cscope 15 $HOME/LinuxProject/linuxGit/pxt4               0001340445
	@acl.c

8 
	~<löux/quŸa›s.h
>

9 
	~"pxt4_jbd3.h
"

10 
	~"pxt4.h
"

11 
	~"x©å.h
"

12 
	~"a˛.h
"

17 
posix_a˛
 *

18 
	$pxt4_a˛_‰om_disk
(c⁄° *
vÆue
, 
size_t
 
size
)

20 c⁄° *
íd
 = (*)
vÆue
 + 
size
;

21 
n
, 
cou¡
;

22 
posix_a˛
 *
a˛
;

24 i‡(!
vÆue
)

25  
NULL
;

26 i‡(
size
 < (
pxt4_a˛_hódî
))

27  
	`ERR_PTR
(-
EINVAL
);

28 i‡(((
pxt4_a˛_hódî
 *)
vÆue
)->
a_vîsi⁄
 !=

29 
	`˝u_to_À32
(
PXT4_ACL_VERSION
))

30  
	`ERR_PTR
(-
EINVAL
);

31 
vÆue
 = (*)vÆuê+ (
pxt4_a˛_hódî
);

32 
cou¡
 = 
	`pxt4_a˛_cou¡
(
size
);

33 i‡(
cou¡
 < 0)

34  
	`ERR_PTR
(-
EINVAL
);

35 i‡(
cou¡
 == 0)

36  
NULL
;

37 
a˛
 = 
	`posix_a˛_Æloc
(
cou¡
, 
GFP_NOFS
);

38 i‡(!
a˛
)

39  
	`ERR_PTR
(-
ENOMEM
);

40 
n
 = 0;Ç < 
cou¡
;Ç++) {

41 
pxt4_a˛_íåy
 *
íåy
 =

42 (
pxt4_a˛_íåy
 *)
vÆue
;

43 i‡((*)
vÆue
 + (
pxt4_a˛_íåy_sh‹t
Ë> 
íd
)

44 
Áû
;

45 
a˛
->
a_íåõs
[
n
].
e_èg
 = 
	`À16_to_˝u
(
íåy
->e_tag);

46 
a˛
->
a_íåõs
[
n
].
e_≥rm
 = 
	`À16_to_˝u
(
íåy
->e_perm);

48 
a˛
->
a_íåõs
[
n
].
e_èg
) {

49 
ACL_USER_OBJ
:

50 
ACL_GROUP_OBJ
:

51 
ACL_MASK
:

52 
ACL_OTHER
:

53 
vÆue
 = (*)value +

54 (
pxt4_a˛_íåy_sh‹t
);

57 
ACL_USER
:

58 
vÆue
 = (*)vÆuê+ (
pxt4_a˛_íåy
);

59 i‡((*)
vÆue
 > 
íd
)

60 
Áû
;

61 
a˛
->
a_íåõs
[
n
].
e_uid
 =

62 
	`make_kuid
(&
öô_u£r_ns
,

63 
	`À32_to_˝u
(
íåy
->
e_id
));

65 
ACL_GROUP
:

66 
vÆue
 = (*)vÆuê+ (
pxt4_a˛_íåy
);

67 i‡((*)
vÆue
 > 
íd
)

68 
Áû
;

69 
a˛
->
a_íåõs
[
n
].
e_gid
 =

70 
	`make_kgid
(&
öô_u£r_ns
,

71 
	`À32_to_˝u
(
íåy
->
e_id
));

75 
Áû
;

78 i‡(
vÆue
 !
íd
)

79 
Áû
;

80  
a˛
;

82 
Áû
:

83 
	`posix_a˛_ªÀa£
(
a˛
);

84  
	`ERR_PTR
(-
EINVAL
);

85 
	}
}

91 
	$pxt4_a˛_to_disk
(c⁄° 
posix_a˛
 *
a˛
, 
size_t
 *
size
)

93 
pxt4_a˛_hódî
 *
ext_a˛
;

94 *
e
;

95 
size_t
 
n
;

97 *
size
 = 
	`pxt4_a˛_size
(
a˛
->
a_cou¡
);

98 
ext_a˛
 = 
	`kmÆloc
((
pxt4_a˛_hódî
Ë+ 
a˛
->
a_cou¡
 *

99 (
pxt4_a˛_íåy
), 
GFP_NOFS
);

100 i‡(!
ext_a˛
)

101  
	`ERR_PTR
(-
ENOMEM
);

102 
ext_a˛
->
a_vîsi⁄
 = 
	`˝u_to_À32
(
PXT4_ACL_VERSION
);

103 
e
 = (*)
ext_a˛
 + (
pxt4_a˛_hódî
);

104 
n
 = 0;Ç < 
a˛
->
a_cou¡
;Ç++) {

105 c⁄° 
posix_a˛_íåy
 *
a˛_e
 = &
a˛
->
a_íåõs
[
n
];

106 
pxt4_a˛_íåy
 *
íåy
 = (pxt4_a˛_íåy *)
e
;

107 
íåy
->
e_èg
 = 
	`˝u_to_À16
(
a˛_e
->e_tag);

108 
íåy
->
e_≥rm
 = 
	`˝u_to_À16
(
a˛_e
->e_perm);

109 
a˛_e
->
e_èg
) {

110 
ACL_USER
:

111 
íåy
->
e_id
 = 
	`˝u_to_À32
(

112 
	`‰om_kuid
(&
öô_u£r_ns
, 
a˛_e
->
e_uid
));

113 
e
 +(
pxt4_a˛_íåy
);

115 
ACL_GROUP
:

116 
íåy
->
e_id
 = 
	`˝u_to_À32
(

117 
	`‰om_kgid
(&
öô_u£r_ns
, 
a˛_e
->
e_gid
));

118 
e
 +(
pxt4_a˛_íåy
);

121 
ACL_USER_OBJ
:

122 
ACL_GROUP_OBJ
:

123 
ACL_MASK
:

124 
ACL_OTHER
:

125 
e
 +(
pxt4_a˛_íåy_sh‹t
);

129 
Áû
;

132  (*)
ext_a˛
;

134 
Áû
:

135 
	`k‰ì
(
ext_a˛
);

136  
	`ERR_PTR
(-
EINVAL
);

137 
	}
}

144 
posix_a˛
 *

145 
	$pxt4_gë_a˛
(
öode
 *öode, 
ty≥
)

147 
«me_ödex
;

148 *
vÆue
 = 
NULL
;

149 
posix_a˛
 *
a˛
;

150 
ªtvÆ
;

152 
ty≥
) {

153 
ACL_TYPE_ACCESS
:

154 
«me_ödex
 = 
PXT4_XATTR_INDEX_POSIX_ACL_ACCESS
;

156 
ACL_TYPE_DEFAULT
:

157 
«me_ödex
 = 
PXT4_XATTR_INDEX_POSIX_ACL_DEFAULT
;

160 
	`BUG
();

162 
ªtvÆ
 = 
	`pxt4_x©å_gë
(
öode
, 
«me_ödex
, "", 
NULL
, 0);

163 i‡(
ªtvÆ
 > 0) {

164 
vÆue
 = 
	`kmÆloc
(
ªtvÆ
, 
GFP_NOFS
);

165 i‡(!
vÆue
)

166  
	`ERR_PTR
(-
ENOMEM
);

167 
ªtvÆ
 = 
	`pxt4_x©å_gë
(
öode
, 
«me_ödex
, "", 
vÆue
,Ñetval);

169 i‡(
ªtvÆ
 > 0)

170 
a˛
 = 
	`pxt4_a˛_‰om_disk
(
vÆue
, 
ªtvÆ
);

171 i‡(
ªtvÆ
 =-
ENODATA
 ||ÑëvÆ =-
ENOSYS
)

172 
a˛
 = 
NULL
;

174 
a˛
 = 
	`ERR_PTR
(
ªtvÆ
);

175 
	`k‰ì
(
vÆue
);

177  
a˛
;

178 
	}
}

186 
	$__pxt4_£t_a˛
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *öode, 
ty≥
,

187 
posix_a˛
 *
a˛
, 
x©å_Êags
)

189 
«me_ödex
;

190 *
vÆue
 = 
NULL
;

191 
size_t
 
size
 = 0;

192 
îr‹
;

194 
ty≥
) {

195 
ACL_TYPE_ACCESS
:

196 
«me_ödex
 = 
PXT4_XATTR_INDEX_POSIX_ACL_ACCESS
;

199 
ACL_TYPE_DEFAULT
:

200 
«me_ödex
 = 
PXT4_XATTR_INDEX_POSIX_ACL_DEFAULT
;

201 i‡(!
	`S_ISDIR
(
öode
->
i_mode
))

202  
a˛
 ? -
EACCES
 : 0;

206  -
EINVAL
;

208 i‡(
a˛
) {

209 
vÆue
 = 
	`pxt4_a˛_to_disk
(
a˛
, &
size
);

210 i‡(
	`IS_ERR
(
vÆue
))

211  ()
	`PTR_ERR
(
vÆue
);

214 
îr‹
 = 
	`pxt4_x©å_£t_h™dÀ
(
h™dÀ
, 
öode
, 
«me_ödex
, "",

215 
vÆue
, 
size
, 
x©å_Êags
);

217 
	`k‰ì
(
vÆue
);

218 i‡(!
îr‹
) {

219 
	`£t_ˇched_a˛
(
öode
, 
ty≥
, 
a˛
);

222  
îr‹
;

223 
	}
}

226 
	$pxt4_£t_a˛
(
öode
 *öode, 
posix_a˛
 *
a˛
, 
ty≥
)

228 
h™dÀ_t
 *
h™dÀ
;

229 
îr‹
, 
¸edôs
, 
ªåõs
 = 0;

230 
size_t
 
a˛_size
 = 
a˛
 ? 
	`pxt4_a˛_size
◊˛->
a_cou¡
) : 0;

231 
umode_t
 
mode
 = 
öode
->
i_mode
;

232 
upd©e_mode
 = 0;

234 
îr‹
 = 
	`dquŸ_öôülize
(
öode
);

235 i‡(
îr‹
)

236  
îr‹
;

237 
ªåy
:

238 
îr‹
 = 
	`pxt4_x©å_£t_¸edôs
(
öode
, 
a˛_size
, 
Ál£
 ,

239 &
¸edôs
);

240 i‡(
îr‹
)

241  
îr‹
;

243 
h™dÀ
 = 
	`pxt4_jou∫Æ_°¨t
(
öode
, 
PXT4_HT_XATTR
, 
¸edôs
);

244 i‡(
	`IS_ERR
(
h™dÀ
))

245  
	`PTR_ERR
(
h™dÀ
);

247 i‡((
ty≥
 =
ACL_TYPE_ACCESS
Ë&& 
a˛
) {

248 
îr‹
 = 
	`posix_a˛_upd©e_mode
(
öode
, &
mode
, &
a˛
);

249 i‡(
îr‹
)

250 
out_°›
;

251 i‡(
mode
 !
öode
->
i_mode
)

252 
upd©e_mode
 = 1;

255 
îr‹
 = 
	`__pxt4_£t_a˛
(
h™dÀ
, 
öode
, 
ty≥
, 
a˛
, 0 );

256 i‡(!
îr‹
 && 
upd©e_mode
) {

257 
öode
->
i_mode
 = 
mode
;

258 
öode
->
i_˘ime
 = 
	`cuºít_time
(inode);

259 
	`pxt4_m¨k_öode_dúty
(
h™dÀ
, 
öode
);

261 
out_°›
:

262 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

263 i‡(
îr‹
 =-
ENOSPC
 && 
	`pxt4_should_ªåy_Æloc
(
öode
->
i_sb
, &
ªåõs
))

264 
ªåy
;

265  
îr‹
;

266 
	}
}

275 
	$pxt4_öô_a˛
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *öode, öodê*
dú
)

277 
posix_a˛
 *
deÁu…_a˛
, *
a˛
;

278 
îr‹
;

280 
îr‹
 = 
	`posix_a˛_¸óã
(
dú
, &
öode
->
i_mode
, &
deÁu…_a˛
, &
a˛
);

281 i‡(
îr‹
)

282  
îr‹
;

284 i‡(
deÁu…_a˛
) {

285 
îr‹
 = 
	`__pxt4_£t_a˛
(
h™dÀ
, 
öode
, 
ACL_TYPE_DEFAULT
,

286 
deÁu…_a˛
, 
XATTR_CREATE
);

287 
	`posix_a˛_ªÀa£
(
deÁu…_a˛
);

289 
öode
->
i_deÁu…_a˛
 = 
NULL
;

291 i‡(
a˛
) {

292 i‡(!
îr‹
)

293 
îr‹
 = 
	`__pxt4_£t_a˛
(
h™dÀ
, 
öode
, 
ACL_TYPE_ACCESS
,

294 
a˛
, 
XATTR_CREATE
);

295 
	`posix_a˛_ªÀa£
(
a˛
);

297 
öode
->
i_a˛
 = 
NULL
;

299  
îr‹
;

300 
	}
}

	@acl.h

8 
	~<löux/posix_a˛_x©å.h
>

10 
	#PXT4_ACL_VERSION
 0x0001

	)

13 
__À16
 
	me_èg
;

14 
__À16
 
	me_≥rm
;

15 
__À32
 
	me_id
;

16 } 
	tpxt4_a˛_íåy
;

19 
__À16
 
	me_èg
;

20 
__À16
 
	me_≥rm
;

21 } 
	tpxt4_a˛_íåy_sh‹t
;

24 
__À32
 
	ma_vîsi⁄
;

25 } 
	tpxt4_a˛_hódî
;

27 
ölöe
 
size_t
 
	$pxt4_a˛_size
(
cou¡
)

29 i‡(
cou¡
 <= 4) {

30  (
pxt4_a˛_hódî
) +

31 
cou¡
 * (
pxt4_a˛_íåy_sh‹t
);

33  (
pxt4_a˛_hódî
) +

34 4 * (
pxt4_a˛_íåy_sh‹t
) +

35 (
cou¡
 - 4Ë* (
pxt4_a˛_íåy
);

37 
	}
}

39 
ölöe
 
	$pxt4_a˛_cou¡
(
size_t
 
size
)

41 
ssize_t
 
s
;

42 
size
 -(
pxt4_a˛_hódî
);

43 
s
 = 
size
 - 4 * (
pxt4_a˛_íåy_sh‹t
);

44 i‡(
s
 < 0) {

45 i‡(
size
 % (
pxt4_a˛_íåy_sh‹t
))

47  
size
 / (
pxt4_a˛_íåy_sh‹t
);

49 i‡(
s
 % (
pxt4_a˛_íåy
))

51  
s
 / (
pxt4_a˛_íåy
) + 4;

53 
	}
}

55 #ifde‡
CONFIG_PXT4_FS_POSIX_ACL


58 
posix_a˛
 *
pxt4_gë_a˛
(
öode
 *öode, 
ty≥
);

59 
pxt4_£t_a˛
(
öode
 *öode, 
posix_a˛
 *
a˛
, 
ty≥
);

60 
pxt4_öô_a˛
(
h™dÀ_t
 *, 
öode
 *, inode *);

63 
	~<löux/sched.h
>

64 
	#pxt4_gë_a˛
 
NULL


	)

65 
	#pxt4_£t_a˛
 
NULL


	)

67 
ölöe
 

68 
	$pxt4_öô_a˛
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *öode, öodê*
dú
)

71 
	}
}

	@balloc.c

15 
	~<löux/time.h
>

16 
	~<löux/ˇ∑bûôy.h
>

17 
	~<löux/fs.h
>

18 
	~<löux/quŸa›s.h
>

19 
	~<löux/buf„r_hód.h
>

20 
	~"pxt4.h
"

21 
	~"pxt4_jbd3.h
"

22 
	~"mbÆloc.h
"

24 
	~<åa˚/evíts/pxt4.h
>

26 
pxt4_num_ba£_mëa_˛u°îs
(
su≥r_block
 *
sb
,

27 
pxt4_group_t
 
block_group
);

35 
pxt4_group_t
 
	$pxt4_gë_group_numbî
(
su≥r_block
 *
sb
,

36 
pxt4_fsblk_t
 
block
)

38 
pxt4_group_t
 
group
;

40 i‡(
	`ã°_›t2
(
sb
, 
STD_GROUP_SIZE
))

41 
group
 = (
block
 -

42 
	`À32_to_˝u
(
	`PXT4_SB
(
sb
)->
s_es
->
s_fú°_d©a_block
)) >>

43 (
	`PXT4_BLOCK_SIZE_BITS
(
sb
Ë+ 
	`PXT4_CLUSTER_BITS
(sb) + 3);

45 
	`pxt4_gë_group_no_™d_off£t
(
sb
, 
block
, &
group
, 
NULL
);

46  
group
;

47 
	}
}

53 
	$pxt4_gë_group_no_™d_off£t
(
su≥r_block
 *
sb
, 
pxt4_fsblk_t
 
blockƒ
,

54 
pxt4_group_t
 *
blockgΩp
, 
pxt4_gΩblk_t
 *
off£ç
)

56 
pxt4_su≥r_block
 *
es
 = 
	`PXT4_SB
(
sb
)->
s_es
;

57 
pxt4_gΩblk_t
 
off£t
;

59 
blockƒ
 = blockƒ - 
	`À32_to_˝u
(
es
->
s_fú°_d©a_block
);

60 
off£t
 = 
	`do_div
(
blockƒ
, 
	`PXT4_BLOCKS_PER_GROUP
(
sb
)) >>

61 
	`PXT4_SB
(
sb
)->
s_˛u°î_bôs
;

62 i‡(
off£ç
)

63 *
off£ç
 = 
off£t
;

64 i‡(
blockgΩp
)

65 *
blockgΩp
 = 
blockƒ
;

67 
	}
}

73 
ölöe
 
	$pxt4_block_ö_group
(
su≥r_block
 *
sb
,

74 
pxt4_fsblk_t
 
block
,

75 
pxt4_group_t
 
block_group
)

77 
pxt4_group_t
 
a˘uÆ_group
;

79 
a˘uÆ_group
 = 
	`pxt4_gë_group_numbî
(
sb
, 
block
);

80  (
a˘uÆ_group
 =
block_group
) ? 1 : 0;

81 
	}
}

86 
	$pxt4_num_ovîhód_˛u°îs
(
su≥r_block
 *
sb
,

87 
pxt4_group_t
 
block_group
,

88 
pxt4_group_desc
 *
gdp
)

90 
num_˛u°îs
;

91 
block_˛u°î
 = -1, 
öode_˛u°î
 = -1, 
ôbl_˛u°î
 = -1, 
i
, 
c
;

92 
pxt4_fsblk_t
 
°¨t
 = 
	`pxt4_group_fú°_block_no
(
sb
, 
block_group
);

93 
pxt4_fsblk_t
 
ôbl_blk
;

94 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
sb
);

99 
num_˛u°îs
 = 
	`pxt4_num_ba£_mëa_˛u°îs
(
sb
, 
block_group
);

113 i‡(
	`pxt4_block_ö_group
(
sb
, 
	`pxt4_block_bôm≠
(sb, 
gdp
), 
block_group
)) {

114 
block_˛u°î
 = 
	`PXT4_B2C
(
sbi
,

115 
	`pxt4_block_bôm≠
(
sb
, 
gdp
Ë- 
°¨t
);

116 i‡(
block_˛u°î
 < 
num_˛u°îs
)

117 
block_˛u°î
 = -1;

118 i‡(
block_˛u°î
 =
num_˛u°îs
) {

119 
num_˛u°îs
++;

120 
block_˛u°î
 = -1;

124 i‡(
	`pxt4_block_ö_group
(
sb
, 
	`pxt4_öode_bôm≠
(sb, 
gdp
), 
block_group
)) {

125 
öode_˛u°î
 = 
	`PXT4_B2C
(
sbi
,

126 
	`pxt4_öode_bôm≠
(
sb
, 
gdp
Ë- 
°¨t
);

127 i‡(
öode_˛u°î
 < 
num_˛u°îs
)

128 
öode_˛u°î
 = -1;

129 i‡(
öode_˛u°î
 =
num_˛u°îs
) {

130 
num_˛u°îs
++;

131 
öode_˛u°î
 = -1;

135 
ôbl_blk
 = 
	`pxt4_öode_èbÀ
(
sb
, 
gdp
);

136 
i
 = 0; i < 
sbi
->
s_ôb_≥r_group
; i++) {

137 i‡(
	`pxt4_block_ö_group
(
sb
, 
ôbl_blk
 + 
i
, 
block_group
)) {

138 
c
 = 
	`PXT4_B2C
(
sbi
, 
ôbl_blk
 + 
i
 - 
°¨t
);

139 i‡((
c
 < 
num_˛u°îs
Ë|| (¯=
öode_˛u°î
) ||

140 (
c
 =
block_˛u°î
Ë|| (¯=
ôbl_˛u°î
))

142 i‡(
c
 =
num_˛u°îs
) {

143 
num_˛u°îs
++;

146 
num_˛u°îs
++;

147 
ôbl_˛u°î
 = 
c
;

151 i‡(
block_˛u°î
 != -1)

152 
num_˛u°îs
++;

153 i‡(
öode_˛u°î
 != -1)

154 
num_˛u°îs
++;

156  
num_˛u°îs
;

157 
	}
}

159 
	$num_˛u°îs_ö_group
(
su≥r_block
 *
sb
,

160 
pxt4_group_t
 
block_group
)

162 
blocks
;

164 i‡(
block_group
 =
	`pxt4_gë_groups_cou¡
(
sb
) - 1) {

171 
blocks
 = 
	`pxt4_blocks_cou¡
(
	`PXT4_SB
(
sb
)->
s_es
) -

172 
	`pxt4_group_fú°_block_no
(
sb
, 
block_group
);

174 
blocks
 = 
	`PXT4_BLOCKS_PER_GROUP
(
sb
);

175  
	`PXT4_NUM_B2C
(
	`PXT4_SB
(
sb
), 
blocks
);

176 
	}
}

179 
	$pxt4_öô_block_bôm≠
(
su≥r_block
 *
sb
,

180 
buf„r_hód
 *
bh
,

181 
pxt4_group_t
 
block_group
,

182 
pxt4_group_desc
 *
gdp
)

184 
bô
, 
bô_max
;

185 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
sb
);

186 
pxt4_fsblk_t
 
°¨t
, 
tmp
;

188 
	`J_ASSERT_BH
(
bh
, 
	`buf„r_locked
(bh));

192 i‡(!
	`pxt4_group_desc_csum_vîify
(
sb
, 
block_group
, 
gdp
)) {

193 
	`pxt4_m¨k_group_bôm≠_c‹ru±ed
(
sb
, 
block_group
,

194 
PXT4_GROUP_INFO_BBITMAP_CORRUPT
 |

195 
PXT4_GROUP_INFO_IBITMAP_CORRUPT
);

196  -
EFSBADCRC
;

198 
	`mem£t
(
bh
->
b_d©a
, 0, 
sb
->
s_blocksize
);

200 
bô_max
 = 
	`pxt4_num_ba£_mëa_˛u°îs
(
sb
, 
block_group
);

201 i‡((
bô_max
 >> 3Ë>
bh
->
b_size
)

202  -
EFSCORRUPTED
;

204 
bô
 = 0; bô < 
bô_max
; bit++)

205 
	`pxt4_£t_bô
(
bô
, 
bh
->
b_d©a
);

207 
°¨t
 = 
	`pxt4_group_fú°_block_no
(
sb
, 
block_group
);

210 
tmp
 = 
	`pxt4_block_bôm≠
(
sb
, 
gdp
);

211 i‡(
	`pxt4_block_ö_group
(
sb
, 
tmp
, 
block_group
))

212 
	`pxt4_£t_bô
(
	`PXT4_B2C
(
sbi
, 
tmp
 - 
°¨t
), 
bh
->
b_d©a
);

214 
tmp
 = 
	`pxt4_öode_bôm≠
(
sb
, 
gdp
);

215 i‡(
	`pxt4_block_ö_group
(
sb
, 
tmp
, 
block_group
))

216 
	`pxt4_£t_bô
(
	`PXT4_B2C
(
sbi
, 
tmp
 - 
°¨t
), 
bh
->
b_d©a
);

218 
tmp
 = 
	`pxt4_öode_èbÀ
(
sb
, 
gdp
);

219 ; 
tmp
 < 
	`pxt4_öode_èbÀ
(
sb
, 
gdp
) +

220 
sbi
->
s_ôb_≥r_group
; 
tmp
++) {

221 i‡(
	`pxt4_block_ö_group
(
sb
, 
tmp
, 
block_group
))

222 
	`pxt4_£t_bô
(
	`PXT4_B2C
(
sbi
, 
tmp
 - 
°¨t
), 
bh
->
b_d©a
);

230 
	`pxt4_m¨k_bôm≠_íd
(
	`num_˛u°îs_ö_group
(
sb
, 
block_group
),

231 
sb
->
s_blocksize
 * 8, 
bh
->
b_d©a
);

233 
	}
}

238 
	$pxt4_‰ì_˛u°îs_a·î_öô
(
su≥r_block
 *
sb
,

239 
pxt4_group_t
 
block_group
,

240 
pxt4_group_desc
 *
gdp
)

242  
	`num_˛u°îs_ö_group
(
sb
, 
block_group
) -

243 
	`pxt4_num_ovîhód_˛u°îs
(
sb
, 
block_group
, 
gdp
);

244 
	}
}

264 
pxt4_group_desc
 * 
	$pxt4_gë_group_desc
(
su≥r_block
 *
sb
,

265 
pxt4_group_t
 
block_group
,

266 
buf„r_hód
 **
bh
)

268 
group_desc
;

269 
off£t
;

270 
pxt4_group_t
 
ngroups
 = 
	`pxt4_gë_groups_cou¡
(
sb
);

271 
pxt4_group_desc
 *
desc
;

272 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
sb
);

273 
buf„r_hód
 *
bh_p
;

275 i‡(
block_group
 >
ngroups
) {

276 
	`pxt4_îr‹
(
sb
, "block_group >= groups_count - block_group = %u,"

277 " groups_cou¡ = %u", 
block_group
, 
ngroups
);

279  
NULL
;

282 
group_desc
 = 
block_group
 >> 
	`PXT4_DESC_PER_BLOCK_BITS
(
sb
);

283 
off£t
 = 
block_group
 & (
	`PXT4_DESC_PER_BLOCK
(
sb
) - 1);

284 
bh_p
 = 
	`sbi_¨øy_rcu_dîef
(
sbi
, 
s_group_desc
, 
group_desc
);

291 i‡(!
bh_p
) {

292 
	`pxt4_îr‹
(
sb
, "Group descriptorÇotÜoaded - "

294 
block_group
, 
group_desc
, 
off£t
);

295  
NULL
;

298 
desc
 = (
pxt4_group_desc
 *)(

299 (
__u8
 *)
bh_p
->
b_d©a
 +

300 
off£t
 * 
	`PXT4_DESC_SIZE
(
sb
));

301 i‡(
bh
)

302 *
bh
 = 
bh_p
;

303  
desc
;

304 
	}
}

310 
pxt4_fsblk_t
 
	$pxt4_vÆid_block_bôm≠
(
su≥r_block
 *
sb
,

311 
pxt4_group_desc
 *
desc
,

312 
pxt4_group_t
 
block_group
,

313 
buf„r_hód
 *
bh
)

315 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
sb
);

316 
pxt4_gΩblk_t
 
off£t
;

317 
pxt4_gΩblk_t
 
√xt_zîo_bô
;

318 
pxt4_gΩblk_t
 
max_bô
 = 
	`PXT4_CLUSTERS_PER_GROUP
(
sb
);

319 
pxt4_fsblk_t
 
blk
;

320 
pxt4_fsblk_t
 
group_fú°_block
;

322 i‡(
	`pxt4_has_„©uª_Êex_bg
(
sb
)) {

331 
group_fú°_block
 = 
	`pxt4_group_fú°_block_no
(
sb
, 
block_group
);

334 
blk
 = 
	`pxt4_block_bôm≠
(
sb
, 
desc
);

335 
off£t
 = 
blk
 - 
group_fú°_block
;

336 i‡(
off£t
 < 0 || 
	`PXT4_B2C
(
sbi
, off£tË>
max_bô
 ||

337 !
	`pxt4_ã°_bô
(
	`PXT4_B2C
(
sbi
, 
off£t
), 
bh
->
b_d©a
))

339  
blk
;

342 
blk
 = 
	`pxt4_öode_bôm≠
(
sb
, 
desc
);

343 
off£t
 = 
blk
 - 
group_fú°_block
;

344 i‡(
off£t
 < 0 || 
	`PXT4_B2C
(
sbi
, off£tË>
max_bô
 ||

345 !
	`pxt4_ã°_bô
(
	`PXT4_B2C
(
sbi
, 
off£t
), 
bh
->
b_d©a
))

347  
blk
;

350 
blk
 = 
	`pxt4_öode_èbÀ
(
sb
, 
desc
);

351 
off£t
 = 
blk
 - 
group_fú°_block
;

352 i‡(
off£t
 < 0 || 
	`PXT4_B2C
(
sbi
, off£tË>
max_bô
 ||

353 
	`PXT4_B2C
(
sbi
, 
off£t
 + sbi->
s_ôb_≥r_group
Ë>
max_bô
)

354  
blk
;

355 
√xt_zîo_bô
 = 
	`pxt4_föd_√xt_zîo_bô
(
bh
->
b_d©a
,

356 
	`PXT4_B2C
(
sbi
, 
off£t
 + sbi->
s_ôb_≥r_group
),

357 
	`PXT4_B2C
(
sbi
, 
off£t
));

358 i‡(
√xt_zîo_bô
 <

359 
	`PXT4_B2C
(
sbi
, 
off£t
 + sbi->
s_ôb_≥r_group
))

361  
blk
;

363 
	}
}

365 
	$pxt4_vÆid©e_block_bôm≠
(
su≥r_block
 *
sb
,

366 
pxt4_group_desc
 *
desc
,

367 
pxt4_group_t
 
block_group
,

368 
buf„r_hód
 *
bh
)

370 
pxt4_fsblk_t
 
blk
;

371 
pxt4_group_öfo
 *
gΩ
 = 
	`pxt4_gë_group_öfo
(
sb
, 
block_group
);

373 i‡(
	`buf„r_vîifõd
(
bh
))

375 i‡(
	`PXT4_MB_GRP_BBITMAP_CORRUPT
(
gΩ
))

376  -
EFSCORRUPTED
;

378 
	`pxt4_lock_group
(
sb
, 
block_group
);

379 i‡(
	`buf„r_vîifõd
(
bh
))

380 
vîifõd
;

381 i‡(
	`u∆ikñy
(!
	`pxt4_block_bôm≠_csum_vîify
(
sb
, 
block_group
,

382 
desc
, 
bh
))) {

383 
	`pxt4_u∆ock_group
(
sb
, 
block_group
);

384 
	`pxt4_îr‹
(
sb
, "bg %u: bad block bôm≠ checksum", 
block_group
);

385 
	`pxt4_m¨k_group_bôm≠_c‹ru±ed
(
sb
, 
block_group
,

386 
PXT4_GROUP_INFO_BBITMAP_CORRUPT
);

387  -
EFSBADCRC
;

389 
blk
 = 
	`pxt4_vÆid_block_bôm≠
(
sb
, 
desc
, 
block_group
, 
bh
);

390 i‡(
	`u∆ikñy
(
blk
 != 0)) {

391 
	`pxt4_u∆ock_group
(
sb
, 
block_group
);

392 
	`pxt4_îr‹
(
sb
, "bg %u: block %llu: invalid block bitmap",

393 
block_group
, 
blk
);

394 
	`pxt4_m¨k_group_bôm≠_c‹ru±ed
(
sb
, 
block_group
,

395 
PXT4_GROUP_INFO_BBITMAP_CORRUPT
);

396  -
EFSCORRUPTED
;

398 
	`£t_buf„r_vîifõd
(
bh
);

399 
vîifõd
:

400 
	`pxt4_u∆ock_group
(
sb
, 
block_group
);

402 
	}
}

414 
buf„r_hód
 *

415 
	$pxt4_ªad_block_bôm≠_nowaô
(
su≥r_block
 *
sb
, 
pxt4_group_t
 
block_group
)

417 
pxt4_group_desc
 *
desc
;

418 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
sb
);

419 
buf„r_hód
 *
bh
;

420 
pxt4_fsblk_t
 
bôm≠_blk
;

421 
îr
;

423 
desc
 = 
	`pxt4_gë_group_desc
(
sb
, 
block_group
, 
NULL
);

424 i‡(!
desc
)

425  
	`ERR_PTR
(-
EFSCORRUPTED
);

426 
bôm≠_blk
 = 
	`pxt4_block_bôm≠
(
sb
, 
desc
);

427 i‡((
bôm≠_blk
 <
	`À32_to_˝u
(
sbi
->
s_es
->
s_fú°_d©a_block
)) ||

428 (
bôm≠_blk
 >
	`pxt4_blocks_cou¡
(
sbi
->
s_es
))) {

429 
	`pxt4_îr‹
(
sb
, "Invalid block bitmap block %llu in "

430 "block_grou∞%u", 
bôm≠_blk
, 
block_group
);

431 
	`pxt4_m¨k_group_bôm≠_c‹ru±ed
(
sb
, 
block_group
,

432 
PXT4_GROUP_INFO_BBITMAP_CORRUPT
);

433  
	`ERR_PTR
(-
EFSCORRUPTED
);

435 
bh
 = 
	`sb_gëblk
(
sb
, 
bôm≠_blk
);

436 i‡(
	`u∆ikñy
(!
bh
)) {

437 
	`pxt4_w¨nög
(
sb
, "Cannot get buffer for block bitmap - "

439 
block_group
, 
bôm≠_blk
);

440  
	`ERR_PTR
(-
ENOMEM
);

443 i‡(
	`bôm≠_u±od©e
(
bh
))

444 
vîify
;

446 
	`lock_buf„r
(
bh
);

447 i‡(
	`bôm≠_u±od©e
(
bh
)) {

448 
	`u∆ock_buf„r
(
bh
);

449 
vîify
;

451 
	`pxt4_lock_group
(
sb
, 
block_group
);

452 i‡(
	`pxt4_has_group_desc_csum
(
sb
) &&

453 (
desc
->
bg_Êags
 & 
	`˝u_to_À16
(
PXT4_BG_BLOCK_UNINIT
))) {

454 i‡(
block_group
 == 0) {

455 
	`pxt4_u∆ock_group
(
sb
, 
block_group
);

456 
	`u∆ock_buf„r
(
bh
);

457 
	`pxt4_îr‹
(
sb
, "Block bitmap for bg 0 marked "

459 
îr
 = -
EFSCORRUPTED
;

460 
out
;

462 
îr
 = 
	`pxt4_öô_block_bôm≠
(
sb
, 
bh
, 
block_group
, 
desc
);

463 
	`£t_bôm≠_u±od©e
(
bh
);

464 
	`£t_buf„r_u±od©e
(
bh
);

465 
	`£t_buf„r_vîifõd
(
bh
);

466 
	`pxt4_u∆ock_group
(
sb
, 
block_group
);

467 
	`u∆ock_buf„r
(
bh
);

468 i‡(
îr
) {

469 
	`pxt4_îr‹
(
sb
, "FailedÅo init block bitmap for group "

470 "%u: %d", 
block_group
, 
îr
);

471 
out
;

473 
vîify
;

475 
	`pxt4_u∆ock_group
(
sb
, 
block_group
);

476 i‡(
	`buf„r_u±od©e
(
bh
)) {

481 
	`£t_bôm≠_u±od©e
(
bh
);

482 
	`u∆ock_buf„r
(
bh
);

483 
vîify
;

488 
	`£t_buf„r_√w
(
bh
);

489 
	`åa˚_pxt4_ªad_block_bôm≠_lﬂd
(
sb
, 
block_group
);

490 
bh
->
b_íd_io
 = 
pxt4_íd_bôm≠_ªad
;

491 
	`gë_bh
(
bh
);

492 
	`submô_bh
(
REQ_OP_READ
, 
REQ_META
 | 
REQ_PRIO
, 
bh
);

493  
bh
;

494 
vîify
:

495 
îr
 = 
	`pxt4_vÆid©e_block_bôm≠
(
sb
, 
desc
, 
block_group
, 
bh
);

496 i‡(
îr
)

497 
out
;

498  
bh
;

499 
out
:

500 
	`put_bh
(
bh
);

501  
	`ERR_PTR
(
îr
);

502 
	}
}

505 
	$pxt4_waô_block_bôm≠
(
su≥r_block
 *
sb
, 
pxt4_group_t
 
block_group
,

506 
buf„r_hód
 *
bh
)

508 
pxt4_group_desc
 *
desc
;

510 i‡(!
	`buf„r_√w
(
bh
))

512 
desc
 = 
	`pxt4_gë_group_desc
(
sb
, 
block_group
, 
NULL
);

513 i‡(!
desc
)

514  -
EFSCORRUPTED
;

515 
	`waô_⁄_buf„r
(
bh
);

516 i‡(!
	`buf„r_u±od©e
(
bh
)) {

517 
	`pxt4_îr‹
(
sb
, "CannotÑead block bitmap - "

519 
block_group
, (Ë
bh
->
b_blockƒ
);

520 
	`pxt4_m¨k_group_bôm≠_c‹ru±ed
(
sb
, 
block_group
,

521 
PXT4_GROUP_INFO_BBITMAP_CORRUPT
);

522  -
EIO
;

524 
	`˛ór_buf„r_√w
(
bh
);

526  
	`pxt4_vÆid©e_block_bôm≠
(
sb
, 
desc
, 
block_group
, 
bh
);

527 
	}
}

529 
buf„r_hód
 *

530 
	$pxt4_ªad_block_bôm≠
(
su≥r_block
 *
sb
, 
pxt4_group_t
 
block_group
)

532 
buf„r_hód
 *
bh
;

533 
îr
;

535 
bh
 = 
	`pxt4_ªad_block_bôm≠_nowaô
(
sb
, 
block_group
);

536 i‡(
	`IS_ERR
(
bh
))

537  
bh
;

538 
îr
 = 
	`pxt4_waô_block_bôm≠
(
sb
, 
block_group
, 
bh
);

539 i‡(
îr
) {

540 
	`put_bh
(
bh
);

541  
	`ERR_PTR
(
îr
);

543  
bh
;

544 
	}
}

555 
	$pxt4_has_‰ì_˛u°îs
(
pxt4_sb_öfo
 *
sbi
,

556 
s64
 
n˛u°îs
, 
Êags
)

558 
s64
 
‰ì_˛u°îs
, 
dúty_˛u°îs
, 
rsv
, 
ªsv_˛u°îs
;

559 
≥r˝u_cou¡î
 *
fcc
 = &
sbi
->
s_‰ì˛u°îs_cou¡î
;

560 
≥r˝u_cou¡î
 *
dcc
 = &
sbi
->
s_dúty˛u°îs_cou¡î
;

562 
‰ì_˛u°îs
 = 
	`≥r˝u_cou¡î_ªad_posôive
(
fcc
);

563 
dúty_˛u°îs
 = 
	`≥r˝u_cou¡î_ªad_posôive
(
dcc
);

564 
ªsv_˛u°îs
 = 
	`©omic64_ªad
(&
sbi
->
s_ªsv_˛u°îs
);

570 
rsv
 = (
	`pxt4_r_blocks_cou¡
(
sbi
->
s_es
Ë>> sbi->
s_˛u°î_bôs
) +

571 
ªsv_˛u°îs
;

573 i‡(
‰ì_˛u°îs
 - (
n˛u°îs
 + 
rsv
 + 
dúty_˛u°îs
) <

574 
PXT4_FREECLUSTERS_WATERMARK
) {

575 
‰ì_˛u°îs
 = 
	`≥r˝u_cou¡î_sum_posôive
(
fcc
);

576 
dúty_˛u°îs
 = 
	`≥r˝u_cou¡î_sum_posôive
(
dcc
);

581 i‡(
‰ì_˛u°îs
 >(
rsv
 + 
n˛u°îs
 + 
dúty_˛u°îs
))

585 i‡(
	`uid_eq
(
sbi
->
s_ªsuid
, 
	`cuºít_fsuid
()) ||

586 (!
	`gid_eq
(
sbi
->
s_ªsgid
, 
GLOBAL_ROOT_GID
Ë&& 
	`ö_group_p
(sbi->s_resgid)) ||

587 
	`ˇ∑bÀ
(
CAP_SYS_RESOURCE
) ||

588 (
Êags
 & 
PXT4_MB_USE_ROOT_BLOCKS
)) {

590 i‡(
‰ì_˛u°îs
 >(
n˛u°îs
 + 
dúty_˛u°îs
 +

591 
ªsv_˛u°îs
))

595 i‡(
Êags
 & 
PXT4_MB_USE_RESERVED
) {

596 i‡(
‰ì_˛u°îs
 >(
n˛u°îs
 + 
dúty_˛u°îs
))

601 
	}
}

603 
	$pxt4_˛aim_‰ì_˛u°îs
(
pxt4_sb_öfo
 *
sbi
,

604 
s64
 
n˛u°îs
, 
Êags
)

606 i‡(
	`pxt4_has_‰ì_˛u°îs
(
sbi
, 
n˛u°îs
, 
Êags
)) {

607 
	`≥r˝u_cou¡î_add
(&
sbi
->
s_dúty˛u°îs_cou¡î
, 
n˛u°îs
);

610  -
ENOSPC
;

611 
	}
}

624 
	$pxt4_should_ªåy_Æloc
(
su≥r_block
 *
sb
, *
ªåõs
)

626 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
sb
);

628 i‡(!
sbi
->
s_jou∫Æ
)

631 i‡(++(*
ªåõs
) > 3) {

632 
	`≥r˝u_cou¡î_öc
(&
sbi
->
s_§a_ex˚eded_ªåy_limô
);

640 
	`smp_mb
();

641 i‡(
sbi
->
s_mb_‰ì_≥ndög
 == 0)

642  
	`pxt4_has_‰ì_˛u°îs
(
sbi
, 1, 0);

648 
	`jbd_debug
(1, "%s:Ñëryög o≥øti⁄á·î ENOSPC\n", 
sb
->
s_id
);

649 (Ë
	`jbd3_jou∫Æ_f‹˚_commô_√°ed
(
sbi
->
s_jou∫Æ
);

651 
	}
}

665 
pxt4_fsblk_t
 
	$pxt4_√w_mëa_blocks
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *inode,

666 
pxt4_fsblk_t
 
gﬂl
, 
Êags
,

667 *
cou¡
, *
îΩ
)

669 
pxt4_Æloˇti⁄_ªque°
 
¨
;

670 
pxt4_fsblk_t
 
ªt
;

672 
	`mem£t
(&
¨
, 0, (ar));

674 
¨
.
öode
 = inode;

675 
¨
.
gﬂl
 = goal;

676 
¨
.
Àn
 = 
cou¡
 ? *count : 1;

677 
¨
.
Êags
 = flags;

679 
ªt
 = 
	`pxt4_mb_√w_blocks
(
h™dÀ
, &
¨
, 
îΩ
);

680 i‡(
cou¡
)

681 *
cou¡
 = 
¨
.
Àn
;

686 i‡(!(*
îΩ
Ë&& (
Êags
 & 
PXT4_MB_DELALLOC_RESERVED
)) {

687 
	`dquŸ_Æloc_block_noÁû
(
öode
,

688 
	`PXT4_C2B
(
	`PXT4_SB
(
öode
->
i_sb
), 
¨
.
Àn
));

690  
ªt
;

691 
	}
}

699 
pxt4_fsblk_t
 
	$pxt4_cou¡_‰ì_˛u°îs
(
su≥r_block
 *
sb
)

701 
pxt4_fsblk_t
 
desc_cou¡
;

702 
pxt4_group_desc
 *
gdp
;

703 
pxt4_group_t
 
i
;

704 
pxt4_group_t
 
ngroups
 = 
	`pxt4_gë_groups_cou¡
(
sb
);

705 
pxt4_group_öfo
 *
gΩ
;

706 #ifde‡
PXT4FS_DEBUG


707 
pxt4_su≥r_block
 *
es
;

708 
pxt4_fsblk_t
 
bôm≠_cou¡
;

709 
x
;

710 
buf„r_hód
 *
bôm≠_bh
 = 
NULL
;

712 
es
 = 
	`PXT4_SB
(
sb
)->
s_es
;

713 
desc_cou¡
 = 0;

714 
bôm≠_cou¡
 = 0;

715 
gdp
 = 
NULL
;

717 
i
 = 0; i < 
ngroups
; i++) {

718 
gdp
 = 
	`pxt4_gë_group_desc
(
sb
, 
i
, 
NULL
);

719 i‡(!
gdp
)

721 
gΩ
 = 
NULL
;

722 i‡(
	`PXT4_SB
(
sb
)->
s_group_öfo
)

723 
gΩ
 = 
	`pxt4_gë_group_öfo
(
sb
, 
i
);

724 i‡(!
gΩ
 || !
	`PXT4_MB_GRP_BBITMAP_CORRUPT
(grp))

725 
desc_cou¡
 +
	`pxt4_‰ì_group_˛u°îs
(
sb
, 
gdp
);

726 
	`bªl£
(
bôm≠_bh
);

727 
bôm≠_bh
 = 
	`pxt4_ªad_block_bôm≠
(
sb
, 
i
);

728 i‡(
	`IS_ERR
(
bôm≠_bh
)) {

729 
bôm≠_bh
 = 
NULL
;

733 
x
 = 
	`pxt4_cou¡_‰ì
(
bôm≠_bh
->
b_d©a
,

734 
	`PXT4_CLUSTERS_PER_GROUP
(
sb
) / 8);

735 
	`¥ötk
(
KERN_DEBUG
 "group %u: stored = %d, counted = %u\n",

736 
i
, 
	`pxt4_‰ì_group_˛u°îs
(
sb
, 
gdp
), 
x
);

737 
bôm≠_cou¡
 +
x
;

739 
	`bªl£
(
bôm≠_bh
);

740 
	`¥ötk
(
KERN_DEBUG
 "pxt4_count_free_clusters: stored = %llu"

742 
	`PXT4_NUM_B2C
(
	`PXT4_SB
(
sb
), 
	`pxt4_‰ì_blocks_cou¡
(
es
)),

743 
desc_cou¡
, 
bôm≠_cou¡
);

744  
bôm≠_cou¡
;

746 
desc_cou¡
 = 0;

747 
i
 = 0; i < 
ngroups
; i++) {

748 
gdp
 = 
	`pxt4_gë_group_desc
(
sb
, 
i
, 
NULL
);

749 i‡(!
gdp
)

751 
gΩ
 = 
NULL
;

752 i‡(
	`PXT4_SB
(
sb
)->
s_group_öfo
)

753 
gΩ
 = 
	`pxt4_gë_group_öfo
(
sb
, 
i
);

754 i‡(!
gΩ
 || !
	`PXT4_MB_GRP_BBITMAP_CORRUPT
(grp))

755 
desc_cou¡
 +
	`pxt4_‰ì_group_˛u°îs
(
sb
, 
gdp
);

758  
desc_cou¡
;

760 
	}
}

762 
ölöe
 
	$ã°_roŸ
(
pxt4_group_t
 
a
, 
b
)

765 i‡(
a
 < 
b
)

767 i‡(
a
 =
b
)

769 i‡((
a
 % 
b
) != 0)

771 
a
 =á / 
b
;

773 
	}
}

783 
	$pxt4_bg_has_su≥r
(
su≥r_block
 *
sb
, 
pxt4_group_t
 
group
)

785 
pxt4_su≥r_block
 *
es
 = 
	`PXT4_SB
(
sb
)->
s_es
;

787 i‡(
group
 == 0)

789 i‡(
	`pxt4_has_„©uª_•¨£_su≥r2
(
sb
)) {

790 i‡(
group
 =
	`À32_to_˝u
(
es
->
s_backup_bgs
[0]) ||

791 
group
 =
	`À32_to_˝u
(
es
->
s_backup_bgs
[1]))

795 i‡((
group
 <1Ë|| !
	`pxt4_has_„©uª_•¨£_su≥r
(
sb
))

797 i‡(!(
group
 & 1))

799 i‡(
	`ã°_roŸ
(
group
, 3) || (test_root(group, 5)) ||

800 
	`ã°_roŸ
(
group
, 7))

804 
	}
}

806 
	$pxt4_bg_num_gdb_mëa
(
su≥r_block
 *
sb
,

807 
pxt4_group_t
 
group
)

809 
mëagroup
 = 
group
 / 
	`PXT4_DESC_PER_BLOCK
(
sb
);

810 
pxt4_group_t
 
fú°
 = 
mëagroup
 * 
	`PXT4_DESC_PER_BLOCK
(
sb
);

811 
pxt4_group_t
 
œ°
 = 
fú°
 + 
	`PXT4_DESC_PER_BLOCK
(
sb
) - 1;

813 i‡(
group
 =
fú°
 || grou∞=fú° + 1 || grou∞=
œ°
)

816 
	}
}

818 
	$pxt4_bg_num_gdb_nomëa
(
su≥r_block
 *
sb
,

819 
pxt4_group_t
 
group
)

821 i‡(!
	`pxt4_bg_has_su≥r
(
sb
, 
group
))

824 i‡(
	`pxt4_has_„©uª_mëa_bg
(
sb
))

825  
	`À32_to_˝u
(
	`PXT4_SB
(
sb
)->
s_es
->
s_fú°_mëa_bg
);

827  
	`PXT4_SB
(
sb
)->
s_gdb_cou¡
;

828 
	}
}

839 
	$pxt4_bg_num_gdb
(
su≥r_block
 *
sb
, 
pxt4_group_t
 
group
)

841 
fú°_mëa_bg
 =

842 
	`À32_to_˝u
(
	`PXT4_SB
(
sb
)->
s_es
->
s_fú°_mëa_bg
);

843 
mëagroup
 = 
group
 / 
	`PXT4_DESC_PER_BLOCK
(
sb
);

845 i‡(!
	`pxt4_has_„©uª_mëa_bg
(
sb
Ë|| 
mëagroup
 < 
fú°_mëa_bg
)

846  
	`pxt4_bg_num_gdb_nomëa
(
sb
, 
group
);

848  
	`pxt4_bg_num_gdb_mëa
(
sb
,
group
);

850 
	}
}

856 
	$pxt4_num_ba£_mëa_˛u°îs
(
su≥r_block
 *
sb
,

857 
pxt4_group_t
 
block_group
)

859 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
sb
);

860 
num
;

863 
num
 = 
	`pxt4_bg_has_su≥r
(
sb
, 
block_group
);

865 i‡(!
	`pxt4_has_„©uª_mëa_bg
(
sb
) ||

866 
block_group
 < 
	`À32_to_˝u
(
sbi
->
s_es
->
s_fú°_mëa_bg
) *

867 
sbi
->
s_desc_≥r_block
) {

868 i‡(
num
) {

869 
num
 +
	`pxt4_bg_num_gdb
(
sb
, 
block_group
);

870 
num
 +
	`À16_to_˝u
(
sbi
->
s_es
->
s_ª£rved_gdt_blocks
);

873 
num
 +
	`pxt4_bg_num_gdb
(
sb
, 
block_group
);

875  
	`PXT4_NUM_B2C
(
sbi
, 
num
);

876 
	}
}

884 
pxt4_fsblk_t
 
	$pxt4_öode_to_gﬂl_block
(
öode
 *inode)

886 
pxt4_öode_öfo
 *
ei
 = 
	`PXT4_I
(
öode
);

887 
pxt4_group_t
 
block_group
;

888 
pxt4_gΩblk_t
 
cﬁour
;

889 
Êex_size
 = 
	`pxt4_Êex_bg_size
(
	`PXT4_SB
(
öode
->
i_sb
));

890 
pxt4_fsblk_t
 
bg_°¨t
;

891 
pxt4_fsblk_t
 
œ°_block
;

893 
block_group
 = 
ei
->
i_block_group
;

894 i‡(
Êex_size
 >
PXT4_FLEX_SIZE_DIR_ALLOC_SCHEME
) {

903 
block_group
 &~(
Êex_size
-1);

904 i‡(
	`S_ISREG
(
öode
->
i_mode
))

905 
block_group
++;

907 
bg_°¨t
 = 
	`pxt4_group_fú°_block_no
(
öode
->
i_sb
, 
block_group
);

908 
œ°_block
 = 
	`pxt4_blocks_cou¡
(
	`PXT4_SB
(
öode
->
i_sb
)->
s_es
) - 1;

914 i‡(
	`ã°_›t
(
öode
->
i_sb
, 
DELALLOC
))

915  
bg_°¨t
;

917 i‡(
bg_°¨t
 + 
	`PXT4_BLOCKS_PER_GROUP
(
öode
->
i_sb
Ë<
œ°_block
)

918 
cﬁour
 = (
cuºít
->
pid
 % 16) *

919 (
	`PXT4_BLOCKS_PER_GROUP
(
öode
->
i_sb
) / 16);

921 
cﬁour
 = (
cuºít
->
pid
 % 16Ë* ((
œ°_block
 - 
bg_°¨t
) / 16);

922  
bg_°¨t
 + 
cﬁour
;

923 
	}
}

	@bitmap.c

11 
	~<löux/buf„r_hód.h
>

12 
	~"pxt4.h
"

14 
	$pxt4_cou¡_‰ì
(*
bôm≠
, 
numch¨s
)

16  
numch¨s
 * 
BITS_PER_BYTE
 - 
	`memweight
(
bôm≠
,Çumchars);

17 
	}
}

19 
	$pxt4_öode_bôm≠_csum_vîify
(
su≥r_block
 *
sb
, 
pxt4_group_t
 
group
,

20 
pxt4_group_desc
 *
gdp
,

21 
buf„r_hód
 *
bh
, 
sz
)

23 
__u32
 
hi
;

24 
__u32
 
¥ovided
, 
ˇlcuœãd
;

25 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
sb
);

27 i‡(!
	`pxt4_has_mëad©a_csum
(
sb
))

30 
¥ovided
 = 
	`À16_to_˝u
(
gdp
->
bg_öode_bôm≠_csum_lo
);

31 
ˇlcuœãd
 = 
	`pxt4_chksum
(
sbi
, sbi->
s_csum_£ed
, (
__u8
 *)
bh
->
b_d©a
, 
sz
);

32 i‡(
sbi
->
s_desc_size
 >
PXT4_BG_INODE_BITMAP_CSUM_HI_END
) {

33 
hi
 = 
	`À16_to_˝u
(
gdp
->
bg_öode_bôm≠_csum_hi
);

34 
¥ovided
 |(
hi
 << 16);

36 
ˇlcuœãd
 &= 0xFFFF;

38  
¥ovided
 =
ˇlcuœãd
;

39 
	}
}

41 
	$pxt4_öode_bôm≠_csum_£t
(
su≥r_block
 *
sb
, 
pxt4_group_t
 
group
,

42 
pxt4_group_desc
 *
gdp
,

43 
buf„r_hód
 *
bh
, 
sz
)

45 
__u32
 
csum
;

46 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
sb
);

48 i‡(!
	`pxt4_has_mëad©a_csum
(
sb
))

51 
csum
 = 
	`pxt4_chksum
(
sbi
, sbi->
s_csum_£ed
, (
__u8
 *)
bh
->
b_d©a
, 
sz
);

52 
gdp
->
bg_öode_bôm≠_csum_lo
 = 
	`˝u_to_À16
(
csum
 & 0xFFFF);

53 i‡(
sbi
->
s_desc_size
 >
PXT4_BG_INODE_BITMAP_CSUM_HI_END
)

54 
gdp
->
bg_öode_bôm≠_csum_hi
 = 
	`˝u_to_À16
(
csum
 >> 16);

55 
	}
}

57 
	$pxt4_block_bôm≠_csum_vîify
(
su≥r_block
 *
sb
, 
pxt4_group_t
 
group
,

58 
pxt4_group_desc
 *
gdp
,

59 
buf„r_hód
 *
bh
)

61 
__u32
 
hi
;

62 
__u32
 
¥ovided
, 
ˇlcuœãd
;

63 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
sb
);

64 
sz
 = 
	`PXT4_CLUSTERS_PER_GROUP
(
sb
) / 8;

66 i‡(!
	`pxt4_has_mëad©a_csum
(
sb
))

69 
¥ovided
 = 
	`À16_to_˝u
(
gdp
->
bg_block_bôm≠_csum_lo
);

70 
ˇlcuœãd
 = 
	`pxt4_chksum
(
sbi
, sbi->
s_csum_£ed
, (
__u8
 *)
bh
->
b_d©a
, 
sz
);

71 i‡(
sbi
->
s_desc_size
 >
PXT4_BG_BLOCK_BITMAP_CSUM_HI_END
) {

72 
hi
 = 
	`À16_to_˝u
(
gdp
->
bg_block_bôm≠_csum_hi
);

73 
¥ovided
 |(
hi
 << 16);

75 
ˇlcuœãd
 &= 0xFFFF;

77 i‡(
¥ovided
 =
ˇlcuœãd
)

81 
	}
}

83 
	$pxt4_block_bôm≠_csum_£t
(
su≥r_block
 *
sb
, 
pxt4_group_t
 
group
,

84 
pxt4_group_desc
 *
gdp
,

85 
buf„r_hód
 *
bh
)

87 
sz
 = 
	`PXT4_CLUSTERS_PER_GROUP
(
sb
) / 8;

88 
__u32
 
csum
;

89 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
sb
);

91 i‡(!
	`pxt4_has_mëad©a_csum
(
sb
))

94 
csum
 = 
	`pxt4_chksum
(
sbi
, sbi->
s_csum_£ed
, (
__u8
 *)
bh
->
b_d©a
, 
sz
);

95 
gdp
->
bg_block_bôm≠_csum_lo
 = 
	`˝u_to_À16
(
csum
 & 0xFFFF);

96 i‡(
sbi
->
s_desc_size
 >
PXT4_BG_BLOCK_BITMAP_CSUM_HI_END
)

97 
gdp
->
bg_block_bôm≠_csum_hi
 = 
	`˝u_to_À16
(
csum
 >> 16);

98 
	}
}

	@block_validity.c

12 
	~<löux/time.h
>

13 
	~<löux/fs.h
>

14 
	~<löux/«mei.h
>

15 
	~<löux/quŸa›s.h
>

16 
	~<löux/buf„r_hód.h
>

17 
	~<löux/sw≠.h
>

18 
	~<löux/∑gem≠.h
>

19 
	~<löux/blkdev.h
>

20 
	~<löux/¶ab.h
>

21 
	~"pxt4.h
"

23 
	spxt4_sy°em_z⁄e
 {

24 
rb_node
 
	mnode
;

25 
pxt4_fsblk_t
 
	m°¨t_blk
;

26 
	mcou¡
;

29 
kmem_ˇche
 *
	gpxt4_sy°em_z⁄e_ˇchï
;

31 
__öô
 
	$pxt4_öô_sy°em_z⁄e
()

33 
pxt4_sy°em_z⁄e_ˇchï
 = 
	`KMEM_CACHE
(
pxt4_sy°em_z⁄e
, 0);

34 i‡(
pxt4_sy°em_z⁄e_ˇchï
 =
NULL
)

35  -
ENOMEM
;

37 
	}
}

39 
	$pxt4_exô_sy°em_z⁄e
()

41 
	`rcu_b¨rõr
();

42 
	`kmem_ˇche_de°roy
(
pxt4_sy°em_z⁄e_ˇchï
);

43 
	}
}

45 
ölöe
 
	$ˇn_mîge
(
pxt4_sy°em_z⁄e
 *
íåy1
,

46 
pxt4_sy°em_z⁄e
 *
íåy2
)

48 i‡((
íåy1
->
°¨t_blk
 +É¡ry1->
cou¡
Ë=
íåy2
->start_blk)

51 
	}
}

53 
	$ªÀa£_sy°em_z⁄e
(
pxt4_sy°em_blocks
 *
sy°em_blks
)

55 
pxt4_sy°em_z⁄e
 *
íåy
, *
n
;

57 
	`rbåì_po°‹dî_f‹_óch_íåy_ß„
(
íåy
, 
n
,

58 &
sy°em_blks
->
roŸ
, 
node
)

59 
	`kmem_ˇche_‰ì
(
pxt4_sy°em_z⁄e_ˇchï
, 
íåy
);

60 
	}
}

67 
	$add_sy°em_z⁄e
(
pxt4_sy°em_blocks
 *
sy°em_blks
,

68 
pxt4_fsblk_t
 
°¨t_blk
,

69 
cou¡
)

71 
pxt4_sy°em_z⁄e
 *
√w_íåy
, *
íåy
;

72 
rb_node
 **
n
 = &
sy°em_blks
->
roŸ
.rb_node, *
node
;

73 
rb_node
 *
∑ª¡
 = 
NULL
, *
√w_node
 = NULL;

75 *
n
) {

76 
∑ª¡
 = *
n
;

77 
íåy
 = 
	`rb_íåy
(
∑ª¡
, 
pxt4_sy°em_z⁄e
, 
node
);

78 i‡(
°¨t_blk
 < 
íåy
->start_blk)

79 
n
 = &(*n)->
rb_À·
;

80 i‡(
°¨t_blk
 >(
íåy
->°¨t_blk +É¡ry->
cou¡
))

81 
n
 = &(*n)->
rb_right
;

83  -
EFSCORRUPTED
;

86 
√w_íåy
 = 
	`kmem_ˇche_Æloc
(
pxt4_sy°em_z⁄e_ˇchï
,

87 
GFP_KERNEL
);

88 i‡(!
√w_íåy
)

89  -
ENOMEM
;

90 
√w_íåy
->
°¨t_blk
 = start_blk;

91 
√w_íåy
->
cou¡
 = count;

92 
√w_node
 = &
√w_íåy
->
node
;

94 
	`rb_lök_node
(
√w_node
, 
∑ª¡
, 
n
);

95 
	`rb_ö£π_cﬁ‹
(
√w_node
, &
sy°em_blks
->
roŸ
);

98 
node
 = 
	`rb_¥ev
(
√w_node
);

99 i‡(
node
) {

100 
íåy
 = 
	`rb_íåy
(
node
, 
pxt4_sy°em_z⁄e
,Çode);

101 i‡(
	`ˇn_mîge
(
íåy
, 
√w_íåy
)) {

102 
√w_íåy
->
°¨t_blk
 = 
íåy
->start_blk;

103 
√w_íåy
->
cou¡
 +
íåy
->count;

104 
	`rb_îa£
(
node
, &
sy°em_blks
->
roŸ
);

105 
	`kmem_ˇche_‰ì
(
pxt4_sy°em_z⁄e_ˇchï
, 
íåy
);

110 
node
 = 
	`rb_√xt
(
√w_node
);

111 i‡(
node
) {

112 
íåy
 = 
	`rb_íåy
(
node
, 
pxt4_sy°em_z⁄e
,Çode);

113 i‡(
	`ˇn_mîge
(
√w_íåy
, 
íåy
)) {

114 
√w_íåy
->
cou¡
 +
íåy
->count;

115 
	`rb_îa£
(
node
, &
sy°em_blks
->
roŸ
);

116 
	`kmem_ˇche_‰ì
(
pxt4_sy°em_z⁄e_ˇchï
, 
íåy
);

120 
	}
}

122 
	$debug_¥öt_åì
(
pxt4_sb_öfo
 *
sbi
)

124 
rb_node
 *
node
;

125 
pxt4_sy°em_z⁄e
 *
íåy
;

126 
fú°
 = 1;

128 
	`¥ötk
(
KERN_INFO
 "System zones: ");

129 
node
 = 
	`rb_fú°
(&
sbi
->
sy°em_blks
->
roŸ
);

130 
node
) {

131 
íåy
 = 
	`rb_íåy
(
node
, 
pxt4_sy°em_z⁄e
,Çode);

132 
	`¥ötk
(
KERN_CONT
 "%s%Œu-%Œu", 
fú°
 ? "" : ", ",

133 
íåy
->
°¨t_blk
,É¡ry->°¨t_blk +É¡ry->
cou¡
 - 1);

134 
fú°
 = 0;

135 
node
 = 
	`rb_√xt
(node);

137 
	`¥ötk
(
KERN_CONT
 "\n");

138 
	}
}

145 
	$pxt4_d©a_block_vÆid_rcu
(
pxt4_sb_öfo
 *
sbi
,

146 
pxt4_sy°em_blocks
 *
sy°em_blks
,

147 
pxt4_fsblk_t
 
°¨t_blk
,

148 
cou¡
)

150 
pxt4_sy°em_z⁄e
 *
íåy
;

151 
rb_node
 *
n
;

153 i‡((
°¨t_blk
 <
	`À32_to_˝u
(
sbi
->
s_es
->
s_fú°_d©a_block
)) ||

154 (
°¨t_blk
 + 
cou¡
 < start_blk) ||

155 (
°¨t_blk
 + 
cou¡
 > 
	`pxt4_blocks_cou¡
(
sbi
->
s_es
))) {

156 
sbi
->
s_es
->
s_œ°_îr‹_block
 = 
	`˝u_to_À64
(
°¨t_blk
);

160 i‡(
sy°em_blks
 =
NULL
)

163 
n
 = 
sy°em_blks
->
roŸ
.
rb_node
;

164 
n
) {

165 
íåy
 = 
	`rb_íåy
(
n
, 
pxt4_sy°em_z⁄e
, 
node
);

166 i‡(
°¨t_blk
 + 
cou¡
 - 1 < 
íåy
->start_blk)

167 
n
 =Ç->
rb_À·
;

168 i‡(
°¨t_blk
 >(
íåy
->°¨t_blk +É¡ry->
cou¡
))

169 
n
 =Ç->
rb_right
;

171 
sbi
->
s_es
->
s_œ°_îr‹_block
 = 
	`˝u_to_À64
(
°¨t_blk
);

176 
	}
}

178 
	$pxt4_¥Ÿe˘_ª£rved_öode
(
su≥r_block
 *
sb
,

179 
pxt4_sy°em_blocks
 *
sy°em_blks
,

180 
u32
 
öo
)

182 
öode
 *inode;

183 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
sb
);

184 
pxt4_m≠_blocks
 
m≠
;

185 
u32
 
i
 = 0, 
num
;

186 
îr
 = 0, 
n
;

188 i‡((
öo
 < 
PXT4_ROOT_INO
) ||

189 (
öo
 > 
	`À32_to_˝u
(
sbi
->
s_es
->
s_öodes_cou¡
)))

190  -
EINVAL
;

191 
öode
 = 
	`pxt4_igë
(
sb
, 
öo
, 
PXT4_IGET_SPECIAL
);

192 i‡(
	`IS_ERR
(
öode
))

193  
	`PTR_ERR
(
öode
);

194 
num
 = (
öode
->
i_size
 + 
sb
->
s_blocksize
 - 1Ë>> sb->
s_blocksize_bôs
;

195 
i
 < 
num
) {

196 
	`c⁄d_ªsched
();

197 
m≠
.
m_lblk
 = 
i
;

198 
m≠
.
m_Àn
 = 
num
 - 
i
;

199 
n
 = 
	`pxt4_m≠_blocks
(
NULL
, 
öode
, &
m≠
, 0);

200 i‡(
n
 < 0) {

201 
îr
 = 
n
;

204 i‡(
n
 == 0) {

205 
i
++;

207 i‡(!
	`pxt4_d©a_block_vÆid_rcu
(
sbi
, 
sy°em_blks
,

208 
m≠
.
m_pblk
, 
n
)) {

209 
	`pxt4_îr‹
(
sb
, "blocks %llu-%llu from inode %u "

210 "ovîœ∞sy°em z⁄e", 
m≠
.
m_pblk
,

211 
m≠
.
m_pblk
 + m≠.
m_Àn
 - 1, 
öo
);

212 
îr
 = -
EFSCORRUPTED
;

215 
îr
 = 
	`add_sy°em_z⁄e
(
sy°em_blks
, 
m≠
.
m_pblk
, 
n
);

216 i‡(
îr
 < 0)

218 
i
 +
n
;

221 
	`ùut
(
öode
);

222  
îr
;

223 
	}
}

225 
	$pxt4_de°roy_sy°em_z⁄e
(
rcu_hód
 *
rcu
)

227 
pxt4_sy°em_blocks
 *
sy°em_blks
;

229 
sy°em_blks
 = 
	`c⁄èöî_of
(
rcu
, 
pxt4_sy°em_blocks
,Ñcu);

230 
	`ªÀa£_sy°em_z⁄e
(
sy°em_blks
);

231 
	`k‰ì
(
sy°em_blks
);

232 
	}
}

243 
	$pxt4_£tup_sy°em_z⁄e
(
su≥r_block
 *
sb
)

245 
pxt4_group_t
 
ngroups
 = 
	`pxt4_gë_groups_cou¡
(
sb
);

246 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
sb
);

247 
pxt4_sy°em_blocks
 *
sy°em_blks
;

248 
pxt4_group_desc
 *
gdp
;

249 
pxt4_group_t
 
i
;

250 
Êex_size
 = 
	`pxt4_Êex_bg_size
(
sbi
);

251 
ªt
;

253 
sy°em_blks
 = 
	`kzÆloc
((*sy°em_blks), 
GFP_KERNEL
);

254 i‡(!
sy°em_blks
)

255  -
ENOMEM
;

257 
i
=0; i < 
ngroups
; i++) {

258 
	`c⁄d_ªsched
();

259 i‡(
	`pxt4_bg_has_su≥r
(
sb
, 
i
) &&

260 ((
i
 < 5Ë|| ((ò% 
Êex_size
) == 0)))

261 
	`add_sy°em_z⁄e
(
sy°em_blks
,

262 
	`pxt4_group_fú°_block_no
(
sb
, 
i
),

263 
	`pxt4_bg_num_gdb
(
sb
, 
i
) + 1);

264 
gdp
 = 
	`pxt4_gë_group_desc
(
sb
, 
i
, 
NULL
);

265 
ªt
 = 
	`add_sy°em_z⁄e
(
sy°em_blks
,

266 
	`pxt4_block_bôm≠
(
sb
, 
gdp
), 1);

267 i‡(
ªt
)

268 
îr
;

269 
ªt
 = 
	`add_sy°em_z⁄e
(
sy°em_blks
,

270 
	`pxt4_öode_bôm≠
(
sb
, 
gdp
), 1);

271 i‡(
ªt
)

272 
îr
;

273 
ªt
 = 
	`add_sy°em_z⁄e
(
sy°em_blks
,

274 
	`pxt4_öode_èbÀ
(
sb
, 
gdp
),

275 
sbi
->
s_ôb_≥r_group
);

276 i‡(
ªt
)

277 
îr
;

279 i‡(
	`pxt4_has_„©uª_jou∫Æ
(
sb
Ë&& 
sbi
->
s_es
->
s_jou∫Æ_öum
) {

280 
ªt
 = 
	`pxt4_¥Ÿe˘_ª£rved_öode
(
sb
, 
sy°em_blks
,

281 
	`À32_to_˝u
(
sbi
->
s_es
->
s_jou∫Æ_öum
));

282 i‡(
ªt
)

283 
îr
;

291 
	`rcu_assign_poöãr
(
sbi
->
sy°em_blks
, system_blks);

293 i‡(
	`ã°_›t
(
sb
, 
DEBUG
))

294 
	`debug_¥öt_åì
(
sbi
);

296 
îr
:

297 
	`ªÀa£_sy°em_z⁄e
(
sy°em_blks
);

298 
	`k‰ì
(
sy°em_blks
);

299  
ªt
;

300 
	}
}

312 
	$pxt4_ªÀa£_sy°em_z⁄e
(
su≥r_block
 *
sb
)

314 
pxt4_sy°em_blocks
 *
sy°em_blks
;

316 
sy°em_blks
 = 
	`rcu_dîe„ªn˚_¥Ÿe˘ed
(
	`PXT4_SB
(
sb
)->system_blks,

317 
	`lockdï_is_hñd
(&
sb
->
s_umou¡
));

318 
	`rcu_assign_poöãr
(
	`PXT4_SB
(
sb
)->
sy°em_blks
, 
NULL
);

320 i‡(
sy°em_blks
)

321 
	`ˇŒ_rcu
(&
sy°em_blks
->
rcu
, 
pxt4_de°roy_sy°em_z⁄e
);

322 
	}
}

324 
	$pxt4_d©a_block_vÆid
(
pxt4_sb_öfo
 *
sbi
, 
pxt4_fsblk_t
 
°¨t_blk
,

325 
cou¡
)

327 
pxt4_sy°em_blocks
 *
sy°em_blks
;

328 
ªt
;

335 
	`rcu_ªad_lock
();

336 
sy°em_blks
 = 
	`rcu_dîe„ªn˚
(
sbi
->system_blks);

337 
ªt
 = 
	`pxt4_d©a_block_vÆid_rcu
(
sbi
, 
sy°em_blks
, 
°¨t_blk
,

338 
cou¡
);

339 
	`rcu_ªad_u∆ock
();

340  
ªt
;

341 
	}
}

343 
	$pxt4_check_blockªf
(c⁄° *
fun˘i⁄
, 
löe
,

344 
öode
 *öode, 
__À32
 *
p
, 
max
)

346 
pxt4_su≥r_block
 *
es
 = 
	`PXT4_SB
(
öode
->
i_sb
)->
s_es
;

347 
__À32
 *
bªf
 = 
p
;

348 
blk
;

350 i‡(
	`pxt4_has_„©uª_jou∫Æ
(
öode
->
i_sb
) &&

351 (
öode
->
i_öo
 ==

352 
	`À32_to_˝u
(
	`PXT4_SB
(
öode
->
i_sb
)->
s_es
->
s_jou∫Æ_öum
)))

355 
bªf
 < 
p
+
max
) {

356 
blk
 = 
	`À32_to_˝u
(*
bªf
++);

357 i‡(
blk
 &&

358 
	`u∆ikñy
(!
	`pxt4_d©a_block_vÆid
(
	`PXT4_SB
(
öode
->
i_sb
),

359 
blk
, 1))) {

360 
es
->
s_œ°_îr‹_block
 = 
	`˝u_to_À64
(
blk
);

361 
	`pxt4_îr‹_öode
(
öode
, 
fun˘i⁄
, 
löe
, 
blk
,

363  -
EFSCORRUPTED
;

367 
	}
}

	@dir.c

25 
	~<löux/fs.h
>

26 
	~<löux/buf„r_hód.h
>

27 
	~<löux/¶ab.h
>

28 
	~<löux/ivîsi⁄.h
>

29 
	~<löux/unicode.h
>

30 
	~"pxt4.h
"

31 
	~"x©å.h
"

33 
pxt4_dx_ªaddú
(
fûe
 *, 
dú_c⁄ãxt
 *);

45 
	$is_dx_dú
(
öode
 *inode)

47 
su≥r_block
 *
sb
 = 
öode
->
i_sb
;

49 i‡(
	`pxt4_has_„©uª_dú_ödex
(
öode
->
i_sb
) &&

50 ((
	`pxt4_ã°_öode_Êag
(
öode
, 
PXT4_INODE_INDEX
)) ||

51 ((
öode
->
i_size
 >> 
sb
->
s_blocksize_bôs
) == 1) ||

52 
	`pxt4_has_ölöe_d©a
(
öode
)))

56 
	}
}

66 
	$__pxt4_check_dú_íåy
(c⁄° *
fun˘i⁄
, 
löe
,

67 
öode
 *
dú
, 
fûe
 *
fûp
,

68 
pxt4_dú_íåy_2
 *
de
,

69 
buf„r_hód
 *
bh
, *
buf
, 
size
,

70 
off£t
)

72 c⁄° *
îr‹_msg
 = 
NULL
;

73 c⁄° 
æí
 = 
	`pxt4_ªc_Àn_‰om_disk
(
de
->
ªc_Àn
,

74 
dú
->
i_sb
->
s_blocksize
);

76 i‡(
	`u∆ikñy
(
æí
 < 
	`PXT4_DIR_REC_LEN
(1)))

77 
îr‹_msg
 = "rec_len is smallerÅhan minimal";

78 i‡(
	`u∆ikñy
(
æí
 % 4 != 0))

79 
îr‹_msg
 = "rec_len % 4 != 0";

80 i‡(
	`u∆ikñy
(
æí
 < 
	`PXT4_DIR_REC_LEN
(
de
->
«me_Àn
)))

81 
îr‹_msg
 = "rec_len isÅoo small forÇame_len";

82 i‡(
	`u∆ikñy
(((*Ë
de
 - 
buf
Ë+ 
æí
 > 
size
))

83 
îr‹_msg
 = "directoryÉntry overrun";

84 i‡(
	`u∆ikñy
(((*Ë
de
 - 
buf
Ë+ 
æí
 >

85 
size
 - 
	`PXT4_DIR_REC_LEN
(1) &&

86 ((*Ë
de
 - 
buf
Ë+ 
æí
 !
size
)) {

87 
îr‹_msg
 = "directoryÉntryÅoo closeÅo blockÉnd";

89 i‡(
	`u∆ikñy
(
	`À32_to_˝u
(
de
->
öode
) >

90 
	`À32_to_˝u
(
	`PXT4_SB
(
dú
->
i_sb
)->
s_es
->
s_öodes_cou¡
)))

91 
îr‹_msg
 = "inode out of bounds";

95 i‡(
fûp
)

96 
	`pxt4_îr‹_fûe
(
fûp
, 
fun˘i⁄
, 
löe
, 
bh
->
b_blockƒ
,

99 
îr‹_msg
, 
off£t
, 
	`À32_to_˝u
(
de
->
öode
),

100 
æí
, 
de
->
«me_Àn
, 
size
);

102 
	`pxt4_îr‹_öode
(
dú
, 
fun˘i⁄
, 
löe
, 
bh
->
b_blockƒ
,

105 
îr‹_msg
, 
off£t
, 
	`À32_to_˝u
(
de
->
öode
),

106 
æí
, 
de
->
«me_Àn
, 
size
);

109 
	}
}

111 
	$pxt4_ªaddú
(
fûe
 *fûe, 
dú_c⁄ãxt
 *
˘x
)

113 
off£t
;

114 
i
;

115 
pxt4_dú_íåy_2
 *
de
;

116 
îr
;

117 
öode
 *öodê
	`fûe_öode
(
fûe
);

118 
su≥r_block
 *
sb
 = 
öode
->
i_sb
;

119 
buf„r_hód
 *
bh
 = 
NULL
;

120 
fs¸y±_°r
 
f°r
 = 
	`FSTR_INIT
(
NULL
, 0);

122 i‡(
	`IS_ENCRYPTED
(
öode
)) {

123 
îr
 = 
	`fs¸y±_gë_í¸y±i⁄_öfo
(
öode
);

124 i‡(
îr
 &&Éº !-
ENOKEY
)

125  
îr
;

128 i‡(
	`is_dx_dú
(
öode
)) {

129 
îr
 = 
	`pxt4_dx_ªaddú
(
fûe
, 
˘x
);

130 i‡(
îr
 !
ERR_BAD_DX_DIR
) {

131  
îr
;

134 i‡(!
	`pxt4_has_mëad©a_csum
(
sb
)) {

139 
	`pxt4_˛ór_öode_Êag
(
öode
, 
PXT4_INODE_INDEX
);

143 i‡(
	`pxt4_has_ölöe_d©a
(
öode
)) {

144 
has_ölöe_d©a
 = 1;

145 
îr
 = 
	`pxt4_ªad_ölöe_dú
(
fûe
, 
˘x
,

146 &
has_ölöe_d©a
);

147 i‡(
has_ölöe_d©a
)

148  
îr
;

151 i‡(
	`IS_ENCRYPTED
(
öode
)) {

152 
îr
 = 
	`fs¸y±_‚ame_Æloc_buf„r
(
öode
, 
PXT4_NAME_LEN
, &
f°r
);

153 i‡(
îr
 < 0)

154  
îr
;

157 
˘x
->
pos
 < 
öode
->
i_size
) {

158 
pxt4_m≠_blocks
 
m≠
;

160 i‡(
	`Áèl_sig«l_≥ndög
(
cuºít
)) {

161 
îr
 = -
ERESTARTSYS
;

162 
îrout
;

164 
	`c⁄d_ªsched
();

165 
off£t
 = 
˘x
->
pos
 & (
sb
->
s_blocksize
 - 1);

166 
m≠
.
m_lblk
 = 
˘x
->
pos
 >> 
	`PXT4_BLOCK_SIZE_BITS
(
sb
);

167 
m≠
.
m_Àn
 = 1;

168 
îr
 = 
	`pxt4_m≠_blocks
(
NULL
, 
öode
, &
m≠
, 0);

169 i‡(
îr
 == 0) {

172 i‡(
m≠
.
m_Àn
 == 0)

173 
m≠
.
m_Àn
 = 1;

174 
˘x
->
pos
 +
m≠
.
m_Àn
 * 
sb
->
s_blocksize
;

177 i‡(
îr
 > 0) {

178 
pgoff_t
 
ödex
 = 
m≠
.
m_pblk
 >>

179 (
PAGE_SHIFT
 - 
öode
->
i_blkbôs
);

180 i‡(!
	`ø_has_ödex
(&
fûe
->
f_ø
, 
ödex
))

181 
	`∑ge_ˇche_sync_ªadahód
(

182 
sb
->
s_bdev
->
bd_öode
->
i_m≠pög
,

183 &
fûe
->
f_ø
, file,

184 
ödex
, 1);

185 
fûe
->
f_ø
.
¥ev_pos
 = (
loff_t
)
ödex
 << 
PAGE_SHIFT
;

186 
bh
 = 
	`pxt4_bªad
(
NULL
, 
öode
, 
m≠
.
m_lblk
, 0);

187 i‡(
	`IS_ERR
(
bh
)) {

188 
îr
 = 
	`PTR_ERR
(
bh
);

189 
bh
 = 
NULL
;

190 
îrout
;

194 i‡(!
bh
) {

196 i‡(
˘x
->
pos
 > 
öode
->
i_blocks
 << 9)

198 
˘x
->
pos
 +
sb
->
s_blocksize
 - 
off£t
;

203 i‡(!
	`buf„r_vîifõd
(
bh
) &&

204 !
	`pxt4_dúblock_csum_vîify
(
öode
, 
bh
)) {

205 
	`PXT4_ERROR_FILE
(
fûe
, 0, "directory fails checksum "

207 ()
˘x
->
pos
);

208 
˘x
->
pos
 +
sb
->
s_blocksize
 - 
off£t
;

209 
	`bªl£
(
bh
);

210 
bh
 = 
NULL
;

213 
	`£t_buf„r_vîifõd
(
bh
);

219 i‡(!
	`öode_eq_ivîsi⁄
(
öode
, 
fûe
->
f_vîsi⁄
)) {

220 
i
 = 0; i < 
sb
->
s_blocksize
 && i < 
off£t
; ) {

221 
de
 = (
pxt4_dú_íåy_2
 *)

222 (
bh
->
b_d©a
 + 
i
);

229 i‡(
	`pxt4_ªc_Àn_‰om_disk
(
de
->
ªc_Àn
,

230 
sb
->
s_blocksize
Ë< 
	`PXT4_DIR_REC_LEN
(1))

232 
i
 +
	`pxt4_ªc_Àn_‰om_disk
(
de
->
ªc_Àn
,

233 
sb
->
s_blocksize
);

235 
off£t
 = 
i
;

236 
˘x
->
pos
 = (˘x->po†& ~(
sb
->
s_blocksize
 - 1))

237 | 
off£t
;

238 
fûe
->
f_vîsi⁄
 = 
	`öode_quîy_ivîsi⁄
(
öode
);

241 
˘x
->
pos
 < 
öode
->
i_size


242 && 
off£t
 < 
sb
->
s_blocksize
) {

243 
de
 = (
pxt4_dú_íåy_2
 *Ë(
bh
->
b_d©a
 + 
off£t
);

244 i‡(
	`pxt4_check_dú_íåy
(
öode
, 
fûe
, 
de
, 
bh
,

245 
bh
->
b_d©a
, bh->
b_size
,

246 
off£t
)) {

250 
˘x
->
pos
 = (ctx->pos |

251 (
sb
->
s_blocksize
 - 1)) + 1;

254 
off£t
 +
	`pxt4_ªc_Àn_‰om_disk
(
de
->
ªc_Àn
,

255 
sb
->
s_blocksize
);

256 i‡(
	`À32_to_˝u
(
de
->
öode
)) {

257 i‡(!
	`IS_ENCRYPTED
(
öode
)) {

258 i‡(!
	`dú_emô
(
˘x
, 
de
->
«me
,

259 
de
->
«me_Àn
,

260 
	`À32_to_˝u
(
de
->
öode
),

261 
	`gë_dty≥
(
sb
, 
de
->
fûe_ty≥
)))

262 
d⁄e
;

264 
ßve_Àn
 = 
f°r
.
Àn
;

265 
fs¸y±_°r
 
de_«me
 =

266 
	`FSTR_INIT
(
de
->
«me
,

267 
de
->
«me_Àn
);

270 
îr
 = 
	`fs¸y±_‚ame_disk_to_u§
(
öode
,

271 0, 0, &
de_«me
, &
f°r
);

272 
de_«me
 = 
f°r
;

273 
f°r
.
Àn
 = 
ßve_Àn
;

274 i‡(
îr
)

275 
îrout
;

276 i‡(!
	`dú_emô
(
˘x
,

277 
de_«me
.
«me
, de_«me.
Àn
,

278 
	`À32_to_˝u
(
de
->
öode
),

279 
	`gë_dty≥
(
sb
, 
de
->
fûe_ty≥
)))

280 
d⁄e
;

283 
˘x
->
pos
 +
	`pxt4_ªc_Àn_‰om_disk
(
de
->
ªc_Àn
,

284 
sb
->
s_blocksize
);

286 i‡((
˘x
->
pos
 < 
öode
->
i_size
Ë&& !
	`dú_ªœx_sh¨ed
(inode))

287 
d⁄e
;

288 
	`bªl£
(
bh
);

289 
bh
 = 
NULL
;

290 
off£t
 = 0;

292 
d⁄e
:

293 
îr
 = 0;

294 
îrout
:

295 
	`fs¸y±_‚ame_‰ì_buf„r
(&
f°r
);

296 
	`bªl£
(
bh
);

297  
îr
;

298 
	}
}

300 
ölöe
 
	$is_32bô_≠i
()

302 #ifde‡
CONFIG_COMPAT


303  
	`ö_com∑t_sysˇŒ
();

305  (
BITS_PER_LONG
 == 32);

307 
	}
}

318 
ölöe
 
loff_t
 
	$hash2pos
(
fûe
 *
fûp
, 
__u32
 
maj‹
, __u32 
mö‹
)

320 i‡((
fûp
->
f_mode
 & 
FMODE_32BITHASH
) ||

321 (!(
fûp
->
f_mode
 & 
FMODE_64BITHASH
Ë&& 
	`is_32bô_≠i
()))

322  
maj‹
 >> 1;

324  ((
__u64
)(
maj‹
 >> 1Ë<< 32Ë| (__u64)
mö‹
;

325 
	}
}

327 
ölöe
 
__u32
 
	$pos2maj_hash
(
fûe
 *
fûp
, 
loff_t
 
pos
)

329 i‡((
fûp
->
f_mode
 & 
FMODE_32BITHASH
) ||

330 (!(
fûp
->
f_mode
 & 
FMODE_64BITHASH
Ë&& 
	`is_32bô_≠i
()))

331  (
pos
 << 1) & 0xffffffff;

333  ((
pos
 >> 32) << 1) & 0xffffffff;

334 
	}
}

336 
ölöe
 
__u32
 
	$pos2mö_hash
(
fûe
 *
fûp
, 
loff_t
 
pos
)

338 i‡((
fûp
->
f_mode
 & 
FMODE_32BITHASH
) ||

339 (!(
fûp
->
f_mode
 & 
FMODE_64BITHASH
Ë&& 
	`is_32bô_≠i
()))

342  
pos
 & 0xffffffff;

343 
	}
}

348 
ölöe
 
loff_t
 
	$pxt4_gë_håì_eof
(
fûe
 *
fûp
)

350 i‡((
fûp
->
f_mode
 & 
FMODE_32BITHASH
) ||

351 (!(
fûp
->
f_mode
 & 
FMODE_64BITHASH
Ë&& 
	`is_32bô_≠i
()))

352  
PXT4_HTREE_EOF_32BIT
;

354  
PXT4_HTREE_EOF_64BIT
;

355 
	}
}

369 
loff_t
 
	$pxt4_dú_Œ£ek
(
fûe
 *fûe, 
loff_t
 
off£t
, 
whí˚
)

371 
öode
 *öodê
fûe
->
f_m≠pög
->
ho°
;

372 
dx_dú
 = 
	`is_dx_dú
(
öode
);

373 
loff_t
 
ªt
, 
håì_max
 = 
	`pxt4_gë_håì_eof
(
fûe
);

375 i‡(
	`likñy
(
dx_dú
))

376 
ªt
 = 
	`gíîic_fûe_Œ£ek_size
(
fûe
, 
off£t
, 
whí˚
,

377 
håì_max
, htree_max);

379 
ªt
 = 
	`pxt4_Œ£ek
(
fûe
, 
off£t
, 
whí˚
);

380 
fûe
->
f_vîsi⁄
 = 
	`öode_≥ek_ivîsi⁄
(
öode
) - 1;

381  
ªt
;

382 
	}
}

388 
	s‚ame
 {

389 
__u32
 
	mhash
;

390 
__u32
 
	mmö‹_hash
;

391 
rb_node
 
	mrb_hash
;

392 
‚ame
 *
	m√xt
;

393 
__u32
 
	möode
;

394 
__u8
 
	m«me_Àn
;

395 
__u8
 
	mfûe_ty≥
;

396 
	m«me
[0];

403 
	$‰ì_rb_åì_‚ame
(
rb_roŸ
 *
roŸ
)

405 
‚ame
 *‚ame, *
√xt
;

407 
	`rbåì_po°‹dî_f‹_óch_íåy_ß„
(
‚ame
, 
√xt
, 
roŸ
, 
rb_hash
)

408 
‚ame
) {

409 
‚ame
 *
ﬁd
 = fname;

410 
‚ame
 = f«me->
√xt
;

411 
	`k‰ì
(
ﬁd
);

414 *
roŸ
 = 
RB_ROOT
;

415 
	}
}

418 
dú_¥iv©e_öfo
 *
	$pxt4_håì_¸óã_dú_öfo
(
fûe
 *
fûp
,

419 
loff_t
 
pos
)

421 
dú_¥iv©e_öfo
 *
p
;

423 
p
 = 
	`kzÆloc
((*p), 
GFP_KERNEL
);

424 i‡(!
p
)

425  
NULL
;

426 
p
->
cuº_hash
 = 
	`pos2maj_hash
(
fûp
, 
pos
);

427 
p
->
cuº_mö‹_hash
 = 
	`pos2mö_hash
(
fûp
, 
pos
);

428  
p
;

429 
	}
}

431 
	$pxt4_håì_‰ì_dú_öfo
(
dú_¥iv©e_öfo
 *
p
)

433 
	`‰ì_rb_åì_‚ame
(&
p
->
roŸ
);

434 
	`k‰ì
(
p
);

435 
	}
}

444 
	$pxt4_håì_°‹e_dúít
(
fûe
 *
dú_fûe
, 
__u32
 
hash
,

445 
__u32
 
mö‹_hash
,

446 
pxt4_dú_íåy_2
 *
dúít
,

447 
fs¸y±_°r
 *
ít_«me
)

449 
rb_node
 **
p
, *
∑ª¡
 = 
NULL
;

450 
‚ame
 *‚ame, *
√w_‚
;

451 
dú_¥iv©e_öfo
 *
öfo
;

452 
Àn
;

454 
öfo
 = 
dú_fûe
->
¥iv©e_d©a
;

455 
p
 = &
öfo
->
roŸ
.
rb_node
;

458 
Àn
 = (
‚ame
Ë+ 
ít_«me
->len + 1;

459 
√w_‚
 = 
	`kzÆloc
(
Àn
, 
GFP_KERNEL
);

460 i‡(!
√w_‚
)

461  -
ENOMEM
;

462 
√w_‚
->
hash
 = hash;

463 
√w_‚
->
mö‹_hash
 = minor_hash;

464 
√w_‚
->
öode
 = 
	`À32_to_˝u
(
dúít
->inode);

465 
√w_‚
->
«me_Àn
 = 
ít_«me
->
Àn
;

466 
√w_‚
->
fûe_ty≥
 = 
dúít
->file_type;

467 
	`mem˝y
(
√w_‚
->
«me
, 
ít_«me
->«me,É¡_«me->
Àn
);

468 
√w_‚
->
«me
[
ít_«me
->
Àn
] = 0;

470 *
p
) {

471 
∑ª¡
 = *
p
;

472 
‚ame
 = 
	`rb_íåy
(
∑ª¡
, ‚ame, 
rb_hash
);

478 i‡((
√w_‚
->
hash
 =
‚ame
->hash) &&

479 (
√w_‚
->
mö‹_hash
 =
‚ame
->minor_hash)) {

480 
√w_‚
->
√xt
 = 
‚ame
->next;

481 
‚ame
->
√xt
 = 
√w_‚
;

485 i‡(
√w_‚
->
hash
 < 
‚ame
->hash)

486 
p
 = &(*p)->
rb_À·
;

487 i‡(
√w_‚
->
hash
 > 
‚ame
->hash)

488 
p
 = &(*p)->
rb_right
;

489 i‡(
√w_‚
->
mö‹_hash
 < 
‚ame
->minor_hash)

490 
p
 = &(*p)->
rb_À·
;

492 
p
 = &(*p)->
rb_right
;

495 
	`rb_lök_node
(&
√w_‚
->
rb_hash
, 
∑ª¡
, 
p
);

496 
	`rb_ö£π_cﬁ‹
(&
√w_‚
->
rb_hash
, &
öfo
->
roŸ
);

498 
	}
}

507 
	$ˇŒ_fûldú
(
fûe
 *fûe, 
dú_c⁄ãxt
 *
˘x
,

508 
‚ame
 *fname)

510 
dú_¥iv©e_öfo
 *
öfo
 = 
fûe
->
¥iv©e_d©a
;

511 
öode
 *öodê
	`fûe_öode
(
fûe
);

512 
su≥r_block
 *
sb
 = 
öode
->
i_sb
;

514 i‡(!
‚ame
) {

515 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "%s:%d: inode #%lu: comm %s: "

516 "ˇŒed wôhÇuŒ f«me?!?", 
__func__
, 
__LINE__
,

517 
öode
->
i_öo
, 
cuºít
->
comm
);

520 
˘x
->
pos
 = 
	`hash2pos
(
fûe
, 
‚ame
->
hash
, f«me->
mö‹_hash
);

521 
‚ame
) {

522 i‡(!
	`dú_emô
(
˘x
, 
‚ame
->
«me
,

523 
‚ame
->
«me_Àn
,

524 
‚ame
->
öode
,

525 
	`gë_dty≥
(
sb
, 
‚ame
->
fûe_ty≥
))) {

526 
öfo
->
exåa_‚ame
 = 
‚ame
;

529 
‚ame
 = f«me->
√xt
;

532 
	}
}

534 
	$pxt4_dx_ªaddú
(
fûe
 *fûe, 
dú_c⁄ãxt
 *
˘x
)

536 
dú_¥iv©e_öfo
 *
öfo
 = 
fûe
->
¥iv©e_d©a
;

537 
öode
 *öodê
	`fûe_öode
(
fûe
);

538 
‚ame
 *fname;

539 
ªt
;

541 i‡(!
öfo
) {

542 
öfo
 = 
	`pxt4_håì_¸óã_dú_öfo
(
fûe
, 
˘x
->
pos
);

543 i‡(!
öfo
)

544  -
ENOMEM
;

545 
fûe
->
¥iv©e_d©a
 = 
öfo
;

548 i‡(
˘x
->
pos
 =
	`pxt4_gë_håì_eof
(
fûe
))

552 i‡(
öfo
->
œ°_pos
 !
˘x
->
pos
) {

553 
	`‰ì_rb_åì_‚ame
(&
öfo
->
roŸ
);

554 
öfo
->
cuº_node
 = 
NULL
;

555 
öfo
->
exåa_‚ame
 = 
NULL
;

556 
öfo
->
cuº_hash
 = 
	`pos2maj_hash
(
fûe
, 
˘x
->
pos
);

557 
öfo
->
cuº_mö‹_hash
 = 
	`pos2mö_hash
(
fûe
, 
˘x
->
pos
);

564 i‡(
öfo
->
exåa_‚ame
) {

565 i‡(
	`ˇŒ_fûldú
(
fûe
, 
˘x
, 
öfo
->
exåa_‚ame
))

566 
föished
;

567 
öfo
->
exåa_‚ame
 = 
NULL
;

568 
√xt_node
;

569 } i‡(!
öfo
->
cuº_node
)

570 
öfo
->
cuº_node
 = 
	`rb_fú°
(&öfo->
roŸ
);

578 i‡((!
öfo
->
cuº_node
) ||

579 !
	`öode_eq_ivîsi⁄
(
öode
, 
fûe
->
f_vîsi⁄
)) {

580 
öfo
->
cuº_node
 = 
NULL
;

581 
	`‰ì_rb_åì_‚ame
(&
öfo
->
roŸ
);

582 
fûe
->
f_vîsi⁄
 = 
	`öode_quîy_ivîsi⁄
(
öode
);

583 
ªt
 = 
	`pxt4_håì_fûl_åì
(
fûe
, 
öfo
->
cuº_hash
,

584 
öfo
->
cuº_mö‹_hash
,

585 &
öfo
->
√xt_hash
);

586 i‡(
ªt
 < 0)

587  
ªt
;

588 i‡(
ªt
 == 0) {

589 
˘x
->
pos
 = 
	`pxt4_gë_håì_eof
(
fûe
);

592 
öfo
->
cuº_node
 = 
	`rb_fú°
(&öfo->
roŸ
);

595 
‚ame
 = 
	`rb_íåy
(
öfo
->
cuº_node
, ‚ame, 
rb_hash
);

596 
öfo
->
cuº_hash
 = 
‚ame
->
hash
;

597 
öfo
->
cuº_mö‹_hash
 = 
‚ame
->
mö‹_hash
;

598 i‡(
	`ˇŒ_fûldú
(
fûe
, 
˘x
, 
‚ame
))

600 
√xt_node
:

601 
öfo
->
cuº_node
 = 
	`rb_√xt
(info->curr_node);

602 i‡(
öfo
->
cuº_node
) {

603 
‚ame
 = 
	`rb_íåy
(
öfo
->
cuº_node
, fname,

604 
rb_hash
);

605 
öfo
->
cuº_hash
 = 
‚ame
->
hash
;

606 
öfo
->
cuº_mö‹_hash
 = 
‚ame
->
mö‹_hash
;

608 i‡(
öfo
->
√xt_hash
 == ~0) {

609 
˘x
->
pos
 = 
	`pxt4_gë_håì_eof
(
fûe
);

612 
öfo
->
cuº_hash
 = info->
√xt_hash
;

613 
öfo
->
cuº_mö‹_hash
 = 0;

616 
föished
:

617 
öfo
->
œ°_pos
 = 
˘x
->
pos
;

619 
	}
}

621 
	$pxt4_dú_›í
(
öode
 * inode, 
fûe
 * 
fûp
)

623 i‡(
	`IS_ENCRYPTED
(
öode
))

624  
	`fs¸y±_gë_í¸y±i⁄_öfo
(
öode
Ë? -
EACCES
 : 0;

626 
	}
}

628 
	$pxt4_ªÀa£_dú
(
öode
 *öode, 
fûe
 *
fûp
)

630 i‡(
fûp
->
¥iv©e_d©a
)

631 
	`pxt4_håì_‰ì_dú_öfo
(
fûp
->
¥iv©e_d©a
);

634 
	}
}

636 
	$pxt4_check_Æl_de
(
öode
 *
dú
, 
buf„r_hód
 *
bh
, *
buf
,

637 
buf_size
)

639 
pxt4_dú_íåy_2
 *
de
;

640 
æí
;

641 
off£t
 = 0;

642 *
t›
;

644 
de
 = (
pxt4_dú_íåy_2
 *)
buf
;

645 
t›
 = 
buf
 + 
buf_size
;

646 (*Ë
de
 < 
t›
) {

647 i‡(
	`pxt4_check_dú_íåy
(
dú
, 
NULL
, 
de
, 
bh
,

648 
buf
, 
buf_size
, 
off£t
))

649  -
EFSCORRUPTED
;

650 
æí
 = 
	`pxt4_ªc_Àn_‰om_disk
(
de
->
ªc_Àn
, 
buf_size
);

651 
de
 = (
pxt4_dú_íåy_2
 *)((*)dê+ 
æí
);

652 
off£t
 +
æí
;

654 i‡((*Ë
de
 > 
t›
)

655  -
EFSCORRUPTED
;

658 
	}
}

660 c⁄° 
fûe_›î©i⁄s
 
	gpxt4_dú_›î©i⁄s
 = {

661 .
Œ£ek
 = 
pxt4_dú_Œ£ek
,

662 .
	gªad
 = 
gíîic_ªad_dú
,

663 .
	gôî©e_sh¨ed
 = 
pxt4_ªaddú
,

664 .
	gu∆ocked_io˘l
 = 
pxt4_io˘l
,

665 #ifde‡
CONFIG_COMPAT


666 .
	gcom∑t_io˘l
 = 
pxt4_com∑t_io˘l
,

668 .
	gfsync
 = 
pxt4_sync_fûe
,

669 .
	g›í
 = 
pxt4_dú_›í
,

670 .
	gªÀa£
 = 
pxt4_ªÀa£_dú
,

673 #ifde‡
CONFIG_UNICODE


674 
	$pxt4_d_com∑ª
(c⁄° 
díåy
 *díåy, 
Àn
,

675 c⁄° *
°r
, c⁄° 
q°r
 *
«me
)

677 
q°r
 q°∏{.
«me
 = 
°r
, .
Àn
 =Üen };

678 c⁄° 
díåy
 *
∑ª¡
 = 
	`READ_ONCE
(díåy->
d_∑ª¡
);

679 c⁄° 
öode
 *öodê
	`READ_ONCE
(
∑ª¡
->
d_öode
);

680 
°rbuf
[
DNAME_INLINE_LEN
];

682 i‡(!
öode
 || !
	`IS_CASEFOLDED
(inode) ||

683 !
	`PXT4_SB
(
öode
->
i_sb
)->
s_ícodög
) {

684 i‡(
Àn
 !
«me
->len)

686  
	`memcmp
(
°r
, 
«me
->«me, 
Àn
);

696 i‡(
Àn
 <
DNAME_INLINE_LEN
 - 1) {

697 
	`mem˝y
(
°rbuf
, 
°r
, 
Àn
);

698 
°rbuf
[
Àn
] = 0;

699 
q°r
.
«me
 = 
°rbuf
;

701 
	`b¨rõr
();

704  
	`pxt4_ci_com∑ª
(
öode
, 
«me
, &
q°r
, 
Ál£
);

705 
	}
}

707 
	$pxt4_d_hash
(c⁄° 
díåy
 *díåy, 
q°r
 *
°r
)

709 c⁄° 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
díåy
->
d_sb
);

710 c⁄° 
unicode_m≠
 *
um
 = 
sbi
->
s_ícodög
;

711 c⁄° 
öode
 *öodê
	`READ_ONCE
(
díåy
->
d_öode
);

712 *
n‹m
;

713 
Àn
, 
ªt
 = 0;

715 i‡(!
öode
 || !
	`IS_CASEFOLDED
(öodeË|| !
um
)

718 
n‹m
 = 
	`kmÆloc
(
PATH_MAX
, 
GFP_ATOMIC
);

719 i‡(!
n‹m
)

720  -
ENOMEM
;

722 
Àn
 = 
	`utf8_ˇ£fﬁd
(
um
, 
°r
, 
n‹m
, 
PATH_MAX
);

723 i‡(
Àn
 < 0) {

724 i‡(
	`pxt4_has_°ri˘_mode
(
sbi
))

725 
ªt
 = -
EINVAL
;

726 
out
;

728 
°r
->
hash
 = 
	`fuŒ_«me_hash
(
díåy
, 
n‹m
, 
Àn
);

729 
out
:

730 
	`k‰ì
(
n‹m
);

731  
ªt
;

732 
	}
}

734 c⁄° 
díåy_›î©i⁄s
 
	gpxt4_díåy_›s
 = {

735 .
d_hash
 = 
pxt4_d_hash
,

736 .
	gd_com∑ª
 = 
pxt4_d_com∑ª
,

	@ext4.h

17 #i‚de‡
_PXT4_H


18 
	#_PXT4_H


	)

20 
	~<löux/ty≥s.h
>

21 
	~<löux/blkdev.h
>

22 
	~<löux/magic.h
>

23 
	~<löux/jbd3.h
>

24 
	~<löux/quŸa.h
>

25 
	~<löux/rw£m.h
>

26 
	~<löux/rbåì.h
>

27 
	~<löux/£qlock.h
>

28 
	~<löux/muãx.h
>

29 
	~<löux/timî.h
>

30 
	~<löux/vîsi⁄.h
>

31 
	~<löux/waô.h
>

32 
	~<löux/sched/sig«l.h
>

33 
	~<löux/blockgroup_lock.h
>

34 
	~<löux/≥r˝u_cou¡î.h
>

35 
	~<löux/øãlimô.h
>

36 
	~<¸y±o/hash.h
>

37 
	~<löux/ÁŒoc.h
>

38 
	~<löux/≥r˝u-rw£m.h
>

39 #ifde‡
__KERNEL__


40 
	~<löux/com∑t.h
>

43 
	~<löux/fs¸y±.h
>

44 
	~<löux/fsvîôy.h
>

46 
	~<löux/compûî.h
>

56 
	#AGGRESSIVE_CHECK__


	)

62 
	#DOUBLE_CHECK__


	)

67 #unde‡
PXT4FS_DEBUG


72 #ifde‡
PXT4FS_DEBUG


73 
	#pxt4_debug
(
f
, 
a
...) \

75 
	`¥ötk
(
KERN_DEBUG
 "PXT4-fs DEBUG (%s, %d): %s:", \

76 
__FILE__
, 
__LINE__
, 
__func__
); \

77 
	`¥ötk
(
KERN_DEBUG
 
f
, ## 
a
); \

78 } 0)

	)

80 
	#pxt4_debug
(
fmt
, ...Ë
	`no_¥ötk
(fmt, ##
__VA_ARGS__
)

	)

86 
	#EXT_DEBUG__


	)

87 #ifde‡
EXT_DEBUG


88 
	#ext_debug
(
fmt
, ...Ë
	`¥ötk
(fmt, ##
__VA_ARGS__
)

	)

90 
	#ext_debug
(
fmt
, ...Ë
	`no_¥ötk
(fmt, ##
__VA_ARGS__
)

	)

94 
	tpxt4_gΩblk_t
;

97 
	tpxt4_fsblk_t
;

100 
__u32
 
	tpxt4_lblk_t
;

103 
	tpxt4_group_t
;

105 
	eSHIFT_DIRECTION
 {

106 
	mSHIFT_LEFT
 = 0,

107 
	mSHIFT_RIGHT
,

118 
	#PXT4_MB_HINT_MERGE
 0x0001

	)

120 
	#PXT4_MB_HINT_RESERVED
 0x0002

	)

122 
	#PXT4_MB_HINT_METADATA
 0x0004

	)

124 
	#PXT4_MB_HINT_FIRST
 0x0008

	)

126 
	#PXT4_MB_HINT_BEST
 0x0010

	)

128 
	#PXT4_MB_HINT_DATA
 0x0020

	)

130 
	#PXT4_MB_HINT_NOPREALLOC
 0x0040

	)

132 
	#PXT4_MB_HINT_GROUP_ALLOC
 0x0080

	)

134 
	#PXT4_MB_HINT_GOAL_ONLY
 0x0100

	)

136 
	#PXT4_MB_HINT_TRY_GOAL
 0x0200

	)

138 
	#PXT4_MB_DELALLOC_RESERVED
 0x0400

	)

140 
	#PXT4_MB_STREAM_ALLOC
 0x0800

	)

142 
	#PXT4_MB_USE_ROOT_BLOCKS
 0x1000

	)

144 
	#PXT4_MB_USE_RESERVED
 0x2000

	)

146 
	spxt4_Æloˇti⁄_ªque°
 {

148 
öode
 *
	möode
;

150 
	mÀn
;

152 
pxt4_lblk_t
 
	mlogiˇl
;

154 
pxt4_lblk_t
 
	mŒe·
;

156 
pxt4_lblk_t
 
	mÃight
;

158 
pxt4_fsblk_t
 
	mgﬂl
;

160 
pxt4_fsblk_t
 
	m∂e·
;

162 
pxt4_fsblk_t
 
	m¥ight
;

164 
	mÊags
;

174 
	#PXT4_MAP_NEW
 (1 << 
BH_New
)

	)

175 
	#PXT4_MAP_MAPPED
 (1 << 
BH_M≠≥d
)

	)

176 
	#PXT4_MAP_UNWRITTEN
 (1 << 
BH_Unwrôãn
)

	)

177 
	#PXT4_MAP_BOUNDARY
 (1 << 
BH_Bound¨y
)

	)

178 
	#PXT4_MAP_FLAGS
 (
PXT4_MAP_NEW
 | 
PXT4_MAP_MAPPED
 |\

179 
PXT4_MAP_UNWRITTEN
 | 
PXT4_MAP_BOUNDARY
)

	)

181 
	spxt4_m≠_blocks
 {

182 
pxt4_fsblk_t
 
	mm_pblk
;

183 
pxt4_lblk_t
 
	mm_lblk
;

184 
	mm_Àn
;

185 
	mm_Êags
;

191 
	spxt4_sy°em_blocks
 {

192 
rb_roŸ
 
	mroŸ
;

193 
rcu_hód
 
	mrcu
;

199 
	#PXT4_IO_END_UNWRITTEN
 0x0001

	)

205 
	spxt4_io_íd
 {

206 
li°_hód
 
	mli°
;

207 
h™dÀ_t
 *
	mh™dÀ
;

209 
öode
 *
	möode
;

210 
bio
 *
	mbio
;

212 
	mÊag
;

213 
©omic_t
 
	mcou¡
;

214 
loff_t
 
	moff£t
;

215 
ssize_t
 
	msize
;

216 } 
	tpxt4_io_íd_t
;

218 
	spxt4_io_submô
 {

219 
wrôeback_c⁄åﬁ
 *
	mio_wbc
;

220 
bio
 *
	mio_bio
;

221 
pxt4_io_íd_t
 *
	mio_íd
;

222 
£˘‹_t
 
	mio_√xt_block
;

228 
	#PXT4_BAD_INO
 1

	)

229 
	#PXT4_ROOT_INO
 2

	)

230 
	#PXT4_USR_QUOTA_INO
 3

	)

231 
	#PXT4_GRP_QUOTA_INO
 4

	)

232 
	#PXT4_BOOT_LOADER_INO
 5

	)

233 
	#PXT4_UNDEL_DIR_INO
 6

	)

234 
	#PXT4_RESIZE_INO
 7

	)

235 
	#PXT4_JOURNAL_INO
 8

	)

238 
	#PXT4_GOOD_OLD_FIRST_INO
 11

	)

243 
	#PXT4_LINK_MAX
 65000

	)

248 
	#PXT4_MIN_BLOCK_SIZE
 1024

	)

249 
	#PXT4_MAX_BLOCK_SIZE
 65536

	)

250 
	#PXT4_MIN_BLOCK_LOG_SIZE
 10

	)

251 
	#PXT4_MAX_BLOCK_LOG_SIZE
 16

	)

252 
	#PXT4_MAX_CLUSTER_LOG_SIZE
 30

	)

253 #ifde‡
__KERNEL__


254 
	#PXT4_BLOCK_SIZE
(
s
Ë((s)->
s_blocksize
)

	)

256 
	#PXT4_BLOCK_SIZE
(
s
Ë(
PXT4_MIN_BLOCK_SIZE
 << (s)->
s_log_block_size
)

	)

258 
	#PXT4_ADDR_PER_BLOCK
(
s
Ë(
	`PXT4_BLOCK_SIZE
(sË/ (
__u32
))

	)

259 
	#PXT4_CLUSTER_SIZE
(
s
Ë(
	`PXT4_BLOCK_SIZE
(s) << \

260 
	`PXT4_SB
(
s
)->
s_˛u°î_bôs
)

	)

261 #ifde‡
__KERNEL__


262 
	#PXT4_BLOCK_SIZE_BITS
(
s
Ë((s)->
s_blocksize_bôs
)

	)

263 
	#PXT4_CLUSTER_BITS
(
s
Ë(
	`PXT4_SB
(s)->
s_˛u°î_bôs
)

	)

265 
	#PXT4_BLOCK_SIZE_BITS
(
s
Ë((s)->
s_log_block_size
 + 10)

	)

267 #ifde‡
__KERNEL__


268 
	#PXT4_ADDR_PER_BLOCK_BITS
(
s
Ë(
	`PXT4_SB
(s)->
s_addr_≥r_block_bôs
)

	)

269 
	#PXT4_INODE_SIZE
(
s
Ë(
	`PXT4_SB
(s)->
s_öode_size
)

	)

270 
	#PXT4_FIRST_INO
(
s
Ë(
	`PXT4_SB
(s)->
s_fú°_öo
)

	)

272 
	#PXT4_INODE_SIZE
(
s
Ë(((s)->
s_ªv_Àvñ
 =
PXT4_GOOD_OLD_REV
) ? \

273 
PXT4_GOOD_OLD_INODE_SIZE
 : \

274 (
s
)->
s_öode_size
)

	)

275 
	#PXT4_FIRST_INO
(
s
Ë(((s)->
s_ªv_Àvñ
 =
PXT4_GOOD_OLD_REV
) ? \

276 
PXT4_GOOD_OLD_FIRST_INO
 : \

277 (
s
)->
s_fú°_öo
)

	)

279 
	#PXT4_BLOCK_ALIGN
(
size
, 
blkbôs
Ë
	`ALIGN
((size), (1 << (blkbôs)))

	)

280 
	#PXT4_MAX_BLOCKS
(
size
, 
off£t
, 
blkbôs
) \

281 ((
	`PXT4_BLOCK_ALIGN
(
size
 + 
off£t
, 
blkbôs
) >> blkbits) - (offset >> \

282 
blkbôs
))

	)

285 
	#PXT4_B2C
(
sbi
, 
blk
Ë((blkË>> (sbi)->
s_˛u°î_bôs
)

	)

287 
	#PXT4_C2B
(
sbi
, 
˛u°î
Ë((˛u°îË<< (sbi)->
s_˛u°î_bôs
)

	)

289 
	#PXT4_NUM_B2C
(
sbi
, 
blks
Ë(((blksË+ (sbi)->
s_˛u°î_øtio
 - 1) >> \

290 (
sbi
)->
s_˛u°î_bôs
)

	)

292 
	#PXT4_PBLK_CMASK
(
s
, 
pblk
) ((pblk) & \

293 ~((
pxt4_fsblk_t
Ë(
s
)->
s_˛u°î_øtio
 - 1))

	)

294 
	#PXT4_LBLK_CMASK
(
s
, 
lblk
) ((lblk) & \

295 ~((
pxt4_lblk_t
Ë(
s
)->
s_˛u°î_øtio
 - 1))

	)

297 
	#PXT4_LBLK_CFILL
(
sbi
, 
lblk
) ((lblk) | \

298 ((
pxt4_lblk_t
Ë(
sbi
)->
s_˛u°î_øtio
 - 1))

	)

300 
	#PXT4_PBLK_COFF
(
s
, 
pblk
) ((pblk) & \

301 ((
pxt4_fsblk_t
Ë(
s
)->
s_˛u°î_øtio
 - 1))

	)

302 
	#PXT4_LBLK_COFF
(
s
, 
lblk
) ((lblk) & \

303 ((
pxt4_lblk_t
Ë(
s
)->
s_˛u°î_øtio
 - 1))

	)

308 
	spxt4_group_desc


310 
__À32
 
	mbg_block_bôm≠_lo
;

311 
__À32
 
	mbg_öode_bôm≠_lo
;

312 
__À32
 
	mbg_öode_èbÀ_lo
;

313 
__À16
 
	mbg_‰ì_blocks_cou¡_lo
;

314 
__À16
 
	mbg_‰ì_öodes_cou¡_lo
;

315 
__À16
 
	mbg_u£d_dús_cou¡_lo
;

316 
__À16
 
	mbg_Êags
;

317 
__À32
 
	mbg_ex˛ude_bôm≠_lo
;

318 
__À16
 
	mbg_block_bôm≠_csum_lo
;

319 
__À16
 
	mbg_öode_bôm≠_csum_lo
;

320 
__À16
 
	mbg_ôabÀ_unu£d_lo
;

321 
__À16
 
	mbg_checksum
;

322 
__À32
 
	mbg_block_bôm≠_hi
;

323 
__À32
 
	mbg_öode_bôm≠_hi
;

324 
__À32
 
	mbg_öode_èbÀ_hi
;

325 
__À16
 
	mbg_‰ì_blocks_cou¡_hi
;

326 
__À16
 
	mbg_‰ì_öodes_cou¡_hi
;

327 
__À16
 
	mbg_u£d_dús_cou¡_hi
;

328 
__À16
 
	mbg_ôabÀ_unu£d_hi
;

329 
__À32
 
	mbg_ex˛ude_bôm≠_hi
;

330 
__À16
 
	mbg_block_bôm≠_csum_hi
;

331 
__À16
 
	mbg_öode_bôm≠_csum_hi
;

332 
__u32
 
	mbg_ª£rved
;

335 
	#PXT4_BG_INODE_BITMAP_CSUM_HI_END
 \

336 (
	`off£tof
(
pxt4_group_desc
, 
bg_öode_bôm≠_csum_hi
) + \

337 (
__À16
))

	)

338 
	#PXT4_BG_BLOCK_BITMAP_CSUM_HI_END
 \

339 (
	`off£tof
(
pxt4_group_desc
, 
bg_block_bôm≠_csum_hi
) + \

340 (
__À16
))

	)

346 
	sÊex_groups
 {

347 
©omic64_t
 
	m‰ì_˛u°îs
;

348 
©omic_t
 
	m‰ì_öodes
;

349 
©omic_t
 
	mu£d_dús
;

352 
	#PXT4_BG_INODE_UNINIT
 0x0001

	)

353 
	#PXT4_BG_BLOCK_UNINIT
 0x0002

	)

354 
	#PXT4_BG_INODE_ZEROED
 0x0004

	)

359 
	#PXT4_MIN_DESC_SIZE
 32

	)

360 
	#PXT4_MIN_DESC_SIZE_64BIT
 64

	)

361 
	#PXT4_MAX_DESC_SIZE
 
PXT4_MIN_BLOCK_SIZE


	)

362 
	#PXT4_DESC_SIZE
(
s
Ë(
	`PXT4_SB
(s)->
s_desc_size
)

	)

363 #ifde‡
__KERNEL__


364 
	#PXT4_BLOCKS_PER_GROUP
(
s
Ë(
	`PXT4_SB
(s)->
s_blocks_≥r_group
)

	)

365 
	#PXT4_CLUSTERS_PER_GROUP
(
s
Ë(
	`PXT4_SB
(s)->
s_˛u°îs_≥r_group
)

	)

366 
	#PXT4_DESC_PER_BLOCK
(
s
Ë(
	`PXT4_SB
(s)->
s_desc_≥r_block
)

	)

367 
	#PXT4_INODES_PER_GROUP
(
s
Ë(
	`PXT4_SB
(s)->
s_öodes_≥r_group
)

	)

368 
	#PXT4_DESC_PER_BLOCK_BITS
(
s
Ë(
	`PXT4_SB
(s)->
s_desc_≥r_block_bôs
)

	)

370 
	#PXT4_BLOCKS_PER_GROUP
(
s
Ë((s)->
s_blocks_≥r_group
)

	)

371 
	#PXT4_DESC_PER_BLOCK
(
s
Ë(
	`PXT4_BLOCK_SIZE
(sË/ 
	`PXT4_DESC_SIZE
(s))

	)

372 
	#PXT4_INODES_PER_GROUP
(
s
Ë((s)->
s_öodes_≥r_group
)

	)

378 
	#PXT4_NDIR_BLOCKS
 12

	)

379 
	#PXT4_IND_BLOCK
 
PXT4_NDIR_BLOCKS


	)

380 
	#PXT4_DIND_BLOCK
 (
PXT4_IND_BLOCK
 + 1)

	)

381 
	#PXT4_TIND_BLOCK
 (
PXT4_DIND_BLOCK
 + 1)

	)

382 
	#PXT4_N_BLOCKS
 (
PXT4_TIND_BLOCK
 + 1)

	)

387 
	#PXT4_SECRM_FL
 0x00000001

	)

388 
	#PXT4_UNRM_FL
 0x00000002

	)

389 
	#PXT4_COMPR_FL
 0x00000004

	)

390 
	#PXT4_SYNC_FL
 0x00000008

	)

391 
	#PXT4_IMMUTABLE_FL
 0x00000010

	)

392 
	#PXT4_APPEND_FL
 0x00000020

	)

393 
	#PXT4_NODUMP_FL
 0x00000040

	)

394 
	#PXT4_NOATIME_FL
 0x00000080

	)

396 
	#PXT4_DIRTY_FL
 0x00000100

	)

397 
	#PXT4_COMPRBLK_FL
 0x00000200

	)

398 
	#PXT4_NOCOMPR_FL
 0x00000400

	)

400 
	#PXT4_ENCRYPT_FL
 0x00000800

	)

402 
	#PXT4_INDEX_FL
 0x00001000

	)

403 
	#PXT4_IMAGIC_FL
 0x00002000

	)

404 
	#PXT4_JOURNAL_DATA_FL
 0x00004000

	)

405 
	#PXT4_NOTAIL_FL
 0x00008000

	)

406 
	#PXT4_DIRSYNC_FL
 0x00010000

	)

407 
	#PXT4_TOPDIR_FL
 0x00020000

	)

408 
	#PXT4_HUGE_FILE_FL
 0x00040000

	)

409 
	#PXT4_EXTENTS_FL
 0x00080000

	)

410 
	#PXT4_VERITY_FL
 0x00100000

	)

411 
	#PXT4_EA_INODE_FL
 0x00200000

	)

412 
	#PXT4_EOFBLOCKS_FL
 0x00400000

	)

413 
	#PXT4_INLINE_DATA_FL
 0x10000000

	)

414 
	#PXT4_PROJINHERIT_FL
 0x20000000

	)

415 
	#PXT4_CASEFOLD_FL
 0x40000000

	)

416 
	#PXT4_RESERVED_FL
 0x80000000

	)

418 
	#PXT4_FL_USER_VISIBLE
 0x705BDFFF

	)

419 
	#PXT4_FL_USER_MODIFIABLE
 0x604BC0FF

	)

422 
	#PXT4_FL_XFLAG_VISIBLE
 (
PXT4_SYNC_FL
 | \

423 
PXT4_IMMUTABLE_FL
 | \

424 
PXT4_APPEND_FL
 | \

425 
PXT4_NODUMP_FL
 | \

426 
PXT4_NOATIME_FL
 | \

427 
PXT4_PROJINHERIT_FL
)

	)

430 
	#PXT4_FL_INHERITED
 (
PXT4_SECRM_FL
 | 
PXT4_UNRM_FL
 | 
PXT4_COMPR_FL
 |\

431 
PXT4_SYNC_FL
 | 
PXT4_NODUMP_FL
 | 
PXT4_NOATIME_FL
 |\

432 
PXT4_NOCOMPR_FL
 | 
PXT4_JOURNAL_DATA_FL
 |\

433 
PXT4_NOTAIL_FL
 | 
PXT4_DIRSYNC_FL
 |\

434 
PXT4_PROJINHERIT_FL
 | 
PXT4_CASEFOLD_FL
)

	)

437 
	#PXT4_REG_FLMASK
 (~(
PXT4_DIRSYNC_FL
 | 
PXT4_TOPDIR_FL
 | 
PXT4_CASEFOLD_FL
 |\

438 
PXT4_PROJINHERIT_FL
))

	)

441 
	#PXT4_OTHER_FLMASK
 (
PXT4_NODUMP_FL
 | 
PXT4_NOATIME_FL
)

	)

444 
	#PXT4_FL_SHOULD_SWAP
 (
PXT4_HUGE_FILE_FL
 | 
PXT4_EXTENTS_FL
)

	)

447 
ölöe
 
__u32
 
	$pxt4_mask_Êags
(
umode_t
 
mode
, 
__u32
 
Êags
)

449 i‡(
	`S_ISDIR
(
mode
))

450  
Êags
;

451 i‡(
	`S_ISREG
(
mode
))

452  
Êags
 & 
PXT4_REG_FLMASK
;

454  
Êags
 & 
PXT4_OTHER_FLMASK
;

455 
	}
}

461 
	mPXT4_INODE_SECRM
 = 0,

462 
	mPXT4_INODE_UNRM
 = 1,

463 
	mPXT4_INODE_COMPR
 = 2,

464 
	mPXT4_INODE_SYNC
 = 3,

465 
	mPXT4_INODE_IMMUTABLE
 = 4,

466 
	mPXT4_INODE_APPEND
 = 5,

467 
	mPXT4_INODE_NODUMP
 = 6,

468 
	mPXT4_INODE_NOATIME
 = 7,

470 
	mPXT4_INODE_DIRTY
 = 8,

471 
	mPXT4_INODE_COMPRBLK
 = 9,

472 
	mPXT4_INODE_NOCOMPR
 = 10,

473 
	mPXT4_INODE_ENCRYPT
 = 11,

475 
	mPXT4_INODE_INDEX
 = 12,

476 
	mPXT4_INODE_IMAGIC
 = 13,

477 
	mPXT4_INODE_JOURNAL_DATA
 = 14,

478 
	mPXT4_INODE_NOTAIL
 = 15,

479 
	mPXT4_INODE_DIRSYNC
 = 16,

480 
	mPXT4_INODE_TOPDIR
 = 17,

481 
	mPXT4_INODE_HUGE_FILE
 = 18,

482 
	mPXT4_INODE_EXTENTS
 = 19,

483 
	mPXT4_INODE_VERITY
 = 20,

484 
	mPXT4_INODE_EA_INODE
 = 21,

485 
	mPXT4_INODE_EOFBLOCKS
 = 22,

486 
	mPXT4_INODE_INLINE_DATA
 = 28,

487 
	mPXT4_INODE_PROJINHERIT
 = 29,

488 
	mPXT4_INODE_RESERVED
 = 31,

504 
	#TEST_FLAG_VALUE
(
FLAG
Ë(
PXT4_
##FLAG##
_FL
 =(1 << 
PXT4_INODE_
##FLAG))

	)

505 
	#CHECK_FLAG_VALUE
(
FLAG
Ë
	`BUILD_BUG_ON
(!
	`TEST_FLAG_VALUE
(FLAG))

	)

507 
ölöe
 
	$pxt4_check_Êag_vÆues
()

509 
	`CHECK_FLAG_VALUE
(
SECRM
);

510 
	`CHECK_FLAG_VALUE
(
UNRM
);

511 
	`CHECK_FLAG_VALUE
(
COMPR
);

512 
	`CHECK_FLAG_VALUE
(
SYNC
);

513 
	`CHECK_FLAG_VALUE
(
IMMUTABLE
);

514 
	`CHECK_FLAG_VALUE
(
APPEND
);

515 
	`CHECK_FLAG_VALUE
(
NODUMP
);

516 
	`CHECK_FLAG_VALUE
(
NOATIME
);

517 
	`CHECK_FLAG_VALUE
(
DIRTY
);

518 
	`CHECK_FLAG_VALUE
(
COMPRBLK
);

519 
	`CHECK_FLAG_VALUE
(
NOCOMPR
);

520 
	`CHECK_FLAG_VALUE
(
ENCRYPT
);

521 
	`CHECK_FLAG_VALUE
(
INDEX
);

522 
	`CHECK_FLAG_VALUE
(
IMAGIC
);

523 
	`CHECK_FLAG_VALUE
(
JOURNAL_DATA
);

524 
	`CHECK_FLAG_VALUE
(
NOTAIL
);

525 
	`CHECK_FLAG_VALUE
(
DIRSYNC
);

526 
	`CHECK_FLAG_VALUE
(
TOPDIR
);

527 
	`CHECK_FLAG_VALUE
(
HUGE_FILE
);

528 
	`CHECK_FLAG_VALUE
(
EXTENTS
);

529 
	`CHECK_FLAG_VALUE
(
VERITY
);

530 
	`CHECK_FLAG_VALUE
(
EA_INODE
);

531 
	`CHECK_FLAG_VALUE
(
EOFBLOCKS
);

532 
	`CHECK_FLAG_VALUE
(
INLINE_DATA
);

533 
	`CHECK_FLAG_VALUE
(
PROJINHERIT
);

534 
	`CHECK_FLAG_VALUE
(
RESERVED
);

535 
	}
}

538 
	spxt4_√w_group_öput
 {

539 
__u32
 
	mgroup
;

540 
__u64
 
	mblock_bôm≠
;

541 
__u64
 
	möode_bôm≠
;

542 
__u64
 
	möode_èbÀ
;

543 
__u32
 
	mblocks_cou¡
;

544 
__u16
 
	mª£rved_blocks
;

545 
__u16
 
	munu£d
;

548 #i‡
deföed
(
__KERNEL__
Ë&& deföed(
CONFIG_COMPAT
)

549 
	scom∑t_pxt4_√w_group_öput
 {

550 
u32
 
	mgroup
;

551 
com∑t_u64
 
	mblock_bôm≠
;

552 
com∑t_u64
 
	möode_bôm≠
;

553 
com∑t_u64
 
	möode_èbÀ
;

554 
u32
 
	mblocks_cou¡
;

555 
u16
 
	mª£rved_blocks
;

556 
u16
 
	munu£d
;

561 
	spxt4_√w_group_d©a
 {

562 
__u32
 
	mgroup
;

563 
__u64
 
	mblock_bôm≠
;

564 
__u64
 
	möode_bôm≠
;

565 
__u64
 
	möode_èbÀ
;

566 
__u32
 
	mblocks_cou¡
;

567 
__u16
 
	mª£rved_blocks
;

568 
__u16
 
	mmd©a_blocks
;

569 
__u32
 
	m‰ì_˛u°îs_cou¡
;

574 
	mBLOCK_BITMAP
 = 0,

575 
	mINODE_BITMAP
,

576 
	mINODE_TABLE
,

577 
	mGROUP_TABLE_COUNT
,

585 
	#PXT4_GET_BLOCKS_CREATE
 0x0001

	)

587 
	#PXT4_GET_BLOCKS_UNWRIT_EXT
 0x0002

	)

588 
	#PXT4_GET_BLOCKS_CREATE_UNWRIT_EXT
 (
PXT4_GET_BLOCKS_UNWRIT_EXT
|\

589 
PXT4_GET_BLOCKS_CREATE
)

	)

592 
	#PXT4_GET_BLOCKS_DELALLOC_RESERVE
 0x0004

	)

596 
	#PXT4_GET_BLOCKS_PRE_IO
 0x0008

	)

597 
	#PXT4_GET_BLOCKS_CONVERT
 0x0010

	)

598 
	#PXT4_GET_BLOCKS_IO_CREATE_EXT
 (
PXT4_GET_BLOCKS_PRE_IO
|\

599 
PXT4_GET_BLOCKS_CREATE_UNWRIT_EXT
)

	)

601 
	#PXT4_GET_BLOCKS_IO_CONVERT_EXT
 (
PXT4_GET_BLOCKS_CONVERT
|\

602 
PXT4_GET_BLOCKS_CREATE_UNWRIT_EXT
)

	)

605 
	#PXT4_GET_BLOCKS_METADATA_NOFAIL
 0x0020

	)

607 
	#PXT4_GET_BLOCKS_NO_NORMALIZE
 0x0040

	)

609 
	#PXT4_GET_BLOCKS_KEEP_SIZE
 0x0080

	)

611 
	#PXT4_GET_BLOCKS_CONVERT_UNWRITTEN
 0x0100

	)

613 
	#PXT4_GET_BLOCKS_ZERO
 0x0200

	)

614 
	#PXT4_GET_BLOCKS_CREATE_ZERO
 (
PXT4_GET_BLOCKS_CREATE
 |\

615 
PXT4_GET_BLOCKS_ZERO
)

	)

618 
	#PXT4_GET_BLOCKS_IO_SUBMIT
 0x0400

	)

629 
	#PXT4_EX_NOCACHE
 0x40000000

	)

630 
	#PXT4_EX_FORCE_CACHE
 0x20000000

	)

635 
	#PXT4_FREE_BLOCKS_METADATA
 0x0001

	)

636 
	#PXT4_FREE_BLOCKS_FORGET
 0x0002

	)

637 
	#PXT4_FREE_BLOCKS_VALIDATED
 0x0004

	)

638 
	#PXT4_FREE_BLOCKS_NO_QUOT_UPDATE
 0x0008

	)

639 
	#PXT4_FREE_BLOCKS_NOFREE_FIRST_CLUSTER
 0x0010

	)

640 
	#PXT4_FREE_BLOCKS_NOFREE_LAST_CLUSTER
 0x0020

	)

641 
	#PXT4_FREE_BLOCKS_RERESERVE_CLUSTER
 0x0040

	)

646 
	#PXT4_IOC_GETFLAGS
 
FS_IOC_GETFLAGS


	)

647 
	#PXT4_IOC_SETFLAGS
 
FS_IOC_SETFLAGS


	)

648 
	#PXT4_IOC_GETVERSION
 
	`_IOR
('f', 3, )

	)

649 
	#PXT4_IOC_SETVERSION
 
	`_IOW
('f', 4, )

	)

650 
	#PXT4_IOC_GETVERSION_OLD
 
FS_IOC_GETVERSION


	)

651 
	#PXT4_IOC_SETVERSION_OLD
 
FS_IOC_SETVERSION


	)

652 
	#PXT4_IOC_GETRSVSZ
 
	`_IOR
('f', 5, )

	)

653 
	#PXT4_IOC_SETRSVSZ
 
	`_IOW
('f', 6, )

	)

654 
	#PXT4_IOC_GROUP_EXTEND
 
	`_IOW
('f', 7, )

	)

655 
	#PXT4_IOC_GROUP_ADD
 
	`_IOW
('f', 8, 
pxt4_√w_group_öput
)

	)

656 
	#PXT4_IOC_MIGRATE
 
	`_IO
('f', 9)

	)

659 
	#PXT4_IOC_ALLOC_DA_BLKS
 
	`_IO
('f', 12)

	)

660 
	#PXT4_IOC_MOVE_EXT
 
	`_IOWR
('f', 15, 
move_exã¡
)

	)

661 
	#PXT4_IOC_RESIZE_FS
 
	`_IOW
('f', 16, 
__u64
)

	)

662 
	#PXT4_IOC_SWAP_BOOT
 
	`_IO
('f', 17)

	)

663 
	#PXT4_IOC_PRECACHE_EXTENTS
 
	`_IO
('f', 18)

	)

664 
	#PXT4_IOC_SET_ENCRYPTION_POLICY
 
FS_IOC_SET_ENCRYPTION_POLICY


	)

665 
	#PXT4_IOC_GET_ENCRYPTION_PWSALT
 
FS_IOC_GET_ENCRYPTION_PWSALT


	)

666 
	#PXT4_IOC_GET_ENCRYPTION_POLICY
 
FS_IOC_GET_ENCRYPTION_POLICY


	)

668 
	#PXT4_IOC_CLEAR_ES_CACHE
 
	`_IO
('f', 40)

	)

669 
	#PXT4_IOC_GETSTATE
 
	`_IOW
('f', 41, 
__u32
)

	)

670 
	#PXT4_IOC_GET_ES_CACHE
 
	`_IOWR
('f', 42, 
fõm≠
)

	)

672 
	#PXT4_IOC_FSGETXATTR
 
FS_IOC_FSGETXATTR


	)

673 
	#PXT4_IOC_FSSETXATTR
 
FS_IOC_FSSETXATTR


	)

675 
	#PXT4_IOC_SHUTDOWN
 
	`_IOR
 ('X', 125, 
__u32
)

	)

680 
	#PXT4_GOING_FLAGS_DEFAULT
 0x0

	)

681 
	#PXT4_GOING_FLAGS_LOGFLUSH
 0x1

	)

682 
	#PXT4_GOING_FLAGS_NOLOGFLUSH
 0x2

	)

690 
	#PXT4_STATE_FLAG_EXT_PRECACHED
 0x00000001

	)

691 
	#PXT4_STATE_FLAG_NEW
 0x00000002

	)

692 
	#PXT4_STATE_FLAG_NEWENTRY
 0x00000004

	)

693 
	#PXT4_STATE_FLAG_DA_ALLOC_CLOSE
 0x00000008

	)

695 #i‡
deföed
(
__KERNEL__
Ë&& deföed(
CONFIG_COMPAT
)

699 
	#PXT4_IOC32_GETFLAGS
 
FS_IOC32_GETFLAGS


	)

700 
	#PXT4_IOC32_SETFLAGS
 
FS_IOC32_SETFLAGS


	)

701 
	#PXT4_IOC32_GETVERSION
 
	`_IOR
('f', 3, )

	)

702 
	#PXT4_IOC32_SETVERSION
 
	`_IOW
('f', 4, )

	)

703 
	#PXT4_IOC32_GETRSVSZ
 
	`_IOR
('f', 5, )

	)

704 
	#PXT4_IOC32_SETRSVSZ
 
	`_IOW
('f', 6, )

	)

705 
	#PXT4_IOC32_GROUP_EXTEND
 
	`_IOW
('f', 7, )

	)

706 
	#PXT4_IOC32_GROUP_ADD
 
	`_IOW
('f', 8, 
com∑t_pxt4_√w_group_öput
)

	)

707 
	#PXT4_IOC32_GETVERSION_OLD
 
FS_IOC32_GETVERSION


	)

708 
	#PXT4_IOC32_SETVERSION_OLD
 
FS_IOC32_SETVERSION


	)

715 
	#PXT4_FIEMAP_EXTENT_HOLE
 0x08000000

	)

718 
	#PXT4_MAX_BLOCK_FILE_PHYS
 0xFFFFFFFF

	)

721 
	#PXT4_MAX_LOGICAL_BLOCK
 0xFFFFFFFE

	)

726 
	spxt4_öode
 {

727 
__À16
 
	mi_mode
;

728 
__À16
 
	mi_uid
;

729 
__À32
 
	mi_size_lo
;

730 
__À32
 
	mi_©ime
;

731 
__À32
 
	mi_˘ime
;

732 
__À32
 
	mi_mtime
;

733 
__À32
 
	mi_dtime
;

734 
__À16
 
	mi_gid
;

735 
__À16
 
	mi_löks_cou¡
;

736 
__À32
 
	mi_blocks_lo
;

737 
__À32
 
	mi_Êags
;

740 
__À32
 
	ml_i_vîsi⁄
;

741 } 
	mlöux1
;

743 
__u32
 
	mh_i_å™¶©‹
;

744 } 
	mhurd1
;

746 
__u32
 
	mm_i_ª£rved1
;

747 } 
	mmasix1
;

748 } 
	mosd1
;

749 
__À32
 
	mi_block
[
PXT4_N_BLOCKS
];

750 
__À32
 
	mi_gíî©i⁄
;

751 
__À32
 
	mi_fûe_a˛_lo
;

752 
__À32
 
	mi_size_high
;

753 
__À32
 
	mi_obso_Áddr
;

756 
__À16
 
	ml_i_blocks_high
;

757 
__À16
 
	ml_i_fûe_a˛_high
;

758 
__À16
 
	ml_i_uid_high
;

759 
__À16
 
	ml_i_gid_high
;

760 
__À16
 
	ml_i_checksum_lo
;

761 
__À16
 
	ml_i_ª£rved
;

762 } 
	mlöux2
;

764 
__À16
 
	mh_i_ª£rved1
;

765 
__u16
 
	mh_i_mode_high
;

766 
__u16
 
	mh_i_uid_high
;

767 
__u16
 
	mh_i_gid_high
;

768 
__u32
 
	mh_i_auth‹
;

769 } 
	mhurd2
;

771 
__À16
 
	mh_i_ª£rved1
;

772 
__À16
 
	mm_i_fûe_a˛_high
;

773 
__u32
 
	mm_i_ª£rved2
[2];

774 } 
	mmasix2
;

775 } 
	mosd2
;

776 
__À16
 
	mi_exåa_isize
;

777 
__À16
 
	mi_checksum_hi
;

778 
__À32
 
	mi_˘ime_exåa
;

779 
__À32
 
	mi_mtime_exåa
;

780 
__À32
 
	mi_©ime_exåa
;

781 
__À32
 
	mi_¸time
;

782 
__À32
 
	mi_¸time_exåa
;

783 
__À32
 
	mi_vîsi⁄_hi
;

784 
__À32
 
	mi_¥ojid
;

787 
	smove_exã¡
 {

788 
__u32
 
	mª£rved
;

789 
__u32
 
	md⁄‹_fd
;

790 
__u64
 
	m‹ig_°¨t
;

791 
__u64
 
	md⁄‹_°¨t
;

792 
__u64
 
	mÀn
;

793 
__u64
 
	mmoved_Àn
;

796 
	#PXT4_EPOCH_BITS
 2

	)

797 
	#PXT4_EPOCH_MASK
 ((1 << 
PXT4_EPOCH_BITS
Ë- 1)

	)

798 
	#PXT4_NSEC_MASK
 (~0UL << 
PXT4_EPOCH_BITS
)

	)

810 
	#PXT4_FITS_IN_INODE
(
pxt4_öode
, 
eöode
, 
fõld
) \

811 ((
	`off£tof
(
	`ty≥of
(*
pxt4_öode
), 
fõld
) + \

812 ((
pxt4_öode
)->
fõld
)) \

813 <(
PXT4_GOOD_OLD_INODE_SIZE
 + \

814 (
eöode
)->
i_exåa_isize
)) \

815 

	)

837 
ölöe
 
__À32
 
	$pxt4_ícode_exåa_time
(
time•ec64
 *
time
)

839 
u32
 
exåa
 =((
time
->
tv_£c
 - (
s32
Èime->tv_£cË>> 32Ë& 
PXT4_EPOCH_MASK
;

840  
	`˝u_to_À32
(
exåa
 | (
time
->
tv_n£c
 << 
PXT4_EPOCH_BITS
));

841 
	}
}

843 
ölöe
 
	$pxt4_decode_exåa_time
(
time•ec64
 *
time
,

844 
__À32
 
exåa
)

846 i‡(
	`u∆ikñy
(
exåa
 & 
	`˝u_to_À32
(
PXT4_EPOCH_MASK
)))

847 
time
->
tv_£c
 +(
u64
)(
	`À32_to_˝u
(
exåa
Ë& 
PXT4_EPOCH_MASK
) << 32;

848 
time
->
tv_n£c
 = (
	`À32_to_˝u
(
exåa
Ë& 
PXT4_NSEC_MASK
Ë>> 
PXT4_EPOCH_BITS
;

849 
	}
}

851 
	#PXT4_INODE_SET_XTIME
(
xtime
, 
öode
, 
øw_öode
) \

853 i‡(
	`PXT4_FITS_IN_INODE
(
øw_öode
, 
	`PXT4_I
(
öode
), 
xtime
 ## 
_exåa
)) {\

854 (
øw_öode
)->
xtime
 = 
	`˝u_to_À32
((
öode
)->xtime.
tv_£c
); \

855 (
øw_öode
)->
xtime
 ## 
_exåa
 = \

856 
	`pxt4_ícode_exåa_time
(&(
öode
)->
xtime
); \

859 (
øw_öode
)->
xtime
 = 
	`˝u_to_À32
(
	`˛amp_t
(
öt32_t
, (
öode
)->xtime.
tv_£c
, 
S32_MIN
, 
S32_MAX
)); \

860 } 0)

	)

862 
	#PXT4_EINODE_SET_XTIME
(
xtime
, 
eöode
, 
øw_öode
) \

864 i‡(
	`PXT4_FITS_IN_INODE
(
øw_öode
, 
eöode
, 
xtime
)) \

865 (
øw_öode
)->
xtime
 = 
	`˝u_to_À32
((
eöode
)->xtime.
tv_£c
); \

866 i‡(
	`PXT4_FITS_IN_INODE
(
øw_öode
, 
eöode
, 
xtime
 ## 
_exåa
)) \

867 (
øw_öode
)->
xtime
 ## 
_exåa
 = \

868 
	`pxt4_ícode_exåa_time
(&(
eöode
)->
xtime
); \

869 } 0)

	)

871 
	#PXT4_INODE_GET_XTIME
(
xtime
, 
öode
, 
øw_öode
) \

873 (
öode
)->
xtime
.
tv_£c
 = (sig√d)
	`À32_to_˝u
((
øw_öode
)->xtime); \

874 i‡(
	`PXT4_FITS_IN_INODE
(
øw_öode
, 
	`PXT4_I
(
öode
), 
xtime
 ## 
_exåa
)) { \

875 
	`pxt4_decode_exåa_time
(&(
öode
)->
xtime
, \

876 
øw_öode
->
xtime
 ## 
_exåa
); \

879 (
öode
)->
xtime
.
tv_n£c
 = 0; \

880 } 0)

	)

883 
	#PXT4_EINODE_GET_XTIME
(
xtime
, 
eöode
, 
øw_öode
) \

885 i‡(
	`PXT4_FITS_IN_INODE
(
øw_öode
, 
eöode
, 
xtime
)) \

886 (
eöode
)->
xtime
.
tv_£c
 = \

887 (sig√d)
	`À32_to_˝u
((
øw_öode
)->
xtime
); \

889 (
eöode
)->
xtime
.
tv_£c
 = 0; \

890 i‡(
	`PXT4_FITS_IN_INODE
(
øw_öode
, 
eöode
, 
xtime
 ## 
_exåa
)) \

891 
	`pxt4_decode_exåa_time
(&(
eöode
)->
xtime
, \

892 
øw_öode
->
xtime
 ## 
_exåa
); \

894 (
eöode
)->
xtime
.
tv_n£c
 = 0; \

895 } 0)

	)

897 
	#i_disk_vîsi⁄
 
osd1
.
löux1
.
l_i_vîsi⁄


	)

899 #i‡
deföed
(
__KERNEL__
Ë|| deföed(
__löux__
)

900 
	#i_ª£rved1
 
osd1
.
löux1
.
l_i_ª£rved1


	)

901 
	#i_fûe_a˛_high
 
osd2
.
löux2
.
l_i_fûe_a˛_high


	)

902 
	#i_blocks_high
 
osd2
.
löux2
.
l_i_blocks_high


	)

903 
	#i_uid_low
 
i_uid


	)

904 
	#i_gid_low
 
i_gid


	)

905 
	#i_uid_high
 
osd2
.
löux2
.
l_i_uid_high


	)

906 
	#i_gid_high
 
osd2
.
löux2
.
l_i_gid_high


	)

907 
	#i_checksum_lo
 
osd2
.
löux2
.
l_i_checksum_lo


	)

909 #ñi‡
deföed
(
__GNU__
)

911 
	#i_å™¶©‹
 
osd1
.
hurd1
.
h_i_å™¶©‹


	)

912 
	#i_uid_high
 
osd2
.
hurd2
.
h_i_uid_high


	)

913 
	#i_gid_high
 
osd2
.
hurd2
.
h_i_gid_high


	)

914 
	#i_auth‹
 
osd2
.
hurd2
.
h_i_auth‹


	)

916 #ñi‡
deföed
(
__masix__
)

918 
	#i_ª£rved1
 
osd1
.
masix1
.
m_i_ª£rved1


	)

919 
	#i_fûe_a˛_high
 
osd2
.
masix2
.
m_i_fûe_a˛_high


	)

920 
	#i_ª£rved2
 
osd2
.
masix2
.
m_i_ª£rved2


	)

924 
	~"exã¡s_°©us.h
"

943 
	mI_DATA_SEM_NORMAL
 = 0,

944 
	mI_DATA_SEM_OTHER
,

945 
	mI_DATA_SEM_QUOTA
,

952 
	spxt4_öode_öfo
 {

953 
__À32
 
	mi_d©a
[15];

954 
__u32
 
	mi_dtime
;

955 
pxt4_fsblk_t
 
	mi_fûe_a˛
;

964 
pxt4_group_t
 
	mi_block_group
;

965 
pxt4_lblk_t
 
	mi_dú_°¨t_lookup
;

966 #i‡(
BITS_PER_LONG
 < 64)

967 
	mi_°©e_Êags
;

969 
	mi_Êags
;

978 
rw_£m≠h‹e
 
	mx©å_£m
;

980 
li°_hód
 
	mi_‹ph™
;

997 
loff_t
 
	mi_disksize
;

1009 
rw_£m≠h‹e
 
	mi_d©a_£m
;

1018 
rw_£m≠h‹e
 
	mi_mm≠_£m
;

1019 
öode
 
	mvfs_öode
;

1020 
jbd3_öode
 *
	mjöode
;

1022 
•ölock_t
 
	mi_øw_lock
;

1028 
time•ec64
 
	mi_¸time
;

1031 
li°_hód
 
	mi_¥óŒoc_li°
;

1032 
•ölock_t
 
	mi_¥óŒoc_lock
;

1035 
pxt4_es_åì
 
	mi_es_åì
;

1036 
rwlock_t
 
	mi_es_lock
;

1037 
li°_hód
 
	mi_es_li°
;

1038 
	mi_es_Æl_ƒ
;

1039 
	mi_es_shk_ƒ
;

1040 
pxt4_lblk_t
 
	mi_es_shrök_lblk
;

1045 
pxt4_group_t
 
	mi_œ°_Æloc_group
;

1049 
	mi_ª£rved_d©a_blocks
;

1050 
pxt4_lblk_t
 
	mi_da_mëad©a_ˇlc_œ°_lblock
;

1051 
	mi_da_mëad©a_ˇlc_Àn
;

1054 
pxt4_≥ndög_åì
 
	mi_≥ndög_åì
;

1057 
__u16
 
	mi_exåa_isize
;

1060 
u16
 
	mi_ölöe_off
;

1061 
u16
 
	mi_ölöe_size
;

1063 #ifde‡
CONFIG_QUOTA


1065 
qsize_t
 
	mi_ª£rved_quŸa
;

1069 
•ölock_t
 
	mi_com∂ëed_io_lock
;

1074 
li°_hód
 
	mi_rsv_c⁄vîsi⁄_li°
;

1075 
w‹k_°ru˘
 
	mi_rsv_c⁄vîsi⁄_w‹k
;

1076 
©omic_t
 
	mi_unwrôãn
;

1078 
•ölock_t
 
	mi_block_ª£rv©i⁄_lock
;

1084 
tid_t
 
	mi_sync_tid
;

1085 
tid_t
 
	mi_d©async_tid
;

1087 #ifde‡
CONFIG_QUOTA


1088 
dquŸ
 *
	mi_dquŸ
[
MAXQUOTAS
];

1092 
__u32
 
	mi_csum_£ed
;

1094 
k¥ojid_t
 
	mi_¥ojid
;

1100 
	#PXT4_VALID_FS
 0x0001

	)

1101 
	#PXT4_ERROR_FS
 0x0002

	)

1102 
	#PXT4_ORPHAN_FS
 0x0004

	)

1107 
	#EXT2_FLAGS_SIGNED_HASH
 0x0001

	)

1108 
	#EXT2_FLAGS_UNSIGNED_HASH
 0x0002

	)

1109 
	#EXT2_FLAGS_TEST_FILESYS
 0x0004

	)

1114 
	#PXT4_MOUNT_NO_MBCACHE
 0x00001

	)

1115 
	#PXT4_MOUNT_GRPID
 0x00004

	)

1116 
	#PXT4_MOUNT_DEBUG
 0x00008

	)

1117 
	#PXT4_MOUNT_ERRORS_CONT
 0x00010

	)

1118 
	#PXT4_MOUNT_ERRORS_RO
 0x00020

	)

1119 
	#PXT4_MOUNT_ERRORS_PANIC
 0x00040

	)

1120 
	#PXT4_MOUNT_ERRORS_MASK
 0x00070

	)

1121 
	#PXT4_MOUNT_MINIX_DF
 0x00080

	)

1122 
	#PXT4_MOUNT_NOLOAD
 0x00100

	)

1123 #ifde‡
CONFIG_FS_DAX


1124 
	#PXT4_MOUNT_DAX
 0x00200

	)

1126 
	#PXT4_MOUNT_DAX
 0

	)

1128 
	#PXT4_MOUNT_DATA_FLAGS
 0x00C00

	)

1129 
	#PXT4_MOUNT_JOURNAL_DATA
 0x00400

	)

1130 
	#PXT4_MOUNT_ORDERED_DATA
 0x00800

	)

1131 
	#PXT4_MOUNT_WRITEBACK_DATA
 0x00C00

	)

1132 
	#PXT4_MOUNT_UPDATE_JOURNAL
 0x01000

	)

1133 
	#PXT4_MOUNT_NO_UID32
 0x02000

	)

1134 
	#PXT4_MOUNT_XATTR_USER
 0x04000

	)

1135 
	#PXT4_MOUNT_POSIX_ACL
 0x08000

	)

1136 
	#PXT4_MOUNT_NO_AUTO_DA_ALLOC
 0x10000

	)

1137 
	#PXT4_MOUNT_BARRIER
 0x20000

	)

1138 
	#PXT4_MOUNT_QUOTA
 0x40000

	)

1139 
	#PXT4_MOUNT_USRQUOTA
 0x80000

	)

1142 
	#PXT4_MOUNT_GRPQUOTA
 0x100000

	)

1145 
	#PXT4_MOUNT_PRJQUOTA
 0x200000

	)

1147 
	#PXT4_MOUNT_DIOREAD_NOLOCK
 0x400000

	)

1148 
	#PXT4_MOUNT_JOURNAL_CHECKSUM
 0x800000

	)

1149 
	#PXT4_MOUNT_JOURNAL_ASYNC_COMMIT
 0x1000000

	)

1150 
	#PXT4_MOUNT_WARN_ON_ERROR
 0x2000000

	)

1151 
	#PXT4_MOUNT_DELALLOC
 0x8000000

	)

1152 
	#PXT4_MOUNT_DATA_ERR_ABORT
 0x10000000

	)

1153 
	#PXT4_MOUNT_BLOCK_VALIDITY
 0x20000000

	)

1154 
	#PXT4_MOUNT_DISCARD
 0x40000000

	)

1155 
	#PXT4_MOUNT_INIT_INODE_TABLE
 0x80000000

	)

1162 
	#PXT4_MOUNT2_EXPLICIT_DELALLOC
 0x00000001

	)

1164 
	#PXT4_MOUNT2_STD_GROUP_SIZE
 0x00000002

	)

1167 
	#PXT4_MOUNT2_HURD_COMPAT
 0x00000004

	)

1170 
	#PXT4_MOUNT2_EXPLICIT_JOURNAL_CHECKSUM
 0x00000008

	)

1173 
	#˛ór_›t
(
sb
, 
›t
Ë
	`PXT4_SB
(sb)->
s_mou¡_›t
 &= \

1174 ~
PXT4_MOUNT_
##
›t


	)

1175 
	#£t_›t
(
sb
, 
›t
Ë
	`PXT4_SB
(sb)->
s_mou¡_›t
 |= \

1176 
PXT4_MOUNT_
##
›t


	)

1177 
	#ã°_›t
(
sb
, 
›t
Ë(
	`PXT4_SB
(sb)->
s_mou¡_›t
 & \

1178 
PXT4_MOUNT_
##
›t
)

	)

1180 
	#˛ór_›t2
(
sb
, 
›t
Ë
	`PXT4_SB
(sb)->
s_mou¡_›t2
 &= \

1181 ~
PXT4_MOUNT2_
##
›t


	)

1182 
	#£t_›t2
(
sb
, 
›t
Ë
	`PXT4_SB
(sb)->
s_mou¡_›t2
 |= \

1183 
PXT4_MOUNT2_
##
›t


	)

1184 
	#ã°_›t2
(
sb
, 
›t
Ë(
	`PXT4_SB
(sb)->
s_mou¡_›t2
 & \

1185 
PXT4_MOUNT2_
##
›t
)

	)

1187 
	#pxt4_ã°_™d_£t_bô
 
__ã°_™d_£t_bô_À


	)

1188 
	#pxt4_£t_bô
 
__£t_bô_À


	)

1189 
	#pxt4_£t_bô_©omic
 
pxt2_£t_bô_©omic


	)

1190 
	#pxt4_ã°_™d_˛ór_bô
 
__ã°_™d_˛ór_bô_À


	)

1191 
	#pxt4_˛ór_bô
 
__˛ór_bô_À


	)

1192 
	#pxt4_˛ór_bô_©omic
 
pxt2_˛ór_bô_©omic


	)

1193 
	#pxt4_ã°_bô
 
ã°_bô_À


	)

1194 
	#pxt4_föd_√xt_zîo_bô
 
föd_√xt_zîo_bô_À


	)

1195 
	#pxt4_föd_√xt_bô
 
föd_√xt_bô_À


	)

1197 
pxt4_£t_bôs
(*
bm
, 
cur
, 
Àn
);

1202 
	#PXT4_DFL_MAX_MNT_COUNT
 20

	)

1203 
	#PXT4_DFL_CHECKINTERVAL
 0

	)

1208 
	#PXT4_ERRORS_CONTINUE
 1

	)

1209 
	#PXT4_ERRORS_RO
 2

	)

1210 
	#PXT4_ERRORS_PANIC
 3

	)

1211 
	#PXT4_ERRORS_DEFAULT
 
PXT4_ERRORS_CONTINUE


	)

1214 
	#PXT4_CRC32C_CHKSUM
 1

	)

1219 
	spxt4_su≥r_block
 {

1220  
__À32
 
	ms_öodes_cou¡
;

1221 
__À32
 
	ms_blocks_cou¡_lo
;

1222 
__À32
 
	ms_r_blocks_cou¡_lo
;

1223 
__À32
 
	ms_‰ì_blocks_cou¡_lo
;

1224  
__À32
 
	ms_‰ì_öodes_cou¡
;

1225 
__À32
 
	ms_fú°_d©a_block
;

1226 
__À32
 
	ms_log_block_size
;

1227 
__À32
 
	ms_log_˛u°î_size
;

1228  
__À32
 
	ms_blocks_≥r_group
;

1229 
__À32
 
	ms_˛u°îs_≥r_group
;

1230 
__À32
 
	ms_öodes_≥r_group
;

1231 
__À32
 
	ms_mtime
;

1232  
__À32
 
	ms_wtime
;

1233 
__À16
 
	ms_m¡_cou¡
;

1234 
__À16
 
	ms_max_m¡_cou¡
;

1235 
__À16
 
	ms_magic
;

1236 
__À16
 
	ms_°©e
;

1237 
__À16
 
	ms_îr‹s
;

1238 
__À16
 
	ms_mö‹_ªv_Àvñ
;

1239  
__À32
 
	ms_œ°check
;

1240 
__À32
 
	ms_checköãrvÆ
;

1241 
__À32
 
	ms_¸ót‹_os
;

1242 
__À32
 
	ms_ªv_Àvñ
;

1243  
__À16
 
	ms_def_ªsuid
;

1244 
__À16
 
	ms_def_ªsgid
;

1258 
__À32
 
	ms_fú°_öo
;

1259 
__À16
 
	ms_öode_size
;

1260 
__À16
 
	ms_block_group_ƒ
;

1261 
__À32
 
	ms_„©uª_com∑t
;

1262  
__À32
 
	ms_„©uª_öcom∑t
;

1263 
__À32
 
	ms_„©uª_ro_com∑t
;

1264  
__u8
 
	ms_uuid
[16];

1265  
	ms_vﬁume_«me
[16];

1266  
	ms_œ°_mou¡ed
[64] 
	m__n⁄°rög
;

1267  
__À32
 
	ms_Æg‹ôhm_ußge_bôm≠
;

1272 
__u8
 
	ms_¥óŒoc_blocks
;

1273 
__u8
 
	ms_¥óŒoc_dú_blocks
;

1274 
__À16
 
	ms_ª£rved_gdt_blocks
;

1278  
__u8
 
	ms_jou∫Æ_uuid
[16];

1279  
__À32
 
	ms_jou∫Æ_öum
;

1280 
__À32
 
	ms_jou∫Æ_dev
;

1281 
__À32
 
	ms_œ°_‹ph™
;

1282 
__À32
 
	ms_hash_£ed
[4];

1283 
__u8
 
	ms_def_hash_vîsi⁄
;

1284 
__u8
 
	ms_j∆_backup_ty≥
;

1285 
__À16
 
	ms_desc_size
;

1286  
__À32
 
	ms_deÁu…_mou¡_›ts
;

1287 
__À32
 
	ms_fú°_mëa_bg
;

1288 
__À32
 
	ms_mkfs_time
;

1289 
__À32
 
	ms_j∆_blocks
[17];

1291  
__À32
 
	ms_blocks_cou¡_hi
;

1292 
__À32
 
	ms_r_blocks_cou¡_hi
;

1293 
__À32
 
	ms_‰ì_blocks_cou¡_hi
;

1294 
__À16
 
	ms_mö_exåa_isize
;

1295 
__À16
 
	ms_w™t_exåa_isize
;

1296 
__À32
 
	ms_Êags
;

1297 
__À16
 
	ms_øid_°ride
;

1298 
__À16
 
	ms_mmp_upd©e_öãrvÆ
;

1299 
__À64
 
	ms_mmp_block
;

1300 
__À32
 
	ms_øid_°rùe_width
;

1301 
__u8
 
	ms_log_groups_≥r_Êex
;

1302 
__u8
 
	ms_checksum_ty≥
;

1303 
__u8
 
	ms_í¸y±i⁄_Àvñ
;

1304 
__u8
 
	ms_ª£rved_∑d
;

1305 
__À64
 
	ms_kbyãs_wrôãn
;

1306 
__À32
 
	ms_¢≠shŸ_öum
;

1307 
__À32
 
	ms_¢≠shŸ_id
;

1308 
__À64
 
	ms_¢≠shŸ_r_blocks_cou¡
;

1310 
__À32
 
	ms_¢≠shŸ_li°
;

1312 
	#PXT4_S_ERR_START
 
	`off£tof
(
pxt4_su≥r_block
, 
s_îr‹_cou¡
)

	)

1313 
__À32
 
	ms_îr‹_cou¡
;

1314 
__À32
 
	ms_fú°_îr‹_time
;

1315 
__À32
 
	ms_fú°_îr‹_öo
;

1316 
__À64
 
	ms_fú°_îr‹_block
;

1317 
__u8
 
	ms_fú°_îr‹_func
[32] 
	m__n⁄°rög
;

1318 
__À32
 
	ms_fú°_îr‹_löe
;

1319 
__À32
 
	ms_œ°_îr‹_time
;

1320 
__À32
 
	ms_œ°_îr‹_öo
;

1321 
__À32
 
	ms_œ°_îr‹_löe
;

1322 
__À64
 
	ms_œ°_îr‹_block
;

1323 
__u8
 
	ms_œ°_îr‹_func
[32] 
	m__n⁄°rög
;

1324 
	#PXT4_S_ERR_END
 
	`off£tof
(
pxt4_su≥r_block
, 
s_mou¡_›ts
)

	)

1325 
__u8
 
	ms_mou¡_›ts
[64];

1326 
__À32
 
	ms_u§_quŸa_öum
;

1327 
__À32
 
	ms_gΩ_quŸa_öum
;

1328 
__À32
 
	ms_ovîhód_˛u°îs
;

1329 
__À32
 
	ms_backup_bgs
[2];

1330 
__u8
 
	ms_í¸y±_Ægos
[4];

1331 
__u8
 
	ms_í¸y±_pw_ß…
[16];

1332 
__À32
 
	ms_Õf_öo
;

1333 
__À32
 
	ms_¥j_quŸa_öum
;

1334 
__À32
 
	ms_checksum_£ed
;

1335 
__u8
 
	ms_wtime_hi
;

1336 
__u8
 
	ms_mtime_hi
;

1337 
__u8
 
	ms_mkfs_time_hi
;

1338 
__u8
 
	ms_œ°check_hi
;

1339 
__u8
 
	ms_fú°_îr‹_time_hi
;

1340 
__u8
 
	ms_œ°_îr‹_time_hi
;

1341 
__u8
 
	ms_∑d
[2];

1342 
__À16
 
	ms_ícodög
;

1343 
__À16
 
	ms_ícodög_Êags
;

1344 
__À32
 
	ms_ª£rved
[95];

1345 
__À32
 
	ms_checksum
;

1348 
	#PXT4_S_ERR_LEN
 (
PXT4_S_ERR_END
 - 
PXT4_S_ERR_START
)

	)

1350 #ifde‡
__KERNEL__


1355 
	#PXT4_MF_MNTDIR_SAMPLED
 0x0001

	)

1356 
	#PXT4_MF_FS_ABORTED
 0x0002

	)

1357 
	#PXT4_MF_TEST_DUMMY_ENCRYPTION
 0x0004

	)

1359 #ifde‡
CONFIG_FS_ENCRYPTION


1360 
	#DUMMY_ENCRYPTION_ENABLED
(
sbi
Ë(
	`u∆ikñy
((sbi)->
s_mou¡_Êags
 & \

1361 
PXT4_MF_TEST_DUMMY_ENCRYPTION
))

	)

1363 
	#DUMMY_ENCRYPTION_ENABLED
(
sbi
Ë(0)

	)

1367 
	#PXT4_MAXQUOTAS
 3

	)

1369 
	#PXT4_ENC_UTF8_12_1
 1

	)

1374 
	#PXT4_ENC_STRICT_MODE_FL
 (1 << 0)

	)

1376 
	#pxt4_has_°ri˘_mode
(
sbi
) \

1377 (
sbi
->
s_ícodög_Êags
 & 
PXT4_ENC_STRICT_MODE_FL
)

	)

1382 
	spxt4_sb_öfo
 {

1383 
	ms_desc_size
;

1384 
	ms_öodes_≥r_block
;

1385 
	ms_blocks_≥r_group
;

1386 
	ms_˛u°îs_≥r_group
;

1387 
	ms_öodes_≥r_group
;

1388 
	ms_ôb_≥r_group
;

1389 
	ms_gdb_cou¡
;

1390 
	ms_desc_≥r_block
;

1391 
pxt4_group_t
 
	ms_groups_cou¡
;

1392 
pxt4_group_t
 
	ms_blockfûe_groups
;

1393 
	ms_ovîhód
;

1394 
	ms_˛u°î_øtio
;

1395 
	ms_˛u°î_bôs
;

1396 
loff_t
 
	ms_bôm≠_maxbyãs
;

1397 
buf„r_hód
 * 
	ms_sbh
;

1398 
pxt4_su≥r_block
 *
	ms_es
;

1399 
buf„r_hód
 * 
__rcu
 *
	ms_group_desc
;

1400 
	ms_mou¡_›t
;

1401 
	ms_mou¡_›t2
;

1402 
	ms_mou¡_Êags
;

1403 
	ms_def_mou¡_›t
;

1404 
pxt4_fsblk_t
 
	ms_sb_block
;

1405 
©omic64_t
 
	ms_ªsv_˛u°îs
;

1406 
kuid_t
 
	ms_ªsuid
;

1407 
kgid_t
 
	ms_ªsgid
;

1408 
	ms_mou¡_°©e
;

1409 
	ms_∑d
;

1410 
	ms_addr_≥r_block_bôs
;

1411 
	ms_desc_≥r_block_bôs
;

1412 
	ms_öode_size
;

1413 
	ms_fú°_öo
;

1414 
	ms_öode_ªadahód_blks
;

1415 
	ms_öode_gﬂl
;

1416 
u32
 
	ms_hash_£ed
[4];

1417 
	ms_def_hash_vîsi⁄
;

1418 
	ms_hash_unsig√d
;

1419 
≥r˝u_cou¡î
 
	ms_‰ì˛u°îs_cou¡î
;

1420 
≥r˝u_cou¡î
 
	ms_‰ìöodes_cou¡î
;

1421 
≥r˝u_cou¡î
 
	ms_dús_cou¡î
;

1422 
≥r˝u_cou¡î
 
	ms_dúty˛u°îs_cou¡î
;

1423 
≥r˝u_cou¡î
 
	ms_§a_ex˚eded_ªåy_limô
;

1424 
blockgroup_lock
 *
	ms_blockgroup_lock
;

1425 
¥oc_dú_íåy
 *
	ms_¥oc
;

1426 
kobje˘
 
	ms_kobj
;

1427 
com∂ëi⁄
 
	ms_kobj_uƒegi°î
;

1428 
su≥r_block
 *
	ms_sb
;

1429 #ifde‡
CONFIG_UNICODE


1430 
unicode_m≠
 *
	ms_ícodög
;

1431 
__u16
 
	ms_ícodög_Êags
;

1435 
jou∫Æ_s
 *
	ms_jou∫Æ
;

1436 
li°_hód
 
	ms_‹ph™
;

1437 
muãx
 
	ms_‹ph™_lock
;

1438 
	ms_pxt4_Êags
;

1439 
	ms_commô_öãrvÆ
;

1440 
u32
 
	ms_max_b©ch_time
;

1441 
u32
 
	ms_mö_b©ch_time
;

1442 
block_devi˚
 *
	mjou∫Æ_bdev
;

1443 #ifde‡
CONFIG_QUOTA


1445 
__rcu
 *
	ms_qf_«mes
[
PXT4_MAXQUOTAS
];

1446 
	ms_jquŸa_fmt
;

1448 
	ms_w™t_exåa_isize
;

1449 
pxt4_sy°em_blocks
 
__rcu
 *
	msy°em_blks
;

1451 #ifde‡
EXTENTS_STATS


1453 
	ms_ext_mö
;

1454 
	ms_ext_max
;

1455 
	ms_dïth_max
;

1456 
•ölock_t
 
	ms_ext_°©s_lock
;

1457 
	ms_ext_blocks
;

1458 
	ms_ext_exã¡s
;

1462 
pxt4_group_öfo
 ** 
__rcu
 *
	ms_group_öfo
;

1463 
öode
 *
	ms_buddy_ˇche
;

1464 
•ölock_t
 
	ms_md_lock
;

1465 *
	ms_mb_off£ts
;

1466 *
	ms_mb_maxs
;

1467 
	ms_group_öfo_size
;

1468 
	ms_mb_‰ì_≥ndög
;

1469 
li°_hód
 
	ms_‰ìd_d©a_li°
;

1473 
	ms_°rùe
;

1474 
	ms_mb_°ªam_ªque°
;

1475 
	ms_mb_max_to_sˇn
;

1476 
	ms_mb_mö_to_sˇn
;

1477 
	ms_mb_°©s
;

1478 
	ms_mb_‹dî2_ªqs
;

1479 
	ms_mb_group_¥óŒoc
;

1480 
	ms_max_dú_size_kb
;

1482 
	ms_mb_œ°_group
;

1483 
	ms_mb_œ°_°¨t
;

1486 
©omic_t
 
	ms_bÆ_ªqs
;

1487 
©omic_t
 
	ms_bÆ_suc˚ss
;

1488 
©omic_t
 
	ms_bÆ_Æloˇãd
;

1489 
©omic_t
 
	ms_bÆ_ex_sˇ¬ed
;

1490 
©omic_t
 
	ms_bÆ_gﬂls
;

1491 
©omic_t
 
	ms_bÆ_bªaks
;

1492 
©omic_t
 
	ms_bÆ_2‹dîs
;

1493 
•ölock_t
 
	ms_bÆ_lock
;

1494 
	ms_mb_buddõs_gíî©ed
;

1495 
	ms_mb_gíî©i⁄_time
;

1496 
©omic_t
 
	ms_mb_lo°_chunks
;

1497 
©omic_t
 
	ms_mb_¥óŒoˇãd
;

1498 
©omic_t
 
	ms_mb_disˇrded
;

1499 
©omic_t
 
	ms_lock_busy
;

1502 
pxt4_loˇlôy_group
 
__≥r˝u
 *
	ms_loˇlôy_groups
;

1505 
	ms_£˘‹s_wrôãn_°¨t
;

1506 
u64
 
	ms_kbyãs_wrôãn
;

1509 
	ms_exã¡_max_zîoout_kb
;

1511 
	ms_log_groups_≥r_Êex
;

1512 
Êex_groups
 * 
__rcu
 *
	ms_Êex_groups
;

1513 
pxt4_group_t
 
	ms_Êex_groups_Æloˇãd
;

1516 
w‹kqueue_°ru˘
 *
	mrsv_c⁄vîsi⁄_wq
;

1519 
timî_li°
 
	ms_îr_ªp‹t
;

1522 
pxt4_li_ªque°
 *
	ms_li_ªque°
;

1524 
	ms_li_waô_mu…
;

1527 
èsk_°ru˘
 *
	ms_mmp_tsk
;

1530 
©omic_t
 
	ms_œ°_åim_möblks
;

1533 
¸y±o_shash
 *
	ms_chksum_drivî
;

1536 
__u32
 
	ms_csum_£ed
;

1539 
shrökî
 
	ms_es_shrökî
;

1540 
li°_hód
 
	ms_es_li°
;

1541 
	ms_es_ƒ_öode
;

1542 
pxt4_es_°©s
 
	ms_es_°©s
;

1543 
mb_ˇche
 *
	ms_ó_block_ˇche
;

1544 
mb_ˇche
 *
	ms_ó_öode_ˇche
;

1545 
•ölock_t
 
s_es_lock
 
	m____ˇchñöe_Æig√d_ö_smp
;

1548 
øãlimô_°©e
 
	ms_îr_øãlimô_°©e
;

1549 
øãlimô_°©e
 
	ms_w¨nög_øãlimô_°©e
;

1550 
øãlimô_°©e
 
	ms_msg_øãlimô_°©e
;

1556 
≥r˝u_rw_£m≠h‹e
 
	ms_wrôïages_rw£m
;

1557 
dax_devi˚
 *
	ms_daxdev
;

1560 
ölöe
 
pxt4_sb_öfo
 *
	$PXT4_SB
(
su≥r_block
 *
sb
)

1562  
sb
->
s_fs_öfo
;

1563 
	}
}

1564 
ölöe
 
pxt4_öode_öfo
 *
	$PXT4_I
(
öode
 *inode)

1566  
	`c⁄èöî_of
(
öode
, 
pxt4_öode_öfo
, 
vfs_öode
);

1567 
	}
}

1569 
ölöe
 
	$pxt4_vÆid_öum
(
su≥r_block
 *
sb
, 
öo
)

1571  
öo
 =
PXT4_ROOT_INO
 ||

1572 (
öo
 >
	`PXT4_FIRST_INO
(
sb
) &&

1573 
öo
 <
	`À32_to_˝u
(
	`PXT4_SB
(
sb
)->
s_es
->
s_öodes_cou¡
));

1574 
	}
}

1584 
	#sbi_¨øy_rcu_dîef
(
sbi
, 
fõld
, 
ödex
) \

1586 
	`ty≥of
(*((
sbi
)->
fõld
)Ë
_v
; \

1587 
	`rcu_ªad_lock
(); \

1588 
_v
 = ((
	`ty≥of
(_v)*)
	`rcu_dîe„ªn˚
((
sbi
)->
fõld
))[
ödex
]; \

1589 
	`rcu_ªad_u∆ock
(); \

1590 
_v
; \

1591 })

	)

1597 
	mPXT4_STATE_JDATA
,

1598 
	mPXT4_STATE_NEW
,

1599 
	mPXT4_STATE_XATTR
,

1600 
	mPXT4_STATE_NO_EXPAND
,

1601 
	mPXT4_STATE_DA_ALLOC_CLOSE
,

1602 
	mPXT4_STATE_EXT_MIGRATE
,

1603 
	mPXT4_STATE_DIO_UNWRITTEN
,

1604 
	mPXT4_STATE_NEWENTRY
,

1605 
	mPXT4_STATE_MAY_INLINE_DATA
,

1606 
	mPXT4_STATE_EXT_PRECACHED
,

1607 
	mPXT4_STATE_LUSTRE_EA_INODE
,

1608 
	mPXT4_STATE_VERITY_IN_PROGRESS
,

1611 
	#PXT4_INODE_BIT_FNS
(
«me
, 
fõld
, 
off£t
) \

1612 
ölöe
 
pxt4_ã°_öode_
##
	`«me
(
öode
 *öode, 
bô
) \

1614  
	`ã°_bô
(
bô
 + (
off£t
), &
	`PXT4_I
(
öode
)->
i_
##
fõld
); \

1616 
ölöe
 
pxt4_£t_öode_
##
	`«me
(
öode
 *öode, 
bô
) \

1618 
	`£t_bô
(
bô
 + (
off£t
), &
	`PXT4_I
(
öode
)->
i_
##
fõld
); \

1620 
ölöe
 
pxt4_˛ór_öode_
##
	`«me
(
öode
 *öode, 
bô
) \

1622 
	`˛ór_bô
(
bô
 + (
off£t
), &
	`PXT4_I
(
öode
)->
i_
##
fõld
); \

1623 }

	)

1627 
ölöe
 
pxt4_ã°_öode_Êag
(
öode
 *öode, 
bô
);

1628 
ölöe
 
pxt4_£t_öode_Êag
(
öode
 *öode, 
bô
);

1629 
ölöe
 
pxt4_˛ór_öode_Êag
(
öode
 *öode, 
bô
);

1630 
	$PXT4_INODE_BIT_FNS
(
Êag
, 
Êags
, 0)

1634 
ölöe
 
	`pxt4_ã°_öode_°©e
(
öode
 *öode, 
bô
);

1635 
ölöe
 
	`pxt4_£t_öode_°©e
(
öode
 *öode, 
bô
);

1636 
ölöe
 
	`pxt4_˛ór_öode_°©e
(
öode
 *öode, 
bô
);

1637 #i‡(
BITS_PER_LONG
 < 64)

1638 
	$PXT4_INODE_BIT_FNS
(
°©e
, 
°©e_Êags
, 0)

1640 
ölöe
 
	$pxt4_˛ór_°©e_Êags
(
pxt4_öode_öfo
 *
ei
)

1642 (
ei
)->
i_°©e_Êags
 = 0;

1643 
	}
}

1645 
	$PXT4_INODE_BIT_FNS
(
°©e
, 
Êags
, 32)

1647 
ölöe
 
	$pxt4_˛ór_°©e_Êags
(
pxt4_öode_öfo
 *
ei
)

1650 
	}
}

1656 
	#PXT4_SB
(
sb
Ë(sb)

	)

1659 
ölöe
 
boﬁ
 
	$pxt4_vîôy_ö_¥ogªss
(
öode
 *inode)

1661  
	`IS_ENABLED
(
CONFIG_FS_VERITY
) &&

1662 
	`pxt4_ã°_öode_°©e
(
öode
, 
PXT4_STATE_VERITY_IN_PROGRESS
);

1663 
	}
}

1665 
	#NEXT_ORPHAN
(
öode
Ë
	`PXT4_I
(öode)->
i_dtime


	)

1670 
	#PXT4_OS_LINUX
 0

	)

1671 
	#PXT4_OS_HURD
 1

	)

1672 
	#PXT4_OS_MASIX
 2

	)

1673 
	#PXT4_OS_FREEBSD
 3

	)

1674 
	#PXT4_OS_LITES
 4

	)

1679 
	#PXT4_GOOD_OLD_REV
 0

	)

1680 
	#PXT4_DYNAMIC_REV
 1

	)

1682 
	#PXT4_CURRENT_REV
 
PXT4_GOOD_OLD_REV


	)

1683 
	#PXT4_MAX_SUPP_REV
 
PXT4_DYNAMIC_REV


	)

1685 
	#PXT4_GOOD_OLD_INODE_SIZE
 128

	)

1687 
	#PXT4_EXTRA_TIMESTAMP_MAX
 (((
s64
)1 << 34Ë- 1 + 
S32_MIN
)

	)

1688 
	#PXT4_NON_EXTRA_TIMESTAMP_MAX
 
S32_MAX


	)

1689 
	#PXT4_TIMESTAMP_MIN
 
S32_MIN


	)

1695 
	#PXT4_FEATURE_COMPAT_DIR_PREALLOC
 0x0001

	)

1696 
	#PXT4_FEATURE_COMPAT_IMAGIC_INODES
 0x0002

	)

1697 
	#PXT4_FEATURE_COMPAT_HAS_JOURNAL
 0x0004

	)

1698 
	#PXT4_FEATURE_COMPAT_EXT_ATTR
 0x0008

	)

1699 
	#PXT4_FEATURE_COMPAT_RESIZE_INODE
 0x0010

	)

1700 
	#PXT4_FEATURE_COMPAT_DIR_INDEX
 0x0020

	)

1701 
	#PXT4_FEATURE_COMPAT_SPARSE_SUPER2
 0x0200

	)

1703 
	#PXT4_FEATURE_RO_COMPAT_SPARSE_SUPER
 0x0001

	)

1704 
	#PXT4_FEATURE_RO_COMPAT_LARGE_FILE
 0x0002

	)

1705 
	#PXT4_FEATURE_RO_COMPAT_BTREE_DIR
 0x0004

	)

1706 
	#PXT4_FEATURE_RO_COMPAT_HUGE_FILE
 0x0008

	)

1707 
	#PXT4_FEATURE_RO_COMPAT_GDT_CSUM
 0x0010

	)

1708 
	#PXT4_FEATURE_RO_COMPAT_DIR_NLINK
 0x0020

	)

1709 
	#PXT4_FEATURE_RO_COMPAT_EXTRA_ISIZE
 0x0040

	)

1710 
	#PXT4_FEATURE_RO_COMPAT_QUOTA
 0x0100

	)

1711 
	#PXT4_FEATURE_RO_COMPAT_BIGALLOC
 0x0200

	)

1718 
	#PXT4_FEATURE_RO_COMPAT_METADATA_CSUM
 0x0400

	)

1719 
	#PXT4_FEATURE_RO_COMPAT_READONLY
 0x1000

	)

1720 
	#PXT4_FEATURE_RO_COMPAT_PROJECT
 0x2000

	)

1721 
	#PXT4_FEATURE_RO_COMPAT_VERITY
 0x8000

	)

1723 
	#PXT4_FEATURE_INCOMPAT_COMPRESSION
 0x0001

	)

1724 
	#PXT4_FEATURE_INCOMPAT_FILETYPE
 0x0002

	)

1725 
	#PXT4_FEATURE_INCOMPAT_RECOVER
 0x0004

	)

1726 
	#PXT4_FEATURE_INCOMPAT_JOURNAL_DEV
 0x0008

	)

1727 
	#PXT4_FEATURE_INCOMPAT_META_BG
 0x0010

	)

1728 
	#PXT4_FEATURE_INCOMPAT_EXTENTS
 0x0040

	)

1729 
	#PXT4_FEATURE_INCOMPAT_64BIT
 0x0080

	)

1730 
	#PXT4_FEATURE_INCOMPAT_MMP
 0x0100

	)

1731 
	#PXT4_FEATURE_INCOMPAT_FLEX_BG
 0x0200

	)

1732 
	#PXT4_FEATURE_INCOMPAT_EA_INODE
 0x0400

	)

1733 
	#PXT4_FEATURE_INCOMPAT_DIRDATA
 0x1000

	)

1734 
	#PXT4_FEATURE_INCOMPAT_CSUM_SEED
 0x2000

	)

1735 
	#PXT4_FEATURE_INCOMPAT_LARGEDIR
 0x4000

	)

1736 
	#PXT4_FEATURE_INCOMPAT_INLINE_DATA
 0x8000

	)

1737 
	#PXT4_FEATURE_INCOMPAT_ENCRYPT
 0x10000

	)

1738 
	#PXT4_FEATURE_INCOMPAT_CASEFOLD
 0x20000

	)

1740 
pxt4_upd©e_dy«mic_ªv
(
su≥r_block
 *
sb
);

1742 
	#PXT4_FEATURE_COMPAT_FUNCS
(
«me
, 
Êag«me
) \

1743 
ölöe
 
boﬁ
 
pxt4_has_„©uª_
##
	`«me
(
su≥r_block
 *
sb
) \

1745  ((
	`PXT4_SB
(
sb
)->
s_es
->
s_„©uª_com∑t
 & \

1746 
	`˝u_to_À32
(
PXT4_FEATURE_COMPAT_
##
Êag«me
)) != 0); \

1748 
ölöe
 
pxt4_£t_„©uª_
##
	`«me
(
su≥r_block
 *
sb
) \

1750 
	`pxt4_upd©e_dy«mic_ªv
(
sb
); \

1751 
	`PXT4_SB
(
sb
)->
s_es
->
s_„©uª_com∑t
 |= \

1752 
	`˝u_to_À32
(
PXT4_FEATURE_COMPAT_
##
Êag«me
); \

1754 
ölöe
 
pxt4_˛ór_„©uª_
##
	`«me
(
su≥r_block
 *
sb
) \

1756 
	`PXT4_SB
(
sb
)->
s_es
->
s_„©uª_com∑t
 &= \

1757 ~
	`˝u_to_À32
(
PXT4_FEATURE_COMPAT_
##
Êag«me
); \

1758 }

	)

1760 
	#PXT4_FEATURE_RO_COMPAT_FUNCS
(
«me
, 
Êag«me
) \

1761 
ölöe
 
boﬁ
 
pxt4_has_„©uª_
##
	`«me
(
su≥r_block
 *
sb
) \

1763  ((
	`PXT4_SB
(
sb
)->
s_es
->
s_„©uª_ro_com∑t
 & \

1764 
	`˝u_to_À32
(
PXT4_FEATURE_RO_COMPAT_
##
Êag«me
)) != 0); \

1766 
ölöe
 
pxt4_£t_„©uª_
##
	`«me
(
su≥r_block
 *
sb
) \

1768 
	`pxt4_upd©e_dy«mic_ªv
(
sb
); \

1769 
	`PXT4_SB
(
sb
)->
s_es
->
s_„©uª_ro_com∑t
 |= \

1770 
	`˝u_to_À32
(
PXT4_FEATURE_RO_COMPAT_
##
Êag«me
); \

1772 
ölöe
 
pxt4_˛ór_„©uª_
##
	`«me
(
su≥r_block
 *
sb
) \

1774 
	`PXT4_SB
(
sb
)->
s_es
->
s_„©uª_ro_com∑t
 &= \

1775 ~
	`˝u_to_À32
(
PXT4_FEATURE_RO_COMPAT_
##
Êag«me
); \

1776 }

	)

1778 
	#PXT4_FEATURE_INCOMPAT_FUNCS
(
«me
, 
Êag«me
) \

1779 
ölöe
 
boﬁ
 
pxt4_has_„©uª_
##
	`«me
(
su≥r_block
 *
sb
) \

1781  ((
	`PXT4_SB
(
sb
)->
s_es
->
s_„©uª_öcom∑t
 & \

1782 
	`˝u_to_À32
(
PXT4_FEATURE_INCOMPAT_
##
Êag«me
)) != 0); \

1784 
ölöe
 
pxt4_£t_„©uª_
##
	`«me
(
su≥r_block
 *
sb
) \

1786 
	`pxt4_upd©e_dy«mic_ªv
(
sb
); \

1787 
	`PXT4_SB
(
sb
)->
s_es
->
s_„©uª_öcom∑t
 |= \

1788 
	`˝u_to_À32
(
PXT4_FEATURE_INCOMPAT_
##
Êag«me
); \

1790 
ölöe
 
pxt4_˛ór_„©uª_
##
	`«me
(
su≥r_block
 *
sb
) \

1792 
	`PXT4_SB
(
sb
)->
s_es
->
s_„©uª_öcom∑t
 &= \

1793 ~
	`˝u_to_À32
(
PXT4_FEATURE_INCOMPAT_
##
Êag«me
); \

1794 }

	)

1796 
	$PXT4_FEATURE_COMPAT_FUNCS
(
dú_¥óŒoc
, 
DIR_PREALLOC
)

1797 
	$PXT4_FEATURE_COMPAT_FUNCS
(
imagic_öodes
, 
IMAGIC_INODES
)

1798 
	$PXT4_FEATURE_COMPAT_FUNCS
(
jou∫Æ
, 
HAS_JOURNAL
)

1799 
	$PXT4_FEATURE_COMPAT_FUNCS
(
x©å
, 
EXT_ATTR
)

1800 
	$PXT4_FEATURE_COMPAT_FUNCS
(
ªsize_öode
, 
RESIZE_INODE
)

1801 
	$PXT4_FEATURE_COMPAT_FUNCS
(
dú_ödex
, 
DIR_INDEX
)

1802 
	$PXT4_FEATURE_COMPAT_FUNCS
(
•¨£_su≥r2
, 
SPARSE_SUPER2
)

1804 
	$PXT4_FEATURE_RO_COMPAT_FUNCS
(
•¨£_su≥r
, 
SPARSE_SUPER
)

1805 
	$PXT4_FEATURE_RO_COMPAT_FUNCS
(
œrge_fûe
, 
LARGE_FILE
)

1806 
	$PXT4_FEATURE_RO_COMPAT_FUNCS
(
båì_dú
, 
BTREE_DIR
)

1807 
	$PXT4_FEATURE_RO_COMPAT_FUNCS
(
huge_fûe
, 
HUGE_FILE
)

1808 
	$PXT4_FEATURE_RO_COMPAT_FUNCS
(
gdt_csum
, 
GDT_CSUM
)

1809 
	$PXT4_FEATURE_RO_COMPAT_FUNCS
(
dú_∆ök
, 
DIR_NLINK
)

1810 
	$PXT4_FEATURE_RO_COMPAT_FUNCS
(
exåa_isize
, 
EXTRA_ISIZE
)

1811 
	$PXT4_FEATURE_RO_COMPAT_FUNCS
(
quŸa
, 
QUOTA
)

1812 
	$PXT4_FEATURE_RO_COMPAT_FUNCS
(
bigÆloc
, 
BIGALLOC
)

1813 
	$PXT4_FEATURE_RO_COMPAT_FUNCS
(
mëad©a_csum
, 
METADATA_CSUM
)

1814 
	$PXT4_FEATURE_RO_COMPAT_FUNCS
(
ªad⁄ly
, 
READONLY
)

1815 
	$PXT4_FEATURE_RO_COMPAT_FUNCS
(
¥oje˘
, 
PROJECT
)

1816 
	$PXT4_FEATURE_RO_COMPAT_FUNCS
(
vîôy
, 
VERITY
)

1818 
	$PXT4_FEATURE_INCOMPAT_FUNCS
(
com¥essi⁄
, 
COMPRESSION
)

1819 
	$PXT4_FEATURE_INCOMPAT_FUNCS
(
fûëy≥
, 
FILETYPE
)

1820 
	$PXT4_FEATURE_INCOMPAT_FUNCS
(
jou∫Æ_√eds_ªcovîy
, 
RECOVER
)

1821 
	$PXT4_FEATURE_INCOMPAT_FUNCS
(
jou∫Æ_dev
, 
JOURNAL_DEV
)

1822 
	$PXT4_FEATURE_INCOMPAT_FUNCS
(
mëa_bg
, 
META_BG
)

1823 
	$PXT4_FEATURE_INCOMPAT_FUNCS
(
exã¡s
, 
EXTENTS
)

1824 
	$PXT4_FEATURE_INCOMPAT_FUNCS
(64b
ô
, 64B
IT
)

1825 
	$PXT4_FEATURE_INCOMPAT_FUNCS
(
mmp
, 
MMP
)

1826 
	$PXT4_FEATURE_INCOMPAT_FUNCS
(
Êex_bg
, 
FLEX_BG
)

1827 
	$PXT4_FEATURE_INCOMPAT_FUNCS
(
ó_öode
, 
EA_INODE
)

1828 
	$PXT4_FEATURE_INCOMPAT_FUNCS
(
dúd©a
, 
DIRDATA
)

1829 
	$PXT4_FEATURE_INCOMPAT_FUNCS
(
csum_£ed
, 
CSUM_SEED
)

1830 
	$PXT4_FEATURE_INCOMPAT_FUNCS
(
œrgedú
, 
LARGEDIR
)

1831 
	$PXT4_FEATURE_INCOMPAT_FUNCS
(
ölöe_d©a
, 
INLINE_DATA
)

1832 
	$PXT4_FEATURE_INCOMPAT_FUNCS
(
í¸y±
, 
ENCRYPT
)

1833 
	$PXT4_FEATURE_INCOMPAT_FUNCS
(
ˇ£fﬁd
, 
CASEFOLD
)

1835 
	#EXT2_FEATURE_COMPAT_SUPP
 
PXT4_FEATURE_COMPAT_EXT_ATTR


	)

1836 
	#EXT2_FEATURE_INCOMPAT_SUPP
 (
PXT4_FEATURE_INCOMPAT_FILETYPE
| \

1837 
PXT4_FEATURE_INCOMPAT_META_BG
)

	)

1838 
	#EXT2_FEATURE_RO_COMPAT_SUPP
 (
PXT4_FEATURE_RO_COMPAT_SPARSE_SUPER
| \

1839 
PXT4_FEATURE_RO_COMPAT_LARGE_FILE
| \

1840 
PXT4_FEATURE_RO_COMPAT_BTREE_DIR
)

	)

1842 
	#EXT3_FEATURE_COMPAT_SUPP
 
PXT4_FEATURE_COMPAT_EXT_ATTR


	)

1843 
	#EXT3_FEATURE_INCOMPAT_SUPP
 (
PXT4_FEATURE_INCOMPAT_FILETYPE
| \

1844 
PXT4_FEATURE_INCOMPAT_RECOVER
| \

1845 
PXT4_FEATURE_INCOMPAT_META_BG
)

	)

1846 
	#EXT3_FEATURE_RO_COMPAT_SUPP
 (
PXT4_FEATURE_RO_COMPAT_SPARSE_SUPER
| \

1847 
PXT4_FEATURE_RO_COMPAT_LARGE_FILE
| \

1848 
PXT4_FEATURE_RO_COMPAT_BTREE_DIR
)

	)

1850 
	#PXT4_FEATURE_COMPAT_SUPP
 
PXT4_FEATURE_COMPAT_EXT_ATTR


	)

1851 
	#PXT4_FEATURE_INCOMPAT_SUPP
 (
PXT4_FEATURE_INCOMPAT_FILETYPE
| \

1852 
PXT4_FEATURE_INCOMPAT_RECOVER
| \

1853 
PXT4_FEATURE_INCOMPAT_META_BG
| \

1854 
PXT4_FEATURE_INCOMPAT_EXTENTS
| \

1855 
PXT4_FEATURE_INCOMPAT_64BIT
| \

1856 
PXT4_FEATURE_INCOMPAT_FLEX_BG
| \

1857 
PXT4_FEATURE_INCOMPAT_EA_INODE
| \

1858 
PXT4_FEATURE_INCOMPAT_MMP
 | \

1859 
PXT4_FEATURE_INCOMPAT_INLINE_DATA
 | \

1860 
PXT4_FEATURE_INCOMPAT_ENCRYPT
 | \

1861 
PXT4_FEATURE_INCOMPAT_CASEFOLD
 | \

1862 
PXT4_FEATURE_INCOMPAT_CSUM_SEED
 | \

1863 
PXT4_FEATURE_INCOMPAT_LARGEDIR
)

	)

1864 
	#PXT4_FEATURE_RO_COMPAT_SUPP
 (
PXT4_FEATURE_RO_COMPAT_SPARSE_SUPER
| \

1865 
PXT4_FEATURE_RO_COMPAT_LARGE_FILE
| \

1866 
PXT4_FEATURE_RO_COMPAT_GDT_CSUM
| \

1867 
PXT4_FEATURE_RO_COMPAT_DIR_NLINK
 | \

1868 
PXT4_FEATURE_RO_COMPAT_EXTRA_ISIZE
 | \

1869 
PXT4_FEATURE_RO_COMPAT_BTREE_DIR
 |\

1870 
PXT4_FEATURE_RO_COMPAT_HUGE_FILE
 |\

1871 
PXT4_FEATURE_RO_COMPAT_BIGALLOC
 |\

1872 
PXT4_FEATURE_RO_COMPAT_METADATA_CSUM
|\

1873 
PXT4_FEATURE_RO_COMPAT_QUOTA
 |\

1874 
PXT4_FEATURE_RO_COMPAT_PROJECT
 |\

1875 
PXT4_FEATURE_RO_COMPAT_VERITY
)

	)

1877 
	#EXTN_FEATURE_FUNCS
(
vî
) \

1878 
ölöe
 
boﬁ
 
pxt4_has_unknown_ext
##
vî
##
	`_com∑t_„©uªs
(
su≥r_block
 *
sb
) \

1880  ((
	`PXT4_SB
(
sb
)->
s_es
->
s_„©uª_com∑t
 & \

1881 
	`˝u_to_À32
(~
EXT
##
vî
##
_FEATURE_COMPAT_SUPP
)) != 0); \

1882 
	}
} \

1883 
ölöe
 
boﬁ
 
pxt4_has_unknown_ext
##
vî
##
	`_ro_com∑t_„©uªs
(
su≥r_block
 *
sb
) \

1885  ((
	`PXT4_SB
(
sb
)->
s_es
->
s_„©uª_ro_com∑t
 & \

1886 
	`˝u_to_À32
(~
EXT
##
vî
##
_FEATURE_RO_COMPAT_SUPP
)) != 0); \

1888 
ölöe
 
boﬁ
 
pxt4_has_unknown_ext
##
vî
##
	`_öcom∑t_„©uªs
(
su≥r_block
 *
sb
) \

1890  ((
	`PXT4_SB
(
sb
)->
s_es
->
s_„©uª_öcom∑t
 & \

1891 
	`˝u_to_À32
(~
EXT
##
vî
##
_FEATURE_INCOMPAT_SUPP
)) != 0); \

1892 }

	)

1894 
	$EXTN_FEATURE_FUNCS
(2)

1895 
	$EXTN_FEATURE_FUNCS
(3)

1896 
	$EXTN_FEATURE_FUNCS
(4)

1898 
ölöe
 
boﬁ
 
	$pxt4_has_com∑t_„©uªs
(
su≥r_block
 *
sb
)

1900  (
	`PXT4_SB
(
sb
)->
s_es
->
s_„©uª_com∑t
 != 0);

1901 
	}
}

1902 
ölöe
 
boﬁ
 
	$pxt4_has_ro_com∑t_„©uªs
(
su≥r_block
 *
sb
)

1904  (
	`PXT4_SB
(
sb
)->
s_es
->
s_„©uª_ro_com∑t
 != 0);

1905 
	}
}

1906 
ölöe
 
boﬁ
 
	$pxt4_has_öcom∑t_„©uªs
(
su≥r_block
 *
sb
)

1908  (
	`PXT4_SB
(
sb
)->
s_es
->
s_„©uª_öcom∑t
 != 0);

1909 
	}
}

1914 
	#PXT4_FLAGS_RESIZING
 0

	)

1915 
	#PXT4_FLAGS_SHUTDOWN
 1

	)

1917 
ölöe
 
	$pxt4_f‹˚d_shutdown
(
pxt4_sb_öfo
 *
sbi
)

1919  
	`ã°_bô
(
PXT4_FLAGS_SHUTDOWN
, &
sbi
->
s_pxt4_Êags
);

1920 
	}
}

1926 
	#PXT4_DEF_RESUID
 0

	)

1927 
	#PXT4_DEF_RESGID
 0

	)

1932 
	#PXT4_DEF_PROJID
 0

	)

1934 
	#PXT4_DEF_INODE_READAHEAD_BLKS
 32

	)

1939 
	#PXT4_DEFM_DEBUG
 0x0001

	)

1940 
	#PXT4_DEFM_BSDGROUPS
 0x0002

	)

1941 
	#PXT4_DEFM_XATTR_USER
 0x0004

	)

1942 
	#PXT4_DEFM_ACL
 0x0008

	)

1943 
	#PXT4_DEFM_UID16
 0x0010

	)

1944 
	#PXT4_DEFM_JMODE
 0x0060

	)

1945 
	#PXT4_DEFM_JMODE_DATA
 0x0020

	)

1946 
	#PXT4_DEFM_JMODE_ORDERED
 0x0040

	)

1947 
	#PXT4_DEFM_JMODE_WBACK
 0x0060

	)

1948 
	#PXT4_DEFM_NOBARRIER
 0x0100

	)

1949 
	#PXT4_DEFM_BLOCK_VALIDITY
 0x0200

	)

1950 
	#PXT4_DEFM_DISCARD
 0x0400

	)

1951 
	#PXT4_DEFM_NODELALLOC
 0x0800

	)

1956 
	#PXT4_DEF_MIN_BATCH_TIME
 0

	)

1957 
	#PXT4_DEF_MAX_BATCH_TIME
 15000

	)

1963 
	#PXT4_FLEX_SIZE_DIR_ALLOC_SCHEME
 4

	)

1968 
	#PXT4_NAME_LEN
 255

	)

1970 
	spxt4_dú_íåy
 {

1971 
__À32
 
	möode
;

1972 
__À16
 
	mªc_Àn
;

1973 
__À16
 
	m«me_Àn
;

1974 
	m«me
[
PXT4_NAME_LEN
];

1983 
	spxt4_dú_íåy_2
 {

1984 
__À32
 
	möode
;

1985 
__À16
 
	mªc_Àn
;

1986 
__u8
 
	m«me_Àn
;

1987 
__u8
 
	mfûe_ty≥
;

1988 
	m«me
[
PXT4_NAME_LEN
];

1995 
	spxt4_dú_íåy_èû
 {

1996 
__À32
 
	mdë_ª£rved_zîo1
;

1997 
__À16
 
	mdë_ªc_Àn
;

1998 
__u8
 
	mdë_ª£rved_zîo2
;

1999 
__u8
 
	mdë_ª£rved_·
;

2000 
__À32
 
	mdë_checksum
;

2003 
	#PXT4_DIRENT_TAIL
(
block
, 
blocksize
) \

2004 ((
pxt4_dú_íåy_èû
 *)(((*)(
block
)) + \

2005 ((
blocksize
) - \

2006 (
pxt4_dú_íåy_èû
))))

	)

2012 
	#PXT4_FT_UNKNOWN
 0

	)

2013 
	#PXT4_FT_REG_FILE
 1

	)

2014 
	#PXT4_FT_DIR
 2

	)

2015 
	#PXT4_FT_CHRDEV
 3

	)

2016 
	#PXT4_FT_BLKDEV
 4

	)

2017 
	#PXT4_FT_FIFO
 5

	)

2018 
	#PXT4_FT_SOCK
 6

	)

2019 
	#PXT4_FT_SYMLINK
 7

	)

2021 
	#PXT4_FT_MAX
 8

	)

2023 
	#PXT4_FT_DIR_CSUM
 0xDE

	)

2030 
	#PXT4_DIR_PAD
 4

	)

2031 
	#PXT4_DIR_ROUND
 (
PXT4_DIR_PAD
 - 1)

	)

2032 
	#PXT4_DIR_REC_LEN
(
«me_Àn
Ë((“ame_ÀnË+ 8 + 
PXT4_DIR_ROUND
) & \

2033 ~
PXT4_DIR_ROUND
)

	)

2034 
	#PXT4_MAX_REC_LEN
 ((1<<16)-1)

	)

2040 
ölöe
 

2041 
	$pxt4_ªc_Àn_‰om_disk
(
__À16
 
dÀn
, 
blocksize
)

2043 
Àn
 = 
	`À16_to_˝u
(
dÀn
);

2045 #i‡(
PAGE_SIZE
 >= 65536)

2046 i‡(
Àn
 =
PXT4_MAX_REC_LEN
 ||Üen == 0)

2047  
blocksize
;

2048  (
Àn
 & 65532) | ((len & 3) << 16);

2050  
Àn
;

2052 
	}
}

2054 
ölöe
 
__À16
 
	$pxt4_ªc_Àn_to_disk
(
Àn
, 
blocksize
)

2056 i‡((
Àn
 > 
blocksize
) || (blocksize > (1 << 18)) || (len & 3))

2057 
	`BUG
();

2058 #i‡(
PAGE_SIZE
 >= 65536)

2059 i‡(
Àn
 < 65536)

2060  
	`˝u_to_À16
(
Àn
);

2061 i‡(
Àn
 =
blocksize
) {

2062 i‡(
blocksize
 == 65536)

2063  
	`˝u_to_À16
(
PXT4_MAX_REC_LEN
);

2065  
	`˝u_to_À16
(0);

2067  
	`˝u_to_À16
((
Àn
 & 65532) | ((len >> 16) & 3));

2069  
	`˝u_to_À16
(
Àn
);

2071 
	}
}

2078 
	#is_dx
(
dú
Ë(
	`pxt4_has_„©uª_dú_ödex
((dú)->
i_sb
) && \

2079 
	`pxt4_ã°_öode_Êag
((
dú
), 
PXT4_INODE_INDEX
))

	)

2080 
	#PXT4_DIR_LINK_MAX
(
dú
Ë
	`u∆ikñy
((dú)->
i_∆ök
 >
PXT4_LINK_MAX
 && \

2081 !(
	`pxt4_has_„©uª_dú_∆ök
((
dú
)->
i_sb
Ë&& 
	`is_dx
(dú)))

	)

2082 
	#PXT4_DIR_LINK_EMPTY
(
dú
Ë((dú)->
i_∆ök
 =2 || (dú)->i_∆ök =1)

	)

2086 
	#DX_HASH_LEGACY
 0

	)

2087 
	#DX_HASH_HALF_MD4
 1

	)

2088 
	#DX_HASH_TEA
 2

	)

2089 
	#DX_HASH_LEGACY_UNSIGNED
 3

	)

2090 
	#DX_HASH_HALF_MD4_UNSIGNED
 4

	)

2091 
	#DX_HASH_TEA_UNSIGNED
 5

	)

2093 
ölöe
 
u32
 
	$pxt4_chksum
(
pxt4_sb_öfo
 *
sbi
, 
u32
 
¸c
,

2094 c⁄° *
addªss
, 
Àngth
)

2097 
shash_desc
 
shash
;

2098 
˘x
[4];

2099 } 
desc
;

2101 
	`BUG_ON
(
	`¸y±o_shash_descsize
(
sbi
->
s_chksum_drivî
)!=(
desc
.
˘x
));

2103 
desc
.
shash
.
tfm
 = 
sbi
->
s_chksum_drivî
;

2104 *(
u32
 *)
desc
.
˘x
 = 
¸c
;

2106 
	`BUG_ON
(
	`¸y±o_shash_upd©e
(&
desc
.
shash
, 
addªss
, 
Àngth
));

2108  *(
u32
 *)
desc
.
˘x
;

2109 
	}
}

2111 #ifde‡
__KERNEL__


2114 
	sdx_hash_öfo


2116 
u32
 
	mhash
;

2117 
u32
 
	mmö‹_hash
;

2118 
	mhash_vîsi⁄
;

2119 
u32
 *
	m£ed
;

2124 
	#PXT4_HTREE_EOF_32BIT
 ((1UL << (32 - 1)Ë- 1)

	)

2125 
	#PXT4_HTREE_EOF_64BIT
 ((1ULL << (64 - 1)Ë- 1)

	)

2131 
	#HASH_NB_ALWAYS
 1

	)

2133 
	spxt4_fûíame
 {

2134 c⁄° 
q°r
 *
	mu§_‚ame
;

2135 
fs¸y±_°r
 
	mdisk_«me
;

2136 
dx_hash_öfo
 
	mhöfo
;

2137 #ifde‡
CONFIG_FS_ENCRYPTION


2138 
fs¸y±_°r
 
	m¸y±o_buf
;

2140 #ifde‡
CONFIG_UNICODE


2141 
fs¸y±_°r
 
	mcf_«me
;

2145 
	#‚ame_«me
(
p
Ë(’)->
disk_«me
.
«me
)

	)

2146 
	#‚ame_Àn
(
p
Ë(’)->
disk_«me
.
Àn
)

	)

2151 
	spxt4_ûoc


2153 
buf„r_hód
 *
	mbh
;

2154 
	moff£t
;

2155 
pxt4_group_t
 
	mblock_group
;

2158 
ölöe
 
pxt4_öode
 *
	$pxt4_øw_öode
(
pxt4_ûoc
 *
ûoc
)

2160  (
pxt4_öode
 *Ë(
ûoc
->
bh
->
b_d©a
 + iloc->
off£t
);

2161 
	}
}

2163 
ölöe
 
boﬁ
 
	$pxt4_is_quŸa_fûe
(
öode
 *inode)

2165  
	`IS_NOQUOTA
(
öode
) &&

2166 !(
	`PXT4_I
(
öode
)->
i_Êags
 & 
PXT4_EA_INODE_FL
);

2167 
	}
}

2174 
	sdú_¥iv©e_öfo
 {

2175 
rb_roŸ
 
	mroŸ
;

2176 
rb_node
 *
	mcuº_node
;

2177 
‚ame
 *
	mexåa_‚ame
;

2178 
loff_t
 
	mœ°_pos
;

2179 
__u32
 
	mcuº_hash
;

2180 
__u32
 
	mcuº_mö‹_hash
;

2181 
__u32
 
	m√xt_hash
;

2185 
ölöe
 
pxt4_fsblk_t


2186 
	$pxt4_group_fú°_block_no
(
su≥r_block
 *
sb
, 
pxt4_group_t
 
group_no
)

2188  
group_no
 * (
pxt4_fsblk_t
)
	`PXT4_BLOCKS_PER_GROUP
(
sb
) +

2189 
	`À32_to_˝u
(
	`PXT4_SB
(
sb
)->
s_es
->
s_fú°_d©a_block
);

2190 
	}
}

2195 
	#ERR_BAD_DX_DIR
 (-(
MAX_ERRNO
 - 1))

	)

2198 
	#PXT4_HTREE_LEVEL_COMPAT
 2

	)

2199 
	#PXT4_HTREE_LEVEL
 3

	)

2201 
ölöe
 
	$pxt4_dú_håì_Àvñ
(
su≥r_block
 *
sb
)

2203  
	`pxt4_has_„©uª_œrgedú
(
sb
) ?

2204 
PXT4_HTREE_LEVEL
 : 
PXT4_HTREE_LEVEL_COMPAT
;

2205 
	}
}

2210 
	#PXT4_DEF_LI_WAIT_MULT
 10

	)

2211 
	#PXT4_DEF_LI_MAX_START_DELAY
 5

	)

2212 
	#PXT4_LAZYINIT_QUIT
 0x0001

	)

2213 
	#PXT4_LAZYINIT_RUNNING
 0x0002

	)

2218 
	spxt4_œzy_öô
 {

2219 
	mli_°©e
;

2220 
li°_hód
 
	mli_ªque°_li°
;

2221 
muãx
 
	mli_li°_mtx
;

2224 
	spxt4_li_ªque°
 {

2225 
su≥r_block
 *
	mÃ_su≥r
;

2226 
pxt4_sb_öfo
 *
	mÃ_sbi
;

2227 
pxt4_group_t
 
	mÃ_√xt_group
;

2228 
li°_hód
 
	mÃ_ªque°
;

2229 
	mÃ_√xt_sched
;

2230 
	mÃ_timeout
;

2233 
	spxt4_„©uªs
 {

2234 
kobje˘
 
	mf_kobj
;

2235 
com∂ëi⁄
 
	mf_kobj_uƒegi°î
;

2245 
	#PXT4_MMP_MAGIC
 0x004D4D50U

	)

2246 
	#PXT4_MMP_SEQ_CLEAN
 0xFF4D4D50U

	)

2247 
	#PXT4_MMP_SEQ_FSCK
 0xE24D4D50U

	)

2248 
	#PXT4_MMP_SEQ_MAX
 0xE24D4D4FU

	)

2250 
	smmp_°ru˘
 {

2251 
__À32
 
	mmmp_magic
;

2252 
__À32
 
	mmmp_£q
;

2258 
__À64
 
	mmmp_time
;

2259 
	mmmp_nodíame
[64];

2260 
	mmmp_bdev«me
[32];

2267 
__À16
 
	mmmp_check_öãrvÆ
;

2269 
__À16
 
	mmmp_∑d1
;

2270 
__À32
 
	mmmp_∑d2
[226];

2271 
__À32
 
	mmmp_checksum
;

2275 
	smmpd_d©a
 {

2276 
buf„r_hód
 *
	mbh
;

2277 
su≥r_block
 *
	msb
;

2288 
	#PXT4_MMP_CHECK_MULT
 2UL

	)

2293 
	#PXT4_MMP_MIN_CHECK_INTERVAL
 5UL

	)

2298 
	#PXT4_MMP_MAX_CHECK_INTERVAL
 300UL

	)

2308 
	#NORET_TYPE


	)

2309 
	#ATTRIB_NORET
 
	`__©åibuã__
((
n‹ëu∫
))

	)

2310 
	#NORET_AND
 
n‹ëu∫
,

	)

2313 
pxt4_cou¡_‰ì
(*
bôm≠
, 
numch¨s
);

2314 
pxt4_öode_bôm≠_csum_£t
(
su≥r_block
 *
sb
, 
pxt4_group_t
 
group
,

2315 
pxt4_group_desc
 *
gdp
,

2316 
buf„r_hód
 *
bh
, 
sz
);

2317 
pxt4_öode_bôm≠_csum_vîify
(
su≥r_block
 *
sb
, 
pxt4_group_t
 
group
,

2318 
pxt4_group_desc
 *
gdp
,

2319 
buf„r_hód
 *
bh
, 
sz
);

2320 
pxt4_block_bôm≠_csum_£t
(
su≥r_block
 *
sb
, 
pxt4_group_t
 
group
,

2321 
pxt4_group_desc
 *
gdp
,

2322 
buf„r_hód
 *
bh
);

2323 
pxt4_block_bôm≠_csum_vîify
(
su≥r_block
 *
sb
, 
pxt4_group_t
 
group
,

2324 
pxt4_group_desc
 *
gdp
,

2325 
buf„r_hód
 *
bh
);

2328 
pxt4_gë_group_no_™d_off£t
(
su≥r_block
 *
sb
,

2329 
pxt4_fsblk_t
 
blockƒ
,

2330 
pxt4_group_t
 *
blockgΩp
,

2331 
pxt4_gΩblk_t
 *
off£ç
);

2332 
pxt4_group_t
 
pxt4_gë_group_numbî
(
su≥r_block
 *
sb
,

2333 
pxt4_fsblk_t
 
block
);

2335 
pxt4_block_group
(
su≥r_block
 *
sb
,

2336 
pxt4_fsblk_t
 
blockƒ
);

2337 
pxt4_gΩblk_t
 
pxt4_block_group_off£t
(
su≥r_block
 *
sb
,

2338 
pxt4_fsblk_t
 
blockƒ
);

2339 
pxt4_bg_has_su≥r
(
su≥r_block
 *
sb
, 
pxt4_group_t
 
group
);

2340 
pxt4_bg_num_gdb
(
su≥r_block
 *
sb
,

2341 
pxt4_group_t
 
group
);

2342 
pxt4_fsblk_t
 
pxt4_√w_mëa_blocks
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *inode,

2343 
pxt4_fsblk_t
 
gﬂl
,

2344 
Êags
,

2345 *
cou¡
,

2346 *
îΩ
);

2347 
pxt4_˛aim_‰ì_˛u°îs
(
pxt4_sb_öfo
 *
sbi
,

2348 
s64
 
n˛u°îs
, 
Êags
);

2349 
pxt4_fsblk_t
 
pxt4_cou¡_‰ì_˛u°îs
(
su≥r_block
 *);

2350 
pxt4_check_blocks_bôm≠
(
su≥r_block
 *);

2351 
pxt4_group_desc
 * 
pxt4_gë_group_desc
(
su≥r_block
 * 
sb
,

2352 
pxt4_group_t
 
block_group
,

2353 
buf„r_hód
 ** 
bh
);

2354 
pxt4_should_ªåy_Æloc
(
su≥r_block
 *
sb
, *
ªåõs
);

2356 
buf„r_hód
 *
pxt4_ªad_block_bôm≠_nowaô
(
su≥r_block
 *
sb
,

2357 
pxt4_group_t
 
block_group
);

2358 
pxt4_waô_block_bôm≠
(
su≥r_block
 *
sb
,

2359 
pxt4_group_t
 
block_group
,

2360 
buf„r_hód
 *
bh
);

2361 
buf„r_hód
 *
pxt4_ªad_block_bôm≠
(
su≥r_block
 *
sb
,

2362 
pxt4_group_t
 
block_group
);

2363 
pxt4_‰ì_˛u°îs_a·î_öô
(
su≥r_block
 *
sb
,

2364 
pxt4_group_t
 
block_group
,

2365 
pxt4_group_desc
 *
gdp
);

2366 
pxt4_fsblk_t
 
pxt4_öode_to_gﬂl_block
(
öode
 *);

2368 #ifde‡
CONFIG_UNICODE


2369 
pxt4_‚ame_£tup_ci_fûíame
(
öode
 *
dú
,

2370 c⁄° 
q°r
 *
öame
,

2371 
fs¸y±_°r
 *
‚ame
);

2374 #ifde‡
CONFIG_FS_ENCRYPTION


2375 
ölöe
 
	$pxt4_‚ame_‰om_fs¸y±_«me
(
pxt4_fûíame
 *
d°
,

2376 c⁄° 
fs¸y±_«me
 *
§c
)

2378 
	`mem£t
(
d°
, 0, (*dst));

2380 
d°
->
u§_‚ame
 = 
§c
->usr_fname;

2381 
d°
->
disk_«me
 = 
§c
->disk_name;

2382 
d°
->
höfo
.
hash
 = 
§c
->hash;

2383 
d°
->
höfo
.
mö‹_hash
 = 
§c
->minor_hash;

2384 
d°
->
¸y±o_buf
 = 
§c
->crypto_buf;

2385 
	}
}

2387 
ölöe
 
	$pxt4_‚ame_£tup_fûíame
(
öode
 *
dú
,

2388 c⁄° 
q°r
 *
öame
,

2389 
lookup
,

2390 
pxt4_fûíame
 *
‚ame
)

2392 
fs¸y±_«me
 
«me
;

2393 
îr
;

2395 
îr
 = 
	`fs¸y±_£tup_fûíame
(
dú
, 
öame
, 
lookup
, &
«me
);

2396 i‡(
îr
)

2397  
îr
;

2399 
	`pxt4_‚ame_‰om_fs¸y±_«me
(
‚ame
, &
«me
);

2401 #ifde‡
CONFIG_UNICODE


2402 
	`pxt4_‚ame_£tup_ci_fûíame
(
dú
, 
öame
, &
‚ame
->
cf_«me
);

2405 
	}
}

2407 
ölöe
 
	$pxt4_‚ame_¥ï¨e_lookup
(
öode
 *
dú
,

2408 
díåy
 *dentry,

2409 
pxt4_fûíame
 *
‚ame
)

2411 
fs¸y±_«me
 
«me
;

2412 
îr
;

2414 
îr
 = 
	`fs¸y±_¥ï¨e_lookup
(
dú
, 
díåy
, &
«me
);

2415 i‡(
îr
)

2416  
îr
;

2418 
	`pxt4_‚ame_‰om_fs¸y±_«me
(
‚ame
, &
«me
);

2420 #ifde‡
CONFIG_UNICODE


2421 
	`pxt4_‚ame_£tup_ci_fûíame
(
dú
, &
díåy
->
d_«me
, &
‚ame
->
cf_«me
);

2424 
	}
}

2426 
ölöe
 
	$pxt4_‚ame_‰ì_fûíame
(
pxt4_fûíame
 *
‚ame
)

2428 
fs¸y±_«me
 
«me
;

2430 
«me
.
¸y±o_buf
 = 
‚ame
->crypto_buf;

2431 
	`fs¸y±_‰ì_fûíame
(&
«me
);

2433 
‚ame
->
¸y±o_buf
.
«me
 = 
NULL
;

2434 
‚ame
->
u§_‚ame
 = 
NULL
;

2435 
‚ame
->
disk_«me
.
«me
 = 
NULL
;

2437 #ifde‡
CONFIG_UNICODE


2438 
	`k‰ì
(
‚ame
->
cf_«me
.
«me
);

2439 
‚ame
->
cf_«me
.
«me
 = 
NULL
;

2441 
	}
}

2443 
ölöe
 
	$pxt4_‚ame_£tup_fûíame
(
öode
 *
dú
,

2444 c⁄° 
q°r
 *
öame
,

2445 
lookup
,

2446 
pxt4_fûíame
 *
‚ame
)

2448 
‚ame
->
u§_‚ame
 = 
öame
;

2449 
‚ame
->
disk_«me
.
«me
 = (*Ë
öame
->name;

2450 
‚ame
->
disk_«me
.
Àn
 = 
öame
->len;

2452 #ifde‡
CONFIG_UNICODE


2453 
	`pxt4_‚ame_£tup_ci_fûíame
(
dú
, 
öame
, &
‚ame
->
cf_«me
);

2457 
	}
}

2459 
ölöe
 
	$pxt4_‚ame_¥ï¨e_lookup
(
öode
 *
dú
,

2460 
díåy
 *dentry,

2461 
pxt4_fûíame
 *
‚ame
)

2463  
	`pxt4_‚ame_£tup_fûíame
(
dú
, &
díåy
->
d_«me
, 1, 
‚ame
);

2464 
	}
}

2466 
ölöe
 
	$pxt4_‚ame_‰ì_fûíame
(
pxt4_fûíame
 *
‚ame
)

2468 #ifde‡
CONFIG_UNICODE


2469 
	`k‰ì
(
‚ame
->
cf_«me
.
«me
);

2470 
‚ame
->
cf_«me
.
«me
 = 
NULL
;

2472 
	}
}

2476 
__pxt4_check_dú_íåy
(c⁄° *, , 
öode
 *,

2477 
fûe
 *,

2478 
pxt4_dú_íåy_2
 *,

2479 
buf„r_hód
 *, *, ,

2481 
	#pxt4_check_dú_íåy
(
dú
, 
fûp
, 
de
, 
bh
, 
buf
, 
size
, 
off£t
) \

2482 
	`u∆ikñy
(
	`__pxt4_check_dú_íåy
(
__func__
, 
__LINE__
, (
dú
), (
fûp
), \

2483 (
de
), (
bh
), (
buf
), (
size
), (
off£t
)))

	)

2484 
pxt4_håì_°‹e_dúít
(
fûe
 *
dú_fûe
, 
__u32
 
hash
,

2485 
__u32
 
mö‹_hash
,

2486 
pxt4_dú_íåy_2
 *
dúít
,

2487 
fs¸y±_°r
 *
ít_«me
);

2488 
pxt4_håì_‰ì_dú_öfo
(
dú_¥iv©e_öfo
 *
p
);

2489 
pxt4_föd_de°_de
(
öode
 *
dú
, inode *inode,

2490 
buf„r_hód
 *
bh
,

2491 *
buf
, 
buf_size
,

2492 
pxt4_fûíame
 *
‚ame
,

2493 
pxt4_dú_íåy_2
 **
de°_de
);

2494 
pxt4_ö£π_díåy
(
öode
 *inode,

2495 
pxt4_dú_íåy_2
 *
de
,

2496 
buf_size
,

2497 
pxt4_fûíame
 *
‚ame
);

2498 
ölöe
 
	$pxt4_upd©e_dx_Êag
(
öode
 *inode)

2500 i‡(!
	`pxt4_has_„©uª_dú_ödex
(
öode
->
i_sb
) &&

2501 
	`pxt4_ã°_öode_Êag
(
öode
, 
PXT4_INODE_INDEX
)) {

2503 
	`WARN_ON_ONCE
(
	`pxt4_has_„©uª_mëad©a_csum
(
öode
->
i_sb
));

2504 
	`pxt4_˛ór_öode_Êag
(
öode
, 
PXT4_INODE_INDEX
);

2506 
	}
}

2507 c⁄° 
	gpxt4_fûëy≥_èbÀ
[] = {

2508 
DT_UNKNOWN
, 
DT_REG
, 
DT_DIR
, 
DT_CHR
, 
DT_BLK
, 
DT_FIFO
, 
DT_SOCK
, 
DT_LNK


2511 
ölöe
 
	$gë_dty≥
(
su≥r_block
 *
sb
, 
fûëy≥
)

2513 i‡(!
	`pxt4_has_„©uª_fûëy≥
(
sb
Ë|| 
fûëy≥
 >
PXT4_FT_MAX
)

2514  
DT_UNKNOWN
;

2516  
pxt4_fûëy≥_èbÀ
[
fûëy≥
];

2517 
	}
}

2518 
pxt4_check_Æl_de
(
öode
 *
dú
, 
buf„r_hód
 *
bh
,

2519 *
buf
, 
buf_size
);

2522 
pxt4_sync_fûe
(
fûe
 *, 
loff_t
,Üoff_t, );

2525 
pxt4fs_dúhash
(c⁄° 
öode
 *
dú
, c⁄° *
«me
, 
Àn
,

2526 
dx_hash_öfo
 *
höfo
);

2529 
öode
 *
__pxt4_√w_öode
(
h™dÀ_t
 *, öodê*, 
umode_t
,

2530 c⁄° 
q°r
 *q°r, 
__u32
 
gﬂl
,

2531 
uid_t
 *
ow√r
, 
__u32
 
i_Êags
,

2532 
h™dÀ_ty≥
, 
löe_no
,

2533 
nblocks
);

2535 
	#pxt4_√w_öode
(
h™dÀ
, 
dú
, 
mode
, 
q°r
, 
gﬂl
, 
ow√r
, 
i_Êags
) \

2536 
	`__pxt4_√w_öode
((
h™dÀ
), (
dú
), (
mode
), (
q°r
), (
gﬂl
), (
ow√r
), \

2537 
i_Êags
, 0, 0, 0)

	)

2538 
	#pxt4_√w_öode_°¨t_h™dÀ
(
dú
, 
mode
, 
q°r
, 
gﬂl
, 
ow√r
, \

2539 
ty≥
, 
nblocks
) \

2540 
	`__pxt4_√w_öode
(
NULL
, (
dú
), (
mode
), (
q°r
), (
gﬂl
), (
ow√r
), \

2541 0, (
ty≥
), 
__LINE__
, (
nblocks
))

	)

2544 
pxt4_‰ì_öode
(
h™dÀ_t
 *, 
öode
 *);

2545 
öode
 * 
pxt4_‹ph™_gë
(
su≥r_block
 *, );

2546 
pxt4_cou¡_‰ì_öodes
(
su≥r_block
 *);

2547 
pxt4_cou¡_dús
(
su≥r_block
 *);

2548 
pxt4_check_öodes_bôm≠
(
su≥r_block
 *);

2549 
pxt4_m¨k_bôm≠_íd
(
°¨t_bô
, 
íd_bô
, *
bôm≠
);

2550 
pxt4_öô_öode_èbÀ
(
su≥r_block
 *
sb
,

2551 
pxt4_group_t
 
group
, 
b¨rõr
);

2552 
pxt4_íd_bôm≠_ªad
(
buf„r_hód
 *
bh
, 
u±od©e
);

2555 c⁄° 
£q_›î©i⁄s
 
pxt4_mb_£q_groups_›s
;

2556 
pxt4_mb_°©s
;

2557 
pxt4_mb_max_to_sˇn
;

2558 
pxt4_mb_öô
(
su≥r_block
 *);

2559 
pxt4_mb_ªÀa£
(
su≥r_block
 *);

2560 
pxt4_fsblk_t
 
pxt4_mb_√w_blocks
(
h™dÀ_t
 *,

2561 
pxt4_Æloˇti⁄_ªque°
 *, *);

2562 
pxt4_mb_ª£rve_blocks
(
su≥r_block
 *, );

2563 
pxt4_disˇrd_¥óŒoˇti⁄s
(
öode
 *);

2564 
__öô
 
pxt4_öô_mbÆloc
();

2565 
pxt4_exô_mbÆloc
();

2566 
pxt4_‰ì_blocks
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *inode,

2567 
buf„r_hód
 *
bh
, 
pxt4_fsblk_t
 
block
,

2568 
cou¡
, 
Êags
);

2569 
pxt4_mb_Æloc_groupöfo
(
su≥r_block
 *
sb
,

2570 
pxt4_group_t
 
ngroups
);

2571 
pxt4_mb_add_groupöfo
(
su≥r_block
 *
sb
,

2572 
pxt4_group_t
 
i
, 
pxt4_group_desc
 *
desc
);

2573 
pxt4_group_add_blocks
(
h™dÀ_t
 *
h™dÀ
, 
su≥r_block
 *
sb
,

2574 
pxt4_fsblk_t
 
block
, 
cou¡
);

2575 
pxt4_åim_fs
(
su≥r_block
 *, 
f°rim_ønge
 *);

2576 
pxt4_¥o˚ss_‰ìd_d©a
(
su≥r_block
 *
sb
, 
tid_t
 
commô_tid
);

2579 
pxt4_öode_is_Á°_symlök
(
öode
 *inode);

2580 
buf„r_hód
 *
pxt4_gëblk
(
h™dÀ_t
 *, 
öode
 *, 
pxt4_lblk_t
, );

2581 
buf„r_hód
 *
pxt4_bªad
(
h™dÀ_t
 *, 
öode
 *, 
pxt4_lblk_t
, );

2582 
pxt4_bªad_b©ch
(
öode
 *öode, 
pxt4_lblk_t
 
block
, 
bh_cou¡
,

2583 
boﬁ
 
waô
, 
buf„r_hód
 **
bhs
);

2584 
pxt4_gë_block_unwrôãn
(
öode
 *öode, 
£˘‹_t
 
iblock
,

2585 
buf„r_hód
 *
bh_ªsu…
, 
¸óã
);

2586 
pxt4_gë_block
(
öode
 *öode, 
£˘‹_t
 
iblock
,

2587 
buf„r_hód
 *
bh_ªsu…
, 
¸óã
);

2588 
pxt4_dio_gë_block
(
öode
 *öode, 
£˘‹_t
 
iblock
,

2589 
buf„r_hód
 *
bh_ªsu…
, 
¸óã
);

2590 
pxt4_da_gë_block_¥ï
(
öode
 *öode, 
£˘‹_t
 
iblock
,

2591 
buf„r_hód
 *
bh
, 
¸óã
);

2592 
pxt4_wÆk_∑ge_buf„rs
(
h™dÀ_t
 *
h™dÀ
,

2593 
buf„r_hód
 *
hód
,

2594 
‰om
,

2595 
to
,

2596 *
∑πül
,

2597 (*
‚
)(
h™dÀ_t
 *
h™dÀ
,

2598 
buf„r_hód
 *
bh
));

2599 
	`do_jou∫Æ_gë_wrôe_ac˚ss
(
h™dÀ_t
 *
h™dÀ
,

2600 
buf„r_hód
 *
bh
);

2601 
	#FALL_BACK_TO_NONDELALLOC
 1

	)

2602 
	#CONVERT_INLINE_DATA
 2

	)

2605 
PXT4_IGET_NORMAL
 = 0,

2606 
PXT4_IGET_SPECIAL
 = 0x0001,

2607 
PXT4_IGET_HANDLE
 = 0x0002

2608 } 
	tpxt4_igë_Êags
;

2610 
öode
 *
	`__pxt4_igë
(
su≥r_block
 *
sb
, 
öo
,

2611 
pxt4_igë_Êags
 
Êags
, c⁄° *
fun˘i⁄
,

2612 
löe
);

2614 
	#pxt4_igë
(
sb
, 
öo
, 
Êags
) \

2615 
	`__pxt4_igë
((
sb
), (
öo
), (
Êags
), 
__func__
, 
__LINE__
)

	)

2617 
	`pxt4_wrôe_öode
(
öode
 *, 
wrôeback_c⁄åﬁ
 *);

2618 
	`pxt4_£èâr
(
díåy
 *, 
üâr
 *);

2619 
	`pxt4_gë©å
(c⁄° 
∑th
 *, 
k°©
 *, 
u32
, );

2620 
	`pxt4_evi˘_öode
(
öode
 *);

2621 
	`pxt4_˛ór_öode
(
öode
 *);

2622 
	`pxt4_fûe_gë©å
(c⁄° 
∑th
 *, 
k°©
 *, 
u32
, );

2623 
	`pxt4_sync_öode
(
h™dÀ_t
 *, 
öode
 *);

2624 
	`pxt4_dúty_öode
(
öode
 *, );

2625 
	`pxt4_ch™ge_öode_jou∫Æ_Êag
(
öode
 *, );

2626 
	`pxt4_gë_öode_loc
(
öode
 *, 
pxt4_ûoc
 *);

2627 
	`pxt4_öode_©èch_jöode
(
öode
 *inode);

2628 
	`pxt4_ˇn_åunˇã
(
öode
 *inode);

2629 
	`pxt4_åunˇã
(
öode
 *);

2630 
	`pxt4_bªak_œyouts
(
öode
 *);

2631 
	`pxt4_punch_hﬁe
(
öode
 *öode, 
loff_t
 
off£t
,Üoff_à
Àngth
);

2632 
	`pxt4_åunˇã_ª°¨t_å™s
(
h™dÀ_t
 *, 
öode
 *, 
nblocks
);

2633 
	`pxt4_£t_öode_Êags
(
öode
 *);

2634 
	`pxt4_Æloc_da_blocks
(
öode
 *inode);

2635 
	`pxt4_£t_a›s
(
öode
 *inode);

2636 
	`pxt4_wrôïage_å™s_blocks
(
öode
 *);

2637 
	`pxt4_chunk_å™s_blocks
(
öode
 *, 
ƒblocks
);

2638 
	`pxt4_zîo_∑πül_blocks
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *inode,

2639 
loff_t
 
l°¨t
,Üoff_à
Ànd
);

2640 
vm_Áu…_t
 
	`pxt4_∑ge_mkwrôe
(
vm_Áu…
 *
vmf
);

2641 
vm_Áu…_t
 
	`pxt4_fûem≠_Áu…
(
vm_Áu…
 *
vmf
);

2642 
qsize_t
 *
	`pxt4_gë_ª£rved_•a˚
(
öode
 *inode);

2643 
	`pxt4_gë_¥ojid
(
öode
 *öode, 
k¥ojid_t
 *
¥ojid
);

2644 
	`pxt4_da_ªÀa£_•a˚
(
öode
 *öode, 
to_‰ì
);

2645 
	`pxt4_da_upd©e_ª£rve_•a˚
(
öode
 *inode,

2646 
u£d
, 
quŸa_˛aim
);

2647 
	`pxt4_issue_zîoout
(
öode
 *öode, 
pxt4_lblk_t
 
lblk
,

2648 
pxt4_fsblk_t
 
pblk
, 
pxt4_lblk_t
 
Àn
);

2651 
	`pxt4_öd_m≠_blocks
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *inode,

2652 
pxt4_m≠_blocks
 *
m≠
, 
Êags
);

2653 
	`pxt4_öd_ˇlc_mëad©a_amou¡
(
öode
 *öode, 
£˘‹_t
 
lblock
);

2654 
	`pxt4_öd_å™s_blocks
(
öode
 *öode, 
ƒblocks
);

2655 
	`pxt4_öd_åunˇã
(
h™dÀ_t
 *, 
öode
 *inode);

2656 
	`pxt4_öd_ªmove_•a˚
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *inode,

2657 
pxt4_lblk_t
 
°¨t
,Öxt4_lblk_à
íd
);

2660 
	`pxt4_io˘l
(
fûe
 *, , );

2661 
	`pxt4_com∑t_io˘l
(
fûe
 *, , );

2664 
	`pxt4_ext_migøã
(
öode
 *);

2665 
	`pxt4_öd_migøã
(
öode
 *inode);

2668 
	`pxt4_dúblock_csum_vîify
(
öode
 *inode,

2669 
buf„r_hód
 *
bh
);

2670 
	`pxt4_‹ph™_add
(
h™dÀ_t
 *, 
öode
 *);

2671 
	`pxt4_‹ph™_dñ
(
h™dÀ_t
 *, 
öode
 *);

2672 
	`pxt4_håì_fûl_åì
(
fûe
 *
dú_fûe
, 
__u32
 
°¨t_hash
,

2673 
__u32
 
°¨t_mö‹_hash
, __u32 *
√xt_hash
);

2674 
	`pxt4_£¨ch_dú
(
buf„r_hód
 *
bh
,

2675 *
£¨ch_buf
,

2676 
buf_size
,

2677 
öode
 *
dú
,

2678 
pxt4_fûíame
 *
‚ame
,

2679 
off£t
,

2680 
pxt4_dú_íåy_2
 **
ªs_dú
);

2681 
	`pxt4_gíîic_dñëe_íåy
(
h™dÀ_t
 *
h™dÀ
,

2682 
öode
 *
dú
,

2683 
pxt4_dú_íåy_2
 *
de_dñ
,

2684 
buf„r_hód
 *
bh
,

2685 *
íåy_buf
,

2686 
buf_size
,

2687 
csum_size
);

2688 
boﬁ
 
	`pxt4_em±y_dú
(
öode
 *inode);

2691 
	`pxt4_kv‰ì_¨øy_rcu
(*
to_‰ì
);

2692 
	`pxt4_group_add
(
su≥r_block
 *
sb
,

2693 
pxt4_√w_group_d©a
 *
öput
);

2694 
	`pxt4_group_exãnd
(
su≥r_block
 *
sb
,

2695 
pxt4_su≥r_block
 *
es
,

2696 
pxt4_fsblk_t
 
n_blocks_cou¡
);

2697 
	`pxt4_ªsize_fs
(
su≥r_block
 *
sb
, 
pxt4_fsblk_t
 
n_blocks_cou¡
);

2700 
buf„r_hód
 *
	`pxt4_sb_bªad
(
su≥r_block
 *
sb
,

2701 
£˘‹_t
 
block
, 
›_Êags
);

2702 
	`pxt4_£q_›ti⁄s_show
(
£q_fûe
 *
£q
, *
off£t
);

2703 
	`pxt4_ˇlcuœã_ovîhód
(
su≥r_block
 *
sb
);

2704 
	`pxt4_su≥rblock_csum_£t
(
su≥r_block
 *
sb
);

2705 *
	`pxt4_kvmÆloc
(
size_t
 
size
, 
gÂ_t
 
Êags
);

2706 *
	`pxt4_kvzÆloc
(
size_t
 
size
, 
gÂ_t
 
Êags
);

2707 
	`pxt4_Æloc_Êex_bg_¨øy
(
su≥r_block
 *
sb
,

2708 
pxt4_group_t
 
ngroup
);

2709 c⁄° *
	`pxt4_decode_îr‹
(
su≥r_block
 *
sb
, 
î∫o
,

2710 
nbuf
[16]);

2711 
	`pxt4_m¨k_group_bôm≠_c‹ru±ed
(
su≥r_block
 *
sb
,

2712 
pxt4_group_t
 
block_group
,

2713 
Êags
);

2715 
	$__¥ötf
(4, 5)

2716 
	`__pxt4_îr‹
(
su≥r_block
 *, const *, ,

2718 
	$__¥ötf
(5, 6)

2719 
	`__pxt4_îr‹_öode
(
öode
 *, c⁄° *, , 
pxt4_fsblk_t
,

2721 
	$__¥ötf
(5, 6)

2722 
	`__pxt4_îr‹_fûe
(
fûe
 *, c⁄° *, , 
pxt4_fsblk_t
,

2724 
	`__pxt4_°d_îr‹
(
su≥r_block
 *, const *,

2726 
	$__¥ötf
(4, 5)

2727 
	`__pxt4_ab‹t
(
su≥r_block
 *, const *, ,

2729 
	$__¥ötf
(4, 5)

2730 
	`__pxt4_w¨nög
(
su≥r_block
 *, const *, ,

2732 
	$__¥ötf
(4, 5)

2733 
	`__pxt4_w¨nög_öode
(c⁄° 
öode
 *öode, c⁄° *
fun˘i⁄
,

2734 
löe
, c⁄° *
fmt
, ...);

2735 
	$__¥ötf
(3, 4)

2736 
	`__pxt4_msg
(
su≥r_block
 *, const *, const *, ...);

2737 
	`__dump_mmp_msg
(
su≥r_block
 *, 
mmp_°ru˘
 *
mmp
,

2739 
	$__¥ötf
(7, 8)

2740 
	`__pxt4_gΩ_locked_îr‹
(const *, ,

2741 
su≥r_block
 *, 
pxt4_group_t
,

2742 , 
pxt4_fsblk_t
,

2745 
	#PXT4_ERROR_INODE
(
öode
, 
fmt
, 
a
...) \

2746 
	`pxt4_îr‹_öode
((
öode
), 
__func__
, 
__LINE__
, 0, (
fmt
), ## 
a
)

	)

2748 
	#PXT4_ERROR_INODE_BLOCK
(
öode
, 
block
, 
fmt
, 
a
...) \

2749 
	`pxt4_îr‹_öode
((
öode
), 
__func__
, 
__LINE__
, (
block
), (
fmt
), ## 
a
)

	)

2751 
	#PXT4_ERROR_FILE
(
fûe
, 
block
, 
fmt
, 
a
...) \

2752 
	`pxt4_îr‹_fûe
((
fûe
), 
__func__
, 
__LINE__
, (
block
), (
fmt
), ## 
a
)

	)

2754 #ifde‡
CONFIG_PRINTK


2756 
	#pxt4_îr‹_öode
(
öode
, 
func
, 
löe
, 
block
, 
fmt
, ...) \

2757 
	`__pxt4_îr‹_öode
(
öode
, 
func
, 
löe
, 
block
, 
fmt
, ##
__VA_ARGS__
)

	)

2758 
	#pxt4_îr‹_fûe
(
fûe
, 
func
, 
löe
, 
block
, 
fmt
, ...) \

2759 
	`__pxt4_îr‹_fûe
(
fûe
, 
func
, 
löe
, 
block
, 
fmt
, ##
__VA_ARGS__
)

	)

2760 
	#pxt4_îr‹
(
sb
, 
fmt
, ...) \

2761 
	`__pxt4_îr‹
(
sb
, 
__func__
, 
__LINE__
, 
fmt
, ##
__VA_ARGS__
)

	)

2762 
	#pxt4_ab‹t
(
sb
, 
fmt
, ...) \

2763 
	`__pxt4_ab‹t
(
sb
, 
__func__
, 
__LINE__
, 
fmt
, ##
__VA_ARGS__
)

	)

2764 
	#pxt4_w¨nög
(
sb
, 
fmt
, ...) \

2765 
	`__pxt4_w¨nög
(
sb
, 
__func__
, 
__LINE__
, 
fmt
, ##
__VA_ARGS__
)

	)

2766 
	#pxt4_w¨nög_öode
(
öode
, 
fmt
, ...) \

2767 
	`__pxt4_w¨nög_öode
(
öode
, 
__func__
, 
__LINE__
, 
fmt
, ##
__VA_ARGS__
)

	)

2768 
	#pxt4_msg
(
sb
, 
Àvñ
, 
fmt
, ...) \

2769 
	`__pxt4_msg
(
sb
, 
Àvñ
, 
fmt
, ##
__VA_ARGS__
)

	)

2770 
	#dump_mmp_msg
(
sb
, 
mmp
, 
msg
) \

2771 
	`__dump_mmp_msg
(
sb
, 
mmp
, 
__func__
, 
__LINE__
, 
msg
)

	)

2772 
	#pxt4_gΩ_locked_îr‹
(
sb
, 
gΩ
, 
öo
, 
block
, 
fmt
, ...) \

2773 
	`__pxt4_gΩ_locked_îr‹
(
__func__
, 
__LINE__
, 
sb
, 
gΩ
, 
öo
, 
block
, \

2774 
fmt
, ##
__VA_ARGS__
)

	)

2778 
	#pxt4_îr‹_öode
(
öode
, 
func
, 
löe
, 
block
, 
fmt
, ...) \

2780 
	`no_¥ötk
(
fmt
, ##
__VA_ARGS__
); \

2781 
	`__pxt4_îr‹_öode
(
öode
, "", 0, 
block
, " "); \

2782 
	}
} 0)

	)

2783 
	#pxt4_îr‹_fûe
(
fûe
, 
func
, 
löe
, 
block
, 
fmt
, ...) \

2785 
	`no_¥ötk
(
fmt
, ##
__VA_ARGS__
); \

2786 
	`__pxt4_îr‹_fûe
(
fûe
, "", 0, 
block
, " "); \

2787 } 0)

	)

2788 
	#pxt4_îr‹
(
sb
, 
fmt
, ...) \

2790 
	`no_¥ötk
(
fmt
, ##
__VA_ARGS__
); \

2791 
	`__pxt4_îr‹
(
sb
, "", 0, " "); \

2792 } 0)

	)

2793 
	#pxt4_ab‹t
(
sb
, 
fmt
, ...) \

2795 
	`no_¥ötk
(
fmt
, ##
__VA_ARGS__
); \

2796 
	`__pxt4_ab‹t
(
sb
, "", 0, " "); \

2797 } 0)

	)

2798 
	#pxt4_w¨nög
(
sb
, 
fmt
, ...) \

2800 
	`no_¥ötk
(
fmt
, ##
__VA_ARGS__
); \

2801 
	`__pxt4_w¨nög
(
sb
, "", 0, " "); \

2802 } 0)

	)

2803 
	#pxt4_w¨nög_öode
(
öode
, 
fmt
, ...) \

2805 
	`no_¥ötk
(
fmt
, ##
__VA_ARGS__
); \

2806 
	`__pxt4_w¨nög_öode
(
öode
, "", 0, " "); \

2807 } 0)

	)

2808 
	#pxt4_msg
(
sb
, 
Àvñ
, 
fmt
, ...) \

2810 
	`no_¥ötk
(
fmt
, ##
__VA_ARGS__
); \

2811 
	`__pxt4_msg
(
sb
, "", " "); \

2812 } 0)

	)

2813 
	#dump_mmp_msg
(
sb
, 
mmp
, 
msg
) \

2814 
	`__dump_mmp_msg
(
sb
, 
mmp
, "", 0, "")

	)

2815 
	#pxt4_gΩ_locked_îr‹
(
sb
, 
gΩ
, 
öo
, 
block
, 
fmt
, ...) \

2817 
	`no_¥ötk
(
fmt
, ##
__VA_ARGS__
); \

2818 
	`__pxt4_gΩ_locked_îr‹
("", 0, 
sb
, 
gΩ
, 
öo
, 
block
, " "); \

2819 } 0)

	)

2823 
pxt4_upd©e_com∑t_„©uª
(
h™dÀ_t
 *
h™dÀ
, 
su≥r_block
 *
sb
,

2824 
__u32
 
com∑t
);

2825 
pxt4_upd©e_rocom∑t_„©uª
(
h™dÀ_t
 *
h™dÀ
,

2826 
su≥r_block
 *
sb
, 
__u32
 
rocom∑t
);

2827 
pxt4_upd©e_öcom∑t_„©uª
(
h™dÀ_t
 *
h™dÀ
,

2828 
su≥r_block
 *
sb
, 
__u32
 
öcom∑t
);

2829 
pxt4_fsblk_t
 
pxt4_block_bôm≠
(
su≥r_block
 *
sb
,

2830 
pxt4_group_desc
 *
bg
);

2831 
pxt4_fsblk_t
 
pxt4_öode_bôm≠
(
su≥r_block
 *
sb
,

2832 
pxt4_group_desc
 *
bg
);

2833 
pxt4_fsblk_t
 
pxt4_öode_èbÀ
(
su≥r_block
 *
sb
,

2834 
pxt4_group_desc
 *
bg
);

2835 
__u32
 
pxt4_‰ì_group_˛u°îs
(
su≥r_block
 *
sb
,

2836 
pxt4_group_desc
 *
bg
);

2837 
__u32
 
pxt4_‰ì_öodes_cou¡
(
su≥r_block
 *
sb
,

2838 
pxt4_group_desc
 *
bg
);

2839 
__u32
 
pxt4_u£d_dús_cou¡
(
su≥r_block
 *
sb
,

2840 
pxt4_group_desc
 *
bg
);

2841 
__u32
 
pxt4_ôabÀ_unu£d_cou¡
(
su≥r_block
 *
sb
,

2842 
pxt4_group_desc
 *
bg
);

2843 
pxt4_block_bôm≠_£t
(
su≥r_block
 *
sb
,

2844 
pxt4_group_desc
 *
bg
, 
pxt4_fsblk_t
 
blk
);

2845 
pxt4_öode_bôm≠_£t
(
su≥r_block
 *
sb
,

2846 
pxt4_group_desc
 *
bg
, 
pxt4_fsblk_t
 
blk
);

2847 
pxt4_öode_èbÀ_£t
(
su≥r_block
 *
sb
,

2848 
pxt4_group_desc
 *
bg
, 
pxt4_fsblk_t
 
blk
);

2849 
pxt4_‰ì_group_˛u°îs_£t
(
su≥r_block
 *
sb
,

2850 
pxt4_group_desc
 *
bg
,

2851 
__u32
 
cou¡
);

2852 
pxt4_‰ì_öodes_£t
(
su≥r_block
 *
sb
,

2853 
pxt4_group_desc
 *
bg
, 
__u32
 
cou¡
);

2854 
pxt4_u£d_dús_£t
(
su≥r_block
 *
sb
,

2855 
pxt4_group_desc
 *
bg
, 
__u32
 
cou¡
);

2856 
pxt4_ôabÀ_unu£d_£t
(
su≥r_block
 *
sb
,

2857 
pxt4_group_desc
 *
bg
, 
__u32
 
cou¡
);

2858 
pxt4_group_desc_csum_vîify
(
su≥r_block
 *
sb
, 
__u32
 
group
,

2859 
pxt4_group_desc
 *
gdp
);

2860 
pxt4_group_desc_csum_£t
(
su≥r_block
 *
sb
, 
__u32
 
group
,

2861 
pxt4_group_desc
 *
gdp
);

2862 
pxt4_ªgi°î_li_ªque°
(
su≥r_block
 *
sb
,

2863 
pxt4_group_t
 
fú°_nŸ_zî€d
);

2865 
ölöe
 
	$pxt4_has_mëad©a_csum
(
su≥r_block
 *
sb
)

2867 
	`WARN_ON_ONCE
(
	`pxt4_has_„©uª_mëad©a_csum
(
sb
) &&

2868 !
	`PXT4_SB
(
sb
)->
s_chksum_drivî
);

2870  
	`pxt4_has_„©uª_mëad©a_csum
(
sb
) &&

2871 (
	`PXT4_SB
(
sb
)->
s_chksum_drivî
 !
NULL
);

2872 
	}
}

2874 
ölöe
 
	$pxt4_has_group_desc_csum
(
su≥r_block
 *
sb
)

2876  
	`pxt4_has_„©uª_gdt_csum
(
sb
Ë|| 
	`pxt4_has_mëad©a_csum
(sb);

2877 
	}
}

2879 
ölöe
 
pxt4_fsblk_t
 
	$pxt4_blocks_cou¡
(
pxt4_su≥r_block
 *
es
)

2881  ((
pxt4_fsblk_t
)
	`À32_to_˝u
(
es
->
s_blocks_cou¡_hi
) << 32) |

2882 
	`À32_to_˝u
(
es
->
s_blocks_cou¡_lo
);

2883 
	}
}

2885 
ölöe
 
pxt4_fsblk_t
 
	$pxt4_r_blocks_cou¡
(
pxt4_su≥r_block
 *
es
)

2887  ((
pxt4_fsblk_t
)
	`À32_to_˝u
(
es
->
s_r_blocks_cou¡_hi
) << 32) |

2888 
	`À32_to_˝u
(
es
->
s_r_blocks_cou¡_lo
);

2889 
	}
}

2891 
ölöe
 
pxt4_fsblk_t
 
	$pxt4_‰ì_blocks_cou¡
(
pxt4_su≥r_block
 *
es
)

2893  ((
pxt4_fsblk_t
)
	`À32_to_˝u
(
es
->
s_‰ì_blocks_cou¡_hi
) << 32) |

2894 
	`À32_to_˝u
(
es
->
s_‰ì_blocks_cou¡_lo
);

2895 
	}
}

2897 
ölöe
 
	$pxt4_blocks_cou¡_£t
(
pxt4_su≥r_block
 *
es
,

2898 
pxt4_fsblk_t
 
blk
)

2900 
es
->
s_blocks_cou¡_lo
 = 
	`˝u_to_À32
((
u32
)
blk
);

2901 
es
->
s_blocks_cou¡_hi
 = 
	`˝u_to_À32
(
blk
 >> 32);

2902 
	}
}

2904 
ölöe
 
	$pxt4_‰ì_blocks_cou¡_£t
(
pxt4_su≥r_block
 *
es
,

2905 
pxt4_fsblk_t
 
blk
)

2907 
es
->
s_‰ì_blocks_cou¡_lo
 = 
	`˝u_to_À32
((
u32
)
blk
);

2908 
es
->
s_‰ì_blocks_cou¡_hi
 = 
	`˝u_to_À32
(
blk
 >> 32);

2909 
	}
}

2911 
ölöe
 
	$pxt4_r_blocks_cou¡_£t
(
pxt4_su≥r_block
 *
es
,

2912 
pxt4_fsblk_t
 
blk
)

2914 
es
->
s_r_blocks_cou¡_lo
 = 
	`˝u_to_À32
((
u32
)
blk
);

2915 
es
->
s_r_blocks_cou¡_hi
 = 
	`˝u_to_À32
(
blk
 >> 32);

2916 
	}
}

2918 
ölöe
 
loff_t
 
	$pxt4_isize
(
su≥r_block
 *
sb
,

2919 
pxt4_öode
 *
øw_öode
)

2921 i‡(
	`pxt4_has_„©uª_œrgedú
(
sb
) ||

2922 
	`S_ISREG
(
	`À16_to_˝u
(
øw_öode
->
i_mode
)))

2923  ((
loff_t
)
	`À32_to_˝u
(
øw_öode
->
i_size_high
) << 32) |

2924 
	`À32_to_˝u
(
øw_öode
->
i_size_lo
);

2926  (
loff_t
Ë
	`À32_to_˝u
(
øw_öode
->
i_size_lo
);

2927 
	}
}

2929 
ölöe
 
	$pxt4_isize_£t
(
pxt4_öode
 *
øw_öode
, 
loff_t
 
i_size
)

2931 
øw_öode
->
i_size_lo
 = 
	`˝u_to_À32
(
i_size
);

2932 
øw_öode
->
i_size_high
 = 
	`˝u_to_À32
(
i_size
 >> 32);

2933 
	}
}

2935 
ölöe


2936 
pxt4_group_öfo
 *
	$pxt4_gë_group_öfo
(
su≥r_block
 *
sb
,

2937 
pxt4_group_t
 
group
)

2939 
pxt4_group_öfo
 **
gΩ_öfo
;

2940 
ödexv
, 
ödexh
;

2941 
	`BUG_ON
(
group
 >
	`PXT4_SB
(
sb
)->
s_groups_cou¡
);

2942 
ödexv
 = 
group
 >> (
	`PXT4_DESC_PER_BLOCK_BITS
(
sb
));

2943 
ödexh
 = 
group
 & ((
	`PXT4_DESC_PER_BLOCK
(
sb
)) - 1);

2944 
gΩ_öfo
 = 
	`sbi_¨øy_rcu_dîef
(
	`PXT4_SB
(
sb
), 
s_group_öfo
, 
ödexv
);

2945  
gΩ_öfo
[
ödexh
];

2946 
	}
}

2953 
ölöe
 
pxt4_group_t
 
	$pxt4_gë_groups_cou¡
(
su≥r_block
 *
sb
)

2955 
pxt4_group_t
 
ngroups
 = 
	`PXT4_SB
(
sb
)->
s_groups_cou¡
;

2957 
	`smp_rmb
();

2958  
ngroups
;

2959 
	}
}

2961 
ölöe
 
pxt4_group_t
 
	$pxt4_Êex_group
(
pxt4_sb_öfo
 *
sbi
,

2962 
pxt4_group_t
 
block_group
)

2964  
block_group
 >> 
sbi
->
s_log_groups_≥r_Êex
;

2965 
	}
}

2967 
ölöe
 
	$pxt4_Êex_bg_size
(
pxt4_sb_öfo
 *
sbi
)

2969  1 << 
sbi
->
s_log_groups_≥r_Êex
;

2970 
	}
}

2972 
	#pxt4_°d_îr‹
(
sb
, 
î∫o
) \

2974 i‡((
î∫o
)) \

2975 
	`__pxt4_°d_îr‹
((
sb
), 
__func__
, 
__LINE__
, (
î∫o
)); \

2976 } 0)

	)

2978 #ifde‡
CONFIG_SMP


2983 
	#PXT4_FREECLUSTERS_WATERMARK
 (4 * (
≥r˝u_cou¡î_b©ch
 * 
ƒ_˝u_ids
))

	)

2985 
	#PXT4_FREECLUSTERS_WATERMARK
 0

	)

2989 
ölöe
 
	$pxt4_upd©e_i_disksize
(
öode
 *öode, 
loff_t
 
√wsize
)

2991 
	`WARN_ON_ONCE
(
	`S_ISREG
(
öode
->
i_mode
) &&

2992 !
	`öode_is_locked
(
öode
));

2993 
	`down_wrôe
(&
	`PXT4_I
(
öode
)->
i_d©a_£m
);

2994 i‡(
√wsize
 > 
	`PXT4_I
(
öode
)->
i_disksize
)

2995 
	`WRITE_ONCE
(
	`PXT4_I
(
öode
)->
i_disksize
, 
√wsize
);

2996 
	`up_wrôe
(&
	`PXT4_I
(
öode
)->
i_d©a_£m
);

2997 
	}
}

3000 
ölöe
 
	$pxt4_upd©e_öode_size
(
öode
 *öode, 
loff_t
 
√wsize
)

3002 
ch™ged
 = 0;

3004 i‡(
√wsize
 > 
öode
->
i_size
) {

3005 
	`i_size_wrôe
(
öode
, 
√wsize
);

3006 
ch™ged
 = 1;

3008 i‡(
√wsize
 > 
	`PXT4_I
(
öode
)->
i_disksize
) {

3009 
	`pxt4_upd©e_i_disksize
(
öode
, 
√wsize
);

3010 
ch™ged
 |= 2;

3012  
ch™ged
;

3013 
	}
}

3015 
pxt4_upd©e_disksize_bef‹e_punch
(
öode
 *öode, 
loff_t
 
off£t
,

3016 
loff_t
 
Àn
);

3018 
	spxt4_group_öfo
 {

3019 
	mbb_°©e
;

3020 
rb_roŸ
 
	mbb_‰ì_roŸ
;

3021 
pxt4_gΩblk_t
 
	mbb_fú°_‰ì
;

3022 
pxt4_gΩblk_t
 
	mbb_‰ì
;

3023 
pxt4_gΩblk_t
 
	mbb_‰agmíts
;

3024 
pxt4_gΩblk_t
 
	mbb_œrge°_‰ì_‹dî
;

3025 
li°_hód
 
	mbb_¥óŒoc_li°
;

3026 #ifde‡
DOUBLE_CHECK


3027 *
	mbb_bôm≠
;

3029 
rw_£m≠h‹e
 
	mÆloc_£m
;

3030 
pxt4_gΩblk_t
 
	mbb_cou¡îs
[];

3036 
	#PXT4_GROUP_INFO_NEED_INIT_BIT
 0

	)

3037 
	#PXT4_GROUP_INFO_WAS_TRIMMED_BIT
 1

	)

3038 
	#PXT4_GROUP_INFO_BBITMAP_CORRUPT_BIT
 2

	)

3039 
	#PXT4_GROUP_INFO_IBITMAP_CORRUPT_BIT
 3

	)

3040 
	#PXT4_GROUP_INFO_BBITMAP_CORRUPT
 \

3041 (1 << 
PXT4_GROUP_INFO_BBITMAP_CORRUPT_BIT
)

	)

3042 
	#PXT4_GROUP_INFO_IBITMAP_CORRUPT
 \

3043 (1 << 
PXT4_GROUP_INFO_IBITMAP_CORRUPT_BIT
)

	)

3045 
	#PXT4_MB_GRP_NEED_INIT
(
gΩ
) \

3046 (
	`ã°_bô
(
PXT4_GROUP_INFO_NEED_INIT_BIT
, &((
gΩ
)->
bb_°©e
)))

	)

3047 
	#PXT4_MB_GRP_BBITMAP_CORRUPT
(
gΩ
) \

3048 (
	`ã°_bô
(
PXT4_GROUP_INFO_BBITMAP_CORRUPT_BIT
, &((
gΩ
)->
bb_°©e
)))

	)

3049 
	#PXT4_MB_GRP_IBITMAP_CORRUPT
(
gΩ
) \

3050 (
	`ã°_bô
(
PXT4_GROUP_INFO_IBITMAP_CORRUPT_BIT
, &((
gΩ
)->
bb_°©e
)))

	)

3052 
	#PXT4_MB_GRP_WAS_TRIMMED
(
gΩ
) \

3053 (
	`ã°_bô
(
PXT4_GROUP_INFO_WAS_TRIMMED_BIT
, &((
gΩ
)->
bb_°©e
)))

	)

3054 
	#PXT4_MB_GRP_SET_TRIMMED
(
gΩ
) \

3055 (
	`£t_bô
(
PXT4_GROUP_INFO_WAS_TRIMMED_BIT
, &((
gΩ
)->
bb_°©e
)))

	)

3056 
	#PXT4_MB_GRP_CLEAR_TRIMMED
(
gΩ
) \

3057 (
	`˛ór_bô
(
PXT4_GROUP_INFO_WAS_TRIMMED_BIT
, &((
gΩ
)->
bb_°©e
)))

	)

3059 
	#PXT4_MAX_CONTENTION
 8

	)

3060 
	#PXT4_CONTENTION_THRESHOLD
 2

	)

3062 
ölöe
 
•ölock_t
 *
	$pxt4_group_lock_±r
(
su≥r_block
 *
sb
,

3063 
pxt4_group_t
 
group
)

3065  
	`bgl_lock_±r
(
	`PXT4_SB
(
sb
)->
s_blockgroup_lock
, 
group
);

3066 
	}
}

3072 
ölöe
 
	$pxt4_fs_is_busy
(
pxt4_sb_öfo
 *
sbi
)

3074  (
	`©omic_ªad
(&
sbi
->
s_lock_busy
Ë> 
PXT4_CONTENTION_THRESHOLD
);

3075 
	}
}

3077 
ölöe
 
	$pxt4_lock_group
(
su≥r_block
 *
sb
, 
pxt4_group_t
 
group
)

3079 
•ölock_t
 *
lock
 = 
	`pxt4_group_lock_±r
(
sb
, 
group
);

3080 i‡(
	`•ö_åylock
(
lock
))

3085 
	`©omic_add_u∆ess
(&
	`PXT4_SB
(
sb
)->
s_lock_busy
, -1, 0);

3091 
	`©omic_add_u∆ess
(&
	`PXT4_SB
(
sb
)->
s_lock_busy
, 1,

3092 
PXT4_MAX_CONTENTION
);

3093 
	`•ö_lock
(
lock
);

3095 
	}
}

3097 
ölöe
 
	$pxt4_u∆ock_group
(
su≥r_block
 *
sb
,

3098 
pxt4_group_t
 
group
)

3100 
	`•ö_u∆ock
(
	`pxt4_group_lock_±r
(
sb
, 
group
));

3101 
	}
}

3106 
	#pxt4_check_ödúe˘_blockªf
(
öode
, 
bh
) \

3107 
	`pxt4_check_blockªf
(
__func__
, 
__LINE__
, 
öode
, \

3108 (
__À32
 *)(
bh
)->
b_d©a
, \

3109 
	`PXT4_ADDR_PER_BLOCK
((
öode
)->
i_sb
))

	)

3111 
	#pxt4_öd_check_öode
(
öode
) \

3112 
	`pxt4_check_blockªf
(
__func__
, 
__LINE__
, 
öode
, \

3113 
	`PXT4_I
(
öode
)->
i_d©a
, \

3114 
PXT4_NDIR_BLOCKS
)

	)

3121 c⁄° 
fûe_›î©i⁄s
 
pxt4_dú_›î©i⁄s
;

3123 #ifde‡
CONFIG_UNICODE


3124 c⁄° 
díåy_›î©i⁄s
 
pxt4_díåy_›s
;

3128 c⁄° 
öode_›î©i⁄s
 
pxt4_fûe_öode_›î©i⁄s
;

3129 c⁄° 
fûe_›î©i⁄s
 
pxt4_fûe_›î©i⁄s
;

3130 
loff_t
 
pxt4_Œ£ek
(
fûe
 *fûe,Üoff_à
off£t
, 
‹igö
);

3133 
pxt4_gë_max_ölöe_size
(
öode
 *inode);

3134 
pxt4_föd_ölöe_d©a_nﬁock
(
öode
 *inode);

3135 
pxt4_öô_ölöe_d©a
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *inode,

3136 
Àn
);

3137 
pxt4_de°roy_ölöe_d©a
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *inode);

3139 
pxt4_ªad∑ge_ölöe
(
öode
 *öode, 
∑ge
 *page);

3140 
pxt4_åy_to_wrôe_ölöe_d©a
(
addªss_•a˚
 *
m≠pög
,

3141 
öode
 *inode,

3142 
loff_t
 
pos
, 
Àn
,

3143 
Êags
,

3144 
∑ge
 **
∑gï
);

3145 
pxt4_wrôe_ölöe_d©a_íd
(
öode
 *inode,

3146 
loff_t
 
pos
, 
Àn
,

3147 
c›õd
,

3148 
∑ge
 *page);

3149 
buf„r_hód
 *

3150 
pxt4_jou∫ÆÀd_wrôe_ölöe_d©a
(
öode
 *inode,

3151 
Àn
,

3152 
∑ge
 *page);

3153 
pxt4_da_wrôe_ölöe_d©a_begö
(
addªss_•a˚
 *
m≠pög
,

3154 
öode
 *inode,

3155 
loff_t
 
pos
, 
Àn
,

3156 
Êags
,

3157 
∑ge
 **
∑gï
,

3158 **
fsd©a
);

3159 
pxt4_da_wrôe_ölöe_d©a_íd
(
öode
 *öode, 
loff_t
 
pos
,

3160 
Àn
, 
c›õd
,

3161 
∑ge
 *page);

3162 
pxt4_åy_add_ölöe_íåy
(
h™dÀ_t
 *
h™dÀ
,

3163 
pxt4_fûíame
 *
‚ame
,

3164 
öode
 *
dú
, inode *inode);

3165 
pxt4_åy_¸óã_ölöe_dú
(
h™dÀ_t
 *
h™dÀ
,

3166 
öode
 *
∑ª¡
,

3167 
öode
 *inode);

3168 
pxt4_ªad_ölöe_dú
(
fûe
 *
fûp
,

3169 
dú_c⁄ãxt
 *
˘x
,

3170 *
has_ölöe_d©a
);

3171 
pxt4_ölöedú_to_åì
(
fûe
 *
dú_fûe
,

3172 
öode
 *
dú
, 
pxt4_lblk_t
 
block
,

3173 
dx_hash_öfo
 *
höfo
,

3174 
__u32
 
°¨t_hash
, __u32 
°¨t_mö‹_hash
,

3175 *
has_ölöe_d©a
);

3176 
buf„r_hód
 *
pxt4_föd_ölöe_íåy
(
öode
 *
dú
,

3177 
pxt4_fûíame
 *
‚ame
,

3178 
pxt4_dú_íåy_2
 **
ªs_dú
,

3179 *
has_ölöe_d©a
);

3180 
pxt4_dñëe_ölöe_íåy
(
h™dÀ_t
 *
h™dÀ
,

3181 
öode
 *
dú
,

3182 
pxt4_dú_íåy_2
 *
de_dñ
,

3183 
buf„r_hód
 *
bh
,

3184 *
has_ölöe_d©a
);

3185 
boﬁ
 
em±y_ölöe_dú
(
öode
 *
dú
, *
has_ölöe_d©a
);

3186 
buf„r_hód
 *
pxt4_gë_fú°_ölöe_block
(
öode
 *inode,

3187 
pxt4_dú_íåy_2
 **
∑ª¡_de
,

3188 *
ªtvÆ
);

3189 
pxt4_ölöe_d©a_fõm≠
(
öode
 *inode,

3190 
fõm≠_exã¡_öfo
 *
fõöfo
,

3191 *
has_ölöe
, 
__u64
 
°¨t
, __u64 
Àn
);

3193 
	giom≠
;

3194 
pxt4_ölöe_d©a_iom≠
(
öode
 *öode, 
iom≠
 *iomap);

3196 
pxt4_ölöe_d©a_åunˇã
(
öode
 *öode, *
has_ölöe
);

3198 
pxt4_c⁄vît_ölöe_d©a
(
öode
 *inode);

3200 
ölöe
 
	$pxt4_has_ölöe_d©a
(
öode
 *inode)

3202  
	`pxt4_ã°_öode_Êag
(
öode
, 
PXT4_INODE_INLINE_DATA
) &&

3203 
	`PXT4_I
(
öode
)->
i_ölöe_off
;

3204 
	}
}

3207 c⁄° 
öode_›î©i⁄s
 
pxt4_dú_öode_›î©i⁄s
;

3208 c⁄° 
öode_›î©i⁄s
 
pxt4_•ecül_öode_›î©i⁄s
;

3209 
díåy
 *
pxt4_gë_∑ª¡
(díåy *
chûd
);

3210 
pxt4_dú_íåy_2
 *
pxt4_öô_dŸ_dŸdŸ
(
öode
 *inode,

3211 
pxt4_dú_íåy_2
 *
de
,

3212 
blocksize
, 
csum_size
,

3213 
∑ª¡_öo
, 
dŸdŸ_ªÆ_Àn
);

3214 
pxt4_öôülize_dúít_èû
(
buf„r_hód
 *
bh
,

3215 
blocksize
);

3216 
pxt4_h™dÀ_dúty_dúblock
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *inode,

3217 
buf„r_hód
 *
bh
);

3218 
pxt4_ci_com∑ª
(c⁄° 
öode
 *
∑ª¡
,

3219 c⁄° 
q°r
 *
‚ame
,

3220 c⁄° 
q°r
 *
íåy
, 
boﬁ
 
quick
);

3222 
	#S_SHIFT
 12

	)

3223 c⁄° 
	gpxt4_ty≥_by_mode
[(
S_IFMT
 >> 
S_SHIFT
) + 1] = {

3224 [
S_IFREG
 >> 
S_SHIFT
] = 
PXT4_FT_REG_FILE
,

3225 [
S_IFDIR
 >> 
S_SHIFT
] = 
PXT4_FT_DIR
,

3226 [
S_IFCHR
 >> 
S_SHIFT
] = 
PXT4_FT_CHRDEV
,

3227 [
S_IFBLK
 >> 
S_SHIFT
] = 
PXT4_FT_BLKDEV
,

3228 [
S_IFIFO
 >> 
S_SHIFT
] = 
PXT4_FT_FIFO
,

3229 [
S_IFSOCK
 >> 
S_SHIFT
] = 
PXT4_FT_SOCK
,

3230 [
S_IFLNK
 >> 
S_SHIFT
] = 
PXT4_FT_SYMLINK
,

3233 
ölöe
 
	$pxt4_£t_de_ty≥
(
su≥r_block
 *
sb
,

3234 
pxt4_dú_íåy_2
 *
de
,

3235 
umode_t
 
mode
) {

3236 i‡(
	`pxt4_has_„©uª_fûëy≥
(
sb
))

3237 
de
->
fûe_ty≥
 = 
pxt4_ty≥_by_mode
[(
mode
 & 
S_IFMT
)>>
S_SHIFT
];

3238 
	}
}

3241 
pxt4_m∑ge_ªad∑ges
(
addªss_•a˚
 *
m≠pög
,

3242 
li°_hód
 *
∑ges
, 
∑ge
 *page,

3243 
ƒ_∑ges
, 
boﬁ
 
is_ªadahód
);

3244 
__öô
 
pxt4_öô_po°_ªad_¥o˚ssög
();

3245 
pxt4_exô_po°_ªad_¥o˚ssög
();

3248 c⁄° 
öode_›î©i⁄s
 
pxt4_í¸y±ed_symlök_öode_›î©i⁄s
;

3249 c⁄° 
öode_›î©i⁄s
 
pxt4_symlök_öode_›î©i⁄s
;

3250 c⁄° 
öode_›î©i⁄s
 
pxt4_Á°_symlök_öode_›î©i⁄s
;

3253 
pxt4_ªgi°î_sysfs
(
su≥r_block
 *
sb
);

3254 
pxt4_uƒegi°î_sysfs
(
su≥r_block
 *
sb
);

3255 
__öô
 
pxt4_öô_sysfs
();

3256 
pxt4_exô_sysfs
();

3259 
pxt4_ªÀa£_sy°em_z⁄e
(
su≥r_block
 *
sb
);

3260 
pxt4_£tup_sy°em_z⁄e
(
su≥r_block
 *
sb
);

3261 
__öô
 
pxt4_öô_sy°em_z⁄e
();

3262 
pxt4_exô_sy°em_z⁄e
();

3263 
pxt4_d©a_block_vÆid
(
pxt4_sb_öfo
 *
sbi
,

3264 
pxt4_fsblk_t
 
°¨t_blk
,

3265 
cou¡
);

3266 
pxt4_check_blockªf
(const *, ,

3267 
öode
 *, 
__À32
 *, );

3270 
	gpxt4_ext_∑th
;

3271 
	gpxt4_exã¡
;

3277 
	#EXT_MAX_BLOCKS
 0xffffffff

	)

3279 
pxt4_ext_åì_öô
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *);

3280 
pxt4_ext_wrôïage_å™s_blocks
(
öode
 *, );

3281 
pxt4_ext_ödex_å™s_blocks
(
öode
 *öode, 
exã¡s
);

3282 
pxt4_ext_m≠_blocks
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *inode,

3283 
pxt4_m≠_blocks
 *
m≠
, 
Êags
);

3284 
pxt4_ext_åunˇã
(
h™dÀ_t
 *, 
öode
 *);

3285 
pxt4_ext_ªmove_•a˚
(
öode
 *öode, 
pxt4_lblk_t
 
°¨t
,

3286 
pxt4_lblk_t
 
íd
);

3287 
pxt4_ext_öô
(
su≥r_block
 *);

3288 
pxt4_ext_ªÀa£
(
su≥r_block
 *);

3289 
pxt4_ÁŒoˇã
(
fûe
 *fûe, 
mode
, 
loff_t
 
off£t
,

3290 
loff_t
 
Àn
);

3291 
pxt4_c⁄vît_unwrôãn_exã¡s
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *inode,

3292 
loff_t
 
off£t
, 
ssize_t
 
Àn
);

3293 
pxt4_m≠_blocks
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *inode,

3294 
pxt4_m≠_blocks
 *
m≠
, 
Êags
);

3295 
pxt4_ext_ˇlc_mëad©a_amou¡
(
öode
 *inode,

3296 
pxt4_lblk_t
 
lblocks
);

3297 
pxt4_ext_ˇlc_¸edôs_f‹_sögÀ_exã¡
(
öode
 *inode,

3298 
num
,

3299 
pxt4_ext_∑th
 *
∑th
);

3300 
pxt4_ˇn_exã¡s_be_mîged
(
öode
 *inode,

3301 
pxt4_exã¡
 *
ex1
,

3302 
pxt4_exã¡
 *
ex2
);

3303 
pxt4_ext_ö£π_exã¡
(
h™dÀ_t
 *, 
öode
 *,

3304 
pxt4_ext_∑th
 **,

3305 
pxt4_exã¡
 *, );

3306 
pxt4_ext_∑th
 *
pxt4_föd_exã¡
(
öode
 *, 
pxt4_lblk_t
,

3307 
pxt4_ext_∑th
 **,

3308 
Êags
);

3309 
pxt4_ext_dr›_ªfs
(
pxt4_ext_∑th
 *);

3310 
pxt4_ext_check_öode
(
öode
 *inode);

3311 
pxt4_lblk_t
 
pxt4_ext_√xt_Æloˇãd_block
(
pxt4_ext_∑th
 *
∑th
);

3312 
pxt4_fõm≠
(
öode
 *öode, 
fõm≠_exã¡_öfo
 *
fõöfo
,

3313 
__u64
 
°¨t
, __u64 
Àn
);

3314 
pxt4_gë_es_ˇche
(
öode
 *inode,

3315 
fõm≠_exã¡_öfo
 *
fõöfo
,

3316 
__u64
 
°¨t
, __u64 
Àn
);

3317 
pxt4_ext_¥eˇche
(
öode
 *inode);

3318 
pxt4_cﬁœp£_ønge
(
öode
 *öode, 
loff_t
 
off£t
,Üoff_à
Àn
);

3319 
pxt4_ö£π_ønge
(
öode
 *öode, 
loff_t
 
off£t
,Üoff_à
Àn
);

3320 
pxt4_sw≠_exã¡s
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *
öode1
,

3321 
öode
 *
öode2
, 
pxt4_lblk_t
 
lblk1
,

3322 
pxt4_lblk_t
 
lblk2
,Öxt4_lblk_à
cou¡
,

3323 
m¨k_unwrôãn
,*
îr
);

3324 
pxt4_˛u_m≠≥d
(
öode
 *öode, 
pxt4_lblk_t
 
l˛u
);

3327 
pxt4_doubÀ_down_wrôe_d©a_£m
(
öode
 *
fú°
,

3328 
öode
 *
£c⁄d
);

3329 
pxt4_doubÀ_up_wrôe_d©a_£m
(
öode
 *
‹ig_öode
,

3330 
öode
 *
d⁄‹_öode
);

3331 
pxt4_move_exã¡s
(
fûe
 *
o_fûp
, fûê*
d_fûp
,

3332 
__u64
 
°¨t_‹ig
, __u64 
°¨t_d⁄‹
,

3333 
__u64
 
Àn
, __u64 *
moved_Àn
);

3336 
__öô
 
pxt4_öô_∑geio
();

3337 
pxt4_exô_∑geio
();

3338 
pxt4_io_íd_t
 *
pxt4_öô_io_íd
(
öode
 *öode, 
gÂ_t
 
Êags
);

3339 
pxt4_io_íd_t
 *
pxt4_gë_io_íd
’xt4_io_íd_à*
io_íd
);

3340 
pxt4_put_io_íd
(
pxt4_io_íd_t
 *
io_íd
);

3341 
pxt4_put_io_íd_de„r
(
pxt4_io_íd_t
 *
io_íd
);

3342 
pxt4_io_submô_öô
(
pxt4_io_submô
 *
io
,

3343 
wrôeback_c⁄åﬁ
 *
wbc
);

3344 
pxt4_íd_io_rsv_w‹k
(
w‹k_°ru˘
 *
w‹k
);

3345 
pxt4_io_submô
(pxt4_io_submô *
io
);

3346 
pxt4_bio_wrôe_∑ge
(
pxt4_io_submô
 *
io
,

3347 
∑ge
 *page,

3348 
Àn
,

3349 
wrôeback_c⁄åﬁ
 *
wbc
,

3350 
boﬁ
 
kìp_towrôe
);

3353 
pxt4_mu…i_mou¡_¥Ÿe˘
(
su≥r_block
 *, 
pxt4_fsblk_t
);

3356 c⁄° 
fsvîôy_›î©i⁄s
 
pxt4_vîôy›s
;

3363 
	#BH_BITMAP_UPTODATE
 
BH_JBDPriv©eSèπ


	)

3365 
ölöe
 
	$bôm≠_u±od©e
(
buf„r_hód
 *
bh
)

3367  (
	`buf„r_u±od©e
(
bh
) &&

3368 
	`ã°_bô
(
BH_BITMAP_UPTODATE
, &(
bh
)->
b_°©e
));

3369 
	}
}

3370 
ölöe
 
	$£t_bôm≠_u±od©e
(
buf„r_hód
 *
bh
)

3372 
	`£t_bô
(
BH_BITMAP_UPTODATE
, &(
bh
)->
b_°©e
);

3373 
	}
}

3375 
	#ö_ønge
(
b
, 
fú°
, 
Àn
Ë((bË>(fú°Ë&& (bË<(fú°Ë+ (ÀnË- 1)

	)

3378 
	#PXT4_WQ_HASH_SZ
 37

	)

3379 
	#pxt4_i€nd_wq
(
v
Ë(&
pxt4__i€nd_wq
[(()(v)) %\

3380 
PXT4_WQ_HASH_SZ
])

	)

3381 
waô_queue_hód_t
 
pxt4__i€nd_wq
[
PXT4_WQ_HASH_SZ
];

3383 
pxt4_ªsize_begö
(
su≥r_block
 *
sb
);

3384 
pxt4_ªsize_íd
(
su≥r_block
 *
sb
);

3386 
ölöe
 
	$pxt4_£t_io_unwrôãn_Êag
(
öode
 *inode,

3387 
pxt4_io_íd
 *
io_íd
)

3389 i‡(!(
io_íd
->
Êag
 & 
PXT4_IO_END_UNWRITTEN
)) {

3390 
io_íd
->
Êag
 |
PXT4_IO_END_UNWRITTEN
;

3391 
	`©omic_öc
(&
	`PXT4_I
(
öode
)->
i_unwrôãn
);

3393 
	}
}

3395 
ölöe
 
	$pxt4_˛ór_io_unwrôãn_Êag
(
pxt4_io_íd_t
 *
io_íd
)

3397 
öode
 *öodê
io_íd
->inode;

3399 i‡(
io_íd
->
Êag
 & 
PXT4_IO_END_UNWRITTEN
) {

3400 
io_íd
->
Êag
 &~
PXT4_IO_END_UNWRITTEN
;

3402 i‡(
	`©omic_dec_™d_ã°
(&
	`PXT4_I
(
öode
)->
i_unwrôãn
))

3403 
	`wake_up_Æl
(
	`pxt4_i€nd_wq
(
öode
));

3405 
	}
}

3407 c⁄° 
iom≠_›s
 
pxt4_iom≠_›s
;

3409 
ölöe
 
	$pxt4_buf„r_u±od©e
(
buf„r_hód
 *
bh
)

3417 i‡(!
	`buf„r_u±od©e
(
bh
Ë&& 
	`buf„r_wrôe_io_îr‹
(bh))

3418 
	`£t_buf„r_u±od©e
(
bh
);

3419  
	`buf„r_u±od©e
(
bh
);

3420 
	}
}

3424 
	#EFSBADCRC
 
EBADMSG


	)

3425 
	#EFSCORRUPTED
 
EUCLEAN


	)

	@ext4_extents.h

7 #i‚de‡
_PXT4_EXTENTS


8 
	#_PXT4_EXTENTS


	)

10 
	~"pxt4.h
"

18 
	#AGGRESSIVE_TEST_


	)

25 
	#EXTENTS_STATS__


	)

31 
	#CHECK_BINSEARCH__


	)

37 
	#EXT_STATS_


	)

55 
	spxt4_exã¡_èû
 {

56 
__À32
 
	më_checksum
;

63 
	spxt4_exã¡
 {

64 
__À32
 
	mì_block
;

65 
__À16
 
	mì_Àn
;

66 
__À16
 
	mì_°¨t_hi
;

67 
__À32
 
	mì_°¨t_lo
;

74 
	spxt4_exã¡_idx
 {

75 
__À32
 
	mei_block
;

76 
__À32
 
	mei_Àaf_lo
;

78 
__À16
 
	mei_Àaf_hi
;

79 
__u16
 
	mei_unu£d
;

85 
	spxt4_exã¡_hódî
 {

86 
__À16
 
	meh_magic
;

87 
__À16
 
	meh_íåõs
;

88 
__À16
 
	meh_max
;

89 
__À16
 
	meh_dïth
;

90 
__À32
 
	meh_gíî©i⁄
;

93 
	#PXT4_EXT_MAGIC
 
	`˝u_to_À16
(0xf30a)

	)

94 
	#PXT4_MAX_EXTENT_DEPTH
 5

	)

96 
	#PXT4_EXTENT_TAIL_OFFSET
(
hdr
) \

97 ((
pxt4_exã¡_hódî
) + \

98 ((
pxt4_exã¡
Ë* 
	`À16_to_˝u
((
hdr
)->
eh_max
)))

	)

100 
ölöe
 
pxt4_exã¡_èû
 *

101 
	$föd_pxt4_exã¡_èû
(
pxt4_exã¡_hódî
 *
eh
)

103  (
pxt4_exã¡_èû
 *)(((*)
eh
) +

104 
	`PXT4_EXTENT_TAIL_OFFSET
(
eh
));

105 
	}
}

112 
	spxt4_ext_∑th
 {

113 
pxt4_fsblk_t
 
	mp_block
;

114 
__u16
 
	mp_dïth
;

115 
__u16
 
	mp_maxdïth
;

116 
pxt4_exã¡
 *
	mp_ext
;

117 
pxt4_exã¡_idx
 *
	mp_idx
;

118 
pxt4_exã¡_hódî
 *
	mp_hdr
;

119 
buf„r_hód
 *
	mp_bh
;

129 
	s∑πül_˛u°î
 {

130 
pxt4_fsblk_t
 
	mp˛u
;

131 
pxt4_lblk_t
 
	mlblk
;

132 íum {
	möôül
, 
	mto‰ì
, 
	mno‰ì
} 
	m°©e
;

156 
	#EXT_INIT_MAX_LEN
 (1UL << 15)

	)

157 
	#EXT_UNWRITTEN_MAX_LEN
 (
EXT_INIT_MAX_LEN
 - 1)

	)

160 
	#EXT_FIRST_EXTENT
(
__hdr__
) \

161 ((
pxt4_exã¡
 *Ë(((*Ë(
__hdr__
)) + \

162 (
pxt4_exã¡_hódî
)))

	)

163 
	#EXT_FIRST_INDEX
(
__hdr__
) \

164 ((
pxt4_exã¡_idx
 *Ë(((*Ë(
__hdr__
)) + \

165 (
pxt4_exã¡_hódî
)))

	)

166 
	#EXT_HAS_FREE_INDEX
(
__∑th__
) \

167 (
	`À16_to_˝u
((
__∑th__
)->
p_hdr
->
eh_íåõs
) \

168 < 
	`À16_to_˝u
((
__∑th__
)->
p_hdr
->
eh_max
))

	)

169 
	#EXT_LAST_EXTENT
(
__hdr__
) \

170 (
	`EXT_FIRST_EXTENT
((
__hdr__
)Ë+ 
	`À16_to_˝u
((__hdr__)->
eh_íåõs
Ë- 1)

	)

171 
	#EXT_LAST_INDEX
(
__hdr__
) \

172 (
	`EXT_FIRST_INDEX
((
__hdr__
)Ë+ 
	`À16_to_˝u
((__hdr__)->
eh_íåõs
Ë- 1)

	)

173 
	#EXT_MAX_EXTENT
(
__hdr__
) \

174 ((
	`À16_to_˝u
((
__hdr__
)->
eh_max
)) ? \

175 ((
	`EXT_FIRST_EXTENT
((
__hdr__
)Ë+ 
	`À16_to_˝u
((__hdr__)->
eh_max
) - 1)) \

176 : 0)

	)

177 
	#EXT_MAX_INDEX
(
__hdr__
) \

178 ((
	`À16_to_˝u
((
__hdr__
)->
eh_max
)) ? \

179 ((
	`EXT_FIRST_INDEX
((
__hdr__
)Ë+ 
	`À16_to_˝u
((__hdr__)->
eh_max
Ë- 1)Ë: 0)

	)

181 
ölöe
 
pxt4_exã¡_hódî
 *
	$ext_öode_hdr
(
öode
 *inode)

183  (
pxt4_exã¡_hódî
 *Ë
	`PXT4_I
(
öode
)->
i_d©a
;

184 
	}
}

186 
ölöe
 
pxt4_exã¡_hódî
 *
	$ext_block_hdr
(
buf„r_hód
 *
bh
)

188  (
pxt4_exã¡_hódî
 *Ë
bh
->
b_d©a
;

189 
	}
}

191 
ölöe
 
	$ext_dïth
(
öode
 *inode)

193  
	`À16_to_˝u
(
	`ext_öode_hdr
(
öode
)->
eh_dïth
);

194 
	}
}

196 
ölöe
 
	$pxt4_ext_m¨k_unwrôãn
(
pxt4_exã¡
 *
ext
)

199 
	`BUG_ON
((
	`À16_to_˝u
(
ext
->
ì_Àn
Ë& ~
EXT_INIT_MAX_LEN
) == 0);

200 
ext
->
ì_Àn
 |
	`˝u_to_À16
(
EXT_INIT_MAX_LEN
);

201 
	}
}

203 
ölöe
 
	$pxt4_ext_is_unwrôãn
(
pxt4_exã¡
 *
ext
)

206  (
	`À16_to_˝u
(
ext
->
ì_Àn
Ë> 
EXT_INIT_MAX_LEN
);

207 
	}
}

209 
ölöe
 
	$pxt4_ext_gë_a˘uÆ_Àn
(
pxt4_exã¡
 *
ext
)

211  (
	`À16_to_˝u
(
ext
->
ì_Àn
Ë<
EXT_INIT_MAX_LEN
 ?

212 
	`À16_to_˝u
(
ext
->
ì_Àn
) :

213 (
	`À16_to_˝u
(
ext
->
ì_Àn
Ë- 
EXT_INIT_MAX_LEN
));

214 
	}
}

216 
ölöe
 
	$pxt4_ext_m¨k_öôülized
(
pxt4_exã¡
 *
ext
)

218 
ext
->
ì_Àn
 = 
	`˝u_to_À16
(
	`pxt4_ext_gë_a˘uÆ_Àn
(ext));

219 
	}
}

225 
ölöe
 
pxt4_fsblk_t
 
	$pxt4_ext_pblock
(
pxt4_exã¡
 *
ex
)

227 
pxt4_fsblk_t
 
block
;

229 
block
 = 
	`À32_to_˝u
(
ex
->
ì_°¨t_lo
);

230 
block
 |((
pxt4_fsblk_t
Ë
	`À16_to_˝u
(
ex
->
ì_°¨t_hi
) << 31) << 1;

231  
block
;

232 
	}
}

238 
ölöe
 
pxt4_fsblk_t
 
	$pxt4_idx_pblock
(
pxt4_exã¡_idx
 *
ix
)

240 
pxt4_fsblk_t
 
block
;

242 
block
 = 
	`À32_to_˝u
(
ix
->
ei_Àaf_lo
);

243 
block
 |((
pxt4_fsblk_t
Ë
	`À16_to_˝u
(
ix
->
ei_Àaf_hi
) << 31) << 1;

244  
block
;

245 
	}
}

252 
ölöe
 
	$pxt4_ext_°‹e_pblock
(
pxt4_exã¡
 *
ex
,

253 
pxt4_fsblk_t
 
pb
)

255 
ex
->
ì_°¨t_lo
 = 
	`˝u_to_À32
((Ë(
pb
 & 0xffffffff));

256 
ex
->
ì_°¨t_hi
 = 
	`˝u_to_À16
((Ë((
pb
 >> 31) >> 1) &

258 
	}
}

265 
ölöe
 
	$pxt4_idx_°‹e_pblock
(
pxt4_exã¡_idx
 *
ix
,

266 
pxt4_fsblk_t
 
pb
)

268 
ix
->
ei_Àaf_lo
 = 
	`˝u_to_À32
((Ë(
pb
 & 0xffffffff));

269 
ix
->
ei_Àaf_hi
 = 
	`˝u_to_À16
((Ë((
pb
 >> 31) >> 1) &

271 
	}
}

273 
	#pxt4_ext_dúty
(
h™dÀ
, 
öode
, 
∑th
) \

274 
	`__pxt4_ext_dúty
(
__func__
, 
__LINE__
, (
h™dÀ
), (
öode
), (
∑th
))

	)

275 
__pxt4_ext_dúty
(c⁄° *
whîe
, 
löe
, 
h™dÀ_t
 *
h™dÀ
,

276 
öode
 *öode, 
pxt4_ext_∑th
 *
∑th
);

	@ext4_jbd2.c

6 
	~"pxt4_jbd3.h
"

8 
	~<åa˚/evíts/pxt4.h
>

11 
h™dÀ_t
 *
	$pxt4_gë_nojou∫Æ
()

13 
h™dÀ_t
 *
h™dÀ
 = 
cuºít
->
jou∫Æ_öfo
;

14 
ªf_˙t
 = ()
h™dÀ
;

16 
	`BUG_ON
(
ªf_˙t
 >
PXT4_NOJOURNAL_MAX_REF_COUNT
);

18 
ªf_˙t
++;

19 
h™dÀ
 = (
h™dÀ_t
 *)
ªf_˙t
;

21 
cuºít
->
jou∫Æ_öfo
 = 
h™dÀ
;

22  
h™dÀ
;

23 
	}
}

27 
	$pxt4_put_nojou∫Æ
(
h™dÀ_t
 *
h™dÀ
)

29 
ªf_˙t
 = ()
h™dÀ
;

31 
	`BUG_ON
(
ªf_˙t
 == 0);

33 
ªf_˙t
--;

34 
h™dÀ
 = (
h™dÀ_t
 *)
ªf_˙t
;

36 
cuºít
->
jou∫Æ_öfo
 = 
h™dÀ
;

37 
	}
}

42 
	$pxt4_jou∫Æ_check_°¨t
(
su≥r_block
 *
sb
)

44 
jou∫Æ_t
 *
jou∫Æ
;

46 
	`might_¶ìp
();

48 i‡(
	`u∆ikñy
(
	`pxt4_f‹˚d_shutdown
(
	`PXT4_SB
(
sb
))))

49  -
EIO
;

51 i‡(
	`sb_rd⁄ly
(
sb
))

52  -
EROFS
;

53 
	`WARN_ON
(
sb
->
s_wrôîs
.
‰ozí
 =
SB_FREEZE_COMPLETE
);

54 
jou∫Æ
 = 
	`PXT4_SB
(
sb
)->
s_jou∫Æ
;

60 i‡(
jou∫Æ
 && 
	`is_jou∫Æ_ab‹ãd
(journal)) {

61 
	`pxt4_ab‹t
(
sb
, "Detectedáborted journal");

62  -
EROFS
;

65 
	}
}

67 
h™dÀ_t
 *
	$__pxt4_jou∫Æ_°¨t_sb
(
su≥r_block
 *
sb
, 
löe
,

68 
ty≥
, 
blocks
, 
rsv_blocks
)

70 
jou∫Æ_t
 *
jou∫Æ
;

71 
îr
;

73 
	`åa˚_pxt4_jou∫Æ_°¨t
(
sb
, 
blocks
, 
rsv_blocks
, 
_RET_IP_
);

74 
îr
 = 
	`pxt4_jou∫Æ_check_°¨t
(
sb
);

75 i‡(
îr
 < 0)

76  
	`ERR_PTR
(
îr
);

78 
jou∫Æ
 = 
	`PXT4_SB
(
sb
)->
s_jou∫Æ
;

79 i‡(!
jou∫Æ
)

80  
	`pxt4_gë_nojou∫Æ
();

81  
	`jbd3__jou∫Æ_°¨t
(
jou∫Æ
, 
blocks
, 
rsv_blocks
, 
GFP_NOFS
,

82 
ty≥
, 
löe
);

83 
	}
}

85 
	$__pxt4_jou∫Æ_°›
(c⁄° *
whîe
, 
löe
, 
h™dÀ_t
 *
h™dÀ
)

87 
su≥r_block
 *
sb
;

88 
îr
;

89 
rc
;

91 i‡(!
	`pxt4_h™dÀ_vÆid
(
h™dÀ
)) {

92 
	`pxt4_put_nojou∫Æ
(
h™dÀ
);

96 
îr
 = 
h™dÀ
->
h_îr
;

97 i‡(!
h™dÀ
->
h_å™ß˘i⁄
) {

98 
rc
 = 
	`jbd3_jou∫Æ_°›
(
h™dÀ
);

99  
îr
 ?Éº : 
rc
;

102 
sb
 = 
h™dÀ
->
h_å™ß˘i⁄
->
t_jou∫Æ
->
j_¥iv©e
;

103 
rc
 = 
	`jbd3_jou∫Æ_°›
(
h™dÀ
);

105 i‡(!
îr
)

106 
îr
 = 
rc
;

107 i‡(
îr
)

108 
	`__pxt4_°d_îr‹
(
sb
, 
whîe
, 
löe
, 
îr
);

109  
îr
;

110 
	}
}

112 
h™dÀ_t
 *
	$__pxt4_jou∫Æ_°¨t_ª£rved
(
h™dÀ_t
 *
h™dÀ
, 
löe
,

113 
ty≥
)

115 
su≥r_block
 *
sb
;

116 
îr
;

118 i‡(!
	`pxt4_h™dÀ_vÆid
(
h™dÀ
))

119  
	`pxt4_gë_nojou∫Æ
();

121 
sb
 = 
h™dÀ
->
h_jou∫Æ
->
j_¥iv©e
;

122 
	`åa˚_pxt4_jou∫Æ_°¨t_ª£rved
(
sb
, 
h™dÀ
->
h_buf„r_¸edôs
,

123 
_RET_IP_
);

124 
îr
 = 
	`pxt4_jou∫Æ_check_°¨t
(
sb
);

125 i‡(
îr
 < 0) {

126 
	`jbd3_jou∫Æ_‰ì_ª£rved
(
h™dÀ
);

127  
	`ERR_PTR
(
îr
);

130 
îr
 = 
	`jbd3_jou∫Æ_°¨t_ª£rved
(
h™dÀ
, 
ty≥
, 
löe
);

131 i‡(
îr
 < 0)

132  
	`ERR_PTR
(
îr
);

133  
h™dÀ
;

134 
	}
}

136 
	$pxt4_jou∫Æ_ab‹t_h™dÀ
(c⁄° *
ˇŒî
, 
löe
,

137 c⁄° *
îr_‚
,

138 
buf„r_hód
 *
bh
,

139 
h™dÀ_t
 *
h™dÀ
, 
îr
)

141 
nbuf
[16];

142 c⁄° *
îr°r
 = 
	`pxt4_decode_îr‹
(
NULL
, 
îr
, 
nbuf
);

144 
	`BUG_ON
(!
	`pxt4_h™dÀ_vÆid
(
h™dÀ
));

146 i‡(
bh
)

147 
	`BUFFER_TRACE
(
bh
, "abort");

149 i‡(!
h™dÀ
->
h_îr
)

150 
h™dÀ
->
h_îr
 = 
îr
;

152 i‡(
	`is_h™dÀ_ab‹ãd
(
h™dÀ
))

155 
	`¥ötk
(
KERN_ERR
 "PXT4-fs: %s:%d:ábortingÅransaction: %s in %s\n",

156 
ˇŒî
, 
löe
, 
îr°r
, 
îr_‚
);

158 
	`jbd3_jou∫Æ_ab‹t_h™dÀ
(
h™dÀ
);

159 
	}
}

161 
	$__pxt4_jou∫Æ_gë_wrôe_ac˚ss
(c⁄° *
whîe
, 
löe
,

162 
h™dÀ_t
 *
h™dÀ
, 
buf„r_hód
 *
bh
)

164 
îr
 = 0;

166 
	`might_¶ìp
();

168 i‡(
	`pxt4_h™dÀ_vÆid
(
h™dÀ
)) {

169 
îr
 = 
	`jbd3_jou∫Æ_gë_wrôe_ac˚ss
(
h™dÀ
, 
bh
);

170 i‡(
îr
)

171 
	`pxt4_jou∫Æ_ab‹t_h™dÀ
(
whîe
, 
löe
, 
__func__
, 
bh
,

172 
h™dÀ
, 
îr
);

174  
îr
;

175 
	}
}

189 
	$__pxt4_f‹gë
(c⁄° *
whîe
, 
löe
, 
h™dÀ_t
 *
h™dÀ
,

190 
is_mëad©a
, 
öode
 *inode,

191 
buf„r_hód
 *
bh
, 
pxt4_fsblk_t
 
blockƒ
)

193 
îr
;

195 
	`might_¶ìp
();

197 
	`åa˚_pxt4_f‹gë
(
öode
, 
is_mëad©a
, 
blockƒ
);

198 
	`BUFFER_TRACE
(
bh
, "enter");

200 
	`jbd_debug
(4, "forgetting bh %p: is_metadata = %d, mode %o, "

202 
bh
, 
is_mëad©a
, 
öode
->
i_mode
,

203 
	`ã°_›t
(
öode
->
i_sb
, 
DATA_FLAGS
));

206 i‡(!
	`pxt4_h™dÀ_vÆid
(
h™dÀ
)) {

207 
	`bf‹gë
(
bh
);

216 i‡(
	`ã°_›t
(
öode
->
i_sb
, 
DATA_FLAGS
Ë=
PXT4_MOUNT_JOURNAL_DATA
 ||

217 (!
is_mëad©a
 && !
	`pxt4_should_jou∫Æ_d©a
(
öode
))) {

218 i‡(
bh
) {

219 
	`BUFFER_TRACE
(
bh
, "call jbd3_journal_forget");

220 
îr
 = 
	`jbd3_jou∫Æ_f‹gë
(
h™dÀ
, 
bh
);

221 i‡(
îr
)

222 
	`pxt4_jou∫Æ_ab‹t_h™dÀ
(
whîe
, 
löe
, 
__func__
,

223 
bh
, 
h™dÀ
, 
îr
);

224  
îr
;

232 
	`BUFFER_TRACE
(
bh
, "call jbd3_journal_revoke");

233 
îr
 = 
	`jbd3_jou∫Æ_ªvoke
(
h™dÀ
, 
blockƒ
, 
bh
);

234 i‡(
îr
) {

235 
	`pxt4_jou∫Æ_ab‹t_h™dÀ
(
whîe
, 
löe
, 
__func__
,

236 
bh
, 
h™dÀ
, 
îr
);

237 
	`__pxt4_ab‹t
(
öode
->
i_sb
, 
whîe
, 
löe
,

238 "îr‹ %d whíáâem±ögÑevoke", 
îr
);

240 
	`BUFFER_TRACE
(
bh
, "exit");

241  
îr
;

242 
	}
}

244 
	$__pxt4_jou∫Æ_gë_¸óã_ac˚ss
(c⁄° *
whîe
, 
löe
,

245 
h™dÀ_t
 *
h™dÀ
, 
buf„r_hód
 *
bh
)

247 
îr
 = 0;

249 i‡(
	`pxt4_h™dÀ_vÆid
(
h™dÀ
)) {

250 
îr
 = 
	`jbd3_jou∫Æ_gë_¸óã_ac˚ss
(
h™dÀ
, 
bh
);

251 i‡(
îr
)

252 
	`pxt4_jou∫Æ_ab‹t_h™dÀ
(
whîe
, 
löe
, 
__func__
,

253 
bh
, 
h™dÀ
, 
îr
);

255  
îr
;

256 
	}
}

258 
	$__pxt4_h™dÀ_dúty_mëad©a
(c⁄° *
whîe
, 
löe
,

259 
h™dÀ_t
 *
h™dÀ
, 
öode
 *inode,

260 
buf„r_hód
 *
bh
)

262 
îr
 = 0;

264 
	`might_¶ìp
();

266 
	`£t_buf„r_mëa
(
bh
);

267 
	`£t_buf„r_¥io
(
bh
);

268 i‡(
	`pxt4_h™dÀ_vÆid
(
h™dÀ
)) {

269 
îr
 = 
	`jbd3_jou∫Æ_dúty_mëad©a
(
h™dÀ
, 
bh
);

271 i‡(!
	`is_h™dÀ_ab‹ãd
(
h™dÀ
Ë&& 
	`WARN_ON_ONCE
(
îr
)) {

272 
	`pxt4_jou∫Æ_ab‹t_h™dÀ
(
whîe
, 
löe
, 
__func__
, 
bh
,

273 
h™dÀ
, 
îr
);

274 i‡(
öode
 =
NULL
) {

275 
	`¥_îr
("PXT4: jbd3_journal_dirty_metadata "

278 
h™dÀ
->
h_ty≥
,

279 
h™dÀ
->
h_löe_no
,

280 
h™dÀ
->
h_ªque°ed_¸edôs
,

281 
h™dÀ
->
h_buf„r_¸edôs
, 
îr
);

282  
îr
;

284 
	`pxt4_îr‹_öode
(
öode
, 
whîe
, 
löe
,

285 
bh
->
b_blockƒ
,

289 
h™dÀ
->
h_ty≥
,

290 
h™dÀ
->
h_löe_no
,

291 
h™dÀ
->
h_ªque°ed_¸edôs
,

292 
h™dÀ
->
h_buf„r_¸edôs
, 
îr
);

295 i‡(
öode
)

296 
	`m¨k_buf„r_dúty_öode
(
bh
, 
öode
);

298 
	`m¨k_buf„r_dúty
(
bh
);

299 i‡(
öode
 && 
	`öode_√eds_sync
(inode)) {

300 
	`sync_dúty_buf„r
(
bh
);

301 i‡(
	`buf„r_ªq
(
bh
Ë&& !
	`buf„r_u±od©e
(bh)) {

302 
pxt4_su≥r_block
 *
es
;

304 
es
 = 
	`PXT4_SB
(
öode
->
i_sb
)->
s_es
;

305 
es
->
s_œ°_îr‹_block
 =

306 
	`˝u_to_À64
(
bh
->
b_blockƒ
);

307 
	`pxt4_îr‹_öode
(
öode
, 
whîe
, 
löe
,

308 
bh
->
b_blockƒ
,

310 
îr
 = -
EIO
;

314  
îr
;

315 
	}
}

317 
	$__pxt4_h™dÀ_dúty_su≥r
(c⁄° *
whîe
, 
löe
,

318 
h™dÀ_t
 *
h™dÀ
, 
su≥r_block
 *
sb
)

320 
buf„r_hód
 *
bh
 = 
	`PXT4_SB
(
sb
)->
s_sbh
;

321 
îr
 = 0;

323 
	`pxt4_su≥rblock_csum_£t
(
sb
);

324 i‡(
	`pxt4_h™dÀ_vÆid
(
h™dÀ
)) {

325 
îr
 = 
	`jbd3_jou∫Æ_dúty_mëad©a
(
h™dÀ
, 
bh
);

326 i‡(
îr
)

327 
	`pxt4_jou∫Æ_ab‹t_h™dÀ
(
whîe
, 
löe
, 
__func__
,

328 
bh
, 
h™dÀ
, 
îr
);

330 
	`m¨k_buf„r_dúty
(
bh
);

331  
îr
;

332 
	}
}

	@ext4_jbd2.h

12 #i‚de‡
_PXT4_JBD3_H


13 
	#_PXT4_JBD3_H


	)

15 
	~<löux/fs.h
>

16 
	~<löux/jbd3.h
>

17 
	~"pxt4.h
"

19 
	#PXT4_JOURNAL
(
öode
Ë(
	`PXT4_SB
((öode)->
i_sb
)->
s_jou∫Æ
)

	)

33 
	#PXT4_SINGLEDATA_TRANS_BLOCKS
(
sb
) \

34 (
	`pxt4_has_„©uª_exã¡s
(
sb
Ë? 20U : 8U)

	)

40 
	#PXT4_XATTR_TRANS_BLOCKS
 6U

	)

48 
	#PXT4_DATA_TRANS_BLOCKS
(
sb
Ë(
	`PXT4_SINGLEDATA_TRANS_BLOCKS
(sb) + \

49 
PXT4_XATTR_TRANS_BLOCKS
 - 2 + \

50 
	`PXT4_MAXQUOTAS_TRANS_BLOCKS
(
sb
))

	)

57 
	#PXT4_META_TRANS_BLOCKS
(
sb
Ë(
PXT4_XATTR_TRANS_BLOCKS
 + \

58 
	`PXT4_MAXQUOTAS_TRANS_BLOCKS
(
sb
))

	)

66 
	#PXT4_MAX_TRANS_DATA
 64U

	)

75 
	#PXT4_RESERVE_TRANS_BLOCKS
 12U

	)

84 
	#PXT4_INDEX_EXTRA_TRANS_BLOCKS
 12U

	)

86 #ifde‡
CONFIG_QUOTA


89 
	#PXT4_QUOTA_TRANS_BLOCKS
(
sb
Ë((
	`ã°_›t
(sb, 
QUOTA
) ||\

90 
	`pxt4_has_„©uª_quŸa
(
sb
)Ë? 1 : 0)

	)

93 
	#PXT4_QUOTA_INIT_BLOCKS
(
sb
Ë((
	`ã°_›t
(sb, 
QUOTA
) ||\

94 
	`pxt4_has_„©uª_quŸa
(
sb
)) ?\

95 (
DQUOT_INIT_ALLOC
*(
	`PXT4_SINGLEDATA_TRANS_BLOCKS
(
sb
)-3)\

96 +3+
DQUOT_INIT_REWRITE
Ë: 0)

	)

98 
	#PXT4_QUOTA_DEL_BLOCKS
(
sb
Ë((
	`ã°_›t
(sb, 
QUOTA
) ||\

99 
	`pxt4_has_„©uª_quŸa
(
sb
)) ?\

100 (
DQUOT_DEL_ALLOC
*(
	`PXT4_SINGLEDATA_TRANS_BLOCKS
(
sb
)-3)\

101 +3+
DQUOT_DEL_REWRITE
Ë: 0)

	)

103 
	#PXT4_QUOTA_TRANS_BLOCKS
(
sb
Ë0

	)

104 
	#PXT4_QUOTA_INIT_BLOCKS
(
sb
Ë0

	)

105 
	#PXT4_QUOTA_DEL_BLOCKS
(
sb
Ë0

	)

107 
	#PXT4_MAXQUOTAS_TRANS_BLOCKS
(
sb
Ë(
PXT4_MAXQUOTAS
*
	`PXT4_QUOTA_TRANS_BLOCKS
(sb))

	)

108 
	#PXT4_MAXQUOTAS_INIT_BLOCKS
(
sb
Ë(
PXT4_MAXQUOTAS
*
	`PXT4_QUOTA_INIT_BLOCKS
(sb))

	)

109 
	#PXT4_MAXQUOTAS_DEL_BLOCKS
(
sb
Ë(
PXT4_MAXQUOTAS
*
	`PXT4_QUOTA_DEL_BLOCKS
(sb))

	)

114 
	#PXT4_HT_MISC
 0

	)

115 
	#PXT4_HT_INODE
 1

	)

116 
	#PXT4_HT_WRITE_PAGE
 2

	)

117 
	#PXT4_HT_MAP_BLOCKS
 3

	)

118 
	#PXT4_HT_DIR
 4

	)

119 
	#PXT4_HT_TRUNCATE
 5

	)

120 
	#PXT4_HT_QUOTA
 6

	)

121 
	#PXT4_HT_RESIZE
 7

	)

122 
	#PXT4_HT_MIGRATE
 8

	)

123 
	#PXT4_HT_MOVE_EXTENTS
 9

	)

124 
	#PXT4_HT_XATTR
 10

	)

125 
	#PXT4_HT_EXT_CONVERT
 11

	)

126 
	#PXT4_HT_MAX
 12

	)

136 
	spxt4_jou∫Æ_cb_íåy
 {

138 
li°_hód
 
	mj˚_li°
;

141 (*
	mj˚_func
)(
su≥r_block
 *
	msb
,

142 
pxt4_jou∫Æ_cb_íåy
 *
	mj˚
, 
	mîr‹
);

168 
ölöe
 
	$_pxt4_jou∫Æ_ˇŒback_add
(
h™dÀ_t
 *
h™dÀ
,

169 
pxt4_jou∫Æ_cb_íåy
 *
j˚
)

172 
	`li°_add_èû
(&
j˚
->
j˚_li°
, &
h™dÀ
->
h_å™ß˘i⁄
->
t_¥iv©e_li°
);

173 
	}
}

175 
ölöe
 
	$pxt4_jou∫Æ_ˇŒback_add
(
h™dÀ_t
 *
h™dÀ
,

176 (*
func
)(
su≥r_block
 *
sb
,

177 
pxt4_jou∫Æ_cb_íåy
 *
j˚
,

178 
rc
),

179 
pxt4_jou∫Æ_cb_íåy
 *
j˚
)

181 
pxt4_sb_öfo
 *
sbi
 =

182 
	`PXT4_SB
(
h™dÀ
->
h_å™ß˘i⁄
->
t_jou∫Æ
->
j_¥iv©e
);

185 
j˚
->
j˚_func
 = 
func
;

186 
	`•ö_lock
(&
sbi
->
s_md_lock
);

187 
	`_pxt4_jou∫Æ_ˇŒback_add
(
h™dÀ
, 
j˚
);

188 
	`•ö_u∆ock
(&
sbi
->
s_md_lock
);

189 
	}
}

198 
ölöe
 
boﬁ
 
	$pxt4_jou∫Æ_ˇŒback_åy_dñ
(
h™dÀ_t
 *
h™dÀ
,

199 
pxt4_jou∫Æ_cb_íåy
 *
j˚
)

201 
boﬁ
 
dñëed
;

202 
pxt4_sb_öfo
 *
sbi
 =

203 
	`PXT4_SB
(
h™dÀ
->
h_å™ß˘i⁄
->
t_jou∫Æ
->
j_¥iv©e
);

205 
	`•ö_lock
(&
sbi
->
s_md_lock
);

206 
dñëed
 = !
	`li°_em±y
(&
j˚
->
j˚_li°
);

207 
	`li°_dñ_öô
(&
j˚
->
j˚_li°
);

208 
	`•ö_u∆ock
(&
sbi
->
s_md_lock
);

209  
dñëed
;

210 
	}
}

213 
pxt4_m¨k_ûoc_dúty
(
h™dÀ_t
 *
h™dÀ
,

214 
öode
 *inode,

215 
pxt4_ûoc
 *
ûoc
);

222 
pxt4_ª£rve_öode_wrôe
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *inode,

223 
pxt4_ûoc
 *
ûoc
);

225 
pxt4_m¨k_öode_dúty
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *inode);

227 
pxt4_ex∑nd_exåa_isize
(
öode
 *inode,

228 
√w_exåa_isize
,

229 
pxt4_ûoc
 *
ûoc
);

233 
__pxt4_jou∫Æ_gë_wrôe_ac˚ss
(c⁄° *
whîe
, 
löe
,

234 
h™dÀ_t
 *
h™dÀ
, 
buf„r_hód
 *
bh
);

236 
__pxt4_f‹gë
(c⁄° *
whîe
, 
löe
, 
h™dÀ_t
 *
h™dÀ
,

237 
is_mëad©a
, 
öode
 *inode,

238 
buf„r_hód
 *
bh
, 
pxt4_fsblk_t
 
blockƒ
);

240 
__pxt4_jou∫Æ_gë_¸óã_ac˚ss
(c⁄° *
whîe
, 
löe
,

241 
h™dÀ_t
 *
h™dÀ
, 
buf„r_hód
 *
bh
);

243 
__pxt4_h™dÀ_dúty_mëad©a
(c⁄° *
whîe
, 
löe
,

244 
h™dÀ_t
 *
h™dÀ
, 
öode
 *inode,

245 
buf„r_hód
 *
bh
);

247 
__pxt4_h™dÀ_dúty_su≥r
(c⁄° *
whîe
, 
löe
,

248 
h™dÀ_t
 *
h™dÀ
, 
su≥r_block
 *
sb
);

250 
	#pxt4_jou∫Æ_gë_wrôe_ac˚ss
(
h™dÀ
, 
bh
) \

251 
	`__pxt4_jou∫Æ_gë_wrôe_ac˚ss
(
__func__
, 
__LINE__
, (
h™dÀ
), (
bh
))

	)

252 
	#pxt4_f‹gë
(
h™dÀ
, 
is_mëad©a
, 
öode
, 
bh
, 
block_ƒ
) \

253 
	`__pxt4_f‹gë
(
__func__
, 
__LINE__
, (
h™dÀ
), (
is_mëad©a
), (
öode
), \

254 (
bh
), (
block_ƒ
))

	)

255 
	#pxt4_jou∫Æ_gë_¸óã_ac˚ss
(
h™dÀ
, 
bh
) \

256 
	`__pxt4_jou∫Æ_gë_¸óã_ac˚ss
(
__func__
, 
__LINE__
, (
h™dÀ
), (
bh
))

	)

257 
	#pxt4_h™dÀ_dúty_mëad©a
(
h™dÀ
, 
öode
, 
bh
) \

258 
	`__pxt4_h™dÀ_dúty_mëad©a
(
__func__
, 
__LINE__
, (
h™dÀ
), (
öode
), \

259 (
bh
))

	)

260 
	#pxt4_h™dÀ_dúty_su≥r
(
h™dÀ
, 
sb
) \

261 
	`__pxt4_h™dÀ_dúty_su≥r
(
__func__
, 
__LINE__
, (
h™dÀ
), (
sb
))

	)

263 
h™dÀ_t
 *
__pxt4_jou∫Æ_°¨t_sb
(
su≥r_block
 *
sb
, 
löe
,

264 
ty≥
, 
blocks
, 
rsv_blocks
);

265 
__pxt4_jou∫Æ_°›
(c⁄° *
whîe
, 
löe
, 
h™dÀ_t
 *
h™dÀ
);

267 
	#PXT4_NOJOURNAL_MAX_REF_COUNT
 ((Ë4096)

	)

271 
ölöe
 
	$pxt4_h™dÀ_vÆid
(
h™dÀ_t
 *
h™dÀ
)

273 i‡(()
h™dÀ
 < 
PXT4_NOJOURNAL_MAX_REF_COUNT
)

276 
	}
}

278 
ölöe
 
	$pxt4_h™dÀ_sync
(
h™dÀ_t
 *
h™dÀ
)

280 i‡(
	`pxt4_h™dÀ_vÆid
(
h™dÀ
))

281 
h™dÀ
->
h_sync
 = 1;

282 
	}
}

284 
ölöe
 
	$pxt4_h™dÀ_is_ab‹ãd
(
h™dÀ_t
 *
h™dÀ
)

286 i‡(
	`pxt4_h™dÀ_vÆid
(
h™dÀ
))

287  
	`is_h™dÀ_ab‹ãd
(
h™dÀ
);

289 
	}
}

291 
ölöe
 
	$pxt4_h™dÀ_has_íough_¸edôs
(
h™dÀ_t
 *
h™dÀ
, 
√eded
)

293 i‡(
	`pxt4_h™dÀ_vÆid
(
h™dÀ
Ë&& h™dÀ->
h_buf„r_¸edôs
 < 
√eded
)

296 
	}
}

298 
	#pxt4_jou∫Æ_°¨t_sb
(
sb
, 
ty≥
, 
nblocks
) \

299 
	`__pxt4_jou∫Æ_°¨t_sb
((
sb
), 
__LINE__
, (
ty≥
), (
nblocks
), 0)

	)

301 
	#pxt4_jou∫Æ_°¨t
(
öode
, 
ty≥
, 
nblocks
) \

302 
	`__pxt4_jou∫Æ_°¨t
((
öode
), 
__LINE__
, (
ty≥
), (
nblocks
), 0)

	)

304 
	#pxt4_jou∫Æ_°¨t_wôh_ª£rve
(
öode
, 
ty≥
, 
blocks
, 
rsv_blocks
) \

305 
	`__pxt4_jou∫Æ_°¨t
((
öode
), 
__LINE__
, (
ty≥
), (
blocks
), (
rsv_blocks
))

	)

307 
ölöe
 
h™dÀ_t
 *
	$__pxt4_jou∫Æ_°¨t
(
öode
 *inode,

308 
löe
, 
ty≥
,

309 
blocks
, 
rsv_blocks
)

311  
	`__pxt4_jou∫Æ_°¨t_sb
(
öode
->
i_sb
, 
löe
, 
ty≥
, 
blocks
,

312 
rsv_blocks
);

313 
	}
}

315 
	#pxt4_jou∫Æ_°›
(
h™dÀ
) \

316 
	`__pxt4_jou∫Æ_°›
(
__func__
, 
__LINE__
, (
h™dÀ
))

	)

318 
	#pxt4_jou∫Æ_°¨t_ª£rved
(
h™dÀ
, 
ty≥
) \

319 
	`__pxt4_jou∫Æ_°¨t_ª£rved
((
h™dÀ
), 
__LINE__
, (
ty≥
))

	)

321 
h™dÀ_t
 *
__pxt4_jou∫Æ_°¨t_ª£rved
(h™dÀ_à*
h™dÀ
, 
löe
,

322 
ty≥
);

324 
ölöe
 
	$pxt4_jou∫Æ_‰ì_ª£rved
(
h™dÀ_t
 *
h™dÀ
)

326 i‡(
	`pxt4_h™dÀ_vÆid
(
h™dÀ
))

327 
	`jbd3_jou∫Æ_‰ì_ª£rved
(
h™dÀ
);

328 
	}
}

330 
ölöe
 
h™dÀ_t
 *
	$pxt4_jou∫Æ_cuºít_h™dÀ
()

332  
	`jou∫Æ_cuºít_h™dÀ
();

333 
	}
}

335 
ölöe
 
	$pxt4_jou∫Æ_exãnd
(
h™dÀ_t
 *
h™dÀ
, 
nblocks
)

337 i‡(
	`pxt4_h™dÀ_vÆid
(
h™dÀ
))

338  
	`jbd3_jou∫Æ_exãnd
(
h™dÀ
, 
nblocks
);

340 
	}
}

342 
ölöe
 
	$pxt4_jou∫Æ_ª°¨t
(
h™dÀ_t
 *
h™dÀ
, 
nblocks
)

344 i‡(
	`pxt4_h™dÀ_vÆid
(
h™dÀ
))

345  
	`jbd3_jou∫Æ_ª°¨t
(
h™dÀ
, 
nblocks
);

347 
	}
}

349 
ölöe
 
	$pxt4_jou∫Æ_blocks_≥r_∑ge
(
öode
 *inode)

351 i‡(
	`PXT4_JOURNAL
(
öode
Ë!
NULL
)

352  
	`jbd3_jou∫Æ_blocks_≥r_∑ge
(
öode
);

354 
	}
}

356 
ölöe
 
	$pxt4_jou∫Æ_f‹˚_commô
(
jou∫Æ_t
 *
jou∫Æ
)

358 i‡(
jou∫Æ
)

359  
	`jbd3_jou∫Æ_f‹˚_commô
(
jou∫Æ
);

361 
	}
}

363 
ölöe
 
	$pxt4_jbd3_öode_add_wrôe
(
h™dÀ_t
 *
h™dÀ
,

364 
öode
 *öode, 
loff_t
 
°¨t_byã
,Üoff_à
Àngth
)

366 i‡(
	`pxt4_h™dÀ_vÆid
(
h™dÀ
))

367  
	`jbd3_jou∫Æ_öode_ønged_wrôe
(
h™dÀ
,

368 
	`PXT4_I
(
öode
)->
jöode
, 
°¨t_byã
, 
Àngth
);

370 
	}
}

372 
ölöe
 
	$pxt4_jbd3_öode_add_waô
(
h™dÀ_t
 *
h™dÀ
,

373 
öode
 *öode, 
loff_t
 
°¨t_byã
,Üoff_à
Àngth
)

375 i‡(
	`pxt4_h™dÀ_vÆid
(
h™dÀ
))

376  
	`jbd3_jou∫Æ_öode_ønged_waô
(
h™dÀ
,

377 
	`PXT4_I
(
öode
)->
jöode
, 
°¨t_byã
, 
Àngth
);

379 
	}
}

381 
ölöe
 
	$pxt4_upd©e_öode_fsync_å™s
(
h™dÀ_t
 *
h™dÀ
,

382 
öode
 *inode,

383 
d©async
)

385 
pxt4_öode_öfo
 *
ei
 = 
	`PXT4_I
(
öode
);

387 i‡(
	`pxt4_h™dÀ_vÆid
(
h™dÀ
Ë&& !
	`is_h™dÀ_ab‹ãd
(handle)) {

388 
ei
->
i_sync_tid
 = 
h™dÀ
->
h_å™ß˘i⁄
->
t_tid
;

389 i‡(
d©async
)

390 
ei
->
i_d©async_tid
 = 
h™dÀ
->
h_å™ß˘i⁄
->
t_tid
;

392 
	}
}

395 
pxt4_f‹˚_commô
(
su≥r_block
 *
sb
);

400 
	#PXT4_INODE_JOURNAL_DATA_MODE
 0x01

	)

401 
	#PXT4_INODE_ORDERED_DATA_MODE
 0x02

	)

402 
	#PXT4_INODE_WRITEBACK_DATA_MODE
 0x04

	)

404 
ölöe
 
	$pxt4_öode_jou∫Æ_mode
(
öode
 *inode)

406 i‡(
	`PXT4_JOURNAL
(
öode
Ë=
NULL
)

407  
PXT4_INODE_WRITEBACK_DATA_MODE
;

409 i‡(!
	`S_ISREG
(
öode
->
i_mode
) ||

410 
	`ã°_›t
(
öode
->
i_sb
, 
DATA_FLAGS
Ë=
PXT4_MOUNT_JOURNAL_DATA
 ||

411 (
	`pxt4_ã°_öode_Êag
(
öode
, 
PXT4_INODE_JOURNAL_DATA
) &&

412 !
	`ã°_›t
(
öode
->
i_sb
, 
DELALLOC
))) {

414 i‡(
	`S_ISREG
(
öode
->
i_mode
Ë&& 
	`IS_ENCRYPTED
(inode))

415  
PXT4_INODE_ORDERED_DATA_MODE
;

416  
PXT4_INODE_JOURNAL_DATA_MODE
;

418 i‡(
	`ã°_›t
(
öode
->
i_sb
, 
DATA_FLAGS
Ë=
PXT4_MOUNT_ORDERED_DATA
)

419  
PXT4_INODE_ORDERED_DATA_MODE
;

420 i‡(
	`ã°_›t
(
öode
->
i_sb
, 
DATA_FLAGS
Ë=
PXT4_MOUNT_WRITEBACK_DATA
)

421  
PXT4_INODE_WRITEBACK_DATA_MODE
;

422 
	`BUG
();

423 
	}
}

425 
ölöe
 
	$pxt4_should_jou∫Æ_d©a
(
öode
 *inode)

427  
	`pxt4_öode_jou∫Æ_mode
(
öode
Ë& 
PXT4_INODE_JOURNAL_DATA_MODE
;

428 
	}
}

430 
ölöe
 
	$pxt4_should_‹dî_d©a
(
öode
 *inode)

432  
	`pxt4_öode_jou∫Æ_mode
(
öode
Ë& 
PXT4_INODE_ORDERED_DATA_MODE
;

433 
	}
}

435 
ölöe
 
	$pxt4_should_wrôeback_d©a
(
öode
 *inode)

437  
	`pxt4_öode_jou∫Æ_mode
(
öode
Ë& 
PXT4_INODE_WRITEBACK_DATA_MODE
;

438 
	}
}

449 
ölöe
 
	$pxt4_should_di‹ód_nﬁock
(
öode
 *inode)

451 i‡(!
	`ã°_›t
(
öode
->
i_sb
, 
DIOREAD_NOLOCK
))

453 i‡(!
	`S_ISREG
(
öode
->
i_mode
))

455 i‡(!(
	`pxt4_ã°_öode_Êag
(
öode
, 
PXT4_INODE_EXTENTS
)))

457 i‡(
	`pxt4_should_jou∫Æ_d©a
(
öode
))

460 
	}
}

	@extents.c

20 
	~<löux/fs.h
>

21 
	~<löux/time.h
>

22 
	~<löux/jbd3.h
>

23 
	~<löux/highuid.h
>

24 
	~<löux/∑gem≠.h
>

25 
	~<löux/quŸa›s.h
>

26 
	~<löux/°rög.h
>

27 
	~<löux/¶ab.h
>

28 
	~<löux/uac˚ss.h
>

29 
	~<löux/fõm≠.h
>

30 
	~<löux/backög-dev.h
>

31 
	~"pxt4_jbd3.h
"

32 
	~"pxt4_exã¡s.h
"

33 
	~"x©å.h
"

35 
	~<åa˚/evíts/pxt4.h
>

40 
	#PXT4_EXT_MAY_ZEROOUT
 0x1

	)

42 
	#PXT4_EXT_MARK_UNWRIT1
 0x2

	)

43 
	#PXT4_EXT_MARK_UNWRIT2
 0x4

	)

45 
	#PXT4_EXT_DATA_VALID1
 0x8

	)

46 
	#PXT4_EXT_DATA_VALID2
 0x10

	)

48 
__À32
 
	$pxt4_exã¡_block_csum
(
öode
 *inode,

49 
pxt4_exã¡_hódî
 *
eh
)

51 
pxt4_öode_öfo
 *
ei
 = 
	`PXT4_I
(
öode
);

52 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
öode
->
i_sb
);

53 
__u32
 
csum
;

55 
csum
 = 
	`pxt4_chksum
(
sbi
, 
ei
->
i_csum_£ed
, (
__u8
 *)
eh
,

56 
	`PXT4_EXTENT_TAIL_OFFSET
(
eh
));

57  
	`˝u_to_À32
(
csum
);

58 
	}
}

60 
	$pxt4_exã¡_block_csum_vîify
(
öode
 *inode,

61 
pxt4_exã¡_hódî
 *
eh
)

63 
pxt4_exã¡_èû
 *
ë
;

65 i‡(!
	`pxt4_has_mëad©a_csum
(
öode
->
i_sb
))

68 
ë
 = 
	`föd_pxt4_exã¡_èû
(
eh
);

69 i‡(
ë
->
ë_checksum
 !
	`pxt4_exã¡_block_csum
(
öode
, 
eh
))

72 
	}
}

74 
	$pxt4_exã¡_block_csum_£t
(
öode
 *inode,

75 
pxt4_exã¡_hódî
 *
eh
)

77 
pxt4_exã¡_èû
 *
ë
;

79 i‡(!
	`pxt4_has_mëad©a_csum
(
öode
->
i_sb
))

82 
ë
 = 
	`föd_pxt4_exã¡_èû
(
eh
);

83 
ë
->
ë_checksum
 = 
	`pxt4_exã¡_block_csum
(
öode
, 
eh
);

84 
	}
}

86 
pxt4_•lô_exã¡
(
h™dÀ_t
 *
h™dÀ
,

87 
öode
 *inode,

88 
pxt4_ext_∑th
 **
µ©h
,

89 
pxt4_m≠_blocks
 *
m≠
,

90 
•lô_Êag
,

91 
Êags
);

93 
pxt4_•lô_exã¡_©
(
h™dÀ_t
 *
h™dÀ
,

94 
öode
 *inode,

95 
pxt4_ext_∑th
 **
µ©h
,

96 
pxt4_lblk_t
 
•lô
,

97 
•lô_Êag
,

98 
Êags
);

100 
pxt4_föd_dñayed_exã¡
(
öode
 *inode,

101 
exã¡_°©us
 *
√wes
);

103 
	$pxt4_ext_åunˇã_exãnd_ª°¨t
(
h™dÀ_t
 *
h™dÀ
,

104 
öode
 *inode,

105 
√eded
)

107 
îr
;

109 i‡(!
	`pxt4_h™dÀ_vÆid
(
h™dÀ
))

111 i‡(
h™dÀ
->
h_buf„r_¸edôs
 >
√eded
)

117 
√eded
 += 3;

118 
îr
 = 
	`pxt4_jou∫Æ_exãnd
(
h™dÀ
, 
√eded
 - h™dÀ->
h_buf„r_¸edôs
);

119 i‡(
îr
 <= 0)

120  
îr
;

121 
îr
 = 
	`pxt4_åunˇã_ª°¨t_å™s
(
h™dÀ
, 
öode
, 
√eded
);

122 i‡(
îr
 == 0)

123 
îr
 = -
EAGAIN
;

125  
îr
;

126 
	}
}

133 
	$pxt4_ext_gë_ac˚ss
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *inode,

134 
pxt4_ext_∑th
 *
∑th
)

136 i‡(
∑th
->
p_bh
) {

138 
	`BUFFER_TRACE
(
∑th
->
p_bh
, "get_write_access");

139  
	`pxt4_jou∫Æ_gë_wrôe_ac˚ss
(
h™dÀ
, 
∑th
->
p_bh
);

144 
	}
}

152 
	$__pxt4_ext_dúty
(c⁄° *
whîe
, 
löe
, 
h™dÀ_t
 *
h™dÀ
,

153 
öode
 *öode, 
pxt4_ext_∑th
 *
∑th
)

155 
îr
;

157 
	`WARN_ON
(!
	`rw£m_is_locked
(&
	`PXT4_I
(
öode
)->
i_d©a_£m
));

158 i‡(
∑th
->
p_bh
) {

159 
	`pxt4_exã¡_block_csum_£t
(
öode
, 
	`ext_block_hdr
(
∑th
->
p_bh
));

161 
îr
 = 
	`__pxt4_h™dÀ_dúty_mëad©a
(
whîe
, 
löe
, 
h™dÀ
,

162 
öode
, 
∑th
->
p_bh
);

165 
îr
 = 
	`pxt4_m¨k_öode_dúty
(
h™dÀ
, 
öode
);

167  
îr
;

168 
	}
}

170 
pxt4_fsblk_t
 
	$pxt4_ext_föd_gﬂl
(
öode
 *inode,

171 
pxt4_ext_∑th
 *
∑th
,

172 
pxt4_lblk_t
 
block
)

174 i‡(
∑th
) {

175 
dïth
 = 
∑th
->
p_dïth
;

176 
pxt4_exã¡
 *
ex
;

195 
ex
 = 
∑th
[
dïth
].
p_ext
;

196 i‡(
ex
) {

197 
pxt4_fsblk_t
 
ext_pblk
 = 
	`pxt4_ext_pblock
(
ex
);

198 
pxt4_lblk_t
 
ext_block
 = 
	`À32_to_˝u
(
ex
->
ì_block
);

200 i‡(
block
 > 
ext_block
)

201  
ext_pblk
 + (
block
 - 
ext_block
);

203  
ext_pblk
 - (
ext_block
 - 
block
);

208 i‡(
∑th
[
dïth
].
p_bh
)

209  
∑th
[
dïth
].
p_bh
->
b_blockƒ
;

213  
	`pxt4_öode_to_gﬂl_block
(
öode
);

214 
	}
}

219 
pxt4_fsblk_t


220 
	$pxt4_ext_√w_mëa_block
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *inode,

221 
pxt4_ext_∑th
 *
∑th
,

222 
pxt4_exã¡
 *
ex
, *
îr
, 
Êags
)

224 
pxt4_fsblk_t
 
gﬂl
, 
√wblock
;

226 
gﬂl
 = 
	`pxt4_ext_föd_gﬂl
(
öode
, 
∑th
, 
	`À32_to_˝u
(
ex
->
ì_block
));

227 
√wblock
 = 
	`pxt4_√w_mëa_blocks
(
h™dÀ
, 
öode
, 
gﬂl
, 
Êags
,

228 
NULL
, 
îr
);

229  
√wblock
;

230 
	}
}

232 
ölöe
 
	$pxt4_ext_•a˚_block
(
öode
 *öode, 
check
)

234 
size
;

236 
size
 = (
öode
->
i_sb
->
s_blocksize
 - (
pxt4_exã¡_hódî
))

237 / (
pxt4_exã¡
);

238 #ifde‡
AGGRESSIVE_TEST


239 i‡(!
check
 && 
size
 > 6)

240 
size
 = 6;

242  
size
;

243 
	}
}

245 
ölöe
 
	$pxt4_ext_•a˚_block_idx
(
öode
 *öode, 
check
)

247 
size
;

249 
size
 = (
öode
->
i_sb
->
s_blocksize
 - (
pxt4_exã¡_hódî
))

250 / (
pxt4_exã¡_idx
);

251 #ifde‡
AGGRESSIVE_TEST


252 i‡(!
check
 && 
size
 > 5)

253 
size
 = 5;

255  
size
;

256 
	}
}

258 
ölöe
 
	$pxt4_ext_•a˚_roŸ
(
öode
 *öode, 
check
)

260 
size
;

262 
size
 = (
	`PXT4_I
(
öode
)->
i_d©a
);

263 
size
 -(
pxt4_exã¡_hódî
);

264 
size
 /(
pxt4_exã¡
);

265 #ifde‡
AGGRESSIVE_TEST


266 i‡(!
check
 && 
size
 > 3)

267 
size
 = 3;

269  
size
;

270 
	}
}

272 
ölöe
 
	$pxt4_ext_•a˚_roŸ_idx
(
öode
 *öode, 
check
)

274 
size
;

276 
size
 = (
	`PXT4_I
(
öode
)->
i_d©a
);

277 
size
 -(
pxt4_exã¡_hódî
);

278 
size
 /(
pxt4_exã¡_idx
);

279 #ifde‡
AGGRESSIVE_TEST


280 i‡(!
check
 && 
size
 > 4)

281 
size
 = 4;

283  
size
;

284 
	}
}

286 
ölöe
 

287 
	$pxt4_f‹˚_•lô_exã¡_©
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *inode,

288 
pxt4_ext_∑th
 **
µ©h
, 
pxt4_lblk_t
 
lblk
,

289 
noÁû
)

291 
pxt4_ext_∑th
 *
∑th
 = *
µ©h
;

292 
unwrôãn
 = 
	`pxt4_ext_is_unwrôãn
(
∑th
[∑th->
p_dïth
].
p_ext
);

294  
	`pxt4_•lô_exã¡_©
(
h™dÀ
, 
öode
, 
µ©h
, 
lblk
, 
unwrôãn
 ?

295 
PXT4_EXT_MARK_UNWRIT1
|
PXT4_EXT_MARK_UNWRIT2
 : 0,

296 
PXT4_EX_NOCACHE
 | 
PXT4_GET_BLOCKS_PRE_IO
 |

297 (
noÁû
 ? 
PXT4_GET_BLOCKS_METADATA_NOFAIL
:0));

298 
	}
}

305 
	$pxt4_ext_ˇlc_mëad©a_amou¡
(
öode
 *öode, 
pxt4_lblk_t
 
lblock
)

307 
pxt4_öode_öfo
 *
ei
 = 
	`PXT4_I
(
öode
);

308 
idxs
;

310 
idxs
 = ((
öode
->
i_sb
->
s_blocksize
 - (
pxt4_exã¡_hódî
))

311 / (
pxt4_exã¡_idx
));

321 i‡(
ei
->
i_da_mëad©a_ˇlc_Àn
 &&

322 
ei
->
i_da_mëad©a_ˇlc_œ°_lblock
+1 =
lblock
) {

323 
num
 = 0;

325 i‡((
ei
->
i_da_mëad©a_ˇlc_Àn
 % 
idxs
) == 0)

326 
num
++;

327 i‡((
ei
->
i_da_mëad©a_ˇlc_Àn
 % (
idxs
*idxs)) == 0)

328 
num
++;

329 i‡((
ei
->
i_da_mëad©a_ˇlc_Àn
 % (
idxs
*idxs*idxs)) == 0) {

330 
num
++;

331 
ei
->
i_da_mëad©a_ˇlc_Àn
 = 0;

333 
ei
->
i_da_mëad©a_ˇlc_Àn
++;

334 
ei
->
i_da_mëad©a_ˇlc_œ°_lblock
++;

335  
num
;

342 
ei
->
i_da_mëad©a_ˇlc_Àn
 = 1;

343 
ei
->
i_da_mëad©a_ˇlc_œ°_lblock
 = 
lblock
;

344  
	`ext_dïth
(
öode
) + 1;

345 
	}
}

348 
	$pxt4_ext_max_íåõs
(
öode
 *öode, 
dïth
)

350 
max
;

352 i‡(
dïth
 =
	`ext_dïth
(
öode
)) {

353 i‡(
dïth
 == 0)

354 
max
 = 
	`pxt4_ext_•a˚_roŸ
(
öode
, 1);

356 
max
 = 
	`pxt4_ext_•a˚_roŸ_idx
(
öode
, 1);

358 i‡(
dïth
 == 0)

359 
max
 = 
	`pxt4_ext_•a˚_block
(
öode
, 1);

361 
max
 = 
	`pxt4_ext_•a˚_block_idx
(
öode
, 1);

364  
max
;

365 
	}
}

367 
	$pxt4_vÆid_exã¡
(
öode
 *öode, 
pxt4_exã¡
 *
ext
)

369 
pxt4_fsblk_t
 
block
 = 
	`pxt4_ext_pblock
(
ext
);

370 
Àn
 = 
	`pxt4_ext_gë_a˘uÆ_Àn
(
ext
);

371 
pxt4_lblk_t
 
lblock
 = 
	`À32_to_˝u
(
ext
->
ì_block
);

378 i‡(
lblock
 + 
Àn
 <=Üblock)

380  
	`pxt4_d©a_block_vÆid
(
	`PXT4_SB
(
öode
->
i_sb
), 
block
, 
Àn
);

381 
	}
}

383 
	$pxt4_vÆid_exã¡_idx
(
öode
 *inode,

384 
pxt4_exã¡_idx
 *
ext_idx
)

386 
pxt4_fsblk_t
 
block
 = 
	`pxt4_idx_pblock
(
ext_idx
);

388  
	`pxt4_d©a_block_vÆid
(
	`PXT4_SB
(
öode
->
i_sb
), 
block
, 1);

389 
	}
}

391 
	$pxt4_vÆid_exã¡_íåõs
(
öode
 *inode,

392 
pxt4_exã¡_hódî
 *
eh
,

393 
dïth
)

395 
íåõs
;

396 i‡(
eh
->
eh_íåõs
 == 0)

399 
íåõs
 = 
	`À16_to_˝u
(
eh
->
eh_íåõs
);

401 i‡(
dïth
 == 0) {

403 
pxt4_exã¡
 *
ext
 = 
	`EXT_FIRST_EXTENT
(
eh
);

404 
pxt4_su≥r_block
 *
es
 = 
	`PXT4_SB
(
öode
->
i_sb
)->
s_es
;

405 
pxt4_fsblk_t
 
pblock
 = 0;

406 
pxt4_lblk_t
 
lblock
 = 0;

407 
pxt4_lblk_t
 
¥ev
 = 0;

408 
Àn
 = 0;

409 
íåõs
) {

410 i‡(!
	`pxt4_vÆid_exã¡
(
öode
, 
ext
))

414 
lblock
 = 
	`À32_to_˝u
(
ext
->
ì_block
);

415 
Àn
 = 
	`pxt4_ext_gë_a˘uÆ_Àn
(
ext
);

416 i‡((
lblock
 <
¥ev
) &&Örev) {

417 
pblock
 = 
	`pxt4_ext_pblock
(
ext
);

418 
es
->
s_œ°_îr‹_block
 = 
	`˝u_to_À64
(
pblock
);

421 
ext
++;

422 
íåõs
--;

423 
¥ev
 = 
lblock
 + 
Àn
 - 1;

426 
pxt4_exã¡_idx
 *
ext_idx
 = 
	`EXT_FIRST_INDEX
(
eh
);

427 
íåõs
) {

428 i‡(!
	`pxt4_vÆid_exã¡_idx
(
öode
, 
ext_idx
))

430 
ext_idx
++;

431 
íåõs
--;

435 
	}
}

437 
	$__pxt4_ext_check
(c⁄° *
fun˘i⁄
, 
löe
,

438 
öode
 *öode, 
pxt4_exã¡_hódî
 *
eh
,

439 
dïth
, 
pxt4_fsblk_t
 
pblk
)

441 c⁄° *
îr‹_msg
;

442 
max
 = 0, 
îr
 = -
EFSCORRUPTED
;

444 i‡(
	`u∆ikñy
(
eh
->
eh_magic
 !
PXT4_EXT_MAGIC
)) {

445 
îr‹_msg
 = "invalid magic";

446 
c‹ru±ed
;

448 i‡(
	`u∆ikñy
(
	`À16_to_˝u
(
eh
->
eh_dïth
Ë!
dïth
)) {

449 
îr‹_msg
 = "unexpectedÉh_depth";

450 
c‹ru±ed
;

452 i‡(
	`u∆ikñy
(
eh
->
eh_max
 == 0)) {

453 
îr‹_msg
 = "invalidÉh_max";

454 
c‹ru±ed
;

456 
max
 = 
	`pxt4_ext_max_íåõs
(
öode
, 
dïth
);

457 i‡(
	`u∆ikñy
(
	`À16_to_˝u
(
eh
->
eh_max
Ë> 
max
)) {

458 
îr‹_msg
 = "tooÜargeÉh_max";

459 
c‹ru±ed
;

461 i‡(
	`u∆ikñy
(
	`À16_to_˝u
(
eh
->
eh_íåõs
Ë>Üe16_to_˝u”h->
eh_max
))) {

462 
îr‹_msg
 = "invalidÉh_entries";

463 
c‹ru±ed
;

465 i‡(!
	`pxt4_vÆid_exã¡_íåõs
(
öode
, 
eh
, 
dïth
)) {

466 
îr‹_msg
 = "invalidÉxtentÉntries";

467 
c‹ru±ed
;

469 i‡(
	`u∆ikñy
(
dïth
 > 32)) {

470 
îr‹_msg
 = "tooÜargeÉh_depth";

471 
c‹ru±ed
;

474 i‡(
	`ext_dïth
(
öode
Ë!
dïth
 &&

475 !
	`pxt4_exã¡_block_csum_vîify
(
öode
, 
eh
)) {

476 
îr‹_msg
 = "extentÅree corrupted";

477 
îr
 = -
EFSBADCRC
;

478 
c‹ru±ed
;

482 
c‹ru±ed
:

483 
	`pxt4_îr‹_öode
(
öode
, 
fun˘i⁄
, 
löe
, 0,

486 (Ë
pblk
, 
îr‹_msg
,

487 
	`À16_to_˝u
(
eh
->
eh_magic
),

488 
	`À16_to_˝u
(
eh
->
eh_íåõs
),Üe16_to_˝u”h->
eh_max
),

489 
max
, 
	`À16_to_˝u
(
eh
->
eh_dïth
), 
dïth
);

490  
îr
;

491 
	}
}

493 
	#pxt4_ext_check
(
öode
, 
eh
, 
dïth
, 
pblk
) \

494 
	`__pxt4_ext_check
(
__func__
, 
__LINE__
, (
öode
), (
eh
), (
dïth
), (
pblk
))

	)

496 
	$pxt4_ext_check_öode
(
öode
 *inode)

498  
	`pxt4_ext_check
(
öode
, 
	`ext_öode_hdr
(öode), 
	`ext_dïth
(inode), 0);

499 
	}
}

501 
	$pxt4_ˇche_exã¡s
(
öode
 *inode,

502 
pxt4_exã¡_hódî
 *
eh
)

504 
pxt4_exã¡
 *
ex
 = 
	`EXT_FIRST_EXTENT
(
eh
);

505 
pxt4_lblk_t
 
¥ev
 = 0;

506 
i
;

508 
i
 = 
	`À16_to_˝u
(
eh
->
eh_íåõs
); i > 0; i--, 
ex
++) {

509 
°©us
 = 
EXTENT_STATUS_WRITTEN
;

510 
pxt4_lblk_t
 
lblk
 = 
	`À32_to_˝u
(
ex
->
ì_block
);

511 
Àn
 = 
	`pxt4_ext_gë_a˘uÆ_Àn
(
ex
);

513 i‡(
¥ev
 && (¥ev !
lblk
))

514 
	`pxt4_es_ˇche_exã¡
(
öode
, 
¥ev
, 
lblk
 -Örev, ~0,

515 
EXTENT_STATUS_HOLE
);

517 i‡(
	`pxt4_ext_is_unwrôãn
(
ex
))

518 
°©us
 = 
EXTENT_STATUS_UNWRITTEN
;

519 
	`pxt4_es_ˇche_exã¡
(
öode
, 
lblk
, 
Àn
,

520 
	`pxt4_ext_pblock
(
ex
), 
°©us
);

521 
¥ev
 = 
lblk
 + 
Àn
;

523 
	}
}

525 
buf„r_hód
 *

526 
	$__ªad_exã¡_åì_block
(c⁄° *
fun˘i⁄
, 
löe
,

527 
öode
 *öode, 
pxt4_fsblk_t
 
pblk
, 
dïth
,

528 
Êags
)

530 
buf„r_hód
 *
bh
;

531 
îr
;

533 
bh
 = 
	`sb_gëblk_gÂ
(
öode
->
i_sb
, 
pblk
, 
__GFP_MOVABLE
 | 
GFP_NOFS
);

534 i‡(
	`u∆ikñy
(!
bh
))

535  
	`ERR_PTR
(-
ENOMEM
);

537 i‡(!
	`bh_u±od©e_‹_lock
(
bh
)) {

538 
	`åa˚_pxt4_ext_lﬂd_exã¡
(
öode
, 
pblk
, 
_RET_IP_
);

539 
îr
 = 
	`bh_submô_ªad
(
bh
);

540 i‡(
îr
 < 0)

541 
îrout
;

543 i‡(
	`buf„r_vîifõd
(
bh
Ë&& !(
Êags
 & 
PXT4_EX_FORCE_CACHE
))

544  
bh
;

545 i‡(!
	`pxt4_has_„©uª_jou∫Æ
(
öode
->
i_sb
) ||

546 (
öode
->
i_öo
 !=

547 
	`À32_to_˝u
(
	`PXT4_SB
(
öode
->
i_sb
)->
s_es
->
s_jou∫Æ_öum
))) {

548 
îr
 = 
	`__pxt4_ext_check
(
fun˘i⁄
, 
löe
, 
öode
,

549 
	`ext_block_hdr
(
bh
), 
dïth
, 
pblk
);

550 i‡(
îr
)

551 
îrout
;

553 
	`£t_buf„r_vîifõd
(
bh
);

557 i‡(!(
Êags
 & 
PXT4_EX_NOCACHE
Ë&& 
dïth
 == 0) {

558 
pxt4_exã¡_hódî
 *
eh
 = 
	`ext_block_hdr
(
bh
);

559 
	`pxt4_ˇche_exã¡s
(
öode
, 
eh
);

561  
bh
;

562 
îrout
:

563 
	`put_bh
(
bh
);

564  
	`ERR_PTR
(
îr
);

566 
	}
}

568 
	#ªad_exã¡_åì_block
(
öode
, 
pblk
, 
dïth
, 
Êags
) \

569 
	`__ªad_exã¡_åì_block
(
__func__
, 
__LINE__
, (
öode
), (
pblk
), \

570 (
dïth
), (
Êags
))

	)

576 
	$pxt4_ext_¥eˇche
(
öode
 *inode)

578 
pxt4_öode_öfo
 *
ei
 = 
	`PXT4_I
(
öode
);

579 
pxt4_ext_∑th
 *
∑th
 = 
NULL
;

580 
buf„r_hód
 *
bh
;

581 
i
 = 0, 
dïth
, 
ªt
 = 0;

583 i‡(!
	`pxt4_ã°_öode_Êag
(
öode
, 
PXT4_INODE_EXTENTS
))

586 
	`down_ªad
(&
ei
->
i_d©a_£m
);

587 
dïth
 = 
	`ext_dïth
(
öode
);

589 
∑th
 = 
	`kˇŒoc
(
dïth
 + 1, (
pxt4_ext_∑th
),

590 
GFP_NOFS
);

591 i‡(
∑th
 =
NULL
) {

592 
	`up_ªad
(&
ei
->
i_d©a_£m
);

593  -
ENOMEM
;

597 i‡(
dïth
 == 0)

598 
out
;

599 
∑th
[0].
p_hdr
 = 
	`ext_öode_hdr
(
öode
);

600 
ªt
 = 
	`pxt4_ext_check
(
öode
, 
∑th
[0].
p_hdr
, 
dïth
, 0);

601 i‡(
ªt
)

602 
out
;

603 
∑th
[0].
p_idx
 = 
	`EXT_FIRST_INDEX
’©h[0].
p_hdr
);

604 
i
 >= 0) {

609 i‡((
i
 =
dïth
) ||

610 
∑th
[
i
].
p_idx
 > 
	`EXT_LAST_INDEX
’©h[i].
p_hdr
)) {

611 
	`bªl£
(
∑th
[
i
].
p_bh
);

612 
∑th
[
i
].
p_bh
 = 
NULL
;

613 
i
--;

616 
bh
 = 
	`ªad_exã¡_åì_block
(
öode
,

617 
	`pxt4_idx_pblock
(
∑th
[
i
].
p_idx
++),

618 
dïth
 - 
i
 - 1,

619 
PXT4_EX_FORCE_CACHE
);

620 i‡(
	`IS_ERR
(
bh
)) {

621 
ªt
 = 
	`PTR_ERR
(
bh
);

624 
i
++;

625 
∑th
[
i
].
p_bh
 = 
bh
;

626 
∑th
[
i
].
p_hdr
 = 
	`ext_block_hdr
(
bh
);

627 
∑th
[
i
].
p_idx
 = 
	`EXT_FIRST_INDEX
’©h[i].
p_hdr
);

629 
	`pxt4_£t_öode_°©e
(
öode
, 
PXT4_STATE_EXT_PRECACHED
);

630 
out
:

631 
	`up_ªad
(&
ei
->
i_d©a_£m
);

632 
	`pxt4_ext_dr›_ªfs
(
∑th
);

633 
	`k‰ì
(
∑th
);

634  
ªt
;

635 
	}
}

637 #ifde‡
EXT_DEBUG


638 
	$pxt4_ext_show_∑th
(
öode
 *öode, 
pxt4_ext_∑th
 *
∑th
)

640 
k
, 
l
 = 
∑th
->
p_dïth
;

642 
	`ext_debug
("path:");

643 
k
 = 0; k <
l
; k++, 
∑th
++) {

644 i‡(
∑th
->
p_idx
) {

645 
	`ext_debug
(" %d->%Œu", 
	`À32_to_˝u
(
∑th
->
p_idx
->
ei_block
),

646 
	`pxt4_idx_pblock
(
∑th
->
p_idx
));

647 } i‡(
∑th
->
p_ext
) {

648 
	`ext_debug
(" %d:[%d]%d:%llu ",

649 
	`À32_to_˝u
(
∑th
->
p_ext
->
ì_block
),

650 
	`pxt4_ext_is_unwrôãn
(
∑th
->
p_ext
),

651 
	`pxt4_ext_gë_a˘uÆ_Àn
(
∑th
->
p_ext
),

652 
	`pxt4_ext_pblock
(
∑th
->
p_ext
));

654 
	`ext_debug
(" []");

656 
	`ext_debug
("\n");

657 
	}
}

659 
	$pxt4_ext_show_Àaf
(
öode
 *öode, 
pxt4_ext_∑th
 *
∑th
)

661 
dïth
 = 
	`ext_dïth
(
öode
);

662 
pxt4_exã¡_hódî
 *
eh
;

663 
pxt4_exã¡
 *
ex
;

664 
i
;

666 i‡(!
∑th
)

669 
eh
 = 
∑th
[
dïth
].
p_hdr
;

670 
ex
 = 
	`EXT_FIRST_EXTENT
(
eh
);

672 
	`ext_debug
("Di•œyögÜó‡exã¡†f‹ inodê%lu\n", 
öode
->
i_öo
);

674 
i
 = 0; i < 
	`À16_to_˝u
(
eh
->
eh_íåõs
); i++, 
ex
++) {

675 
	`ext_debug
("%d:[%d]%d:%Œu ", 
	`À32_to_˝u
(
ex
->
ì_block
),

676 
	`pxt4_ext_is_unwrôãn
(
ex
),

677 
	`pxt4_ext_gë_a˘uÆ_Àn
(
ex
), 
	`pxt4_ext_pblock
(ex));

679 
	`ext_debug
("\n");

680 
	}
}

682 
	$pxt4_ext_show_move
(
öode
 *öode, 
pxt4_ext_∑th
 *
∑th
,

683 
pxt4_fsblk_t
 
√wblock
, 
Àvñ
)

685 
dïth
 = 
	`ext_dïth
(
öode
);

686 
pxt4_exã¡
 *
ex
;

688 i‡(
dïth
 !
Àvñ
) {

689 
pxt4_exã¡_idx
 *
idx
;

690 
idx
 = 
∑th
[
Àvñ
].
p_idx
;

691 
idx
 <
	`EXT_MAX_INDEX
(
∑th
[
Àvñ
].
p_hdr
)) {

692 
	`ext_debug
("%d: movê%d:%Œu i¿√w index %Œu\n", 
Àvñ
,

693 
	`À32_to_˝u
(
idx
->
ei_block
),

694 
	`pxt4_idx_pblock
(
idx
),

695 
√wblock
);

696 
idx
++;

702 
ex
 = 
∑th
[
dïth
].
p_ext
;

703 
ex
 <
	`EXT_MAX_EXTENT
(
∑th
[
dïth
].
p_hdr
)) {

704 
	`ext_debug
("move %d:%llu:[%d]%d inÇewÜeaf %llu\n",

705 
	`À32_to_˝u
(
ex
->
ì_block
),

706 
	`pxt4_ext_pblock
(
ex
),

707 
	`pxt4_ext_is_unwrôãn
(
ex
),

708 
	`pxt4_ext_gë_a˘uÆ_Àn
(
ex
),

709 
√wblock
);

710 
ex
++;

712 
	}
}

715 
	#pxt4_ext_show_∑th
(
öode
, 
∑th
)

	)

716 
	#pxt4_ext_show_Àaf
(
öode
, 
∑th
)

	)

717 
	#pxt4_ext_show_move
(
öode
, 
∑th
, 
√wblock
, 
Àvñ
)

	)

720 
	$pxt4_ext_dr›_ªfs
(
pxt4_ext_∑th
 *
∑th
)

722 
dïth
, 
i
;

724 i‡(!
∑th
)

726 
dïth
 = 
∑th
->
p_dïth
;

727 
i
 = 0; i <
dïth
; i++, 
∑th
++)

728 i‡(
∑th
->
p_bh
) {

729 
	`bªl£
(
∑th
->
p_bh
);

730 
∑th
->
p_bh
 = 
NULL
;

732 
	}
}

740 
	$pxt4_ext_bö£¨ch_idx
(
öode
 *inode,

741 
pxt4_ext_∑th
 *
∑th
, 
pxt4_lblk_t
 
block
)

743 
pxt4_exã¡_hódî
 *
eh
 = 
∑th
->
p_hdr
;

744 
pxt4_exã¡_idx
 *
r
, *
l
, *
m
;

747 
	`ext_debug
("bö£¨ch f‹ %u(idx): ", 
block
);

749 
l
 = 
	`EXT_FIRST_INDEX
(
eh
) + 1;

750 
r
 = 
	`EXT_LAST_INDEX
(
eh
);

751 
l
 <
r
) {

752 
m
 = 
l
 + (
r
 -Ü) / 2;

753 i‡(
block
 < 
	`À32_to_˝u
(
m
->
ei_block
))

754 
r
 = 
m
 - 1;

756 
l
 = 
m
 + 1;

757 
	`ext_debug
("%p(%u):%p(%u):%p(%uË", 
l
, 
	`À32_to_˝u
÷->
ei_block
),

758 
m
, 
	`À32_to_˝u
(m->
ei_block
),

759 
r
, 
	`À32_to_˝u
‘->
ei_block
));

762 
∑th
->
p_idx
 = 
l
 - 1;

763 
	`ext_debug
(" -> %u->%Œd ", 
	`À32_to_˝u
(
∑th
->
p_idx
->
ei_block
),

764 
	`pxt4_idx_pblock
(
∑th
->
p_idx
));

766 #ifde‡
CHECK_BINSEARCH


768 
pxt4_exã¡_idx
 *
chix
, *
ix
;

769 
k
;

771 
chix
 = 
ix
 = 
	`EXT_FIRST_INDEX
(
eh
);

772 
k
 = 0; k < 
	`À16_to_˝u
(
eh
->
eh_íåõs
); k++, 
ix
++) {

773 i‡(
k
 != 0 &&

774 
	`À32_to_˝u
(
ix
->
ei_block
) <=Üe32_to_cpu(ix[-1].ei_block)) {

775 
	`¥ötk
(
KERN_DEBUG
 "k=%d, ix=0x%p, "

776 "fú°=0x%p\n", 
k
,

777 
ix
, 
	`EXT_FIRST_INDEX
(
eh
));

778 
	`¥ötk
(
KERN_DEBUG
 "%u <= %u\n",

779 
	`À32_to_˝u
(
ix
->
ei_block
),

780 
	`À32_to_˝u
(
ix
[-1].
ei_block
));

782 
	`BUG_ON
(
k
 && 
	`À32_to_˝u
(
ix
->
ei_block
)

783 <
	`À32_to_˝u
(
ix
[-1].
ei_block
));

784 i‡(
block
 < 
	`À32_to_˝u
(
ix
->
ei_block
))

786 
chix
 = 
ix
;

788 
	`BUG_ON
(
chix
 !
∑th
->
p_idx
);

792 
	}
}

800 
	$pxt4_ext_bö£¨ch
(
öode
 *inode,

801 
pxt4_ext_∑th
 *
∑th
, 
pxt4_lblk_t
 
block
)

803 
pxt4_exã¡_hódî
 *
eh
 = 
∑th
->
p_hdr
;

804 
pxt4_exã¡
 *
r
, *
l
, *
m
;

806 i‡(
eh
->
eh_íåõs
 == 0) {

814 
	`ext_debug
("bö£¨ch f‹ %u: ", 
block
);

816 
l
 = 
	`EXT_FIRST_EXTENT
(
eh
) + 1;

817 
r
 = 
	`EXT_LAST_EXTENT
(
eh
);

819 
l
 <
r
) {

820 
m
 = 
l
 + (
r
 -Ü) / 2;

821 i‡(
block
 < 
	`À32_to_˝u
(
m
->
ì_block
))

822 
r
 = 
m
 - 1;

824 
l
 = 
m
 + 1;

825 
	`ext_debug
("%p(%u):%p(%u):%p(%uË", 
l
, 
	`À32_to_˝u
÷->
ì_block
),

826 
m
, 
	`À32_to_˝u
(m->
ì_block
),

827 
r
, 
	`À32_to_˝u
‘->
ì_block
));

830 
∑th
->
p_ext
 = 
l
 - 1;

831 
	`ext_debug
(" -> %d:%llu:[%d]%d ",

832 
	`À32_to_˝u
(
∑th
->
p_ext
->
ì_block
),

833 
	`pxt4_ext_pblock
(
∑th
->
p_ext
),

834 
	`pxt4_ext_is_unwrôãn
(
∑th
->
p_ext
),

835 
	`pxt4_ext_gë_a˘uÆ_Àn
(
∑th
->
p_ext
));

837 #ifde‡
CHECK_BINSEARCH


839 
pxt4_exã¡
 *
chex
, *
ex
;

840 
k
;

842 
chex
 = 
ex
 = 
	`EXT_FIRST_EXTENT
(
eh
);

843 
k
 = 0; k < 
	`À16_to_˝u
(
eh
->
eh_íåõs
); k++, 
ex
++) {

844 
	`BUG_ON
(
k
 && 
	`À32_to_˝u
(
ex
->
ì_block
)

845 <
	`À32_to_˝u
(
ex
[-1].
ì_block
));

846 i‡(
block
 < 
	`À32_to_˝u
(
ex
->
ì_block
))

848 
chex
 = 
ex
;

850 
	`BUG_ON
(
chex
 !
∑th
->
p_ext
);

854 
	}
}

856 
	$pxt4_ext_åì_öô
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *inode)

858 
pxt4_exã¡_hódî
 *
eh
;

860 
eh
 = 
	`ext_öode_hdr
(
öode
);

861 
eh
->
eh_dïth
 = 0;

862 
eh
->
eh_íåõs
 = 0;

863 
eh
->
eh_magic
 = 
PXT4_EXT_MAGIC
;

864 
eh
->
eh_max
 = 
	`˝u_to_À16
(
	`pxt4_ext_•a˚_roŸ
(
öode
, 0));

865 
eh
->
eh_gíî©i⁄
 = 0;

866 
	`pxt4_m¨k_öode_dúty
(
h™dÀ
, 
öode
);

868 
	}
}

870 
pxt4_ext_∑th
 *

871 
	$pxt4_föd_exã¡
(
öode
 *öode, 
pxt4_lblk_t
 
block
,

872 
pxt4_ext_∑th
 **
‹ig_∑th
, 
Êags
)

874 
pxt4_exã¡_hódî
 *
eh
;

875 
buf„r_hód
 *
bh
;

876 
pxt4_ext_∑th
 *
∑th
 = 
‹ig_∑th
 ? *‹ig_∑th : 
NULL
;

877 
dïth
, 
i
, 
µos
 = 0;

878 
ªt
;

880 
eh
 = 
	`ext_öode_hdr
(
öode
);

881 
dïth
 = 
	`ext_dïth
(
öode
);

882 i‡(
dïth
 < 0 || dïth > 
PXT4_MAX_EXTENT_DEPTH
) {

883 
	`PXT4_ERROR_INODE
(
öode
, "inode has invalidÉxtent depth: %d",

884 
dïth
);

885 
ªt
 = -
EFSCORRUPTED
;

886 
îr
;

889 i‡(
∑th
) {

890 
	`pxt4_ext_dr›_ªfs
(
∑th
);

891 i‡(
dïth
 > 
∑th
[0].
p_maxdïth
) {

892 
	`k‰ì
(
∑th
);

893 *
‹ig_∑th
 = 
∑th
 = 
NULL
;

896 i‡(!
∑th
) {

898 
∑th
 = 
	`kˇŒoc
(
dïth
 + 2, (
pxt4_ext_∑th
),

899 
GFP_NOFS
);

900 i‡(
	`u∆ikñy
(!
∑th
))

901  
	`ERR_PTR
(-
ENOMEM
);

902 
∑th
[0].
p_maxdïth
 = 
dïth
 + 1;

904 
∑th
[0].
p_hdr
 = 
eh
;

905 
∑th
[0].
p_bh
 = 
NULL
;

907 
i
 = 
dïth
;

908 i‡(!(
Êags
 & 
PXT4_EX_NOCACHE
Ë&& 
dïth
 == 0)

909 
	`pxt4_ˇche_exã¡s
(
öode
, 
eh
);

911 
i
) {

912 
	`ext_debug
("depth %d:Çum %d, max %d\n",

913 
µos
, 
	`À16_to_˝u
(
eh
->
eh_íåõs
),Üe16_to_˝u”h->
eh_max
));

915 
	`pxt4_ext_bö£¨ch_idx
(
öode
, 
∑th
 + 
µos
, 
block
);

916 
∑th
[
µos
].
p_block
 = 
	`pxt4_idx_pblock
’©h[µos].
p_idx
);

917 
∑th
[
µos
].
p_dïth
 = 
i
;

918 
∑th
[
µos
].
p_ext
 = 
NULL
;

920 
bh
 = 
	`ªad_exã¡_åì_block
(
öode
, 
∑th
[
µos
].
p_block
, --
i
,

921 
Êags
);

922 i‡(
	`IS_ERR
(
bh
)) {

923 
ªt
 = 
	`PTR_ERR
(
bh
);

924 
îr
;

927 
eh
 = 
	`ext_block_hdr
(
bh
);

928 
µos
++;

929 
∑th
[
µos
].
p_bh
 = 
bh
;

930 
∑th
[
µos
].
p_hdr
 = 
eh
;

933 
∑th
[
µos
].
p_dïth
 = 
i
;

934 
∑th
[
µos
].
p_ext
 = 
NULL
;

935 
∑th
[
µos
].
p_idx
 = 
NULL
;

938 
	`pxt4_ext_bö£¨ch
(
öode
, 
∑th
 + 
µos
, 
block
);

940 i‡(
∑th
[
µos
].
p_ext
)

941 
∑th
[
µos
].
p_block
 = 
	`pxt4_ext_pblock
’©h[µos].
p_ext
);

943 
	`pxt4_ext_show_∑th
(
öode
, 
∑th
);

945  
∑th
;

947 
îr
:

948 
	`pxt4_ext_dr›_ªfs
(
∑th
);

949 
	`k‰ì
(
∑th
);

950 i‡(
‹ig_∑th
)

951 *
‹ig_∑th
 = 
NULL
;

952  
	`ERR_PTR
(
ªt
);

953 
	}
}

960 
	$pxt4_ext_ö£π_ödex
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *inode,

961 
pxt4_ext_∑th
 *
cuΩ
,

962 
logiˇl
, 
pxt4_fsblk_t
 
±r
)

964 
pxt4_exã¡_idx
 *
ix
;

965 
Àn
, 
îr
;

967 
îr
 = 
	`pxt4_ext_gë_ac˚ss
(
h™dÀ
, 
öode
, 
cuΩ
);

968 i‡(
îr
)

969  
îr
;

971 i‡(
	`u∆ikñy
(
logiˇl
 =
	`À32_to_˝u
(
cuΩ
->
p_idx
->
ei_block
))) {

972 
	`PXT4_ERROR_INODE
(
öode
,

974 
logiˇl
, 
	`À32_to_˝u
(
cuΩ
->
p_idx
->
ei_block
));

975  -
EFSCORRUPTED
;

978 i‡(
	`u∆ikñy
(
	`À16_to_˝u
(
cuΩ
->
p_hdr
->
eh_íåõs
)

979 >
	`À16_to_˝u
(
cuΩ
->
p_hdr
->
eh_max
))) {

980 
	`PXT4_ERROR_INODE
(
öode
,

982 
	`À16_to_˝u
(
cuΩ
->
p_hdr
->
eh_íåõs
),

983 
	`À16_to_˝u
(
cuΩ
->
p_hdr
->
eh_max
));

984  -
EFSCORRUPTED
;

987 i‡(
logiˇl
 > 
	`À32_to_˝u
(
cuΩ
->
p_idx
->
ei_block
)) {

989 
	`ext_debug
("ö£πÇew index %dá·î: %Œu\n", 
logiˇl
, 
±r
);

990 
ix
 = 
cuΩ
->
p_idx
 + 1;

993 
	`ext_debug
("ö£πÇew index %d bef‹e: %Œu\n", 
logiˇl
, 
±r
);

994 
ix
 = 
cuΩ
->
p_idx
;

997 
Àn
 = 
	`EXT_LAST_INDEX
(
cuΩ
->
p_hdr
Ë- 
ix
 + 1;

998 
	`BUG_ON
(
Àn
 < 0);

999 i‡(
Àn
 > 0) {

1000 
	`ext_debug
("insertÇew index %d: "

1002 
logiˇl
, 
Àn
, 
ix
, ix + 1);

1003 
	`memmove
(
ix
 + 1, ix, 
Àn
 * (
pxt4_exã¡_idx
));

1006 i‡(
	`u∆ikñy
(
ix
 > 
	`EXT_MAX_INDEX
(
cuΩ
->
p_hdr
))) {

1007 
	`PXT4_ERROR_INODE
(
öode
, "ix > EXT_MAX_INDEX!");

1008  -
EFSCORRUPTED
;

1011 
ix
->
ei_block
 = 
	`˝u_to_À32
(
logiˇl
);

1012 
	`pxt4_idx_°‹e_pblock
(
ix
, 
±r
);

1013 
	`À16_add_˝u
(&
cuΩ
->
p_hdr
->
eh_íåõs
, 1);

1015 i‡(
	`u∆ikñy
(
ix
 > 
	`EXT_LAST_INDEX
(
cuΩ
->
p_hdr
))) {

1016 
	`PXT4_ERROR_INODE
(
öode
, "ix > EXT_LAST_INDEX!");

1017  -
EFSCORRUPTED
;

1020 
îr
 = 
	`pxt4_ext_dúty
(
h™dÀ
, 
öode
, 
cuΩ
);

1021 
	`pxt4_°d_îr‹
(
öode
->
i_sb
, 
îr
);

1023  
îr
;

1024 
	}
}

1036 
	$pxt4_ext_•lô
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *inode,

1037 
Êags
,

1038 
pxt4_ext_∑th
 *
∑th
,

1039 
pxt4_exã¡
 *
√wext
, 
©
)

1041 
buf„r_hód
 *
bh
 = 
NULL
;

1042 
dïth
 = 
	`ext_dïth
(
öode
);

1043 
pxt4_exã¡_hódî
 *
√h
;

1044 
pxt4_exã¡_idx
 *
fidx
;

1045 
i
 = 
©
, 
k
, 
m
, 
a
;

1046 
pxt4_fsblk_t
 
√wblock
, 
ﬁdblock
;

1047 
__À32
 
b‹dî
;

1048 
pxt4_fsblk_t
 *
ablocks
 = 
NULL
;

1049 
îr
 = 0;

1050 
size_t
 
ext_size
 = 0;

1057 i‡(
	`u∆ikñy
(
∑th
[
dïth
].
p_ext
 > 
	`EXT_MAX_EXTENT
’©h[dïth].
p_hdr
))) {

1058 
	`PXT4_ERROR_INODE
(
öode
, "p_ext > EXT_MAX_EXTENT!");

1059  -
EFSCORRUPTED
;

1061 i‡(
∑th
[
dïth
].
p_ext
 !
	`EXT_MAX_EXTENT
’©h[dïth].
p_hdr
)) {

1062 
b‹dî
 = 
∑th
[
dïth
].
p_ext
[1].
ì_block
;

1063 
	`ext_debug
("leaf will be split."

1065 
	`À32_to_˝u
(
b‹dî
));

1067 
b‹dî
 = 
√wext
->
ì_block
;

1068 
	`ext_debug
("leaf will beádded."

1070 
	`À32_to_˝u
(
b‹dî
));

1085 
ablocks
 = 
	`kˇŒoc
(
dïth
, (
pxt4_fsblk_t
), 
GFP_NOFS
);

1086 i‡(!
ablocks
)

1087  -
ENOMEM
;

1090 
	`ext_debug
("Æloˇã %d block†f‹ indexes/Àaf\n", 
dïth
 - 
©
);

1091 
a
 = 0;á < 
dïth
 - 
©
;á++) {

1092 
√wblock
 = 
	`pxt4_ext_√w_mëa_block
(
h™dÀ
, 
öode
, 
∑th
,

1093 
√wext
, &
îr
, 
Êags
);

1094 i‡(
√wblock
 == 0)

1095 
˛ónup
;

1096 
ablocks
[
a
] = 
√wblock
;

1100 
√wblock
 = 
ablocks
[--
a
];

1101 i‡(
	`u∆ikñy
(
√wblock
 == 0)) {

1102 
	`PXT4_ERROR_INODE
(
öode
, "newblock == 0!");

1103 
îr
 = -
EFSCORRUPTED
;

1104 
˛ónup
;

1106 
bh
 = 
	`sb_gëblk_gÂ
(
öode
->
i_sb
, 
√wblock
, 
__GFP_MOVABLE
 | 
GFP_NOFS
);

1107 i‡(
	`u∆ikñy
(!
bh
)) {

1108 
îr
 = -
ENOMEM
;

1109 
˛ónup
;

1111 
	`lock_buf„r
(
bh
);

1113 
îr
 = 
	`pxt4_jou∫Æ_gë_¸óã_ac˚ss
(
h™dÀ
, 
bh
);

1114 i‡(
îr
)

1115 
˛ónup
;

1117 
√h
 = 
	`ext_block_hdr
(
bh
);

1118 
√h
->
eh_íåõs
 = 0;

1119 
√h
->
eh_max
 = 
	`˝u_to_À16
(
	`pxt4_ext_•a˚_block
(
öode
, 0));

1120 
√h
->
eh_magic
 = 
PXT4_EXT_MAGIC
;

1121 
√h
->
eh_dïth
 = 0;

1122 
√h
->
eh_gíî©i⁄
 = 0;

1125 i‡(
	`u∆ikñy
(
∑th
[
dïth
].
p_hdr
->
eh_íåõs
 !=

1126 
∑th
[
dïth
].
p_hdr
->
eh_max
)) {

1127 
	`PXT4_ERROR_INODE
(
öode
, "eh_entries %d !=Éh_max %d!",

1128 
∑th
[
dïth
].
p_hdr
->
eh_íåõs
,

1129 
∑th
[
dïth
].
p_hdr
->
eh_max
);

1130 
îr
 = -
EFSCORRUPTED
;

1131 
˛ónup
;

1134 
m
 = 
	`EXT_MAX_EXTENT
(
∑th
[
dïth
].
p_hdr
Ë-Ö©h[dïth].
p_ext
++;

1135 
	`pxt4_ext_show_move
(
öode
, 
∑th
, 
√wblock
, 
dïth
);

1136 i‡(
m
) {

1137 
pxt4_exã¡
 *
ex
;

1138 
ex
 = 
	`EXT_FIRST_EXTENT
(
√h
);

1139 
	`memmove
(
ex
, 
∑th
[
dïth
].
p_ext
, (
pxt4_exã¡
Ë* 
m
);

1140 
	`À16_add_˝u
(&
√h
->
eh_íåõs
, 
m
);

1144 
ext_size
 = (
pxt4_exã¡_hódî
) +

1145 (
pxt4_exã¡
Ë* 
	`À16_to_˝u
(
√h
->
eh_íåõs
);

1146 
	`mem£t
(
bh
->
b_d©a
 + 
ext_size
, 0, 
öode
->
i_sb
->
s_blocksize
 -Éxt_size);

1147 
	`pxt4_exã¡_block_csum_£t
(
öode
, 
√h
);

1148 
	`£t_buf„r_u±od©e
(
bh
);

1149 
	`u∆ock_buf„r
(
bh
);

1151 
îr
 = 
	`pxt4_h™dÀ_dúty_mëad©a
(
h™dÀ
, 
öode
, 
bh
);

1152 i‡(
îr
)

1153 
˛ónup
;

1154 
	`bªl£
(
bh
);

1155 
bh
 = 
NULL
;

1158 i‡(
m
) {

1159 
îr
 = 
	`pxt4_ext_gë_ac˚ss
(
h™dÀ
, 
öode
, 
∑th
 + 
dïth
);

1160 i‡(
îr
)

1161 
˛ónup
;

1162 
	`À16_add_˝u
(&
∑th
[
dïth
].
p_hdr
->
eh_íåõs
, -
m
);

1163 
îr
 = 
	`pxt4_ext_dúty
(
h™dÀ
, 
öode
, 
∑th
 + 
dïth
);

1164 i‡(
îr
)

1165 
˛ónup
;

1170 
k
 = 
dïth
 - 
©
 - 1;

1171 i‡(
	`u∆ikñy
(
k
 < 0)) {

1172 
	`PXT4_ERROR_INODE
(
öode
, "k %d < 0!", 
k
);

1173 
îr
 = -
EFSCORRUPTED
;

1174 
˛ónup
;

1176 i‡(
k
)

1177 
	`ext_debug
("¸óã %d i¡îmedüã indi˚s\n", 
k
);

1180 
i
 = 
dïth
 - 1;

1181 
k
--) {

1182 
ﬁdblock
 = 
√wblock
;

1183 
√wblock
 = 
ablocks
[--
a
];

1184 
bh
 = 
	`sb_gëblk
(
öode
->
i_sb
, 
√wblock
);

1185 i‡(
	`u∆ikñy
(!
bh
)) {

1186 
îr
 = -
ENOMEM
;

1187 
˛ónup
;

1189 
	`lock_buf„r
(
bh
);

1191 
îr
 = 
	`pxt4_jou∫Æ_gë_¸óã_ac˚ss
(
h™dÀ
, 
bh
);

1192 i‡(
îr
)

1193 
˛ónup
;

1195 
√h
 = 
	`ext_block_hdr
(
bh
);

1196 
√h
->
eh_íåõs
 = 
	`˝u_to_À16
(1);

1197 
√h
->
eh_magic
 = 
PXT4_EXT_MAGIC
;

1198 
√h
->
eh_max
 = 
	`˝u_to_À16
(
	`pxt4_ext_•a˚_block_idx
(
öode
, 0));

1199 
√h
->
eh_dïth
 = 
	`˝u_to_À16
(
dïth
 - 
i
);

1200 
√h
->
eh_gíî©i⁄
 = 0;

1201 
fidx
 = 
	`EXT_FIRST_INDEX
(
√h
);

1202 
fidx
->
ei_block
 = 
b‹dî
;

1203 
	`pxt4_idx_°‹e_pblock
(
fidx
, 
ﬁdblock
);

1205 
	`ext_debug
("int.indexát %d (block %llu): %u -> %llu\n",

1206 
i
, 
√wblock
, 
	`À32_to_˝u
(
b‹dî
), 
ﬁdblock
);

1209 i‡(
	`u∆ikñy
(
	`EXT_MAX_INDEX
(
∑th
[
i
].
p_hdr
) !=

1210 
	`EXT_LAST_INDEX
(
∑th
[
i
].
p_hdr
))) {

1211 
	`PXT4_ERROR_INODE
(
öode
,

1213 
	`À32_to_˝u
(
∑th
[
i
].
p_ext
->
ì_block
));

1214 
îr
 = -
EFSCORRUPTED
;

1215 
˛ónup
;

1218 
m
 = 
	`EXT_MAX_INDEX
(
∑th
[
i
].
p_hdr
Ë-Ö©h[i].
p_idx
++;

1219 
	`ext_debug
("cu∏0x%p,Üa° 0x%p\n", 
∑th
[
i
].
p_idx
,

1220 
	`EXT_MAX_INDEX
(
∑th
[
i
].
p_hdr
));

1221 
	`pxt4_ext_show_move
(
öode
, 
∑th
, 
√wblock
, 
i
);

1222 i‡(
m
) {

1223 
	`memmove
(++
fidx
, 
∑th
[
i
].
p_idx
,

1224 (
pxt4_exã¡_idx
Ë* 
m
);

1225 
	`À16_add_˝u
(&
√h
->
eh_íåõs
, 
m
);

1228 
ext_size
 = (
pxt4_exã¡_hódî
) +

1229 ((
pxt4_exã¡
Ë* 
	`À16_to_˝u
(
√h
->
eh_íåõs
));

1230 
	`mem£t
(
bh
->
b_d©a
 + 
ext_size
, 0,

1231 
öode
->
i_sb
->
s_blocksize
 - 
ext_size
);

1232 
	`pxt4_exã¡_block_csum_£t
(
öode
, 
√h
);

1233 
	`£t_buf„r_u±od©e
(
bh
);

1234 
	`u∆ock_buf„r
(
bh
);

1236 
îr
 = 
	`pxt4_h™dÀ_dúty_mëad©a
(
h™dÀ
, 
öode
, 
bh
);

1237 i‡(
îr
)

1238 
˛ónup
;

1239 
	`bªl£
(
bh
);

1240 
bh
 = 
NULL
;

1243 i‡(
m
) {

1244 
îr
 = 
	`pxt4_ext_gë_ac˚ss
(
h™dÀ
, 
öode
, 
∑th
 + 
i
);

1245 i‡(
îr
)

1246 
˛ónup
;

1247 
	`À16_add_˝u
(&
∑th
[
i
].
p_hdr
->
eh_íåõs
, -
m
);

1248 
îr
 = 
	`pxt4_ext_dúty
(
h™dÀ
, 
öode
, 
∑th
 + 
i
);

1249 i‡(
îr
)

1250 
˛ónup
;

1253 
i
--;

1257 
îr
 = 
	`pxt4_ext_ö£π_ödex
(
h™dÀ
, 
öode
, 
∑th
 + 
©
,

1258 
	`À32_to_˝u
(
b‹dî
), 
√wblock
);

1260 
˛ónup
:

1261 i‡(
bh
) {

1262 i‡(
	`buf„r_locked
(
bh
))

1263 
	`u∆ock_buf„r
(
bh
);

1264 
	`bªl£
(
bh
);

1267 i‡(
îr
) {

1269 
i
 = 0; i < 
dïth
; i++) {

1270 i‡(!
ablocks
[
i
])

1272 
	`pxt4_‰ì_blocks
(
h™dÀ
, 
öode
, 
NULL
, 
ablocks
[
i
], 1,

1273 
PXT4_FREE_BLOCKS_METADATA
);

1276 
	`k‰ì
(
ablocks
);

1278  
îr
;

1279 
	}
}

1289 
	$pxt4_ext_grow_ödïth
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *inode,

1290 
Êags
)

1292 
pxt4_exã¡_hódî
 *
√h
;

1293 
buf„r_hód
 *
bh
;

1294 
pxt4_fsblk_t
 
√wblock
, 
gﬂl
 = 0;

1295 
pxt4_su≥r_block
 *
es
 = 
	`PXT4_SB
(
öode
->
i_sb
)->
s_es
;

1296 
îr
 = 0;

1297 
size_t
 
ext_size
 = 0;

1300 i‡(
	`ext_dïth
(
öode
))

1301 
gﬂl
 = 
	`pxt4_idx_pblock
(
	`EXT_FIRST_INDEX
(
	`ext_öode_hdr
(
öode
)));

1302 i‡(
gﬂl
 > 
	`À32_to_˝u
(
es
->
s_fú°_d©a_block
)) {

1303 
Êags
 |
PXT4_MB_HINT_TRY_GOAL
;

1304 
gﬂl
--;

1306 
gﬂl
 = 
	`pxt4_öode_to_gﬂl_block
(
öode
);

1307 
√wblock
 = 
	`pxt4_√w_mëa_blocks
(
h™dÀ
, 
öode
, 
gﬂl
, 
Êags
,

1308 
NULL
, &
îr
);

1309 i‡(
√wblock
 == 0)

1310  
îr
;

1312 
bh
 = 
	`sb_gëblk_gÂ
(
öode
->
i_sb
, 
√wblock
, 
__GFP_MOVABLE
 | 
GFP_NOFS
);

1313 i‡(
	`u∆ikñy
(!
bh
))

1314  -
ENOMEM
;

1315 
	`lock_buf„r
(
bh
);

1317 
îr
 = 
	`pxt4_jou∫Æ_gë_¸óã_ac˚ss
(
h™dÀ
, 
bh
);

1318 i‡(
îr
) {

1319 
	`u∆ock_buf„r
(
bh
);

1320 
out
;

1323 
ext_size
 = (
	`PXT4_I
(
öode
)->
i_d©a
);

1325 
	`memmove
(
bh
->
b_d©a
, 
	`PXT4_I
(
öode
)->
i_d©a
, 
ext_size
);

1327 
	`mem£t
(
bh
->
b_d©a
 + 
ext_size
, 0, 
öode
->
i_sb
->
s_blocksize
 -Éxt_size);

1330 
√h
 = 
	`ext_block_hdr
(
bh
);

1333 i‡(
	`ext_dïth
(
öode
))

1334 
√h
->
eh_max
 = 
	`˝u_to_À16
(
	`pxt4_ext_•a˚_block_idx
(
öode
, 0));

1336 
√h
->
eh_max
 = 
	`˝u_to_À16
(
	`pxt4_ext_•a˚_block
(
öode
, 0));

1337 
√h
->
eh_magic
 = 
PXT4_EXT_MAGIC
;

1338 
	`pxt4_exã¡_block_csum_£t
(
öode
, 
√h
);

1339 
	`£t_buf„r_u±od©e
(
bh
);

1340 
	`u∆ock_buf„r
(
bh
);

1342 
îr
 = 
	`pxt4_h™dÀ_dúty_mëad©a
(
h™dÀ
, 
öode
, 
bh
);

1343 i‡(
îr
)

1344 
out
;

1347 
√h
 = 
	`ext_öode_hdr
(
öode
);

1348 
√h
->
eh_íåõs
 = 
	`˝u_to_À16
(1);

1349 
	`pxt4_idx_°‹e_pblock
(
	`EXT_FIRST_INDEX
(
√h
), 
√wblock
);

1350 i‡(
√h
->
eh_dïth
 == 0) {

1352 
√h
->
eh_max
 = 
	`˝u_to_À16
(
	`pxt4_ext_•a˚_roŸ_idx
(
öode
, 0));

1353 
	`EXT_FIRST_INDEX
(
√h
)->
ei_block
 =

1354 
	`EXT_FIRST_EXTENT
(
√h
)->
ì_block
;

1356 
	`ext_debug
("newÑoot:Çum %d(%d),Üblock %d,Ötr %llu\n",

1357 
	`À16_to_˝u
(
√h
->
eh_íåõs
),Üe16_to_˝u“eh->
eh_max
),

1358 
	`À32_to_˝u
(
	`EXT_FIRST_INDEX
(
√h
)->
ei_block
),

1359 
	`pxt4_idx_pblock
(
	`EXT_FIRST_INDEX
(
√h
)));

1361 
	`À16_add_˝u
(&
√h
->
eh_dïth
, 1);

1362 
	`pxt4_m¨k_öode_dúty
(
h™dÀ
, 
öode
);

1363 
out
:

1364 
	`bªl£
(
bh
);

1366  
îr
;

1367 
	}
}

1374 
	$pxt4_ext_¸óã_√w_Àaf
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *inode,

1375 
mb_Êags
,

1376 
gb_Êags
,

1377 
pxt4_ext_∑th
 **
µ©h
,

1378 
pxt4_exã¡
 *
√wext
)

1380 
pxt4_ext_∑th
 *
∑th
 = *
µ©h
;

1381 
pxt4_ext_∑th
 *
cuΩ
;

1382 
dïth
, 
i
, 
îr
 = 0;

1384 
ª≥©
:

1385 
i
 = 
dïth
 = 
	`ext_dïth
(
öode
);

1388 
cuΩ
 = 
∑th
 + 
dïth
;

1389 
i
 > 0 && !
	`EXT_HAS_FREE_INDEX
(
cuΩ
)) {

1390 
i
--;

1391 
cuΩ
--;

1396 i‡(
	`EXT_HAS_FREE_INDEX
(
cuΩ
)) {

1399 
îr
 = 
	`pxt4_ext_•lô
(
h™dÀ
, 
öode
, 
mb_Êags
, 
∑th
, 
√wext
, 
i
);

1400 i‡(
îr
)

1401 
out
;

1404 
∑th
 = 
	`pxt4_föd_exã¡
(
öode
,

1405 (
pxt4_lblk_t
)
	`À32_to_˝u
(
√wext
->
ì_block
),

1406 
µ©h
, 
gb_Êags
);

1407 i‡(
	`IS_ERR
(
∑th
))

1408 
îr
 = 
	`PTR_ERR
(
∑th
);

1411 
îr
 = 
	`pxt4_ext_grow_ödïth
(
h™dÀ
, 
öode
, 
mb_Êags
);

1412 i‡(
îr
)

1413 
out
;

1416 
∑th
 = 
	`pxt4_föd_exã¡
(
öode
,

1417 (
pxt4_lblk_t
)
	`À32_to_˝u
(
√wext
->
ì_block
),

1418 
µ©h
, 
gb_Êags
);

1419 i‡(
	`IS_ERR
(
∑th
)) {

1420 
îr
 = 
	`PTR_ERR
(
∑th
);

1421 
out
;

1428 
dïth
 = 
	`ext_dïth
(
öode
);

1429 i‡(
∑th
[
dïth
].
p_hdr
->
eh_íåõs
 =∑th[dïth].p_hdr->
eh_max
) {

1431 
ª≥©
;

1435 
out
:

1436  
îr
;

1437 
	}
}

1446 
	$pxt4_ext_£¨ch_À·
(
öode
 *inode,

1447 
pxt4_ext_∑th
 *
∑th
,

1448 
pxt4_lblk_t
 *
logiˇl
, 
pxt4_fsblk_t
 *
phys
)

1450 
pxt4_exã¡_idx
 *
ix
;

1451 
pxt4_exã¡
 *
ex
;

1452 
dïth
, 
ì_Àn
;

1454 i‡(
	`u∆ikñy
(
∑th
 =
NULL
)) {

1455 
	`PXT4_ERROR_INODE
(
öode
, "∑th =NULL *logiˇ»%d!", *
logiˇl
);

1456  -
EFSCORRUPTED
;

1458 
dïth
 = 
∑th
->
p_dïth
;

1459 *
phys
 = 0;

1461 i‡(
dïth
 =0 && 
∑th
->
p_ext
 =
NULL
)

1468 
ex
 = 
∑th
[
dïth
].
p_ext
;

1469 
ì_Àn
 = 
	`pxt4_ext_gë_a˘uÆ_Àn
(
ex
);

1470 i‡(*
logiˇl
 < 
	`À32_to_˝u
(
ex
->
ì_block
)) {

1471 i‡(
	`u∆ikñy
(
	`EXT_FIRST_EXTENT
(
∑th
[
dïth
].
p_hdr
Ë!
ex
)) {

1472 
	`PXT4_ERROR_INODE
(
öode
,

1474 *
logiˇl
, 
	`À32_to_˝u
(
ex
->
ì_block
));

1475  -
EFSCORRUPTED
;

1477 --
dïth
 >= 0) {

1478 
ix
 = 
∑th
[
dïth
].
p_idx
;

1479 i‡(
	`u∆ikñy
(
ix
 !
	`EXT_FIRST_INDEX
(
∑th
[
dïth
].
p_hdr
))) {

1480 
	`PXT4_ERROR_INODE
(
öode
,

1482 
ix
 !
NULL
 ? 
	`À32_to_˝u
(ix->
ei_block
) : 0,

1483 
	`EXT_FIRST_INDEX
(
∑th
[
dïth
].
p_hdr
Ë!
NULL
 ?

1484 
	`À32_to_˝u
(
	`EXT_FIRST_INDEX
(
∑th
[
dïth
].
p_hdr
)->
ei_block
) : 0,

1485 
dïth
);

1486  -
EFSCORRUPTED
;

1492 i‡(
	`u∆ikñy
(*
logiˇl
 < (
	`À32_to_˝u
(
ex
->
ì_block
Ë+ 
ì_Àn
))) {

1493 
	`PXT4_ERROR_INODE
(
öode
,

1495 *
logiˇl
, 
	`À32_to_˝u
(
ex
->
ì_block
), 
ì_Àn
);

1496  -
EFSCORRUPTED
;

1499 *
logiˇl
 = 
	`À32_to_˝u
(
ex
->
ì_block
Ë+ 
ì_Àn
 - 1;

1500 *
phys
 = 
	`pxt4_ext_pblock
(
ex
Ë+ 
ì_Àn
 - 1;

1502 
	}
}

1511 
	$pxt4_ext_£¨ch_right
(
öode
 *inode,

1512 
pxt4_ext_∑th
 *
∑th
,

1513 
pxt4_lblk_t
 *
logiˇl
, 
pxt4_fsblk_t
 *
phys
,

1514 
pxt4_exã¡
 **
ªt_ex
)

1516 
buf„r_hód
 *
bh
 = 
NULL
;

1517 
pxt4_exã¡_hódî
 *
eh
;

1518 
pxt4_exã¡_idx
 *
ix
;

1519 
pxt4_exã¡
 *
ex
;

1520 
pxt4_fsblk_t
 
block
;

1521 
dïth
;

1522 
ì_Àn
;

1524 i‡(
	`u∆ikñy
(
∑th
 =
NULL
)) {

1525 
	`PXT4_ERROR_INODE
(
öode
, "∑th =NULL *logiˇ»%d!", *
logiˇl
);

1526  -
EFSCORRUPTED
;

1528 
dïth
 = 
∑th
->
p_dïth
;

1529 *
phys
 = 0;

1531 i‡(
dïth
 =0 && 
∑th
->
p_ext
 =
NULL
)

1538 
ex
 = 
∑th
[
dïth
].
p_ext
;

1539 
ì_Àn
 = 
	`pxt4_ext_gë_a˘uÆ_Àn
(
ex
);

1540 i‡(*
logiˇl
 < 
	`À32_to_˝u
(
ex
->
ì_block
)) {

1541 i‡(
	`u∆ikñy
(
	`EXT_FIRST_EXTENT
(
∑th
[
dïth
].
p_hdr
Ë!
ex
)) {

1542 
	`PXT4_ERROR_INODE
(
öode
,

1544 
dïth
);

1545  -
EFSCORRUPTED
;

1547 --
dïth
 >= 0) {

1548 
ix
 = 
∑th
[
dïth
].
p_idx
;

1549 i‡(
	`u∆ikñy
(
ix
 !
	`EXT_FIRST_INDEX
(
∑th
[
dïth
].
p_hdr
))) {

1550 
	`PXT4_ERROR_INODE
(
öode
,

1552 *
logiˇl
);

1553  -
EFSCORRUPTED
;

1556 
found_exã¡
;

1559 i‡(
	`u∆ikñy
(*
logiˇl
 < (
	`À32_to_˝u
(
ex
->
ì_block
Ë+ 
ì_Àn
))) {

1560 
	`PXT4_ERROR_INODE
(
öode
,

1562 *
logiˇl
, 
	`À32_to_˝u
(
ex
->
ì_block
), 
ì_Àn
);

1563  -
EFSCORRUPTED
;

1566 i‡(
ex
 !
	`EXT_LAST_EXTENT
(
∑th
[
dïth
].
p_hdr
)) {

1568 
ex
++;

1569 
found_exã¡
;

1573 --
dïth
 >= 0) {

1574 
ix
 = 
∑th
[
dïth
].
p_idx
;

1575 i‡(
ix
 !
	`EXT_LAST_INDEX
(
∑th
[
dïth
].
p_hdr
))

1576 
gŸ_ödex
;

1582 
gŸ_ödex
:

1586 
ix
++;

1587 
block
 = 
	`pxt4_idx_pblock
(
ix
);

1588 ++
dïth
 < 
∑th
->
p_dïth
) {

1590 
bh
 = 
	`ªad_exã¡_åì_block
(
öode
, 
block
,

1591 
∑th
->
p_dïth
 - 
dïth
, 0);

1592 i‡(
	`IS_ERR
(
bh
))

1593  
	`PTR_ERR
(
bh
);

1594 
eh
 = 
	`ext_block_hdr
(
bh
);

1595 
ix
 = 
	`EXT_FIRST_INDEX
(
eh
);

1596 
block
 = 
	`pxt4_idx_pblock
(
ix
);

1597 
	`put_bh
(
bh
);

1600 
bh
 = 
	`ªad_exã¡_åì_block
(
öode
, 
block
, 
∑th
->
p_dïth
 - 
dïth
, 0);

1601 i‡(
	`IS_ERR
(
bh
))

1602  
	`PTR_ERR
(
bh
);

1603 
eh
 = 
	`ext_block_hdr
(
bh
);

1604 
ex
 = 
	`EXT_FIRST_EXTENT
(
eh
);

1605 
found_exã¡
:

1606 *
logiˇl
 = 
	`À32_to_˝u
(
ex
->
ì_block
);

1607 *
phys
 = 
	`pxt4_ext_pblock
(
ex
);

1608 *
ªt_ex
 = 
ex
;

1609 i‡(
bh
)

1610 
	`put_bh
(
bh
);

1612 
	}
}

1621 
pxt4_lblk_t


1622 
	$pxt4_ext_√xt_Æloˇãd_block
(
pxt4_ext_∑th
 *
∑th
)

1624 
dïth
;

1626 
	`BUG_ON
(
∑th
 =
NULL
);

1627 
dïth
 = 
∑th
->
p_dïth
;

1629 i‡(
dïth
 =0 && 
∑th
->
p_ext
 =
NULL
)

1630  
EXT_MAX_BLOCKS
;

1632 
dïth
 >= 0) {

1633 i‡(
dïth
 =
∑th
->
p_dïth
) {

1635 i‡(
∑th
[
dïth
].
p_ext
 &&

1636 
∑th
[
dïth
].
p_ext
 !=

1637 
	`EXT_LAST_EXTENT
(
∑th
[
dïth
].
p_hdr
))

1638  
	`À32_to_˝u
(
∑th
[
dïth
].
p_ext
[1].
ì_block
);

1641 i‡(
∑th
[
dïth
].
p_idx
 !=

1642 
	`EXT_LAST_INDEX
(
∑th
[
dïth
].
p_hdr
))

1643  
	`À32_to_˝u
(
∑th
[
dïth
].
p_idx
[1].
ei_block
);

1645 
dïth
--;

1648  
EXT_MAX_BLOCKS
;

1649 
	}
}

1655 
pxt4_lblk_t
 
	$pxt4_ext_√xt_Àaf_block
(
pxt4_ext_∑th
 *
∑th
)

1657 
dïth
;

1659 
	`BUG_ON
(
∑th
 =
NULL
);

1660 
dïth
 = 
∑th
->
p_dïth
;

1663 i‡(
dïth
 == 0)

1664  
EXT_MAX_BLOCKS
;

1667 
dïth
--;

1669 
dïth
 >= 0) {

1670 i‡(
∑th
[
dïth
].
p_idx
 !=

1671 
	`EXT_LAST_INDEX
(
∑th
[
dïth
].
p_hdr
))

1672  (
pxt4_lblk_t
)

1673 
	`À32_to_˝u
(
∑th
[
dïth
].
p_idx
[1].
ei_block
);

1674 
dïth
--;

1677  
EXT_MAX_BLOCKS
;

1678 
	}
}

1686 
	$pxt4_ext_c‹ª˘_ödexes
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *inode,

1687 
pxt4_ext_∑th
 *
∑th
)

1689 
pxt4_exã¡_hódî
 *
eh
;

1690 
dïth
 = 
	`ext_dïth
(
öode
);

1691 
pxt4_exã¡
 *
ex
;

1692 
__À32
 
b‹dî
;

1693 
k
, 
îr
 = 0;

1695 
eh
 = 
∑th
[
dïth
].
p_hdr
;

1696 
ex
 = 
∑th
[
dïth
].
p_ext
;

1698 i‡(
	`u∆ikñy
(
ex
 =
NULL
 || 
eh
 == NULL)) {

1699 
	`PXT4_ERROR_INODE
(
öode
,

1700 "ex %∞=NULL o∏eh %∞=NULL", 
ex
, 
eh
);

1701  -
EFSCORRUPTED
;

1704 i‡(
dïth
 == 0) {

1709 i‡(
ex
 !
	`EXT_FIRST_EXTENT
(
eh
)) {

1717 
k
 = 
dïth
 - 1;

1718 
b‹dî
 = 
∑th
[
dïth
].
p_ext
->
ì_block
;

1719 
îr
 = 
	`pxt4_ext_gë_ac˚ss
(
h™dÀ
, 
öode
, 
∑th
 + 
k
);

1720 i‡(
îr
)

1721  
îr
;

1722 
∑th
[
k
].
p_idx
->
ei_block
 = 
b‹dî
;

1723 
îr
 = 
	`pxt4_ext_dúty
(
h™dÀ
, 
öode
, 
∑th
 + 
k
);

1724 i‡(
îr
)

1725  
îr
;

1727 
k
--) {

1729 i‡(
∑th
[
k
+1].
p_idx
 !
	`EXT_FIRST_INDEX
’©h[k+1].
p_hdr
))

1731 
îr
 = 
	`pxt4_ext_gë_ac˚ss
(
h™dÀ
, 
öode
, 
∑th
 + 
k
);

1732 i‡(
îr
)

1734 
∑th
[
k
].
p_idx
->
ei_block
 = 
b‹dî
;

1735 
îr
 = 
	`pxt4_ext_dúty
(
h™dÀ
, 
öode
, 
∑th
 + 
k
);

1736 i‡(
îr
)

1740  
îr
;

1741 
	}
}

1744 
	$pxt4_ˇn_exã¡s_be_mîged
(
öode
 *öode, 
pxt4_exã¡
 *
ex1
,

1745 
pxt4_exã¡
 *
ex2
)

1747 
ext1_ì_Àn
, 
pxt2_ì_Àn
;

1749 i‡(
	`pxt4_ext_is_unwrôãn
(
ex1
Ë!pxt4_ext_is_unwrôãn(
ex2
))

1752 
ext1_ì_Àn
 = 
	`pxt4_ext_gë_a˘uÆ_Àn
(
ex1
);

1753 
pxt2_ì_Àn
 = 
	`pxt4_ext_gë_a˘uÆ_Àn
(
ex2
);

1755 i‡(
	`À32_to_˝u
(
ex1
->
ì_block
Ë+ 
ext1_ì_Àn
 !=

1756 
	`À32_to_˝u
(
ex2
->
ì_block
))

1764 i‡(
ext1_ì_Àn
 + 
pxt2_ì_Àn
 > 
EXT_INIT_MAX_LEN
)

1772 i‡(
	`pxt4_ext_is_unwrôãn
(
ex1
) &&

1773 (
	`pxt4_ã°_öode_°©e
(
öode
, 
PXT4_STATE_DIO_UNWRITTEN
) ||

1774 
	`©omic_ªad
(&
	`PXT4_I
(
öode
)->
i_unwrôãn
) ||

1775 (
ext1_ì_Àn
 + 
pxt2_ì_Àn
 > 
EXT_UNWRITTEN_MAX_LEN
)))

1777 #ifde‡
AGGRESSIVE_TEST


1778 i‡(
ext1_ì_Àn
 >= 4)

1782 i‡(
	`pxt4_ext_pblock
(
ex1
Ë+ 
ext1_ì_Àn
 =pxt4_ext_pblock(
ex2
))

1785 
	}
}

1794 
	$pxt4_ext_åy_to_mîge_right
(
öode
 *inode,

1795 
pxt4_ext_∑th
 *
∑th
,

1796 
pxt4_exã¡
 *
ex
)

1798 
pxt4_exã¡_hódî
 *
eh
;

1799 
dïth
, 
Àn
;

1800 
mîge_d⁄e
 = 0, 
unwrôãn
;

1802 
dïth
 = 
	`ext_dïth
(
öode
);

1803 
	`BUG_ON
(
∑th
[
dïth
].
p_hdr
 =
NULL
);

1804 
eh
 = 
∑th
[
dïth
].
p_hdr
;

1806 
ex
 < 
	`EXT_LAST_EXTENT
(
eh
)) {

1807 i‡(!
	`pxt4_ˇn_exã¡s_be_mîged
(
öode
, 
ex
,Éx + 1))

1810 
unwrôãn
 = 
	`pxt4_ext_is_unwrôãn
(
ex
);

1811 
ex
->
ì_Àn
 = 
	`˝u_to_À16
(
	`pxt4_ext_gë_a˘uÆ_Àn
(ex)

1812 + 
	`pxt4_ext_gë_a˘uÆ_Àn
(
ex
 + 1));

1813 i‡(
unwrôãn
)

1814 
	`pxt4_ext_m¨k_unwrôãn
(
ex
);

1816 i‡(
ex
 + 1 < 
	`EXT_LAST_EXTENT
(
eh
)) {

1817 
Àn
 = (
	`EXT_LAST_EXTENT
(
eh
Ë- 
ex
 - 1)

1818 * (
pxt4_exã¡
);

1819 
	`memmove
(
ex
 + 1,Éx + 2, 
Àn
);

1821 
	`À16_add_˝u
(&
eh
->
eh_íåõs
, -1);

1822 
mîge_d⁄e
 = 1;

1823 
	`WARN_ON
(
eh
->
eh_íåõs
 == 0);

1824 i‡(!
eh
->
eh_íåõs
)

1825 
	`PXT4_ERROR_INODE
(
öode
, "eh->eh_entries = 0!");

1828  
mîge_d⁄e
;

1829 
	}
}

1835 
	$pxt4_ext_åy_to_mîge_up
(
h™dÀ_t
 *
h™dÀ
,

1836 
öode
 *inode,

1837 
pxt4_ext_∑th
 *
∑th
)

1839 
size_t
 
s
;

1840 
max_roŸ
 = 
	`pxt4_ext_•a˚_roŸ
(
öode
, 0);

1841 
pxt4_fsblk_t
 
blk
;

1843 i‡((
∑th
[0].
p_dïth
 != 1) ||

1844 (
	`À16_to_˝u
(
∑th
[0].
p_hdr
->
eh_íåõs
) != 1) ||

1845 (
	`À16_to_˝u
(
∑th
[1].
p_hdr
->
eh_íåõs
Ë> 
max_roŸ
))

1853 i‡(
	`pxt4_jou∫Æ_exãnd
(
h™dÀ
, 2))

1859 
blk
 = 
	`pxt4_idx_pblock
(
∑th
[0].
p_idx
);

1860 
s
 = 
	`À16_to_˝u
(
∑th
[1].
p_hdr
->
eh_íåõs
) *

1861 (
pxt4_exã¡_idx
);

1862 
s
 +(
pxt4_exã¡_hódî
);

1864 
∑th
[1].
p_maxdïth
 =Öath[0].p_maxdepth;

1865 
	`mem˝y
(
∑th
[0].
p_hdr
,Ö©h[1].p_hdr, 
s
);

1866 
∑th
[0].
p_dïth
 = 0;

1867 
∑th
[0].
p_ext
 = 
	`EXT_FIRST_EXTENT
’©h[0].
p_hdr
) +

1868 (
∑th
[1].
p_ext
 - 
	`EXT_FIRST_EXTENT
’©h[1].
p_hdr
));

1869 
∑th
[0].
p_hdr
->
eh_max
 = 
	`˝u_to_À16
(
max_roŸ
);

1871 
	`bªl£
(
∑th
[1].
p_bh
);

1872 
	`pxt4_‰ì_blocks
(
h™dÀ
, 
öode
, 
NULL
, 
blk
, 1,

1873 
PXT4_FREE_BLOCKS_METADATA
 | 
PXT4_FREE_BLOCKS_FORGET
);

1874 
	}
}

1880 
	$pxt4_ext_åy_to_mîge
(
h™dÀ_t
 *
h™dÀ
,

1881 
öode
 *inode,

1882 
pxt4_ext_∑th
 *
∑th
,

1883 
pxt4_exã¡
 *
ex
) {

1884 
pxt4_exã¡_hódî
 *
eh
;

1885 
dïth
;

1886 
mîge_d⁄e
 = 0;

1888 
dïth
 = 
	`ext_dïth
(
öode
);

1889 
	`BUG_ON
(
∑th
[
dïth
].
p_hdr
 =
NULL
);

1890 
eh
 = 
∑th
[
dïth
].
p_hdr
;

1892 i‡(
ex
 > 
	`EXT_FIRST_EXTENT
(
eh
))

1893 
mîge_d⁄e
 = 
	`pxt4_ext_åy_to_mîge_right
(
öode
, 
∑th
, 
ex
 - 1);

1895 i‡(!
mîge_d⁄e
)

1896 (Ë
	`pxt4_ext_åy_to_mîge_right
(
öode
, 
∑th
, 
ex
);

1898 
	`pxt4_ext_åy_to_mîge_up
(
h™dÀ
, 
öode
, 
∑th
);

1899 
	}
}

1909 
	$pxt4_ext_check_ovîœp
(
pxt4_sb_öfo
 *
sbi
,

1910 
öode
 *inode,

1911 
pxt4_exã¡
 *
√wext
,

1912 
pxt4_ext_∑th
 *
∑th
)

1914 
pxt4_lblk_t
 
b1
, 
b2
;

1915 
dïth
, 
Àn1
;

1916 
ªt
 = 0;

1918 
b1
 = 
	`À32_to_˝u
(
√wext
->
ì_block
);

1919 
Àn1
 = 
	`pxt4_ext_gë_a˘uÆ_Àn
(
√wext
);

1920 
dïth
 = 
	`ext_dïth
(
öode
);

1921 i‡(!
∑th
[
dïth
].
p_ext
)

1922 
out
;

1923 
b2
 = 
	`PXT4_LBLK_CMASK
(
sbi
, 
	`À32_to_˝u
(
∑th
[
dïth
].
p_ext
->
ì_block
));

1929 i‡(
b2
 < 
b1
) {

1930 
b2
 = 
	`pxt4_ext_√xt_Æloˇãd_block
(
∑th
);

1931 i‡(
b2
 =
EXT_MAX_BLOCKS
)

1932 
out
;

1933 
b2
 = 
	`PXT4_LBLK_CMASK
(
sbi
, b2);

1937 i‡(
b1
 + 
Àn1
 < b1) {

1938 
Àn1
 = 
EXT_MAX_BLOCKS
 - 
b1
;

1939 
√wext
->
ì_Àn
 = 
	`˝u_to_À16
(
Àn1
);

1940 
ªt
 = 1;

1944 i‡(
b1
 + 
Àn1
 > 
b2
) {

1945 
√wext
->
ì_Àn
 = 
	`˝u_to_À16
(
b2
 - 
b1
);

1946 
ªt
 = 1;

1948 
out
:

1949  
ªt
;

1950 
	}
}

1958 
	$pxt4_ext_ö£π_exã¡
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *inode,

1959 
pxt4_ext_∑th
 **
µ©h
,

1960 
pxt4_exã¡
 *
√wext
, 
gb_Êags
)

1962 
pxt4_ext_∑th
 *
∑th
 = *
µ©h
;

1963 
pxt4_exã¡_hódî
 *
eh
;

1964 
pxt4_exã¡
 *
ex
, *
„x
;

1965 
pxt4_exã¡
 *
√¨ex
;

1966 
pxt4_ext_∑th
 *
≈©h
 = 
NULL
;

1967 
dïth
, 
Àn
, 
îr
;

1968 
pxt4_lblk_t
 
√xt
;

1969 
mb_Êags
 = 0, 
unwrôãn
;

1971 i‡(
gb_Êags
 & 
PXT4_GET_BLOCKS_DELALLOC_RESERVE
)

1972 
mb_Êags
 |
PXT4_MB_DELALLOC_RESERVED
;

1973 i‡(
	`u∆ikñy
(
	`pxt4_ext_gë_a˘uÆ_Àn
(
√wext
) == 0)) {

1974 
	`PXT4_ERROR_INODE
(
öode
, "pxt4_ext_get_actual_len(newext) == 0");

1975  -
EFSCORRUPTED
;

1977 
dïth
 = 
	`ext_dïth
(
öode
);

1978 
ex
 = 
∑th
[
dïth
].
p_ext
;

1979 
eh
 = 
∑th
[
dïth
].
p_hdr
;

1980 i‡(
	`u∆ikñy
(
∑th
[
dïth
].
p_hdr
 =
NULL
)) {

1981 
	`PXT4_ERROR_INODE
(
öode
, "∑th[%d].p_hd∏=NULL", 
dïth
);

1982  -
EFSCORRUPTED
;

1986 i‡(
ex
 && !(
gb_Êags
 & 
PXT4_GET_BLOCKS_PRE_IO
)) {

1995 i‡(
ex
 < 
	`EXT_LAST_EXTENT
(
eh
) &&

1996 (
	`À32_to_˝u
(
ex
->
ì_block
) +

1997 
	`pxt4_ext_gë_a˘uÆ_Àn
(
ex
) <

1998 
	`À32_to_˝u
(
√wext
->
ì_block
))) {

1999 
ex
 += 1;

2000 
¥ïíd
;

2001 } i‡((
ex
 > 
	`EXT_FIRST_EXTENT
(
eh
)) &&

2002 (
	`À32_to_˝u
(
√wext
->
ì_block
) +

2003 
	`pxt4_ext_gë_a˘uÆ_Àn
(
√wext
) <

2004 
	`À32_to_˝u
(
ex
->
ì_block
)))

2005 
ex
 -= 1;

2008 i‡(
	`pxt4_ˇn_exã¡s_be_mîged
(
öode
, 
ex
, 
√wext
)) {

2009 
	`ext_debug
("append [%d]%d blockÅo %u:[%d]%d"

2011 
	`pxt4_ext_is_unwrôãn
(
√wext
),

2012 
	`pxt4_ext_gë_a˘uÆ_Àn
(
√wext
),

2013 
	`À32_to_˝u
(
ex
->
ì_block
),

2014 
	`pxt4_ext_is_unwrôãn
(
ex
),

2015 
	`pxt4_ext_gë_a˘uÆ_Àn
(
ex
),

2016 
	`pxt4_ext_pblock
(
ex
));

2017 
îr
 = 
	`pxt4_ext_gë_ac˚ss
(
h™dÀ
, 
öode
,

2018 
∑th
 + 
dïth
);

2019 i‡(
îr
)

2020  
îr
;

2021 
unwrôãn
 = 
	`pxt4_ext_is_unwrôãn
(
ex
);

2022 
ex
->
ì_Àn
 = 
	`˝u_to_À16
(
	`pxt4_ext_gë_a˘uÆ_Àn
(ex)

2023 + 
	`pxt4_ext_gë_a˘uÆ_Àn
(
√wext
));

2024 i‡(
unwrôãn
)

2025 
	`pxt4_ext_m¨k_unwrôãn
(
ex
);

2026 
eh
 = 
∑th
[
dïth
].
p_hdr
;

2027 
√¨ex
 = 
ex
;

2028 
mîge
;

2031 
¥ïíd
:

2033 i‡(
	`pxt4_ˇn_exã¡s_be_mîged
(
öode
, 
√wext
, 
ex
)) {

2034 
	`ext_debug
("prepend %u[%d]%d blockÅo %u:[%d]%d"

2036 
	`À32_to_˝u
(
√wext
->
ì_block
),

2037 
	`pxt4_ext_is_unwrôãn
(
√wext
),

2038 
	`pxt4_ext_gë_a˘uÆ_Àn
(
√wext
),

2039 
	`À32_to_˝u
(
ex
->
ì_block
),

2040 
	`pxt4_ext_is_unwrôãn
(
ex
),

2041 
	`pxt4_ext_gë_a˘uÆ_Àn
(
ex
),

2042 
	`pxt4_ext_pblock
(
ex
));

2043 
îr
 = 
	`pxt4_ext_gë_ac˚ss
(
h™dÀ
, 
öode
,

2044 
∑th
 + 
dïth
);

2045 i‡(
îr
)

2046  
îr
;

2048 
unwrôãn
 = 
	`pxt4_ext_is_unwrôãn
(
ex
);

2049 
ex
->
ì_block
 = 
√wext
->ee_block;

2050 
	`pxt4_ext_°‹e_pblock
(
ex
, 
	`pxt4_ext_pblock
(
√wext
));

2051 
ex
->
ì_Àn
 = 
	`˝u_to_À16
(
	`pxt4_ext_gë_a˘uÆ_Àn
(ex)

2052 + 
	`pxt4_ext_gë_a˘uÆ_Àn
(
√wext
));

2053 i‡(
unwrôãn
)

2054 
	`pxt4_ext_m¨k_unwrôãn
(
ex
);

2055 
eh
 = 
∑th
[
dïth
].
p_hdr
;

2056 
√¨ex
 = 
ex
;

2057 
mîge
;

2061 
dïth
 = 
	`ext_dïth
(
öode
);

2062 
eh
 = 
∑th
[
dïth
].
p_hdr
;

2063 i‡(
	`À16_to_˝u
(
eh
->
eh_íåõs
Ë<Üe16_to_˝u”h->
eh_max
))

2064 
has_•a˚
;

2067 
„x
 = 
	`EXT_LAST_EXTENT
(
eh
);

2068 
√xt
 = 
EXT_MAX_BLOCKS
;

2069 i‡(
	`À32_to_˝u
(
√wext
->
ì_block
Ë>Üe32_to_˝u(
„x
->ee_block))

2070 
√xt
 = 
	`pxt4_ext_√xt_Àaf_block
(
∑th
);

2071 i‡(
√xt
 !
EXT_MAX_BLOCKS
) {

2072 
	`ext_debug
("√xàÀa‡block - %u\n", 
√xt
);

2073 
	`BUG_ON
(
≈©h
 !
NULL
);

2074 
≈©h
 = 
	`pxt4_föd_exã¡
(
öode
, 
√xt
, 
NULL
, 0);

2075 i‡(
	`IS_ERR
(
≈©h
))

2076  
	`PTR_ERR
(
≈©h
);

2077 
	`BUG_ON
(
≈©h
->
p_dïth
 !
∑th
->p_depth);

2078 
eh
 = 
≈©h
[
dïth
].
p_hdr
;

2079 i‡(
	`À16_to_˝u
(
eh
->
eh_íåõs
Ë<Üe16_to_˝u”h->
eh_max
)) {

2080 
	`ext_debug
("nextÜeaf isn't full(%d)\n",

2081 
	`À16_to_˝u
(
eh
->
eh_íåõs
));

2082 
∑th
 = 
≈©h
;

2083 
has_•a˚
;

2085 
	`ext_debug
("nextÜeaf hasÇo free space(%d,%d)\n",

2086 
	`À16_to_˝u
(
eh
->
eh_íåõs
),Üe16_to_˝u”h->
eh_max
));

2093 i‡(
gb_Êags
 & 
PXT4_GET_BLOCKS_METADATA_NOFAIL
)

2094 
mb_Êags
 |
PXT4_MB_USE_RESERVED
;

2095 
îr
 = 
	`pxt4_ext_¸óã_√w_Àaf
(
h™dÀ
, 
öode
, 
mb_Êags
, 
gb_Êags
,

2096 
µ©h
, 
√wext
);

2097 i‡(
îr
)

2098 
˛ónup
;

2099 
dïth
 = 
	`ext_dïth
(
öode
);

2100 
eh
 = 
∑th
[
dïth
].
p_hdr
;

2102 
has_•a˚
:

2103 
√¨ex
 = 
∑th
[
dïth
].
p_ext
;

2105 
îr
 = 
	`pxt4_ext_gë_ac˚ss
(
h™dÀ
, 
öode
, 
∑th
 + 
dïth
);

2106 i‡(
îr
)

2107 
˛ónup
;

2109 i‡(!
√¨ex
) {

2111 
	`ext_debug
("firstÉxtent inÅheÜeaf: %u:%llu:[%d]%d\n",

2112 
	`À32_to_˝u
(
√wext
->
ì_block
),

2113 
	`pxt4_ext_pblock
(
√wext
),

2114 
	`pxt4_ext_is_unwrôãn
(
√wext
),

2115 
	`pxt4_ext_gë_a˘uÆ_Àn
(
√wext
));

2116 
√¨ex
 = 
	`EXT_FIRST_EXTENT
(
eh
);

2118 i‡(
	`À32_to_˝u
(
√wext
->
ì_block
)

2119 > 
	`À32_to_˝u
(
√¨ex
->
ì_block
)) {

2121 
	`ext_debug
("insert %u:%llu:[%d]%d before: "

2123 
	`À32_to_˝u
(
√wext
->
ì_block
),

2124 
	`pxt4_ext_pblock
(
√wext
),

2125 
	`pxt4_ext_is_unwrôãn
(
√wext
),

2126 
	`pxt4_ext_gë_a˘uÆ_Àn
(
√wext
),

2127 
√¨ex
);

2128 
√¨ex
++;

2131 
	`BUG_ON
(
√wext
->
ì_block
 =
√¨ex
->ee_block);

2132 
	`ext_debug
("insert %u:%llu:[%d]%dáfter: "

2134 
	`À32_to_˝u
(
√wext
->
ì_block
),

2135 
	`pxt4_ext_pblock
(
√wext
),

2136 
	`pxt4_ext_is_unwrôãn
(
√wext
),

2137 
	`pxt4_ext_gë_a˘uÆ_Àn
(
√wext
),

2138 
√¨ex
);

2140 
Àn
 = 
	`EXT_LAST_EXTENT
(
eh
Ë- 
√¨ex
 + 1;

2141 i‡(
Àn
 > 0) {

2142 
	`ext_debug
("insert %u:%llu:[%d]%d: "

2144 
	`À32_to_˝u
(
√wext
->
ì_block
),

2145 
	`pxt4_ext_pblock
(
√wext
),

2146 
	`pxt4_ext_is_unwrôãn
(
√wext
),

2147 
	`pxt4_ext_gë_a˘uÆ_Àn
(
√wext
),

2148 
Àn
, 
√¨ex
,Çearex + 1);

2149 
	`memmove
(
√¨ex
 + 1,Çearex,

2150 
Àn
 * (
pxt4_exã¡
));

2154 
	`À16_add_˝u
(&
eh
->
eh_íåõs
, 1);

2155 
∑th
[
dïth
].
p_ext
 = 
√¨ex
;

2156 
√¨ex
->
ì_block
 = 
√wext
->ee_block;

2157 
	`pxt4_ext_°‹e_pblock
(
√¨ex
, 
	`pxt4_ext_pblock
(
√wext
));

2158 
√¨ex
->
ì_Àn
 = 
√wext
->ee_len;

2160 
mîge
:

2162 i‡(!(
gb_Êags
 & 
PXT4_GET_BLOCKS_PRE_IO
))

2163 
	`pxt4_ext_åy_to_mîge
(
h™dÀ
, 
öode
, 
∑th
, 
√¨ex
);

2167 
îr
 = 
	`pxt4_ext_c‹ª˘_ödexes
(
h™dÀ
, 
öode
, 
∑th
);

2168 i‡(
îr
)

2169 
˛ónup
;

2171 
îr
 = 
	`pxt4_ext_dúty
(
h™dÀ
, 
öode
, 
∑th
 +Ö©h->
p_dïth
);

2173 
˛ónup
:

2174 
	`pxt4_ext_dr›_ªfs
(
≈©h
);

2175 
	`k‰ì
(
≈©h
);

2176  
îr
;

2177 
	}
}

2179 
	$pxt4_fûl_fõm≠_exã¡s
(
öode
 *inode,

2180 
pxt4_lblk_t
 
block
,Öxt4_lblk_à
num
,

2181 
fõm≠_exã¡_öfo
 *
fõöfo
)

2183 
pxt4_ext_∑th
 *
∑th
 = 
NULL
;

2184 
pxt4_exã¡
 *
ex
;

2185 
exã¡_°©us
 
es
;

2186 
pxt4_lblk_t
 
√xt
, 
√xt_dñ
, 
°¨t
 = 0, 
íd
 = 0;

2187 
pxt4_lblk_t
 
œ°
 = 
block
 + 
num
;

2188 
exi°s
, 
dïth
 = 0, 
îr
 = 0;

2189 
Êags
 = 0;

2190 
blksize_bôs
 = 
öode
->
i_sb
->
s_blocksize_bôs
;

2192 
block
 < 
œ°
 && block !
EXT_MAX_BLOCKS
) {

2193 
num
 = 
œ°
 - 
block
;

2195 
	`down_ªad
(&
	`PXT4_I
(
öode
)->
i_d©a_£m
);

2197 
∑th
 = 
	`pxt4_föd_exã¡
(
öode
, 
block
, &path, 0);

2198 i‡(
	`IS_ERR
(
∑th
)) {

2199 
	`up_ªad
(&
	`PXT4_I
(
öode
)->
i_d©a_£m
);

2200 
îr
 = 
	`PTR_ERR
(
∑th
);

2201 
∑th
 = 
NULL
;

2205 
dïth
 = 
	`ext_dïth
(
öode
);

2206 i‡(
	`u∆ikñy
(
∑th
[
dïth
].
p_hdr
 =
NULL
)) {

2207 
	`up_ªad
(&
	`PXT4_I
(
öode
)->
i_d©a_£m
);

2208 
	`PXT4_ERROR_INODE
(
öode
, "∑th[%d].p_hd∏=NULL", 
dïth
);

2209 
îr
 = -
EFSCORRUPTED
;

2212 
ex
 = 
∑th
[
dïth
].
p_ext
;

2213 
√xt
 = 
	`pxt4_ext_√xt_Æloˇãd_block
(
∑th
);

2215 
Êags
 = 0;

2216 
exi°s
 = 0;

2217 i‡(!
ex
) {

2220 
°¨t
 = 
block
;

2221 
íd
 = 
block
 + 
num
;

2222 } i‡(
	`À32_to_˝u
(
ex
->
ì_block
Ë> 
block
) {

2224 
°¨t
 = 
block
;

2225 
íd
 = 
	`À32_to_˝u
(
ex
->
ì_block
);

2226 i‡(
block
 + 
num
 < 
íd
)

2227 
íd
 = 
block
 + 
num
;

2228 } i‡(
block
 >
	`À32_to_˝u
(
ex
->
ì_block
)

2229 + 
	`pxt4_ext_gë_a˘uÆ_Àn
(
ex
)) {

2231 
°¨t
 = 
block
;

2232 
íd
 = 
block
 + 
num
;

2233 i‡(
íd
 >
√xt
)

2234 
íd
 = 
√xt
;

2235 } i‡(
block
 >
	`À32_to_˝u
(
ex
->
ì_block
)) {

2240 
°¨t
 = 
block
;

2241 
íd
 = 
	`À32_to_˝u
(
ex
->
ì_block
)

2242 + 
	`pxt4_ext_gë_a˘uÆ_Àn
(
ex
);

2243 i‡(
block
 + 
num
 < 
íd
)

2244 
íd
 = 
block
 + 
num
;

2245 
exi°s
 = 1;

2247 
	`BUG
();

2249 
	`BUG_ON
(
íd
 <
°¨t
);

2251 i‡(!
exi°s
) {

2252 
es
.
es_lblk
 = 
°¨t
;

2253 
es
.
es_Àn
 = 
íd
 - 
°¨t
;

2254 
es
.
es_pblk
 = 0;

2256 
es
.
es_lblk
 = 
	`À32_to_˝u
(
ex
->
ì_block
);

2257 
es
.
es_Àn
 = 
	`pxt4_ext_gë_a˘uÆ_Àn
(
ex
);

2258 
es
.
es_pblk
 = 
	`pxt4_ext_pblock
(
ex
);

2259 i‡(
	`pxt4_ext_is_unwrôãn
(
ex
))

2260 
Êags
 |
FIEMAP_EXTENT_UNWRITTEN
;

2268 
√xt_dñ
 = 
	`pxt4_föd_dñayed_exã¡
(
öode
, &
es
);

2269 i‡(!
exi°s
 && 
√xt_dñ
) {

2270 
exi°s
 = 1;

2271 
Êags
 |(
FIEMAP_EXTENT_DELALLOC
 |

2272 
FIEMAP_EXTENT_UNKNOWN
);

2274 
	`up_ªad
(&
	`PXT4_I
(
öode
)->
i_d©a_£m
);

2276 i‡(
	`u∆ikñy
(
es
.
es_Àn
 == 0)) {

2277 
	`PXT4_ERROR_INODE
(
öode
, "es.es_len == 0");

2278 
îr
 = -
EFSCORRUPTED
;

2293 i‡(
√xt
 =
√xt_dñ
 &&Çexà=
EXT_MAX_BLOCKS
) {

2294 
Êags
 |
FIEMAP_EXTENT_LAST
;

2295 i‡(
	`u∆ikñy
(
√xt_dñ
 !
EXT_MAX_BLOCKS
 ||

2296 
√xt
 !
EXT_MAX_BLOCKS
)) {

2297 
	`PXT4_ERROR_INODE
(
öode
,

2300 
√xt
, 
√xt_dñ
);

2301 
îr
 = -
EFSCORRUPTED
;

2306 i‡(
exi°s
) {

2307 
îr
 = 
	`fõm≠_fûl_√xt_exã¡
(
fõöfo
,

2308 (
__u64
)
es
.
es_lblk
 << 
blksize_bôs
,

2309 (
__u64
)
es
.
es_pblk
 << 
blksize_bôs
,

2310 (
__u64
)
es
.
es_Àn
 << 
blksize_bôs
,

2311 
Êags
);

2312 i‡(
îr
 < 0)

2314 i‡(
îr
 == 1) {

2315 
îr
 = 0;

2320 
block
 = 
es
.
es_lblk
 +És.
es_Àn
;

2323 
	`pxt4_ext_dr›_ªfs
(
∑th
);

2324 
	`k‰ì
(
∑th
);

2325  
îr
;

2326 
	}
}

2328 
	$pxt4_fûl_es_ˇche_öfo
(
öode
 *inode,

2329 
pxt4_lblk_t
 
block
,Öxt4_lblk_à
num
,

2330 
fõm≠_exã¡_öfo
 *
fõöfo
)

2332 
pxt4_lblk_t
 
√xt
, 
íd
 = 
block
 + 
num
 - 1;

2333 
exã¡_°©us
 
es
;

2334 
blksize_bôs
 = 
öode
->
i_sb
->
s_blocksize_bôs
;

2335 
Êags
;

2336 
îr
;

2338 
block
 <
íd
) {

2339 
√xt
 = 0;

2340 
Êags
 = 0;

2341 i‡(!
	`pxt4_es_lookup_exã¡
(
öode
, 
block
, &
√xt
, &
es
))

2343 i‡(
	`pxt4_es_is_unwrôãn
(&
es
))

2344 
Êags
 |
FIEMAP_EXTENT_UNWRITTEN
;

2345 i‡(
	`pxt4_es_is_dñayed
(&
es
))

2346 
Êags
 |(
FIEMAP_EXTENT_DELALLOC
 |

2347 
FIEMAP_EXTENT_UNKNOWN
);

2348 i‡(
	`pxt4_es_is_hﬁe
(&
es
))

2349 
Êags
 |
PXT4_FIEMAP_EXTENT_HOLE
;

2350 i‡(
√xt
 == 0)

2351 
Êags
 |
FIEMAP_EXTENT_LAST
;

2352 i‡(
Êags
 & (
FIEMAP_EXTENT_DELALLOC
|

2353 
PXT4_FIEMAP_EXTENT_HOLE
))

2354 
es
.
es_pblk
 = 0;

2356 
es
.
es_pblk
 = 
	`pxt4_es_pblock
(&es);

2357 
îr
 = 
	`fõm≠_fûl_√xt_exã¡
(
fõöfo
,

2358 (
__u64
)
es
.
es_lblk
 << 
blksize_bôs
,

2359 (
__u64
)
es
.
es_pblk
 << 
blksize_bôs
,

2360 (
__u64
)
es
.
es_Àn
 << 
blksize_bôs
,

2361 
Êags
);

2362 i‡(
√xt
 == 0)

2364 
block
 = 
√xt
;

2365 i‡(
îr
 < 0)

2366  
îr
;

2367 i‡(
îr
 == 1)

2371 
	}
}

2387 
pxt4_lblk_t
 
	$pxt4_ext_dëîmöe_hﬁe
(
öode
 *inode,

2388 
pxt4_ext_∑th
 *
∑th
,

2389 
pxt4_lblk_t
 *
lblk
)

2391 
dïth
 = 
	`ext_dïth
(
öode
);

2392 
pxt4_exã¡
 *
ex
;

2393 
pxt4_lblk_t
 
Àn
;

2395 
ex
 = 
∑th
[
dïth
].
p_ext
;

2396 i‡(
ex
 =
NULL
) {

2398 *
lblk
 = 0;

2399 
Àn
 = 
EXT_MAX_BLOCKS
;

2400 } i‡(*
lblk
 < 
	`À32_to_˝u
(
ex
->
ì_block
)) {

2401 
Àn
 = 
	`À32_to_˝u
(
ex
->
ì_block
Ë- *
lblk
;

2402 } i‡(*
lblk
 >
	`À32_to_˝u
(
ex
->
ì_block
)

2403 + 
	`pxt4_ext_gë_a˘uÆ_Àn
(
ex
)) {

2404 
pxt4_lblk_t
 
√xt
;

2406 *
lblk
 = 
	`À32_to_˝u
(
ex
->
ì_block
Ë+ 
	`pxt4_ext_gë_a˘uÆ_Àn
(ex);

2407 
√xt
 = 
	`pxt4_ext_√xt_Æloˇãd_block
(
∑th
);

2408 
	`BUG_ON
(
√xt
 =*
lblk
);

2409 
Àn
 = 
√xt
 - *
lblk
;

2411 
	`BUG
();

2413  
Àn
;

2414 
	}
}

2422 
	$pxt4_ext_put_g≠_ö_ˇche
(
öode
 *öode, 
pxt4_lblk_t
 
hﬁe_°¨t
,

2423 
pxt4_lblk_t
 
hﬁe_Àn
)

2425 
exã¡_°©us
 
es
;

2427 
	`pxt4_es_föd_exã¡_ønge
(
öode
, &
pxt4_es_is_dñayed
, 
hﬁe_°¨t
,

2428 
hﬁe_°¨t
 + 
hﬁe_Àn
 - 1, &
es
);

2429 i‡(
es
.
es_Àn
) {

2431 i‡(
es
.
es_lblk
 <
hﬁe_°¨t
)

2433 
hﬁe_Àn
 = 
	`mö
(
es
.
es_lblk
 - 
hﬁe_°¨t
, hole_len);

2435 
	`ext_debug
(" -> %u:%u\n", 
hﬁe_°¨t
, 
hﬁe_Àn
);

2436 
	`pxt4_es_ö£π_exã¡
(
öode
, 
hﬁe_°¨t
, 
hﬁe_Àn
, ~0,

2437 
EXTENT_STATUS_HOLE
);

2438 
	}
}

2444 
	$pxt4_ext_rm_idx
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *inode,

2445 
pxt4_ext_∑th
 *
∑th
, 
dïth
)

2447 
îr
;

2448 
pxt4_fsblk_t
 
Àaf
;

2451 
dïth
--;

2452 
∑th
 =Ö©h + 
dïth
;

2453 
Àaf
 = 
	`pxt4_idx_pblock
(
∑th
->
p_idx
);

2454 i‡(
	`u∆ikñy
(
∑th
->
p_hdr
->
eh_íåõs
 == 0)) {

2455 
	`PXT4_ERROR_INODE
(
öode
, "path->p_hdr->eh_entries == 0");

2456  -
EFSCORRUPTED
;

2458 
îr
 = 
	`pxt4_ext_gë_ac˚ss
(
h™dÀ
, 
öode
, 
∑th
);

2459 i‡(
îr
)

2460  
îr
;

2462 i‡(
∑th
->
p_idx
 !
	`EXT_LAST_INDEX
’©h->
p_hdr
)) {

2463 
Àn
 = 
	`EXT_LAST_INDEX
(
∑th
->
p_hdr
Ë-Ö©h->
p_idx
;

2464 
Àn
 *(
pxt4_exã¡_idx
);

2465 
	`memmove
(
∑th
->
p_idx
,Ö©h->p_idx + 1, 
Àn
);

2468 
	`À16_add_˝u
(&
∑th
->
p_hdr
->
eh_íåõs
, -1);

2469 
îr
 = 
	`pxt4_ext_dúty
(
h™dÀ
, 
öode
, 
∑th
);

2470 i‡(
îr
)

2471  
îr
;

2472 
	`ext_debug
("ödex i†em±y,Ñemovêô, fªêblock %Œu\n", 
Àaf
);

2473 
	`åa˚_pxt4_ext_rm_idx
(
öode
, 
Àaf
);

2475 
	`pxt4_‰ì_blocks
(
h™dÀ
, 
öode
, 
NULL
, 
Àaf
, 1,

2476 
PXT4_FREE_BLOCKS_METADATA
 | 
PXT4_FREE_BLOCKS_FORGET
);

2478 --
dïth
 >= 0) {

2479 i‡(
∑th
->
p_idx
 !
	`EXT_FIRST_INDEX
’©h->
p_hdr
))

2481 
∑th
--;

2482 
îr
 = 
	`pxt4_ext_gë_ac˚ss
(
h™dÀ
, 
öode
, 
∑th
);

2483 i‡(
îr
)

2485 
∑th
->
p_idx
->
ei_block
 = (path+1)->p_idx->ei_block;

2486 
îr
 = 
	`pxt4_ext_dúty
(
h™dÀ
, 
öode
, 
∑th
);

2487 i‡(
îr
)

2490  
îr
;

2491 
	}
}

2500 
	$pxt4_ext_ˇlc_¸edôs_f‹_sögÀ_exã¡
(
öode
 *öode, 
ƒblocks
,

2501 
pxt4_ext_∑th
 *
∑th
)

2503 i‡(
∑th
) {

2504 
dïth
 = 
	`ext_dïth
(
öode
);

2505 
ªt
 = 0;

2508 i‡(
	`À16_to_˝u
(
∑th
[
dïth
].
p_hdr
->
eh_íåõs
)

2509 < 
	`À16_to_˝u
(
∑th
[
dïth
].
p_hdr
->
eh_max
)) {

2520 
ªt
 = 2 + 
	`PXT4_META_TRANS_BLOCKS
(
öode
->
i_sb
);

2521  
ªt
;

2525  
	`pxt4_chunk_å™s_blocks
(
öode
, 
ƒblocks
);

2526 
	}
}

2537 
	$pxt4_ext_ödex_å™s_blocks
(
öode
 *öode, 
exã¡s
)

2539 
ödex
;

2540 
dïth
;

2543 i‡(
	`pxt4_has_ölöe_d©a
(
öode
))

2546 
dïth
 = 
	`ext_dïth
(
öode
);

2548 i‡(
exã¡s
 <= 1)

2549 
ödex
 = 
dïth
 * 2;

2551 
ödex
 = 
dïth
 * 3;

2553  
ödex
;

2554 
	}
}

2556 
ölöe
 
	$gë_deÁu…_‰ì_blocks_Êags
(
öode
 *inode)

2558 i‡(
	`S_ISDIR
(
öode
->
i_mode
Ë|| 
	`S_ISLNK
(inode->i_mode) ||

2559 
	`pxt4_ã°_öode_Êag
(
öode
, 
PXT4_INODE_EA_INODE
))

2560  
PXT4_FREE_BLOCKS_METADATA
 | 
PXT4_FREE_BLOCKS_FORGET
;

2561 i‡(
	`pxt4_should_jou∫Æ_d©a
(
öode
))

2562  
PXT4_FREE_BLOCKS_FORGET
;

2564 
	}
}

2581 
	$pxt4_ªª£rve_˛u°î
(
öode
 *öode, 
pxt4_lblk_t
 
lblk
)

2583 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
öode
->
i_sb
);

2584 
pxt4_öode_öfo
 *
ei
 = 
	`PXT4_I
(
öode
);

2586 
	`dquŸ_ª˛aim_block
(
öode
, 
	`PXT4_C2B
(
sbi
, 1));

2588 
	`•ö_lock
(&
ei
->
i_block_ª£rv©i⁄_lock
);

2589 
ei
->
i_ª£rved_d©a_blocks
++;

2590 
	`≥r˝u_cou¡î_add
(&
sbi
->
s_dúty˛u°îs_cou¡î
, 1);

2591 
	`•ö_u∆ock
(&
ei
->
i_block_ª£rv©i⁄_lock
);

2593 
	`≥r˝u_cou¡î_add
(&
sbi
->
s_‰ì˛u°îs_cou¡î
, 1);

2594 
	`pxt4_ªmove_≥ndög
(
öode
, 
lblk
);

2595 
	}
}

2597 
	$pxt4_ªmove_blocks
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *inode,

2598 
pxt4_exã¡
 *
ex
,

2599 
∑πül_˛u°î
 *
∑πül
,

2600 
pxt4_lblk_t
 
‰om
,Öxt4_lblk_à
to
)

2602 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
öode
->
i_sb
);

2603 
ì_Àn
 = 
	`pxt4_ext_gë_a˘uÆ_Àn
(
ex
);

2604 
pxt4_fsblk_t
 
œ°_pblk
, 
pblk
;

2605 
pxt4_lblk_t
 
num
;

2606 
Êags
;

2609 i‡(
‰om
 < 
	`À32_to_˝u
(
ex
->
ì_block
) ||

2610 
to
 !
	`À32_to_˝u
(
ex
->
ì_block
Ë+ 
ì_Àn
 - 1) {

2611 
	`pxt4_îr‹
(
sbi
->
s_sb
,

2613 
‰om
, 
to
, 
	`À32_to_˝u
(
ex
->
ì_block
), 
ì_Àn
);

2617 #ifde‡
EXTENTS_STATS


2618 
	`•ö_lock
(&
sbi
->
s_ext_°©s_lock
);

2619 
sbi
->
s_ext_blocks
 +
ì_Àn
;

2620 
sbi
->
s_ext_exã¡s
++;

2621 i‡(
ì_Àn
 < 
sbi
->
s_ext_mö
)

2622 
sbi
->
s_ext_mö
 = 
ì_Àn
;

2623 i‡(
ì_Àn
 > 
sbi
->
s_ext_max
)

2624 
sbi
->
s_ext_max
 = 
ì_Àn
;

2625 i‡(
	`ext_dïth
(
öode
Ë> 
sbi
->
s_dïth_max
)

2626 
sbi
->
s_dïth_max
 = 
	`ext_dïth
(
öode
);

2627 
	`•ö_u∆ock
(&
sbi
->
s_ext_°©s_lock
);

2630 
	`åa˚_pxt4_ªmove_blocks
(
öode
, 
ex
, 
‰om
, 
to
, 
∑πül
);

2636 
œ°_pblk
 = 
	`pxt4_ext_pblock
(
ex
Ë+ 
ì_Àn
 - 1;

2638 i‡(
∑πül
->
°©e
 !
öôül
 &&

2639 
∑πül
->
p˛u
 !
	`PXT4_B2C
(
sbi
, 
œ°_pblk
)) {

2640 i‡(
∑πül
->
°©e
 =
to‰ì
) {

2641 
Êags
 = 
	`gë_deÁu…_‰ì_blocks_Êags
(
öode
);

2642 i‡(
	`pxt4_is_≥ndög
(
öode
, 
∑πül
->
lblk
))

2643 
Êags
 |
PXT4_FREE_BLOCKS_RERESERVE_CLUSTER
;

2644 
	`pxt4_‰ì_blocks
(
h™dÀ
, 
öode
, 
NULL
,

2645 
	`PXT4_C2B
(
sbi
, 
∑πül
->
p˛u
),

2646 
sbi
->
s_˛u°î_øtio
, 
Êags
);

2647 i‡(
Êags
 & 
PXT4_FREE_BLOCKS_RERESERVE_CLUSTER
)

2648 
	`pxt4_ªª£rve_˛u°î
(
öode
, 
∑πül
->
lblk
);

2650 
∑πül
->
°©e
 = 
öôül
;

2653 
num
 = 
	`À32_to_˝u
(
ex
->
ì_block
Ë+ 
ì_Àn
 - 
‰om
;

2654 
pblk
 = 
	`pxt4_ext_pblock
(
ex
Ë+ 
ì_Àn
 - 
num
;

2662 
Êags
 = 
	`gë_deÁu…_‰ì_blocks_Êags
(
öode
);

2665 i‡((
	`PXT4_LBLK_COFF
(
sbi
, 
to
Ë!sbi->
s_˛u°î_øtio
 - 1) &&

2666 (
	`PXT4_LBLK_CMASK
(
sbi
, 
to
Ë>
‰om
) &&

2667 (
∑πül
->
°©e
 !
no‰ì
)) {

2668 i‡(
	`pxt4_is_≥ndög
(
öode
, 
to
))

2669 
Êags
 |
PXT4_FREE_BLOCKS_RERESERVE_CLUSTER
;

2670 
	`pxt4_‰ì_blocks
(
h™dÀ
, 
öode
, 
NULL
,

2671 
	`PXT4_PBLK_CMASK
(
sbi
, 
œ°_pblk
),

2672 
sbi
->
s_˛u°î_øtio
, 
Êags
);

2673 i‡(
Êags
 & 
PXT4_FREE_BLOCKS_RERESERVE_CLUSTER
)

2674 
	`pxt4_ªª£rve_˛u°î
(
öode
, 
to
);

2675 
∑πül
->
°©e
 = 
öôül
;

2676 
Êags
 = 
	`gë_deÁu…_‰ì_blocks_Êags
(
öode
);

2679 
Êags
 |
PXT4_FREE_BLOCKS_NOFREE_LAST_CLUSTER
;

2687 
Êags
 |
PXT4_FREE_BLOCKS_NOFREE_FIRST_CLUSTER
;

2688 
	`pxt4_‰ì_blocks
(
h™dÀ
, 
öode
, 
NULL
, 
pblk
, 
num
, 
Êags
);

2691 i‡(
∑πül
->
°©e
 !
öôül
 &&Ö¨tül->
p˛u
 !
	`PXT4_B2C
(
sbi
, 
pblk
))

2692 
∑πül
->
°©e
 = 
öôül
;

2704 i‡(
	`PXT4_LBLK_COFF
(
sbi
, 
‰om
Ë&& 
num
 =
ì_Àn
) {

2705 i‡(
∑πül
->
°©e
 =
öôül
) {

2706 
∑πül
->
p˛u
 = 
	`PXT4_B2C
(
sbi
, 
pblk
);

2707 
∑πül
->
lblk
 = 
‰om
;

2708 
∑πül
->
°©e
 = 
to‰ì
;

2711 
∑πül
->
°©e
 = 
öôül
;

2715 
	}
}

2733 
	$pxt4_ext_rm_Àaf
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *inode,

2734 
pxt4_ext_∑th
 *
∑th
,

2735 
∑πül_˛u°î
 *
∑πül
,

2736 
pxt4_lblk_t
 
°¨t
,Öxt4_lblk_à
íd
)

2738 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
öode
->
i_sb
);

2739 
îr
 = 0, 
c‹ª˘_ödex
 = 0;

2740 
dïth
 = 
	`ext_dïth
(
öode
), 
¸edôs
;

2741 
pxt4_exã¡_hódî
 *
eh
;

2742 
pxt4_lblk_t
 
a
, 
b
;

2743 
num
;

2744 
pxt4_lblk_t
 
ex_ì_block
;

2745 
ex_ì_Àn
;

2746 
unwrôãn
 = 0;

2747 
pxt4_exã¡
 *
ex
;

2748 
pxt4_fsblk_t
 
pblk
;

2751 
	`ext_debug
("åunˇã sö˚ %u i¿Àa‡tÿ%u\n", 
°¨t
, 
íd
);

2752 i‡(!
∑th
[
dïth
].
p_hdr
)

2753 
∑th
[
dïth
].
p_hdr
 = 
	`ext_block_hdr
’©h[dïth].
p_bh
);

2754 
eh
 = 
∑th
[
dïth
].
p_hdr
;

2755 i‡(
	`u∆ikñy
(
∑th
[
dïth
].
p_hdr
 =
NULL
)) {

2756 
	`PXT4_ERROR_INODE
(
öode
, "∑th[%d].p_hd∏=NULL", 
dïth
);

2757  -
EFSCORRUPTED
;

2760 
ex
 = 
∑th
[
dïth
].
p_ext
;

2761 i‡(!
ex
)

2762 
ex
 = 
	`EXT_LAST_EXTENT
(
eh
);

2764 
ex_ì_block
 = 
	`À32_to_˝u
(
ex
->
ì_block
);

2765 
ex_ì_Àn
 = 
	`pxt4_ext_gë_a˘uÆ_Àn
(
ex
);

2767 
	`åa˚_pxt4_ext_rm_Àaf
(
öode
, 
°¨t
, 
ex
, 
∑πül
);

2769 
ex
 >
	`EXT_FIRST_EXTENT
(
eh
) &&

2770 
ex_ì_block
 + 
ex_ì_Àn
 > 
°¨t
) {

2772 i‡(
	`pxt4_ext_is_unwrôãn
(
ex
))

2773 
unwrôãn
 = 1;

2775 
unwrôãn
 = 0;

2777 
	`ext_debug
("ªmovêexà%u:[%d]%d\n", 
ex_ì_block
,

2778 
unwrôãn
, 
ex_ì_Àn
);

2779 
∑th
[
dïth
].
p_ext
 = 
ex
;

2781 
a
 = 
ex_ì_block
 > 
°¨t
 ?Éx_ee_block : start;

2782 
b
 = 
ex_ì_block
+
ex_ì_Àn
 - 1 < 
íd
 ?

2783 
ex_ì_block
+
ex_ì_Àn
 - 1 : 
íd
;

2785 
	`ext_debug
(" b‹dî %u:%u\n", 
a
, 
b
);

2788 i‡(
íd
 < 
ex_ì_block
) {

2796 i‡(
sbi
->
s_˛u°î_øtio
 > 1) {

2797 
pblk
 = 
	`pxt4_ext_pblock
(
ex
);

2798 
∑πül
->
p˛u
 = 
	`PXT4_B2C
(
sbi
, 
pblk
);

2799 
∑πül
->
°©e
 = 
no‰ì
;

2801 
ex
--;

2802 
ex_ì_block
 = 
	`À32_to_˝u
(
ex
->
ì_block
);

2803 
ex_ì_Àn
 = 
	`pxt4_ext_gë_a˘uÆ_Àn
(
ex
);

2805 } i‡(
b
 !
ex_ì_block
 + 
ex_ì_Àn
 - 1) {

2806 
	`PXT4_ERROR_INODE
(
öode
,

2809 
°¨t
, 
íd
, 
ex_ì_block
,

2810 
ex_ì_block
 + 
ex_ì_Àn
 - 1);

2811 
îr
 = -
EFSCORRUPTED
;

2812 
out
;

2813 } i‡(
a
 !
ex_ì_block
) {

2815 
num
 = 
a
 - 
ex_ì_block
;

2818 
num
 = 0;

2826 
¸edôs
 = 7 + 2*(
ex_ì_Àn
/
	`PXT4_BLOCKS_PER_GROUP
(
öode
->
i_sb
));

2827 i‡(
ex
 =
	`EXT_FIRST_EXTENT
(
eh
)) {

2828 
c‹ª˘_ödex
 = 1;

2829 
¸edôs
 +(
	`ext_dïth
(
öode
)) + 1;

2831 
¸edôs
 +
	`PXT4_MAXQUOTAS_TRANS_BLOCKS
(
öode
->
i_sb
);

2833 
îr
 = 
	`pxt4_ext_åunˇã_exãnd_ª°¨t
(
h™dÀ
, 
öode
, 
¸edôs
);

2834 i‡(
îr
)

2835 
out
;

2837 
îr
 = 
	`pxt4_ext_gë_ac˚ss
(
h™dÀ
, 
öode
, 
∑th
 + 
dïth
);

2838 i‡(
îr
)

2839 
out
;

2841 
îr
 = 
	`pxt4_ªmove_blocks
(
h™dÀ
, 
öode
, 
ex
, 
∑πül
, 
a
, 
b
);

2842 i‡(
îr
)

2843 
out
;

2845 i‡(
num
 == 0)

2847 
	`pxt4_ext_°‹e_pblock
(
ex
, 0);

2849 
ex
->
ì_Àn
 = 
	`˝u_to_À16
(
num
);

2854 i‡(
unwrôãn
 && 
num
)

2855 
	`pxt4_ext_m¨k_unwrôãn
(
ex
);

2860 i‡(
num
 == 0) {

2861 i‡(
íd
 !
EXT_MAX_BLOCKS
 - 1) {

2867 
	`memmove
(
ex
,Éx+1, (
	`EXT_LAST_EXTENT
(
eh
) -Éx) *

2868 (
pxt4_exã¡
));

2871 
	`mem£t
(
	`EXT_LAST_EXTENT
(
eh
), 0,

2872 (
pxt4_exã¡
));

2874 
	`À16_add_˝u
(&
eh
->
eh_íåõs
, -1);

2877 
îr
 = 
	`pxt4_ext_dúty
(
h™dÀ
, 
öode
, 
∑th
 + 
dïth
);

2878 i‡(
îr
)

2879 
out
;

2881 
	`ext_debug
("√wÉxã¡: %u:%u:%Œu\n", 
ex_ì_block
, 
num
,

2882 
	`pxt4_ext_pblock
(
ex
));

2883 
ex
--;

2884 
ex_ì_block
 = 
	`À32_to_˝u
(
ex
->
ì_block
);

2885 
ex_ì_Àn
 = 
	`pxt4_ext_gë_a˘uÆ_Àn
(
ex
);

2888 i‡(
c‹ª˘_ödex
 && 
eh
->
eh_íåõs
)

2889 
îr
 = 
	`pxt4_ext_c‹ª˘_ödexes
(
h™dÀ
, 
öode
, 
∑th
);

2898 i‡(
∑πül
->
°©e
 =
to‰ì
 && 
ex
 >
	`EXT_FIRST_EXTENT
(
eh
)) {

2899 
pblk
 = 
	`pxt4_ext_pblock
(
ex
Ë+ 
ex_ì_Àn
 - 1;

2900 i‡(
∑πül
->
p˛u
 !
	`PXT4_B2C
(
sbi
, 
pblk
)) {

2901 
Êags
 = 
	`gë_deÁu…_‰ì_blocks_Êags
(
öode
);

2903 i‡(
	`pxt4_is_≥ndög
(
öode
, 
∑πül
->
lblk
))

2904 
Êags
 |
PXT4_FREE_BLOCKS_RERESERVE_CLUSTER
;

2905 
	`pxt4_‰ì_blocks
(
h™dÀ
, 
öode
, 
NULL
,

2906 
	`PXT4_C2B
(
sbi
, 
∑πül
->
p˛u
),

2907 
sbi
->
s_˛u°î_øtio
, 
Êags
);

2908 i‡(
Êags
 & 
PXT4_FREE_BLOCKS_RERESERVE_CLUSTER
)

2909 
	`pxt4_ªª£rve_˛u°î
(
öode
, 
∑πül
->
lblk
);

2911 
∑πül
->
°©e
 = 
öôül
;

2916 i‡(
îr
 =0 && 
eh
->
eh_íåõs
 =0 && 
∑th
[
dïth
].
p_bh
 !
NULL
)

2917 
îr
 = 
	`pxt4_ext_rm_idx
(
h™dÀ
, 
öode
, 
∑th
, 
dïth
);

2919 
out
:

2920  
îr
;

2921 
	}
}

2928 
	$pxt4_ext_m‹e_to_rm
(
pxt4_ext_∑th
 *
∑th
)

2930 
	`BUG_ON
(
∑th
->
p_idx
 =
NULL
);

2932 i‡(
∑th
->
p_idx
 < 
	`EXT_FIRST_INDEX
’©h->
p_hdr
))

2939 i‡(
	`À16_to_˝u
(
∑th
->
p_hdr
->
eh_íåõs
Ë=∑th->
p_block
)

2942 
	}
}

2944 
	$pxt4_ext_ªmove_•a˚
(
öode
 *öode, 
pxt4_lblk_t
 
°¨t
,

2945 
pxt4_lblk_t
 
íd
)

2947 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
öode
->
i_sb
);

2948 
dïth
 = 
	`ext_dïth
(
öode
);

2949 
pxt4_ext_∑th
 *
∑th
 = 
NULL
;

2950 
∑πül_˛u°î
 
∑πül
;

2951 
h™dÀ_t
 *
h™dÀ
;

2952 
i
 = 0, 
îr
 = 0;

2954 
∑πül
.
p˛u
 = 0;

2955 
∑πül
.
lblk
 = 0;

2956 
∑πül
.
°©e
 = 
öôül
;

2958 
	`ext_debug
("åunˇã sö˚ %uÅÿ%u\n", 
°¨t
, 
íd
);

2961 
h™dÀ
 = 
	`pxt4_jou∫Æ_°¨t
(
öode
, 
PXT4_HT_TRUNCATE
, 
dïth
 + 1);

2962 i‡(
	`IS_ERR
(
h™dÀ
))

2963  
	`PTR_ERR
(
h™dÀ
);

2965 
agaö
:

2966 
	`åa˚_pxt4_ext_ªmove_•a˚
(
öode
, 
°¨t
, 
íd
, 
dïth
);

2975 i‡(
íd
 < 
EXT_MAX_BLOCKS
 - 1) {

2976 
pxt4_exã¡
 *
ex
;

2977 
pxt4_lblk_t
 
ì_block
, 
ex_íd
, 
lblk
;

2978 
pxt4_fsblk_t
 
pblk
;

2981 
∑th
 = 
	`pxt4_föd_exã¡
(
öode
, 
íd
, 
NULL
, 
PXT4_EX_NOCACHE
);

2982 i‡(
	`IS_ERR
(
∑th
)) {

2983 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

2984  
	`PTR_ERR
(
∑th
);

2986 
dïth
 = 
	`ext_dïth
(
öode
);

2988 
ex
 = 
∑th
[
dïth
].
p_ext
;

2989 i‡(!
ex
) {

2990 i‡(
dïth
) {

2991 
	`PXT4_ERROR_INODE
(
öode
,

2993 
dïth
);

2994 
îr
 = -
EFSCORRUPTED
;

2996 
out
;

2999 
ì_block
 = 
	`À32_to_˝u
(
ex
->ee_block);

3000 
ex_íd
 = 
ì_block
 + 
	`pxt4_ext_gë_a˘uÆ_Àn
(
ex
) - 1;

3008 i‡(
íd
 >
ì_block
 &&Énd < 
ex_íd
) {

3015 i‡(
sbi
->
s_˛u°î_øtio
 > 1) {

3016 
pblk
 = 
	`pxt4_ext_pblock
(
ex
Ë+ 
íd
 - 
ì_block
 + 1;

3017 
∑πül
.
p˛u
 = 
	`PXT4_B2C
(
sbi
, 
pblk
);

3018 
∑πül
.
°©e
 = 
no‰ì
;

3027 
îr
 = 
	`pxt4_f‹˚_•lô_exã¡_©
(
h™dÀ
, 
öode
, &
∑th
,

3028 
íd
 + 1, 1);

3029 i‡(
îr
 < 0)

3030 
out
;

3032 } i‡(
sbi
->
s_˛u°î_øtio
 > 1 && 
íd
 >
ex_íd
 &&

3033 
∑πül
.
°©e
 =
öôül
) {

3044 
lblk
 = 
ex_íd
 + 1;

3045 
îr
 = 
	`pxt4_ext_£¨ch_right
(
öode
, 
∑th
, &
lblk
, &
pblk
,

3046 &
ex
);

3047 i‡(
îr
)

3048 
out
;

3049 i‡(
pblk
) {

3050 
∑πül
.
p˛u
 = 
	`PXT4_B2C
(
sbi
, 
pblk
);

3051 
∑πül
.
°©e
 = 
no‰ì
;

3059 
dïth
 = 
	`ext_dïth
(
öode
);

3060 i‡(
∑th
) {

3061 
k
 = 
i
 = 
dïth
;

3062 --
k
 > 0)

3063 
∑th
[
k
].
p_block
 =

3064 
	`À16_to_˝u
(
∑th
[
k
].
p_hdr
->
eh_íåõs
)+1;

3066 
∑th
 = 
	`kˇŒoc
(
dïth
 + 1, (
pxt4_ext_∑th
),

3067 
GFP_NOFS
);

3068 i‡(
∑th
 =
NULL
) {

3069 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

3070  -
ENOMEM
;

3072 
∑th
[0].
p_maxdïth
 =Ö©h[0].
p_dïth
 = 
dïth
;

3073 
∑th
[0].
p_hdr
 = 
	`ext_öode_hdr
(
öode
);

3074 
i
 = 0;

3076 i‡(
	`pxt4_ext_check
(
öode
, 
∑th
[0].
p_hdr
, 
dïth
, 0)) {

3077 
îr
 = -
EFSCORRUPTED
;

3078 
out
;

3081 
îr
 = 0;

3083 
i
 >0 && 
îr
 == 0) {

3084 i‡(
i
 =
dïth
) {

3086 
îr
 = 
	`pxt4_ext_rm_Àaf
(
h™dÀ
, 
öode
, 
∑th
,

3087 &
∑πül
, 
°¨t
, 
íd
);

3089 
	`bªl£
(
∑th
[
i
].
p_bh
);

3090 
∑th
[
i
].
p_bh
 = 
NULL
;

3091 
i
--;

3096 i‡(!
∑th
[
i
].
p_hdr
) {

3097 
	`ext_debug
("initialize header\n");

3098 
∑th
[
i
].
p_hdr
 = 
	`ext_block_hdr
’©h[i].
p_bh
);

3101 i‡(!
∑th
[
i
].
p_idx
) {

3103 
∑th
[
i
].
p_idx
 = 
	`EXT_LAST_INDEX
’©h[i].
p_hdr
);

3104 
∑th
[
i
].
p_block
 = 
	`À16_to_˝u
’©h[i].
p_hdr
->
eh_íåõs
)+1;

3105 
	`ext_debug
("init indexÖtr: hdr 0x%p,Çum %d\n",

3106 
∑th
[
i
].
p_hdr
,

3107 
	`À16_to_˝u
(
∑th
[
i
].
p_hdr
->
eh_íåõs
));

3110 
∑th
[
i
].
p_idx
--;

3113 
	`ext_debug
("level %d - index, first 0x%p, cur 0x%p\n",

3114 
i
, 
	`EXT_FIRST_INDEX
(
∑th
[i].
p_hdr
),

3115 
∑th
[
i
].
p_idx
);

3116 i‡(
	`pxt4_ext_m‹e_to_rm
(
∑th
 + 
i
)) {

3117 
buf„r_hód
 *
bh
;

3119 
	`ext_debug
("moveÅoÜevel %d (block %llu)\n",

3120 
i
 + 1, 
	`pxt4_idx_pblock
(
∑th
[i].
p_idx
));

3121 
	`mem£t
(
∑th
 + 
i
 + 1, 0, (*path));

3122 
bh
 = 
	`ªad_exã¡_åì_block
(
öode
,

3123 
	`pxt4_idx_pblock
(
∑th
[
i
].
p_idx
), 
dïth
 - i - 1,

3124 
PXT4_EX_NOCACHE
);

3125 i‡(
	`IS_ERR
(
bh
)) {

3127 
îr
 = 
	`PTR_ERR
(
bh
);

3132 
	`c⁄d_ªsched
();

3133 i‡(
	`WARN_ON
(
i
 + 1 > 
dïth
)) {

3134 
îr
 = -
EFSCORRUPTED
;

3137 
∑th
[
i
 + 1].
p_bh
 = 
bh
;

3141 
∑th
[
i
].
p_block
 = 
	`À16_to_˝u
’©h[i].
p_hdr
->
eh_íåõs
);

3142 
i
++;

3145 i‡(
∑th
[
i
].
p_hdr
->
eh_íåõs
 == 0 && i > 0) {

3149 
îr
 = 
	`pxt4_ext_rm_idx
(
h™dÀ
, 
öode
, 
∑th
, 
i
);

3152 
	`bªl£
(
∑th
[
i
].
p_bh
);

3153 
∑th
[
i
].
p_bh
 = 
NULL
;

3154 
i
--;

3155 
	`ext_debug
("ªtu∫ÅÿÀvñ %d\n", 
i
);

3159 
	`åa˚_pxt4_ext_ªmove_•a˚_d⁄e
(
öode
, 
°¨t
, 
íd
, 
dïth
, &
∑πül
,

3160 
∑th
->
p_hdr
->
eh_íåõs
);

3166 i‡(
∑πül
.
°©e
 =
to‰ì
 && 
îr
 == 0) {

3167 
Êags
 = 
	`gë_deÁu…_‰ì_blocks_Êags
(
öode
);

3169 i‡(
	`pxt4_is_≥ndög
(
öode
, 
∑πül
.
lblk
))

3170 
Êags
 |
PXT4_FREE_BLOCKS_RERESERVE_CLUSTER
;

3171 
	`pxt4_‰ì_blocks
(
h™dÀ
, 
öode
, 
NULL
,

3172 
	`PXT4_C2B
(
sbi
, 
∑πül
.
p˛u
),

3173 
sbi
->
s_˛u°î_øtio
, 
Êags
);

3174 i‡(
Êags
 & 
PXT4_FREE_BLOCKS_RERESERVE_CLUSTER
)

3175 
	`pxt4_ªª£rve_˛u°î
(
öode
, 
∑πül
.
lblk
);

3176 
∑πül
.
°©e
 = 
öôül
;

3180 i‡(
∑th
->
p_hdr
->
eh_íåõs
 == 0) {

3185 
îr
 = 
	`pxt4_ext_gë_ac˚ss
(
h™dÀ
, 
öode
, 
∑th
);

3186 i‡(
îr
 == 0) {

3187 
	`ext_öode_hdr
(
öode
)->
eh_dïth
 = 0;

3188 
	`ext_öode_hdr
(
öode
)->
eh_max
 =

3189 
	`˝u_to_À16
(
	`pxt4_ext_•a˚_roŸ
(
öode
, 0));

3190 
îr
 = 
	`pxt4_ext_dúty
(
h™dÀ
, 
öode
, 
∑th
);

3193 
out
:

3194 
	`pxt4_ext_dr›_ªfs
(
∑th
);

3195 
	`k‰ì
(
∑th
);

3196 
∑th
 = 
NULL
;

3197 i‡(
îr
 =-
EAGAIN
)

3198 
agaö
;

3199 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

3201  
îr
;

3202 
	}
}

3207 
	$pxt4_ext_öô
(
su≥r_block
 *
sb
)

3213 i‡(
	`pxt4_has_„©uª_exã¡s
(
sb
)) {

3214 #i‡
	`deföed
(
AGGRESSIVE_TEST
Ë|| deföed(
CHECK_BINSEARCH
Ë|| deföed(
EXTENTS_STATS
)

3215 
	`¥ötk
(
KERN_INFO
 "PXT4-fs: fileÉxtentsÉnabled"

3216 #ifde‡
AGGRESSIVE_TEST


3219 #ifde‡
CHECK_BINSEARCH


3222 #ifde‡
EXTENTS_STATS


3227 #ifde‡
EXTENTS_STATS


3228 
	`•ö_lock_öô
(&
	`PXT4_SB
(
sb
)->
s_ext_°©s_lock
);

3229 
	`PXT4_SB
(
sb
)->
s_ext_mö
 = 1 << 30;

3230 
	`PXT4_SB
(
sb
)->
s_ext_max
 = 0;

3233 
	}
}

3238 
	$pxt4_ext_ªÀa£
(
su≥r_block
 *
sb
)

3240 i‡(!
	`pxt4_has_„©uª_exã¡s
(
sb
))

3243 #ifde‡
EXTENTS_STATS


3244 i‡(
	`PXT4_SB
(
sb
)->
s_ext_blocks
 && PXT4_SB(sb)->
s_ext_exã¡s
) {

3245 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
sb
);

3246 
	`¥ötk
(
KERN_ERR
 "PXT4-fs: %lu blocks in %luÉxtents (%luáve)\n",

3247 
sbi
->
s_ext_blocks
, sbi->
s_ext_exã¡s
,

3248 
sbi
->
s_ext_blocks
 / sbi->
s_ext_exã¡s
);

3249 
	`¥ötk
(
KERN_ERR
 "PXT4-fs:Éxtents: %lu min, %lu max, max depth %lu\n",

3250 
sbi
->
s_ext_mö
, sbi->
s_ext_max
, sbi->
s_dïth_max
);

3253 
	}
}

3255 
	$pxt4_zîoout_es
(
öode
 *öode, 
pxt4_exã¡
 *
ex
)

3257 
pxt4_lblk_t
 
ì_block
;

3258 
pxt4_fsblk_t
 
ì_pblock
;

3259 
ì_Àn
;

3261 
ì_block
 = 
	`À32_to_˝u
(
ex
->ee_block);

3262 
ì_Àn
 = 
	`pxt4_ext_gë_a˘uÆ_Àn
(
ex
);

3263 
ì_pblock
 = 
	`pxt4_ext_pblock
(
ex
);

3265 i‡(
ì_Àn
 == 0)

3268  
	`pxt4_es_ö£π_exã¡
(
öode
, 
ì_block
, 
ì_Àn
, 
ì_pblock
,

3269 
EXTENT_STATUS_WRITTEN
);

3270 
	}
}

3273 
	$pxt4_ext_zîoout
(
öode
 *öode, 
pxt4_exã¡
 *
ex
)

3275 
pxt4_fsblk_t
 
ì_pblock
;

3276 
ì_Àn
;

3278 
ì_Àn
 = 
	`pxt4_ext_gë_a˘uÆ_Àn
(
ex
);

3279 
ì_pblock
 = 
	`pxt4_ext_pblock
(
ex
);

3280  
	`pxt4_issue_zîoout
(
öode
, 
	`À32_to_˝u
(
ex
->
ì_block
), 
ì_pblock
,

3281 
ì_Àn
);

3282 
	}
}

3305 
	$pxt4_•lô_exã¡_©
(
h™dÀ_t
 *
h™dÀ
,

3306 
öode
 *inode,

3307 
pxt4_ext_∑th
 **
µ©h
,

3308 
pxt4_lblk_t
 
•lô
,

3309 
•lô_Êag
,

3310 
Êags
)

3312 
pxt4_ext_∑th
 *
∑th
 = *
µ©h
;

3313 
pxt4_fsblk_t
 
√wblock
;

3314 
pxt4_lblk_t
 
ì_block
;

3315 
pxt4_exã¡
 *
ex
, 
√wex
, 
‹ig_ex
, 
zîo_ex
;

3316 
pxt4_exã¡
 *
ex2
 = 
NULL
;

3317 
ì_Àn
, 
dïth
;

3318 
îr
 = 0;

3320 
	`BUG_ON
((
•lô_Êag
 & (
PXT4_EXT_DATA_VALID1
 | 
PXT4_EXT_DATA_VALID2
)) ==

3321 (
PXT4_EXT_DATA_VALID1
 | 
PXT4_EXT_DATA_VALID2
));

3323 
	`ext_debug
("pxt4_split_extents_at: inode %lu,Üogical"

3324 "block %Œu\n", 
öode
->
i_öo
, ()
•lô
);

3326 
	`pxt4_ext_show_Àaf
(
öode
, 
∑th
);

3328 
dïth
 = 
	`ext_dïth
(
öode
);

3329 
ex
 = 
∑th
[
dïth
].
p_ext
;

3330 
ì_block
 = 
	`À32_to_˝u
(
ex
->ee_block);

3331 
ì_Àn
 = 
	`pxt4_ext_gë_a˘uÆ_Àn
(
ex
);

3332 
√wblock
 = 
•lô
 - 
ì_block
 + 
	`pxt4_ext_pblock
(
ex
);

3334 
	`BUG_ON
(
•lô
 < 
ì_block
 || s∂ô >”e_block + 
ì_Àn
));

3335 
	`BUG_ON
(!
	`pxt4_ext_is_unwrôãn
(
ex
) &&

3336 
•lô_Êag
 & (
PXT4_EXT_MAY_ZEROOUT
 |

3337 
PXT4_EXT_MARK_UNWRIT1
 |

3338 
PXT4_EXT_MARK_UNWRIT2
));

3340 
îr
 = 
	`pxt4_ext_gë_ac˚ss
(
h™dÀ
, 
öode
, 
∑th
 + 
dïth
);

3341 i‡(
îr
)

3342 
out
;

3344 i‡(
•lô
 =
ì_block
) {

3350 i‡(
•lô_Êag
 & 
PXT4_EXT_MARK_UNWRIT2
)

3351 
	`pxt4_ext_m¨k_unwrôãn
(
ex
);

3353 
	`pxt4_ext_m¨k_öôülized
(
ex
);

3355 i‡(!(
Êags
 & 
PXT4_GET_BLOCKS_PRE_IO
))

3356 
	`pxt4_ext_åy_to_mîge
(
h™dÀ
, 
öode
, 
∑th
, 
ex
);

3358 
îr
 = 
	`pxt4_ext_dúty
(
h™dÀ
, 
öode
, 
∑th
 +Ö©h->
p_dïth
);

3359 
out
;

3363 
	`mem˝y
(&
‹ig_ex
, 
ex
, (orig_ex));

3364 
ex
->
ì_Àn
 = 
	`˝u_to_À16
(
•lô
 - 
ì_block
);

3365 i‡(
•lô_Êag
 & 
PXT4_EXT_MARK_UNWRIT1
)

3366 
	`pxt4_ext_m¨k_unwrôãn
(
ex
);

3372 
îr
 = 
	`pxt4_ext_dúty
(
h™dÀ
, 
öode
, 
∑th
 + 
dïth
);

3373 i‡(
îr
)

3374 
fix_exã¡_Àn
;

3376 
ex2
 = &
√wex
;

3377 
ex2
->
ì_block
 = 
	`˝u_to_À32
(
•lô
);

3378 
ex2
->
ì_Àn
 = 
	`˝u_to_À16
”e_À¿- (
•lô
 - 
ì_block
));

3379 
	`pxt4_ext_°‹e_pblock
(
ex2
, 
√wblock
);

3380 i‡(
•lô_Êag
 & 
PXT4_EXT_MARK_UNWRIT2
)

3381 
	`pxt4_ext_m¨k_unwrôãn
(
ex2
);

3383 
îr
 = 
	`pxt4_ext_ö£π_exã¡
(
h™dÀ
, 
öode
, 
µ©h
, &
√wex
, 
Êags
);

3384 i‡(
îr
 !-
ENOSPC
 &&Éº !-
EDQUOT
)

3385 
out
;

3387 i‡(
PXT4_EXT_MAY_ZEROOUT
 & 
•lô_Êag
) {

3388 i‡(
•lô_Êag
 & (
PXT4_EXT_DATA_VALID1
|
PXT4_EXT_DATA_VALID2
)) {

3389 i‡(
•lô_Êag
 & 
PXT4_EXT_DATA_VALID1
) {

3390 
îr
 = 
	`pxt4_ext_zîoout
(
öode
, 
ex2
);

3391 
zîo_ex
.
ì_block
 = 
ex2
->ee_block;

3392 
zîo_ex
.
ì_Àn
 = 
	`˝u_to_À16
(

3393 
	`pxt4_ext_gë_a˘uÆ_Àn
(
ex2
));

3394 
	`pxt4_ext_°‹e_pblock
(&
zîo_ex
,

3395 
	`pxt4_ext_pblock
(
ex2
));

3397 
îr
 = 
	`pxt4_ext_zîoout
(
öode
, 
ex
);

3398 
zîo_ex
.
ì_block
 = 
ex
->ee_block;

3399 
zîo_ex
.
ì_Àn
 = 
	`˝u_to_À16
(

3400 
	`pxt4_ext_gë_a˘uÆ_Àn
(
ex
));

3401 
	`pxt4_ext_°‹e_pblock
(&
zîo_ex
,

3402 
	`pxt4_ext_pblock
(
ex
));

3405 
îr
 = 
	`pxt4_ext_zîoout
(
öode
, &
‹ig_ex
);

3406 
zîo_ex
.
ì_block
 = 
‹ig_ex
.ee_block;

3407 
zîo_ex
.
ì_Àn
 = 
	`˝u_to_À16
(

3408 
	`pxt4_ext_gë_a˘uÆ_Àn
(&
‹ig_ex
));

3409 
	`pxt4_ext_°‹e_pblock
(&
zîo_ex
,

3410 
	`pxt4_ext_pblock
(&
‹ig_ex
));

3413 i‡(!
îr
) {

3415 
ex
->
ì_Àn
 = 
	`˝u_to_À16
(ee_len);

3416 
	`pxt4_ext_åy_to_mîge
(
h™dÀ
, 
öode
, 
∑th
, 
ex
);

3417 
îr
 = 
	`pxt4_ext_dúty
(
h™dÀ
, 
öode
, 
∑th
 +Ö©h->
p_dïth
);

3418 i‡(!
îr
)

3420 
îr
 = 
	`pxt4_zîoout_es
(
öode
, &
zîo_ex
);

3426 
out
;

3430 
fix_exã¡_Àn
:

3431 
ex
->
ì_Àn
 = 
‹ig_ex
.ee_len;

3432 
	`pxt4_ext_dúty
(
h™dÀ
, 
öode
, 
∑th
 +Ö©h->
p_dïth
);

3433  
îr
;

3434 
out
:

3435 
	`pxt4_ext_show_Àaf
(
öode
, 
∑th
);

3436  
îr
;

3437 
	}
}

3450 
	$pxt4_•lô_exã¡
(
h™dÀ_t
 *
h™dÀ
,

3451 
öode
 *inode,

3452 
pxt4_ext_∑th
 **
µ©h
,

3453 
pxt4_m≠_blocks
 *
m≠
,

3454 
•lô_Êag
,

3455 
Êags
)

3457 
pxt4_ext_∑th
 *
∑th
 = *
µ©h
;

3458 
pxt4_lblk_t
 
ì_block
;

3459 
pxt4_exã¡
 *
ex
;

3460 
ì_Àn
, 
dïth
;

3461 
îr
 = 0;

3462 
unwrôãn
;

3463 
•lô_Êag1
, 
Êags1
;

3464 
Æloˇãd
 = 
m≠
->
m_Àn
;

3466 
dïth
 = 
	`ext_dïth
(
öode
);

3467 
ex
 = 
∑th
[
dïth
].
p_ext
;

3468 
ì_block
 = 
	`À32_to_˝u
(
ex
->ee_block);

3469 
ì_Àn
 = 
	`pxt4_ext_gë_a˘uÆ_Àn
(
ex
);

3470 
unwrôãn
 = 
	`pxt4_ext_is_unwrôãn
(
ex
);

3472 i‡(
m≠
->
m_lblk
 + m≠->
m_Àn
 < 
ì_block
 + 
ì_Àn
) {

3473 
•lô_Êag1
 = 
•lô_Êag
 & 
PXT4_EXT_MAY_ZEROOUT
;

3474 
Êags1
 = 
Êags
 | 
PXT4_GET_BLOCKS_PRE_IO
;

3475 i‡(
unwrôãn
)

3476 
•lô_Êag1
 |
PXT4_EXT_MARK_UNWRIT1
 |

3477 
PXT4_EXT_MARK_UNWRIT2
;

3478 i‡(
•lô_Êag
 & 
PXT4_EXT_DATA_VALID2
)

3479 
•lô_Êag1
 |
PXT4_EXT_DATA_VALID1
;

3480 
îr
 = 
	`pxt4_•lô_exã¡_©
(
h™dÀ
, 
öode
, 
µ©h
,

3481 
m≠
->
m_lblk
 + m≠->
m_Àn
, 
•lô_Êag1
, 
Êags1
);

3482 i‡(
îr
)

3483 
out
;

3485 
Æloˇãd
 = 
ì_Àn
 - (
m≠
->
m_lblk
 - 
ì_block
);

3491 
∑th
 = 
	`pxt4_föd_exã¡
(
öode
, 
m≠
->
m_lblk
, 
µ©h
, 0);

3492 i‡(
	`IS_ERR
(
∑th
))

3493  
	`PTR_ERR
(
∑th
);

3494 
dïth
 = 
	`ext_dïth
(
öode
);

3495 
ex
 = 
∑th
[
dïth
].
p_ext
;

3496 i‡(!
ex
) {

3497 
	`PXT4_ERROR_INODE
(
öode
, "unexpected holeát %lu",

3498 (Ë
m≠
->
m_lblk
);

3499  -
EFSCORRUPTED
;

3501 
unwrôãn
 = 
	`pxt4_ext_is_unwrôãn
(
ex
);

3502 
•lô_Êag1
 = 0;

3504 i‡(
m≠
->
m_lblk
 >
ì_block
) {

3505 
•lô_Êag1
 = 
•lô_Êag
 & 
PXT4_EXT_DATA_VALID2
;

3506 i‡(
unwrôãn
) {

3507 
•lô_Êag1
 |
PXT4_EXT_MARK_UNWRIT1
;

3508 
•lô_Êag1
 |
•lô_Êag
 & (
PXT4_EXT_MAY_ZEROOUT
 |

3509 
PXT4_EXT_MARK_UNWRIT2
);

3511 
îr
 = 
	`pxt4_•lô_exã¡_©
(
h™dÀ
, 
öode
, 
µ©h
,

3512 
m≠
->
m_lblk
, 
•lô_Êag1
, 
Êags
);

3513 i‡(
îr
)

3514 
out
;

3517 
	`pxt4_ext_show_Àaf
(
öode
, 
∑th
);

3518 
out
:

3519  
îr
 ?Éº : 
Æloˇãd
;

3520 
	}
}

3542 
	$pxt4_ext_c⁄vît_to_öôülized
(
h™dÀ_t
 *
h™dÀ
,

3543 
öode
 *inode,

3544 
pxt4_m≠_blocks
 *
m≠
,

3545 
pxt4_ext_∑th
 **
µ©h
,

3546 
Êags
)

3548 
pxt4_ext_∑th
 *
∑th
 = *
µ©h
;

3549 
pxt4_sb_öfo
 *
sbi
;

3550 
pxt4_exã¡_hódî
 *
eh
;

3551 
pxt4_m≠_blocks
 
•lô_m≠
;

3552 
pxt4_exã¡
 
zîo_ex1
, 
zîo_ex2
;

3553 
pxt4_exã¡
 *
ex
, *
abut_ex
;

3554 
pxt4_lblk_t
 
ì_block
, 
eof_block
;

3555 
ì_Àn
, 
dïth
, 
m≠_Àn
 = 
m≠
->
m_Àn
;

3556 
Æloˇãd
 = 0, 
max_zîoout
 = 0;

3557 
îr
 = 0;

3558 
•lô_Êag
 = 
PXT4_EXT_DATA_VALID2
;

3560 
	`ext_debug
("pxt4_ext_convert_to_initialized: inode %lu,Üogical"

3561 "block %Œu, max_block†%u\n", 
öode
->
i_öo
,

3562 ()
m≠
->
m_lblk
, 
m≠_Àn
);

3564 
sbi
 = 
	`PXT4_SB
(
öode
->
i_sb
);

3565 
eof_block
 = (
	`PXT4_I
(
öode
)->
i_disksize
 + inode->
i_sb
->
s_blocksize
 - 1)

3566 >> 
öode
->
i_sb
->
s_blocksize_bôs
;

3567 i‡(
eof_block
 < 
m≠
->
m_lblk
 + 
m≠_Àn
)

3568 
eof_block
 = 
m≠
->
m_lblk
 + 
m≠_Àn
;

3570 
dïth
 = 
	`ext_dïth
(
öode
);

3571 
eh
 = 
∑th
[
dïth
].
p_hdr
;

3572 
ex
 = 
∑th
[
dïth
].
p_ext
;

3573 
ì_block
 = 
	`À32_to_˝u
(
ex
->ee_block);

3574 
ì_Àn
 = 
	`pxt4_ext_gë_a˘uÆ_Àn
(
ex
);

3575 
zîo_ex1
.
ì_Àn
 = 0;

3576 
zîo_ex2
.
ì_Àn
 = 0;

3578 
	`åa˚_pxt4_ext_c⁄vît_to_öôülized_íãr
(
öode
, 
m≠
, 
ex
);

3581 
	`BUG_ON
(!
	`pxt4_ext_is_unwrôãn
(
ex
));

3582 
	`BUG_ON
(!
	`ö_ønge
(
m≠
->
m_lblk
, 
ì_block
, 
ì_Àn
));

3599 i‡((
m≠
->
m_lblk
 =
ì_block
) &&

3601 (
m≠_Àn
 < 
ì_Àn
) &&

3602 (
ex
 > 
	`EXT_FIRST_EXTENT
(
eh
))) {

3603 
pxt4_lblk_t
 
¥ev_lblk
;

3604 
pxt4_fsblk_t
 
¥ev_pblk
, 
ì_pblk
;

3605 
¥ev_Àn
;

3607 
abut_ex
 = 
ex
 - 1;

3608 
¥ev_lblk
 = 
	`À32_to_˝u
(
abut_ex
->
ì_block
);

3609 
¥ev_Àn
 = 
	`pxt4_ext_gë_a˘uÆ_Àn
(
abut_ex
);

3610 
¥ev_pblk
 = 
	`pxt4_ext_pblock
(
abut_ex
);

3611 
ì_pblk
 = 
	`pxt4_ext_pblock
(
ex
);

3622 i‡((!
	`pxt4_ext_is_unwrôãn
(
abut_ex
)) &&

3623 ((
¥ev_lblk
 + 
¥ev_Àn
Ë=
ì_block
) &&

3624 ((
¥ev_pblk
 + 
¥ev_Àn
Ë=
ì_pblk
) &&

3625 (
¥ev_Àn
 < (
EXT_INIT_MAX_LEN
 - 
m≠_Àn
))) {

3626 
îr
 = 
	`pxt4_ext_gë_ac˚ss
(
h™dÀ
, 
öode
, 
∑th
 + 
dïth
);

3627 i‡(
îr
)

3628 
out
;

3630 
	`åa˚_pxt4_ext_c⁄vît_to_öôülized_Á°∑th
(
öode
,

3631 
m≠
, 
ex
, 
abut_ex
);

3634 
ex
->
ì_block
 = 
	`˝u_to_À32
”e_block + 
m≠_Àn
);

3635 
	`pxt4_ext_°‹e_pblock
(
ex
, 
ì_pblk
 + 
m≠_Àn
);

3636 
ex
->
ì_Àn
 = 
	`˝u_to_À16
”e_À¿- 
m≠_Àn
);

3637 
	`pxt4_ext_m¨k_unwrôãn
(
ex
);

3640 
abut_ex
->
ì_Àn
 = 
	`˝u_to_À16
(
¥ev_Àn
 + 
m≠_Àn
);

3643 
Æloˇãd
 = 
m≠_Àn
;

3645 } i‡(((
m≠
->
m_lblk
 + 
m≠_Àn
Ë=(
ì_block
 + 
ì_Àn
)) &&

3646 (
m≠_Àn
 < 
ì_Àn
) &&

3647 
ex
 < 
	`EXT_LAST_EXTENT
(
eh
)) {

3649 
pxt4_lblk_t
 
√xt_lblk
;

3650 
pxt4_fsblk_t
 
√xt_pblk
, 
ì_pblk
;

3651 
√xt_Àn
;

3653 
abut_ex
 = 
ex
 + 1;

3654 
√xt_lblk
 = 
	`À32_to_˝u
(
abut_ex
->
ì_block
);

3655 
√xt_Àn
 = 
	`pxt4_ext_gë_a˘uÆ_Àn
(
abut_ex
);

3656 
√xt_pblk
 = 
	`pxt4_ext_pblock
(
abut_ex
);

3657 
ì_pblk
 = 
	`pxt4_ext_pblock
(
ex
);

3668 i‡((!
	`pxt4_ext_is_unwrôãn
(
abut_ex
)) &&

3669 ((
m≠
->
m_lblk
 + 
m≠_Àn
Ë=
√xt_lblk
) &&

3670 ((
ì_pblk
 + 
ì_Àn
Ë=
√xt_pblk
) &&

3671 (
√xt_Àn
 < (
EXT_INIT_MAX_LEN
 - 
m≠_Àn
))) {

3672 
îr
 = 
	`pxt4_ext_gë_ac˚ss
(
h™dÀ
, 
öode
, 
∑th
 + 
dïth
);

3673 i‡(
îr
)

3674 
out
;

3676 
	`åa˚_pxt4_ext_c⁄vît_to_öôülized_Á°∑th
(
öode
,

3677 
m≠
, 
ex
, 
abut_ex
);

3680 
abut_ex
->
ì_block
 = 
	`˝u_to_À32
(
√xt_lblk
 - 
m≠_Àn
);

3681 
	`pxt4_ext_°‹e_pblock
(
abut_ex
, 
√xt_pblk
 - 
m≠_Àn
);

3682 
ex
->
ì_Àn
 = 
	`˝u_to_À16
”e_À¿- 
m≠_Àn
);

3683 
	`pxt4_ext_m¨k_unwrôãn
(
ex
);

3686 
abut_ex
->
ì_Àn
 = 
	`˝u_to_À16
(
√xt_Àn
 + 
m≠_Àn
);

3689 
Æloˇãd
 = 
m≠_Àn
;

3692 i‡(
Æloˇãd
) {

3694 
	`pxt4_ext_dúty
(
h™dÀ
, 
öode
, 
∑th
 + 
dïth
);

3697 
∑th
[
dïth
].
p_ext
 = 
abut_ex
;

3698 
out
;

3700 
Æloˇãd
 = 
ì_Àn
 - (
m≠
->
m_lblk
 - 
ì_block
);

3702 
	`WARN_ON
(
m≠
->
m_lblk
 < 
ì_block
);

3707 
•lô_Êag
 |
ì_block
 + 
ì_Àn
 <
eof_block
 ? 
PXT4_EXT_MAY_ZEROOUT
 : 0;

3709 i‡(
PXT4_EXT_MAY_ZEROOUT
 & 
•lô_Êag
)

3710 
max_zîoout
 = 
sbi
->
s_exã¡_max_zîoout_kb
 >>

3711 (
öode
->
i_sb
->
s_blocksize_bôs
 - 10);

3713 i‡(
	`IS_ENCRYPTED
(
öode
))

3714 
max_zîoout
 = 0;

3727 
•lô_m≠
.
m_lblk
 = 
m≠
->m_lblk;

3728 
•lô_m≠
.
m_Àn
 = 
m≠
->m_len;

3730 i‡(
max_zîoout
 && (
Æloˇãd
 > 
•lô_m≠
.
m_Àn
)) {

3731 i‡(
Æloˇãd
 <
max_zîoout
) {

3733 
zîo_ex1
.
ì_block
 =

3734 
	`˝u_to_À32
(
•lô_m≠
.
m_lblk
 +

3735 
•lô_m≠
.
m_Àn
);

3736 
zîo_ex1
.
ì_Àn
 =

3737 
	`˝u_to_À16
(
Æloˇãd
 - 
•lô_m≠
.
m_Àn
);

3738 
	`pxt4_ext_°‹e_pblock
(&
zîo_ex1
,

3739 
	`pxt4_ext_pblock
(
ex
Ë+ 
•lô_m≠
.
m_lblk
 +

3740 
•lô_m≠
.
m_Àn
 - 
ì_block
);

3741 
îr
 = 
	`pxt4_ext_zîoout
(
öode
, &
zîo_ex1
);

3742 i‡(
îr
)

3743 
out
;

3744 
•lô_m≠
.
m_Àn
 = 
Æloˇãd
;

3746 i‡(
•lô_m≠
.
m_lblk
 - 
ì_block
 + s∂ô_m≠.
m_Àn
 <

3747 
max_zîoout
) {

3749 i‡(
•lô_m≠
.
m_lblk
 !
ì_block
) {

3750 
zîo_ex2
.
ì_block
 = 
ex
->ee_block;

3751 
zîo_ex2
.
ì_Àn
 = 
	`˝u_to_À16
(
•lô_m≠
.
m_lblk
 -

3752 
ì_block
);

3753 
	`pxt4_ext_°‹e_pblock
(&
zîo_ex2
,

3754 
	`pxt4_ext_pblock
(
ex
));

3755 
îr
 = 
	`pxt4_ext_zîoout
(
öode
, &
zîo_ex2
);

3756 i‡(
îr
)

3757 
out
;

3760 
•lô_m≠
.
m_Àn
 +•lô_m≠.
m_lblk
 - 
ì_block
;

3761 
•lô_m≠
.
m_lblk
 = 
ì_block
;

3762 
Æloˇãd
 = 
m≠
->
m_Àn
;

3766 
îr
 = 
	`pxt4_•lô_exã¡
(
h™dÀ
, 
öode
, 
µ©h
, &
•lô_m≠
, 
•lô_Êag
,

3767 
Êags
);

3768 i‡(
îr
 > 0)

3769 
îr
 = 0;

3770 
out
:

3772 i‡(!
îr
) {

3773 
îr
 = 
	`pxt4_zîoout_es
(
öode
, &
zîo_ex1
);

3774 i‡(!
îr
)

3775 
îr
 = 
	`pxt4_zîoout_es
(
öode
, &
zîo_ex2
);

3777  
îr
 ?Éº : 
Æloˇãd
;

3778 
	}
}

3804 
	$pxt4_•lô_c⁄vît_exã¡s
(
h™dÀ_t
 *
h™dÀ
,

3805 
öode
 *inode,

3806 
pxt4_m≠_blocks
 *
m≠
,

3807 
pxt4_ext_∑th
 **
µ©h
,

3808 
Êags
)

3810 
pxt4_ext_∑th
 *
∑th
 = *
µ©h
;

3811 
pxt4_lblk_t
 
eof_block
;

3812 
pxt4_lblk_t
 
ì_block
;

3813 
pxt4_exã¡
 *
ex
;

3814 
ì_Àn
;

3815 
•lô_Êag
 = 0, 
dïth
;

3817 
	`ext_debug
("%s: inode %lu,Üogical block %llu, max_blocks %u\n",

3818 
__func__
, 
öode
->
i_öo
,

3819 ()
m≠
->
m_lblk
, m≠->
m_Àn
);

3821 
eof_block
 = (
	`PXT4_I
(
öode
)->
i_disksize
 + inode->
i_sb
->
s_blocksize
 - 1)

3822 >> 
öode
->
i_sb
->
s_blocksize_bôs
;

3823 i‡(
eof_block
 < 
m≠
->
m_lblk
 + m≠->
m_Àn
)

3824 
eof_block
 = 
m≠
->
m_lblk
 + m≠->
m_Àn
;

3829 
dïth
 = 
	`ext_dïth
(
öode
);

3830 
ex
 = 
∑th
[
dïth
].
p_ext
;

3831 
ì_block
 = 
	`À32_to_˝u
(
ex
->ee_block);

3832 
ì_Àn
 = 
	`pxt4_ext_gë_a˘uÆ_Àn
(
ex
);

3835 i‡(
Êags
 & 
PXT4_GET_BLOCKS_CONVERT_UNWRITTEN
) {

3836 
•lô_Êag
 |
PXT4_EXT_DATA_VALID1
;

3838 } i‡(
Êags
 & 
PXT4_GET_BLOCKS_CONVERT
) {

3839 
•lô_Êag
 |
ì_block
 + 
ì_Àn
 <
eof_block
 ?

3840 
PXT4_EXT_MAY_ZEROOUT
 : 0;

3841 
•lô_Êag
 |(
PXT4_EXT_MARK_UNWRIT2
 | 
PXT4_EXT_DATA_VALID2
);

3843 
Êags
 |
PXT4_GET_BLOCKS_PRE_IO
;

3844  
	`pxt4_•lô_exã¡
(
h™dÀ
, 
öode
, 
µ©h
, 
m≠
, 
•lô_Êag
, 
Êags
);

3845 
	}
}

3847 
	$pxt4_c⁄vît_unwrôãn_exã¡s_ídio
(
h™dÀ_t
 *
h™dÀ
,

3848 
öode
 *inode,

3849 
pxt4_m≠_blocks
 *
m≠
,

3850 
pxt4_ext_∑th
 **
µ©h
)

3852 
pxt4_ext_∑th
 *
∑th
 = *
µ©h
;

3853 
pxt4_exã¡
 *
ex
;

3854 
pxt4_lblk_t
 
ì_block
;

3855 
ì_Àn
;

3856 
dïth
;

3857 
îr
 = 0;

3859 
dïth
 = 
	`ext_dïth
(
öode
);

3860 
ex
 = 
∑th
[
dïth
].
p_ext
;

3861 
ì_block
 = 
	`À32_to_˝u
(
ex
->ee_block);

3862 
ì_Àn
 = 
	`pxt4_ext_gë_a˘uÆ_Àn
(
ex
);

3864 
	`ext_debug
("pxt4_convert_unwritten_extents_endio: inode %lu,Üogical"

3865 "block %Œu, max_block†%u\n", 
öode
->
i_öo
,

3866 ()
ì_block
, 
ì_Àn
);

3874 i‡(
ì_block
 !
m≠
->
m_lblk
 || 
ì_Àn
 > m≠->
m_Àn
) {

3875 #ifde‡
CONFIG_PXT4_DEBUG


3876 
	`pxt4_w¨nög
(
öode
->
i_sb
, "Inode (%ld) finished:ÉxtentÜogical block %llu,"

3878 
öode
->
i_öo
, ()
ì_block
, 
ì_Àn
,

3879 ()
m≠
->
m_lblk
, m≠->
m_Àn
);

3881 
îr
 = 
	`pxt4_•lô_c⁄vît_exã¡s
(
h™dÀ
, 
öode
, 
m≠
, 
µ©h
,

3882 
PXT4_GET_BLOCKS_CONVERT
);

3883 i‡(
îr
 < 0)

3884  
îr
;

3885 
∑th
 = 
	`pxt4_föd_exã¡
(
öode
, 
m≠
->
m_lblk
, 
µ©h
, 0);

3886 i‡(
	`IS_ERR
(
∑th
))

3887  
	`PTR_ERR
(
∑th
);

3888 
dïth
 = 
	`ext_dïth
(
öode
);

3889 
ex
 = 
∑th
[
dïth
].
p_ext
;

3892 
îr
 = 
	`pxt4_ext_gë_ac˚ss
(
h™dÀ
, 
öode
, 
∑th
 + 
dïth
);

3893 i‡(
îr
)

3894 
out
;

3896 
	`pxt4_ext_m¨k_öôülized
(
ex
);

3901 
	`pxt4_ext_åy_to_mîge
(
h™dÀ
, 
öode
, 
∑th
, 
ex
);

3904 
îr
 = 
	`pxt4_ext_dúty
(
h™dÀ
, 
öode
, 
∑th
 +Ö©h->
p_dïth
);

3905 
out
:

3906 
	`pxt4_ext_show_Àaf
(
öode
, 
∑th
);

3907  
îr
;

3908 
	}
}

3913 
	$check_eofblocks_Ê
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *inode,

3914 
pxt4_lblk_t
 
lblk
,

3915 
pxt4_ext_∑th
 *
∑th
,

3916 
Àn
)

3918 
i
, 
dïth
;

3919 
pxt4_exã¡_hódî
 *
eh
;

3920 
pxt4_exã¡
 *
œ°_ex
;

3922 i‡(!
	`pxt4_ã°_öode_Êag
(
öode
, 
PXT4_INODE_EOFBLOCKS
))

3925 
dïth
 = 
	`ext_dïth
(
öode
);

3926 
eh
 = 
∑th
[
dïth
].
p_hdr
;

3933 i‡(
	`u∆ikñy
(!
eh
->
eh_íåõs
))

3934 
out
;

3935 
œ°_ex
 = 
	`EXT_LAST_EXTENT
(
eh
);

3945 i‡(
lblk
 + 
Àn
 < 
	`À32_to_˝u
(
œ°_ex
->
ì_block
) +

3946 
	`pxt4_ext_gë_a˘uÆ_Àn
(
œ°_ex
))

3955 
i
 = 
dïth
-1; i >= 0; i--)

3956 i‡(
∑th
[
i
].
p_idx
 !
	`EXT_LAST_INDEX
’©h[i].
p_hdr
))

3958 
out
:

3959 
	`pxt4_˛ór_öode_Êag
(
öode
, 
PXT4_INODE_EOFBLOCKS
);

3960  
	`pxt4_m¨k_öode_dúty
(
h™dÀ
, 
öode
);

3961 
	}
}

3964 
	$c⁄vît_öôülized_exã¡
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *inode,

3965 
pxt4_m≠_blocks
 *
m≠
,

3966 
pxt4_ext_∑th
 **
µ©h
,

3967 
Æloˇãd
)

3969 
pxt4_ext_∑th
 *
∑th
 = *
µ©h
;

3970 
pxt4_exã¡
 *
ex
;

3971 
pxt4_lblk_t
 
ì_block
;

3972 
ì_Àn
;

3973 
dïth
;

3974 
îr
 = 0;

3980 i‡(
m≠
->
m_Àn
 > 
EXT_UNWRITTEN_MAX_LEN
)

3981 
m≠
->
m_Àn
 = 
EXT_UNWRITTEN_MAX_LEN
 / 2;

3983 
dïth
 = 
	`ext_dïth
(
öode
);

3984 
ex
 = 
∑th
[
dïth
].
p_ext
;

3985 
ì_block
 = 
	`À32_to_˝u
(
ex
->ee_block);

3986 
ì_Àn
 = 
	`pxt4_ext_gë_a˘uÆ_Àn
(
ex
);

3988 
	`ext_debug
("%s: inode %lu,Üogical"

3989 "block %Œu, max_block†%u\n", 
__func__
, 
öode
->
i_öo
,

3990 ()
ì_block
, 
ì_Àn
);

3992 i‡(
ì_block
 !
m≠
->
m_lblk
 || 
ì_Àn
 > m≠->
m_Àn
) {

3993 
îr
 = 
	`pxt4_•lô_c⁄vît_exã¡s
(
h™dÀ
, 
öode
, 
m≠
, 
µ©h
,

3994 
PXT4_GET_BLOCKS_CONVERT_UNWRITTEN
);

3995 i‡(
îr
 < 0)

3996  
îr
;

3997 
∑th
 = 
	`pxt4_föd_exã¡
(
öode
, 
m≠
->
m_lblk
, 
µ©h
, 0);

3998 i‡(
	`IS_ERR
(
∑th
))

3999  
	`PTR_ERR
(
∑th
);

4000 
dïth
 = 
	`ext_dïth
(
öode
);

4001 
ex
 = 
∑th
[
dïth
].
p_ext
;

4002 i‡(!
ex
) {

4003 
	`PXT4_ERROR_INODE
(
öode
, "unexpected holeát %lu",

4004 (Ë
m≠
->
m_lblk
);

4005  -
EFSCORRUPTED
;

4009 
îr
 = 
	`pxt4_ext_gë_ac˚ss
(
h™dÀ
, 
öode
, 
∑th
 + 
dïth
);

4010 i‡(
îr
)

4011  
îr
;

4013 
	`pxt4_ext_m¨k_unwrôãn
(
ex
);

4018 
	`pxt4_ext_åy_to_mîge
(
h™dÀ
, 
öode
, 
∑th
, 
ex
);

4021 
îr
 = 
	`pxt4_ext_dúty
(
h™dÀ
, 
öode
, 
∑th
 +Ö©h->
p_dïth
);

4022 i‡(
îr
)

4023  
îr
;

4024 
	`pxt4_ext_show_Àaf
(
öode
, 
∑th
);

4026 
	`pxt4_upd©e_öode_fsync_å™s
(
h™dÀ
, 
öode
, 1);

4027 
îr
 = 
	`check_eofblocks_Ê
(
h™dÀ
, 
öode
, 
m≠
->
m_lblk
, 
∑th
, m≠->
m_Àn
);

4028 i‡(
îr
)

4029  
îr
;

4030 
m≠
->
m_Êags
 |
PXT4_MAP_UNWRITTEN
;

4031 i‡(
Æloˇãd
 > 
m≠
->
m_Àn
)

4032 
Æloˇãd
 = 
m≠
->
m_Àn
;

4033 
m≠
->
m_Àn
 = 
Æloˇãd
;

4034  
Æloˇãd
;

4035 
	}
}

4038 
	$pxt4_ext_h™dÀ_unwrôãn_exã¡s
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *inode,

4039 
pxt4_m≠_blocks
 *
m≠
,

4040 
pxt4_ext_∑th
 **
µ©h
, 
Êags
,

4041 
Æloˇãd
, 
pxt4_fsblk_t
 
√wblock
)

4043 
pxt4_ext_∑th
 *
∑th
 = *
µ©h
;

4044 
ªt
 = 0;

4045 
îr
 = 0;

4047 
	`ext_debug
("pxt4_ext_handle_unwritten_extents: inode %lu,Üogical "

4049 
öode
->
i_öo
, ()
m≠
->
m_lblk
, m≠->
m_Àn
,

4050 
Êags
, 
Æloˇãd
);

4051 
	`pxt4_ext_show_Àaf
(
öode
, 
∑th
);

4057 
Êags
 |
PXT4_GET_BLOCKS_METADATA_NOFAIL
;

4059 
	`åa˚_pxt4_ext_h™dÀ_unwrôãn_exã¡s
(
öode
, 
m≠
, 
Êags
,

4060 
Æloˇãd
, 
√wblock
);

4063 i‡(
Êags
 & 
PXT4_GET_BLOCKS_PRE_IO
) {

4064 
ªt
 = 
	`pxt4_•lô_c⁄vît_exã¡s
(
h™dÀ
, 
öode
, 
m≠
, 
µ©h
,

4065 
Êags
 | 
PXT4_GET_BLOCKS_CONVERT
);

4066 i‡(
ªt
 <= 0)

4067 
out
;

4068 
m≠
->
m_Êags
 |
PXT4_MAP_UNWRITTEN
;

4069 
out
;

4072 i‡(
Êags
 & 
PXT4_GET_BLOCKS_CONVERT
) {

4073 i‡(
Êags
 & 
PXT4_GET_BLOCKS_ZERO
) {

4074 i‡(
Æloˇãd
 > 
m≠
->
m_Àn
)

4075 
Æloˇãd
 = 
m≠
->
m_Àn
;

4076 
îr
 = 
	`pxt4_issue_zîoout
(
öode
, 
m≠
->
m_lblk
, 
√wblock
,

4077 
Æloˇãd
);

4078 i‡(
îr
 < 0)

4079 
out2
;

4081 
ªt
 = 
	`pxt4_c⁄vît_unwrôãn_exã¡s_ídio
(
h™dÀ
, 
öode
, 
m≠
,

4082 
µ©h
);

4083 i‡(
ªt
 >= 0) {

4084 
	`pxt4_upd©e_öode_fsync_å™s
(
h™dÀ
, 
öode
, 1);

4085 
îr
 = 
	`check_eofblocks_Ê
(
h™dÀ
, 
öode
, 
m≠
->
m_lblk
,

4086 
∑th
, 
m≠
->
m_Àn
);

4088 
îr
 = 
ªt
;

4089 
m≠
->
m_Êags
 |
PXT4_MAP_MAPPED
;

4090 
m≠
->
m_pblk
 = 
√wblock
;

4091 i‡(
Æloˇãd
 > 
m≠
->
m_Àn
)

4092 
Æloˇãd
 = 
m≠
->
m_Àn
;

4093 
m≠
->
m_Àn
 = 
Æloˇãd
;

4094 
out2
;

4101 i‡(
Êags
 & 
PXT4_GET_BLOCKS_UNWRIT_EXT
) {

4102 
m≠
->
m_Êags
 |
PXT4_MAP_UNWRITTEN
;

4103 
m≠_out
;

4107 i‡((
Êags
 & 
PXT4_GET_BLOCKS_CREATE
) == 0) {

4115 
m≠
->
m_Êags
 |
PXT4_MAP_UNWRITTEN
;

4116 
out1
;

4120 
ªt
 = 
	`pxt4_ext_c⁄vît_to_öôülized
(
h™dÀ
, 
öode
, 
m≠
, 
µ©h
, 
Êags
);

4121 i‡(
ªt
 >= 0)

4122 
	`pxt4_upd©e_öode_fsync_å™s
(
h™dÀ
, 
öode
, 1);

4123 
out
:

4124 i‡(
ªt
 <= 0) {

4125 
îr
 = 
ªt
;

4126 
out2
;

4128 
Æloˇãd
 = 
ªt
;

4129 
m≠
->
m_Êags
 |
PXT4_MAP_NEW
;

4130 i‡(
Æloˇãd
 > 
m≠
->
m_Àn
)

4131 
Æloˇãd
 = 
m≠
->
m_Àn
;

4132 
m≠
->
m_Àn
 = 
Æloˇãd
;

4134 
m≠_out
:

4135 
m≠
->
m_Êags
 |
PXT4_MAP_MAPPED
;

4136 i‡((
Êags
 & 
PXT4_GET_BLOCKS_KEEP_SIZE
) == 0) {

4137 
îr
 = 
	`check_eofblocks_Ê
(
h™dÀ
, 
öode
, 
m≠
->
m_lblk
, 
∑th
,

4138 
m≠
->
m_Àn
);

4139 i‡(
îr
 < 0)

4140 
out2
;

4142 
out1
:

4143 i‡(
Æloˇãd
 > 
m≠
->
m_Àn
)

4144 
Æloˇãd
 = 
m≠
->
m_Àn
;

4145 
	`pxt4_ext_show_Àaf
(
öode
, 
∑th
);

4146 
m≠
->
m_pblk
 = 
√wblock
;

4147 
m≠
->
m_Àn
 = 
Æloˇãd
;

4148 
out2
:

4149  
îr
 ?Éº : 
Æloˇãd
;

4150 
	}
}

4193 
	$gë_im∂õd_˛u°î_Æloc
(
su≥r_block
 *
sb
,

4194 
pxt4_m≠_blocks
 *
m≠
,

4195 
pxt4_exã¡
 *
ex
,

4196 
pxt4_ext_∑th
 *
∑th
)

4198 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
sb
);

4199 
pxt4_lblk_t
 
c_off£t
 = 
	`PXT4_LBLK_COFF
(
sbi
, 
m≠
->
m_lblk
);

4200 
pxt4_lblk_t
 
ex_˛u°î_°¨t
, 
ex_˛u°î_íd
;

4201 
pxt4_lblk_t
 
º_˛u°î_°¨t
;

4202 
pxt4_lblk_t
 
ì_block
 = 
	`À32_to_˝u
(
ex
->ee_block);

4203 
pxt4_fsblk_t
 
ì_°¨t
 = 
	`pxt4_ext_pblock
(
ex
);

4204 
ì_Àn
 = 
	`pxt4_ext_gë_a˘uÆ_Àn
(
ex
);

4207 
ex_˛u°î_°¨t
 = 
	`PXT4_B2C
(
sbi
, 
ì_block
);

4208 
ex_˛u°î_íd
 = 
	`PXT4_B2C
(
sbi
, 
ì_block
 + 
ì_Àn
 - 1);

4211 
º_˛u°î_°¨t
 = 
	`PXT4_B2C
(
sbi
, 
m≠
->
m_lblk
);

4213 i‡((
º_˛u°î_°¨t
 =
ex_˛u°î_íd
) ||

4214 (
º_˛u°î_°¨t
 =
ex_˛u°î_°¨t
)) {

4215 i‡(
º_˛u°î_°¨t
 =
ex_˛u°î_íd
)

4216 
ì_°¨t
 +
ì_Àn
 - 1;

4217 
m≠
->
m_pblk
 = 
	`PXT4_PBLK_CMASK
(
sbi
, 
ì_°¨t
Ë+ 
c_off£t
;

4218 
m≠
->
m_Àn
 = 
	`mö
(map->m_len,

4219 (Ë
sbi
->
s_˛u°î_øtio
 - 
c_off£t
);

4229 i‡(
m≠
->
m_lblk
 < 
ì_block
)

4230 
m≠
->
m_Àn
 = 
	`mö
(m≠->m_Àn, 
ì_block
 - m≠->
m_lblk
);

4241 i‡(
m≠
->
m_lblk
 > 
ì_block
) {

4242 
pxt4_lblk_t
 
√xt
 = 
	`pxt4_ext_√xt_Æloˇãd_block
(
∑th
);

4243 
m≠
->
m_Àn
 = 
	`mö
(m≠->m_Àn, 
√xt
 - m≠->
m_lblk
);

4246 
	`åa˚_pxt4_gë_im∂õd_˛u°î_Æloc_exô
(
sb
, 
m≠
, 1);

4250 
	`åa˚_pxt4_gë_im∂õd_˛u°î_Æloc_exô
(
sb
, 
m≠
, 0);

4252 
	}
}

4273 
	$pxt4_ext_m≠_blocks
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *inode,

4274 
pxt4_m≠_blocks
 *
m≠
, 
Êags
)

4276 
pxt4_ext_∑th
 *
∑th
 = 
NULL
;

4277 
pxt4_exã¡
 
√wex
, *
ex
, *
ex2
;

4278 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
öode
->
i_sb
);

4279 
pxt4_fsblk_t
 
√wblock
 = 0;

4280 
‰ì_⁄_îr
 = 0, 
îr
 = 0, 
dïth
, 
ªt
;

4281 
Æloˇãd
 = 0, 
off£t
 = 0;

4282 
Æloˇãd_˛u°îs
 = 0;

4283 
pxt4_Æloˇti⁄_ªque°
 
¨
;

4284 
pxt4_lblk_t
 
˛u°î_off£t
;

4285 
boﬁ
 
m≠_‰om_˛u°î
 = 
Ál£
;

4287 
	`ext_debug
("blocks %u/%uÑequested for inode %lu\n",

4288 
m≠
->
m_lblk
, m≠->
m_Àn
, 
öode
->
i_öo
);

4289 
	`åa˚_pxt4_ext_m≠_blocks_íãr
(
öode
, 
m≠
->
m_lblk
, m≠->
m_Àn
, 
Êags
);

4292 
∑th
 = 
	`pxt4_föd_exã¡
(
öode
, 
m≠
->
m_lblk
, 
NULL
, 0);

4293 i‡(
	`IS_ERR
(
∑th
)) {

4294 
îr
 = 
	`PTR_ERR
(
∑th
);

4295 
∑th
 = 
NULL
;

4296 
out2
;

4299 
dïth
 = 
	`ext_dïth
(
öode
);

4306 i‡(
	`u∆ikñy
(
∑th
[
dïth
].
p_ext
 =
NULL
 && depth != 0)) {

4307 
	`PXT4_ERROR_INODE
(
öode
, "badÉxtentáddress "

4309 (Ë
m≠
->
m_lblk
, 
dïth
,

4310 
∑th
[
dïth
].
p_block
);

4311 
îr
 = -
EFSCORRUPTED
;

4312 
out2
;

4315 
ex
 = 
∑th
[
dïth
].
p_ext
;

4316 i‡(
ex
) {

4317 
pxt4_lblk_t
 
ì_block
 = 
	`À32_to_˝u
(
ex
->ee_block);

4318 
pxt4_fsblk_t
 
ì_°¨t
 = 
	`pxt4_ext_pblock
(
ex
);

4319 
ì_Àn
;

4326 
ì_Àn
 = 
	`pxt4_ext_gë_a˘uÆ_Àn
(
ex
);

4328 
	`åa˚_pxt4_ext_show_exã¡
(
öode
, 
ì_block
, 
ì_°¨t
, 
ì_Àn
);

4331 i‡(
	`ö_ønge
(
m≠
->
m_lblk
, 
ì_block
, 
ì_Àn
)) {

4332 
√wblock
 = 
m≠
->
m_lblk
 - 
ì_block
 + 
ì_°¨t
;

4334 
Æloˇãd
 = 
ì_Àn
 - (
m≠
->
m_lblk
 - 
ì_block
);

4335 
	`ext_debug
("%u fô i¡ÿ%u:%d -> %Œu\n", 
m≠
->
m_lblk
,

4336 
ì_block
, 
ì_Àn
, 
√wblock
);

4342 i‡((!
	`pxt4_ext_is_unwrôãn
(
ex
)) &&

4343 (
Êags
 & 
PXT4_GET_BLOCKS_CONVERT_UNWRITTEN
)) {

4344 
Æloˇãd
 = 
	`c⁄vît_öôülized_exã¡
(

4345 
h™dÀ
, 
öode
, 
m≠
, &
∑th
,

4346 
Æloˇãd
);

4347 
out2
;

4348 } i‡(!
	`pxt4_ext_is_unwrôãn
(
ex
))

4349 
out
;

4351 
ªt
 = 
	`pxt4_ext_h™dÀ_unwrôãn_exã¡s
(

4352 
h™dÀ
, 
öode
, 
m≠
, &
∑th
, 
Êags
,

4353 
Æloˇãd
, 
√wblock
);

4354 i‡(
ªt
 < 0)

4355 
îr
 = 
ªt
;

4357 
Æloˇãd
 = 
ªt
;

4358 
out2
;

4366 i‡((
Êags
 & 
PXT4_GET_BLOCKS_CREATE
) == 0) {

4367 
pxt4_lblk_t
 
hﬁe_°¨t
, 
hﬁe_Àn
;

4369 
hﬁe_°¨t
 = 
m≠
->
m_lblk
;

4370 
hﬁe_Àn
 = 
	`pxt4_ext_dëîmöe_hﬁe
(
öode
, 
∑th
, &
hﬁe_°¨t
);

4375 
	`pxt4_ext_put_g≠_ö_ˇche
(
öode
, 
hﬁe_°¨t
, 
hﬁe_Àn
);

4378 i‡(
hﬁe_°¨t
 !
m≠
->
m_lblk
)

4379 
hﬁe_Àn
 -
m≠
->
m_lblk
 - 
hﬁe_°¨t
;

4380 
m≠
->
m_pblk
 = 0;

4381 
m≠
->
m_Àn
 = 
	`mö_t
(, m≠->m_Àn, 
hﬁe_Àn
);

4383 
out2
;

4389 
√wex
.
ì_block
 = 
	`˝u_to_À32
(
m≠
->
m_lblk
);

4390 
˛u°î_off£t
 = 
	`PXT4_LBLK_COFF
(
sbi
, 
m≠
->
m_lblk
);

4396 i‡(
˛u°î_off£t
 && 
ex
 &&

4397 
	`gë_im∂õd_˛u°î_Æloc
(
öode
->
i_sb
, 
m≠
, 
ex
, 
∑th
)) {

4398 
¨
.
Àn
 = 
Æloˇãd
 = 
m≠
->
m_Àn
;

4399 
√wblock
 = 
m≠
->
m_pblk
;

4400 
m≠_‰om_˛u°î
 = 
åue
;

4401 
gŸ_Æloˇãd_blocks
;

4405 
¨
.
Œe·
 = 
m≠
->
m_lblk
;

4406 
îr
 = 
	`pxt4_ext_£¨ch_À·
(
öode
, 
∑th
, &
¨
.
Œe·
, &¨.
∂e·
);

4407 i‡(
îr
)

4408 
out2
;

4409 
¨
.
Ãight
 = 
m≠
->
m_lblk
;

4410 
ex2
 = 
NULL
;

4411 
îr
 = 
	`pxt4_ext_£¨ch_right
(
öode
, 
∑th
, &
¨
.
Ãight
, &¨.
¥ight
, &
ex2
);

4412 i‡(
îr
)

4413 
out2
;

4417 i‡((
sbi
->
s_˛u°î_øtio
 > 1Ë&& 
ex2
 &&

4418 
	`gë_im∂õd_˛u°î_Æloc
(
öode
->
i_sb
, 
m≠
, 
ex2
, 
∑th
)) {

4419 
¨
.
Àn
 = 
Æloˇãd
 = 
m≠
->
m_Àn
;

4420 
√wblock
 = 
m≠
->
m_pblk
;

4421 
m≠_‰om_˛u°î
 = 
åue
;

4422 
gŸ_Æloˇãd_blocks
;

4431 i‡(
m≠
->
m_Àn
 > 
EXT_INIT_MAX_LEN
 &&

4432 !(
Êags
 & 
PXT4_GET_BLOCKS_UNWRIT_EXT
))

4433 
m≠
->
m_Àn
 = 
EXT_INIT_MAX_LEN
;

4434 i‡(
m≠
->
m_Àn
 > 
EXT_UNWRITTEN_MAX_LEN
 &&

4435 (
Êags
 & 
PXT4_GET_BLOCKS_UNWRIT_EXT
))

4436 
m≠
->
m_Àn
 = 
EXT_UNWRITTEN_MAX_LEN
;

4439 
√wex
.
ì_Àn
 = 
	`˝u_to_À16
(
m≠
->
m_Àn
);

4440 
îr
 = 
	`pxt4_ext_check_ovîœp
(
sbi
, 
öode
, &
√wex
, 
∑th
);

4441 i‡(
îr
)

4442 
Æloˇãd
 = 
	`pxt4_ext_gë_a˘uÆ_Àn
(&
√wex
);

4444 
Æloˇãd
 = 
m≠
->
m_Àn
;

4447 
¨
.
öode
 = inode;

4448 
¨
.
gﬂl
 = 
	`pxt4_ext_föd_gﬂl
(
öode
, 
∑th
, 
m≠
->
m_lblk
);

4449 
¨
.
logiˇl
 = 
m≠
->
m_lblk
;

4458 
off£t
 = 
	`PXT4_LBLK_COFF
(
sbi
, 
m≠
->
m_lblk
);

4459 
¨
.
Àn
 = 
	`PXT4_NUM_B2C
(
sbi
, 
off£t
+
Æloˇãd
);

4460 
¨
.
gﬂl
 -
off£t
;

4461 
¨
.
logiˇl
 -
off£t
;

4462 i‡(
	`S_ISREG
(
öode
->
i_mode
))

4463 
¨
.
Êags
 = 
PXT4_MB_HINT_DATA
;

4466 
¨
.
Êags
 = 0;

4467 i‡(
Êags
 & 
PXT4_GET_BLOCKS_NO_NORMALIZE
)

4468 
¨
.
Êags
 |
PXT4_MB_HINT_NOPREALLOC
;

4469 i‡(
Êags
 & 
PXT4_GET_BLOCKS_DELALLOC_RESERVE
)

4470 
¨
.
Êags
 |
PXT4_MB_DELALLOC_RESERVED
;

4471 i‡(
Êags
 & 
PXT4_GET_BLOCKS_METADATA_NOFAIL
)

4472 
¨
.
Êags
 |
PXT4_MB_USE_RESERVED
;

4473 
√wblock
 = 
	`pxt4_mb_√w_blocks
(
h™dÀ
, &
¨
, &
îr
);

4474 i‡(!
√wblock
)

4475 
out2
;

4476 
	`ext_debug
("allocateÇew block: goal %llu, found %llu/%u\n",

4477 
¨
.
gﬂl
, 
√wblock
, 
Æloˇãd
);

4478 
‰ì_⁄_îr
 = 1;

4479 
Æloˇãd_˛u°îs
 = 
¨
.
Àn
;

4480 
¨
.
Àn
 = 
	`PXT4_C2B
(
sbi
,ár.ÀnË- 
off£t
;

4481 i‡(
¨
.
Àn
 > 
Æloˇãd
)

4482 
¨
.
Àn
 = 
Æloˇãd
;

4484 
gŸ_Æloˇãd_blocks
:

4486 
	`pxt4_ext_°‹e_pblock
(&
√wex
, 
√wblock
 + 
off£t
);

4487 
√wex
.
ì_Àn
 = 
	`˝u_to_À16
(
¨
.
Àn
);

4489 i‡(
Êags
 & 
PXT4_GET_BLOCKS_UNWRIT_EXT
){

4490 
	`pxt4_ext_m¨k_unwrôãn
(&
√wex
);

4491 
m≠
->
m_Êags
 |
PXT4_MAP_UNWRITTEN
;

4494 
îr
 = 0;

4495 i‡((
Êags
 & 
PXT4_GET_BLOCKS_KEEP_SIZE
) == 0)

4496 
îr
 = 
	`check_eofblocks_Ê
(
h™dÀ
, 
öode
, 
m≠
->
m_lblk
,

4497 
∑th
, 
¨
.
Àn
);

4498 i‡(!
îr
)

4499 
îr
 = 
	`pxt4_ext_ö£π_exã¡
(
h™dÀ
, 
öode
, &
∑th
,

4500 &
√wex
, 
Êags
);

4502 i‡(
îr
 && 
‰ì_⁄_îr
) {

4503 
fb_Êags
 = 
Êags
 & 
PXT4_GET_BLOCKS_DELALLOC_RESERVE
 ?

4504 
PXT4_FREE_BLOCKS_NO_QUOT_UPDATE
 : 0;

4508 
	`pxt4_disˇrd_¥óŒoˇti⁄s
(
öode
);

4509 
	`pxt4_‰ì_blocks
(
h™dÀ
, 
öode
, 
NULL
, 
√wblock
,

4510 
	`PXT4_C2B
(
sbi
, 
Æloˇãd_˛u°îs
), 
fb_Êags
);

4511 
out2
;

4515 
√wblock
 = 
	`pxt4_ext_pblock
(&
√wex
);

4516 
Æloˇãd
 = 
	`pxt4_ext_gë_a˘uÆ_Àn
(&
√wex
);

4517 i‡(
Æloˇãd
 > 
m≠
->
m_Àn
)

4518 
Æloˇãd
 = 
m≠
->
m_Àn
;

4519 
m≠
->
m_Êags
 |
PXT4_MAP_NEW
;

4527 i‡(
	`ã°_›t
(
öode
->
i_sb
, 
DELALLOC
Ë&& !
m≠_‰om_˛u°î
) {

4528 i‡(
Êags
 & 
PXT4_GET_BLOCKS_DELALLOC_RESERVE
) {

4533 
	`pxt4_da_upd©e_ª£rve_•a˚
(
öode
, 
Æloˇãd_˛u°îs
,

4536 
pxt4_lblk_t
 
lblk
, 
Àn
;

4537 
n
;

4550 
lblk
 = 
	`PXT4_LBLK_CMASK
(
sbi
, 
m≠
->
m_lblk
);

4551 
Àn
 = 
Æloˇãd_˛u°îs
 << 
sbi
->
s_˛u°î_bôs
;

4552 
n
 = 
	`pxt4_es_dñayed_˛u
(
öode
, 
lblk
, 
Àn
);

4553 i‡(
n
 > 0)

4554 
	`pxt4_da_upd©e_ª£rve_•a˚
(
öode
, (Ë
n
, 0);

4562 i‡((
Êags
 & 
PXT4_GET_BLOCKS_UNWRIT_EXT
) == 0)

4563 
	`pxt4_upd©e_öode_fsync_å™s
(
h™dÀ
, 
öode
, 1);

4565 
	`pxt4_upd©e_öode_fsync_å™s
(
h™dÀ
, 
öode
, 0);

4566 
out
:

4567 i‡(
Æloˇãd
 > 
m≠
->
m_Àn
)

4568 
Æloˇãd
 = 
m≠
->
m_Àn
;

4569 
	`pxt4_ext_show_Àaf
(
öode
, 
∑th
);

4570 
m≠
->
m_Êags
 |
PXT4_MAP_MAPPED
;

4571 
m≠
->
m_pblk
 = 
√wblock
;

4572 
m≠
->
m_Àn
 = 
Æloˇãd
;

4573 
out2
:

4574 
	`pxt4_ext_dr›_ªfs
(
∑th
);

4575 
	`k‰ì
(
∑th
);

4577 
	`åa˚_pxt4_ext_m≠_blocks_exô
(
öode
, 
Êags
, 
m≠
,

4578 
îr
 ?Éº : 
Æloˇãd
);

4579  
îr
 ?Éº : 
Æloˇãd
;

4580 
	}
}

4582 
	$pxt4_ext_åunˇã
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *inode)

4584 
su≥r_block
 *
sb
 = 
öode
->
i_sb
;

4585 
pxt4_lblk_t
 
œ°_block
;

4586 
îr
 = 0;

4595 
	`PXT4_I
(
öode
)->
i_disksize
 = inode->
i_size
;

4596 
îr
 = 
	`pxt4_m¨k_öode_dúty
(
h™dÀ
, 
öode
);

4597 i‡(
îr
)

4598  
îr
;

4600 
œ°_block
 = (
öode
->
i_size
 + 
sb
->
s_blocksize
 - 1)

4601 >> 
	`PXT4_BLOCK_SIZE_BITS
(
sb
);

4602 
ªåy
:

4603 
îr
 = 
	`pxt4_es_ªmove_exã¡
(
öode
, 
œ°_block
,

4604 
EXT_MAX_BLOCKS
 - 
œ°_block
);

4605 i‡(
îr
 =-
ENOMEM
) {

4606 
	`c⁄d_ªsched
();

4607 
	`c⁄ge°i⁄_waô
(
BLK_RW_ASYNC
, 
HZ
/50);

4608 
ªåy
;

4610 i‡(
îr
)

4611  
îr
;

4612  
	`pxt4_ext_ªmove_•a˚
(
öode
, 
œ°_block
, 
EXT_MAX_BLOCKS
 - 1);

4613 
	}
}

4615 
	$pxt4_Æloc_fûe_blocks
(
fûe
 *fûe, 
pxt4_lblk_t
 
off£t
,

4616 
pxt4_lblk_t
 
Àn
, 
loff_t
 
√w_size
,

4617 
Êags
)

4619 
öode
 *öodê
	`fûe_öode
(
fûe
);

4620 
h™dÀ_t
 *
h™dÀ
;

4621 
ªt
 = 0;

4622 
ªt2
 = 0;

4623 
ªåõs
 = 0;

4624 
dïth
 = 0;

4625 
pxt4_m≠_blocks
 
m≠
;

4626 
¸edôs
;

4627 
loff_t
 
ïos
;

4629 
	`BUG_ON
(!
	`pxt4_ã°_öode_Êag
(
öode
, 
PXT4_INODE_EXTENTS
));

4630 
m≠
.
m_lblk
 = 
off£t
;

4631 
m≠
.
m_Àn
 = 
Àn
;

4637 i‡(
Àn
 <
EXT_UNWRITTEN_MAX_LEN
)

4638 
Êags
 |
PXT4_GET_BLOCKS_NO_NORMALIZE
;

4643 
¸edôs
 = 
	`pxt4_chunk_å™s_blocks
(
öode
, 
Àn
);

4644 
dïth
 = 
	`ext_dïth
(
öode
);

4646 
ªåy
:

4647 
ªt
 >0 && 
Àn
) {

4651 i‡(
dïth
 !
	`ext_dïth
(
öode
)) {

4652 
¸edôs
 = 
	`pxt4_chunk_å™s_blocks
(
öode
, 
Àn
);

4653 
dïth
 = 
	`ext_dïth
(
öode
);

4656 
h™dÀ
 = 
	`pxt4_jou∫Æ_°¨t
(
öode
, 
PXT4_HT_MAP_BLOCKS
,

4657 
¸edôs
);

4658 i‡(
	`IS_ERR
(
h™dÀ
)) {

4659 
ªt
 = 
	`PTR_ERR
(
h™dÀ
);

4662 
ªt
 = 
	`pxt4_m≠_blocks
(
h™dÀ
, 
öode
, &
m≠
, 
Êags
);

4663 i‡(
ªt
 <= 0) {

4664 
	`pxt4_debug
("inode #%lu: block %u:Üen %u: "

4666 
öode
->
i_öo
, 
m≠
.
m_lblk
,

4667 
m≠
.
m_Àn
, 
ªt
);

4668 
	`pxt4_m¨k_öode_dúty
(
h™dÀ
, 
öode
);

4669 
ªt2
 = 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

4672 
m≠
.
m_lblk
 +
ªt
;

4673 
m≠
.
m_Àn
 = 
Àn
 =Üí - 
ªt
;

4674 
ïos
 = (
loff_t
)
m≠
.
m_lblk
 << 
öode
->
i_blkbôs
;

4675 
öode
->
i_˘ime
 = 
	`cuºít_time
(inode);

4676 i‡(
√w_size
) {

4677 i‡(
ïos
 > 
√w_size
)

4678 
ïos
 = 
√w_size
;

4679 i‡(
	`pxt4_upd©e_öode_size
(
öode
, 
ïos
) & 0x1)

4680 
öode
->
i_mtime
 = inode->
i_˘ime
;

4682 i‡(
ïos
 > 
öode
->
i_size
)

4683 
	`pxt4_£t_öode_Êag
(
öode
,

4684 
PXT4_INODE_EOFBLOCKS
);

4686 
	`pxt4_m¨k_öode_dúty
(
h™dÀ
, 
öode
);

4687 
	`pxt4_upd©e_öode_fsync_å™s
(
h™dÀ
, 
öode
, 1);

4688 
ªt2
 = 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

4689 i‡(
ªt2
)

4692 i‡(
ªt
 =-
ENOSPC
 &&

4693 
	`pxt4_should_ªåy_Æloc
(
öode
->
i_sb
, &
ªåõs
)) {

4694 
ªt
 = 0;

4695 
ªåy
;

4698  
ªt
 > 0 ? 
ªt2
 :Ñet;

4699 
	}
}

4701 
	$pxt4_zîo_ønge
(
fûe
 *fûe, 
loff_t
 
off£t
,

4702 
loff_t
 
Àn
, 
mode
)

4704 
öode
 *öodê
	`fûe_öode
(
fûe
);

4705 
h™dÀ_t
 *
h™dÀ
 = 
NULL
;

4706 
max_blocks
;

4707 
loff_t
 
√w_size
 = 0;

4708 
ªt
 = 0;

4709 
Êags
;

4710 
¸edôs
;

4711 
∑πül_begö
, 
∑πül_íd
;

4712 
loff_t
 
°¨t
, 
íd
;

4713 
pxt4_lblk_t
 
lblk
;

4714 
blkbôs
 = 
öode
->
i_blkbôs
;

4716 
	`åa˚_pxt4_zîo_ønge
(
öode
, 
off£t
, 
Àn
, 
mode
);

4718 i‡(!
	`S_ISREG
(
öode
->
i_mode
))

4719  -
EINVAL
;

4722 i‡(
	`pxt4_should_jou∫Æ_d©a
(
öode
)) {

4723 
ªt
 = 
	`pxt4_f‹˚_commô
(
öode
->
i_sb
);

4724 i‡(
ªt
)

4725  
ªt
;

4734 
°¨t
 = 
	`round_up
(
off£t
, 1 << 
blkbôs
);

4735 
íd
 = 
	`round_down
((
off£t
 + 
Àn
), 1 << 
blkbôs
);

4737 i‡(
°¨t
 < 
off£t
 || 
íd
 > off£à+ 
Àn
)

4738  -
EINVAL
;

4739 
∑πül_begö
 = 
off£t
 & ((1 << 
blkbôs
) - 1);

4740 
∑πül_íd
 = (
off£t
 + 
Àn
Ë& ((1 << 
blkbôs
) - 1);

4742 
lblk
 = 
°¨t
 >> 
blkbôs
;

4743 
max_blocks
 = (
íd
 >> 
blkbôs
);

4744 i‡(
max_blocks
 < 
lblk
)

4745 
max_blocks
 = 0;

4747 
max_blocks
 -
lblk
;

4749 
	`öode_lock
(
öode
);

4754 i‡(!(
	`pxt4_ã°_öode_Êag
(
öode
, 
PXT4_INODE_EXTENTS
))) {

4755 
ªt
 = -
EOPNOTSUPP
;

4756 
out_muãx
;

4759 i‡(!(
mode
 & 
FALLOC_FL_KEEP_SIZE
) &&

4760 (
off£t
 + 
Àn
 > 
	`i_size_ªad
(
öode
) ||

4761 
off£t
 + 
Àn
 > 
	`PXT4_I
(
öode
)->
i_disksize
)) {

4762 
√w_size
 = 
off£t
 + 
Àn
;

4763 
ªt
 = 
	`öode_√wsize_ok
(
öode
, 
√w_size
);

4764 i‡(
ªt
)

4765 
out_muãx
;

4768 
Êags
 = 
PXT4_GET_BLOCKS_CREATE_UNWRIT_EXT
;

4769 i‡(
mode
 & 
FALLOC_FL_KEEP_SIZE
)

4770 
Êags
 |
PXT4_GET_BLOCKS_KEEP_SIZE
;

4773 
	`öode_dio_waô
(
öode
);

4776 i‡(
∑πül_begö
 || 
∑πül_íd
) {

4777 
ªt
 = 
	`pxt4_Æloc_fûe_blocks
(
fûe
,

4778 
	`round_down
(
off£t
, 1 << 
blkbôs
) >> blkbits,

4779 (
	`round_up
((
off£t
 + 
Àn
), 1 << 
blkbôs
) -

4780 
	`round_down
(
off£t
, 1 << 
blkbôs
)) >> blkbits,

4781 
√w_size
, 
Êags
);

4782 i‡(
ªt
)

4783 
out_muãx
;

4788 i‡(
max_blocks
 > 0) {

4789 
Êags
 |(
PXT4_GET_BLOCKS_CONVERT_UNWRITTEN
 |

4790 
PXT4_EX_NOCACHE
);

4796 
	`down_wrôe
(&
	`PXT4_I
(
öode
)->
i_mm≠_£m
);

4798 
ªt
 = 
	`pxt4_bªak_œyouts
(
öode
);

4799 i‡(
ªt
) {

4800 
	`up_wrôe
(&
	`PXT4_I
(
öode
)->
i_mm≠_£m
);

4801 
out_muãx
;

4804 
ªt
 = 
	`pxt4_upd©e_disksize_bef‹e_punch
(
öode
, 
off£t
, 
Àn
);

4805 i‡(
ªt
) {

4806 
	`up_wrôe
(&
	`PXT4_I
(
öode
)->
i_mm≠_£m
);

4807 
out_muãx
;

4810 
	`åunˇã_∑geˇche_ønge
(
öode
, 
°¨t
, 
íd
 - 1);

4811 
öode
->
i_mtime
 = inode->
i_˘ime
 = 
	`cuºít_time
(inode);

4813 
ªt
 = 
	`pxt4_Æloc_fûe_blocks
(
fûe
, 
lblk
, 
max_blocks
, 
√w_size
,

4814 
Êags
);

4815 
	`up_wrôe
(&
	`PXT4_I
(
öode
)->
i_mm≠_£m
);

4816 i‡(
ªt
)

4817 
out_muãx
;

4819 i‡(!
∑πül_begö
 && !
∑πül_íd
)

4820 
out_muãx
;

4826 
¸edôs
 = (2 * 
	`pxt4_ext_ödex_å™s_blocks
(
öode
, 2)) + 1;

4827 i‡(
	`pxt4_should_jou∫Æ_d©a
(
öode
))

4828 
¸edôs
 += 2;

4829 
h™dÀ
 = 
	`pxt4_jou∫Æ_°¨t
(
öode
, 
PXT4_HT_MISC
, 
¸edôs
);

4830 i‡(
	`IS_ERR
(
h™dÀ
)) {

4831 
ªt
 = 
	`PTR_ERR
(
h™dÀ
);

4832 
	`pxt4_°d_îr‹
(
öode
->
i_sb
, 
ªt
);

4833 
out_muãx
;

4836 
öode
->
i_mtime
 = inode->
i_˘ime
 = 
	`cuºít_time
(inode);

4837 i‡(
√w_size
) {

4838 
	`pxt4_upd©e_öode_size
(
öode
, 
√w_size
);

4844 i‡((
off£t
 + 
Àn
Ë> 
	`i_size_ªad
(
öode
))

4845 
	`pxt4_£t_öode_Êag
(
öode
, 
PXT4_INODE_EOFBLOCKS
);

4847 
	`pxt4_m¨k_öode_dúty
(
h™dÀ
, 
öode
);

4850 
ªt
 = 
	`pxt4_zîo_∑πül_blocks
(
h™dÀ
, 
öode
, 
off£t
, 
Àn
);

4851 i‡(
ªt
 >= 0)

4852 
	`pxt4_upd©e_öode_fsync_å™s
(
h™dÀ
, 
öode
, 1);

4854 i‡(
fûe
->
f_Êags
 & 
O_SYNC
)

4855 
	`pxt4_h™dÀ_sync
(
h™dÀ
);

4857 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

4858 
out_muãx
:

4859 
	`öode_u∆ock
(
öode
);

4860  
ªt
;

4861 
	}
}

4870 
	$pxt4_ÁŒoˇã
(
fûe
 *fûe, 
mode
, 
loff_t
 
off£t
,Üoff_à
Àn
)

4872 
öode
 *öodê
	`fûe_öode
(
fûe
);

4873 
loff_t
 
√w_size
 = 0;

4874 
max_blocks
;

4875 
ªt
 = 0;

4876 
Êags
;

4877 
pxt4_lblk_t
 
lblk
;

4878 
blkbôs
 = 
öode
->
i_blkbôs
;

4890 i‡(
	`IS_ENCRYPTED
(
öode
) &&

4891 (
mode
 & (
FALLOC_FL_COLLAPSE_RANGE
 | 
FALLOC_FL_INSERT_RANGE
 |

4892 
FALLOC_FL_ZERO_RANGE
)))

4893  -
EOPNOTSUPP
;

4896 i‡(
mode
 & ~(
FALLOC_FL_KEEP_SIZE
 | 
FALLOC_FL_PUNCH_HOLE
 |

4897 
FALLOC_FL_COLLAPSE_RANGE
 | 
FALLOC_FL_ZERO_RANGE
 |

4898 
FALLOC_FL_INSERT_RANGE
))

4899  -
EOPNOTSUPP
;

4901 i‡(
mode
 & 
FALLOC_FL_PUNCH_HOLE
)

4902  
	`pxt4_punch_hﬁe
(
öode
, 
off£t
, 
Àn
);

4904 
ªt
 = 
	`pxt4_c⁄vît_ölöe_d©a
(
öode
);

4905 i‡(
ªt
)

4906  
ªt
;

4908 i‡(
mode
 & 
FALLOC_FL_COLLAPSE_RANGE
)

4909  
	`pxt4_cﬁœp£_ønge
(
öode
, 
off£t
, 
Àn
);

4911 i‡(
mode
 & 
FALLOC_FL_INSERT_RANGE
)

4912  
	`pxt4_ö£π_ønge
(
öode
, 
off£t
, 
Àn
);

4914 i‡(
mode
 & 
FALLOC_FL_ZERO_RANGE
)

4915  
	`pxt4_zîo_ønge
(
fûe
, 
off£t
, 
Àn
, 
mode
);

4917 
	`åa˚_pxt4_ÁŒoˇã_íãr
(
öode
, 
off£t
, 
Àn
, 
mode
);

4918 
lblk
 = 
off£t
 >> 
blkbôs
;

4920 
max_blocks
 = 
	`PXT4_MAX_BLOCKS
(
Àn
, 
off£t
, 
blkbôs
);

4921 
Êags
 = 
PXT4_GET_BLOCKS_CREATE_UNWRIT_EXT
;

4922 i‡(
mode
 & 
FALLOC_FL_KEEP_SIZE
)

4923 
Êags
 |
PXT4_GET_BLOCKS_KEEP_SIZE
;

4925 
	`öode_lock
(
öode
);

4930 i‡(!(
	`pxt4_ã°_öode_Êag
(
öode
, 
PXT4_INODE_EXTENTS
))) {

4931 
ªt
 = -
EOPNOTSUPP
;

4932 
out
;

4935 i‡(!(
mode
 & 
FALLOC_FL_KEEP_SIZE
) &&

4936 (
off£t
 + 
Àn
 > 
	`i_size_ªad
(
öode
) ||

4937 
off£t
 + 
Àn
 > 
	`PXT4_I
(
öode
)->
i_disksize
)) {

4938 
√w_size
 = 
off£t
 + 
Àn
;

4939 
ªt
 = 
	`öode_√wsize_ok
(
öode
, 
√w_size
);

4940 i‡(
ªt
)

4941 
out
;

4945 
	`öode_dio_waô
(
öode
);

4947 
ªt
 = 
	`pxt4_Æloc_fûe_blocks
(
fûe
, 
lblk
, 
max_blocks
, 
√w_size
, 
Êags
);

4948 i‡(
ªt
)

4949 
out
;

4951 i‡(
fûe
->
f_Êags
 & 
O_SYNC
 && 
	`PXT4_SB
(
öode
->
i_sb
)->
s_jou∫Æ
) {

4952 
ªt
 = 
	`jbd3_com∂ëe_å™ß˘i⁄
(
	`PXT4_SB
(
öode
->
i_sb
)->
s_jou∫Æ
,

4953 
	`PXT4_I
(
öode
)->
i_sync_tid
);

4955 
out
:

4956 
	`öode_u∆ock
(
öode
);

4957 
	`åa˚_pxt4_ÁŒoˇã_exô
(
öode
, 
off£t
, 
max_blocks
, 
ªt
);

4958  
ªt
;

4959 
	}
}

4971 
	$pxt4_c⁄vît_unwrôãn_exã¡s
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *inode,

4972 
loff_t
 
off£t
, 
ssize_t
 
Àn
)

4974 
max_blocks
;

4975 
ªt
 = 0;

4976 
ªt2
 = 0;

4977 
pxt4_m≠_blocks
 
m≠
;

4978 
¸edôs
, 
blkbôs
 = 
öode
->
i_blkbôs
;

4980 
m≠
.
m_lblk
 = 
off£t
 >> 
blkbôs
;

4981 
max_blocks
 = 
	`PXT4_MAX_BLOCKS
(
Àn
, 
off£t
, 
blkbôs
);

4988 i‡(
h™dÀ
) {

4989 
h™dÀ
 = 
	`pxt4_jou∫Æ_°¨t_ª£rved
(handle,

4990 
PXT4_HT_EXT_CONVERT
);

4991 i‡(
	`IS_ERR
(
h™dÀ
))

4992  
	`PTR_ERR
(
h™dÀ
);

4993 
¸edôs
 = 0;

4998 
¸edôs
 = 
	`pxt4_chunk_å™s_blocks
(
öode
, 
max_blocks
);

5000 
ªt
 >0 &&Ñë < 
max_blocks
) {

5001 
m≠
.
m_lblk
 +
ªt
;

5002 
m≠
.
m_Àn
 = (
max_blocks
 -
ªt
);

5003 i‡(
¸edôs
) {

5004 
h™dÀ
 = 
	`pxt4_jou∫Æ_°¨t
(
öode
, 
PXT4_HT_MAP_BLOCKS
,

5005 
¸edôs
);

5006 i‡(
	`IS_ERR
(
h™dÀ
)) {

5007 
ªt
 = 
	`PTR_ERR
(
h™dÀ
);

5011 
ªt
 = 
	`pxt4_m≠_blocks
(
h™dÀ
, 
öode
, &
m≠
,

5012 
PXT4_GET_BLOCKS_IO_CONVERT_EXT
);

5013 i‡(
ªt
 <= 0)

5014 
	`pxt4_w¨nög
(
öode
->
i_sb
,

5017 
öode
->
i_öo
, 
m≠
.
m_lblk
,

5018 
m≠
.
m_Àn
, 
ªt
);

5019 
	`pxt4_m¨k_öode_dúty
(
h™dÀ
, 
öode
);

5020 i‡(
¸edôs
)

5021 
ªt2
 = 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

5022 i‡(
ªt
 <0 || 
ªt2
)

5025 i‡(!
¸edôs
)

5026 
ªt2
 = 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

5027  
ªt
 > 0 ? 
ªt2
 :Ñet;

5028 
	}
}

5039 
	$pxt4_föd_dñayed_exã¡
(
öode
 *inode,

5040 
exã¡_°©us
 *
√wes
)

5042 
exã¡_°©us
 
es
;

5043 
pxt4_lblk_t
 
block
, 
√xt_dñ
;

5045 i‡(
√wes
->
es_pblk
 == 0) {

5046 
	`pxt4_es_föd_exã¡_ønge
(
öode
, &
pxt4_es_is_dñayed
,

5047 
√wes
->
es_lblk
,

5048 
√wes
->
es_lblk
 +Çewes->
es_Àn
 - 1,

5049 &
es
);

5055 i‡(
es
.
es_Àn
 == 0)

5059 i‡(
es
.
es_lblk
 > 
√wes
->es_lblk) {

5061 
√wes
->
es_Àn
 = 
	`mö
(
es
.
es_lblk
 -Çewes->es_lblk,

5062 
√wes
->
es_Àn
);

5066 
√wes
->
es_Àn
 = 
es
.
es_lblk
 +És.es_len -Çewes->es_lblk;

5069 
block
 = 
√wes
->
es_lblk
 +Çewes->
es_Àn
;

5070 
	`pxt4_es_föd_exã¡_ønge
(
öode
, &
pxt4_es_is_dñayed
, 
block
,

5071 
EXT_MAX_BLOCKS
, &
es
);

5072 i‡(
es
.
es_Àn
 == 0)

5073 
√xt_dñ
 = 
EXT_MAX_BLOCKS
;

5075 
√xt_dñ
 = 
es
.
es_lblk
;

5077  
√xt_dñ
;

5078 
	}
}

5080 
	$pxt4_x©å_fõm≠
(
öode
 *inode,

5081 
fõm≠_exã¡_öfo
 *
fõöfo
)

5083 
__u64
 
physiˇl
 = 0;

5084 
__u64
 
Àngth
;

5085 
__u32
 
Êags
 = 
FIEMAP_EXTENT_LAST
;

5086 
blockbôs
 = 
öode
->
i_sb
->
s_blocksize_bôs
;

5087 
îr‹
 = 0;

5090 i‡(
	`pxt4_ã°_öode_°©e
(
öode
, 
PXT4_STATE_XATTR
)) {

5091 
pxt4_ûoc
 
ûoc
;

5092 
off£t
;

5094 
îr‹
 = 
	`pxt4_gë_öode_loc
(
öode
, &
ûoc
);

5095 i‡(
îr‹
)

5096  
îr‹
;

5097 
physiˇl
 = (
__u64
)
ûoc
.
bh
->
b_blockƒ
 << 
blockbôs
;

5098 
off£t
 = 
PXT4_GOOD_OLD_INODE_SIZE
 +

5099 
	`PXT4_I
(
öode
)->
i_exåa_isize
;

5100 
physiˇl
 +
off£t
;

5101 
Àngth
 = 
	`PXT4_SB
(
öode
->
i_sb
)->
s_öode_size
 - 
off£t
;

5102 
Êags
 |
FIEMAP_EXTENT_DATA_INLINE
;

5103 
	`bªl£
(
ûoc
.
bh
);

5105 
physiˇl
 = (
__u64
)
	`PXT4_I
(
öode
)->
i_fûe_a˛
 << 
blockbôs
;

5106 
Àngth
 = 
öode
->
i_sb
->
s_blocksize
;

5109 i‡(
physiˇl
)

5110 
îr‹
 = 
	`fõm≠_fûl_√xt_exã¡
(
fõöfo
, 0, 
physiˇl
,

5111 
Àngth
, 
Êags
);

5112  (
îr‹
 < 0 ?Érror : 0);

5113 
	}
}

5115 
	$_pxt4_fõm≠
(
öode
 *inode,

5116 
fõm≠_exã¡_öfo
 *
fõöfo
,

5117 
__u64
 
°¨t
, __u64 
Àn
,

5118 (*
fûl
)(
öode
 *, 
pxt4_lblk_t
,

5119 
pxt4_lblk_t
,

5120 
fõm≠_exã¡_öfo
 *))

5122 
pxt4_lblk_t
 
°¨t_blk
;

5123 
u32
 
pxt4_fõm≠_Êags
 = 
FIEMAP_FLAG_SYNC
|
FIEMAP_FLAG_XATTR
;

5125 
îr‹
 = 0;

5127 i‡(
	`pxt4_has_ölöe_d©a
(
öode
)) {

5128 
has_ölöe
 = 1;

5130 
îr‹
 = 
	`pxt4_ölöe_d©a_fõm≠
(
öode
, 
fõöfo
, &
has_ölöe
,

5131 
°¨t
, 
Àn
);

5133 i‡(
has_ölöe
)

5134  
îr‹
;

5137 i‡(
fõöfo
->
fi_Êags
 & 
FIEMAP_FLAG_CACHE
) {

5138 
îr‹
 = 
	`pxt4_ext_¥eˇche
(
öode
);

5139 i‡(
îr‹
)

5140  
îr‹
;

5141 
fõöfo
->
fi_Êags
 &~
FIEMAP_FLAG_CACHE
;

5145 i‡(!(
	`pxt4_ã°_öode_Êag
(
öode
, 
PXT4_INODE_EXTENTS
)) &&

5146 
fûl
 =
pxt4_fûl_fõm≠_exã¡s
)

5147  
	`gíîic_block_fõm≠
(
öode
, 
fõöfo
, 
°¨t
, 
Àn
,

5148 
pxt4_gë_block
);

5150 i‡(
fûl
 =
pxt4_fûl_es_ˇche_öfo
)

5151 
pxt4_fõm≠_Êags
 &
FIEMAP_FLAG_XATTR
;

5152 i‡(
	`fõm≠_check_Êags
(
fõöfo
, 
pxt4_fõm≠_Êags
))

5153  -
EBADR
;

5155 i‡(
fõöfo
->
fi_Êags
 & 
FIEMAP_FLAG_XATTR
) {

5156 
îr‹
 = 
	`pxt4_x©å_fõm≠
(
öode
, 
fõöfo
);

5158 
pxt4_lblk_t
 
Àn_blks
;

5159 
__u64
 
œ°_blk
;

5161 
°¨t_blk
 = 
°¨t
 >> 
öode
->
i_sb
->
s_blocksize_bôs
;

5162 
œ°_blk
 = (
°¨t
 + 
Àn
 - 1Ë>> 
öode
->
i_sb
->
s_blocksize_bôs
;

5163 i‡(
œ°_blk
 >
EXT_MAX_BLOCKS
)

5164 
œ°_blk
 = 
EXT_MAX_BLOCKS
-1;

5165 
Àn_blks
 = ((
pxt4_lblk_t
Ë
œ°_blk
Ë- 
°¨t_blk
 + 1;

5171 
îr‹
 = 
	`fûl
(
öode
, 
°¨t_blk
, 
Àn_blks
, 
fõöfo
);

5173  
îr‹
;

5174 
	}
}

5176 
	$pxt4_fõm≠
(
öode
 *öode, 
fõm≠_exã¡_öfo
 *
fõöfo
,

5177 
__u64
 
°¨t
, __u64 
Àn
)

5179  
	`_pxt4_fõm≠
(
öode
, 
fõöfo
, 
°¨t
, 
Àn
,

5180 
pxt4_fûl_fõm≠_exã¡s
);

5181 
	}
}

5183 
	$pxt4_gë_es_ˇche
(
öode
 *öode, 
fõm≠_exã¡_öfo
 *
fõöfo
,

5184 
__u64
 
°¨t
, __u64 
Àn
)

5186 i‡(
	`pxt4_has_ölöe_d©a
(
öode
)) {

5187 
has_ölöe
;

5189 
	`down_ªad
(&
	`PXT4_I
(
öode
)->
x©å_£m
);

5190 
has_ölöe
 = 
	`pxt4_has_ölöe_d©a
(
öode
);

5191 
	`up_ªad
(&
	`PXT4_I
(
öode
)->
x©å_£m
);

5192 i‡(
has_ölöe
)

5196  
	`_pxt4_fõm≠
(
öode
, 
fõöfo
, 
°¨t
, 
Àn
,

5197 
pxt4_fûl_es_ˇche_öfo
);

5198 
	}
}

5208 
	$pxt4_ac˚ss_∑th
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *inode,

5209 
pxt4_ext_∑th
 *
∑th
)

5211 
¸edôs
, 
îr
;

5213 i‡(!
	`pxt4_h™dÀ_vÆid
(
h™dÀ
))

5222 i‡(
h™dÀ
->
h_buf„r_¸edôs
 < 7) {

5223 
¸edôs
 = 
	`pxt4_wrôïage_å™s_blocks
(
öode
);

5224 
îr
 = 
	`pxt4_ext_åunˇã_exãnd_ª°¨t
(
h™dÀ
, 
öode
, 
¸edôs
);

5226 i‡(
îr
 &&Éº !-
EAGAIN
)

5227  
îr
;

5230 
îr
 = 
	`pxt4_ext_gë_ac˚ss
(
h™dÀ
, 
öode
, 
∑th
);

5231  
îr
;

5232 
	}
}

5241 
	$pxt4_ext_shi·_∑th_exã¡s
(
pxt4_ext_∑th
 *
∑th
, 
pxt4_lblk_t
 
shi·
,

5242 
öode
 *öode, 
h™dÀ_t
 *
h™dÀ
,

5243 
SHIFT_DIRECTION
 
SHIFT
)

5245 
dïth
, 
îr
 = 0;

5246 
pxt4_exã¡
 *
ex_°¨t
, *
ex_œ°
;

5247 
boﬁ
 
upd©e
 = 0;

5248 
dïth
 = 
∑th
->
p_dïth
;

5250 
dïth
 >= 0) {

5251 i‡(
dïth
 =
∑th
->
p_dïth
) {

5252 
ex_°¨t
 = 
∑th
[
dïth
].
p_ext
;

5253 i‡(!
ex_°¨t
)

5254  -
EFSCORRUPTED
;

5256 
ex_œ°
 = 
	`EXT_LAST_EXTENT
(
∑th
[
dïth
].
p_hdr
);

5258 
îr
 = 
	`pxt4_ac˚ss_∑th
(
h™dÀ
, 
öode
, 
∑th
 + 
dïth
);

5259 i‡(
îr
)

5260 
out
;

5262 i‡(
ex_°¨t
 =
	`EXT_FIRST_EXTENT
(
∑th
[
dïth
].
p_hdr
))

5263 
upd©e
 = 1;

5265 
ex_°¨t
 <
ex_œ°
) {

5266 i‡(
SHIFT
 =
SHIFT_LEFT
) {

5267 
	`À32_add_˝u
(&
ex_°¨t
->
ì_block
,

5268 -
shi·
);

5270 i‡((
ex_°¨t
 >

5271 
	`EXT_FIRST_EXTENT
(
∑th
[
dïth
].
p_hdr
))

5273 
	`pxt4_ext_åy_to_mîge_right
(
öode
,

5274 
∑th
, 
ex_°¨t
 - 1))

5275 
ex_œ°
--;

5277 
ex_°¨t
++;

5279 
	`À32_add_˝u
(&
ex_œ°
->
ì_block
, 
shi·
);

5280 
	`pxt4_ext_åy_to_mîge_right
(
öode
, 
∑th
,

5281 
ex_œ°
);

5282 
ex_œ°
--;

5285 
îr
 = 
	`pxt4_ext_dúty
(
h™dÀ
, 
öode
, 
∑th
 + 
dïth
);

5286 i‡(
îr
)

5287 
out
;

5289 i‡(--
dïth
 < 0 || !
upd©e
)

5294 
îr
 = 
	`pxt4_ac˚ss_∑th
(
h™dÀ
, 
öode
, 
∑th
 + 
dïth
);

5295 i‡(
îr
)

5296 
out
;

5298 i‡(
SHIFT
 =
SHIFT_LEFT
)

5299 
	`À32_add_˝u
(&
∑th
[
dïth
].
p_idx
->
ei_block
, -
shi·
);

5301 
	`À32_add_˝u
(&
∑th
[
dïth
].
p_idx
->
ei_block
, 
shi·
);

5302 
îr
 = 
	`pxt4_ext_dúty
(
h™dÀ
, 
öode
, 
∑th
 + 
dïth
);

5303 i‡(
îr
)

5304 
out
;

5307 i‡(
∑th
[
dïth
].
p_idx
 !
	`EXT_FIRST_INDEX
’©h[dïth].
p_hdr
))

5310 
dïth
--;

5313 
out
:

5314  
îr
;

5315 
	}
}

5325 
	$pxt4_ext_shi·_exã¡s
(
öode
 *öode, 
h™dÀ_t
 *
h™dÀ
,

5326 
pxt4_lblk_t
 
°¨t
,Öxt4_lblk_à
shi·
,

5327 
SHIFT_DIRECTION
 
SHIFT
)

5329 
pxt4_ext_∑th
 *
∑th
;

5330 
ªt
 = 0, 
dïth
;

5331 
pxt4_exã¡
 *
exã¡
;

5332 
pxt4_lblk_t
 
°›
, *
ôî©‹
, 
ex_°¨t
, 
ex_íd
;

5335 
∑th
 = 
	`pxt4_föd_exã¡
(
öode
, 
EXT_MAX_BLOCKS
 - 1, 
NULL
,

5336 
PXT4_EX_NOCACHE
);

5337 i‡(
	`IS_ERR
(
∑th
))

5338  
	`PTR_ERR
(
∑th
);

5340 
dïth
 = 
∑th
->
p_dïth
;

5341 
exã¡
 = 
∑th
[
dïth
].
p_ext
;

5342 i‡(!
exã¡
)

5343 
out
;

5345 
°›
 = 
	`À32_to_˝u
(
exã¡
->
ì_block
);

5352 i‡(
SHIFT
 =
SHIFT_LEFT
) {

5353 
∑th
 = 
	`pxt4_föd_exã¡
(
öode
, 
°¨t
 - 1, &path,

5354 
PXT4_EX_NOCACHE
);

5355 i‡(
	`IS_ERR
(
∑th
))

5356  
	`PTR_ERR
(
∑th
);

5357 
dïth
 = 
∑th
->
p_dïth
;

5358 
exã¡
 = 
∑th
[
dïth
].
p_ext
;

5359 i‡(
exã¡
) {

5360 
ex_°¨t
 = 
	`À32_to_˝u
(
exã¡
->
ì_block
);

5361 
ex_íd
 = 
	`À32_to_˝u
(
exã¡
->
ì_block
) +

5362 
	`pxt4_ext_gë_a˘uÆ_Àn
(
exã¡
);

5364 
ex_°¨t
 = 0;

5365 
ex_íd
 = 0;

5368 i‡((
°¨t
 =
ex_°¨t
 && 
shi·
 >Éx_start) ||

5369 (
shi·
 > 
°¨t
 - 
ex_íd
)) {

5370 
ªt
 = -
EINVAL
;

5371 
out
;

5374 i‡(
shi·
 > 
EXT_MAX_BLOCKS
 -

5375 (
°›
 + 
	`pxt4_ext_gë_a˘uÆ_Àn
(
exã¡
))) {

5376 
ªt
 = -
EINVAL
;

5377 
out
;

5386 i‡(
SHIFT
 =
SHIFT_LEFT
)

5387 
ôî©‹
 = &
°¨t
;

5389 
ôî©‹
 = &
°›
;

5396 
ôî©‹
 && 
°¨t
 <
°›
) {

5397 
∑th
 = 
	`pxt4_föd_exã¡
(
öode
, *
ôî©‹
, &path,

5398 
PXT4_EX_NOCACHE
);

5399 i‡(
	`IS_ERR
(
∑th
))

5400  
	`PTR_ERR
(
∑th
);

5401 
dïth
 = 
∑th
->
p_dïth
;

5402 
exã¡
 = 
∑th
[
dïth
].
p_ext
;

5403 i‡(!
exã¡
) {

5404 
	`PXT4_ERROR_INODE
(
öode
, "unexpected holeát %lu",

5405 (Ë*
ôî©‹
);

5406  -
EFSCORRUPTED
;

5408 i‡(
SHIFT
 =
SHIFT_LEFT
 && *
ôî©‹
 >

5409 
	`À32_to_˝u
(
exã¡
->
ì_block
)) {

5411 i‡(
exã¡
 < 
	`EXT_LAST_EXTENT
(
∑th
[
dïth
].
p_hdr
)) {

5412 
∑th
[
dïth
].
p_ext
++;

5414 *
ôî©‹
 = 
	`pxt4_ext_√xt_Æloˇãd_block
(
∑th
);

5419 i‡(
SHIFT
 =
SHIFT_LEFT
) {

5420 
exã¡
 = 
	`EXT_LAST_EXTENT
(
∑th
[
dïth
].
p_hdr
);

5421 *
ôî©‹
 = 
	`À32_to_˝u
(
exã¡
->
ì_block
) +

5422 
	`pxt4_ext_gë_a˘uÆ_Àn
(
exã¡
);

5424 
exã¡
 = 
	`EXT_FIRST_EXTENT
(
∑th
[
dïth
].
p_hdr
);

5425 i‡(
	`À32_to_˝u
(
exã¡
->
ì_block
) > 0)

5426 *
ôî©‹
 = 
	`À32_to_˝u
(
exã¡
->
ì_block
) - 1;

5429 
ôî©‹
 = 
NULL
;

5431 
	`À32_to_˝u
(
exã¡
->
ì_block
Ë< 
°¨t
)

5432 
exã¡
++;

5433 
∑th
[
dïth
].
p_ext
 = 
exã¡
;

5435 
ªt
 = 
	`pxt4_ext_shi·_∑th_exã¡s
(
∑th
, 
shi·
, 
öode
,

5436 
h™dÀ
, 
SHIFT
);

5437 i‡(
ªt
)

5440 
out
:

5441 
	`pxt4_ext_dr›_ªfs
(
∑th
);

5442 
	`k‰ì
(
∑th
);

5443  
ªt
;

5444 
	}
}

5451 
	$pxt4_cﬁœp£_ønge
(
öode
 *öode, 
loff_t
 
off£t
,Üoff_à
Àn
)

5453 
su≥r_block
 *
sb
 = 
öode
->
i_sb
;

5454 
pxt4_lblk_t
 
punch_°¨t
, 
punch_°›
;

5455 
h™dÀ_t
 *
h™dÀ
;

5456 
¸edôs
;

5457 
loff_t
 
√w_size
, 
ioff£t
;

5458 
ªt
;

5465 i‡(!
	`pxt4_ã°_öode_Êag
(
öode
, 
PXT4_INODE_EXTENTS
))

5466  -
EOPNOTSUPP
;

5469 i‡(
off£t
 & (
	`PXT4_CLUSTER_SIZE
(
sb
) - 1) ||

5470 
Àn
 & (
	`PXT4_CLUSTER_SIZE
(
sb
) - 1))

5471  -
EINVAL
;

5473 i‡(!
	`S_ISREG
(
öode
->
i_mode
))

5474  -
EINVAL
;

5476 
	`åa˚_pxt4_cﬁœp£_ønge
(
öode
, 
off£t
, 
Àn
);

5478 
punch_°¨t
 = 
off£t
 >> 
	`PXT4_BLOCK_SIZE_BITS
(
sb
);

5479 
punch_°›
 = (
off£t
 + 
Àn
Ë>> 
	`PXT4_BLOCK_SIZE_BITS
(
sb
);

5482 i‡(
	`pxt4_should_jou∫Æ_d©a
(
öode
)) {

5483 
ªt
 = 
	`pxt4_f‹˚_commô
(
öode
->
i_sb
);

5484 i‡(
ªt
)

5485  
ªt
;

5488 
	`öode_lock
(
öode
);

5493 i‡(
off£t
 + 
Àn
 >
	`i_size_ªad
(
öode
)) {

5494 
ªt
 = -
EINVAL
;

5495 
out_muãx
;

5499 i‡(!
	`pxt4_ã°_öode_Êag
(
öode
, 
PXT4_INODE_EXTENTS
)) {

5500 
ªt
 = -
EOPNOTSUPP
;

5501 
out_muãx
;

5505 
	`öode_dio_waô
(
öode
);

5511 
	`down_wrôe
(&
	`PXT4_I
(
öode
)->
i_mm≠_£m
);

5513 
ªt
 = 
	`pxt4_bªak_œyouts
(
öode
);

5514 i‡(
ªt
)

5515 
out_mm≠
;

5521 
ioff£t
 = 
	`round_down
(
off£t
, 
PAGE_SIZE
);

5526 
ªt
 = 
	`fûem≠_wrôe_™d_waô_ønge
(
öode
->
i_m≠pög
, 
ioff£t
, 
off£t
);

5527 i‡(
ªt
)

5528 
out_mm≠
;

5534 
ªt
 = 
	`fûem≠_wrôe_™d_waô_ønge
(
öode
->
i_m≠pög
, 
off£t
 + 
Àn
,

5535 
LLONG_MAX
);

5536 i‡(
ªt
)

5537 
out_mm≠
;

5538 
	`åunˇã_∑geˇche
(
öode
, 
ioff£t
);

5540 
¸edôs
 = 
	`pxt4_wrôïage_å™s_blocks
(
öode
);

5541 
h™dÀ
 = 
	`pxt4_jou∫Æ_°¨t
(
öode
, 
PXT4_HT_TRUNCATE
, 
¸edôs
);

5542 i‡(
	`IS_ERR
(
h™dÀ
)) {

5543 
ªt
 = 
	`PTR_ERR
(
h™dÀ
);

5544 
out_mm≠
;

5547 
	`down_wrôe
(&
	`PXT4_I
(
öode
)->
i_d©a_£m
);

5548 
	`pxt4_disˇrd_¥óŒoˇti⁄s
(
öode
);

5550 
ªt
 = 
	`pxt4_es_ªmove_exã¡
(
öode
, 
punch_°¨t
,

5551 
EXT_MAX_BLOCKS
 - 
punch_°¨t
);

5552 i‡(
ªt
) {

5553 
	`up_wrôe
(&
	`PXT4_I
(
öode
)->
i_d©a_£m
);

5554 
out_°›
;

5557 
ªt
 = 
	`pxt4_ext_ªmove_•a˚
(
öode
, 
punch_°¨t
, 
punch_°›
 - 1);

5558 i‡(
ªt
) {

5559 
	`up_wrôe
(&
	`PXT4_I
(
öode
)->
i_d©a_£m
);

5560 
out_°›
;

5562 
	`pxt4_disˇrd_¥óŒoˇti⁄s
(
öode
);

5564 
ªt
 = 
	`pxt4_ext_shi·_exã¡s
(
öode
, 
h™dÀ
, 
punch_°›
,

5565 
punch_°›
 - 
punch_°¨t
, 
SHIFT_LEFT
);

5566 i‡(
ªt
) {

5567 
	`up_wrôe
(&
	`PXT4_I
(
öode
)->
i_d©a_£m
);

5568 
out_°›
;

5571 
√w_size
 = 
	`i_size_ªad
(
öode
Ë- 
Àn
;

5572 
	`i_size_wrôe
(
öode
, 
√w_size
);

5573 
	`PXT4_I
(
öode
)->
i_disksize
 = 
√w_size
;

5575 
	`up_wrôe
(&
	`PXT4_I
(
öode
)->
i_d©a_£m
);

5576 i‡(
	`IS_SYNC
(
öode
))

5577 
	`pxt4_h™dÀ_sync
(
h™dÀ
);

5578 
öode
->
i_mtime
 = inode->
i_˘ime
 = 
	`cuºít_time
(inode);

5579 
	`pxt4_m¨k_öode_dúty
(
h™dÀ
, 
öode
);

5580 
	`pxt4_upd©e_öode_fsync_å™s
(
h™dÀ
, 
öode
, 1);

5582 
out_°›
:

5583 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

5584 
out_mm≠
:

5585 
	`up_wrôe
(&
	`PXT4_I
(
öode
)->
i_mm≠_£m
);

5586 
out_muãx
:

5587 
	`öode_u∆ock
(
öode
);

5588  
ªt
;

5589 
	}
}

5599 
	$pxt4_ö£π_ønge
(
öode
 *öode, 
loff_t
 
off£t
,Üoff_à
Àn
)

5601 
su≥r_block
 *
sb
 = 
öode
->
i_sb
;

5602 
h™dÀ_t
 *
h™dÀ
;

5603 
pxt4_ext_∑th
 *
∑th
;

5604 
pxt4_exã¡
 *
exã¡
;

5605 
pxt4_lblk_t
 
off£t_lblk
, 
Àn_lblk
, 
ì_°¨t_lblk
 = 0;

5606 
¸edôs
, 
ì_Àn
;

5607 
ªt
 = 0, 
dïth
, 
•lô_Êag
 = 0;

5608 
loff_t
 
ioff£t
;

5615 i‡(!
	`pxt4_ã°_öode_Êag
(
öode
, 
PXT4_INODE_EXTENTS
))

5616  -
EOPNOTSUPP
;

5619 i‡(
off£t
 & (
	`PXT4_CLUSTER_SIZE
(
sb
) - 1) ||

5620 
Àn
 & (
	`PXT4_CLUSTER_SIZE
(
sb
) - 1))

5621  -
EINVAL
;

5623 i‡(!
	`S_ISREG
(
öode
->
i_mode
))

5624  -
EOPNOTSUPP
;

5626 
	`åa˚_pxt4_ö£π_ønge
(
öode
, 
off£t
, 
Àn
);

5628 
off£t_lblk
 = 
off£t
 >> 
	`PXT4_BLOCK_SIZE_BITS
(
sb
);

5629 
Àn_lblk
 = 
Àn
 >> 
	`PXT4_BLOCK_SIZE_BITS
(
sb
);

5632 i‡(
	`pxt4_should_jou∫Æ_d©a
(
öode
)) {

5633 
ªt
 = 
	`pxt4_f‹˚_commô
(
öode
->
i_sb
);

5634 i‡(
ªt
)

5635  
ªt
;

5638 
	`öode_lock
(
öode
);

5640 i‡(!
	`pxt4_ã°_öode_Êag
(
öode
, 
PXT4_INODE_EXTENTS
)) {

5641 
ªt
 = -
EOPNOTSUPP
;

5642 
out_muãx
;

5646 i‡(
öode
->
i_size
 + 
Àn
 > inode->
i_sb
->
s_maxbyãs
) {

5647 
ªt
 = -
EFBIG
;

5648 
out_muãx
;

5652 i‡(
off£t
 >
	`i_size_ªad
(
öode
)) {

5653 
ªt
 = -
EINVAL
;

5654 
out_muãx
;

5658 
	`öode_dio_waô
(
öode
);

5664 
	`down_wrôe
(&
	`PXT4_I
(
öode
)->
i_mm≠_£m
);

5666 
ªt
 = 
	`pxt4_bªak_œyouts
(
öode
);

5667 i‡(
ªt
)

5668 
out_mm≠
;

5674 
ioff£t
 = 
	`round_down
(
off£t
, 
PAGE_SIZE
);

5676 
ªt
 = 
	`fûem≠_wrôe_™d_waô_ønge
(
öode
->
i_m≠pög
, 
ioff£t
,

5677 
LLONG_MAX
);

5678 i‡(
ªt
)

5679 
out_mm≠
;

5680 
	`åunˇã_∑geˇche
(
öode
, 
ioff£t
);

5682 
¸edôs
 = 
	`pxt4_wrôïage_å™s_blocks
(
öode
);

5683 
h™dÀ
 = 
	`pxt4_jou∫Æ_°¨t
(
öode
, 
PXT4_HT_TRUNCATE
, 
¸edôs
);

5684 i‡(
	`IS_ERR
(
h™dÀ
)) {

5685 
ªt
 = 
	`PTR_ERR
(
h™dÀ
);

5686 
out_mm≠
;

5690 
öode
->
i_size
 +
Àn
;

5691 
	`PXT4_I
(
öode
)->
i_disksize
 +
Àn
;

5692 
öode
->
i_mtime
 = inode->
i_˘ime
 = 
	`cuºít_time
(inode);

5693 
ªt
 = 
	`pxt4_m¨k_öode_dúty
(
h™dÀ
, 
öode
);

5694 i‡(
ªt
)

5695 
out_°›
;

5697 
	`down_wrôe
(&
	`PXT4_I
(
öode
)->
i_d©a_£m
);

5698 
	`pxt4_disˇrd_¥óŒoˇti⁄s
(
öode
);

5700 
∑th
 = 
	`pxt4_föd_exã¡
(
öode
, 
off£t_lblk
, 
NULL
, 0);

5701 i‡(
	`IS_ERR
(
∑th
)) {

5702 
	`up_wrôe
(&
	`PXT4_I
(
öode
)->
i_d©a_£m
);

5703 
out_°›
;

5706 
dïth
 = 
	`ext_dïth
(
öode
);

5707 
exã¡
 = 
∑th
[
dïth
].
p_ext
;

5708 i‡(
exã¡
) {

5709 
ì_°¨t_lblk
 = 
	`À32_to_˝u
(
exã¡
->
ì_block
);

5710 
ì_Àn
 = 
	`pxt4_ext_gë_a˘uÆ_Àn
(
exã¡
);

5716 i‡((
off£t_lblk
 > 
ì_°¨t_lblk
) &&

5717 (
off£t_lblk
 < (
ì_°¨t_lblk
 + 
ì_Àn
))) {

5718 i‡(
	`pxt4_ext_is_unwrôãn
(
exã¡
))

5719 
•lô_Êag
 = 
PXT4_EXT_MARK_UNWRIT1
 |

5720 
PXT4_EXT_MARK_UNWRIT2
;

5721 
ªt
 = 
	`pxt4_•lô_exã¡_©
(
h™dÀ
, 
öode
, &
∑th
,

5722 
off£t_lblk
, 
•lô_Êag
,

5723 
PXT4_EX_NOCACHE
 |

5724 
PXT4_GET_BLOCKS_PRE_IO
 |

5725 
PXT4_GET_BLOCKS_METADATA_NOFAIL
);

5728 
	`pxt4_ext_dr›_ªfs
(
∑th
);

5729 
	`k‰ì
(
∑th
);

5730 i‡(
ªt
 < 0) {

5731 
	`up_wrôe
(&
	`PXT4_I
(
öode
)->
i_d©a_£m
);

5732 
out_°›
;

5735 
	`pxt4_ext_dr›_ªfs
(
∑th
);

5736 
	`k‰ì
(
∑th
);

5739 
ªt
 = 
	`pxt4_es_ªmove_exã¡
(
öode
, 
off£t_lblk
,

5740 
EXT_MAX_BLOCKS
 - 
off£t_lblk
);

5741 i‡(
ªt
) {

5742 
	`up_wrôe
(&
	`PXT4_I
(
öode
)->
i_d©a_£m
);

5743 
out_°›
;

5750 
ªt
 = 
	`pxt4_ext_shi·_exã¡s
(
öode
, 
h™dÀ
,

5751 
ì_°¨t_lblk
 > 
off£t_lblk
 ?Ée_start_lblk : offset_lblk,

5752 
Àn_lblk
, 
SHIFT_RIGHT
);

5754 
	`up_wrôe
(&
	`PXT4_I
(
öode
)->
i_d©a_£m
);

5755 i‡(
	`IS_SYNC
(
öode
))

5756 
	`pxt4_h™dÀ_sync
(
h™dÀ
);

5757 i‡(
ªt
 >= 0)

5758 
	`pxt4_upd©e_öode_fsync_å™s
(
h™dÀ
, 
öode
, 1);

5760 
out_°›
:

5761 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

5762 
out_mm≠
:

5763 
	`up_wrôe
(&
	`PXT4_I
(
öode
)->
i_mm≠_£m
);

5764 
out_muãx
:

5765 
	`öode_u∆ock
(
öode
);

5766  
ªt
;

5767 
	}
}

5790 
	$pxt4_sw≠_exã¡s
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *
öode1
,

5791 
öode
 *
öode2
, 
pxt4_lblk_t
 
lblk1
,Öxt4_lblk_à
lblk2
,

5792 
pxt4_lblk_t
 
cou¡
, 
unwrôãn
, *
îp
)

5794 
pxt4_ext_∑th
 *
∑th1
 = 
NULL
;

5795 
pxt4_ext_∑th
 *
∑th2
 = 
NULL
;

5796 
ª∂a˚d_cou¡
 = 0;

5798 
	`BUG_ON
(!
	`rw£m_is_locked
(&
	`PXT4_I
(
öode1
)->
i_d©a_£m
));

5799 
	`BUG_ON
(!
	`rw£m_is_locked
(&
	`PXT4_I
(
öode2
)->
i_d©a_£m
));

5800 
	`BUG_ON
(!
	`öode_is_locked
(
öode1
));

5801 
	`BUG_ON
(!
	`öode_is_locked
(
öode2
));

5803 *
îp
 = 
	`pxt4_es_ªmove_exã¡
(
öode1
, 
lblk1
, 
cou¡
);

5804 i‡(
	`u∆ikñy
(*
îp
))

5806 *
îp
 = 
	`pxt4_es_ªmove_exã¡
(
öode2
, 
lblk2
, 
cou¡
);

5807 i‡(
	`u∆ikñy
(*
îp
))

5810 
cou¡
) {

5811 
pxt4_exã¡
 *
ex1
, *
ex2
, 
tmp_ex
;

5812 
pxt4_lblk_t
 
e1_blk
, 
e2_blk
;

5813 
e1_Àn
, 
e2_Àn
, 
Àn
;

5814 
•lô
 = 0;

5816 
∑th1
 = 
	`pxt4_föd_exã¡
(
öode1
, 
lblk1
, 
NULL
, 
PXT4_EX_NOCACHE
);

5817 i‡(
	`IS_ERR
(
∑th1
)) {

5818 *
îp
 = 
	`PTR_ERR
(
∑th1
);

5819 
∑th1
 = 
NULL
;

5820 
föish
:

5821 
cou¡
 = 0;

5822 
ª≥©
;

5824 
∑th2
 = 
	`pxt4_föd_exã¡
(
öode2
, 
lblk2
, 
NULL
, 
PXT4_EX_NOCACHE
);

5825 i‡(
	`IS_ERR
(
∑th2
)) {

5826 *
îp
 = 
	`PTR_ERR
(
∑th2
);

5827 
∑th2
 = 
NULL
;

5828 
föish
;

5830 
ex1
 = 
∑th1
[∑th1->
p_dïth
].
p_ext
;

5831 
ex2
 = 
∑th2
[∑th2->
p_dïth
].
p_ext
;

5833 i‡(
	`u∆ikñy
(!
ex2
 || !
ex1
))

5834 
föish
;

5836 
e1_blk
 = 
	`À32_to_˝u
(
ex1
->
ì_block
);

5837 
e2_blk
 = 
	`À32_to_˝u
(
ex2
->
ì_block
);

5838 
e1_Àn
 = 
	`pxt4_ext_gë_a˘uÆ_Àn
(
ex1
);

5839 
e2_Àn
 = 
	`pxt4_ext_gë_a˘uÆ_Àn
(
ex2
);

5842 i‡(!
	`ö_ønge
(
lblk1
, 
e1_blk
, 
e1_Àn
) ||

5843 !
	`ö_ønge
(
lblk2
, 
e2_blk
, 
e2_Àn
)) {

5844 
pxt4_lblk_t
 
√xt1
, 
≈xt2
;

5847 
√xt1
 = 
	`pxt4_ext_√xt_Æloˇãd_block
(
∑th1
);

5848 
≈xt2
 = 
	`pxt4_ext_√xt_Æloˇãd_block
(
∑th2
);

5850 i‡(
e1_blk
 > 
lblk1
)

5851 
√xt1
 = 
e1_blk
;

5852 i‡(
e2_blk
 > 
lblk2
)

5853 
≈xt2
 = 
e2_blk
;

5855 i‡(
√xt1
 =
EXT_MAX_BLOCKS
 || 
≈xt2
 == EXT_MAX_BLOCKS)

5856 
föish
;

5858 
Àn
 = 
√xt1
 - 
lblk1
;

5859 i‡(
Àn
 < 
≈xt2
 - 
lblk2
)

5860 
Àn
 = 
≈xt2
 - 
lblk2
;

5861 i‡(
Àn
 > 
cou¡
)

5862 
Àn
 = 
cou¡
;

5863 
lblk1
 +
Àn
;

5864 
lblk2
 +
Àn
;

5865 
cou¡
 -
Àn
;

5866 
ª≥©
;

5870 i‡(
e1_blk
 < 
lblk1
) {

5871 
•lô
 = 1;

5872 *
îp
 = 
	`pxt4_f‹˚_•lô_exã¡_©
(
h™dÀ
, 
öode1
,

5873 &
∑th1
, 
lblk1
, 0);

5874 i‡(
	`u∆ikñy
(*
îp
))

5875 
föish
;

5877 i‡(
e2_blk
 < 
lblk2
) {

5878 
•lô
 = 1;

5879 *
îp
 = 
	`pxt4_f‹˚_•lô_exã¡_©
(
h™dÀ
, 
öode2
,

5880 &
∑th2
, 
lblk2
, 0);

5881 i‡(
	`u∆ikñy
(*
îp
))

5882 
föish
;

5886 i‡(
•lô
)

5887 
ª≥©
;

5890 
Àn
 = 
cou¡
;

5891 i‡(
Àn
 > 
e1_blk
 + 
e1_Àn
 - 
lblk1
)

5892 
Àn
 = 
e1_blk
 + 
e1_Àn
 - 
lblk1
;

5893 i‡(
Àn
 > 
e2_blk
 + 
e2_Àn
 - 
lblk2
)

5894 
Àn
 = 
e2_blk
 + 
e2_Àn
 - 
lblk2
;

5896 i‡(
Àn
 !
e1_Àn
) {

5897 
•lô
 = 1;

5898 *
îp
 = 
	`pxt4_f‹˚_•lô_exã¡_©
(
h™dÀ
, 
öode1
,

5899 &
∑th1
, 
lblk1
 + 
Àn
, 0);

5900 i‡(
	`u∆ikñy
(*
îp
))

5901 
föish
;

5903 i‡(
Àn
 !
e2_Àn
) {

5904 
•lô
 = 1;

5905 *
îp
 = 
	`pxt4_f‹˚_•lô_exã¡_©
(
h™dÀ
, 
öode2
,

5906 &
∑th2
, 
lblk2
 + 
Àn
, 0);

5907 i‡(*
îp
)

5908 
föish
;

5912 i‡(
•lô
)

5913 
ª≥©
;

5915 
	`BUG_ON
(
e2_Àn
 !
e1_Àn
);

5916 *
îp
 = 
	`pxt4_ext_gë_ac˚ss
(
h™dÀ
, 
öode1
, 
∑th1
 +Ö©h1->
p_dïth
);

5917 i‡(
	`u∆ikñy
(*
îp
))

5918 
föish
;

5919 *
îp
 = 
	`pxt4_ext_gë_ac˚ss
(
h™dÀ
, 
öode2
, 
∑th2
 +Ö©h2->
p_dïth
);

5920 i‡(
	`u∆ikñy
(*
îp
))

5921 
föish
;

5924 
tmp_ex
 = *
ex1
;

5925 
	`pxt4_ext_°‹e_pblock
(
ex1
, 
	`pxt4_ext_pblock
(
ex2
));

5926 
	`pxt4_ext_°‹e_pblock
(
ex2
, 
	`pxt4_ext_pblock
(&
tmp_ex
));

5927 
ex1
->
ì_Àn
 = 
	`˝u_to_À16
(
e2_Àn
);

5928 
ex2
->
ì_Àn
 = 
	`˝u_to_À16
(
e1_Àn
);

5929 i‡(
unwrôãn
)

5930 
	`pxt4_ext_m¨k_unwrôãn
(
ex2
);

5931 i‡(
	`pxt4_ext_is_unwrôãn
(&
tmp_ex
))

5932 
	`pxt4_ext_m¨k_unwrôãn
(
ex1
);

5934 
	`pxt4_ext_åy_to_mîge
(
h™dÀ
, 
öode2
, 
∑th2
, 
ex2
);

5935 
	`pxt4_ext_åy_to_mîge
(
h™dÀ
, 
öode1
, 
∑th1
, 
ex1
);

5936 *
îp
 = 
	`pxt4_ext_dúty
(
h™dÀ
, 
öode2
, 
∑th2
 +

5937 
∑th2
->
p_dïth
);

5938 i‡(
	`u∆ikñy
(*
îp
))

5939 
föish
;

5940 *
îp
 = 
	`pxt4_ext_dúty
(
h™dÀ
, 
öode1
, 
∑th1
 +

5941 
∑th1
->
p_dïth
);

5948 i‡(
	`u∆ikñy
(*
îp
))

5949 
föish
;

5950 
lblk1
 +
Àn
;

5951 
lblk2
 +
Àn
;

5952 
ª∂a˚d_cou¡
 +
Àn
;

5953 
cou¡
 -
Àn
;

5955 
ª≥©
:

5956 
	`pxt4_ext_dr›_ªfs
(
∑th1
);

5957 
	`k‰ì
(
∑th1
);

5958 
	`pxt4_ext_dr›_ªfs
(
∑th2
);

5959 
	`k‰ì
(
∑th2
);

5960 
∑th1
 = 
∑th2
 = 
NULL
;

5962  
ª∂a˚d_cou¡
;

5963 
	}
}

5977 
	$pxt4_˛u_m≠≥d
(
öode
 *öode, 
pxt4_lblk_t
 
l˛u
)

5979 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
öode
->
i_sb
);

5980 
pxt4_ext_∑th
 *
∑th
;

5981 
dïth
, 
m≠≥d
 = 0, 
îr
 = 0;

5982 
pxt4_exã¡
 *
exã¡
;

5983 
pxt4_lblk_t
 
fú°_lblk
, 
fú°_l˛u
, 
œ°_l˛u
;

5986 
∑th
 = 
	`pxt4_föd_exã¡
(
öode
, 
	`PXT4_C2B
(
sbi
, 
l˛u
), 
NULL
, 0);

5987 i‡(
	`IS_ERR
(
∑th
)) {

5988 
îr
 = 
	`PTR_ERR
(
∑th
);

5989 
∑th
 = 
NULL
;

5990 
out
;

5993 
dïth
 = 
	`ext_dïth
(
öode
);

6000 i‡(
	`u∆ikñy
(
∑th
[
dïth
].
p_ext
 =
NULL
 && depth != 0)) {

6001 
	`PXT4_ERROR_INODE
(
öode
,

6003 (Ë
	`PXT4_C2B
(
sbi
, 
l˛u
),

6004 
dïth
, 
∑th
[dïth].
p_block
);

6005 
îr
 = -
EFSCORRUPTED
;

6006 
out
;

6009 
exã¡
 = 
∑th
[
dïth
].
p_ext
;

6012 i‡(
exã¡
 =
NULL
)

6013 
out
;

6015 
fú°_lblk
 = 
	`À32_to_˝u
(
exã¡
->
ì_block
);

6016 
fú°_l˛u
 = 
	`PXT4_B2C
(
sbi
, 
fú°_lblk
);

6024 i‡(
l˛u
 >
fú°_l˛u
) {

6025 
œ°_l˛u
 = 
	`PXT4_B2C
(
sbi
, 
fú°_lblk
 +

6026 
	`pxt4_ext_gë_a˘uÆ_Àn
(
exã¡
) - 1);

6027 i‡(
l˛u
 <
œ°_l˛u
) {

6028 
m≠≥d
 = 1;

6030 
fú°_lblk
 = 
	`pxt4_ext_√xt_Æloˇãd_block
(
∑th
);

6031 
fú°_l˛u
 = 
	`PXT4_B2C
(
sbi
, 
fú°_lblk
);

6032 i‡(
l˛u
 =
fú°_l˛u
)

6033 
m≠≥d
 = 1;

6037 
out
:

6038 
	`pxt4_ext_dr›_ªfs
(
∑th
);

6039 
	`k‰ì
(
∑th
);

6041  
îr
 ?Éº : 
m≠≥d
;

6042 
	}
}

	@extents_status.c

13 
	~<löux/li°_s‹t.h
>

14 
	~<löux/¥oc_fs.h
>

15 
	~<löux/£q_fûe.h
>

16 
	~"pxt4.h
"

18 
	~<åa˚/evíts/pxt4.h
>

144 
kmem_ˇche
 *
	gpxt4_es_ˇchï
;

145 
kmem_ˇche
 *
	gpxt4_≥ndög_ˇchï
;

147 
__es_ö£π_exã¡
(
öode
 *öode, 
exã¡_°©us
 *
√wes
);

148 
__es_ªmove_exã¡
(
öode
 *öode, 
pxt4_lblk_t
 
lblk
,

149 
pxt4_lblk_t
 
íd
, *
ª£rved
);

150 
es_ª˛aim_exã¡s
(
pxt4_öode_öfo
 *
ei
, *
ƒ_to_sˇn
);

151 
__es_shrök
(
pxt4_sb_öfo
 *
sbi
, 
ƒ_to_sˇn
,

152 
pxt4_öode_öfo
 *
locked_ei
);

153 
__ªvi£_≥ndög
(
öode
 *öode, 
pxt4_lblk_t
 
lblk
,

154 
pxt4_lblk_t
 
Àn
);

156 
__öô
 
	$pxt4_öô_es
()

158 
pxt4_es_ˇchï
 = 
	`kmem_ˇche_¸óã
("pxt4_extent_status",

159 (
exã¡_°©us
),

160 0, (
SLAB_RECLAIM_ACCOUNT
), 
NULL
);

161 i‡(
pxt4_es_ˇchï
 =
NULL
)

162  -
ENOMEM
;

164 
	}
}

166 
	$pxt4_exô_es
()

168 
	`kmem_ˇche_de°roy
(
pxt4_es_ˇchï
);

169 
	}
}

171 
	$pxt4_es_öô_åì
(
pxt4_es_åì
 *
åì
)

173 
åì
->
roŸ
 = 
RB_ROOT
;

174 
åì
->
ˇche_es
 = 
NULL
;

175 
	}
}

177 #ifde‡
ES_DEBUG__


178 
	$pxt4_es_¥öt_åì
(
öode
 *inode)

180 
pxt4_es_åì
 *
åì
;

181 
rb_node
 *
node
;

183 
	`¥ötk
(
KERN_DEBUG
 "°©u†exã¡†f‹ inodê%lu:", 
öode
->
i_öo
);

184 
åì
 = &
	`PXT4_I
(
öode
)->
i_es_åì
;

185 
node
 = 
	`rb_fú°
(&
åì
->
roŸ
);

186 
node
) {

187 
exã¡_°©us
 *
es
;

188 
es
 = 
	`rb_íåy
(
node
, 
exã¡_°©us
, 
rb_node
);

189 
	`¥ötk
(
KERN_DEBUG
 " [%u/%u) %llu %x",

190 
es
->
es_lblk
,És->
es_Àn
,

191 
	`pxt4_es_pblock
(
es
), 
	`pxt4_es_°©us
(es));

192 
node
 = 
	`rb_√xt
(node);

194 
	`¥ötk
(
KERN_DEBUG
 "\n");

195 
	}
}

197 
	#pxt4_es_¥öt_åì
(
öode
)

	)

200 
ölöe
 
pxt4_lblk_t
 
	$pxt4_es_íd
(
exã¡_°©us
 *
es
)

202 
	`BUG_ON
(
es
->
es_lblk
 +És->
es_Àn
 <És->es_lblk);

203  
es
->
es_lblk
 +És->
es_Àn
 - 1;

204 
	}
}

210 
exã¡_°©us
 *
	$__es_åì_£¨ch
(
rb_roŸ
 *
roŸ
,

211 
pxt4_lblk_t
 
lblk
)

213 
rb_node
 *
node
 = 
roŸ
->rb_node;

214 
exã¡_°©us
 *
es
 = 
NULL
;

216 
node
) {

217 
es
 = 
	`rb_íåy
(
node
, 
exã¡_°©us
, 
rb_node
);

218 i‡(
lblk
 < 
es
->
es_lblk
)

219 
node
 =Çode->
rb_À·
;

220 i‡(
lblk
 > 
	`pxt4_es_íd
(
es
))

221 
node
 =Çode->
rb_right
;

223  
es
;

226 i‡(
es
 && 
lblk
 <És->
es_lblk
)

227  
es
;

229 i‡(
es
 && 
lblk
 > 
	`pxt4_es_íd
(es)) {

230 
node
 = 
	`rb_√xt
(&
es
->
rb_node
);

231  
node
 ? 
	`rb_íåy
“ode, 
exã¡_°©us
, 
rb_node
) :

232 
NULL
;

235  
NULL
;

236 
	}
}

256 
	$__es_föd_exã¡_ønge
(
öode
 *inode,

257 (*
m©chög_‚
)(
exã¡_°©us
 *
es
),

258 
pxt4_lblk_t
 
lblk
,Öxt4_lblk_à
íd
,

259 
exã¡_°©us
 *
es
)

261 
pxt4_es_åì
 *
åì
 = 
NULL
;

262 
exã¡_°©us
 *
es1
 = 
NULL
;

263 
rb_node
 *
node
;

265 
	`WARN_ON
(
es
 =
NULL
);

266 
	`WARN_ON
(
íd
 < 
lblk
);

268 
åì
 = &
	`PXT4_I
(
öode
)->
i_es_åì
;

271 
es
->
es_lblk
 =És->
es_Àn
 =És->
es_pblk
 = 0;

272 i‡(
åì
->
ˇche_es
) {

273 
es1
 = 
åì
->
ˇche_es
;

274 i‡(
	`ö_ønge
(
lblk
, 
es1
->
es_lblk
,És1->
es_Àn
)) {

275 
	`es_debug
("%u cached by [%u/%u) %llu %x\n",

276 
lblk
, 
es1
->
es_lblk
,És1->
es_Àn
,

277 
	`pxt4_es_pblock
(
es1
), 
	`pxt4_es_°©us
(es1));

278 
out
;

282 
es1
 = 
	`__es_åì_£¨ch
(&
åì
->
roŸ
, 
lblk
);

284 
out
:

285 i‡(
es1
 && !
	`m©chög_‚
(es1)) {

286 (
node
 = 
	`rb_√xt
(&
es1
->
rb_node
)Ë!
NULL
) {

287 
es1
 = 
	`rb_íåy
(
node
, 
exã¡_°©us
, 
rb_node
);

288 i‡(
es1
->
es_lblk
 > 
íd
) {

289 
es1
 = 
NULL
;

292 i‡(
	`m©chög_‚
(
es1
))

297 i‡(
es1
 && 
	`m©chög_‚
(es1)) {

298 
åì
->
ˇche_es
 = 
es1
;

299 
es
->
es_lblk
 = 
es1
->es_lblk;

300 
es
->
es_Àn
 = 
es1
->es_len;

301 
es
->
es_pblk
 = 
es1
->es_pblk;

304 
	}
}

309 
	$pxt4_es_föd_exã¡_ønge
(
öode
 *inode,

310 (*
m©chög_‚
)(
exã¡_°©us
 *
es
),

311 
pxt4_lblk_t
 
lblk
,Öxt4_lblk_à
íd
,

312 
exã¡_°©us
 *
es
)

314 
	`åa˚_pxt4_es_föd_exã¡_ønge_íãr
(
öode
, 
lblk
);

316 
	`ªad_lock
(&
	`PXT4_I
(
öode
)->
i_es_lock
);

317 
	`__es_föd_exã¡_ønge
(
öode
, 
m©chög_‚
, 
lblk
, 
íd
, 
es
);

318 
	`ªad_u∆ock
(&
	`PXT4_I
(
öode
)->
i_es_lock
);

320 
	`åa˚_pxt4_es_föd_exã¡_ønge_exô
(
öode
, 
es
);

321 
	}
}

338 
boﬁ
 
	$__es_sˇn_ønge
(
öode
 *inode,

339 (*
m©chög_‚
)(
exã¡_°©us
 *
es
),

340 
pxt4_lblk_t
 
°¨t
,Öxt4_lblk_à
íd
)

342 
exã¡_°©us
 
es
;

344 
	`__es_föd_exã¡_ønge
(
öode
, 
m©chög_‚
, 
°¨t
, 
íd
, &
es
);

345 i‡(
es
.
es_Àn
 == 0)

346  
Ál£
;

347 i‡(
es
.
es_lblk
 <
°¨t
 &&

348 
°¨t
 < 
es
.
es_lblk
 +És.
es_Àn
)

349  
åue
;

350 i‡(
°¨t
 <
es
.
es_lblk
 &&És.es_lblk <
íd
)

351  
åue
;

353  
Ál£
;

354 
	}
}

358 
boﬁ
 
	$pxt4_es_sˇn_ønge
(
öode
 *inode,

359 (*
m©chög_‚
)(
exã¡_°©us
 *
es
),

360 
pxt4_lblk_t
 
lblk
,Öxt4_lblk_à
íd
)

362 
boﬁ
 
ªt
;

364 
	`ªad_lock
(&
	`PXT4_I
(
öode
)->
i_es_lock
);

365 
ªt
 = 
	`__es_sˇn_ønge
(
öode
, 
m©chög_‚
, 
lblk
, 
íd
);

366 
	`ªad_u∆ock
(&
	`PXT4_I
(
öode
)->
i_es_lock
);

368  
ªt
;

369 
	}
}

385 
boﬁ
 
	$__es_sˇn_˛u
(
öode
 *inode,

386 (*
m©chög_‚
)(
exã¡_°©us
 *
es
),

387 
pxt4_lblk_t
 
lblk
)

389 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
öode
->
i_sb
);

390 
pxt4_lblk_t
 
lblk_°¨t
, 
lblk_íd
;

392 
lblk_°¨t
 = 
	`PXT4_LBLK_CMASK
(
sbi
, 
lblk
);

393 
lblk_íd
 = 
lblk_°¨t
 + 
sbi
->
s_˛u°î_øtio
 - 1;

395  
	`__es_sˇn_ønge
(
öode
, 
m©chög_‚
, 
lblk_°¨t
, 
lblk_íd
);

396 
	}
}

401 
boﬁ
 
	$pxt4_es_sˇn_˛u
(
öode
 *inode,

402 (*
m©chög_‚
)(
exã¡_°©us
 *
es
),

403 
pxt4_lblk_t
 
lblk
)

405 
boﬁ
 
ªt
;

407 
	`ªad_lock
(&
	`PXT4_I
(
öode
)->
i_es_lock
);

408 
ªt
 = 
	`__es_sˇn_˛u
(
öode
, 
m©chög_‚
, 
lblk
);

409 
	`ªad_u∆ock
(&
	`PXT4_I
(
öode
)->
i_es_lock
);

411  
ªt
;

412 
	}
}

414 
	$pxt4_es_li°_add
(
öode
 *inode)

416 
pxt4_öode_öfo
 *
ei
 = 
	`PXT4_I
(
öode
);

417 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
öode
->
i_sb
);

419 i‡(!
	`li°_em±y
(&
ei
->
i_es_li°
))

422 
	`•ö_lock
(&
sbi
->
s_es_lock
);

423 i‡(
	`li°_em±y
(&
ei
->
i_es_li°
)) {

424 
	`li°_add_èû
(&
ei
->
i_es_li°
, &
sbi
->
s_es_li°
);

425 
sbi
->
s_es_ƒ_öode
++;

427 
	`•ö_u∆ock
(&
sbi
->
s_es_lock
);

428 
	}
}

430 
	$pxt4_es_li°_dñ
(
öode
 *inode)

432 
pxt4_öode_öfo
 *
ei
 = 
	`PXT4_I
(
öode
);

433 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
öode
->
i_sb
);

435 
	`•ö_lock
(&
sbi
->
s_es_lock
);

436 i‡(!
	`li°_em±y
(&
ei
->
i_es_li°
)) {

437 
	`li°_dñ_öô
(&
ei
->
i_es_li°
);

438 
sbi
->
s_es_ƒ_öode
--;

439 
	`WARN_ON_ONCE
(
sbi
->
s_es_ƒ_öode
 < 0);

441 
	`•ö_u∆ock
(&
sbi
->
s_es_lock
);

442 
	}
}

444 
exã¡_°©us
 *

445 
	$pxt4_es_Æloc_exã¡
(
öode
 *öode, 
pxt4_lblk_t
 
lblk
,Öxt4_lblk_à
Àn
,

446 
pxt4_fsblk_t
 
pblk
)

448 
exã¡_°©us
 *
es
;

449 
es
 = 
	`kmem_ˇche_Æloc
(
pxt4_es_ˇchï
, 
GFP_ATOMIC
);

450 i‡(
es
 =
NULL
)

451  
NULL
;

452 
es
->
es_lblk
 = 
lblk
;

453 
es
->
es_Àn
 = 
Àn
;

454 
es
->
es_pblk
 = 
pblk
;

459 i‡(!
	`pxt4_es_is_dñayed
(
es
)) {

460 i‡(!
	`PXT4_I
(
öode
)->
i_es_shk_ƒ
++)

461 
	`pxt4_es_li°_add
(
öode
);

462 
	`≥r˝u_cou¡î_öc
(&
	`PXT4_SB
(
öode
->
i_sb
)->

463 
s_es_°©s
.
es_°©s_shk_˙t
);

466 
	`PXT4_I
(
öode
)->
i_es_Æl_ƒ
++;

467 
	`≥r˝u_cou¡î_öc
(&
	`PXT4_SB
(
öode
->
i_sb
)->
s_es_°©s
.
es_°©s_Æl_˙t
);

469  
es
;

470 
	}
}

472 
	$pxt4_es_‰ì_exã¡
(
öode
 *öode, 
exã¡_°©us
 *
es
)

474 
	`PXT4_I
(
öode
)->
i_es_Æl_ƒ
--;

475 
	`≥r˝u_cou¡î_dec
(&
	`PXT4_SB
(
öode
->
i_sb
)->
s_es_°©s
.
es_°©s_Æl_˙t
);

478 i‡(!
	`pxt4_es_is_dñayed
(
es
)) {

479 
	`BUG_ON
(
	`PXT4_I
(
öode
)->
i_es_shk_ƒ
 == 0);

480 i‡(!--
	`PXT4_I
(
öode
)->
i_es_shk_ƒ
)

481 
	`pxt4_es_li°_dñ
(
öode
);

482 
	`≥r˝u_cou¡î_dec
(&
	`PXT4_SB
(
öode
->
i_sb
)->

483 
s_es_°©s
.
es_°©s_shk_˙t
);

486 
	`kmem_ˇche_‰ì
(
pxt4_es_ˇchï
, 
es
);

487 
	}
}

496 
	$pxt4_es_ˇn_be_mîged
(
exã¡_°©us
 *
es1
,

497 
exã¡_°©us
 *
es2
)

499 i‡(
	`pxt4_es_ty≥
(
es1
Ë!pxt4_es_ty≥(
es2
))

502 i‡(((
__u64
Ë
es1
->
es_Àn
Ë+ 
es2
->es_À¿> 
EXT_MAX_BLOCKS
) {

503 
	`¥_w¨n
("ESássertion failed when mergingÉxtents. "

506 
es1
->
es_Àn
, 
es2
->es_Àn, 
EXT_MAX_BLOCKS
);

507 
	`WARN_ON
(1);

511 i‡(((
__u64
Ë
es1
->
es_lblk
Ë+És1->
es_Àn
 !
es2
->es_lblk)

514 i‡((
	`pxt4_es_is_wrôãn
(
es1
Ë|| 
	`pxt4_es_is_unwrôãn
(es1)) &&

515 (
	`pxt4_es_pblock
(
es1
Ë+És1->
es_Àn
 =pxt4_es_pblock(
es2
)))

518 i‡(
	`pxt4_es_is_hﬁe
(
es1
))

522 i‡(
	`pxt4_es_is_dñayed
(
es1
Ë&& !
	`pxt4_es_is_unwrôãn
(es1))

526 
	}
}

528 
exã¡_°©us
 *

529 
	$pxt4_es_åy_to_mîge_À·
(
öode
 *öode, 
exã¡_°©us
 *
es
)

531 
pxt4_es_åì
 *
åì
 = &
	`PXT4_I
(
öode
)->
i_es_åì
;

532 
exã¡_°©us
 *
es1
;

533 
rb_node
 *
node
;

535 
node
 = 
	`rb_¥ev
(&
es
->
rb_node
);

536 i‡(!
node
)

537  
es
;

539 
es1
 = 
	`rb_íåy
(
node
, 
exã¡_°©us
, 
rb_node
);

540 i‡(
	`pxt4_es_ˇn_be_mîged
(
es1
, 
es
)) {

541 
es1
->
es_Àn
 +
es
->es_len;

542 i‡(
	`pxt4_es_is_ª„ªn˚d
(
es
))

543 
	`pxt4_es_£t_ª„ªn˚d
(
es1
);

544 
	`rb_îa£
(&
es
->
rb_node
, &
åì
->
roŸ
);

545 
	`pxt4_es_‰ì_exã¡
(
öode
, 
es
);

546 
es
 = 
es1
;

549  
es
;

550 
	}
}

552 
exã¡_°©us
 *

553 
	$pxt4_es_åy_to_mîge_right
(
öode
 *öode, 
exã¡_°©us
 *
es
)

555 
pxt4_es_åì
 *
åì
 = &
	`PXT4_I
(
öode
)->
i_es_åì
;

556 
exã¡_°©us
 *
es1
;

557 
rb_node
 *
node
;

559 
node
 = 
	`rb_√xt
(&
es
->
rb_node
);

560 i‡(!
node
)

561  
es
;

563 
es1
 = 
	`rb_íåy
(
node
, 
exã¡_°©us
, 
rb_node
);

564 i‡(
	`pxt4_es_ˇn_be_mîged
(
es
, 
es1
)) {

565 
es
->
es_Àn
 +
es1
->es_len;

566 i‡(
	`pxt4_es_is_ª„ªn˚d
(
es1
))

567 
	`pxt4_es_£t_ª„ªn˚d
(
es
);

568 
	`rb_îa£
(
node
, &
åì
->
roŸ
);

569 
	`pxt4_es_‰ì_exã¡
(
öode
, 
es1
);

572  
es
;

573 
	}
}

575 #ifde‡
ES_AGGRESSIVE_TEST


576 
	~"pxt4_exã¡s.h
"

578 
	$pxt4_es_ö£π_exã¡_ext_check
(
öode
 *inode,

579 
exã¡_°©us
 *
es
)

581 
pxt4_ext_∑th
 *
∑th
 = 
NULL
;

582 
pxt4_exã¡
 *
ex
;

583 
pxt4_lblk_t
 
ì_block
;

584 
pxt4_fsblk_t
 
ì_°¨t
;

585 
ì_Àn
;

586 
dïth
, 
ì_°©us
, 
es_°©us
;

588 
∑th
 = 
	`pxt4_föd_exã¡
(
öode
, 
es
->
es_lblk
, 
NULL
, 
PXT4_EX_NOCACHE
);

589 i‡(
	`IS_ERR
(
∑th
))

592 
dïth
 = 
	`ext_dïth
(
öode
);

593 
ex
 = 
∑th
[
dïth
].
p_ext
;

595 i‡(
ex
) {

597 
ì_block
 = 
	`À32_to_˝u
(
ex
->ee_block);

598 
ì_°¨t
 = 
	`pxt4_ext_pblock
(
ex
);

599 
ì_Àn
 = 
	`pxt4_ext_gë_a˘uÆ_Àn
(
ex
);

601 
ì_°©us
 = 
	`pxt4_ext_is_unwrôãn
(
ex
) ? 1 : 0;

602 
es_°©us
 = 
	`pxt4_es_is_unwrôãn
(
es
) ? 1 : 0;

608 i‡(!
	`pxt4_es_is_wrôãn
(
es
Ë&& !
	`pxt4_es_is_unwrôãn
(es)) {

609 i‡(
	`ö_ønge
(
es
->
es_lblk
, 
ì_block
, 
ì_Àn
)) {

610 
	`¥_w¨n
("ES insertássertion failed for "

615 
öode
->
i_öo
, 
ì_block
, 
ì_Àn
,

616 
ì_°¨t
, 
ì_°©us
 ? 'u' : 'w',

617 
es
->
es_lblk
,És->
es_Àn
,

618 
	`pxt4_es_pblock
(
es
), 
	`pxt4_es_°©us
(es));

620 
out
;

627 i‡(
es
->
es_lblk
 < 
ì_block
 ||

628 
	`pxt4_es_pblock
(
es
Ë!
ì_°¨t
 +És->
es_lblk
 - 
ì_block
) {

629 
	`¥_w¨n
("ES insertássertion failed for inode: %lu "

631 "es_°©u†[%d/%d/%Œu/%c]\n", 
öode
->
i_öo
,

632 
ì_block
, 
ì_Àn
, 
ì_°¨t
,

633 
ì_°©us
 ? 'u' : 'w', 
es
->
es_lblk
,És->
es_Àn
,

634 
	`pxt4_es_pblock
(
es
), 
es_°©us
 ? 'u' : 'w');

635 
out
;

638 i‡(
ì_°©us
 ^ 
es_°©us
) {

639 
	`¥_w¨n
("ES insertássertion failed for inode: %lu "

641 "es_°©u†[%d/%d/%Œu/%c]\n", 
öode
->
i_öo
,

642 
ì_block
, 
ì_Àn
, 
ì_°¨t
,

643 
ì_°©us
 ? 'u' : 'w', 
es
->
es_lblk
,És->
es_Àn
,

644 
	`pxt4_es_pblock
(
es
), 
es_°©us
 ? 'u' : 'w');

651 i‡(!
	`pxt4_es_is_dñayed
(
es
Ë&& !
	`pxt4_es_is_hﬁe
(es)) {

652 
	`¥_w¨n
("ES insertássertion failed for inode: %lu "

655 "[%d/%d/%Œu/%x]\n", 
öode
->
i_öo
,

656 
es
->
es_lblk
,És->es_lblk,És->
es_Àn
,

657 
	`pxt4_es_pblock
(
es
), 
	`pxt4_es_°©us
(es));

660 
out
:

661 
	`pxt4_ext_dr›_ªfs
(
∑th
);

662 
	`k‰ì
(
∑th
);

663 
	}
}

665 
	$pxt4_es_ö£π_exã¡_öd_check
(
öode
 *inode,

666 
exã¡_°©us
 *
es
)

668 
pxt4_m≠_blocks
 
m≠
;

669 
ªtvÆ
;

678 
m≠
.
m_lblk
 = 
es
->
es_lblk
;

679 
m≠
.
m_Àn
 = 
es
->
es_Àn
;

681 
ªtvÆ
 = 
	`pxt4_öd_m≠_blocks
(
NULL
, 
öode
, &
m≠
, 0);

682 i‡(
ªtvÆ
 > 0) {

683 i‡(
	`pxt4_es_is_dñayed
(
es
Ë|| 
	`pxt4_es_is_hﬁe
(es)) {

688 
	`¥_w¨n
("ES insertássertion failed for inode: %lu "

691 
öode
->
i_öo
, 
es
->
es_lblk
,És->
es_Àn
,

692 
	`pxt4_es_pblock
(
es
), 
	`pxt4_es_°©us
(es));

694 } i‡(
	`pxt4_es_is_wrôãn
(
es
)) {

695 i‡(
ªtvÆ
 !
es
->
es_Àn
) {

696 
	`¥_w¨n
("ES insertássertion failed for "

698 
öode
->
i_öo
, 
ªtvÆ
, 
es
->
es_Àn
);

701 i‡(
m≠
.
m_pblk
 !
	`pxt4_es_pblock
(
es
)) {

702 
	`¥_w¨n
("ES insertássertion failed for "

705 
öode
->
i_öo
, 
m≠
.
m_pblk
,

706 
	`pxt4_es_pblock
(
es
));

714 
	`BUG
();

716 } i‡(
ªtvÆ
 == 0) {

717 i‡(
	`pxt4_es_is_wrôãn
(
es
)) {

718 
	`¥_w¨n
("ES insertássertion failed for inode: %lu "

721 
öode
->
i_öo
, 
es
->
es_lblk
,És->
es_Àn
,

722 
	`pxt4_es_pblock
(
es
), 
	`pxt4_es_°©us
(es));

726 
	}
}

728 
ölöe
 
	$pxt4_es_ö£π_exã¡_check
(
öode
 *inode,

729 
exã¡_°©us
 *
es
)

735 
	`BUG_ON
(!
	`rw£m_is_locked
(&
	`PXT4_I
(
öode
)->
i_d©a_£m
));

736 i‡(
	`pxt4_ã°_öode_Êag
(
öode
, 
PXT4_INODE_EXTENTS
))

737 
	`pxt4_es_ö£π_exã¡_ext_check
(
öode
, 
es
);

739 
	`pxt4_es_ö£π_exã¡_öd_check
(
öode
, 
es
);

740 
	}
}

742 
ölöe
 
	$pxt4_es_ö£π_exã¡_check
(
öode
 *inode,

743 
exã¡_°©us
 *
es
)

745 
	}
}

748 
	$__es_ö£π_exã¡
(
öode
 *öode, 
exã¡_°©us
 *
√wes
)

750 
pxt4_es_åì
 *
åì
 = &
	`PXT4_I
(
öode
)->
i_es_åì
;

751 
rb_node
 **
p
 = &
åì
->
roŸ
.rb_node;

752 
rb_node
 *
∑ª¡
 = 
NULL
;

753 
exã¡_°©us
 *
es
;

755 *
p
) {

756 
∑ª¡
 = *
p
;

757 
es
 = 
	`rb_íåy
(
∑ª¡
, 
exã¡_°©us
, 
rb_node
);

759 i‡(
√wes
->
es_lblk
 < 
es
->es_lblk) {

760 i‡(
	`pxt4_es_ˇn_be_mîged
(
√wes
, 
es
)) {

765 
es
->
es_lblk
 = 
√wes
->es_lblk;

766 
es
->
es_Àn
 +
√wes
->es_len;

767 i‡(
	`pxt4_es_is_wrôãn
(
es
) ||

768 
	`pxt4_es_is_unwrôãn
(
es
))

769 
	`pxt4_es_°‹e_pblock
(
es
,

770 
√wes
->
es_pblk
);

771 
es
 = 
	`pxt4_es_åy_to_mîge_À·
(
öode
,És);

772 
out
;

774 
p
 = &(*p)->
rb_À·
;

775 } i‡(
√wes
->
es_lblk
 > 
	`pxt4_es_íd
(
es
)) {

776 i‡(
	`pxt4_es_ˇn_be_mîged
(
es
, 
√wes
)) {

777 
es
->
es_Àn
 +
√wes
->es_len;

778 
es
 = 
	`pxt4_es_åy_to_mîge_right
(
öode
,És);

779 
out
;

781 
p
 = &(*p)->
rb_right
;

783 
	`BUG
();

784  -
EINVAL
;

788 
es
 = 
	`pxt4_es_Æloc_exã¡
(
öode
, 
√wes
->
es_lblk
,Çewes->
es_Àn
,

789 
√wes
->
es_pblk
);

790 i‡(!
es
)

791  -
ENOMEM
;

792 
	`rb_lök_node
(&
es
->
rb_node
, 
∑ª¡
, 
p
);

793 
	`rb_ö£π_cﬁ‹
(&
es
->
rb_node
, &
åì
->
roŸ
);

795 
out
:

796 
åì
->
ˇche_es
 = 
es
;

798 
	}
}

806 
	$pxt4_es_ö£π_exã¡
(
öode
 *öode, 
pxt4_lblk_t
 
lblk
,

807 
pxt4_lblk_t
 
Àn
, 
pxt4_fsblk_t
 
pblk
,

808 
°©us
)

810 
exã¡_°©us
 
√wes
;

811 
pxt4_lblk_t
 
íd
 = 
lblk
 + 
Àn
 - 1;

812 
îr
 = 0;

813 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
öode
->
i_sb
);

815 
	`es_debug
("add [%u/%u) %llu %xÅoÉxtent statusÅree of inode %lu\n",

816 
lblk
, 
Àn
, 
pblk
, 
°©us
, 
öode
->
i_öo
);

818 i‡(!
Àn
)

821 
	`BUG_ON
(
íd
 < 
lblk
);

823 i‡((
°©us
 & 
EXTENT_STATUS_DELAYED
) &&

824 (
°©us
 & 
EXTENT_STATUS_WRITTEN
)) {

825 
	`pxt4_w¨nög
(
öode
->
i_sb
, "InsertingÉxtent [%u/%u]ás "

827 " cau£ d©®loss.", 
lblk
, 
Àn
);

828 
	`WARN_ON
(1);

831 
√wes
.
es_lblk
 = 
lblk
;

832 
√wes
.
es_Àn
 = 
Àn
;

833 
	`pxt4_es_°‹e_pblock_°©us
(&
√wes
, 
pblk
, 
°©us
);

834 
	`åa˚_pxt4_es_ö£π_exã¡
(
öode
, &
√wes
);

836 
	`pxt4_es_ö£π_exã¡_check
(
öode
, &
√wes
);

838 
	`wrôe_lock
(&
	`PXT4_I
(
öode
)->
i_es_lock
);

839 
îr
 = 
	`__es_ªmove_exã¡
(
öode
, 
lblk
, 
íd
, 
NULL
);

840 i‡(
îr
 != 0)

841 
îr‹
;

842 
ªåy
:

843 
îr
 = 
	`__es_ö£π_exã¡
(
öode
, &
√wes
);

844 i‡(
îr
 =-
ENOMEM
 && 
	`__es_shrök
(
	`PXT4_SB
(
öode
->
i_sb
),

845 128, 
	`PXT4_I
(
öode
)))

846 
ªåy
;

847 i‡(
îr
 =-
ENOMEM
 && !
	`pxt4_es_is_dñayed
(&
√wes
))

848 
îr
 = 0;

850 i‡(
sbi
->
s_˛u°î_øtio
 > 1 && 
	`ã°_›t
(
öode
->
i_sb
, 
DELALLOC
) &&

851 (
°©us
 & 
EXTENT_STATUS_WRITTEN
 ||

852 
°©us
 & 
EXTENT_STATUS_UNWRITTEN
))

853 
	`__ªvi£_≥ndög
(
öode
, 
lblk
, 
Àn
);

855 
îr‹
:

856 
	`wrôe_u∆ock
(&
	`PXT4_I
(
öode
)->
i_es_lock
);

858 
	`pxt4_es_¥öt_åì
(
öode
);

860  
îr
;

861 
	}
}

868 
	$pxt4_es_ˇche_exã¡
(
öode
 *öode, 
pxt4_lblk_t
 
lblk
,

869 
pxt4_lblk_t
 
Àn
, 
pxt4_fsblk_t
 
pblk
,

870 
°©us
)

872 
exã¡_°©us
 *
es
;

873 
exã¡_°©us
 
√wes
;

874 
pxt4_lblk_t
 
íd
 = 
lblk
 + 
Àn
 - 1;

876 
√wes
.
es_lblk
 = 
lblk
;

877 
√wes
.
es_Àn
 = 
Àn
;

878 
	`pxt4_es_°‹e_pblock_°©us
(&
√wes
, 
pblk
, 
°©us
);

879 
	`åa˚_pxt4_es_ˇche_exã¡
(
öode
, &
√wes
);

881 i‡(!
Àn
)

884 
	`BUG_ON
(
íd
 < 
lblk
);

886 
	`wrôe_lock
(&
	`PXT4_I
(
öode
)->
i_es_lock
);

888 
es
 = 
	`__es_åì_£¨ch
(&
	`PXT4_I
(
öode
)->
i_es_åì
.
roŸ
, 
lblk
);

889 i‡(!
es
 ||És->
es_lblk
 > 
íd
)

890 
	`__es_ö£π_exã¡
(
öode
, &
√wes
);

891 
	`wrôe_u∆ock
(&
	`PXT4_I
(
öode
)->
i_es_lock
);

892 
	}
}

901 
	$pxt4_es_lookup_exã¡
(
öode
 *öode, 
pxt4_lblk_t
 
lblk
,

902 
pxt4_lblk_t
 *
√xt_lblk
,

903 
exã¡_°©us
 *
es
)

905 
pxt4_es_åì
 *
åì
;

906 
pxt4_es_°©s
 *
°©s
;

907 
exã¡_°©us
 *
es1
 = 
NULL
;

908 
rb_node
 *
node
;

909 
found
 = 0;

911 
	`åa˚_pxt4_es_lookup_exã¡_íãr
(
öode
, 
lblk
);

912 
	`es_debug
("looku∞exã¡ i¿block %u\n", 
lblk
);

914 
åì
 = &
	`PXT4_I
(
öode
)->
i_es_åì
;

915 
	`ªad_lock
(&
	`PXT4_I
(
öode
)->
i_es_lock
);

918 
es
->
es_lblk
 =És->
es_Àn
 =És->
es_pblk
 = 0;

919 i‡(
åì
->
ˇche_es
) {

920 
es1
 = 
åì
->
ˇche_es
;

921 i‡(
	`ö_ønge
(
lblk
, 
es1
->
es_lblk
,És1->
es_Àn
)) {

922 
	`es_debug
("%u cached by [%u/%u)\n",

923 
lblk
, 
es1
->
es_lblk
,És1->
es_Àn
);

924 
found
 = 1;

925 
out
;

929 
node
 = 
åì
->
roŸ
.
rb_node
;

930 
node
) {

931 
es1
 = 
	`rb_íåy
(
node
, 
exã¡_°©us
, 
rb_node
);

932 i‡(
lblk
 < 
es1
->
es_lblk
)

933 
node
 =Çode->
rb_À·
;

934 i‡(
lblk
 > 
	`pxt4_es_íd
(
es1
))

935 
node
 =Çode->
rb_right
;

937 
found
 = 1;

942 
out
:

943 
°©s
 = &
	`PXT4_SB
(
öode
->
i_sb
)->
s_es_°©s
;

944 i‡(
found
) {

945 
	`BUG_ON
(!
es1
);

946 
es
->
es_lblk
 = 
es1
->es_lblk;

947 
es
->
es_Àn
 = 
es1
->es_len;

948 
es
->
es_pblk
 = 
es1
->es_pblk;

949 i‡(!
	`pxt4_es_is_ª„ªn˚d
(
es1
))

950 
	`pxt4_es_£t_ª„ªn˚d
(
es1
);

951 
	`≥r˝u_cou¡î_öc
(&
°©s
->
es_°©s_ˇche_hôs
);

952 i‡(
√xt_lblk
) {

953 
node
 = 
	`rb_√xt
(&
es1
->
rb_node
);

954 i‡(
node
) {

955 
es1
 = 
	`rb_íåy
(
node
, 
exã¡_°©us
,

956 
rb_node
);

957 *
√xt_lblk
 = 
es1
->
es_lblk
;

959 *
√xt_lblk
 = 0;

962 
	`≥r˝u_cou¡î_öc
(&
°©s
->
es_°©s_ˇche_mis£s
);

965 
	`ªad_u∆ock
(&
	`PXT4_I
(
öode
)->
i_es_lock
);

967 
	`åa˚_pxt4_es_lookup_exã¡_exô
(
öode
, 
es
, 
found
);

968  
found
;

969 
	}
}

971 
	srsvd_cou¡
 {

972 
	mndñ⁄ly
;

973 
boﬁ
 
	mfú°_do_lblk_found
;

974 
pxt4_lblk_t
 
	mfú°_do_lblk
;

975 
pxt4_lblk_t
 
	mœ°_do_lblk
;

976 
exã¡_°©us
 *
	mÀ·_es
;

977 
boﬁ
 
	m∑πül
;

978 
pxt4_lblk_t
 
	ml˛u
;

992 
	$öô_rsvd
(
öode
 *öode, 
pxt4_lblk_t
 
lblk
,

993 
exã¡_°©us
 *
es
, 
rsvd_cou¡
 *
rc
)

995 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
öode
->
i_sb
);

996 
rb_node
 *
node
;

998 
rc
->
ndñ⁄ly
 = 0;

1006 i‡(
sbi
->
s_˛u°î_øtio
 > 1) {

1007 
rc
->
fú°_do_lblk_found
 = 
Ál£
;

1008 i‡(
lblk
 > 
es
->
es_lblk
) {

1009 
rc
->
À·_es
 = 
es
;

1011 
node
 = 
	`rb_¥ev
(&
es
->
rb_node
);

1012 
rc
->
À·_es
 = 
node
 ? 
	`rb_íåy
(node,

1013 
exã¡_°©us
,

1014 
rb_node
Ë: 
NULL
;

1016 
rc
->
∑πül
 = 
Ál£
;

1018 
	}
}

1034 
	$cou¡_rsvd
(
öode
 *öode, 
pxt4_lblk_t
 
lblk
, 
Àn
,

1035 
exã¡_°©us
 *
es
, 
rsvd_cou¡
 *
rc
)

1037 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
öode
->
i_sb
);

1038 
pxt4_lblk_t
 
i
, 
íd
, 
n˛u
;

1040 i‡(!
	`pxt4_es_is_dñ⁄ly
(
es
))

1043 
	`WARN_ON
(
Àn
 <= 0);

1045 i‡(
sbi
->
s_˛u°î_øtio
 == 1) {

1046 
rc
->
ndñ⁄ly
 +(Ë
Àn
;

1052 
i
 = (
lblk
 < 
es
->
es_lblk
) ?És->es_lblk :Üblk;

1053 
íd
 = 
lblk
 + (
pxt4_lblk_t
Ë
Àn
 - 1;

1054 
íd
 = (íd > 
	`pxt4_es_íd
(
es
)) ?Öxt4_es_end(es) :Énd;

1057 i‡(
rc
->
fú°_do_lblk_found
 =
Ál£
) {

1058 
rc
->
fú°_do_lblk
 = 
i
;

1059 
rc
->
fú°_do_lblk_found
 = 
åue
;

1063 
rc
->
œ°_do_lblk
 = 
íd
;

1069 i‡(
rc
->
∑πül
 && (rc->
l˛u
 !
	`PXT4_B2C
(
sbi
, 
i
))) {

1070 
rc
->
ndñ⁄ly
++;

1071 
rc
->
∑πül
 = 
Ál£
;

1078 i‡(
	`PXT4_LBLK_COFF
(
sbi
, 
i
) != 0) {

1079 i‡(
íd
 >
	`PXT4_LBLK_CFILL
(
sbi
, 
i
)) {

1080 
rc
->
ndñ⁄ly
++;

1081 
rc
->
∑πül
 = 
Ál£
;

1082 
i
 = 
	`PXT4_LBLK_CFILL
(
sbi
, i) + 1;

1090 i‡((
i
 + 
sbi
->
s_˛u°î_øtio
 - 1Ë<
íd
) {

1091 
n˛u
 = (
íd
 - 
i
 + 1Ë>> 
sbi
->
s_˛u°î_bôs
;

1092 
rc
->
ndñ⁄ly
 +
n˛u
;

1093 
i
 +
n˛u
 << 
sbi
->
s_˛u°î_bôs
;

1100 i‡(!
rc
->
∑πül
 && 
i
 <
íd
) {

1101 
rc
->
∑πül
 = 
åue
;

1102 
rc
->
l˛u
 = 
	`PXT4_B2C
(
sbi
, 
i
);

1104 
	}
}

1116 
≥ndög_ª£rv©i⁄
 *
	$__¥_åì_£¨ch
(
rb_roŸ
 *
roŸ
,

1117 
pxt4_lblk_t
 
l˛u
)

1119 
rb_node
 *
node
 = 
roŸ
->rb_node;

1120 
≥ndög_ª£rv©i⁄
 *
¥
 = 
NULL
;

1122 
node
) {

1123 
¥
 = 
	`rb_íåy
(
node
, 
≥ndög_ª£rv©i⁄
, 
rb_node
);

1124 i‡(
l˛u
 < 
¥
->lclu)

1125 
node
 =Çode->
rb_À·
;

1126 i‡(
l˛u
 > 
¥
->lclu)

1127 
node
 =Çode->
rb_right
;

1129  
¥
;

1131 i‡(
¥
 && 
l˛u
 <Ör->lclu)

1132  
¥
;

1133 i‡(
¥
 && 
l˛u
 >Ör->lclu) {

1134 
node
 = 
	`rb_√xt
(&
¥
->
rb_node
);

1135  
node
 ? 
	`rb_íåy
“ode, 
≥ndög_ª£rv©i⁄
,

1136 
rb_node
Ë: 
NULL
;

1138  
NULL
;

1139 
	}
}

1157 
	$gë_rsvd
(
öode
 *öode, 
pxt4_lblk_t
 
íd
,

1158 
exã¡_°©us
 *
right_es
,

1159 
rsvd_cou¡
 *
rc
)

1161 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
öode
->
i_sb
);

1162 
≥ndög_ª£rv©i⁄
 *
¥
;

1163 
pxt4_≥ndög_åì
 *
åì
 = &
	`PXT4_I
(
öode
)->
i_≥ndög_åì
;

1164 
rb_node
 *
node
;

1165 
pxt4_lblk_t
 
fú°_l˛u
, 
œ°_l˛u
;

1166 
boﬁ
 
À·_dñ⁄ly
, 
right_dñ⁄ly
, 
cou¡_≥ndög
;

1167 
exã¡_°©us
 *
es
;

1169 i‡(
sbi
->
s_˛u°î_øtio
 > 1) {

1171 i‡(
rc
->
∑πül
)

1172 
rc
->
ndñ⁄ly
++;

1174 i‡(
rc
->
ndñ⁄ly
 == 0)

1177 
fú°_l˛u
 = 
	`PXT4_B2C
(
sbi
, 
rc
->
fú°_do_lblk
);

1178 
œ°_l˛u
 = 
	`PXT4_B2C
(
sbi
, 
rc
->
œ°_do_lblk
);

1185 
À·_dñ⁄ly
 = 
right_dñ⁄ly
 = 
Ál£
;

1187 
es
 = 
rc
->
À·_es
;

1188 
es
 && 
	`pxt4_es_íd
(es) >=

1189 
	`PXT4_LBLK_CMASK
(
sbi
, 
rc
->
fú°_do_lblk
)) {

1190 i‡(
	`pxt4_es_is_dñ⁄ly
(
es
)) {

1191 
rc
->
ndñ⁄ly
--;

1192 
À·_dñ⁄ly
 = 
åue
;

1195 
node
 = 
	`rb_¥ev
(&
es
->
rb_node
);

1196 i‡(!
node
)

1198 
es
 = 
	`rb_íåy
(
node
, 
exã¡_°©us
, 
rb_node
);

1200 i‡(
right_es
 && (!
À·_dñ⁄ly
 || 
fú°_l˛u
 !
œ°_l˛u
)) {

1201 i‡(
íd
 < 
	`pxt4_es_íd
(
right_es
)) {

1202 
es
 = 
right_es
;

1204 
node
 = 
	`rb_√xt
(&
right_es
->
rb_node
);

1205 
es
 = 
node
 ? 
	`rb_íåy
“ode, 
exã¡_°©us
,

1206 
rb_node
Ë: 
NULL
;

1208 
es
 &&És->
es_lblk
 <=

1209 
	`PXT4_LBLK_CFILL
(
sbi
, 
rc
->
œ°_do_lblk
)) {

1210 i‡(
	`pxt4_es_is_dñ⁄ly
(
es
)) {

1211 
rc
->
ndñ⁄ly
--;

1212 
right_dñ⁄ly
 = 
åue
;

1215 
node
 = 
	`rb_√xt
(&
es
->
rb_node
);

1216 i‡(!
node
)

1218 
es
 = 
	`rb_íåy
(
node
, 
exã¡_°©us
,

1219 
rb_node
);

1232 i‡(
fú°_l˛u
 =
œ°_l˛u
) {

1233 i‡(
À·_dñ⁄ly
 | 
right_dñ⁄ly
)

1234 
cou¡_≥ndög
 = 
Ál£
;

1236 
cou¡_≥ndög
 = 
åue
;

1238 i‡(
À·_dñ⁄ly
)

1239 
fú°_l˛u
++;

1240 i‡(
right_dñ⁄ly
)

1241 
œ°_l˛u
--;

1242 i‡(
fú°_l˛u
 <
œ°_l˛u
)

1243 
cou¡_≥ndög
 = 
åue
;

1245 
cou¡_≥ndög
 = 
Ál£
;

1254 i‡(
cou¡_≥ndög
) {

1255 
¥
 = 
	`__¥_åì_£¨ch
(&
åì
->
roŸ
, 
fú°_l˛u
);

1256 
¥
 &&Ör->
l˛u
 <
œ°_l˛u
) {

1257 
rc
->
ndñ⁄ly
--;

1258 
node
 = 
	`rb_√xt
(&
¥
->
rb_node
);

1259 
	`rb_îa£
(&
¥
->
rb_node
, &
åì
->
roŸ
);

1260 
	`kmem_ˇche_‰ì
(
pxt4_≥ndög_ˇchï
, 
¥
);

1261 i‡(!
node
)

1263 
¥
 = 
	`rb_íåy
(
node
, 
≥ndög_ª£rv©i⁄
,

1264 
rb_node
);

1268  
rc
->
ndñ⁄ly
;

1269 
	}
}

1285 
	$__es_ªmove_exã¡
(
öode
 *öode, 
pxt4_lblk_t
 
lblk
,

1286 
pxt4_lblk_t
 
íd
, *
ª£rved
)

1288 
pxt4_es_åì
 *
åì
 = &
	`PXT4_I
(
öode
)->
i_es_åì
;

1289 
rb_node
 *
node
;

1290 
exã¡_°©us
 *
es
;

1291 
exã¡_°©us
 
‹ig_es
;

1292 
pxt4_lblk_t
 
Àn1
, 
Àn2
;

1293 
pxt4_fsblk_t
 
block
;

1294 
îr
;

1295 
boﬁ
 
cou¡_ª£rved
 = 
åue
;

1296 
rsvd_cou¡
 
rc
;

1298 i‡(
ª£rved
 =
NULL
 || !
	`ã°_›t
(
öode
->
i_sb
, 
DELALLOC
))

1299 
cou¡_ª£rved
 = 
Ál£
;

1300 
ªåy
:

1301 
îr
 = 0;

1303 
es
 = 
	`__es_åì_£¨ch
(&
åì
->
roŸ
, 
lblk
);

1304 i‡(!
es
)

1305 
out
;

1306 i‡(
es
->
es_lblk
 > 
íd
)

1307 
out
;

1310 
åì
->
ˇche_es
 = 
NULL
;

1311 i‡(
cou¡_ª£rved
)

1312 
	`öô_rsvd
(
öode
, 
lblk
, 
es
, &
rc
);

1314 
‹ig_es
.
es_lblk
 = 
es
->es_lblk;

1315 
‹ig_es
.
es_Àn
 = 
es
->es_len;

1316 
‹ig_es
.
es_pblk
 = 
es
->es_pblk;

1318 
Àn1
 = 
lblk
 > 
es
->
es_lblk
 ?Üblk -És->es_lblk : 0;

1319 
Àn2
 = 
	`pxt4_es_íd
(
es
Ë> 
íd
 ?Öxt4_es_end(es) -Énd : 0;

1320 i‡(
Àn1
 > 0)

1321 
es
->
es_Àn
 = 
Àn1
;

1322 i‡(
Àn2
 > 0) {

1323 i‡(
Àn1
 > 0) {

1324 
exã¡_°©us
 
√wes
;

1326 
√wes
.
es_lblk
 = 
íd
 + 1;

1327 
√wes
.
es_Àn
 = 
Àn2
;

1328 
block
 = 0x7FDEADBEEFULL;

1329 i‡(
	`pxt4_es_is_wrôãn
(&
‹ig_es
) ||

1330 
	`pxt4_es_is_unwrôãn
(&
‹ig_es
))

1331 
block
 = 
	`pxt4_es_pblock
(&
‹ig_es
) +

1332 
‹ig_es
.
es_Àn
 - 
Àn2
;

1333 
	`pxt4_es_°‹e_pblock_°©us
(&
√wes
, 
block
,

1334 
	`pxt4_es_°©us
(&
‹ig_es
));

1335 
îr
 = 
	`__es_ö£π_exã¡
(
öode
, &
√wes
);

1336 i‡(
îr
) {

1337 
es
->
es_lblk
 = 
‹ig_es
.es_lblk;

1338 
es
->
es_Àn
 = 
‹ig_es
.es_len;

1339 i‡((
îr
 =-
ENOMEM
) &&

1340 
	`__es_shrök
(
	`PXT4_SB
(
öode
->
i_sb
),

1341 128, 
	`PXT4_I
(
öode
)))

1342 
ªåy
;

1343 
out
;

1346 
es
->
es_lblk
 = 
íd
 + 1;

1347 
es
->
es_Àn
 = 
Àn2
;

1348 i‡(
	`pxt4_es_is_wrôãn
(
es
) ||

1349 
	`pxt4_es_is_unwrôãn
(
es
)) {

1350 
block
 = 
‹ig_es
.
es_pblk
 + orig_es.
es_Àn
 - 
Àn2
;

1351 
	`pxt4_es_°‹e_pblock
(
es
, 
block
);

1354 i‡(
cou¡_ª£rved
)

1355 
	`cou¡_rsvd
(
öode
, 
lblk
, 
‹ig_es
.
es_Àn
 - 
Àn1
 - 
Àn2
,

1356 &
‹ig_es
, &
rc
);

1357 
out
;

1360 i‡(
Àn1
 > 0) {

1361 i‡(
cou¡_ª£rved
)

1362 
	`cou¡_rsvd
(
öode
, 
lblk
, 
‹ig_es
.
es_Àn
 - 
Àn1
,

1363 &
‹ig_es
, &
rc
);

1364 
node
 = 
	`rb_√xt
(&
es
->
rb_node
);

1365 i‡(
node
)

1366 
es
 = 
	`rb_íåy
(
node
, 
exã¡_°©us
, 
rb_node
);

1368 
es
 = 
NULL
;

1371 
es
 && 
	`pxt4_es_íd
”sË<
íd
) {

1372 i‡(
cou¡_ª£rved
)

1373 
	`cou¡_rsvd
(
öode
, 
es
->
es_lblk
,És->
es_Àn
,És, &
rc
);

1374 
node
 = 
	`rb_√xt
(&
es
->
rb_node
);

1375 
	`rb_îa£
(&
es
->
rb_node
, &
åì
->
roŸ
);

1376 
	`pxt4_es_‰ì_exã¡
(
öode
, 
es
);

1377 i‡(!
node
) {

1378 
es
 = 
NULL
;

1381 
es
 = 
	`rb_íåy
(
node
, 
exã¡_°©us
, 
rb_node
);

1384 i‡(
es
 &&És->
es_lblk
 < 
íd
 + 1) {

1385 
pxt4_lblk_t
 
‹ig_Àn
 = 
es
->
es_Àn
;

1387 
Àn1
 = 
	`pxt4_es_íd
(
es
Ë- 
íd
;

1388 i‡(
cou¡_ª£rved
)

1389 
	`cou¡_rsvd
(
öode
, 
es
->
es_lblk
, 
‹ig_Àn
 - 
Àn1
,

1390 
es
, &
rc
);

1391 
es
->
es_lblk
 = 
íd
 + 1;

1392 
es
->
es_Àn
 = 
Àn1
;

1393 i‡(
	`pxt4_es_is_wrôãn
(
es
Ë|| 
	`pxt4_es_is_unwrôãn
(es)) {

1394 
block
 = 
es
->
es_pblk
 + 
‹ig_Àn
 - 
Àn1
;

1395 
	`pxt4_es_°‹e_pblock
(
es
, 
block
);

1399 i‡(
cou¡_ª£rved
)

1400 *
ª£rved
 = 
	`gë_rsvd
(
öode
, 
íd
, 
es
, &
rc
);

1401 
out
:

1402  
îr
;

1403 
	}
}

1415 
	$pxt4_es_ªmove_exã¡
(
öode
 *öode, 
pxt4_lblk_t
 
lblk
,

1416 
pxt4_lblk_t
 
Àn
)

1418 
pxt4_lblk_t
 
íd
;

1419 
îr
 = 0;

1420 
ª£rved
 = 0;

1422 
	`åa˚_pxt4_es_ªmove_exã¡
(
öode
, 
lblk
, 
Àn
);

1423 
	`es_debug
("remove [%u/%u) fromÉxtent statusÅree of inode %lu\n",

1424 
lblk
, 
Àn
, 
öode
->
i_öo
);

1426 i‡(!
Àn
)

1427  
îr
;

1429 
íd
 = 
lblk
 + 
Àn
 - 1;

1430 
	`BUG_ON
(
íd
 < 
lblk
);

1437 
	`wrôe_lock
(&
	`PXT4_I
(
öode
)->
i_es_lock
);

1438 
îr
 = 
	`__es_ªmove_exã¡
(
öode
, 
lblk
, 
íd
, &
ª£rved
);

1439 
	`wrôe_u∆ock
(&
	`PXT4_I
(
öode
)->
i_es_lock
);

1440 
	`pxt4_es_¥öt_åì
(
öode
);

1441 
	`pxt4_da_ªÀa£_•a˚
(
öode
, 
ª£rved
);

1442  
îr
;

1443 
	}
}

1445 
	$__es_shrök
(
pxt4_sb_öfo
 *
sbi
, 
ƒ_to_sˇn
,

1446 
pxt4_öode_öfo
 *
locked_ei
)

1448 
pxt4_öode_öfo
 *
ei
;

1449 
pxt4_es_°©s
 *
es_°©s
;

1450 
ktime_t
 
°¨t_time
;

1451 
u64
 
sˇn_time
;

1452 
ƒ_to_wÆk
;

1453 
ƒ_shrunk
 = 0;

1454 
ªåõd
 = 0, 
ƒ_skù≥d
 = 0;

1456 
es_°©s
 = &
sbi
->
s_es_°©s
;

1457 
°¨t_time
 = 
	`ktime_gë
();

1459 
ªåy
:

1460 
	`•ö_lock
(&
sbi
->
s_es_lock
);

1461 
ƒ_to_wÆk
 = 
sbi
->
s_es_ƒ_öode
;

1462 
ƒ_to_wÆk
-- > 0) {

1463 i‡(
	`li°_em±y
(&
sbi
->
s_es_li°
)) {

1464 
	`•ö_u∆ock
(&
sbi
->
s_es_lock
);

1465 
out
;

1467 
ei
 = 
	`li°_fú°_íåy
(&
sbi
->
s_es_li°
, 
pxt4_öode_öfo
,

1468 
i_es_li°
);

1470 
	`li°_move_èû
(&
ei
->
i_es_li°
, &
sbi
->
s_es_li°
);

1476 i‡(!
ªåõd
 && 
	`pxt4_ã°_öode_°©e
(&
ei
->
vfs_öode
,

1477 
PXT4_STATE_EXT_PRECACHED
)) {

1478 
ƒ_skù≥d
++;

1482 i‡(
ei
 =
locked_ei
 || !
	`wrôe_åylock
(&ei->
i_es_lock
)) {

1483 
ƒ_skù≥d
++;

1490 
	`•ö_u∆ock
(&
sbi
->
s_es_lock
);

1492 
ƒ_shrunk
 +
	`es_ª˛aim_exã¡s
(
ei
, &
ƒ_to_sˇn
);

1493 
	`wrôe_u∆ock
(&
ei
->
i_es_lock
);

1495 i‡(
ƒ_to_sˇn
 <= 0)

1496 
out
;

1497 
	`•ö_lock
(&
sbi
->
s_es_lock
);

1499 
	`•ö_u∆ock
(&
sbi
->
s_es_lock
);

1505 i‡((
ƒ_shrunk
 =0Ë&& 
ƒ_skù≥d
 && !
ªåõd
) {

1506 
ªåõd
++;

1507 
ªåy
;

1510 i‡(
locked_ei
 && 
ƒ_shrunk
 == 0)

1511 
ƒ_shrunk
 = 
	`es_ª˛aim_exã¡s
(
locked_ei
, &
ƒ_to_sˇn
);

1513 
out
:

1514 
sˇn_time
 = 
	`ktime_to_ns
(
	`ktime_sub
(
	`ktime_gë
(), 
°¨t_time
));

1515 i‡(
	`likñy
(
es_°©s
->
es_°©s_sˇn_time
))

1516 
es_°©s
->
es_°©s_sˇn_time
 = (
sˇn_time
 +

1517 
es_°©s
->
es_°©s_sˇn_time
*3) / 4;

1519 
es_°©s
->
es_°©s_sˇn_time
 = 
sˇn_time
;

1520 i‡(
sˇn_time
 > 
es_°©s
->
es_°©s_max_sˇn_time
)

1521 
es_°©s
->
es_°©s_max_sˇn_time
 = 
sˇn_time
;

1522 i‡(
	`likñy
(
es_°©s
->
es_°©s_shrunk
))

1523 
es_°©s
->
es_°©s_shrunk
 = (
ƒ_shrunk
 +

1524 
es_°©s
->
es_°©s_shrunk
*3) / 4;

1526 
es_°©s
->
es_°©s_shrunk
 = 
ƒ_shrunk
;

1528 
	`åa˚_pxt4_es_shrök
(
sbi
->
s_sb
, 
ƒ_shrunk
, 
sˇn_time
,

1529 
ƒ_skù≥d
, 
ªåõd
);

1530  
ƒ_shrunk
;

1531 
	}
}

1533 
	$pxt4_es_cou¡
(
shrökî
 *
shrök
,

1534 
shrök_c⁄åﬁ
 *
sc
)

1536 
ƒ
;

1537 
pxt4_sb_öfo
 *
sbi
;

1539 
sbi
 = 
	`c⁄èöî_of
(
shrök
, 
pxt4_sb_öfo
, 
s_es_shrökî
);

1540 
ƒ
 = 
	`≥r˝u_cou¡î_ªad_posôive
(&
sbi
->
s_es_°©s
.
es_°©s_shk_˙t
);

1541 
	`åa˚_pxt4_es_shrök_cou¡
(
sbi
->
s_sb
, 
sc
->
ƒ_to_sˇn
, 
ƒ
);

1542  
ƒ
;

1543 
	}
}

1545 
	$pxt4_es_sˇn
(
shrökî
 *
shrök
,

1546 
shrök_c⁄åﬁ
 *
sc
)

1548 
pxt4_sb_öfo
 *
sbi
 = 
	`c⁄èöî_of
(
shrök
,

1549 
pxt4_sb_öfo
, 
s_es_shrökî
);

1550 
ƒ_to_sˇn
 = 
sc
->nr_to_scan;

1551 
ªt
, 
ƒ_shrunk
;

1553 
ªt
 = 
	`≥r˝u_cou¡î_ªad_posôive
(&
sbi
->
s_es_°©s
.
es_°©s_shk_˙t
);

1554 
	`åa˚_pxt4_es_shrök_sˇn_íãr
(
sbi
->
s_sb
, 
ƒ_to_sˇn
, 
ªt
);

1556 
ƒ_shrunk
 = 
	`__es_shrök
(
sbi
, 
ƒ_to_sˇn
, 
NULL
);

1558 
ªt
 = 
	`≥r˝u_cou¡î_ªad_posôive
(&
sbi
->
s_es_°©s
.
es_°©s_shk_˙t
);

1559 
	`åa˚_pxt4_es_shrök_sˇn_exô
(
sbi
->
s_sb
, 
ƒ_shrunk
, 
ªt
);

1560  
ƒ_shrunk
;

1561 
	}
}

1563 
	$pxt4_£q_es_shrökî_öfo_show
(
£q_fûe
 *
£q
, *
v
)

1565 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
((
su≥r_block
 *Ë
£q
->
¥iv©e
);

1566 
pxt4_es_°©s
 *
es_°©s
 = &
sbi
->
s_es_°©s
;

1567 
pxt4_öode_öfo
 *
ei
, *
max
 = 
NULL
;

1568 
öode_˙t
 = 0;

1570 i‡(
v
 !
SEQ_START_TOKEN
)

1574 
	`•ö_lock
(&
sbi
->
s_es_lock
);

1575 
	`li°_f‹_óch_íåy
(
ei
, &
sbi
->
s_es_li°
, 
i_es_li°
) {

1576 
öode_˙t
++;

1577 i‡(
max
 && max->
i_es_Æl_ƒ
 < 
ei
->i_es_all_nr)

1578 
max
 = 
ei
;

1579 i‡(!
max
)

1580 
max
 = 
ei
;

1582 
	`•ö_u∆ock
(&
sbi
->
s_es_lock
);

1584 
	`£q_¥ötf
(
£q
, "stats:\n %lld objects\n %lldÑeclaimable objects\n",

1585 
	`≥r˝u_cou¡î_sum_posôive
(&
es_°©s
->
es_°©s_Æl_˙t
),

1586 
	`≥r˝u_cou¡î_sum_posôive
(&
es_°©s
->
es_°©s_shk_˙t
));

1587 
	`£q_¥ötf
(
£q
, " %lld/%lld cache hits/misses\n",

1588 
	`≥r˝u_cou¡î_sum_posôive
(&
es_°©s
->
es_°©s_ˇche_hôs
),

1589 
	`≥r˝u_cou¡î_sum_posôive
(&
es_°©s
->
es_°©s_ˇche_mis£s
));

1590 i‡(
öode_˙t
)

1591 
	`£q_¥ötf
(
£q
, " %d inode†⁄Üi°\n", 
öode_˙t
);

1593 
	`£q_¥ötf
(
£q
, "average:\n %llu us scanÅime\n",

1594 
	`div_u64
(
es_°©s
->
es_°©s_sˇn_time
, 1000));

1595 
	`£q_¥ötf
(
£q
, " %lu shrunk obje˘s\n", 
es_°©s
->
es_°©s_shrunk
);

1596 i‡(
öode_˙t
)

1597 
	`£q_¥ötf
(
£q
,

1600 
max
->
vfs_öode
.
i_öo
, max->
i_es_Æl_ƒ
, max->
i_es_shk_ƒ
,

1601 
	`div_u64
(
es_°©s
->
es_°©s_max_sˇn_time
, 1000));

1604 
	}
}

1606 
	$pxt4_es_ªgi°î_shrökî
(
pxt4_sb_öfo
 *
sbi
)

1608 
îr
;

1611 
	`BUILD_BUG_ON
(
ES_SHIFT
 < 48);

1612 
	`INIT_LIST_HEAD
(&
sbi
->
s_es_li°
);

1613 
sbi
->
s_es_ƒ_öode
 = 0;

1614 
	`•ö_lock_öô
(&
sbi
->
s_es_lock
);

1615 
sbi
->
s_es_°©s
.
es_°©s_shrunk
 = 0;

1616 
îr
 = 
	`≥r˝u_cou¡î_öô
(&
sbi
->
s_es_°©s
.
es_°©s_ˇche_hôs
, 0,

1617 
GFP_KERNEL
);

1618 i‡(
îr
)

1619  
îr
;

1620 
îr
 = 
	`≥r˝u_cou¡î_öô
(&
sbi
->
s_es_°©s
.
es_°©s_ˇche_mis£s
, 0,

1621 
GFP_KERNEL
);

1622 i‡(
îr
)

1623 
îr1
;

1624 
sbi
->
s_es_°©s
.
es_°©s_sˇn_time
 = 0;

1625 
sbi
->
s_es_°©s
.
es_°©s_max_sˇn_time
 = 0;

1626 
îr
 = 
	`≥r˝u_cou¡î_öô
(&
sbi
->
s_es_°©s
.
es_°©s_Æl_˙t
, 0, 
GFP_KERNEL
);

1627 i‡(
îr
)

1628 
îr2
;

1629 
îr
 = 
	`≥r˝u_cou¡î_öô
(&
sbi
->
s_es_°©s
.
es_°©s_shk_˙t
, 0, 
GFP_KERNEL
);

1630 i‡(
îr
)

1631 
îr3
;

1633 
sbi
->
s_es_shrökî
.
sˇn_obje˘s
 = 
pxt4_es_sˇn
;

1634 
sbi
->
s_es_shrökî
.
cou¡_obje˘s
 = 
pxt4_es_cou¡
;

1635 
sbi
->
s_es_shrökî
.
£eks
 = 
DEFAULT_SEEKS
;

1636 
îr
 = 
	`ªgi°î_shrökî
(&
sbi
->
s_es_shrökî
);

1637 i‡(
îr
)

1638 
îr4
;

1641 
îr4
:

1642 
	`≥r˝u_cou¡î_de°roy
(&
sbi
->
s_es_°©s
.
es_°©s_shk_˙t
);

1643 
îr3
:

1644 
	`≥r˝u_cou¡î_de°roy
(&
sbi
->
s_es_°©s
.
es_°©s_Æl_˙t
);

1645 
îr2
:

1646 
	`≥r˝u_cou¡î_de°roy
(&
sbi
->
s_es_°©s
.
es_°©s_ˇche_mis£s
);

1647 
îr1
:

1648 
	`≥r˝u_cou¡î_de°roy
(&
sbi
->
s_es_°©s
.
es_°©s_ˇche_hôs
);

1649  
îr
;

1650 
	}
}

1652 
	$pxt4_es_uƒegi°î_shrökî
(
pxt4_sb_öfo
 *
sbi
)

1654 
	`≥r˝u_cou¡î_de°roy
(&
sbi
->
s_es_°©s
.
es_°©s_ˇche_hôs
);

1655 
	`≥r˝u_cou¡î_de°roy
(&
sbi
->
s_es_°©s
.
es_°©s_ˇche_mis£s
);

1656 
	`≥r˝u_cou¡î_de°roy
(&
sbi
->
s_es_°©s
.
es_°©s_Æl_˙t
);

1657 
	`≥r˝u_cou¡î_de°roy
(&
sbi
->
s_es_°©s
.
es_°©s_shk_˙t
);

1658 
	`uƒegi°î_shrökî
(&
sbi
->
s_es_shrökî
);

1659 
	}
}

1669 
	$es_do_ª˛aim_exã¡s
(
pxt4_öode_öfo
 *
ei
, 
pxt4_lblk_t
 
íd
,

1670 *
ƒ_to_sˇn
, *
ƒ_shrunk
)

1672 
öode
 *öodê&
ei
->
vfs_öode
;

1673 
pxt4_es_åì
 *
åì
 = &
ei
->
i_es_åì
;

1674 
exã¡_°©us
 *
es
;

1675 
rb_node
 *
node
;

1677 
es
 = 
	`__es_åì_£¨ch
(&
åì
->
roŸ
, 
ei
->
i_es_shrök_lblk
);

1678 i‡(!
es
)

1679 
out_wøp
;

1681 *
ƒ_to_sˇn
 > 0) {

1682 i‡(
es
->
es_lblk
 > 
íd
) {

1683 
ei
->
i_es_shrök_lblk
 = 
íd
 + 1;

1687 (*
ƒ_to_sˇn
)--;

1688 
node
 = 
	`rb_√xt
(&
es
->
rb_node
);

1693 i‡(
	`pxt4_es_is_dñayed
(
es
))

1694 
√xt
;

1695 i‡(
	`pxt4_es_is_ª„ªn˚d
(
es
)) {

1696 
	`pxt4_es_˛ór_ª„ªn˚d
(
es
);

1697 
√xt
;

1700 
	`rb_îa£
(&
es
->
rb_node
, &
åì
->
roŸ
);

1701 
	`pxt4_es_‰ì_exã¡
(
öode
, 
es
);

1702 (*
ƒ_shrunk
)++;

1703 
√xt
:

1704 i‡(!
node
)

1705 
out_wøp
;

1706 
es
 = 
	`rb_íåy
(
node
, 
exã¡_°©us
, 
rb_node
);

1708 
ei
->
i_es_shrök_lblk
 = 
es
->
es_lblk
;

1710 
out_wøp
:

1711 
ei
->
i_es_shrök_lblk
 = 0;

1713 
	}
}

1715 
	$es_ª˛aim_exã¡s
(
pxt4_öode_öfo
 *
ei
, *
ƒ_to_sˇn
)

1717 
öode
 *öodê&
ei
->
vfs_öode
;

1718 
ƒ_shrunk
 = 0;

1719 
pxt4_lblk_t
 
°¨t
 = 
ei
->
i_es_shrök_lblk
;

1720 
	`DEFINE_RATELIMIT_STATE
(
_rs
, 
DEFAULT_RATELIMIT_INTERVAL
,

1721 
DEFAULT_RATELIMIT_BURST
);

1723 i‡(
ei
->
i_es_shk_ƒ
 == 0)

1726 i‡(
	`pxt4_ã°_öode_°©e
(
öode
, 
PXT4_STATE_EXT_PRECACHED
) &&

1727 
	`__øãlimô
(&
_rs
))

1728 
	`pxt4_w¨nög
(
öode
->
i_sb
, "forced shrink ofÖrecachedÉxtents");

1730 i‡(!
	`es_do_ª˛aim_exã¡s
(
ei
, 
EXT_MAX_BLOCKS
, 
ƒ_to_sˇn
, &
ƒ_shrunk
) &&

1731 
°¨t
 != 0)

1732 
	`es_do_ª˛aim_exã¡s
(
ei
, 
°¨t
 - 1, 
ƒ_to_sˇn
, &
ƒ_shrunk
);

1734 
ei
->
i_es_åì
.
ˇche_es
 = 
NULL
;

1735  
ƒ_shrunk
;

1736 
	}
}

1743 
	$pxt4_˛ór_öode_es
(
öode
 *inode)

1745 
pxt4_öode_öfo
 *
ei
 = 
	`PXT4_I
(
öode
);

1746 
exã¡_°©us
 *
es
;

1747 
pxt4_es_åì
 *
åì
;

1748 
rb_node
 *
node
;

1750 
	`wrôe_lock
(&
ei
->
i_es_lock
);

1751 
åì
 = &
	`PXT4_I
(
öode
)->
i_es_åì
;

1752 
åì
->
ˇche_es
 = 
NULL
;

1753 
node
 = 
	`rb_fú°
(&
åì
->
roŸ
);

1754 
node
) {

1755 
es
 = 
	`rb_íåy
(
node
, 
exã¡_°©us
, 
rb_node
);

1756 
node
 = 
	`rb_√xt
(node);

1757 i‡(!
	`pxt4_es_is_dñayed
(
es
)) {

1758 
	`rb_îa£
(&
es
->
rb_node
, &
åì
->
roŸ
);

1759 
	`pxt4_es_‰ì_exã¡
(
öode
, 
es
);

1762 
	`pxt4_˛ór_öode_°©e
(
öode
, 
PXT4_STATE_EXT_PRECACHED
);

1763 
	`wrôe_u∆ock
(&
ei
->
i_es_lock
);

1764 
	}
}

1766 #ifde‡
ES_DEBUG__


1767 
	$pxt4_¥öt_≥ndög_åì
(
öode
 *inode)

1769 
pxt4_≥ndög_åì
 *
åì
;

1770 
rb_node
 *
node
;

1771 
≥ndög_ª£rv©i⁄
 *
¥
;

1773 
	`¥ötk
(
KERN_DEBUG
 "≥ndögÑe£rv©i⁄†f‹ inodê%lu:", 
öode
->
i_öo
);

1774 
åì
 = &
	`PXT4_I
(
öode
)->
i_≥ndög_åì
;

1775 
node
 = 
	`rb_fú°
(&
åì
->
roŸ
);

1776 
node
) {

1777 
¥
 = 
	`rb_íåy
(
node
, 
≥ndög_ª£rv©i⁄
, 
rb_node
);

1778 
	`¥ötk
(
KERN_DEBUG
 " %u", 
¥
->
l˛u
);

1779 
node
 = 
	`rb_√xt
(node);

1781 
	`¥ötk
(
KERN_DEBUG
 "\n");

1782 
	}
}

1784 
	#pxt4_¥öt_≥ndög_åì
(
öode
)

	)

1787 
__öô
 
	$pxt4_öô_≥ndög
()

1789 
pxt4_≥ndög_ˇchï
 = 
	`kmem_ˇche_¸óã
("pxt4_pending_reservation",

1790 (
≥ndög_ª£rv©i⁄
),

1791 0, (
SLAB_RECLAIM_ACCOUNT
), 
NULL
);

1792 i‡(
pxt4_≥ndög_ˇchï
 =
NULL
)

1793  -
ENOMEM
;

1795 
	}
}

1797 
	$pxt4_exô_≥ndög
()

1799 
	`kmem_ˇche_de°roy
(
pxt4_≥ndög_ˇchï
);

1800 
	}
}

1802 
	$pxt4_öô_≥ndög_åì
(
pxt4_≥ndög_åì
 *
åì
)

1804 
åì
->
roŸ
 = 
RB_ROOT
;

1805 
	}
}

1816 
≥ndög_ª£rv©i⁄
 *
	$__gë_≥ndög
(
öode
 *inode,

1817 
pxt4_lblk_t
 
l˛u
)

1819 
pxt4_≥ndög_åì
 *
åì
;

1820 
rb_node
 *
node
;

1821 
≥ndög_ª£rv©i⁄
 *
¥
 = 
NULL
;

1823 
åì
 = &
	`PXT4_I
(
öode
)->
i_≥ndög_åì
;

1824 
node
 = (&
åì
->
roŸ
)->
rb_node
;

1826 
node
) {

1827 
¥
 = 
	`rb_íåy
(
node
, 
≥ndög_ª£rv©i⁄
, 
rb_node
);

1828 i‡(
l˛u
 < 
¥
->lclu)

1829 
node
 =Çode->
rb_À·
;

1830 i‡(
l˛u
 > 
¥
->lclu)

1831 
node
 =Çode->
rb_right
;

1832 i‡(
l˛u
 =
¥
->lclu)

1833  
¥
;

1835  
NULL
;

1836 
	}
}

1848 
	$__ö£π_≥ndög
(
öode
 *öode, 
pxt4_lblk_t
 
lblk
)

1850 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
öode
->
i_sb
);

1851 
pxt4_≥ndög_åì
 *
åì
 = &
	`PXT4_I
(
öode
)->
i_≥ndög_åì
;

1852 
rb_node
 **
p
 = &
åì
->
roŸ
.rb_node;

1853 
rb_node
 *
∑ª¡
 = 
NULL
;

1854 
≥ndög_ª£rv©i⁄
 *
¥
;

1855 
pxt4_lblk_t
 
l˛u
;

1856 
ªt
 = 0;

1858 
l˛u
 = 
	`PXT4_B2C
(
sbi
, 
lblk
);

1860 *
p
) {

1861 
∑ª¡
 = *
p
;

1862 
¥
 = 
	`rb_íåy
(
∑ª¡
, 
≥ndög_ª£rv©i⁄
, 
rb_node
);

1864 i‡(
l˛u
 < 
¥
->lclu) {

1865 
p
 = &(*p)->
rb_À·
;

1866 } i‡(
l˛u
 > 
¥
->lclu) {

1867 
p
 = &(*p)->
rb_right
;

1870 
out
;

1874 
¥
 = 
	`kmem_ˇche_Æloc
(
pxt4_≥ndög_ˇchï
, 
GFP_ATOMIC
);

1875 i‡(
¥
 =
NULL
) {

1876 
ªt
 = -
ENOMEM
;

1877 
out
;

1879 
¥
->
l˛u
 =Üclu;

1881 
	`rb_lök_node
(&
¥
->
rb_node
, 
∑ª¡
, 
p
);

1882 
	`rb_ö£π_cﬁ‹
(&
¥
->
rb_node
, &
åì
->
roŸ
);

1884 
out
:

1885  
ªt
;

1886 
	}
}

1897 
	$__ªmove_≥ndög
(
öode
 *öode, 
pxt4_lblk_t
 
lblk
)

1899 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
öode
->
i_sb
);

1900 
≥ndög_ª£rv©i⁄
 *
¥
;

1901 
pxt4_≥ndög_åì
 *
åì
;

1903 
¥
 = 
	`__gë_≥ndög
(
öode
, 
	`PXT4_B2C
(
sbi
, 
lblk
));

1904 i‡(
¥
 !
NULL
) {

1905 
åì
 = &
	`PXT4_I
(
öode
)->
i_≥ndög_åì
;

1906 
	`rb_îa£
(&
¥
->
rb_node
, &
åì
->
roŸ
);

1907 
	`kmem_ˇche_‰ì
(
pxt4_≥ndög_ˇchï
, 
¥
);

1909 
	}
}

1920 
	$pxt4_ªmove_≥ndög
(
öode
 *öode, 
pxt4_lblk_t
 
lblk
)

1922 
pxt4_öode_öfo
 *
ei
 = 
	`PXT4_I
(
öode
);

1924 
	`wrôe_lock
(&
ei
->
i_es_lock
);

1925 
	`__ªmove_≥ndög
(
öode
, 
lblk
);

1926 
	`wrôe_u∆ock
(&
ei
->
i_es_lock
);

1927 
	}
}

1939 
boﬁ
 
	$pxt4_is_≥ndög
(
öode
 *öode, 
pxt4_lblk_t
 
lblk
)

1941 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
öode
->
i_sb
);

1942 
pxt4_öode_öfo
 *
ei
 = 
	`PXT4_I
(
öode
);

1943 
boﬁ
 
ªt
;

1945 
	`ªad_lock
(&
ei
->
i_es_lock
);

1946 
ªt
 = (
boﬁ
)(
	`__gë_≥ndög
(
öode
, 
	`PXT4_B2C
(
sbi
, 
lblk
)Ë!
NULL
);

1947 
	`ªad_u∆ock
(&
ei
->
i_es_lock
);

1949  
ªt
;

1950 
	}
}

1964 
	$pxt4_es_ö£π_dñayed_block
(
öode
 *öode, 
pxt4_lblk_t
 
lblk
,

1965 
boﬁ
 
Æloˇãd
)

1967 
exã¡_°©us
 
√wes
;

1968 
îr
 = 0;

1970 
	`es_debug
("add [%u/1) delayedÅoÉxtent statusÅree of inode %lu\n",

1971 
lblk
, 
öode
->
i_öo
);

1973 
√wes
.
es_lblk
 = 
lblk
;

1974 
√wes
.
es_Àn
 = 1;

1975 
	`pxt4_es_°‹e_pblock_°©us
(&
√wes
, ~0, 
EXTENT_STATUS_DELAYED
);

1976 
	`åa˚_pxt4_es_ö£π_dñayed_block
(
öode
, &
√wes
, 
Æloˇãd
);

1978 
	`pxt4_es_ö£π_exã¡_check
(
öode
, &
√wes
);

1980 
	`wrôe_lock
(&
	`PXT4_I
(
öode
)->
i_es_lock
);

1982 
îr
 = 
	`__es_ªmove_exã¡
(
öode
, 
lblk
,Üblk, 
NULL
);

1983 i‡(
îr
 != 0)

1984 
îr‹
;

1985 
ªåy
:

1986 
îr
 = 
	`__es_ö£π_exã¡
(
öode
, &
√wes
);

1987 i‡(
îr
 =-
ENOMEM
 && 
	`__es_shrök
(
	`PXT4_SB
(
öode
->
i_sb
),

1988 128, 
	`PXT4_I
(
öode
)))

1989 
ªåy
;

1990 i‡(
îr
 != 0)

1991 
îr‹
;

1993 i‡(
Æloˇãd
)

1994 
	`__ö£π_≥ndög
(
öode
, 
lblk
);

1996 
îr‹
:

1997 
	`wrôe_u∆ock
(&
	`PXT4_I
(
öode
)->
i_es_lock
);

1999 
	`pxt4_es_¥öt_åì
(
öode
);

2000 
	`pxt4_¥öt_≥ndög_åì
(
öode
);

2002  
îr
;

2003 
	}
}

2018 
	$__es_dñayed_˛u
(
öode
 *öode, 
pxt4_lblk_t
 
°¨t
,

2019 
pxt4_lblk_t
 
íd
)

2021 
pxt4_es_åì
 *
åì
 = &
	`PXT4_I
(
öode
)->
i_es_åì
;

2022 
exã¡_°©us
 *
es
;

2023 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
öode
->
i_sb
);

2024 
rb_node
 *
node
;

2025 
pxt4_lblk_t
 
fú°_l˛u
, 
œ°_l˛u
;

2026 
œ°_cou¡ed_l˛u
;

2027 
n
 = 0;

2030 
œ°_cou¡ed_l˛u
 = ~0ULL;

2032 
es
 = 
	`__es_åì_£¨ch
(&
åì
->
roŸ
, 
°¨t
);

2034 
es
 && (es->
es_lblk
 <
íd
)) {

2035 i‡(
	`pxt4_es_is_dñ⁄ly
(
es
)) {

2036 i‡(
es
->
es_lblk
 <
°¨t
)

2037 
fú°_l˛u
 = 
	`PXT4_B2C
(
sbi
, 
°¨t
);

2039 
fú°_l˛u
 = 
	`PXT4_B2C
(
sbi
, 
es
->
es_lblk
);

2041 i‡(
	`pxt4_es_íd
(
es
Ë>
íd
)

2042 
œ°_l˛u
 = 
	`PXT4_B2C
(
sbi
, 
íd
);

2044 
œ°_l˛u
 = 
	`PXT4_B2C
(
sbi
, 
	`pxt4_es_íd
(
es
));

2046 i‡(
fú°_l˛u
 =
œ°_cou¡ed_l˛u
)

2047 
n
 +
œ°_l˛u
 - 
fú°_l˛u
;

2049 
n
 +
œ°_l˛u
 - 
fú°_l˛u
 + 1;

2050 
œ°_cou¡ed_l˛u
 = 
œ°_l˛u
;

2052 
node
 = 
	`rb_√xt
(&
es
->
rb_node
);

2053 i‡(!
node
)

2055 
es
 = 
	`rb_íåy
(
node
, 
exã¡_°©us
, 
rb_node
);

2058  
n
;

2059 
	}
}

2071 
	$pxt4_es_dñayed_˛u
(
öode
 *öode, 
pxt4_lblk_t
 
lblk
,

2072 
pxt4_lblk_t
 
Àn
)

2074 
pxt4_öode_öfo
 *
ei
 = 
	`PXT4_I
(
öode
);

2075 
pxt4_lblk_t
 
íd
;

2076 
n
;

2078 i‡(
Àn
 == 0)

2081 
íd
 = 
lblk
 + 
Àn
 - 1;

2082 
	`WARN_ON
(
íd
 < 
lblk
);

2084 
	`ªad_lock
(&
ei
->
i_es_lock
);

2086 
n
 = 
	`__es_dñayed_˛u
(
öode
, 
lblk
, 
íd
);

2088 
	`ªad_u∆ock
(&
ei
->
i_es_lock
);

2090  
n
;

2091 
	}
}

2108 
	$__ªvi£_≥ndög
(
öode
 *öode, 
pxt4_lblk_t
 
lblk
,

2109 
pxt4_lblk_t
 
Àn
)

2111 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
öode
->
i_sb
);

2112 
pxt4_lblk_t
 
íd
 = 
lblk
 + 
Àn
 - 1;

2113 
pxt4_lblk_t
 
fú°
, 
œ°
;

2114 
boﬁ
 
f_dñ
 = 
Ál£
, 
l_dñ
 = false;

2116 i‡(
Àn
 == 0)

2132 i‡(
	`PXT4_B2C
(
sbi
, 
lblk
Ë=PXT4_B2C(sbi, 
íd
)) {

2133 
fú°
 = 
	`PXT4_LBLK_CMASK
(
sbi
, 
lblk
);

2134 i‡(
fú°
 !
lblk
)

2135 
f_dñ
 = 
	`__es_sˇn_ønge
(
öode
, &
pxt4_es_is_dñ⁄ly
,

2136 
fú°
, 
lblk
 - 1);

2137 i‡(
f_dñ
) {

2138 
	`__ö£π_≥ndög
(
öode
, 
fú°
);

2140 
œ°
 = 
	`PXT4_LBLK_CMASK
(
sbi
, 
íd
) +

2141 
sbi
->
s_˛u°î_øtio
 - 1;

2142 i‡(
œ°
 !
íd
)

2143 
l_dñ
 = 
	`__es_sˇn_ønge
(
öode
,

2144 &
pxt4_es_is_dñ⁄ly
,

2145 
íd
 + 1, 
œ°
);

2146 i‡(
l_dñ
)

2147 
	`__ö£π_≥ndög
(
öode
, 
œ°
);

2149 
	`__ªmove_≥ndög
(
öode
, 
œ°
);

2152 
fú°
 = 
	`PXT4_LBLK_CMASK
(
sbi
, 
lblk
);

2153 i‡(
fú°
 !
lblk
)

2154 
f_dñ
 = 
	`__es_sˇn_ønge
(
öode
, &
pxt4_es_is_dñ⁄ly
,

2155 
fú°
, 
lblk
 - 1);

2156 i‡(
f_dñ
)

2157 
	`__ö£π_≥ndög
(
öode
, 
fú°
);

2159 
	`__ªmove_≥ndög
(
öode
, 
fú°
);

2161 
œ°
 = 
	`PXT4_LBLK_CMASK
(
sbi
, 
íd
Ë+ sbi->
s_˛u°î_øtio
 - 1;

2162 i‡(
œ°
 !
íd
)

2163 
l_dñ
 = 
	`__es_sˇn_ønge
(
öode
, &
pxt4_es_is_dñ⁄ly
,

2164 
íd
 + 1, 
œ°
);

2165 i‡(
l_dñ
)

2166 
	`__ö£π_≥ndög
(
öode
, 
œ°
);

2168 
	`__ªmove_≥ndög
(
öode
, 
œ°
);

2170 
	}
}

	@extents_status.h

12 #i‚de‡
_PXT4_EXTENTS_STATUS_H


13 
	#_PXT4_EXTENTS_STATUS_H


	)

18 #ifde‡
ES_DEBUG__


19 
	#es_debug
(
fmt
, ...Ë
	`¥ötk
(fmt, ##
__VA_ARGS__
)

	)

21 
	#es_debug
(
fmt
, ...Ë
	`no_¥ötk
(fmt, ##
__VA_ARGS__
)

	)

28 
	#ES_AGGRESSIVE_TEST__


	)

34 
	mES_WRITTEN_B
,

35 
	mES_UNWRITTEN_B
,

36 
	mES_DELAYED_B
,

37 
	mES_HOLE_B
,

38 
	mES_REFERENCED_B
,

39 
	mES_FLAGS


42 
	#ES_SHIFT
 ((
pxt4_fsblk_t
)*8 - 
ES_FLAGS
)

	)

43 
	#ES_MASK
 (~((
pxt4_fsblk_t
)0Ë<< 
ES_SHIFT
)

	)

45 
	#EXTENT_STATUS_WRITTEN
 (1 << 
ES_WRITTEN_B
)

	)

46 
	#EXTENT_STATUS_UNWRITTEN
 (1 << 
ES_UNWRITTEN_B
)

	)

47 
	#EXTENT_STATUS_DELAYED
 (1 << 
ES_DELAYED_B
)

	)

48 
	#EXTENT_STATUS_HOLE
 (1 << 
ES_HOLE_B
)

	)

49 
	#EXTENT_STATUS_REFERENCED
 (1 << 
ES_REFERENCED_B
)

	)

51 
	#ES_TYPE_MASK
 ((
pxt4_fsblk_t
)(
EXTENT_STATUS_WRITTEN
 | \

52 
EXTENT_STATUS_UNWRITTEN
 | \

53 
EXTENT_STATUS_DELAYED
 | \

54 
EXTENT_STATUS_HOLE
Ë<< 
ES_SHIFT
)

	)

56 
	gpxt4_sb_öfo
;

57 
	gpxt4_exã¡
;

59 
	sexã¡_°©us
 {

60 
rb_node
 
	mrb_node
;

61 
pxt4_lblk_t
 
	mes_lblk
;

62 
pxt4_lblk_t
 
	mes_Àn
;

63 
pxt4_fsblk_t
 
	mes_pblk
;

66 
	spxt4_es_åì
 {

67 
rb_roŸ
 
	mroŸ
;

68 
exã¡_°©us
 *
	mˇche_es
;

71 
	spxt4_es_°©s
 {

72 
	mes_°©s_shrunk
;

73 
≥r˝u_cou¡î
 
	mes_°©s_ˇche_hôs
;

74 
≥r˝u_cou¡î
 
	mes_°©s_ˇche_mis£s
;

75 
u64
 
	mes_°©s_sˇn_time
;

76 
u64
 
	mes_°©s_max_sˇn_time
;

77 
≥r˝u_cou¡î
 
	mes_°©s_Æl_˙t
;

78 
≥r˝u_cou¡î
 
	mes_°©s_shk_˙t
;

117 
	s≥ndög_ª£rv©i⁄
 {

118 
rb_node
 
	mrb_node
;

119 
pxt4_lblk_t
 
	ml˛u
;

122 
	spxt4_≥ndög_åì
 {

123 
rb_roŸ
 
	mroŸ
;

126 
__öô
 
pxt4_öô_es
();

127 
pxt4_exô_es
();

128 
pxt4_es_öô_åì
(
pxt4_es_åì
 *
åì
);

130 
pxt4_es_ö£π_exã¡
(
öode
 *öode, 
pxt4_lblk_t
 
lblk
,

131 
pxt4_lblk_t
 
Àn
, 
pxt4_fsblk_t
 
pblk
,

132 
°©us
);

133 
pxt4_es_ˇche_exã¡
(
öode
 *öode, 
pxt4_lblk_t
 
lblk
,

134 
pxt4_lblk_t
 
Àn
, 
pxt4_fsblk_t
 
pblk
,

135 
°©us
);

136 
pxt4_es_ªmove_exã¡
(
öode
 *öode, 
pxt4_lblk_t
 
lblk
,

137 
pxt4_lblk_t
 
Àn
);

138 
pxt4_es_föd_exã¡_ønge
(
öode
 *inode,

139 (*
m©ch_‚
)(
exã¡_°©us
 *
es
),

140 
pxt4_lblk_t
 
lblk
,Öxt4_lblk_à
íd
,

141 
exã¡_°©us
 *
es
);

142 
	`pxt4_es_lookup_exã¡
(
öode
 *öode, 
pxt4_lblk_t
 
lblk
,

143 
pxt4_lblk_t
 *
√xt_lblk
,

144 
exã¡_°©us
 *
es
);

145 
boﬁ
 
	`pxt4_es_sˇn_ønge
(
öode
 *inode,

146 (*
m©chög_‚
)(
exã¡_°©us
 *
es
),

147 
pxt4_lblk_t
 
lblk
,Öxt4_lblk_à
íd
);

148 
boﬁ
 
	`pxt4_es_sˇn_˛u
(
öode
 *inode,

149 (*
m©chög_‚
)(
exã¡_°©us
 *
es
),

150 
pxt4_lblk_t
 
lblk
);

152 
ölöe
 
	$pxt4_es_°©us
(
exã¡_°©us
 *
es
)

154  
es
->
es_pblk
 >> 
ES_SHIFT
;

155 
	}
}

157 
ölöe
 
	$pxt4_es_ty≥
(
exã¡_°©us
 *
es
)

159  (
es
->
es_pblk
 & 
ES_TYPE_MASK
Ë>> 
ES_SHIFT
;

160 
	}
}

162 
ölöe
 
	$pxt4_es_is_wrôãn
(
exã¡_°©us
 *
es
)

164  (
	`pxt4_es_ty≥
(
es
Ë& 
EXTENT_STATUS_WRITTEN
) != 0;

165 
	}
}

167 
ölöe
 
	$pxt4_es_is_unwrôãn
(
exã¡_°©us
 *
es
)

169  (
	`pxt4_es_ty≥
(
es
Ë& 
EXTENT_STATUS_UNWRITTEN
) != 0;

170 
	}
}

172 
ölöe
 
	$pxt4_es_is_dñayed
(
exã¡_°©us
 *
es
)

174  (
	`pxt4_es_ty≥
(
es
Ë& 
EXTENT_STATUS_DELAYED
) != 0;

175 
	}
}

177 
ölöe
 
	$pxt4_es_is_hﬁe
(
exã¡_°©us
 *
es
)

179  (
	`pxt4_es_ty≥
(
es
Ë& 
EXTENT_STATUS_HOLE
) != 0;

180 
	}
}

182 
ölöe
 
	$pxt4_es_is_m≠≥d
(
exã¡_°©us
 *
es
)

184  (
	`pxt4_es_is_wrôãn
(
es
Ë|| 
	`pxt4_es_is_unwrôãn
(es));

185 
	}
}

187 
ölöe
 
	$pxt4_es_is_dñ⁄ly
(
exã¡_°©us
 *
es
)

189  (
	`pxt4_es_is_dñayed
(
es
Ë&& !
	`pxt4_es_is_unwrôãn
(es));

190 
	}
}

192 
ölöe
 
	$pxt4_es_£t_ª„ªn˚d
(
exã¡_°©us
 *
es
)

194 
es
->
es_pblk
 |((
pxt4_fsblk_t
)
EXTENT_STATUS_REFERENCED
Ë<< 
ES_SHIFT
;

195 
	}
}

197 
ölöe
 
	$pxt4_es_˛ór_ª„ªn˚d
(
exã¡_°©us
 *
es
)

199 
es
->
es_pblk
 &~(((
pxt4_fsblk_t
)
EXTENT_STATUS_REFERENCED
Ë<< 
ES_SHIFT
);

200 
	}
}

202 
ölöe
 
	$pxt4_es_is_ª„ªn˚d
(
exã¡_°©us
 *
es
)

204  (
	`pxt4_es_°©us
(
es
Ë& 
EXTENT_STATUS_REFERENCED
) != 0;

205 
	}
}

207 
ölöe
 
pxt4_fsblk_t
 
	$pxt4_es_pblock
(
exã¡_°©us
 *
es
)

209  
es
->
es_pblk
 & ~
ES_MASK
;

210 
	}
}

212 
ölöe
 
	$pxt4_es_°‹e_pblock
(
exã¡_°©us
 *
es
,

213 
pxt4_fsblk_t
 
pb
)

215 
pxt4_fsblk_t
 
block
;

217 
block
 = (
pb
 & ~
ES_MASK
Ë| (
es
->
es_pblk
 & ES_MASK);

218 
es
->
es_pblk
 = 
block
;

219 
	}
}

221 
ölöe
 
	$pxt4_es_°‹e_°©us
(
exã¡_°©us
 *
es
,

222 
°©us
)

224 
es
->
es_pblk
 = (((
pxt4_fsblk_t
)
°©us
 << 
ES_SHIFT
Ë& 
ES_MASK
) |

225 (
es
->
es_pblk
 & ~
ES_MASK
);

226 
	}
}

228 
ölöe
 
	$pxt4_es_°‹e_pblock_°©us
(
exã¡_°©us
 *
es
,

229 
pxt4_fsblk_t
 
pb
,

230 
°©us
)

232 
es
->
es_pblk
 = (((
pxt4_fsblk_t
)
°©us
 << 
ES_SHIFT
Ë& 
ES_MASK
) |

233 (
pb
 & ~
ES_MASK
);

234 
	}
}

236 
pxt4_es_ªgi°î_shrökî
(
pxt4_sb_öfo
 *
sbi
);

237 
pxt4_es_uƒegi°î_shrökî
(
pxt4_sb_öfo
 *
sbi
);

239 
pxt4_£q_es_shrökî_öfo_show
(
£q_fûe
 *
£q
, *
v
);

241 
__öô
 
pxt4_öô_≥ndög
();

242 
pxt4_exô_≥ndög
();

243 
pxt4_öô_≥ndög_åì
(
pxt4_≥ndög_åì
 *
åì
);

244 
pxt4_ªmove_≥ndög
(
öode
 *öode, 
pxt4_lblk_t
 
lblk
);

245 
boﬁ
 
pxt4_is_≥ndög
(
öode
 *öode, 
pxt4_lblk_t
 
lblk
);

246 
pxt4_es_ö£π_dñayed_block
(
öode
 *öode, 
pxt4_lblk_t
 
lblk
,

247 
boﬁ
 
Æloˇãd
);

248 
pxt4_es_dñayed_˛u
(
öode
 *öode, 
pxt4_lblk_t
 
lblk
,

249 
pxt4_lblk_t
 
Àn
);

250 
pxt4_˛ór_öode_es
(
öode
 *inode);

	@file.c

22 
	~<löux/time.h
>

23 
	~<löux/fs.h
>

24 
	~<löux/iom≠.h
>

25 
	~<löux/mou¡.h
>

26 
	~<löux/∑th.h
>

27 
	~<löux/dax.h
>

28 
	~<löux/quŸa›s.h
>

29 
	~<löux/∑gevec.h
>

30 
	~<löux/uio.h
>

31 
	~<löux/mm™.h
>

32 
	~"pxt4.h
"

33 
	~"pxt4_jbd3.h
"

34 
	~"x©å.h
"

35 
	~"a˛.h
"

37 #ifde‡
CONFIG_FS_DAX


38 
ssize_t
 
	$pxt4_dax_ªad_ôî
(
kiocb
 *
iocb
, 
iov_ôî
 *
to
)

40 
öode
 *öodê
	`fûe_öode
(
iocb
->
ki_fûp
);

41 
ssize_t
 
ªt
;

43 i‡(
iocb
->
ki_Êags
 & 
IOCB_NOWAIT
) {

44 i‡(!
	`öode_åylock_sh¨ed
(
öode
))

45  -
EAGAIN
;

47 
	`öode_lock_sh¨ed
(
öode
);

53 i‡(!
	`IS_DAX
(
öode
)) {

54 
	`öode_u∆ock_sh¨ed
(
öode
);

56  
	`gíîic_fûe_ªad_ôî
(
iocb
, 
to
);

58 
ªt
 = 
	`dax_iom≠_rw
(
iocb
, 
to
, &
pxt4_iom≠_›s
);

59 
	`öode_u∆ock_sh¨ed
(
öode
);

61 
	`fûe_ac˚s£d
(
iocb
->
ki_fûp
);

62  
ªt
;

63 
	}
}

66 
ssize_t
 
	$pxt4_fûe_ªad_ôî
(
kiocb
 *
iocb
, 
iov_ôî
 *
to
)

68 i‡(
	`u∆ikñy
(
	`pxt4_f‹˚d_shutdown
(
	`PXT4_SB
(
	`fûe_öode
(
iocb
->
ki_fûp
)->
i_sb
))))

69  -
EIO
;

71 i‡(!
	`iov_ôî_cou¡
(
to
))

74 #ifde‡
CONFIG_FS_DAX


75 i‡(
	`IS_DAX
(
	`fûe_öode
(
iocb
->
ki_fûp
)))

76  
	`pxt4_dax_ªad_ôî
(
iocb
, 
to
);

78  
	`gíîic_fûe_ªad_ôî
(
iocb
, 
to
);

79 
	}
}

86 
	$pxt4_ªÀa£_fûe
(
öode
 *öode, 
fûe
 *
fûp
)

88 i‡(
	`pxt4_ã°_öode_°©e
(
öode
, 
PXT4_STATE_DA_ALLOC_CLOSE
)) {

89 
	`pxt4_Æloc_da_blocks
(
öode
);

90 
	`pxt4_˛ór_öode_°©e
(
öode
, 
PXT4_STATE_DA_ALLOC_CLOSE
);

93 i‡((
fûp
->
f_mode
 & 
FMODE_WRITE
) &&

94 (
	`©omic_ªad
(&
öode
->
i_wrôecou¡
) == 1) &&

95 !
	`PXT4_I
(
öode
)->
i_ª£rved_d©a_blocks
)

97 
	`down_wrôe
(&
	`PXT4_I
(
öode
)->
i_d©a_£m
);

98 
	`pxt4_disˇrd_¥óŒoˇti⁄s
(
öode
);

99 
	`up_wrôe
(&
	`PXT4_I
(
öode
)->
i_d©a_£m
);

101 i‡(
	`is_dx
(
öode
Ë&& 
fûp
->
¥iv©e_d©a
)

102 
	`pxt4_håì_‰ì_dú_öfo
(
fûp
->
¥iv©e_d©a
);

105 
	}
}

107 
	$pxt4_unwrôãn_waô
(
öode
 *inode)

109 
waô_queue_hód_t
 *
wq
 = 
	`pxt4_i€nd_wq
(
öode
);

111 
	`waô_evít
(*
wq
, (
	`©omic_ªad
(&
	`PXT4_I
(
öode
)->
i_unwrôãn
) == 0));

112 
	}
}

124 
	$pxt4_u«lig√d_aio
(
öode
 *öode, 
iov_ôî
 *
‰om
, 
loff_t
 
pos
)

126 
su≥r_block
 *
sb
 = 
öode
->
i_sb
;

127 
blockmask
 = 
sb
->
s_blocksize
 - 1;

129 i‡(
pos
 >
	`ALIGN
(
	`i_size_ªad
(
öode
), 
sb
->
s_blocksize
))

132 i‡((
pos
 | 
	`iov_ôî_Æignmít
(
‰om
)Ë& 
blockmask
)

136 
	}
}

139 
boﬁ
 
	$pxt4_ovîwrôe_io
(
öode
 *öode, 
loff_t
 
pos
,Üoff_à
Àn
)

141 
pxt4_m≠_blocks
 
m≠
;

142 
blkbôs
 = 
öode
->
i_blkbôs
;

143 
îr
, 
blkÀn
;

145 i‡(
pos
 + 
Àn
 > 
	`i_size_ªad
(
öode
))

146  
Ál£
;

148 
m≠
.
m_lblk
 = 
pos
 >> 
blkbôs
;

149 
m≠
.
m_Àn
 = 
	`PXT4_MAX_BLOCKS
(
Àn
, 
pos
, 
blkbôs
);

150 
blkÀn
 = 
m≠
.
m_Àn
;

152 
îr
 = 
	`pxt4_m≠_blocks
(
NULL
, 
öode
, &
m≠
, 0);

158  
îr
 =
blkÀn
 && (
m≠
.
m_Êags
 & 
PXT4_MAP_MAPPED
);

159 
	}
}

161 
ssize_t
 
	$pxt4_wrôe_checks
(
kiocb
 *
iocb
, 
iov_ôî
 *
‰om
)

163 
öode
 *öodê
	`fûe_öode
(
iocb
->
ki_fûp
);

164 
ssize_t
 
ªt
;

166 
ªt
 = 
	`gíîic_wrôe_checks
(
iocb
, 
‰om
);

167 i‡(
ªt
 <= 0)

168  
ªt
;

170 i‡(
	`u∆ikñy
(
	`IS_IMMUTABLE
(
öode
)))

171  -
EPERM
;

177 i‡(!(
	`pxt4_ã°_öode_Êag
(
öode
, 
PXT4_INODE_EXTENTS
))) {

178 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
öode
->
i_sb
);

180 i‡(
iocb
->
ki_pos
 >
sbi
->
s_bôm≠_maxbyãs
)

181  -
EFBIG
;

182 
	`iov_ôî_åunˇã
(
‰om
, 
sbi
->
s_bôm≠_maxbyãs
 - 
iocb
->
ki_pos
);

184  
	`iov_ôî_cou¡
(
‰om
);

185 
	}
}

187 #ifde‡
CONFIG_FS_DAX


188 
ssize_t


189 
	$pxt4_dax_wrôe_ôî
(
kiocb
 *
iocb
, 
iov_ôî
 *
‰om
)

191 
öode
 *öodê
	`fûe_öode
(
iocb
->
ki_fûp
);

192 
ssize_t
 
ªt
;

194 i‡(
iocb
->
ki_Êags
 & 
IOCB_NOWAIT
) {

195 i‡(!
	`öode_åylock
(
öode
))

196  -
EAGAIN
;

198 
	`öode_lock
(
öode
);

200 
ªt
 = 
	`pxt4_wrôe_checks
(
iocb
, 
‰om
);

201 i‡(
ªt
 <= 0)

202 
out
;

203 
ªt
 = 
	`fûe_ªmove_¥ivs
(
iocb
->
ki_fûp
);

204 i‡(
ªt
)

205 
out
;

206 
ªt
 = 
	`fûe_upd©e_time
(
iocb
->
ki_fûp
);

207 i‡(
ªt
)

208 
out
;

210 
ªt
 = 
	`dax_iom≠_rw
(
iocb
, 
‰om
, &
pxt4_iom≠_›s
);

211 
out
:

212 
	`öode_u∆ock
(
öode
);

213 i‡(
ªt
 > 0)

214 
ªt
 = 
	`gíîic_wrôe_sync
(
iocb
,Ñet);

215  
ªt
;

216 
	}
}

219 
ssize_t


220 
	$pxt4_fûe_wrôe_ôî
(
kiocb
 *
iocb
, 
iov_ôî
 *
‰om
)

222 
öode
 *öodê
	`fûe_öode
(
iocb
->
ki_fûp
);

223 
o_dúe˘
 = 
iocb
->
ki_Êags
 & 
IOCB_DIRECT
;

224 
u«lig√d_aio
 = 0;

225 
ovîwrôe
 = 0;

226 
ssize_t
 
ªt
;

228 i‡(
	`u∆ikñy
(
	`pxt4_f‹˚d_shutdown
(
	`PXT4_SB
(
öode
->
i_sb
))))

229  -
EIO
;

231 #ifde‡
CONFIG_FS_DAX


232 i‡(
	`IS_DAX
(
öode
))

233  
	`pxt4_dax_wrôe_ôî
(
iocb
, 
‰om
);

236 i‡(!
	`öode_åylock
(
öode
)) {

237 i‡(
iocb
->
ki_Êags
 & 
IOCB_NOWAIT
)

238  -
EAGAIN
;

239 
	`öode_lock
(
öode
);

242 
ªt
 = 
	`pxt4_wrôe_checks
(
iocb
, 
‰om
);

243 i‡(
ªt
 <= 0)

244 
out
;

251 i‡(
o_dúe˘
 && 
	`pxt4_ã°_öode_Êag
(
öode
, 
PXT4_INODE_EXTENTS
) &&

252 !
	`is_sync_kiocb
(
iocb
) &&

253 
	`pxt4_u«lig√d_aio
(
öode
, 
‰om
, 
iocb
->
ki_pos
)) {

254 
u«lig√d_aio
 = 1;

255 
	`pxt4_unwrôãn_waô
(
öode
);

258 
iocb
->
¥iv©e
 = &
ovîwrôe
;

260 i‡(
o_dúe˘
 && !
u«lig√d_aio
) {

261 i‡(
	`pxt4_ovîwrôe_io
(
öode
, 
iocb
->
ki_pos
, 
	`iov_ôî_cou¡
(
‰om
))) {

262 i‡(
	`pxt4_should_di‹ód_nﬁock
(
öode
))

263 
ovîwrôe
 = 1;

264 } i‡(
iocb
->
ki_Êags
 & 
IOCB_NOWAIT
) {

265 
ªt
 = -
EAGAIN
;

266 
out
;

270 
ªt
 = 
	`__gíîic_fûe_wrôe_ôî
(
iocb
, 
‰om
);

276 i‡(
ªt
 =-
EIOCBQUEUED
 && 
u«lig√d_aio
)

277 
	`pxt4_unwrôãn_waô
(
öode
);

278 
	`öode_u∆ock
(
öode
);

280 i‡(
ªt
 > 0)

281 
ªt
 = 
	`gíîic_wrôe_sync
(
iocb
,Ñet);

283  
ªt
;

285 
out
:

286 
	`öode_u∆ock
(
öode
);

287  
ªt
;

288 
	}
}

290 #ifde‡
CONFIG_FS_DAX


291 
vm_Áu…_t
 
	$pxt4_dax_huge_Áu…
(
vm_Áu…
 *
vmf
,

292 
∑ge_íåy_size
 
≥_size
)

294 
îr‹
 = 0;

295 
vm_Áu…_t
 
ªsu…
;

296 
ªåõs
 = 0;

297 
h™dÀ_t
 *
h™dÀ
 = 
NULL
;

298 
öode
 *öodê
	`fûe_öode
(
vmf
->
vma
->
vm_fûe
);

299 
su≥r_block
 *
sb
 = 
öode
->
i_sb
;

312 
boﬁ
 
wrôe
 = (
vmf
->
Êags
 & 
FAULT_FLAG_WRITE
) &&

313 (
vmf
->
vma
->
vm_Êags
 & 
VM_SHARED
);

314 
p‚_t
 
p‚
;

316 i‡(
wrôe
) {

317 
	`sb_°¨t_∑geÁu…
(
sb
);

318 
	`fûe_upd©e_time
(
vmf
->
vma
->
vm_fûe
);

319 
	`down_ªad
(&
	`PXT4_I
(
öode
)->
i_mm≠_£m
);

320 
ªåy
:

321 
h™dÀ
 = 
	`pxt4_jou∫Æ_°¨t_sb
(
sb
, 
PXT4_HT_WRITE_PAGE
,

322 
	`PXT4_DATA_TRANS_BLOCKS
(
sb
));

323 i‡(
	`IS_ERR
(
h™dÀ
)) {

324 
	`up_ªad
(&
	`PXT4_I
(
öode
)->
i_mm≠_£m
);

325 
	`sb_íd_∑geÁu…
(
sb
);

326  
VM_FAULT_SIGBUS
;

329 
	`down_ªad
(&
	`PXT4_I
(
öode
)->
i_mm≠_£m
);

331 
ªsu…
 = 
	`dax_iom≠_Áu…
(
vmf
, 
≥_size
, &
p‚
, &
îr‹
, &
pxt4_iom≠_›s
);

332 i‡(
wrôe
) {

333 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

335 i‡((
ªsu…
 & 
VM_FAULT_ERROR
Ë&& 
îr‹
 =-
ENOSPC
 &&

336 
	`pxt4_should_ªåy_Æloc
(
sb
, &
ªåõs
))

337 
ªåy
;

339 i‡(
ªsu…
 & 
VM_FAULT_NEEDDSYNC
)

340 
ªsu…
 = 
	`dax_föish_sync_Áu…
(
vmf
, 
≥_size
, 
p‚
);

341 
	`up_ªad
(&
	`PXT4_I
(
öode
)->
i_mm≠_£m
);

342 
	`sb_íd_∑geÁu…
(
sb
);

344 
	`up_ªad
(&
	`PXT4_I
(
öode
)->
i_mm≠_£m
);

347  
ªsu…
;

348 
	}
}

350 
vm_Áu…_t
 
	$pxt4_dax_Áu…
(
vm_Áu…
 *
vmf
)

352  
	`pxt4_dax_huge_Áu…
(
vmf
, 
PE_SIZE_PTE
);

353 
	}
}

355 c⁄° 
vm_›î©i⁄s_°ru˘
 
	gpxt4_dax_vm_›s
 = {

356 .
Áu…
 = 
pxt4_dax_Áu…
,

357 .
	ghuge_Áu…
 = 
pxt4_dax_huge_Áu…
,

358 .
	g∑ge_mkwrôe
 = 
pxt4_dax_Áu…
,

359 .
	gp‚_mkwrôe
 = 
pxt4_dax_Áu…
,

362 
	#pxt4_dax_vm_›s
 
pxt4_fûe_vm_›s


	)

365 c⁄° 
vm_›î©i⁄s_°ru˘
 
	gpxt4_fûe_vm_›s
 = {

366 .
Áu…
 = 
pxt4_fûem≠_Áu…
,

367 .
	gm≠_∑ges
 = 
fûem≠_m≠_∑ges
,

368 .
	g∑ge_mkwrôe
 = 
pxt4_∑ge_mkwrôe
,

371 
	$pxt4_fûe_mm≠
(
fûe
 *fûe, 
vm_¨ó_°ru˘
 *
vma
)

373 
öode
 *öodê
fûe
->
f_m≠pög
->
ho°
;

374 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
öode
->
i_sb
);

375 
dax_devi˚
 *
dax_dev
 = 
sbi
->
s_daxdev
;

377 i‡(
	`u∆ikñy
(
	`pxt4_f‹˚d_shutdown
(
sbi
)))

378  -
EIO
;

384 i‡(!
	`daxdev_m≠pög_suµ‹ãd
(
vma
, 
dax_dev
))

385  -
EOPNOTSUPP
;

387 
	`fûe_ac˚s£d
(
fûe
);

388 i‡(
	`IS_DAX
(
	`fûe_öode
(
fûe
))) {

389 
vma
->
vm_›s
 = &
pxt4_dax_vm_›s
;

390 
vma
->
vm_Êags
 |
VM_HUGEPAGE
;

392 
vma
->
vm_›s
 = &
pxt4_fûe_vm_›s
;

395 
	}
}

397 
	$pxt4_ßm∂e_œ°_mou¡ed
(
su≥r_block
 *
sb
,

398 
vfsmou¡
 *
m¡
)

400 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
sb
);

401 
∑th
Öath;

402 
buf
[64], *
˝
;

403 
h™dÀ_t
 *
h™dÀ
;

404 
îr
;

406 i‡(
	`likñy
(
sbi
->
s_mou¡_Êags
 & 
PXT4_MF_MNTDIR_SAMPLED
))

409 i‡(
	`sb_rd⁄ly
(
sb
Ë|| !
	`sb_°¨t_ötwrôe_åylock
(sb))

412 
sbi
->
s_mou¡_Êags
 |
PXT4_MF_MNTDIR_SAMPLED
;

419 
	`mem£t
(
buf
, 0, (buf));

420 
∑th
.
m¡
 = mnt;

421 
∑th
.
díåy
 = 
m¡
->
m¡_roŸ
;

422 
˝
 = 
	`d_∑th
(&
∑th
, 
buf
, (buf));

423 
îr
 = 0;

424 i‡(
	`IS_ERR
(
˝
))

425 
out
;

427 
h™dÀ
 = 
	`pxt4_jou∫Æ_°¨t_sb
(
sb
, 
PXT4_HT_MISC
, 1);

428 
îr
 = 
	`PTR_ERR
(
h™dÀ
);

429 i‡(
	`IS_ERR
(
h™dÀ
))

430 
out
;

431 
	`BUFFER_TRACE
(
sbi
->
s_sbh
, "get_write_access");

432 
îr
 = 
	`pxt4_jou∫Æ_gë_wrôe_ac˚ss
(
h™dÀ
, 
sbi
->
s_sbh
);

433 i‡(
îr
)

434 
out_jou∫Æ
;

435 
	`°∫˝y
(
sbi
->
s_es
->
s_œ°_mou¡ed
, 
˝
,

436 (
sbi
->
s_es
->
s_œ°_mou¡ed
));

437 
	`pxt4_h™dÀ_dúty_su≥r
(
h™dÀ
, 
sb
);

438 
out_jou∫Æ
:

439 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

440 
out
:

441 
	`sb_íd_ötwrôe
(
sb
);

442  
îr
;

443 
	}
}

445 
	$pxt4_fûe_›í
(
öode
 * inode, 
fûe
 * 
fûp
)

447 
ªt
;

449 i‡(
	`u∆ikñy
(
	`pxt4_f‹˚d_shutdown
(
	`PXT4_SB
(
öode
->
i_sb
))))

450  -
EIO
;

452 
ªt
 = 
	`pxt4_ßm∂e_œ°_mou¡ed
(
öode
->
i_sb
, 
fûp
->
f_∑th
.
m¡
);

453 i‡(
ªt
)

454  
ªt
;

456 
ªt
 = 
	`fs¸y±_fûe_›í
(
öode
, 
fûp
);

457 i‡(
ªt
)

458  
ªt
;

460 
ªt
 = 
	`fsvîôy_fûe_›í
(
öode
, 
fûp
);

461 i‡(
ªt
)

462  
ªt
;

468 i‡(
fûp
->
f_mode
 & 
FMODE_WRITE
) {

469 
ªt
 = 
	`pxt4_öode_©èch_jöode
(
öode
);

470 i‡(
ªt
 < 0)

471  
ªt
;

474 
fûp
->
f_mode
 |
FMODE_NOWAIT
;

475  
	`dquŸ_fûe_›í
(
öode
, 
fûp
);

476 
	}
}

483 
loff_t
 
	$pxt4_Œ£ek
(
fûe
 *fûe, 
loff_t
 
off£t
, 
whí˚
)

485 
öode
 *öodê
fûe
->
f_m≠pög
->
ho°
;

486 
loff_t
 
maxbyãs
;

488 i‡(!(
	`pxt4_ã°_öode_Êag
(
öode
, 
PXT4_INODE_EXTENTS
)))

489 
maxbyãs
 = 
	`PXT4_SB
(
öode
->
i_sb
)->
s_bôm≠_maxbyãs
;

491 
maxbyãs
 = 
öode
->
i_sb
->
s_maxbyãs
;

493 
whí˚
) {

495  
	`gíîic_fûe_Œ£ek_size
(
fûe
, 
off£t
, 
whí˚
,

496 
maxbyãs
, 
	`i_size_ªad
(
öode
));

497 
SEEK_HOLE
:

498 
	`öode_lock_sh¨ed
(
öode
);

499 
off£t
 = 
	`iom≠_£ek_hﬁe
(
öode
, off£t, &
pxt4_iom≠_›s
);

500 
	`öode_u∆ock_sh¨ed
(
öode
);

502 
SEEK_DATA
:

503 
	`öode_lock_sh¨ed
(
öode
);

504 
off£t
 = 
	`iom≠_£ek_d©a
(
öode
, off£t, &
pxt4_iom≠_›s
);

505 
	`öode_u∆ock_sh¨ed
(
öode
);

509 i‡(
off£t
 < 0)

510  
off£t
;

511  
	`vfs_£ços
(
fûe
, 
off£t
, 
maxbyãs
);

512 
	}
}

514 c⁄° 
fûe_›î©i⁄s
 
	gpxt4_fûe_›î©i⁄s
 = {

515 .
Œ£ek
 = 
pxt4_Œ£ek
,

516 .
	gªad_ôî
 = 
pxt4_fûe_ªad_ôî
,

517 .
	gwrôe_ôî
 = 
pxt4_fûe_wrôe_ôî
,

518 .
	gu∆ocked_io˘l
 = 
pxt4_io˘l
,

519 #ifde‡
CONFIG_COMPAT


520 .
	gcom∑t_io˘l
 = 
pxt4_com∑t_io˘l
,

522 .
	gmm≠
 = 
pxt4_fûe_mm≠
,

523 .
	gmm≠_suµ‹ãd_Êags
 = 
MAP_SYNC
,

524 .
	g›í
 = 
pxt4_fûe_›í
,

525 .
	gªÀa£
 = 
pxt4_ªÀa£_fûe
,

526 .
	gfsync
 = 
pxt4_sync_fûe
,

527 .
	ggë_unm≠≥d_¨ó
 = 
thp_gë_unm≠≥d_¨ó
,

528 .
	g•li˚_ªad
 = 
gíîic_fûe_•li˚_ªad
,

529 .
	g•li˚_wrôe
 = 
ôî_fûe_•li˚_wrôe
,

530 .
	gÁŒoˇã
 = 
pxt4_ÁŒoˇã
,

533 c⁄° 
öode_›î©i⁄s
 
	gpxt4_fûe_öode_›î©i⁄s
 = {

534 .
£èâr
 = 
pxt4_£èâr
,

535 .
	ggë©å
 = 
pxt4_fûe_gë©å
,

536 .
	gli°x©å
 = 
pxt4_li°x©å
,

537 .
	ggë_a˛
 = 
pxt4_gë_a˛
,

538 .
	g£t_a˛
 = 
pxt4_£t_a˛
,

539 .
	gfõm≠
 = 
pxt4_fõm≠
,

	@fsmap.c

7 
	~"pxt4.h
"

8 
	~<löux/fsm≠.h
>

9 
	~"fsm≠.h
"

10 
	~"mbÆloc.h
"

11 
	~<löux/s‹t.h
>

12 
	~<löux/li°_s‹t.h
>

13 
	~<åa˚/evíts/pxt4.h
>

16 
	$pxt4_fsm≠_‰om_öã∫Æ
(
su≥r_block
 *
sb
, 
fsm≠
 *
de°
,

17 
pxt4_fsm≠
 *
§c
)

19 
de°
->
fmr_devi˚
 = 
§c
->fmr_device;

20 
de°
->
fmr_Êags
 = 
§c
->fmr_flags;

21 
de°
->
fmr_physiˇl
 = 
§c
->fmr_physiˇ»<< 
sb
->
s_blocksize_bôs
;

22 
de°
->
fmr_ow√r
 = 
§c
->fmr_owner;

23 
de°
->
fmr_off£t
 = 0;

24 
de°
->
fmr_Àngth
 = 
§c
->fmr_Àngth << 
sb
->
s_blocksize_bôs
;

25 
de°
->
fmr_ª£rved
[0] = 0;

26 
de°
->
fmr_ª£rved
[1] = 0;

27 
de°
->
fmr_ª£rved
[2] = 0;

28 
	}
}

31 
	$pxt4_fsm≠_to_öã∫Æ
(
su≥r_block
 *
sb
, 
pxt4_fsm≠
 *
de°
,

32 
fsm≠
 *
§c
)

34 
de°
->
fmr_devi˚
 = 
§c
->fmr_device;

35 
de°
->
fmr_Êags
 = 
§c
->fmr_flags;

36 
de°
->
fmr_physiˇl
 = 
§c
->fmr_physiˇ»>> 
sb
->
s_blocksize_bôs
;

37 
de°
->
fmr_ow√r
 = 
§c
->fmr_owner;

38 
de°
->
fmr_Àngth
 = 
§c
->fmr_Àngth >> 
sb
->
s_blocksize_bôs
;

39 
	}
}

42 
	spxt4_gëfsm≠_öfo
 {

43 
pxt4_fsm≠_hód
 *
	mgfi_hód
;

44 
pxt4_fsm≠_f‹m©_t
 
	mgfi_f‹m©ãr
;

45 *
	mgfi_f‹m©_¨g
;

46 
pxt4_fsblk_t
 
	mgfi_√xt_fsblk
;

47 
u32
 
	mgfi_dev
;

48 
pxt4_group_t
 
	mgfi_agno
;

49 
pxt4_fsm≠
 
	mgfi_low
;

50 
pxt4_fsm≠
 
	mgfi_high
;

51 
pxt4_fsm≠
 
	mgfi_œ°‰ì
;

52 
li°_hód
 
	mgfi_mëa_li°
;

53 
boﬁ
 
	mgfi_œ°
;

57 
	spxt4_gëfsm≠_dev
 {

58 (*
	mgfd_‚
)(
su≥r_block
 *
	msb
,

59 
pxt4_fsm≠
 *
	mkeys
,

60 
pxt4_gëfsm≠_öfo
 *
	möfo
);

61 
u32
 
	mgfd_dev
;

65 
	$pxt4_gëfsm≠_dev_com∑ª
(c⁄° *
p1
, c⁄° *
p2
)

67 c⁄° 
pxt4_gëfsm≠_dev
 *
d1
 = 
p1
;

68 c⁄° 
pxt4_gëfsm≠_dev
 *
d2
 = 
p2
;

70  
d1
->
gfd_dev
 - 
d2
->gfd_dev;

71 
	}
}

74 
boﬁ
 
	$pxt4_gëfsm≠_ªc_bef‹e_low_key
(
pxt4_gëfsm≠_öfo
 *
öfo
,

75 
pxt4_fsm≠
 *
ªc
)

77  
ªc
->
fmr_physiˇl
 < 
öfo
->
gfi_low
.fmr_physical;

78 
	}
}

84 
	$pxt4_gëfsm≠_hñ≥r
(
su≥r_block
 *
sb
,

85 
pxt4_gëfsm≠_öfo
 *
öfo
,

86 
pxt4_fsm≠
 *
ªc
)

88 
pxt4_fsm≠
 
fmr
;

89 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
sb
);

90 
pxt4_fsblk_t
 
ªc_fsblk
 = 
ªc
->
fmr_physiˇl
;

91 
pxt4_group_t
 
agno
;

92 
pxt4_gΩblk_t
 
˙o
;

93 
îr‹
;

95 i‡(
	`Áèl_sig«l_≥ndög
(
cuºít
))

96  -
EINTR
;

102 i‡(
	`pxt4_gëfsm≠_ªc_bef‹e_low_key
(
öfo
, 
ªc
)) {

103 
ªc_fsblk
 +
ªc
->
fmr_Àngth
;

104 i‡(
öfo
->
gfi_√xt_fsblk
 < 
ªc_fsblk
)

105 
öfo
->
gfi_√xt_fsblk
 = 
ªc_fsblk
;

106  
PXT4_QUERY_RANGE_CONTINUE
;

110 i‡(
öfo
->
gfi_hód
->
fmh_cou¡
 == 0) {

111 i‡(
öfo
->
gfi_hód
->
fmh_íåõs
 =
UINT_MAX
)

112  
PXT4_QUERY_RANGE_ABORT
;

114 i‡(
ªc_fsblk
 > 
öfo
->
gfi_√xt_fsblk
)

115 
öfo
->
gfi_hód
->
fmh_íåõs
++;

117 i‡(
öfo
->
gfi_œ°
)

118  
PXT4_QUERY_RANGE_CONTINUE
;

120 
öfo
->
gfi_hód
->
fmh_íåõs
++;

122 
ªc_fsblk
 +
ªc
->
fmr_Àngth
;

123 i‡(
öfo
->
gfi_√xt_fsblk
 < 
ªc_fsblk
)

124 
öfo
->
gfi_√xt_fsblk
 = 
ªc_fsblk
;

125  
PXT4_QUERY_RANGE_CONTINUE
;

133 i‡(
ªc_fsblk
 > 
öfo
->
gfi_√xt_fsblk
) {

134 i‡(
öfo
->
gfi_hód
->
fmh_íåõs
 >öfo->gfi_hód->
fmh_cou¡
)

135  
PXT4_QUERY_RANGE_ABORT
;

137 
	`pxt4_gë_group_no_™d_off£t
(
sb
, 
öfo
->
gfi_√xt_fsblk
,

138 &
agno
, &
˙o
);

139 
	`åa˚_pxt4_fsm≠_m≠pög
(
sb
, 
öfo
->
gfi_dev
, 
agno
,

140 
	`PXT4_C2B
(
sbi
, 
˙o
),

141 
ªc_fsblk
 - 
öfo
->
gfi_√xt_fsblk
,

142 
PXT4_FMR_OWN_UNKNOWN
);

144 
fmr
.
fmr_devi˚
 = 
öfo
->
gfi_dev
;

145 
fmr
.
fmr_physiˇl
 = 
öfo
->
gfi_√xt_fsblk
;

146 
fmr
.
fmr_ow√r
 = 
PXT4_FMR_OWN_UNKNOWN
;

147 
fmr
.
fmr_Àngth
 = 
ªc_fsblk
 - 
öfo
->
gfi_√xt_fsblk
;

148 
fmr
.
fmr_Êags
 = 
FMR_OF_SPECIAL_OWNER
;

149 
îr‹
 = 
öfo
->
	`gfi_f‹m©ãr
(&
fmr
, info->
gfi_f‹m©_¨g
);

150 i‡(
îr‹
)

151  
îr‹
;

152 
öfo
->
gfi_hód
->
fmh_íåõs
++;

155 i‡(
öfo
->
gfi_œ°
)

156 
out
;

159 i‡(
öfo
->
gfi_hód
->
fmh_íåõs
 >öfo->gfi_hód->
fmh_cou¡
)

160  
PXT4_QUERY_RANGE_ABORT
;

162 
	`pxt4_gë_group_no_™d_off£t
(
sb
, 
ªc_fsblk
, &
agno
, &
˙o
);

163 
	`åa˚_pxt4_fsm≠_m≠pög
(
sb
, 
öfo
->
gfi_dev
, 
agno
, 
	`PXT4_C2B
(
sbi
, 
˙o
),

164 
ªc
->
fmr_Àngth
,Ñec->
fmr_ow√r
);

166 
fmr
.
fmr_devi˚
 = 
öfo
->
gfi_dev
;

167 
fmr
.
fmr_physiˇl
 = 
ªc_fsblk
;

168 
fmr
.
fmr_ow√r
 = 
ªc
->fmr_owner;

169 
fmr
.
fmr_Êags
 = 
FMR_OF_SPECIAL_OWNER
;

170 
fmr
.
fmr_Àngth
 = 
ªc
->fmr_length;

171 
îr‹
 = 
öfo
->
	`gfi_f‹m©ãr
(&
fmr
, info->
gfi_f‹m©_¨g
);

172 i‡(
îr‹
)

173  
îr‹
;

174 
öfo
->
gfi_hód
->
fmh_íåõs
++;

176 
out
:

177 
ªc_fsblk
 +
ªc
->
fmr_Àngth
;

178 i‡(
öfo
->
gfi_√xt_fsblk
 < 
ªc_fsblk
)

179 
öfo
->
gfi_√xt_fsblk
 = 
ªc_fsblk
;

180  
PXT4_QUERY_RANGE_CONTINUE
;

181 
	}
}

183 
ölöe
 
pxt4_fsblk_t
 
	$pxt4_fsm≠_√xt_pblk
(
pxt4_fsm≠
 *
fmr
)

185  
fmr
->
fmr_physiˇl
 + fmr->
fmr_Àngth
;

186 
	}
}

189 
	$pxt4_gëfsm≠_d©adev_hñ≥r
(
su≥r_block
 *
sb
,

190 
pxt4_group_t
 
agno
, 
pxt4_gΩblk_t
 
°¨t
,

191 
pxt4_gΩblk_t
 
Àn
, *
¥iv
)

193 
pxt4_fsm≠
 
úec
;

194 
pxt4_gëfsm≠_öfo
 *
öfo
 = 
¥iv
;

195 
pxt4_fsm≠
 *
p
;

196 
pxt4_fsm≠
 *
tmp
;

197 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
sb
);

198 
pxt4_fsblk_t
 
fsb
;

199 
pxt4_fsblk_t
 
f¶í
;

200 
îr‹
;

202 
fsb
 = (
	`PXT4_C2B
(
sbi
, 
°¨t
Ë+ 
	`pxt4_group_fú°_block_no
(
sb
, 
agno
));

203 
f¶í
 = 
	`PXT4_C2B
(
sbi
, 
Àn
);

206 i‡(
öfo
->
gfi_œ°‰ì
.
fmr_ow√r
) {

208 i‡(
	`pxt4_fsm≠_√xt_pblk
(&
öfo
->
gfi_œ°‰ì
Ë=
fsb
) {

209 
öfo
->
gfi_œ°‰ì
.
fmr_Àngth
 +
f¶í
;

217 
îr‹
 = 
	`pxt4_gëfsm≠_hñ≥r
(
sb
, 
öfo
, &öfo->
gfi_œ°‰ì
);

218 i‡(
îr‹
)

219  
îr‹
;

220 
öfo
->
gfi_œ°‰ì
.
fmr_ow√r
 = 0;

224 
	`li°_f‹_óch_íåy_ß„
(
p
, 
tmp
, &
öfo
->
gfi_mëa_li°
, 
fmr_li°
) {

225 i‡(
p
->
fmr_physiˇl
 +Ö->
fmr_Àngth
 <
öfo
->
gfi_√xt_fsblk
) {

226 
	`li°_dñ
(&
p
->
fmr_li°
);

227 
	`k‰ì
(
p
);

228 } i‡(
p
->
fmr_physiˇl
 < 
fsb
) {

229 
îr‹
 = 
	`pxt4_gëfsm≠_hñ≥r
(
sb
, 
öfo
, 
p
);

230 i‡(
îr‹
)

231  
îr‹
;

233 
	`li°_dñ
(&
p
->
fmr_li°
);

234 
	`k‰ì
(
p
);

238 
úec
.
fmr_devi˚
 = 0;

239 
úec
.
fmr_physiˇl
 = 
fsb
;

240 
úec
.
fmr_Àngth
 = 
f¶í
;

241 
úec
.
fmr_ow√r
 = 
PXT4_FMR_OWN_FREE
;

242 
úec
.
fmr_Êags
 = 0;

245 i‡(
	`pxt4_fsm≠_√xt_pblk
(&
úec
) ==

246 
	`pxt4_group_fú°_block_no
(
sb
, 
agno
 + 1)) {

247 
öfo
->
gfi_œ°‰ì
 = 
úec
;

252  
	`pxt4_gëfsm≠_hñ≥r
(
sb
, 
öfo
, &
úec
);

253 
	}
}

256 
	$pxt4_gëfsm≠_logdev
(
su≥r_block
 *
sb
, 
pxt4_fsm≠
 *
keys
,

257 
pxt4_gëfsm≠_öfo
 *
öfo
)

259 
jou∫Æ_t
 *
jou∫Æ
 = 
	`PXT4_SB
(
sb
)->
s_jou∫Æ
;

260 
pxt4_fsm≠
 
úec
;

263 
öfo
->
gfi_low
 = 
keys
[0];

264 
öfo
->
gfi_low
.
fmr_Àngth
 = 0;

266 
	`mem£t
(&
öfo
->
gfi_high
, 0xFF, (info->gfi_high));

268 
	`åa˚_pxt4_fsm≠_low_key
(
sb
, 
öfo
->
gfi_dev
, 0,

269 
öfo
->
gfi_low
.
fmr_physiˇl
,

270 
öfo
->
gfi_low
.
fmr_Àngth
,

271 
öfo
->
gfi_low
.
fmr_ow√r
);

273 
	`åa˚_pxt4_fsm≠_high_key
(
sb
, 
öfo
->
gfi_dev
, 0,

274 
öfo
->
gfi_high
.
fmr_physiˇl
,

275 
öfo
->
gfi_high
.
fmr_Àngth
,

276 
öfo
->
gfi_high
.
fmr_ow√r
);

278 i‡(
keys
[0].
fmr_physiˇl
 > 0)

282 
úec
.
fmr_physiˇl
 = 
jou∫Æ
->
j_blk_off£t
;

283 
úec
.
fmr_Àngth
 = 
jou∫Æ
->
j_maxÀn
;

284 
úec
.
fmr_ow√r
 = 
PXT4_FMR_OWN_LOG
;

285 
úec
.
fmr_Êags
 = 0;

287  
	`pxt4_gëfsm≠_hñ≥r
(
sb
, 
öfo
, &
úec
);

288 
	}
}

291 
ölöe
 
	$pxt4_gëfsm≠_fûl
(
li°_hód
 *
mëa_li°
,

292 
pxt4_fsblk_t
 
fsb
,Öxt4_fsblk_à
Àn
,

293 
uöt64_t
 
ow√r
)

295 
pxt4_fsm≠
 *
fsm
;

297 
fsm
 = 
	`kmÆloc
((*fsm), 
GFP_NOFS
);

298 i‡(!
fsm
)

299  -
ENOMEM
;

300 
fsm
->
fmr_devi˚
 = 0;

301 
fsm
->
fmr_Êags
 = 0;

302 
fsm
->
fmr_physiˇl
 = 
fsb
;

303 
fsm
->
fmr_ow√r
 = 
ow√r
;

304 
fsm
->
fmr_Àngth
 = 
Àn
;

305 
	`li°_add_èû
(&
fsm
->
fmr_li°
, 
mëa_li°
);

308 
	}
}

314 
	$pxt4_gëfsm≠_föd_sb
(
su≥r_block
 *
sb
,

315 
pxt4_group_t
 
agno
,

316 
li°_hód
 *
mëa_li°
)

318 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
sb
);

319 
pxt4_fsblk_t
 
fsb
 = 
	`pxt4_group_fú°_block_no
(
sb
, 
agno
);

320 
pxt4_fsblk_t
 
Àn
;

321 
fú°_mëa_bg
 = 
	`À32_to_˝u
(
sbi
->
s_es
->
s_fú°_mëa_bg
);

322 
mëagroup
 = 
agno
 / 
	`PXT4_DESC_PER_BLOCK
(
sb
);

323 
îr‹
;

326 i‡(
	`pxt4_bg_has_su≥r
(
sb
, 
agno
)) {

327 
îr‹
 = 
	`pxt4_gëfsm≠_fûl
(
mëa_li°
, 
fsb
, 1, 
PXT4_FMR_OWN_FS
);

328 i‡(
îr‹
)

329  
îr‹
;

330 
fsb
++;

334 
Àn
 = 
	`pxt4_bg_num_gdb
(
sb
, 
agno
);

335 i‡(!
Àn
)

337 
îr‹
 = 
	`pxt4_gëfsm≠_fûl
(
mëa_li°
, 
fsb
, 
Àn
,

338 
PXT4_FMR_OWN_GDT
);

339 i‡(
îr‹
)

340  
îr‹
;

341 
fsb
 +
Àn
;

344 i‡(!
	`pxt4_has_„©uª_mëa_bg
(
sb
Ë|| 
mëagroup
 < 
fú°_mëa_bg
) {

345 
Àn
 = 
	`À16_to_˝u
(
sbi
->
s_es
->
s_ª£rved_gdt_blocks
);

346 
îr‹
 = 
	`pxt4_gëfsm≠_fûl
(
mëa_li°
, 
fsb
, 
Àn
,

347 
PXT4_FMR_OWN_RESV_GDT
);

348 i‡(
îr‹
)

349  
îr‹
;

353 
	}
}

356 
	$pxt4_gëfsm≠_com∑ª
(*
¥iv
,

357 
li°_hód
 *
a
,

358 
li°_hód
 *
b
)

360 
pxt4_fsm≠
 *
Á
;

361 
pxt4_fsm≠
 *
fb
;

363 
Á
 = 
	`c⁄èöî_of
(
a
, 
pxt4_fsm≠
, 
fmr_li°
);

364 
fb
 = 
	`c⁄èöî_of
(
b
, 
pxt4_fsm≠
, 
fmr_li°
);

365 i‡(
Á
->
fmr_physiˇl
 < 
fb
->fmr_physical)

367 i‡(
Á
->
fmr_physiˇl
 > 
fb
->fmr_physical)

370 
	}
}

373 
	$pxt4_gëfsm≠_mîge_fixed_mëad©a
(
li°_hód
 *
mëa_li°
)

375 
pxt4_fsm≠
 *
p
;

376 
pxt4_fsm≠
 *
¥ev
 = 
NULL
;

377 
pxt4_fsm≠
 *
tmp
;

379 
	`li°_f‹_óch_íåy_ß„
(
p
, 
tmp
, 
mëa_li°
, 
fmr_li°
) {

380 i‡(!
¥ev
) {

381 
¥ev
 = 
p
;

385 i‡(
¥ev
->
fmr_ow√r
 =
p
->fmr_owner &&

386 
¥ev
->
fmr_physiˇl
 +Öªv->
fmr_Àngth
 =
p
->fmr_physical) {

387 
¥ev
->
fmr_Àngth
 +
p
->fmr_length;

388 
	`li°_dñ
(&
p
->
fmr_li°
);

389 
	`k‰ì
(
p
);

391 
¥ev
 = 
p
;

393 
	}
}

396 
	$pxt4_gëfsm≠_‰ì_fixed_mëad©a
(
li°_hód
 *
mëa_li°
)

398 
pxt4_fsm≠
 *
p
;

399 
pxt4_fsm≠
 *
tmp
;

401 
	`li°_f‹_óch_íåy_ß„
(
p
, 
tmp
, 
mëa_li°
, 
fmr_li°
) {

402 
	`li°_dñ
(&
p
->
fmr_li°
);

403 
	`k‰ì
(
p
);

405 
	}
}

408 
	$pxt4_gëfsm≠_föd_fixed_mëad©a
(
su≥r_block
 *
sb
,

409 
li°_hód
 *
mëa_li°
)

411 
pxt4_group_desc
 *
gdp
;

412 
pxt4_group_t
 
agno
;

413 
îr‹
;

415 
	`INIT_LIST_HEAD
(
mëa_li°
);

418 
agno
 = 0;ágnÿ< 
	`PXT4_SB
(
sb
)->
s_groups_cou¡
;ágno++) {

419 
gdp
 = 
	`pxt4_gë_group_desc
(
sb
, 
agno
, 
NULL
);

420 i‡(!
gdp
) {

421 
îr‹
 = -
EFSCORRUPTED
;

422 
îr
;

426 
îr‹
 = 
	`pxt4_gëfsm≠_föd_sb
(
sb
, 
agno
, 
mëa_li°
);

427 i‡(
îr‹
)

428 
îr
;

431 
îr‹
 = 
	`pxt4_gëfsm≠_fûl
(
mëa_li°
,

432 
	`pxt4_block_bôm≠
(
sb
, 
gdp
), 1,

433 
PXT4_FMR_OWN_BLKBM
);

434 i‡(
îr‹
)

435 
îr
;

438 
îr‹
 = 
	`pxt4_gëfsm≠_fûl
(
mëa_li°
,

439 
	`pxt4_öode_bôm≠
(
sb
, 
gdp
), 1,

440 
PXT4_FMR_OWN_INOBM
);

441 i‡(
îr‹
)

442 
îr
;

445 
îr‹
 = 
	`pxt4_gëfsm≠_fûl
(
mëa_li°
,

446 
	`pxt4_öode_èbÀ
(
sb
, 
gdp
),

447 
	`PXT4_SB
(
sb
)->
s_ôb_≥r_group
,

448 
PXT4_FMR_OWN_INODES
);

449 i‡(
îr‹
)

450 
îr
;

454 
	`li°_s‹t
(
NULL
, 
mëa_li°
, 
pxt4_gëfsm≠_com∑ª
);

457 
	`pxt4_gëfsm≠_mîge_fixed_mëad©a
(
mëa_li°
);

460 
îr
:

461 
	`pxt4_gëfsm≠_‰ì_fixed_mëad©a
(
mëa_li°
);

462  
îr‹
;

463 
	}
}

466 
	$pxt4_gëfsm≠_d©adev
(
su≥r_block
 *
sb
,

467 
pxt4_fsm≠
 *
keys
,

468 
pxt4_gëfsm≠_öfo
 *
öfo
)

470 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
sb
);

471 
pxt4_fsblk_t
 
°¨t_fsb
;

472 
pxt4_fsblk_t
 
íd_fsb
;

473 
pxt4_fsblk_t
 
bofs
;

474 
pxt4_fsblk_t
 
eofs
;

475 
pxt4_group_t
 
°¨t_ag
;

476 
pxt4_group_t
 
íd_ag
;

477 
pxt4_gΩblk_t
 
fú°_˛u°î
;

478 
pxt4_gΩblk_t
 
œ°_˛u°î
;

479 
îr‹
 = 0;

481 
bofs
 = 
	`À32_to_˝u
(
sbi
->
s_es
->
s_fú°_d©a_block
);

482 
eofs
 = 
	`pxt4_blocks_cou¡
(
sbi
->
s_es
);

483 i‡(
keys
[0].
fmr_physiˇl
 >
eofs
)

485 i‡(
keys
[0].
fmr_physiˇl
 < 
bofs
)

486 
keys
[0].
fmr_physiˇl
 = 
bofs
;

487 i‡(
keys
[1].
fmr_physiˇl
 >
eofs
)

488 
keys
[1].
fmr_physiˇl
 = 
eofs
 - 1;

489 
°¨t_fsb
 = 
keys
[0].
fmr_physiˇl
;

490 
íd_fsb
 = 
keys
[1].
fmr_physiˇl
;

493 
	`pxt4_gë_group_no_™d_off£t
(
sb
, 
°¨t_fsb
, &
°¨t_ag
, &
fú°_˛u°î
);

494 
	`pxt4_gë_group_no_™d_off£t
(
sb
, 
íd_fsb
, &
íd_ag
, &
œ°_˛u°î
);

501 
öfo
->
gfi_low
 = 
keys
[0];

502 
öfo
->
gfi_low
.
fmr_physiˇl
 = 
	`PXT4_C2B
(
sbi
, 
fú°_˛u°î
);

503 
öfo
->
gfi_low
.
fmr_Àngth
 = 0;

505 
	`mem£t
(&
öfo
->
gfi_high
, 0xFF, (info->gfi_high));

508 
îr‹
 = 
	`pxt4_gëfsm≠_föd_fixed_mëad©a
(
sb
, &
öfo
->
gfi_mëa_li°
);

509 i‡(
îr‹
)

510 
îr
;

513 
öfo
->
gfi_agno
 = 
°¨t_ag
;

514 
öfo
->
gfi_agno
 <
íd_ag
;

515 
öfo
->
gfi_agno
++) {

520 i‡(
öfo
->
gfi_agno
 =
íd_ag
) {

521 
öfo
->
gfi_high
 = 
keys
[1];

522 
öfo
->
gfi_high
.
fmr_physiˇl
 = 
	`PXT4_C2B
(
sbi
,

523 
œ°_˛u°î
);

524 
öfo
->
gfi_high
.
fmr_Àngth
 = 0;

527 
	`åa˚_pxt4_fsm≠_low_key
(
sb
, 
öfo
->
gfi_dev
, info->
gfi_agno
,

528 
öfo
->
gfi_low
.
fmr_physiˇl
,

529 
öfo
->
gfi_low
.
fmr_Àngth
,

530 
öfo
->
gfi_low
.
fmr_ow√r
);

532 
	`åa˚_pxt4_fsm≠_high_key
(
sb
, 
öfo
->
gfi_dev
, info->
gfi_agno
,

533 
öfo
->
gfi_high
.
fmr_physiˇl
,

534 
öfo
->
gfi_high
.
fmr_Àngth
,

535 
öfo
->
gfi_high
.
fmr_ow√r
);

537 
îr‹
 = 
	`pxt4_mbÆloc_quîy_ønge
(
sb
, 
öfo
->
gfi_agno
,

538 
	`PXT4_B2C
(
sbi
, 
öfo
->
gfi_low
.
fmr_physiˇl
),

539 
	`PXT4_B2C
(
sbi
, 
öfo
->
gfi_high
.
fmr_physiˇl
),

540 
pxt4_gëfsm≠_d©adev_hñ≥r
, 
öfo
);

541 i‡(
îr‹
)

542 
îr
;

548 i‡(
öfo
->
gfi_agno
 =
°¨t_ag
)

549 
	`mem£t
(&
öfo
->
gfi_low
, 0, (info->gfi_low));

553 i‡(
öfo
->
gfi_œ°‰ì
.
fmr_ow√r
) {

554 
îr‹
 = 
	`pxt4_gëfsm≠_hñ≥r
(
sb
, 
öfo
, &öfo->
gfi_œ°‰ì
);

555 i‡(
îr‹
)

556 
îr
;

560 
öfo
->
gfi_œ°
 = 
åue
;

561 
îr‹
 = 
	`pxt4_gëfsm≠_d©adev_hñ≥r
(
sb
, 
íd_ag
, 
œ°_˛u°î
, 0, 
öfo
);

562 i‡(
îr‹
)

563 
îr
;

565 
îr
:

566 
	`pxt4_gëfsm≠_‰ì_fixed_mëad©a
(&
öfo
->
gfi_mëa_li°
);

567  
îr‹
;

568 
	}
}

571 
boﬁ
 
	$pxt4_gëfsm≠_is_vÆid_devi˚
(
su≥r_block
 *
sb
,

572 
pxt4_fsm≠
 *
fm
)

574 i‡(
fm
->
fmr_devi˚
 =0 || fm->fmr_devi˚ =
UINT_MAX
 ||

575 
fm
->
fmr_devi˚
 =
	`√w_ícode_dev
(
sb
->
s_bdev
->
bd_dev
))

576  
åue
;

577 i‡(
	`PXT4_SB
(
sb
)->
jou∫Æ_bdev
 &&

578 
fm
->
fmr_devi˚
 =
	`√w_ícode_dev
(
	`PXT4_SB
(
sb
)->
jou∫Æ_bdev
->
bd_dev
))

579  
åue
;

580  
Ál£
;

581 
	}
}

584 
boﬁ
 
	$pxt4_gëfsm≠_check_keys
(
pxt4_fsm≠
 *
low_key
,

585 
pxt4_fsm≠
 *
high_key
)

587 i‡(
low_key
->
fmr_devi˚
 > 
high_key
->fmr_device)

588  
Ál£
;

589 i‡(
low_key
->
fmr_devi˚
 < 
high_key
->fmr_device)

590  
åue
;

592 i‡(
low_key
->
fmr_physiˇl
 > 
high_key
->fmr_physical)

593  
Ál£
;

594 i‡(
low_key
->
fmr_physiˇl
 < 
high_key
->fmr_physical)

595  
åue
;

597 i‡(
low_key
->
fmr_ow√r
 > 
high_key
->fmr_owner)

598  
Ál£
;

599 i‡(
low_key
->
fmr_ow√r
 < 
high_key
->fmr_owner)

600  
åue
;

602  
Ál£
;

603 
	}
}

605 
	#PXT4_GETFSMAP_DEVS
 2

	)

627 
	$pxt4_gëfsm≠
(
su≥r_block
 *
sb
, 
pxt4_fsm≠_hód
 *
hód
,

628 
pxt4_fsm≠_f‹m©_t
 
f‹m©ãr
, *
¨g
)

630 
pxt4_fsm≠
 
dkeys
[2];

631 
pxt4_gëfsm≠_dev
 
h™dÀrs
[
PXT4_GETFSMAP_DEVS
];

632 
pxt4_gëfsm≠_öfo
 
öfo
 = { 
NULL
 };

633 
i
;

634 
îr‹
 = 0;

636 i‡(
hód
->
fmh_iÊags
 & ~
FMH_IF_VALID
)

637  -
EINVAL
;

638 i‡(!
	`pxt4_gëfsm≠_is_vÆid_devi˚
(
sb
, &
hód
->
fmh_keys
[0]) ||

639 !
	`pxt4_gëfsm≠_is_vÆid_devi˚
(
sb
, &
hód
->
fmh_keys
[1]))

640  -
EINVAL
;

642 
hód
->
fmh_íåõs
 = 0;

645 
	`mem£t
(
h™dÀrs
, 0, (handlers));

646 
h™dÀrs
[0].
gfd_dev
 = 
	`√w_ícode_dev
(
sb
->
s_bdev
->
bd_dev
);

647 
h™dÀrs
[0].
gfd_‚
 = 
pxt4_gëfsm≠_d©adev
;

648 i‡(
	`PXT4_SB
(
sb
)->
jou∫Æ_bdev
) {

649 
h™dÀrs
[1].
gfd_dev
 = 
	`√w_ícode_dev
(

650 
	`PXT4_SB
(
sb
)->
jou∫Æ_bdev
->
bd_dev
);

651 
h™dÀrs
[1].
gfd_‚
 = 
pxt4_gëfsm≠_logdev
;

654 
	`s‹t
(
h™dÀrs
, 
PXT4_GETFSMAP_DEVS
, (
pxt4_gëfsm≠_dev
),

655 
pxt4_gëfsm≠_dev_com∑ª
, 
NULL
);

668 
dkeys
[0] = 
hód
->
fmh_keys
[0];

669 
dkeys
[0].
fmr_physiˇl
 +dkeys[0].
fmr_Àngth
;

670 
dkeys
[0].
fmr_ow√r
 = 0;

671 
dkeys
[0].
fmr_Àngth
 = 0;

672 
	`mem£t
(&
dkeys
[1], 0xFF, (
pxt4_fsm≠
));

674 i‡(!
	`pxt4_gëfsm≠_check_keys
(
dkeys
, &
hód
->
fmh_keys
[1]))

675  -
EINVAL
;

677 
öfo
.
gfi_√xt_fsblk
 = 
hód
->
fmh_keys
[0].
fmr_physiˇl
 +

678 
hód
->
fmh_keys
[0].
fmr_Àngth
;

679 
öfo
.
gfi_f‹m©ãr
 = 
f‹m©ãr
;

680 
öfo
.
gfi_f‹m©_¨g
 = 
¨g
;

681 
öfo
.
gfi_hód
 = 
hód
;

684 
i
 = 0; i < 
PXT4_GETFSMAP_DEVS
; i++) {

686 i‡(!
h™dÀrs
[
i
].
gfd_‚
)

688 i‡(
hód
->
fmh_keys
[0].
fmr_devi˚
 > 
h™dÀrs
[
i
].
gfd_dev
)

690 i‡(
hód
->
fmh_keys
[1].
fmr_devi˚
 < 
h™dÀrs
[
i
].
gfd_dev
)

700 i‡(
h™dÀrs
[
i
].
gfd_dev
 =
hód
->
fmh_keys
[1].
fmr_devi˚
)

701 
dkeys
[1] = 
hód
->
fmh_keys
[1];

702 i‡(
h™dÀrs
[
i
].
gfd_dev
 > 
hód
->
fmh_keys
[0].
fmr_devi˚
)

703 
	`mem£t
(&
dkeys
[0], 0, (
pxt4_fsm≠
));

705 
öfo
.
gfi_dev
 = 
h™dÀrs
[
i
].
gfd_dev
;

706 
öfo
.
gfi_œ°
 = 
Ál£
;

707 
öfo
.
gfi_agno
 = -1;

708 
îr‹
 = 
h™dÀrs
[
i
].
	`gfd_‚
(
sb
, 
dkeys
, &
öfo
);

709 i‡(
îr‹
)

711 
öfo
.
gfi_√xt_fsblk
 = 0;

714 
hód
->
fmh_oÊags
 = 
FMH_OF_DEV_T
;

715  
îr‹
;

716 
	}
}

	@fsmap.h

7 #i‚de‡
__PXT4_FSMAP_H__


8 
	#__PXT4_FSMAP_H__


	)

10 
	gfsm≠
;

13 
	spxt4_fsm≠
 {

14 
li°_hód
 
	mfmr_li°
;

15 
dev_t
 
	mfmr_devi˚
;

16 
uöt32_t
 
	mfmr_Êags
;

17 
uöt64_t
 
	mfmr_physiˇl
;

18 
uöt64_t
 
	mfmr_ow√r
;

19 
uöt64_t
 
	mfmr_Àngth
;

22 
	spxt4_fsm≠_hód
 {

23 
uöt32_t
 
	mfmh_iÊags
;

24 
uöt32_t
 
	mfmh_oÊags
;

25 
	mfmh_cou¡
;

26 
	mfmh_íåõs
;

28 
pxt4_fsm≠
 
	mfmh_keys
[2];

31 
pxt4_fsm≠_‰om_öã∫Æ
(
su≥r_block
 *
sb
, 
fsm≠
 *
de°
,

32 
pxt4_fsm≠
 *
§c
);

33 
pxt4_fsm≠_to_öã∫Æ
(
su≥r_block
 *
sb
, 
pxt4_fsm≠
 *
de°
,

34 
fsm≠
 *
§c
);

37 (*
	tpxt4_fsm≠_f‹m©_t
)(
	tpxt4_fsm≠
 *, *);

39 
	`pxt4_gëfsm≠
(
su≥r_block
 *
sb
, 
pxt4_fsm≠_hód
 *
hód
,

40 
pxt4_fsm≠_f‹m©_t
 
f‹m©ãr
, *
¨g
);

42 
	#PXT4_QUERY_RANGE_ABORT
 1

	)

43 
	#PXT4_QUERY_RANGE_CONTINUE
 0

	)

46 
	#PXT4_FMR_OWN_FREE
 
FMR_OWN_FREE


	)

47 
	#PXT4_FMR_OWN_UNKNOWN
 
FMR_OWN_UNKNOWN


	)

48 
	#PXT4_FMR_OWN_FS
 
	`FMR_OWNER
('X', 1Ë

	)

49 
	#PXT4_FMR_OWN_LOG
 
	`FMR_OWNER
('X', 2Ë

	)

50 
	#PXT4_FMR_OWN_INODES
 
	`FMR_OWNER
('X', 5Ë

	)

51 
	#PXT4_FMR_OWN_GDT
 
	`FMR_OWNER
('f', 1Ë

	)

52 
	#PXT4_FMR_OWN_RESV_GDT
 
	`FMR_OWNER
('f', 2Ë

	)

53 
	#PXT4_FMR_OWN_BLKBM
 
	`FMR_OWNER
('f', 3Ë

	)

54 
	#PXT4_FMR_OWN_INOBM
 
	`FMR_OWNER
('f', 4Ë

	)

	@fsync.c

26 
	~<löux/time.h
>

27 
	~<löux/fs.h
>

28 
	~<löux/sched.h
>

29 
	~<löux/wrôeback.h
>

30 
	~<löux/blkdev.h
>

32 
	~"pxt4.h
"

33 
	~"pxt4_jbd3.h
"

35 
	~<åa˚/evíts/pxt4.h
>

45 
	$pxt4_sync_∑ª¡
(
öode
 *inode)

47 
díåy
 *díåy, *
√xt
;

48 
ªt
 = 0;

50 i‡(!
	`pxt4_ã°_öode_°©e
(
öode
, 
PXT4_STATE_NEWENTRY
))

52 
díåy
 = 
	`d_föd_™y_Æüs
(
öode
);

53 i‡(!
díåy
)

55 
	`pxt4_ã°_öode_°©e
(
öode
, 
PXT4_STATE_NEWENTRY
)) {

56 
	`pxt4_˛ór_öode_°©e
(
öode
, 
PXT4_STATE_NEWENTRY
);

58 
√xt
 = 
	`dgë_∑ª¡
(
díåy
);

59 
	`dput
(
díåy
);

60 
díåy
 = 
√xt
;

61 
öode
 = 
díåy
->
d_öode
;

70 
ªt
 = 
	`sync_m≠pög_buf„rs
(
öode
->
i_m≠pög
);

71 i‡(
ªt
)

73 
ªt
 = 
	`sync_öode_mëad©a
(
öode
, 1);

74 i‡(
ªt
)

77 
	`dput
(
díåy
);

78  
ªt
;

79 
	}
}

93 
	$pxt4_sync_fûe
(
fûe
 *fûe, 
loff_t
 
°¨t
,Üoff_à
íd
, 
d©async
)

95 
öode
 *öodê
fûe
->
f_m≠pög
->
ho°
;

96 
pxt4_öode_öfo
 *
ei
 = 
	`PXT4_I
(
öode
);

97 
jou∫Æ_t
 *
jou∫Æ
 = 
	`PXT4_SB
(
öode
->
i_sb
)->
s_jou∫Æ
;

98 
ªt
 = 0, 
îr
;

99 
tid_t
 
commô_tid
;

100 
boﬁ
 
√eds_b¨rõr
 = 
Ál£
;

102 i‡(
	`u∆ikñy
(
	`pxt4_f‹˚d_shutdown
(
	`PXT4_SB
(
öode
->
i_sb
))))

103  -
EIO
;

105 
	`J_ASSERT
(
	`pxt4_jou∫Æ_cuºít_h™dÀ
(Ë=
NULL
);

107 
	`åa˚_pxt4_sync_fûe_íãr
(
fûe
, 
d©async
);

109 i‡(
	`sb_rd⁄ly
(
öode
->
i_sb
)) {

111 
	`smp_rmb
();

112 i‡(
	`PXT4_SB
(
öode
->
i_sb
)->
s_mou¡_Êags
 & 
PXT4_MF_FS_ABORTED
)

113 
ªt
 = -
EROFS
;

114 
out
;

117 i‡(!
jou∫Æ
) {

118 
ªt
 = 
	`__gíîic_fûe_fsync
(
fûe
, 
°¨t
, 
íd
, 
d©async
);

119 i‡(!
ªt
)

120 
ªt
 = 
	`pxt4_sync_∑ª¡
(
öode
);

121 i‡(
	`ã°_›t
(
öode
->
i_sb
, 
BARRIER
))

122 
issue_Êush
;

123 
out
;

126 
ªt
 = 
	`fûe_wrôe_™d_waô_ønge
(
fûe
, 
°¨t
, 
íd
);

127 i‡(
ªt
)

128  
ªt
;

143 i‡(
	`pxt4_should_jou∫Æ_d©a
(
öode
)) {

144 
ªt
 = 
	`pxt4_f‹˚_commô
(
öode
->
i_sb
);

145 
out
;

148 
commô_tid
 = 
d©async
 ? 
ei
->
i_d©async_tid
 :Éi->
i_sync_tid
;

149 i‡(
jou∫Æ
->
j_Êags
 & 
JBD3_BARRIER
 &&

150 !
	`jbd3_å™s_wûl_£nd_d©a_b¨rõr
(
jou∫Æ
, 
commô_tid
))

151 
√eds_b¨rõr
 = 
åue
;

152 
ªt
 = 
	`jbd3_com∂ëe_å™ß˘i⁄
(
jou∫Æ
, 
commô_tid
);

153 i‡(
√eds_b¨rõr
) {

154 
issue_Êush
:

155 
îr
 = 
	`blkdev_issue_Êush
(
öode
->
i_sb
->
s_bdev
, 
GFP_KERNEL
, 
NULL
);

156 i‡(!
ªt
)

157 
ªt
 = 
îr
;

159 
out
:

160 
îr
 = 
	`fûe_check_™d_adv™˚_wb_îr
(
fûe
);

161 i‡(
ªt
 == 0)

162 
ªt
 = 
îr
;

163 
	`åa˚_pxt4_sync_fûe_exô
(
öode
, 
ªt
);

164  
ªt
;

165 
	}
}

	@hash.c

8 
	~<löux/fs.h
>

9 
	~<löux/unicode.h
>

10 
	~<löux/compûî.h
>

11 
	~<löux/bô›s.h
>

12 
	~"pxt4.h
"

14 
	#DELTA
 0x9E3779B9

	)

16 
	$TEA_å™sf‹m
(
__u32
 
buf
[4], __u32 c⁄° 
ö
[])

18 
__u32
 
sum
 = 0;

19 
__u32
 
b0
 = 
buf
[0], 
b1
 = buf[1];

20 
__u32
 
a
 = 
ö
[0], 
b
 = in[1], 
c
 = in[2], 
d
 = in[3];

21 
n
 = 16;

24 
sum
 +
DELTA
;

25 
b0
 +((
b1
 << 4)+
a
Ë^ (b1+
sum
Ë^ ((b1 >> 5)+
b
);

26 
b1
 +((
b0
 << 4)+
c
Ë^ (b0+
sum
Ë^ ((b0 >> 5)+
d
);

27 } --
n
);

29 
buf
[0] +
b0
;

30 
buf
[1] +
b1
;

31 
	}
}

34 
	#F
(
x
, 
y
, 
z
Ë((zË^ ((xË& ((yË^ (z))))

	)

35 
	#G
(
x
, 
y
, 
z
Ë(((xË& (y)Ë+ (((xË^ (y)Ë& (z)))

	)

36 
	#H
(
x
, 
y
, 
z
Ë((xË^ (yË^ (z))

	)

44 
	#ROUND
(
f
, 
a
, 
b
, 
c
, 
d
, 
x
, 
s
) \

45 (
a
 +
	`f
(
b
, 
c
, 
d
Ë+ 
x
,á = 
	`rﬁ32
◊, 
s
))

	)

46 
	#K1
 0

	)

47 
	#K2
 013240474631UL

	)

48 
	#K3
 015666365641UL

	)

53 
__u32
 
	$hÆf_md4_å™sf‹m
(
__u32
 
buf
[4], __u32 c⁄° 
ö
[8])

55 
__u32
 
a
 = 
buf
[0], 
b
 = buf[1], 
c
 = buf[2], 
d
 = buf[3];

58 
	`ROUND
(
F
, 
a
, 
b
, 
c
, 
d
, 
ö
[0] + 
K1
, 3);

59 
	`ROUND
(
F
, 
d
, 
a
, 
b
, 
c
, 
ö
[1] + 
K1
, 7);

60 
	`ROUND
(
F
, 
c
, 
d
, 
a
, 
b
, 
ö
[2] + 
K1
, 11);

61 
	`ROUND
(
F
, 
b
, 
c
, 
d
, 
a
, 
ö
[3] + 
K1
, 19);

62 
	`ROUND
(
F
, 
a
, 
b
, 
c
, 
d
, 
ö
[4] + 
K1
, 3);

63 
	`ROUND
(
F
, 
d
, 
a
, 
b
, 
c
, 
ö
[5] + 
K1
, 7);

64 
	`ROUND
(
F
, 
c
, 
d
, 
a
, 
b
, 
ö
[6] + 
K1
, 11);

65 
	`ROUND
(
F
, 
b
, 
c
, 
d
, 
a
, 
ö
[7] + 
K1
, 19);

68 
	`ROUND
(
G
, 
a
, 
b
, 
c
, 
d
, 
ö
[1] + 
K2
, 3);

69 
	`ROUND
(
G
, 
d
, 
a
, 
b
, 
c
, 
ö
[3] + 
K2
, 5);

70 
	`ROUND
(
G
, 
c
, 
d
, 
a
, 
b
, 
ö
[5] + 
K2
, 9);

71 
	`ROUND
(
G
, 
b
, 
c
, 
d
, 
a
, 
ö
[7] + 
K2
, 13);

72 
	`ROUND
(
G
, 
a
, 
b
, 
c
, 
d
, 
ö
[0] + 
K2
, 3);

73 
	`ROUND
(
G
, 
d
, 
a
, 
b
, 
c
, 
ö
[2] + 
K2
, 5);

74 
	`ROUND
(
G
, 
c
, 
d
, 
a
, 
b
, 
ö
[4] + 
K2
, 9);

75 
	`ROUND
(
G
, 
b
, 
c
, 
d
, 
a
, 
ö
[6] + 
K2
, 13);

78 
	`ROUND
(
H
, 
a
, 
b
, 
c
, 
d
, 
ö
[3] + 
K3
, 3);

79 
	`ROUND
(
H
, 
d
, 
a
, 
b
, 
c
, 
ö
[7] + 
K3
, 9);

80 
	`ROUND
(
H
, 
c
, 
d
, 
a
, 
b
, 
ö
[2] + 
K3
, 11);

81 
	`ROUND
(
H
, 
b
, 
c
, 
d
, 
a
, 
ö
[6] + 
K3
, 15);

82 
	`ROUND
(
H
, 
a
, 
b
, 
c
, 
d
, 
ö
[1] + 
K3
, 3);

83 
	`ROUND
(
H
, 
d
, 
a
, 
b
, 
c
, 
ö
[5] + 
K3
, 9);

84 
	`ROUND
(
H
, 
c
, 
d
, 
a
, 
b
, 
ö
[0] + 
K3
, 11);

85 
	`ROUND
(
H
, 
b
, 
c
, 
d
, 
a
, 
ö
[4] + 
K3
, 15);

87 
buf
[0] +
a
;

88 
buf
[1] +
b
;

89 
buf
[2] +
c
;

90 
buf
[3] +
d
;

92  
buf
[1];

93 
	}
}

94 #unde‡
ROUND


95 #unde‡
K1


96 #unde‡
K2


97 #unde‡
K3


98 #unde‡
F


99 #unde‡
G


100 #unde‡
H


103 
__u32
 
	$dx_hack_hash_unsig√d
(c⁄° *
«me
, 
Àn
)

105 
__u32
 
hash
, 
hash0
 = 0x12a3„2d, 
hash1
 = 0x37abe8f9;

106 c⁄° *
u˝
 = (c⁄° *Ë
«me
;

108 
Àn
--) {

109 
hash
 = 
hash1
 + (
hash0
 ^ (((Ë*
u˝
++) * 7152373));

111 i‡(
hash
 & 0x80000000)

112 
hash
 -= 0x7fffffff;

113 
hash1
 = 
hash0
;

114 
hash0
 = 
hash
;

116  
hash0
 << 1;

117 
	}
}

119 
__u32
 
	$dx_hack_hash_sig√d
(c⁄° *
«me
, 
Àn
)

121 
__u32
 
hash
, 
hash0
 = 0x12a3„2d, 
hash1
 = 0x37abe8f9;

122 c⁄° sig√d *
s˝
 = (c⁄° sig√d *Ë
«me
;

124 
Àn
--) {

125 
hash
 = 
hash1
 + (
hash0
 ^ (((Ë*
s˝
++) * 7152373));

127 i‡(
hash
 & 0x80000000)

128 
hash
 -= 0x7fffffff;

129 
hash1
 = 
hash0
;

130 
hash0
 = 
hash
;

132  
hash0
 << 1;

133 
	}
}

135 
	$°r2hashbuf_sig√d
(c⁄° *
msg
, 
Àn
, 
__u32
 *
buf
, 
num
)

137 
__u32
 
∑d
, 
vÆ
;

138 
i
;

139 c⁄° sig√d *
s˝
 = (c⁄° sig√d *Ë
msg
;

141 
∑d
 = (
__u32
)
Àn
 | ((__u32)len << 8);

142 
∑d
 |=Öad << 16;

144 
vÆ
 = 
∑d
;

145 i‡(
Àn
 > 
num
*4)

146 
Àn
 = 
num
 * 4;

147 
i
 = 0; i < 
Àn
; i++) {

148 
vÆ
 = ((Ë
s˝
[
i
]) + (val << 8);

149 i‡((
i
 % 4) == 3) {

150 *
buf
++ = 
vÆ
;

151 
vÆ
 = 
∑d
;

152 
num
--;

155 i‡(--
num
 >= 0)

156 *
buf
++ = 
vÆ
;

157 --
num
 >= 0)

158 *
buf
++ = 
∑d
;

159 
	}
}

161 
	$°r2hashbuf_unsig√d
(c⁄° *
msg
, 
Àn
, 
__u32
 *
buf
, 
num
)

163 
__u32
 
∑d
, 
vÆ
;

164 
i
;

165 c⁄° *
u˝
 = (c⁄° *Ë
msg
;

167 
∑d
 = (
__u32
)
Àn
 | ((__u32)len << 8);

168 
∑d
 |=Öad << 16;

170 
vÆ
 = 
∑d
;

171 i‡(
Àn
 > 
num
*4)

172 
Àn
 = 
num
 * 4;

173 
i
 = 0; i < 
Àn
; i++) {

174 
vÆ
 = ((Ë
u˝
[
i
]) + (val << 8);

175 i‡((
i
 % 4) == 3) {

176 *
buf
++ = 
vÆ
;

177 
vÆ
 = 
∑d
;

178 
num
--;

181 i‡(--
num
 >= 0)

182 *
buf
++ = 
vÆ
;

183 --
num
 >= 0)

184 *
buf
++ = 
∑d
;

185 
	}
}

200 
	$__pxt4fs_dúhash
(c⁄° *
«me
, 
Àn
,

201 
dx_hash_öfo
 *
höfo
)

203 
__u32
 
hash
;

204 
__u32
 
mö‹_hash
 = 0;

205 c⁄° *
p
;

206 
i
;

207 
__u32
 
ö
[8], 
buf
[4];

208 (*
°r2hashbuf
)(c⁄° *, , 
__u32
 *, ) =

209 
°r2hashbuf_sig√d
;

212 
buf
[0] = 0x67452301;

213 
buf
[1] = 0xefcdab89;

214 
buf
[2] = 0x98badcfe;

215 
buf
[3] = 0x10325476;

218 i‡(
höfo
->
£ed
) {

219 
i
 = 0; i < 4; i++) {

220 i‡(
höfo
->
£ed
[
i
]) {

221 
	`mem˝y
(
buf
, 
höfo
->
£ed
, (buf));

227 
höfo
->
hash_vîsi⁄
) {

228 
DX_HASH_LEGACY_UNSIGNED
:

229 
hash
 = 
	`dx_hack_hash_unsig√d
(
«me
, 
Àn
);

231 
DX_HASH_LEGACY
:

232 
hash
 = 
	`dx_hack_hash_sig√d
(
«me
, 
Àn
);

234 
DX_HASH_HALF_MD4_UNSIGNED
:

235 
°r2hashbuf
 = 
°r2hashbuf_unsig√d
;

237 
DX_HASH_HALF_MD4
:

238 
p
 = 
«me
;

239 
Àn
 > 0) {

240 (*
°r2hashbuf
)(
p
, 
Àn
, 
ö
, 8);

241 
	`hÆf_md4_å™sf‹m
(
buf
, 
ö
);

242 
Àn
 -= 32;

243 
p
 += 32;

245 
mö‹_hash
 = 
buf
[2];

246 
hash
 = 
buf
[1];

248 
DX_HASH_TEA_UNSIGNED
:

249 
°r2hashbuf
 = 
°r2hashbuf_unsig√d
;

251 
DX_HASH_TEA
:

252 
p
 = 
«me
;

253 
Àn
 > 0) {

254 (*
°r2hashbuf
)(
p
, 
Àn
, 
ö
, 4);

255 
	`TEA_å™sf‹m
(
buf
, 
ö
);

256 
Àn
 -= 16;

257 
p
 += 16;

259 
hash
 = 
buf
[0];

260 
mö‹_hash
 = 
buf
[1];

263 
höfo
->
hash
 = 0;

266 
hash
 = hash & ~1;

267 i‡(
hash
 =(
PXT4_HTREE_EOF_32BIT
 << 1))

268 
hash
 = (
PXT4_HTREE_EOF_32BIT
 - 1) << 1;

269 
höfo
->
hash
 = hash;

270 
höfo
->
mö‹_hash
 = minor_hash;

272 
	}
}

274 
	$pxt4fs_dúhash
(c⁄° 
öode
 *
dú
, c⁄° *
«me
, 
Àn
,

275 
dx_hash_öfo
 *
höfo
)

277 #ifde‡
CONFIG_UNICODE


278 c⁄° 
unicode_m≠
 *
um
 = 
	`PXT4_SB
(
dú
->
i_sb
)->
s_ícodög
;

279 
r
, 
dÀn
;

280 *
buff
;

281 
q°r
 q°∏{.
«me
 =Çame, .
Àn
 =Üen };

283 i‡(
Àn
 && 
	`IS_CASEFOLDED
(
dú
Ë&& 
um
) {

284 
buff
 = 
	`kzÆloc
((Ë* 
PATH_MAX
, 
GFP_KERNEL
);

285 i‡(!
buff
)

286  -
ENOMEM
;

288 
dÀn
 = 
	`utf8_ˇ£fﬁd
(
um
, &
q°r
, 
buff
, 
PATH_MAX
);

289 i‡(
dÀn
 < 0) {

290 
	`k‰ì
(
buff
);

291 
›aque_£q
;

294 
r
 = 
	`__pxt4fs_dúhash
(
buff
, 
dÀn
, 
höfo
);

296 
	`k‰ì
(
buff
);

297  
r
;

299 
›aque_£q
:

301  
	`__pxt4fs_dúhash
(
«me
, 
Àn
, 
höfo
);

302 
	}
}

	@ialloc.c

16 
	~<löux/time.h
>

17 
	~<löux/fs.h
>

18 
	~<löux/°©.h
>

19 
	~<löux/°rög.h
>

20 
	~<löux/quŸa›s.h
>

21 
	~<löux/buf„r_hód.h
>

22 
	~<löux/øndom.h
>

23 
	~<löux/bô›s.h
>

24 
	~<löux/blkdev.h
>

25 
	~<löux/¸ed.h
>

27 
	~<asm/byã‹dî.h
>

29 
	~"pxt4.h
"

30 
	~"pxt4_jbd3.h
"

31 
	~"x©å.h
"

32 
	~"a˛.h
"

34 
	~<åa˚/evíts/pxt4.h
>

55 
	$pxt4_m¨k_bôm≠_íd
(
°¨t_bô
, 
íd_bô
, *
bôm≠
)

57 
i
;

59 i‡(
°¨t_bô
 >
íd_bô
)

62 
	`pxt4_debug
("m¨kÉnd bô†+%dÅhrough +%d u£d\n", 
°¨t_bô
, 
íd_bô
);

63 
i
 = 
°¨t_bô
; i < ((start_bit + 7) & ~7UL); i++)

64 
	`pxt4_£t_bô
(
i
, 
bôm≠
);

65 i‡(
i
 < 
íd_bô
)

66 
	`mem£t
(
bôm≠
 + (
i
 >> 3), 0xff, (
íd_bô
 - i) >> 3);

67 
	}
}

69 
	$pxt4_íd_bôm≠_ªad
(
buf„r_hód
 *
bh
, 
u±od©e
)

71 i‡(
u±od©e
) {

72 
	`£t_buf„r_u±od©e
(
bh
);

73 
	`£t_bôm≠_u±od©e
(
bh
);

75 
	`u∆ock_buf„r
(
bh
);

76 
	`put_bh
(
bh
);

77 
	}
}

79 
	$pxt4_vÆid©e_öode_bôm≠
(
su≥r_block
 *
sb
,

80 
pxt4_group_desc
 *
desc
,

81 
pxt4_group_t
 
block_group
,

82 
buf„r_hód
 *
bh
)

84 
pxt4_fsblk_t
 
blk
;

85 
pxt4_group_öfo
 *
gΩ
 = 
	`pxt4_gë_group_öfo
(
sb
, 
block_group
);

87 i‡(
	`buf„r_vîifõd
(
bh
))

89 i‡(
	`PXT4_MB_GRP_IBITMAP_CORRUPT
(
gΩ
))

90  -
EFSCORRUPTED
;

92 
	`pxt4_lock_group
(
sb
, 
block_group
);

93 i‡(
	`buf„r_vîifõd
(
bh
))

94 
vîifõd
;

95 
blk
 = 
	`pxt4_öode_bôm≠
(
sb
, 
desc
);

96 i‡(!
	`pxt4_öode_bôm≠_csum_vîify
(
sb
, 
block_group
, 
desc
, 
bh
,

97 
	`PXT4_INODES_PER_GROUP
(
sb
) / 8)) {

98 
	`pxt4_u∆ock_group
(
sb
, 
block_group
);

99 
	`pxt4_îr‹
(
sb
, "Corrupt inode bitmap - block_group = %u, "

100 "öode_bôm≠ = %Œu", 
block_group
, 
blk
);

101 
	`pxt4_m¨k_group_bôm≠_c‹ru±ed
(
sb
, 
block_group
,

102 
PXT4_GROUP_INFO_IBITMAP_CORRUPT
);

103  -
EFSBADCRC
;

105 
	`£t_buf„r_vîifõd
(
bh
);

106 
vîifõd
:

107 
	`pxt4_u∆ock_group
(
sb
, 
block_group
);

109 
	}
}

117 
buf„r_hód
 *

118 
	$pxt4_ªad_öode_bôm≠
(
su≥r_block
 *
sb
, 
pxt4_group_t
 
block_group
)

120 
pxt4_group_desc
 *
desc
;

121 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
sb
);

122 
buf„r_hód
 *
bh
 = 
NULL
;

123 
pxt4_fsblk_t
 
bôm≠_blk
;

124 
îr
;

126 
desc
 = 
	`pxt4_gë_group_desc
(
sb
, 
block_group
, 
NULL
);

127 i‡(!
desc
)

128  
	`ERR_PTR
(-
EFSCORRUPTED
);

130 
bôm≠_blk
 = 
	`pxt4_öode_bôm≠
(
sb
, 
desc
);

131 i‡((
bôm≠_blk
 <
	`À32_to_˝u
(
sbi
->
s_es
->
s_fú°_d©a_block
)) ||

132 (
bôm≠_blk
 >
	`pxt4_blocks_cou¡
(
sbi
->
s_es
))) {

133 
	`pxt4_îr‹
(
sb
, "Invalid inode bitmap blk %llu in "

134 "block_grou∞%u", 
bôm≠_blk
, 
block_group
);

135 
	`pxt4_m¨k_group_bôm≠_c‹ru±ed
(
sb
, 
block_group
,

136 
PXT4_GROUP_INFO_IBITMAP_CORRUPT
);

137  
	`ERR_PTR
(-
EFSCORRUPTED
);

139 
bh
 = 
	`sb_gëblk
(
sb
, 
bôm≠_blk
);

140 i‡(
	`u∆ikñy
(!
bh
)) {

141 
	`pxt4_w¨nög
(
sb
, "CannotÑead inode bitmap - "

143 
block_group
, 
bôm≠_blk
);

144  
	`ERR_PTR
(-
ENOMEM
);

146 i‡(
	`bôm≠_u±od©e
(
bh
))

147 
vîify
;

149 
	`lock_buf„r
(
bh
);

150 i‡(
	`bôm≠_u±od©e
(
bh
)) {

151 
	`u∆ock_buf„r
(
bh
);

152 
vîify
;

155 
	`pxt4_lock_group
(
sb
, 
block_group
);

156 i‡(
	`pxt4_has_group_desc_csum
(
sb
) &&

157 (
desc
->
bg_Êags
 & 
	`˝u_to_À16
(
PXT4_BG_INODE_UNINIT
))) {

158 i‡(
block_group
 == 0) {

159 
	`pxt4_u∆ock_group
(
sb
, 
block_group
);

160 
	`u∆ock_buf„r
(
bh
);

161 
	`pxt4_îr‹
(
sb
, "Inode bitmap for bg 0 marked "

163 
îr
 = -
EFSCORRUPTED
;

164 
out
;

166 
	`mem£t
(
bh
->
b_d©a
, 0, (
	`PXT4_INODES_PER_GROUP
(
sb
) + 7) / 8);

167 
	`pxt4_m¨k_bôm≠_íd
(
	`PXT4_INODES_PER_GROUP
(
sb
),

168 
sb
->
s_blocksize
 * 8, 
bh
->
b_d©a
);

169 
	`£t_bôm≠_u±od©e
(
bh
);

170 
	`£t_buf„r_u±od©e
(
bh
);

171 
	`£t_buf„r_vîifõd
(
bh
);

172 
	`pxt4_u∆ock_group
(
sb
, 
block_group
);

173 
	`u∆ock_buf„r
(
bh
);

174  
bh
;

176 
	`pxt4_u∆ock_group
(
sb
, 
block_group
);

178 i‡(
	`buf„r_u±od©e
(
bh
)) {

183 
	`£t_bôm≠_u±od©e
(
bh
);

184 
	`u∆ock_buf„r
(
bh
);

185 
vîify
;

190 
	`åa˚_pxt4_lﬂd_öode_bôm≠
(
sb
, 
block_group
);

191 
bh
->
b_íd_io
 = 
pxt4_íd_bôm≠_ªad
;

192 
	`gë_bh
(
bh
);

193 
	`submô_bh
(
REQ_OP_READ
, 
REQ_META
 | 
REQ_PRIO
, 
bh
);

194 
	`waô_⁄_buf„r
(
bh
);

195 i‡(!
	`buf„r_u±od©e
(
bh
)) {

196 
	`put_bh
(
bh
);

197 
	`pxt4_îr‹
(
sb
, "CannotÑead inode bitmap - "

199 
block_group
, 
bôm≠_blk
);

200 
	`pxt4_m¨k_group_bôm≠_c‹ru±ed
(
sb
, 
block_group
,

201 
PXT4_GROUP_INFO_IBITMAP_CORRUPT
);

202  
	`ERR_PTR
(-
EIO
);

205 
vîify
:

206 
îr
 = 
	`pxt4_vÆid©e_öode_bôm≠
(
sb
, 
desc
, 
block_group
, 
bh
);

207 i‡(
îr
)

208 
out
;

209  
bh
;

210 
out
:

211 
	`put_bh
(
bh
);

212  
	`ERR_PTR
(
îr
);

213 
	}
}

231 
	$pxt4_‰ì_öode
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *inode)

233 
su≥r_block
 *
sb
 = 
öode
->
i_sb
;

234 
is_dúe˘‹y
;

235 
öo
;

236 
buf„r_hód
 *
bôm≠_bh
 = 
NULL
;

237 
buf„r_hód
 *
bh2
;

238 
pxt4_group_t
 
block_group
;

239 
bô
;

240 
pxt4_group_desc
 *
gdp
;

241 
pxt4_su≥r_block
 *
es
;

242 
pxt4_sb_öfo
 *
sbi
;

243 
Áèl
 = 0, 
îr
, 
cou¡
, 
˛óªd
;

244 
pxt4_group_öfo
 *
gΩ
;

246 i‡(!
sb
) {

247 
	`¥ötk
(
KERN_ERR
 "PXT4-fs: %s:%d: inode on "

248 "n⁄exi°íàdevi˚\n", 
__func__
, 
__LINE__
);

251 i‡(
	`©omic_ªad
(&
öode
->
i_cou¡
) > 1) {

252 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "%s:%d: inode #%lu: count=%d",

253 
__func__
, 
__LINE__
, 
öode
->
i_öo
,

254 
	`©omic_ªad
(&
öode
->
i_cou¡
));

257 i‡(
öode
->
i_∆ök
) {

258 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "%s:%d: inode #%lu:Çlink=%d\n",

259 
__func__
, 
__LINE__
, 
öode
->
i_öo
, inode->
i_∆ök
);

262 
sbi
 = 
	`PXT4_SB
(
sb
);

264 
öo
 = 
öode
->
i_öo
;

265 
	`pxt4_debug
("‰ìög inodê%lu\n", 
öo
);

266 
	`åa˚_pxt4_‰ì_öode
(
öode
);

268 
	`dquŸ_öôülize
(
öode
);

269 
	`dquŸ_‰ì_öode
(
öode
);

271 
is_dúe˘‹y
 = 
	`S_ISDIR
(
öode
->
i_mode
);

274 
	`pxt4_˛ór_öode
(
öode
);

276 
es
 = 
sbi
->
s_es
;

277 i‡(
öo
 < 
	`PXT4_FIRST_INO
(
sb
Ë|| inÿ> 
	`À32_to_˝u
(
es
->
s_öodes_cou¡
)) {

278 
	`pxt4_îr‹
(
sb
, "ª£rved o∏n⁄exi°íàöodê%lu", 
öo
);

279 
îr‹_ªtu∫
;

281 
block_group
 = (
öo
 - 1Ë/ 
	`PXT4_INODES_PER_GROUP
(
sb
);

282 
bô
 = (
öo
 - 1Ë% 
	`PXT4_INODES_PER_GROUP
(
sb
);

283 
bôm≠_bh
 = 
	`pxt4_ªad_öode_bôm≠
(
sb
, 
block_group
);

285 
gΩ
 = 
	`pxt4_gë_group_öfo
(
sb
, 
block_group
);

286 i‡(
	`IS_ERR
(
bôm≠_bh
)) {

287 
Áèl
 = 
	`PTR_ERR
(
bôm≠_bh
);

288 
bôm≠_bh
 = 
NULL
;

289 
îr‹_ªtu∫
;

291 i‡(
	`u∆ikñy
(
	`PXT4_MB_GRP_IBITMAP_CORRUPT
(
gΩ
))) {

292 
Áèl
 = -
EFSCORRUPTED
;

293 
îr‹_ªtu∫
;

296 
	`BUFFER_TRACE
(
bôm≠_bh
, "get_write_access");

297 
Áèl
 = 
	`pxt4_jou∫Æ_gë_wrôe_ac˚ss
(
h™dÀ
, 
bôm≠_bh
);

298 i‡(
Áèl
)

299 
îr‹_ªtu∫
;

301 
Áèl
 = -
ESRCH
;

302 
gdp
 = 
	`pxt4_gë_group_desc
(
sb
, 
block_group
, &
bh2
);

303 i‡(
gdp
) {

304 
	`BUFFER_TRACE
(
bh2
, "get_write_access");

305 
Áèl
 = 
	`pxt4_jou∫Æ_gë_wrôe_ac˚ss
(
h™dÀ
, 
bh2
);

307 
	`pxt4_lock_group
(
sb
, 
block_group
);

308 
˛óªd
 = 
	`pxt4_ã°_™d_˛ór_bô
(
bô
, 
bôm≠_bh
->
b_d©a
);

309 i‡(
Áèl
 || !
˛óªd
) {

310 
	`pxt4_u∆ock_group
(
sb
, 
block_group
);

311 
out
;

314 
cou¡
 = 
	`pxt4_‰ì_öodes_cou¡
(
sb
, 
gdp
) + 1;

315 
	`pxt4_‰ì_öodes_£t
(
sb
, 
gdp
, 
cou¡
);

316 i‡(
is_dúe˘‹y
) {

317 
cou¡
 = 
	`pxt4_u£d_dús_cou¡
(
sb
, 
gdp
) - 1;

318 
	`pxt4_u£d_dús_£t
(
sb
, 
gdp
, 
cou¡
);

319 
	`≥r˝u_cou¡î_dec
(&
sbi
->
s_dús_cou¡î
);

321 
	`pxt4_öode_bôm≠_csum_£t
(
sb
, 
block_group
, 
gdp
, 
bôm≠_bh
,

322 
	`PXT4_INODES_PER_GROUP
(
sb
) / 8);

323 
	`pxt4_group_desc_csum_£t
(
sb
, 
block_group
, 
gdp
);

324 
	`pxt4_u∆ock_group
(
sb
, 
block_group
);

326 
	`≥r˝u_cou¡î_öc
(&
sbi
->
s_‰ìöodes_cou¡î
);

327 i‡(
sbi
->
s_log_groups_≥r_Êex
) {

328 
Êex_groups
 *
fg
;

330 
fg
 = 
	`sbi_¨øy_rcu_dîef
(
sbi
, 
s_Êex_groups
,

331 
	`pxt4_Êex_group
(
sbi
, 
block_group
));

332 
	`©omic_öc
(&
fg
->
‰ì_öodes
);

333 i‡(
is_dúe˘‹y
)

334 
	`©omic_dec
(&
fg
->
u£d_dús
);

336 
	`BUFFER_TRACE
(
bh2
, "callÖxt4_handle_dirty_metadata");

337 
Áèl
 = 
	`pxt4_h™dÀ_dúty_mëad©a
(
h™dÀ
, 
NULL
, 
bh2
);

338 
out
:

339 i‡(
˛óªd
) {

340 
	`BUFFER_TRACE
(
bôm≠_bh
, "callÖxt4_handle_dirty_metadata");

341 
îr
 = 
	`pxt4_h™dÀ_dúty_mëad©a
(
h™dÀ
, 
NULL
, 
bôm≠_bh
);

342 i‡(!
Áèl
)

343 
Áèl
 = 
îr
;

345 
	`pxt4_îr‹
(
sb
, "bôáÃódy cÀ¨ed f‹ inodê%lu", 
öo
);

346 
	`pxt4_m¨k_group_bôm≠_c‹ru±ed
(
sb
, 
block_group
,

347 
PXT4_GROUP_INFO_IBITMAP_CORRUPT
);

350 
îr‹_ªtu∫
:

351 
	`bªl£
(
bôm≠_bh
);

352 
	`pxt4_°d_îr‹
(
sb
, 
Áèl
);

353 
	}
}

355 
	s‹lov_°©s
 {

356 
__u64
 
	m‰ì_˛u°îs
;

357 
__u32
 
	m‰ì_öodes
;

358 
__u32
 
	mu£d_dús
;

366 
	$gë_‹lov_°©s
(
su≥r_block
 *
sb
, 
pxt4_group_t
 
g
,

367 
Êex_size
, 
‹lov_°©s
 *
°©s
)

369 
pxt4_group_desc
 *
desc
;

371 i‡(
Êex_size
 > 1) {

372 
Êex_groups
 *
fg
 = 
	`sbi_¨øy_rcu_dîef
(
	`PXT4_SB
(
sb
),

373 
s_Êex_groups
, 
g
);

374 
°©s
->
‰ì_öodes
 = 
	`©omic_ªad
(&
fg
->free_inodes);

375 
°©s
->
‰ì_˛u°îs
 = 
	`©omic64_ªad
(&
fg
->free_clusters);

376 
°©s
->
u£d_dús
 = 
	`©omic_ªad
(&
fg
->used_dirs);

380 
desc
 = 
	`pxt4_gë_group_desc
(
sb
, 
g
, 
NULL
);

381 i‡(
desc
) {

382 
°©s
->
‰ì_öodes
 = 
	`pxt4_‰ì_öodes_cou¡
(
sb
, 
desc
);

383 
°©s
->
‰ì_˛u°îs
 = 
	`pxt4_‰ì_group_˛u°îs
(
sb
, 
desc
);

384 
°©s
->
u£d_dús
 = 
	`pxt4_u£d_dús_cou¡
(
sb
, 
desc
);

386 
°©s
->
‰ì_öodes
 = 0;

387 
°©s
->
‰ì_˛u°îs
 = 0;

388 
°©s
->
u£d_dús
 = 0;

390 
	}
}

413 
	$föd_group_‹lov
(
su≥r_block
 *
sb
, 
öode
 *
∑ª¡
,

414 
pxt4_group_t
 *
group
, 
umode_t
 
mode
,

415 c⁄° 
q°r
 *qstr)

417 
pxt4_group_t
 
∑ª¡_group
 = 
	`PXT4_I
(
∑ª¡
)->
i_block_group
;

418 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
sb
);

419 
pxt4_group_t
 
ªÆ_ngroups
 = 
	`pxt4_gë_groups_cou¡
(
sb
);

420 
öodes_≥r_group
 = 
	`PXT4_INODES_PER_GROUP
(
sb
);

421 
‰ìi
, 
ave‰ìi
, 
gΩ_‰ì
;

422 
pxt4_fsblk_t
 
‰ìc
, 
ave‰ìc
;

423 
ndús
;

424 
max_dús
, 
mö_öodes
;

425 
pxt4_gΩblk_t
 
mö_˛u°îs
;

426 
pxt4_group_t
 
i
, 
gΩ
, 
g
, 
ngroups
;

427 
pxt4_group_desc
 *
desc
;

428 
‹lov_°©s
 
°©s
;

429 
Êex_size
 = 
	`pxt4_Êex_bg_size
(
sbi
);

430 
dx_hash_öfo
 
höfo
;

432 
ngroups
 = 
ªÆ_ngroups
;

433 i‡(
Êex_size
 > 1) {

434 
ngroups
 = (
ªÆ_ngroups
 + 
Êex_size
 - 1) >>

435 
sbi
->
s_log_groups_≥r_Êex
;

436 
∑ª¡_group
 >>
sbi
->
s_log_groups_≥r_Êex
;

439 
‰ìi
 = 
	`≥r˝u_cou¡î_ªad_posôive
(&
sbi
->
s_‰ìöodes_cou¡î
);

440 
ave‰ìi
 = 
‰ìi
 / 
ngroups
;

441 
‰ìc
 = 
	`≥r˝u_cou¡î_ªad_posôive
(&
sbi
->
s_‰ì˛u°îs_cou¡î
);

442 
ave‰ìc
 = 
‰ìc
;

443 
	`do_div
(
ave‰ìc
, 
ngroups
);

444 
ndús
 = 
	`≥r˝u_cou¡î_ªad_posôive
(&
sbi
->
s_dús_cou¡î
);

446 i‡(
	`S_ISDIR
(
mode
) &&

447 ((
∑ª¡
 =
	`d_öode
(
sb
->
s_roŸ
)) ||

448 (
	`pxt4_ã°_öode_Êag
(
∑ª¡
, 
PXT4_INODE_TOPDIR
)))) {

449 
be°_ndú
 = 
öodes_≥r_group
;

450 
ªt
 = -1;

452 i‡(
q°r
) {

453 
höfo
.
hash_vîsi⁄
 = 
DX_HASH_HALF_MD4
;

454 
höfo
.
£ed
 = 
sbi
->
s_hash_£ed
;

455 
	`pxt4fs_dúhash
(
∑ª¡
, 
q°r
->
«me
, q°r->
Àn
, &
höfo
);

456 
gΩ
 = 
höfo
.
hash
;

458 
gΩ
 = 
	`¥™dom_u32
();

459 
∑ª¡_group
 = ()
gΩ
 % 
ngroups
;

460 
i
 = 0; i < 
ngroups
; i++) {

461 
g
 = (
∑ª¡_group
 + 
i
Ë% 
ngroups
;

462 
	`gë_‹lov_°©s
(
sb
, 
g
, 
Êex_size
, &
°©s
);

463 i‡(!
°©s
.
‰ì_öodes
)

465 i‡(
°©s
.
u£d_dús
 >
be°_ndú
)

467 i‡(
°©s
.
‰ì_öodes
 < 
ave‰ìi
)

469 i‡(
°©s
.
‰ì_˛u°îs
 < 
ave‰ìc
)

471 
gΩ
 = 
g
;

472 
ªt
 = 0;

473 
be°_ndú
 = 
°©s
.
u£d_dús
;

475 i‡(
ªt
)

476 
ÁŒback
;

477 
found_Êex_bg
:

478 i‡(
Êex_size
 == 1) {

479 *
group
 = 
gΩ
;

490 
gΩ
 *
Êex_size
;

491 
i
 = 0; i < 
Êex_size
; i++) {

492 i‡(
gΩ
+
i
 >
ªÆ_ngroups
)

494 
desc
 = 
	`pxt4_gë_group_desc
(
sb
, 
gΩ
+
i
, 
NULL
);

495 i‡(
desc
 && 
	`pxt4_‰ì_öodes_cou¡
(
sb
, desc)) {

496 *
group
 = 
gΩ
+
i
;

500 
ÁŒback
;

503 
max_dús
 = 
ndús
 / 
ngroups
 + 
öodes_≥r_group
 / 16;

504 
mö_öodes
 = 
ave‰ìi
 - 
öodes_≥r_group
*
Êex_size
 / 4;

505 i‡(
mö_öodes
 < 1)

506 
mö_öodes
 = 1;

507 
mö_˛u°îs
 = 
ave‰ìc
 - 
	`PXT4_CLUSTERS_PER_GROUP
(
sb
)*
Êex_size
 / 4;

513 i‡(
	`PXT4_I
(
∑ª¡
)->
i_œ°_Æloc_group
 != ~0) {

514 
∑ª¡_group
 = 
	`PXT4_I
(
∑ª¡
)->
i_œ°_Æloc_group
;

515 i‡(
Êex_size
 > 1)

516 
∑ª¡_group
 >>
sbi
->
s_log_groups_≥r_Êex
;

519 
i
 = 0; i < 
ngroups
; i++) {

520 
gΩ
 = (
∑ª¡_group
 + 
i
Ë% 
ngroups
;

521 
	`gë_‹lov_°©s
(
sb
, 
gΩ
, 
Êex_size
, &
°©s
);

522 i‡(
°©s
.
u£d_dús
 >
max_dús
)

524 i‡(
°©s
.
‰ì_öodes
 < 
mö_öodes
)

526 i‡(
°©s
.
‰ì_˛u°îs
 < 
mö_˛u°îs
)

528 
found_Êex_bg
;

531 
ÁŒback
:

532 
ngroups
 = 
ªÆ_ngroups
;

533 
ave‰ìi
 = 
‰ìi
 / 
ngroups
;

534 
ÁŒback_ªåy
:

535 
∑ª¡_group
 = 
	`PXT4_I
(
∑ª¡
)->
i_block_group
;

536 
i
 = 0; i < 
ngroups
; i++) {

537 
gΩ
 = (
∑ª¡_group
 + 
i
Ë% 
ngroups
;

538 
desc
 = 
	`pxt4_gë_group_desc
(
sb
, 
gΩ
, 
NULL
);

539 i‡(
desc
) {

540 
gΩ_‰ì
 = 
	`pxt4_‰ì_öodes_cou¡
(
sb
, 
desc
);

541 i‡(
gΩ_‰ì
 && gΩ_‰ì >
ave‰ìi
) {

542 *
group
 = 
gΩ
;

548 i‡(
ave‰ìi
) {

553 
ave‰ìi
 = 0;

554 
ÁŒback_ªåy
;

558 
	}
}

560 
	$föd_group_Ÿhî
(
su≥r_block
 *
sb
, 
öode
 *
∑ª¡
,

561 
pxt4_group_t
 *
group
, 
umode_t
 
mode
)

563 
pxt4_group_t
 
∑ª¡_group
 = 
	`PXT4_I
(
∑ª¡
)->
i_block_group
;

564 
pxt4_group_t
 
i
, 
œ°
, 
ngroups
 = 
	`pxt4_gë_groups_cou¡
(
sb
);

565 
pxt4_group_desc
 *
desc
;

566 
Êex_size
 = 
	`pxt4_Êex_bg_size
(
	`PXT4_SB
(
sb
));

575 i‡(
Êex_size
 > 1) {

576 
ªåy
 = 0;

578 
åy_agaö
:

579 
∑ª¡_group
 &~(
Êex_size
-1);

580 
œ°
 = 
∑ª¡_group
 + 
Êex_size
;

581 i‡(
œ°
 > 
ngroups
)

582 
œ°
 = 
ngroups
;

583 
i
 = 
∑ª¡_group
; i < 
œ°
; i++) {

584 
desc
 = 
	`pxt4_gë_group_desc
(
sb
, 
i
, 
NULL
);

585 i‡(
desc
 && 
	`pxt4_‰ì_öodes_cou¡
(
sb
, desc)) {

586 *
group
 = 
i
;

590 i‡(!
ªåy
 && 
	`PXT4_I
(
∑ª¡
)->
i_œ°_Æloc_group
 != ~0) {

591 
ªåy
 = 1;

592 
∑ª¡_group
 = 
	`PXT4_I
(
∑ª¡
)->
i_œ°_Æloc_group
;

593 
åy_agaö
;

600 *
group
 = 
∑ª¡_group
 + 
Êex_size
;

601 i‡(*
group
 > 
ngroups
)

602 *
group
 = 0;

603  
	`föd_group_‹lov
(
sb
, 
∑ª¡
, 
group
, 
mode
, 
NULL
);

609 *
group
 = 
∑ª¡_group
;

610 
desc
 = 
	`pxt4_gë_group_desc
(
sb
, *
group
, 
NULL
);

611 i‡(
desc
 && 
	`pxt4_‰ì_öodes_cou¡
(
sb
, desc) &&

612 
	`pxt4_‰ì_group_˛u°îs
(
sb
, 
desc
))

624 *
group
 = (*grou∞+ 
∑ª¡
->
i_öo
Ë% 
ngroups
;

630 
i
 = 1; i < 
ngroups
; i <<= 1) {

631 *
group
 +
i
;

632 i‡(*
group
 >
ngroups
)

633 *
group
 -
ngroups
;

634 
desc
 = 
	`pxt4_gë_group_desc
(
sb
, *
group
, 
NULL
);

635 i‡(
desc
 && 
	`pxt4_‰ì_öodes_cou¡
(
sb
, desc) &&

636 
	`pxt4_‰ì_group_˛u°îs
(
sb
, 
desc
))

644 *
group
 = 
∑ª¡_group
;

645 
i
 = 0; i < 
ngroups
; i++) {

646 i‡(++*
group
 >
ngroups
)

647 *
group
 = 0;

648 
desc
 = 
	`pxt4_gë_group_desc
(
sb
, *
group
, 
NULL
);

649 i‡(
desc
 && 
	`pxt4_‰ì_öodes_cou¡
(
sb
, desc))

654 
	}
}

662 
	#RECENTCY_MIN
 60

	)

663 
	#RECENTCY_DIRTY
 300

	)

665 
	$ª˚¡ly_dñëed
(
su≥r_block
 *
sb
, 
pxt4_group_t
 
group
, 
öo
)

667 
pxt4_group_desc
 *
gdp
;

668 
pxt4_öode
 *
øw_öode
;

669 
buf„r_hód
 *
bh
;

670 
öodes_≥r_block
 = 
	`PXT4_SB
(
sb
)->
s_öodes_≥r_block
;

671 
off£t
, 
ªt
 = 0;

672 
ª˚¡cy
 = 
RECENTCY_MIN
;

673 
u32
 
dtime
, 
now
;

675 
gdp
 = 
	`pxt4_gë_group_desc
(
sb
, 
group
, 
NULL
);

676 i‡(
	`u∆ikñy
(!
gdp
))

679 
bh
 = 
	`sb_föd_gë_block
(
sb
, 
	`pxt4_öode_èbÀ
(sb, 
gdp
) +

680 (
öo
 / 
öodes_≥r_block
));

681 i‡(!
bh
 || !
	`buf„r_u±od©e
(bh))

686 
out
;

688 
off£t
 = (
öo
 % 
öodes_≥r_block
Ë* 
	`PXT4_INODE_SIZE
(
sb
);

689 
øw_öode
 = (
pxt4_öode
 *Ë(
bh
->
b_d©a
 + 
off£t
);

695 
dtime
 = 
	`À32_to_˝u
(
øw_öode
->
i_dtime
);

696 
now
 = 
	`ktime_gë_ªÆ_£c⁄ds
();

697 i‡(
	`buf„r_dúty
(
bh
))

698 
ª˚¡cy
 +
RECENTCY_DIRTY
;

700 i‡(
dtime
 && 
	`time_bef‹e32
(dtime, 
now
) &&

701 
	`time_bef‹e32
(
now
, 
dtime
 + 
ª˚¡cy
))

702 
ªt
 = 1;

703 
out
:

704 
	`bªl£
(
bh
);

705  
ªt
;

706 
	}
}

708 
	$föd_öode_bô
(
su≥r_block
 *
sb
, 
pxt4_group_t
 
group
,

709 
buf„r_hód
 *
bôm≠
, *
öo
)

711 
√xt
:

712 *
öo
 = 
	`pxt4_föd_√xt_zîo_bô
((*)

713 
bôm≠
->
b_d©a
,

714 
	`PXT4_INODES_PER_GROUP
(
sb
), *
öo
);

715 i‡(*
öo
 >
	`PXT4_INODES_PER_GROUP
(
sb
))

718 i‡((
	`PXT4_SB
(
sb
)->
s_jou∫Æ
 =
NULL
) &&

719 
	`ª˚¡ly_dñëed
(
sb
, 
group
, *
öo
)) {

720 *
öo
 = *ino + 1;

721 i‡(*
öo
 < 
	`PXT4_INODES_PER_GROUP
(
sb
))

722 
√xt
;

727 
	}
}

739 
öode
 *
	$__pxt4_√w_öode
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *
dú
,

740 
umode_t
 
mode
, c⁄° 
q°r
 *qstr,

741 
__u32
 
gﬂl
, 
uid_t
 *
ow√r
, __u32 
i_Êags
,

742 
h™dÀ_ty≥
, 
löe_no
,

743 
nblocks
)

745 
su≥r_block
 *
sb
;

746 
buf„r_hód
 *
öode_bôm≠_bh
 = 
NULL
;

747 
buf„r_hód
 *
group_desc_bh
;

748 
pxt4_group_t
 
ngroups
, 
group
 = 0;

749 
öo
 = 0;

750 
öode
 *inode;

751 
pxt4_group_desc
 *
gdp
 = 
NULL
;

752 
pxt4_öode_öfo
 *
ei
;

753 
pxt4_sb_öfo
 *
sbi
;

754 
ªt2
, 
îr
;

755 
öode
 *
ªt
;

756 
pxt4_group_t
 
i
;

757 
pxt4_group_t
 
Êex_group
;

758 
pxt4_group_öfo
 *
gΩ
;

759 
í¸y±
 = 0;

762 i‡(!
dú
 || !dú->
i_∆ök
)

763  
	`ERR_PTR
(-
EPERM
);

765 
sb
 = 
dú
->
i_sb
;

766 
sbi
 = 
	`PXT4_SB
(
sb
);

768 i‡(
	`u∆ikñy
(
	`pxt4_f‹˚d_shutdown
(
sbi
)))

769  
	`ERR_PTR
(-
EIO
);

771 i‡((
	`IS_ENCRYPTED
(
dú
Ë|| 
	`DUMMY_ENCRYPTION_ENABLED
(
sbi
)) &&

772 (
	`S_ISREG
(
mode
Ë|| 
	`S_ISDIR
(modeË|| 
	`S_ISLNK
(mode)) &&

773 !(
i_Êags
 & 
PXT4_EA_INODE_FL
)) {

774 
îr
 = 
	`fs¸y±_gë_í¸y±i⁄_öfo
(
dú
);

775 i‡(
îr
)

776  
	`ERR_PTR
(
îr
);

777 i‡(!
	`fs¸y±_has_í¸y±i⁄_key
(
dú
))

778  
	`ERR_PTR
(-
ENOKEY
);

779 
í¸y±
 = 1;

782 i‡(!
h™dÀ
 && 
sbi
->
s_jou∫Æ
 && !(
i_Êags
 & 
PXT4_EA_INODE_FL
)) {

783 #ifde‡
CONFIG_PXT4_FS_POSIX_ACL


784 
posix_a˛
 *
p
 = 
	`gë_a˛
(
dú
, 
ACL_TYPE_DEFAULT
);

786 i‡(
	`IS_ERR
(
p
))

787  
	`ERR_CAST
(
p
);

788 i‡(
p
) {

789 
a˛_size
 = 
p
->
a_cou¡
 * (
pxt4_a˛_íåy
);

791 
nblocks
 +(
	`S_ISDIR
(
mode
) ? 2 : 1) *

792 
	`__pxt4_x©å_£t_¸edôs
(
sb
, 
NULL
 ,

793 
NULL
 , 
a˛_size
,

794 
åue
 );

795 
	`posix_a˛_ªÀa£
(
p
);

799 #ifde‡
CONFIG_SECURITY


801 
num_£curôy_x©ås
 = 1;

803 #ifde‡
CONFIG_INTEGRITY


804 
num_£curôy_x©ås
++;

811 
nblocks
 +
num_£curôy_x©ås
 *

812 
	`__pxt4_x©å_£t_¸edôs
(
sb
, 
NULL
 ,

813 
NULL
 , 1024,

814 
åue
 );

817 i‡(
í¸y±
)

818 
nblocks
 +
	`__pxt4_x©å_£t_¸edôs
(
sb
,

819 
NULL
 , NULL ,

820 
FSCRYPT_SET_CONTEXT_MAX_SIZE
,

821 
åue
 );

824 
ngroups
 = 
	`pxt4_gë_groups_cou¡
(
sb
);

825 
	`åa˚_pxt4_ªque°_öode
(
dú
, 
mode
);

826 
öode
 = 
	`√w_öode
(
sb
);

827 i‡(!
öode
)

828  
	`ERR_PTR
(-
ENOMEM
);

829 
ei
 = 
	`PXT4_I
(
öode
);

836 i‡(
ow√r
) {

837 
öode
->
i_mode
 = 
mode
;

838 
	`i_uid_wrôe
(
öode
, 
ow√r
[0]);

839 
	`i_gid_wrôe
(
öode
, 
ow√r
[1]);

840 } i‡(
	`ã°_›t
(
sb
, 
GRPID
)) {

841 
öode
->
i_mode
 = 
mode
;

842 
öode
->
i_uid
 = 
	`cuºít_fsuid
();

843 
öode
->
i_gid
 = 
dú
->i_gid;

845 
	`öode_öô_ow√r
(
öode
, 
dú
, 
mode
);

847 i‡(
	`pxt4_has_„©uª_¥oje˘
(
sb
) &&

848 
	`pxt4_ã°_öode_Êag
(
dú
, 
PXT4_INODE_PROJINHERIT
))

849 
ei
->
i_¥ojid
 = 
	`PXT4_I
(
dú
)->i_projid;

851 
ei
->
i_¥ojid
 = 
	`make_k¥ojid
(&
öô_u£r_ns
, 
PXT4_DEF_PROJID
);

853 
îr
 = 
	`dquŸ_öôülize
(
öode
);

854 i‡(
îr
)

855 
out
;

857 i‡(!
gﬂl
)

858 
gﬂl
 = 
sbi
->
s_öode_gﬂl
;

860 i‡(
gﬂl
 && gﬂ»<
	`À32_to_˝u
(
sbi
->
s_es
->
s_öodes_cou¡
)) {

861 
group
 = (
gﬂl
 - 1Ë/ 
	`PXT4_INODES_PER_GROUP
(
sb
);

862 
öo
 = (
gﬂl
 - 1Ë% 
	`PXT4_INODES_PER_GROUP
(
sb
);

863 
ªt2
 = 0;

864 
gŸ_group
;

867 i‡(
	`S_ISDIR
(
mode
))

868 
ªt2
 = 
	`föd_group_‹lov
(
sb
, 
dú
, &
group
, 
mode
, 
q°r
);

870 
ªt2
 = 
	`föd_group_Ÿhî
(
sb
, 
dú
, &
group
, 
mode
);

872 
gŸ_group
:

873 
	`PXT4_I
(
dú
)->
i_œ°_Æloc_group
 = 
group
;

874 
îr
 = -
ENOSPC
;

875 i‡(
ªt2
 == -1)

876 
out
;

883 
i
 = 0; i < 
ngroups
; i++, 
öo
 = 0) {

884 
îr
 = -
EIO
;

886 
gdp
 = 
	`pxt4_gë_group_desc
(
sb
, 
group
, &
group_desc_bh
);

887 i‡(!
gdp
)

888 
out
;

893 i‡(
	`pxt4_‰ì_öodes_cou¡
(
sb
, 
gdp
) == 0)

894 
√xt_group
;

896 
gΩ
 = 
	`pxt4_gë_group_öfo
(
sb
, 
group
);

898 i‡(
	`PXT4_MB_GRP_IBITMAP_CORRUPT
(
gΩ
))

899 
√xt_group
;

901 
	`bªl£
(
öode_bôm≠_bh
);

902 
öode_bôm≠_bh
 = 
	`pxt4_ªad_öode_bôm≠
(
sb
, 
group
);

904 i‡(
	`PXT4_MB_GRP_IBITMAP_CORRUPT
(
gΩ
) ||

905 
	`IS_ERR
(
öode_bôm≠_bh
)) {

906 
öode_bôm≠_bh
 = 
NULL
;

907 
√xt_group
;

910 
ª≥©_ö_this_group
:

911 
ªt2
 = 
	`föd_öode_bô
(
sb
, 
group
, 
öode_bôm≠_bh
, &
öo
);

912 i‡(!
ªt2
)

913 
√xt_group
;

915 i‡(
group
 =0 && (
öo
 + 1Ë< 
	`PXT4_FIRST_INO
(
sb
)) {

916 
	`pxt4_îr‹
(
sb
, "reserved inode found cleared - "

917 "öode=%lu", 
öo
 + 1);

918 
	`pxt4_m¨k_group_bôm≠_c‹ru±ed
(
sb
, 
group
,

919 
PXT4_GROUP_INFO_IBITMAP_CORRUPT
);

920 
√xt_group
;

923 i‡(!
h™dÀ
) {

924 
	`BUG_ON
(
nblocks
 <= 0);

925 
h™dÀ
 = 
	`__pxt4_jou∫Æ_°¨t_sb
(
dú
->
i_sb
, 
löe_no
,

926 
h™dÀ_ty≥
, 
nblocks
,

928 i‡(
	`IS_ERR
(
h™dÀ
)) {

929 
îr
 = 
	`PTR_ERR
(
h™dÀ
);

930 
	`pxt4_°d_îr‹
(
sb
, 
îr
);

931 
out
;

934 
	`BUFFER_TRACE
(
öode_bôm≠_bh
, "get_write_access");

935 
îr
 = 
	`pxt4_jou∫Æ_gë_wrôe_ac˚ss
(
h™dÀ
, 
öode_bôm≠_bh
);

936 i‡(
îr
) {

937 
	`pxt4_°d_îr‹
(
sb
, 
îr
);

938 
out
;

940 
	`pxt4_lock_group
(
sb
, 
group
);

941 
ªt2
 = 
	`pxt4_ã°_™d_£t_bô
(
öo
, 
öode_bôm≠_bh
->
b_d©a
);

942 i‡(
ªt2
) {

946 
ªt2
 = 
	`föd_öode_bô
(
sb
, 
group
, 
öode_bôm≠_bh
, &
öo
);

947 i‡(
ªt2
) {

948 
	`pxt4_£t_bô
(
öo
, 
öode_bôm≠_bh
->
b_d©a
);

949 
ªt2
 = 0;

951 
ªt2
 = 1;

954 
	`pxt4_u∆ock_group
(
sb
, 
group
);

955 
öo
++;

956 i‡(!
ªt2
)

957 
gŸ
;

959 i‡(
öo
 < 
	`PXT4_INODES_PER_GROUP
(
sb
))

960 
ª≥©_ö_this_group
;

961 
√xt_group
:

962 i‡(++
group
 =
ngroups
)

963 
group
 = 0;

965 
îr
 = -
ENOSPC
;

966 
out
;

968 
gŸ
:

969 
	`BUFFER_TRACE
(
öode_bôm≠_bh
, "callÖxt4_handle_dirty_metadata");

970 
îr
 = 
	`pxt4_h™dÀ_dúty_mëad©a
(
h™dÀ
, 
NULL
, 
öode_bôm≠_bh
);

971 i‡(
îr
) {

972 
	`pxt4_°d_îr‹
(
sb
, 
îr
);

973 
out
;

976 
	`BUFFER_TRACE
(
group_desc_bh
, "get_write_access");

977 
îr
 = 
	`pxt4_jou∫Æ_gë_wrôe_ac˚ss
(
h™dÀ
, 
group_desc_bh
);

978 i‡(
îr
) {

979 
	`pxt4_°d_îr‹
(
sb
, 
îr
);

980 
out
;

984 i‡(
	`pxt4_has_group_desc_csum
(
sb
) &&

985 
gdp
->
bg_Êags
 & 
	`˝u_to_À16
(
PXT4_BG_BLOCK_UNINIT
)) {

986 
buf„r_hód
 *
block_bôm≠_bh
;

988 
block_bôm≠_bh
 = 
	`pxt4_ªad_block_bôm≠
(
sb
, 
group
);

989 i‡(
	`IS_ERR
(
block_bôm≠_bh
)) {

990 
îr
 = 
	`PTR_ERR
(
block_bôm≠_bh
);

991 
out
;

993 
	`BUFFER_TRACE
(
block_bôm≠_bh
, "get block bitmapáccess");

994 
îr
 = 
	`pxt4_jou∫Æ_gë_wrôe_ac˚ss
(
h™dÀ
, 
block_bôm≠_bh
);

995 i‡(
îr
) {

996 
	`bªl£
(
block_bôm≠_bh
);

997 
	`pxt4_°d_îr‹
(
sb
, 
îr
);

998 
out
;

1001 
	`BUFFER_TRACE
(
block_bôm≠_bh
, "dirty block bitmap");

1002 
îr
 = 
	`pxt4_h™dÀ_dúty_mëad©a
(
h™dÀ
, 
NULL
, 
block_bôm≠_bh
);

1005 
	`pxt4_lock_group
(
sb
, 
group
);

1006 i‡(
	`pxt4_has_group_desc_csum
(
sb
) &&

1007 (
gdp
->
bg_Êags
 & 
	`˝u_to_À16
(
PXT4_BG_BLOCK_UNINIT
))) {

1008 
gdp
->
bg_Êags
 &
	`˝u_to_À16
(~
PXT4_BG_BLOCK_UNINIT
);

1009 
	`pxt4_‰ì_group_˛u°îs_£t
(
sb
, 
gdp
,

1010 
	`pxt4_‰ì_˛u°îs_a·î_öô
(
sb
, 
group
, 
gdp
));

1011 
	`pxt4_block_bôm≠_csum_£t
(
sb
, 
group
, 
gdp
,

1012 
block_bôm≠_bh
);

1013 
	`pxt4_group_desc_csum_£t
(
sb
, 
group
, 
gdp
);

1015 
	`pxt4_u∆ock_group
(
sb
, 
group
);

1016 
	`bªl£
(
block_bôm≠_bh
);

1018 i‡(
îr
) {

1019 
	`pxt4_°d_îr‹
(
sb
, 
îr
);

1020 
out
;

1025 i‡(
	`pxt4_has_group_desc_csum
(
sb
)) {

1026 
‰ì
;

1027 
pxt4_group_öfo
 *
gΩ
 = 
	`pxt4_gë_group_öfo
(
sb
, 
group
);

1029 
	`down_ªad
(&
gΩ
->
Æloc_£m
);

1030 
	`pxt4_lock_group
(
sb
, 
group
);

1031 
‰ì
 = 
	`PXT4_INODES_PER_GROUP
(
sb
) -

1032 
	`pxt4_ôabÀ_unu£d_cou¡
(
sb
, 
gdp
);

1033 i‡(
gdp
->
bg_Êags
 & 
	`˝u_to_À16
(
PXT4_BG_INODE_UNINIT
)) {

1034 
gdp
->
bg_Êags
 &
	`˝u_to_À16
(~
PXT4_BG_INODE_UNINIT
);

1035 
‰ì
 = 0;

1042 i‡(
öo
 > 
‰ì
)

1043 
	`pxt4_ôabÀ_unu£d_£t
(
sb
, 
gdp
,

1044 (
	`PXT4_INODES_PER_GROUP
(
sb
Ë- 
öo
));

1045 
	`up_ªad
(&
gΩ
->
Æloc_£m
);

1047 
	`pxt4_lock_group
(
sb
, 
group
);

1050 
	`pxt4_‰ì_öodes_£t
(
sb
, 
gdp
, 
	`pxt4_‰ì_öodes_cou¡
(sb, gdp) - 1);

1051 i‡(
	`S_ISDIR
(
mode
)) {

1052 
	`pxt4_u£d_dús_£t
(
sb
, 
gdp
, 
	`pxt4_u£d_dús_cou¡
(sb, gdp) + 1);

1053 i‡(
sbi
->
s_log_groups_≥r_Êex
) {

1054 
pxt4_group_t
 
f
 = 
	`pxt4_Êex_group
(
sbi
, 
group
);

1056 
	`©omic_öc
(&
	`sbi_¨øy_rcu_dîef
(
sbi
, 
s_Êex_groups
,

1057 
f
)->
u£d_dús
);

1060 i‡(
	`pxt4_has_group_desc_csum
(
sb
)) {

1061 
	`pxt4_öode_bôm≠_csum_£t
(
sb
, 
group
, 
gdp
, 
öode_bôm≠_bh
,

1062 
	`PXT4_INODES_PER_GROUP
(
sb
) / 8);

1063 
	`pxt4_group_desc_csum_£t
(
sb
, 
group
, 
gdp
);

1065 
	`pxt4_u∆ock_group
(
sb
, 
group
);

1067 
	`BUFFER_TRACE
(
group_desc_bh
, "callÖxt4_handle_dirty_metadata");

1068 
îr
 = 
	`pxt4_h™dÀ_dúty_mëad©a
(
h™dÀ
, 
NULL
, 
group_desc_bh
);

1069 i‡(
îr
) {

1070 
	`pxt4_°d_îr‹
(
sb
, 
îr
);

1071 
out
;

1074 
	`≥r˝u_cou¡î_dec
(&
sbi
->
s_‰ìöodes_cou¡î
);

1075 i‡(
	`S_ISDIR
(
mode
))

1076 
	`≥r˝u_cou¡î_öc
(&
sbi
->
s_dús_cou¡î
);

1078 i‡(
sbi
->
s_log_groups_≥r_Êex
) {

1079 
Êex_group
 = 
	`pxt4_Êex_group
(
sbi
, 
group
);

1080 
	`©omic_dec
(&
	`sbi_¨øy_rcu_dîef
(
sbi
, 
s_Êex_groups
,

1081 
Êex_group
)->
‰ì_öodes
);

1084 
öode
->
i_öo
 = 
öo
 + 
group
 * 
	`PXT4_INODES_PER_GROUP
(
sb
);

1086 
öode
->
i_blocks
 = 0;

1087 
öode
->
i_mtime
 = inode->
i_©ime
 = inode->
i_˘ime
 = 
	`cuºít_time
(inode);

1088 
ei
->
i_¸time
 = 
öode
->
i_mtime
;

1090 
	`mem£t
(
ei
->
i_d©a
, 0, (ei->i_data));

1091 
ei
->
i_dú_°¨t_lookup
 = 0;

1092 
ei
->
i_disksize
 = 0;

1095 
ei
->
i_Êags
 =

1096 
	`pxt4_mask_Êags
(
mode
, 
	`PXT4_I
(
dú
)->
i_Êags
 & 
PXT4_FL_INHERITED
);

1097 
ei
->
i_Êags
 |= i_flags;

1098 
ei
->
i_fûe_a˛
 = 0;

1099 
ei
->
i_dtime
 = 0;

1100 
ei
->
i_block_group
 = 
group
;

1101 
ei
->
i_œ°_Æloc_group
 = ~0;

1103 
	`pxt4_£t_öode_Êags
(
öode
);

1104 i‡(
	`IS_DIRSYNC
(
öode
))

1105 
	`pxt4_h™dÀ_sync
(
h™dÀ
);

1106 i‡(
	`ö£π_öode_locked
(
öode
) < 0) {

1111 
îr
 = -
EIO
;

1112 
	`pxt4_îr‹
(
sb
, "failedÅo insert inode %lu: doublyállocated?",

1113 
öode
->
i_öo
);

1114 
	`pxt4_m¨k_group_bôm≠_c‹ru±ed
(
sb
, 
group
,

1115 
PXT4_GROUP_INFO_IBITMAP_CORRUPT
);

1116 
out
;

1118 
öode
->
i_gíî©i⁄
 = 
	`¥™dom_u32
();

1121 i‡(
	`pxt4_has_mëad©a_csum
(
sb
)) {

1122 
__u32
 
csum
;

1123 
__À32
 
öum
 = 
	`˝u_to_À32
(
öode
->
i_öo
);

1124 
__À32
 
gí
 = 
	`˝u_to_À32
(
öode
->
i_gíî©i⁄
);

1125 
csum
 = 
	`pxt4_chksum
(
sbi
, sbi->
s_csum_£ed
, (
__u8
 *)&
öum
,

1126 (
öum
));

1127 
ei
->
i_csum_£ed
 = 
	`pxt4_chksum
(
sbi
, 
csum
, (
__u8
 *)&
gí
,

1128 (
gí
));

1131 
	`pxt4_˛ór_°©e_Êags
(
ei
);

1132 
	`pxt4_£t_öode_°©e
(
öode
, 
PXT4_STATE_NEW
);

1134 
ei
->
i_exåa_isize
 = 
sbi
->
s_w™t_exåa_isize
;

1135 
ei
->
i_ölöe_off
 = 0;

1136 i‡(
	`pxt4_has_„©uª_ölöe_d©a
(
sb
))

1137 
	`pxt4_£t_öode_°©e
(
öode
, 
PXT4_STATE_MAY_INLINE_DATA
);

1138 
ªt
 = 
öode
;

1139 
îr
 = 
	`dquŸ_Æloc_öode
(
öode
);

1140 i‡(
îr
)

1141 
Áû_dr›
;

1148 i‡(
í¸y±
) {

1149 
îr
 = 
	`fs¸y±_öhîô_c⁄ãxt
(
dú
, 
öode
, 
h™dÀ
, 
åue
);

1150 i‡(
îr
)

1151 
Áû_‰ì_dr›
;

1154 i‡(!(
ei
->
i_Êags
 & 
PXT4_EA_INODE_FL
)) {

1155 
îr
 = 
	`pxt4_öô_a˛
(
h™dÀ
, 
öode
, 
dú
);

1156 i‡(
îr
)

1157 
Áû_‰ì_dr›
;

1159 
îr
 = 
	`pxt4_öô_£curôy
(
h™dÀ
, 
öode
, 
dú
, 
q°r
);

1160 i‡(
îr
)

1161 
Áû_‰ì_dr›
;

1164 i‡(
	`pxt4_has_„©uª_exã¡s
(
sb
)) {

1166 i‡(
	`S_ISDIR
(
mode
Ë|| 
	`S_ISREG
(modeË|| 
	`S_ISLNK
(mode)) {

1167 
	`pxt4_£t_öode_Êag
(
öode
, 
PXT4_INODE_EXTENTS
);

1168 
	`pxt4_ext_åì_öô
(
h™dÀ
, 
öode
);

1172 i‡(
	`pxt4_h™dÀ_vÆid
(
h™dÀ
)) {

1173 
ei
->
i_sync_tid
 = 
h™dÀ
->
h_å™ß˘i⁄
->
t_tid
;

1174 
ei
->
i_d©async_tid
 = 
h™dÀ
->
h_å™ß˘i⁄
->
t_tid
;

1177 
îr
 = 
	`pxt4_m¨k_öode_dúty
(
h™dÀ
, 
öode
);

1178 i‡(
îr
) {

1179 
	`pxt4_°d_îr‹
(
sb
, 
îr
);

1180 
Áû_‰ì_dr›
;

1183 
	`pxt4_debug
("Æloˇtög inodê%lu\n", 
öode
->
i_öo
);

1184 
	`åa˚_pxt4_Æloˇã_öode
(
öode
, 
dú
, 
mode
);

1185 
	`bªl£
(
öode_bôm≠_bh
);

1186  
ªt
;

1188 
Áû_‰ì_dr›
:

1189 
	`dquŸ_‰ì_öode
(
öode
);

1190 
Áû_dr›
:

1191 
	`˛ór_∆ök
(
öode
);

1192 
	`u∆ock_√w_öode
(
öode
);

1193 
out
:

1194 
	`dquŸ_dr›
(
öode
);

1195 
öode
->
i_Êags
 |
S_NOQUOTA
;

1196 
	`ùut
(
öode
);

1197 
	`bªl£
(
öode_bôm≠_bh
);

1198  
	`ERR_PTR
(
îr
);

1199 
	}
}

1202 
öode
 *
	$pxt4_‹ph™_gë
(
su≥r_block
 *
sb
, 
öo
)

1204 
max_öo
 = 
	`À32_to_˝u
(
	`PXT4_SB
(
sb
)->
s_es
->
s_öodes_cou¡
);

1205 
pxt4_group_t
 
block_group
;

1206 
bô
;

1207 
buf„r_hód
 *
bôm≠_bh
 = 
NULL
;

1208 
öode
 *öodê
NULL
;

1209 
îr
 = -
EFSCORRUPTED
;

1211 i‡(
öo
 < 
	`PXT4_FIRST_INO
(
sb
Ë|| inÿ> 
max_öo
)

1212 
bad_‹ph™
;

1214 
block_group
 = (
öo
 - 1Ë/ 
	`PXT4_INODES_PER_GROUP
(
sb
);

1215 
bô
 = (
öo
 - 1Ë% 
	`PXT4_INODES_PER_GROUP
(
sb
);

1216 
bôm≠_bh
 = 
	`pxt4_ªad_öode_bôm≠
(
sb
, 
block_group
);

1217 i‡(
	`IS_ERR
(
bôm≠_bh
))

1218  
	`ERR_CAST
(
bôm≠_bh
);

1224 i‡(!
	`pxt4_ã°_bô
(
bô
, 
bôm≠_bh
->
b_d©a
))

1225 
bad_‹ph™
;

1227 
öode
 = 
	`pxt4_igë
(
sb
, 
öo
, 
PXT4_IGET_NORMAL
);

1228 i‡(
	`IS_ERR
(
öode
)) {

1229 
îr
 = 
	`PTR_ERR
(
öode
);

1230 
	`pxt4_îr‹
(
sb
, "couldn'tÑead orphan inode %lu (err %d)",

1231 
öo
, 
îr
);

1232  
öode
;

1241 i‡((
öode
->
i_∆ök
 && !
	`pxt4_ˇn_åunˇã
(inode)) ||

1242 
	`is_bad_öode
(
öode
))

1243 
bad_‹ph™
;

1245 i‡(
	`NEXT_ORPHAN
(
öode
Ë> 
max_öo
)

1246 
bad_‹ph™
;

1247 
	`bªl£
(
bôm≠_bh
);

1248  
öode
;

1250 
bad_‹ph™
:

1251 
	`pxt4_îr‹
(
sb
, "bad oΩh™ inodê%lu", 
öo
);

1252 i‡(
bôm≠_bh
)

1253 
	`¥ötk
(
KERN_ERR
 "pxt4_test_bit(bit=%d, block=%llu) = %d\n",

1254 
bô
, ()
bôm≠_bh
->
b_blockƒ
,

1255 
	`pxt4_ã°_bô
(
bô
, 
bôm≠_bh
->
b_d©a
));

1256 i‡(
öode
) {

1257 
	`¥ötk
(
KERN_ERR
 "is_bad_inode(inode)=%d\n",

1258 
	`is_bad_öode
(
öode
));

1259 
	`¥ötk
(
KERN_ERR
 "NEXT_ORPHAN(inode)=%u\n",

1260 
	`NEXT_ORPHAN
(
öode
));

1261 
	`¥ötk
(
KERN_ERR
 "max_öo=%lu\n", 
max_öo
);

1262 
	`¥ötk
(
KERN_ERR
 "i_∆ök=%u\n", 
öode
->
i_∆ök
);

1264 i‡(
öode
->
i_∆ök
 == 0)

1265 
öode
->
i_blocks
 = 0;

1266 
	`ùut
(
öode
);

1268 
	`bªl£
(
bôm≠_bh
);

1269  
	`ERR_PTR
(
îr
);

1270 
	}
}

1272 
	$pxt4_cou¡_‰ì_öodes
(
su≥r_block
 *
sb
)

1274 
desc_cou¡
;

1275 
pxt4_group_desc
 *
gdp
;

1276 
pxt4_group_t
 
i
, 
ngroups
 = 
	`pxt4_gë_groups_cou¡
(
sb
);

1277 #ifde‡
PXT4FS_DEBUG


1278 
pxt4_su≥r_block
 *
es
;

1279 
bôm≠_cou¡
, 
x
;

1280 
buf„r_hód
 *
bôm≠_bh
 = 
NULL
;

1282 
es
 = 
	`PXT4_SB
(
sb
)->
s_es
;

1283 
desc_cou¡
 = 0;

1284 
bôm≠_cou¡
 = 0;

1285 
gdp
 = 
NULL
;

1286 
i
 = 0; i < 
ngroups
; i++) {

1287 
gdp
 = 
	`pxt4_gë_group_desc
(
sb
, 
i
, 
NULL
);

1288 i‡(!
gdp
)

1290 
desc_cou¡
 +
	`pxt4_‰ì_öodes_cou¡
(
sb
, 
gdp
);

1291 
	`bªl£
(
bôm≠_bh
);

1292 
bôm≠_bh
 = 
	`pxt4_ªad_öode_bôm≠
(
sb
, 
i
);

1293 i‡(
	`IS_ERR
(
bôm≠_bh
)) {

1294 
bôm≠_bh
 = 
NULL
;

1298 
x
 = 
	`pxt4_cou¡_‰ì
(
bôm≠_bh
->
b_d©a
,

1299 
	`PXT4_INODES_PER_GROUP
(
sb
) / 8);

1300 
	`¥ötk
(
KERN_DEBUG
 "group %lu: stored = %d, counted = %lu\n",

1301 (Ë
i
, 
	`pxt4_‰ì_öodes_cou¡
(
sb
, 
gdp
), 
x
);

1302 
bôm≠_cou¡
 +
x
;

1304 
	`bªl£
(
bôm≠_bh
);

1305 
	`¥ötk
(
KERN_DEBUG
 "pxt4_count_free_inodes: "

1307 
	`À32_to_˝u
(
es
->
s_‰ì_öodes_cou¡
), 
desc_cou¡
, 
bôm≠_cou¡
);

1308  
desc_cou¡
;

1310 
desc_cou¡
 = 0;

1311 
i
 = 0; i < 
ngroups
; i++) {

1312 
gdp
 = 
	`pxt4_gë_group_desc
(
sb
, 
i
, 
NULL
);

1313 i‡(!
gdp
)

1315 
desc_cou¡
 +
	`pxt4_‰ì_öodes_cou¡
(
sb
, 
gdp
);

1316 
	`c⁄d_ªsched
();

1318  
desc_cou¡
;

1320 
	}
}

1323 
	$pxt4_cou¡_dús
(
su≥r_block
 * 
sb
)

1325 
cou¡
 = 0;

1326 
pxt4_group_t
 
i
, 
ngroups
 = 
	`pxt4_gë_groups_cou¡
(
sb
);

1328 
i
 = 0; i < 
ngroups
; i++) {

1329 
pxt4_group_desc
 *
gdp
 = 
	`pxt4_gë_group_desc
(
sb
, 
i
, 
NULL
);

1330 i‡(!
gdp
)

1332 
cou¡
 +
	`pxt4_u£d_dús_cou¡
(
sb
, 
gdp
);

1334  
cou¡
;

1335 
	}
}

1345 
	$pxt4_öô_öode_èbÀ
(
su≥r_block
 *
sb
, 
pxt4_group_t
 
group
,

1346 
b¨rõr
)

1348 
pxt4_group_öfo
 *
gΩ
 = 
	`pxt4_gë_group_öfo
(
sb
, 
group
);

1349 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
sb
);

1350 
pxt4_group_desc
 *
gdp
 = 
NULL
;

1351 
buf„r_hód
 *
group_desc_bh
;

1352 
h™dÀ_t
 *
h™dÀ
;

1353 
pxt4_fsblk_t
 
blk
;

1354 
num
, 
ªt
 = 0, 
u£d_blks
 = 0;

1355 
u£d_öos
 = 0;

1358 i‡(
	`sb_rd⁄ly
(
sb
)) {

1359 
ªt
 = 1;

1360 
out
;

1363 
gdp
 = 
	`pxt4_gë_group_desc
(
sb
, 
group
, &
group_desc_bh
);

1364 i‡(!
gdp
)

1365 
out
;

1371 i‡(
gdp
->
bg_Êags
 & 
	`˝u_to_À16
(
PXT4_BG_INODE_ZEROED
))

1372 
out
;

1374 
h™dÀ
 = 
	`pxt4_jou∫Æ_°¨t_sb
(
sb
, 
PXT4_HT_MISC
, 1);

1375 i‡(
	`IS_ERR
(
h™dÀ
)) {

1376 
ªt
 = 
	`PTR_ERR
(
h™dÀ
);

1377 
out
;

1380 
	`down_wrôe
(&
gΩ
->
Æloc_£m
);

1386 i‡(!(
gdp
->
bg_Êags
 & 
	`˝u_to_À16
(
PXT4_BG_INODE_UNINIT
))) {

1387 
u£d_öos
 = 
	`PXT4_INODES_PER_GROUP
(
sb
) -

1388 
	`pxt4_ôabÀ_unu£d_cou¡
(
sb
, 
gdp
);

1389 
u£d_blks
 = 
	`DIV_ROUND_UP
(
u£d_öos
, 
sbi
->
s_öodes_≥r_block
);

1392 i‡(
u£d_blks
 < 0 || u£d_blk†> 
sbi
->
s_ôb_≥r_group
) {

1393 
	`pxt4_îr‹
(
sb
, "Something is wrong with group %u: "

1396 
group
, 
u£d_blks
,

1397 
	`pxt4_ôabÀ_unu£d_cou¡
(
sb
, 
gdp
));

1398 
ªt
 = 1;

1399 
îr_out
;

1402 
u£d_öos
 +
group
 * 
	`PXT4_INODES_PER_GROUP
(
sb
);

1407 i‡((
u£d_blks
 !
sbi
->
s_ôb_≥r_group
) &&

1408 (
u£d_öos
 < 
	`PXT4_FIRST_INO
(
sb
))) {

1409 
	`pxt4_îr‹
(
sb
, "Something is wrong with group %u: "

1412 
group
, 
	`pxt4_ôabÀ_unu£d_cou¡
(
sb
, 
gdp
),

1413 
u£d_öos
);

1414 
ªt
 = 1;

1415 
îr_out
;

1419 
blk
 = 
	`pxt4_öode_èbÀ
(
sb
, 
gdp
Ë+ 
u£d_blks
;

1420 
num
 = 
sbi
->
s_ôb_≥r_group
 - 
u£d_blks
;

1422 
	`BUFFER_TRACE
(
group_desc_bh
, "get_write_access");

1423 
ªt
 = 
	`pxt4_jou∫Æ_gë_wrôe_ac˚ss
(
h™dÀ
,

1424 
group_desc_bh
);

1425 i‡(
ªt
)

1426 
îr_out
;

1433 i‡(
	`u∆ikñy
(
num
 == 0))

1434 
skù_zîoout
;

1436 
	`pxt4_debug
("goingÅo zero out inodeÅable in group %d\n",

1437 
group
);

1438 
ªt
 = 
	`sb_issue_zîoout
(
sb
, 
blk
, 
num
, 
GFP_NOFS
);

1439 i‡(
ªt
 < 0)

1440 
îr_out
;

1441 i‡(
b¨rõr
)

1442 
	`blkdev_issue_Êush
(
sb
->
s_bdev
, 
GFP_NOFS
, 
NULL
);

1444 
skù_zîoout
:

1445 
	`pxt4_lock_group
(
sb
, 
group
);

1446 
gdp
->
bg_Êags
 |
	`˝u_to_À16
(
PXT4_BG_INODE_ZEROED
);

1447 
	`pxt4_group_desc_csum_£t
(
sb
, 
group
, 
gdp
);

1448 
	`pxt4_u∆ock_group
(
sb
, 
group
);

1450 
	`BUFFER_TRACE
(
group_desc_bh
,

1452 
ªt
 = 
	`pxt4_h™dÀ_dúty_mëad©a
(
h™dÀ
, 
NULL
,

1453 
group_desc_bh
);

1455 
îr_out
:

1456 
	`up_wrôe
(&
gΩ
->
Æloc_£m
);

1457 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

1458 
out
:

1459  
ªt
;

1460 
	}
}

	@indirect.c

24 
	~"pxt4_jbd3.h
"

25 
	~"åunˇã.h
"

26 
	~<löux/dax.h
>

27 
	~<löux/uio.h
>

29 
	~<åa˚/evíts/pxt4.h
>

32 
__À32
 *
	mp
;

33 
__À32
 
	mkey
;

34 
buf„r_hód
 *
	mbh
;

35 } 
	tIndúe˘
;

37 
ölöe
 
	$add_chaö
(
Indúe˘
 *
p
, 
buf„r_hód
 *
bh
, 
__À32
 *
v
)

39 
p
->
key
 = *’->∞
v
);

40 
p
->
bh
 = bh;

41 
	}
}

74 
	$pxt4_block_to_∑th
(
öode
 *inode,

75 
pxt4_lblk_t
 
i_block
,

76 
pxt4_lblk_t
 
off£ts
[4], *
bound¨y
)

78 
±rs
 = 
	`PXT4_ADDR_PER_BLOCK
(
öode
->
i_sb
);

79 
±rs_bôs
 = 
	`PXT4_ADDR_PER_BLOCK_BITS
(
öode
->
i_sb
);

80 c⁄° 
dúe˘_blocks
 = 
PXT4_NDIR_BLOCKS
,

81 
ödúe˘_blocks
 = 
±rs
,

82 
doubÀ_blocks
 = (1 << (
±rs_bôs
 * 2));

83 
n
 = 0;

84 
föÆ
 = 0;

86 i‡(
i_block
 < 
dúe˘_blocks
) {

87 
off£ts
[
n
++] = 
i_block
;

88 
föÆ
 = 
dúe˘_blocks
;

89 } i‡((
i_block
 -
dúe˘_blocks
Ë< 
ödúe˘_blocks
) {

90 
off£ts
[
n
++] = 
PXT4_IND_BLOCK
;

91 
off£ts
[
n
++] = 
i_block
;

92 
föÆ
 = 
±rs
;

93 } i‡((
i_block
 -
ödúe˘_blocks
Ë< 
doubÀ_blocks
) {

94 
off£ts
[
n
++] = 
PXT4_DIND_BLOCK
;

95 
off£ts
[
n
++] = 
i_block
 >> 
±rs_bôs
;

96 
off£ts
[
n
++] = 
i_block
 & (
±rs
 - 1);

97 
föÆ
 = 
±rs
;

98 } i‡(((
i_block
 -
doubÀ_blocks
Ë>> (
±rs_bôs
 * 2)Ë< 
±rs
) {

99 
off£ts
[
n
++] = 
PXT4_TIND_BLOCK
;

100 
off£ts
[
n
++] = 
i_block
 >> (
±rs_bôs
 * 2);

101 
off£ts
[
n
++] = (
i_block
 >> 
±rs_bôs
Ë& (
±rs
 - 1);

102 
off£ts
[
n
++] = 
i_block
 & (
±rs
 - 1);

103 
föÆ
 = 
±rs
;

105 
	`pxt4_w¨nög
(
öode
->
i_sb
, "block %lu > max in inode %lu",

106 
i_block
 + 
dúe˘_blocks
 +

107 
ödúe˘_blocks
 + 
doubÀ_blocks
, 
öode
->
i_öo
);

109 i‡(
bound¨y
)

110 *
bound¨y
 = 
föÆ
 - 1 - (
i_block
 & (
±rs
 - 1));

111  
n
;

112 
	}
}

144 
Indúe˘
 *
	$pxt4_gë_bønch
(
öode
 *öode, 
dïth
,

145 
pxt4_lblk_t
 *
off£ts
,

146 
Indúe˘
 
chaö
[4], *
îr
)

148 
su≥r_block
 *
sb
 = 
öode
->
i_sb
;

149 
Indúe˘
 *
p
 = 
chaö
;

150 
buf„r_hód
 *
bh
;

151 
ªt
 = -
EIO
;

153 *
îr
 = 0;

155 
	`add_chaö
(
chaö
, 
NULL
, 
	`PXT4_I
(
öode
)->
i_d©a
 + *
off£ts
);

156 i‡(!
p
->
key
)

157 
no_block
;

158 --
dïth
) {

159 
bh
 = 
	`sb_gëblk
(
sb
, 
	`À32_to_˝u
(
p
->
key
));

160 i‡(
	`u∆ikñy
(!
bh
)) {

161 
ªt
 = -
ENOMEM
;

162 
Áûuª
;

165 i‡(!
	`bh_u±od©e_‹_lock
(
bh
)) {

166 i‡(
	`bh_submô_ªad
(
bh
) < 0) {

167 
	`put_bh
(
bh
);

168 
Áûuª
;

171 i‡(
	`pxt4_check_ödúe˘_blockªf
(
öode
, 
bh
)) {

172 
	`put_bh
(
bh
);

173 
Áûuª
;

177 
	`add_chaö
(++
p
, 
bh
, (
__À32
 *)bh->
b_d©a
 + *++
off£ts
);

179 i‡(!
p
->
key
)

180 
no_block
;

182  
NULL
;

184 
Áûuª
:

185 *
îr
 = 
ªt
;

186 
no_block
:

187  
p
;

188 
	}
}

210 
pxt4_fsblk_t
 
	$pxt4_föd_√¨
(
öode
 *öode, 
Indúe˘
 *
öd
)

212 
pxt4_öode_öfo
 *
ei
 = 
	`PXT4_I
(
öode
);

213 
__À32
 *
°¨t
 = 
öd
->
bh
 ? (__À32 *Ëöd->bh->
b_d©a
 : 
ei
->
i_d©a
;

214 
__À32
 *
p
;

217 
p
 = 
öd
->∞- 1;Ö >
°¨t
;Ö--) {

218 i‡(*
p
)

219  
	`À32_to_˝u
(*
p
);

223 i‡(
öd
->
bh
)

224  
öd
->
bh
->
b_blockƒ
;

230  
	`pxt4_öode_to_gﬂl_block
(
öode
);

231 
	}
}

244 
pxt4_fsblk_t
 
	$pxt4_föd_gﬂl
(
öode
 *öode, 
pxt4_lblk_t
 
block
,

245 
Indúe˘
 *
∑πül
)

247 
pxt4_fsblk_t
 
gﬂl
;

253 
gﬂl
 = 
	`pxt4_föd_√¨
(
öode
, 
∑πül
);

254 
gﬂl
 = gﬂ»& 
PXT4_MAX_BLOCK_FILE_PHYS
;

255  
gﬂl
;

256 
	}
}

270 
	$pxt4_blks_to_Æloˇã
(
Indúe˘
 *
bønch
, 
k
, 
blks
,

271 
blocks_to_bound¨y
)

273 
cou¡
 = 0;

279 i‡(
k
 > 0) {

281 i‡(
blks
 < 
blocks_to_bound¨y
 + 1)

282 
cou¡
 +
blks
;

284 
cou¡
 +
blocks_to_bound¨y
 + 1;

285  
cou¡
;

288 
cou¡
++;

289 
cou¡
 < 
blks
 && cou¡ <
blocks_to_bound¨y
 &&

290 
	`À32_to_˝u
(*(
bønch
[0].
p
 + 
cou¡
)) == 0) {

291 
cou¡
++;

293  
cou¡
;

294 
	}
}

321 
	$pxt4_Æloc_bønch
(
h™dÀ_t
 *
h™dÀ
,

322 
pxt4_Æloˇti⁄_ªque°
 *
¨
,

323 
ödúe˘_blks
, 
pxt4_lblk_t
 *
off£ts
,

324 
Indúe˘
 *
bønch
)

326 
buf„r_hód
 * 
bh
;

327 
pxt4_fsblk_t
 
b
, 
√w_blocks
[4];

328 
__À32
 *
p
;

329 
i
, 
j
, 
îr
, 
Àn
 = 1;

331 
i
 = 0; i <
ödúe˘_blks
; i++) {

332 i‡(
i
 =
ödúe˘_blks
) {

333 
√w_blocks
[
i
] = 
	`pxt4_mb_√w_blocks
(
h™dÀ
, 
¨
, &
îr
);

335 
¨
->
gﬂl
 = 
√w_blocks
[
i
] = 
	`pxt4_√w_mëa_blocks
(
h™dÀ
,

336 
¨
->
öode
,ár->
gﬂl
,

337 
¨
->
Êags
 & 
PXT4_MB_DELALLOC_RESERVED
,

338 
NULL
, &
îr
);

339 i‡(
îr
) {

340 
i
--;

341 
Áûed
;

343 
bønch
[
i
].
key
 = 
	`˝u_to_À32
(
√w_blocks
[i]);

344 i‡(
i
 == 0)

347 
bh
 = 
bønch
[
i
].bh = 
	`sb_gëblk
(
¨
->
öode
->
i_sb
, 
√w_blocks
[i-1]);

348 i‡(
	`u∆ikñy
(!
bh
)) {

349 
îr
 = -
ENOMEM
;

350 
Áûed
;

352 
	`lock_buf„r
(
bh
);

353 
	`BUFFER_TRACE
(
bh
, "call get_create_access");

354 
îr
 = 
	`pxt4_jou∫Æ_gë_¸óã_ac˚ss
(
h™dÀ
, 
bh
);

355 i‡(
îr
) {

356 
	`u∆ock_buf„r
(
bh
);

357 
Áûed
;

360 
	`mem£t
(
bh
->
b_d©a
, 0, bh->
b_size
);

361 
p
 = 
bønch
[
i
].∞(
__À32
 *Ë
bh
->
b_d©a
 + 
off£ts
[i];

362 
b
 = 
√w_blocks
[
i
];

364 i‡(
i
 =
ödúe˘_blks
)

365 
Àn
 = 
¨
->len;

366 
j
 = 0; j < 
Àn
; j++)

367 *
p
++ = 
	`˝u_to_À32
(
b
++);

369 
	`BUFFER_TRACE
(
bh
, "marking uptodate");

370 
	`£t_buf„r_u±od©e
(
bh
);

371 
	`u∆ock_buf„r
(
bh
);

373 
	`BUFFER_TRACE
(
bh
, "callÖxt4_handle_dirty_metadata");

374 
îr
 = 
	`pxt4_h™dÀ_dúty_mëad©a
(
h™dÀ
, 
¨
->
öode
, 
bh
);

375 i‡(
îr
)

376 
Áûed
;

379 
Áûed
:

380 ; 
i
 >= 0; i--) {

387 i‡(
i
 > 0 && i !
ödúe˘_blks
 && 
bønch
[i].
bh
)

388 
	`pxt4_f‹gë
(
h™dÀ
, 1, 
¨
->
öode
, 
bønch
[
i
].
bh
,

389 
bønch
[
i
].
bh
->
b_blockƒ
);

390 
	`pxt4_‰ì_blocks
(
h™dÀ
, 
¨
->
öode
, 
NULL
, 
√w_blocks
[
i
],

391 (
i
 =
ödúe˘_blks
Ë? 
¨
->
Àn
 : 1, 0);

393  
îr
;

394 
	}
}

407 
	$pxt4_•li˚_bønch
(
h™dÀ_t
 *
h™dÀ
,

408 
pxt4_Æloˇti⁄_ªque°
 *
¨
,

409 
Indúe˘
 *
whîe
, 
num
)

411 
i
;

412 
îr
 = 0;

413 
pxt4_fsblk_t
 
cuºít_block
;

420 i‡(
whîe
->
bh
) {

421 
	`BUFFER_TRACE
(
whîe
->
bh
, "get_write_access");

422 
îr
 = 
	`pxt4_jou∫Æ_gë_wrôe_ac˚ss
(
h™dÀ
, 
whîe
->
bh
);

423 i‡(
îr
)

424 
îr_out
;

428 *
whîe
->
p
 = whîe->
key
;

434 i‡(
num
 =0 && 
¨
->
Àn
 > 1) {

435 
cuºít_block
 = 
	`À32_to_˝u
(
whîe
->
key
) + 1;

436 
i
 = 1; i < 
¨
->
Àn
; i++)

437 *(
whîe
->
p
 + 
i
Ë
	`˝u_to_À32
(
cuºít_block
++);

442 i‡(
whîe
->
bh
) {

451 
	`jbd_debug
(5, "splicing indirect only\n");

452 
	`BUFFER_TRACE
(
whîe
->
bh
, "callÖxt4_handle_dirty_metadata");

453 
îr
 = 
	`pxt4_h™dÀ_dúty_mëad©a
(
h™dÀ
, 
¨
->
öode
, 
whîe
->
bh
);

454 i‡(
îr
)

455 
îr_out
;

460 
	`pxt4_m¨k_öode_dúty
(
h™dÀ
, 
¨
->
öode
);

461 
	`jbd_debug
(5, "splicing direct\n");

463  
îr
;

465 
îr_out
:

466 
i
 = 1; i <
num
; i++) {

472 
	`pxt4_‰ì_blocks
(
h™dÀ
, 
¨
->
öode
, 
whîe
[
i
].
bh
, 0, 1,

473 
PXT4_FREE_BLOCKS_FORGET
);

475 
	`pxt4_‰ì_blocks
(
h™dÀ
, 
¨
->
öode
, 
NULL
, 
	`À32_to_˝u
(
whîe
[
num
].
key
),

476 
¨
->
Àn
, 0);

478  
îr
;

479 
	}
}

509 
	$pxt4_öd_m≠_blocks
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *inode,

510 
pxt4_m≠_blocks
 *
m≠
,

511 
Êags
)

513 
pxt4_Æloˇti⁄_ªque°
 
¨
;

514 
îr
 = -
EIO
;

515 
pxt4_lblk_t
 
off£ts
[4];

516 
Indúe˘
 
chaö
[4];

517 
Indúe˘
 *
∑πül
;

518 
ödúe˘_blks
;

519 
blocks_to_bound¨y
 = 0;

520 
dïth
;

521 
cou¡
 = 0;

522 
pxt4_fsblk_t
 
fú°_block
 = 0;

524 
	`åa˚_pxt4_öd_m≠_blocks_íãr
(
öode
, 
m≠
->
m_lblk
, m≠->
m_Àn
, 
Êags
);

525 
	`J_ASSERT
(!(
	`pxt4_ã°_öode_Êag
(
öode
, 
PXT4_INODE_EXTENTS
)));

526 
	`J_ASSERT
(
h™dÀ
 !
NULL
 || (
Êags
 & 
PXT4_GET_BLOCKS_CREATE
) == 0);

527 
dïth
 = 
	`pxt4_block_to_∑th
(
öode
, 
m≠
->
m_lblk
, 
off£ts
,

528 &
blocks_to_bound¨y
);

530 i‡(
dïth
 == 0)

531 
out
;

533 
∑πül
 = 
	`pxt4_gë_bønch
(
öode
, 
dïth
, 
off£ts
, 
chaö
, &
îr
);

536 i‡(!
∑πül
) {

537 
fú°_block
 = 
	`À32_to_˝u
(
chaö
[
dïth
 - 1].
key
);

538 
cou¡
++;

540 
cou¡
 < 
m≠
->
m_Àn
 && cou¡ <
blocks_to_bound¨y
) {

541 
pxt4_fsblk_t
 
blk
;

543 
blk
 = 
	`À32_to_˝u
(*(
chaö
[
dïth
-1].
p
 + 
cou¡
));

545 i‡(
blk
 =
fú°_block
 + 
cou¡
)

546 
cou¡
++;

550 
gŸ_ô
;

554 i‡((
Êags
 & 
PXT4_GET_BLOCKS_CREATE
) == 0) {

555 
ïb
 = 
öode
->
i_sb
->
s_blocksize
 / (
u32
);

556 
i
;

564 
cou¡
 = 0;

565 
i
 = 
∑πül
 - 
chaö
 + 1; i < 
dïth
; i++)

566 
cou¡
 = cou¡ * 
ïb
 + (ïb - 
off£ts
[
i
] - 1);

567 
cou¡
++;

569 
m≠
->
m_pblk
 = 0;

570 
m≠
->
m_Àn
 = 
	`mö_t
(, m≠->m_Àn, 
cou¡
);

571 
˛ónup
;

575 i‡(
îr
 =-
EIO
)

576 
˛ónup
;

581 i‡(
	`pxt4_has_„©uª_bigÆloc
(
öode
->
i_sb
)) {

582 
	`PXT4_ERROR_INODE
(
öode
, "Can'tállocate blocks for "

584  -
EFSCORRUPTED
;

588 
	`mem£t
(&
¨
, 0, (ar));

589 
¨
.
öode
 = inode;

590 
¨
.
logiˇl
 = 
m≠
->
m_lblk
;

591 i‡(
	`S_ISREG
(
öode
->
i_mode
))

592 
¨
.
Êags
 = 
PXT4_MB_HINT_DATA
;

593 i‡(
Êags
 & 
PXT4_GET_BLOCKS_DELALLOC_RESERVE
)

594 
¨
.
Êags
 |
PXT4_MB_DELALLOC_RESERVED
;

595 i‡(
Êags
 & 
PXT4_GET_BLOCKS_METADATA_NOFAIL
)

596 
¨
.
Êags
 |
PXT4_MB_USE_RESERVED
;

598 
¨
.
gﬂl
 = 
	`pxt4_föd_gﬂl
(
öode
, 
m≠
->
m_lblk
, 
∑πül
);

601 
ödúe˘_blks
 = (
chaö
 + 
dïth
Ë- 
∑πül
 - 1;

607 
¨
.
Àn
 = 
	`pxt4_blks_to_Æloˇã
(
∑πül
, 
ödúe˘_blks
,

608 
m≠
->
m_Àn
, 
blocks_to_bound¨y
);

613 
îr
 = 
	`pxt4_Æloc_bønch
(
h™dÀ
, &
¨
, 
ödúe˘_blks
,

614 
off£ts
 + (
∑πül
 - 
chaö
),Öartial);

623 i‡(!
îr
)

624 
îr
 = 
	`pxt4_•li˚_bønch
(
h™dÀ
, &
¨
, 
∑πül
, 
ödúe˘_blks
);

625 i‡(
îr
)

626 
˛ónup
;

628 
m≠
->
m_Êags
 |
PXT4_MAP_NEW
;

630 
	`pxt4_upd©e_öode_fsync_å™s
(
h™dÀ
, 
öode
, 1);

631 
cou¡
 = 
¨
.
Àn
;

632 
gŸ_ô
:

633 
m≠
->
m_Êags
 |
PXT4_MAP_MAPPED
;

634 
m≠
->
m_pblk
 = 
	`À32_to_˝u
(
chaö
[
dïth
-1].
key
);

635 
m≠
->
m_Àn
 = 
cou¡
;

636 i‡(
cou¡
 > 
blocks_to_bound¨y
)

637 
m≠
->
m_Êags
 |
PXT4_MAP_BOUNDARY
;

638 
îr
 = 
cou¡
;

640 
∑πül
 = 
chaö
 + 
dïth
 - 1;

641 
˛ónup
:

642 
∑πül
 > 
chaö
) {

643 
	`BUFFER_TRACE
(
∑πül
->
bh
, "call brelse");

644 
	`bªl£
(
∑πül
->
bh
);

645 
∑πül
--;

647 
out
:

648 
	`åa˚_pxt4_öd_m≠_blocks_exô
(
öode
, 
Êags
, 
m≠
, 
îr
);

649  
îr
;

650 
	}
}

656 
	$pxt4_öd_ˇlc_mëad©a_amou¡
(
öode
 *öode, 
£˘‹_t
 
lblock
)

658 
pxt4_öode_öfo
 *
ei
 = 
	`PXT4_I
(
öode
);

659 
£˘‹_t
 
död_mask
 = ~((£˘‹_t)
	`PXT4_ADDR_PER_BLOCK
(
öode
->
i_sb
) - 1);

660 
blk_bôs
;

662 i‡(
lblock
 < 
PXT4_NDIR_BLOCKS
)

665 
lblock
 -
PXT4_NDIR_BLOCKS
;

667 i‡(
ei
->
i_da_mëad©a_ˇlc_Àn
 &&

668 (
lblock
 & 
död_mask
Ë=
ei
->
i_da_mëad©a_ˇlc_œ°_lblock
) {

669 
ei
->
i_da_mëad©a_ˇlc_Àn
++;

672 
ei
->
i_da_mëad©a_ˇlc_œ°_lblock
 = 
lblock
 & 
död_mask
;

673 
ei
->
i_da_mëad©a_ˇlc_Àn
 = 1;

674 
blk_bôs
 = 
	`‹dî_ba£_2
(
lblock
);

675  (
blk_bôs
 / 
	`PXT4_ADDR_PER_BLOCK_BITS
(
öode
->
i_sb
)) + 1;

676 
	}
}

682 
	$pxt4_öd_å™s_blocks
(
öode
 *öode, 
ƒblocks
)

689  
	`DIV_ROUND_UP
(
ƒblocks
, 
	`PXT4_ADDR_PER_BLOCK
(
öode
->
i_sb
)) + 4;

690 
	}
}

704 
	$åy_to_exãnd_å™ß˘i⁄
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *inode)

706 i‡(!
	`pxt4_h™dÀ_vÆid
(
h™dÀ
))

708 i‡(
	`pxt4_h™dÀ_has_íough_¸edôs
(
h™dÀ
, 
PXT4_RESERVE_TRANS_BLOCKS
+1))

710 i‡(!
	`pxt4_jou∫Æ_exãnd
(
h™dÀ
, 
	`pxt4_blocks_f‹_åunˇã
(
öode
)))

713 
	}
}

720 
ölöe
 
	$Æl_zî€s
(
__À32
 *
p
, __À32 *
q
)

722 
p
 < 
q
)

723 i‡(*
p
++)

726 
	}
}

763 
Indúe˘
 *
	$pxt4_föd_sh¨ed
(
öode
 *öode, 
dïth
,

764 
pxt4_lblk_t
 
off£ts
[4], 
Indúe˘
 
chaö
[4],

765 
__À32
 *
t›
)

767 
Indúe˘
 *
∑πül
, *
p
;

768 
k
, 
îr
;

770 *
t›
 = 0;

772 
k
 = 
dïth
; k > 1 && !
off£ts
[k-1]; k--)

774 
∑πül
 = 
	`pxt4_gë_bønch
(
öode
, 
k
, 
off£ts
, 
chaö
, &
îr
);

776 i‡(!
∑πül
)

777 
∑πül
 = 
chaö
 + 
k
-1;

782 i‡(!
∑πül
->
key
 && *∑πül->
p
)

784 
no_t›
;

785 
p
 = 
∑πül
; (∞> 
chaö
Ë&& 
	`Æl_zî€s
((
__À32
 *Ëp->
bh
->
b_d©a
,Ö->p);Ö--)

793 i‡(
p
 =
chaö
 + 
k
 - 1 &&Ö > chain) {

794 
p
->p--;

796 *
t›
 = *
p
->p;

799 *
p
->p = 0;

804 
∑πül
 > 
p
) {

805 
	`bªl£
(
∑πül
->
bh
);

806 
∑πül
--;

808 
no_t›
:

809  
∑πül
;

810 
	}
}

823 
	$pxt4_˛ór_blocks
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *inode,

824 
buf„r_hód
 *
bh
,

825 
pxt4_fsblk_t
 
block_to_‰ì
,

826 
cou¡
, 
__À32
 *
fú°
,

827 
__À32
 *
œ°
)

829 
__À32
 *
p
;

830 
Êags
 = 
PXT4_FREE_BLOCKS_VALIDATED
;

831 
îr
;

833 i‡(
	`S_ISDIR
(
öode
->
i_mode
Ë|| 
	`S_ISLNK
(inode->i_mode) ||

834 
	`pxt4_ã°_öode_Êag
(
öode
, 
PXT4_INODE_EA_INODE
))

835 
Êags
 |
PXT4_FREE_BLOCKS_FORGET
 | 
PXT4_FREE_BLOCKS_METADATA
;

836 i‡(
	`pxt4_should_jou∫Æ_d©a
(
öode
))

837 
Êags
 |
PXT4_FREE_BLOCKS_FORGET
;

839 i‡(!
	`pxt4_d©a_block_vÆid
(
	`PXT4_SB
(
öode
->
i_sb
), 
block_to_‰ì
,

840 
cou¡
)) {

841 
	`PXT4_ERROR_INODE
(
öode
, "attemptÅo clear invalid "

843 (Ë
block_to_‰ì
, 
cou¡
);

847 i‡(
	`åy_to_exãnd_å™ß˘i⁄
(
h™dÀ
, 
öode
)) {

848 i‡(
bh
) {

849 
	`BUFFER_TRACE
(
bh
, "callÖxt4_handle_dirty_metadata");

850 
îr
 = 
	`pxt4_h™dÀ_dúty_mëad©a
(
h™dÀ
, 
öode
, 
bh
);

851 i‡(
	`u∆ikñy
(
îr
))

852 
out_îr
;

854 
îr
 = 
	`pxt4_m¨k_öode_dúty
(
h™dÀ
, 
öode
);

855 i‡(
	`u∆ikñy
(
îr
))

856 
out_îr
;

857 
îr
 = 
	`pxt4_åunˇã_ª°¨t_å™s
(
h™dÀ
, 
öode
,

858 
	`pxt4_blocks_f‹_åunˇã
(
öode
));

859 i‡(
	`u∆ikñy
(
îr
))

860 
out_îr
;

861 i‡(
bh
) {

862 
	`BUFFER_TRACE
(
bh
, "retaking writeáccess");

863 
îr
 = 
	`pxt4_jou∫Æ_gë_wrôe_ac˚ss
(
h™dÀ
, 
bh
);

864 i‡(
	`u∆ikñy
(
îr
))

865 
out_îr
;

869 
p
 = 
fú°
;Ö < 
œ°
;Ö++)

870 *
p
 = 0;

872 
	`pxt4_‰ì_blocks
(
h™dÀ
, 
öode
, 
NULL
, 
block_to_‰ì
, 
cou¡
, 
Êags
);

874 
out_îr
:

875 
	`pxt4_°d_îr‹
(
öode
->
i_sb
, 
îr
);

876  
îr
;

877 
	}
}

898 
	$pxt4_‰ì_d©a
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *inode,

899 
buf„r_hód
 *
this_bh
,

900 
__À32
 *
fú°
, __À32 *
œ°
)

902 
pxt4_fsblk_t
 
block_to_‰ì
 = 0;

903 
cou¡
 = 0;

904 
__À32
 *
block_to_‰ì_p
 = 
NULL
;

907 
pxt4_fsblk_t
 
ƒ
;

908 
__À32
 *
p
;

910 
îr
 = 0;

912 i‡(
this_bh
) {

913 
	`BUFFER_TRACE
(
this_bh
, "get_write_access");

914 
îr
 = 
	`pxt4_jou∫Æ_gë_wrôe_ac˚ss
(
h™dÀ
, 
this_bh
);

917 i‡(
îr
)

921 
p
 = 
fú°
;Ö < 
œ°
;Ö++) {

922 
ƒ
 = 
	`À32_to_˝u
(*
p
);

923 i‡(
ƒ
) {

925 i‡(
cou¡
 == 0) {

926 
block_to_‰ì
 = 
ƒ
;

927 
block_to_‰ì_p
 = 
p
;

928 
cou¡
 = 1;

929 } i‡(
ƒ
 =
block_to_‰ì
 + 
cou¡
) {

930 
cou¡
++;

932 
îr
 = 
	`pxt4_˛ór_blocks
(
h™dÀ
, 
öode
, 
this_bh
,

933 
block_to_‰ì
, 
cou¡
,

934 
block_to_‰ì_p
, 
p
);

935 i‡(
îr
)

937 
block_to_‰ì
 = 
ƒ
;

938 
block_to_‰ì_p
 = 
p
;

939 
cou¡
 = 1;

944 i‡(!
îr
 && 
cou¡
 > 0)

945 
îr
 = 
	`pxt4_˛ór_blocks
(
h™dÀ
, 
öode
, 
this_bh
, 
block_to_‰ì
,

946 
cou¡
, 
block_to_‰ì_p
, 
p
);

947 i‡(
îr
 < 0)

951 i‡(
this_bh
) {

952 
	`BUFFER_TRACE
(
this_bh
, "callÖxt4_handle_dirty_metadata");

960 i‡((
	`PXT4_JOURNAL
(
öode
Ë=
NULL
Ë|| 
	`bh2jh
(
this_bh
))

961 
	`pxt4_h™dÀ_dúty_mëad©a
(
h™dÀ
, 
öode
, 
this_bh
);

963 
	`PXT4_ERROR_INODE
(
öode
,

966 (Ë
this_bh
->
b_blockƒ
);

968 
	}
}

983 
	$pxt4_‰ì_bønches
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *inode,

984 
buf„r_hód
 *
∑ª¡_bh
,

985 
__À32
 *
fú°
, __À32 *
œ°
, 
dïth
)

987 
pxt4_fsblk_t
 
ƒ
;

988 
__À32
 *
p
;

990 i‡(
	`pxt4_h™dÀ_is_ab‹ãd
(
h™dÀ
))

993 i‡(
dïth
--) {

994 
buf„r_hód
 *
bh
;

995 
addr_≥r_block
 = 
	`PXT4_ADDR_PER_BLOCK
(
öode
->
i_sb
);

996 
p
 = 
œ°
;

997 --
p
 >
fú°
) {

998 
ƒ
 = 
	`À32_to_˝u
(*
p
);

999 i‡(!
ƒ
)

1002 i‡(!
	`pxt4_d©a_block_vÆid
(
	`PXT4_SB
(
öode
->
i_sb
),

1003 
ƒ
, 1)) {

1004 
	`PXT4_ERROR_INODE
(
öode
,

1007 (Ë
ƒ
, 
dïth
);

1012 
bh
 = 
	`sb_bªad
(
öode
->
i_sb
, 
ƒ
);

1018 i‡(!
bh
) {

1019 
	`PXT4_ERROR_INODE_BLOCK
(
öode
, 
ƒ
,

1025 
	`BUFFER_TRACE
(
bh
, "free child branches");

1026 
	`pxt4_‰ì_bønches
(
h™dÀ
, 
öode
, 
bh
,

1027 (
__À32
 *Ë
bh
->
b_d©a
,

1028 (
__À32
 *Ë
bh
->
b_d©a
 + 
addr_≥r_block
,

1029 
dïth
);

1030 
	`bªl£
(
bh
);

1048 i‡(
	`pxt4_h™dÀ_is_ab‹ãd
(
h™dÀ
))

1050 i‡(
	`åy_to_exãnd_å™ß˘i⁄
(
h™dÀ
, 
öode
)) {

1051 
	`pxt4_m¨k_öode_dúty
(
h™dÀ
, 
öode
);

1052 
	`pxt4_åunˇã_ª°¨t_å™s
(
h™dÀ
, 
öode
,

1053 
	`pxt4_blocks_f‹_åunˇã
(
öode
));

1067 
	`pxt4_‰ì_blocks
(
h™dÀ
, 
öode
, 
NULL
, 
ƒ
, 1,

1068 
PXT4_FREE_BLOCKS_METADATA
|

1069 
PXT4_FREE_BLOCKS_FORGET
);

1071 i‡(
∑ª¡_bh
) {

1076 
	`BUFFER_TRACE
(
∑ª¡_bh
, "get_write_access");

1077 i‡(!
	`pxt4_jou∫Æ_gë_wrôe_ac˚ss
(
h™dÀ
,

1078 
∑ª¡_bh
)){

1079 *
p
 = 0;

1080 
	`BUFFER_TRACE
(
∑ª¡_bh
,

1082 
	`pxt4_h™dÀ_dúty_mëad©a
(
h™dÀ
,

1083 
öode
,

1084 
∑ª¡_bh
);

1090 
	`BUFFER_TRACE
(
∑ª¡_bh
, "free data blocks");

1091 
	`pxt4_‰ì_d©a
(
h™dÀ
, 
öode
, 
∑ª¡_bh
, 
fú°
, 
œ°
);

1093 
	}
}

1095 
	$pxt4_öd_åunˇã
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *inode)

1097 
pxt4_öode_öfo
 *
ei
 = 
	`PXT4_I
(
öode
);

1098 
__À32
 *
i_d©a
 = 
ei
->i_data;

1099 
addr_≥r_block
 = 
	`PXT4_ADDR_PER_BLOCK
(
öode
->
i_sb
);

1100 
pxt4_lblk_t
 
off£ts
[4];

1101 
Indúe˘
 
chaö
[4];

1102 
Indúe˘
 *
∑πül
;

1103 
__À32
 
ƒ
 = 0;

1104 
n
 = 0;

1105 
pxt4_lblk_t
 
œ°_block
, 
max_block
;

1106 
blocksize
 = 
öode
->
i_sb
->
s_blocksize
;

1108 
œ°_block
 = (
öode
->
i_size
 + 
blocksize
-1)

1109 >> 
	`PXT4_BLOCK_SIZE_BITS
(
öode
->
i_sb
);

1110 
max_block
 = (
	`PXT4_SB
(
öode
->
i_sb
)->
s_bôm≠_maxbyãs
 + 
blocksize
-1)

1111 >> 
	`PXT4_BLOCK_SIZE_BITS
(
öode
->
i_sb
);

1113 i‡(
œ°_block
 !
max_block
) {

1114 
n
 = 
	`pxt4_block_to_∑th
(
öode
, 
œ°_block
, 
off£ts
, 
NULL
);

1115 i‡(
n
 == 0)

1119 
	`pxt4_es_ªmove_exã¡
(
öode
, 
œ°_block
, 
EXT_MAX_BLOCKS
 -Üast_block);

1128 
ei
->
i_disksize
 = 
öode
->
i_size
;

1130 i‡(
œ°_block
 =
max_block
) {

1136 } i‡(
n
 == 1) {

1137 
	`pxt4_‰ì_d©a
(
h™dÀ
, 
öode
, 
NULL
, 
i_d©a
+
off£ts
[0],

1138 
i_d©a
 + 
PXT4_NDIR_BLOCKS
);

1139 
do_ödúe˘s
;

1142 
∑πül
 = 
	`pxt4_föd_sh¨ed
(
öode
, 
n
, 
off£ts
, 
chaö
, &
ƒ
);

1144 i‡(
ƒ
) {

1145 i‡(
∑πül
 =
chaö
) {

1147 
	`pxt4_‰ì_bønches
(
h™dÀ
, 
öode
, 
NULL
,

1148 &
ƒ
, &ƒ+1, (
chaö
+
n
-1Ë- 
∑πül
);

1149 *
∑πül
->
p
 = 0;

1156 
	`BUFFER_TRACE
(
∑πül
->
bh
, "get_write_access");

1157 
	`pxt4_‰ì_bønches
(
h™dÀ
, 
öode
, 
∑πül
->
bh
,

1158 
∑πül
->
p
,

1159 
∑πül
->
p
+1, (
chaö
+
n
-1) -Öartial);

1163 
∑πül
 > 
chaö
) {

1164 
	`pxt4_‰ì_bønches
(
h™dÀ
, 
öode
, 
∑πül
->
bh
,Ö¨tül->
p
 + 1,

1165 (
__À32
*)
∑πül
->
bh
->
b_d©a
+
addr_≥r_block
,

1166 (
chaö
+
n
-1Ë- 
∑πül
);

1167 
	`BUFFER_TRACE
(
∑πül
->
bh
, "call brelse");

1168 
	`bªl£
(
∑πül
->
bh
);

1169 
∑πül
--;

1171 
do_ödúe˘s
:

1173 
off£ts
[0]) {

1175 
ƒ
 = 
i_d©a
[
PXT4_IND_BLOCK
];

1176 i‡(
ƒ
) {

1177 
	`pxt4_‰ì_bønches
(
h™dÀ
, 
öode
, 
NULL
, &
ƒ
, &nr+1, 1);

1178 
i_d©a
[
PXT4_IND_BLOCK
] = 0;

1181 
PXT4_IND_BLOCK
:

1182 
ƒ
 = 
i_d©a
[
PXT4_DIND_BLOCK
];

1183 i‡(
ƒ
) {

1184 
	`pxt4_‰ì_bønches
(
h™dÀ
, 
öode
, 
NULL
, &
ƒ
, &nr+1, 2);

1185 
i_d©a
[
PXT4_DIND_BLOCK
] = 0;

1188 
PXT4_DIND_BLOCK
:

1189 
ƒ
 = 
i_d©a
[
PXT4_TIND_BLOCK
];

1190 i‡(
ƒ
) {

1191 
	`pxt4_‰ì_bønches
(
h™dÀ
, 
öode
, 
NULL
, &
ƒ
, &nr+1, 3);

1192 
i_d©a
[
PXT4_TIND_BLOCK
] = 0;

1195 
PXT4_TIND_BLOCK
:

1198 
	}
}

1210 
	$pxt4_öd_ªmove_•a˚
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *inode,

1211 
pxt4_lblk_t
 
°¨t
,Öxt4_lblk_à
íd
)

1213 
pxt4_öode_öfo
 *
ei
 = 
	`PXT4_I
(
öode
);

1214 
__À32
 *
i_d©a
 = 
ei
->i_data;

1215 
addr_≥r_block
 = 
	`PXT4_ADDR_PER_BLOCK
(
öode
->
i_sb
);

1216 
pxt4_lblk_t
 
off£ts
[4], 
off£ts2
[4];

1217 
Indúe˘
 
chaö
[4], 
chaö2
[4];

1218 
Indúe˘
 *
∑πül
, *
∑πül2
;

1219 
Indúe˘
 *
p
 = 
NULL
, *
p2
 = NULL;

1220 
pxt4_lblk_t
 
max_block
;

1221 
__À32
 
ƒ
 = 0, 
ƒ2
 = 0;

1222 
n
 = 0, 
n2
 = 0;

1223 
blocksize
 = 
öode
->
i_sb
->
s_blocksize
;

1225 
max_block
 = (
	`PXT4_SB
(
öode
->
i_sb
)->
s_bôm≠_maxbyãs
 + 
blocksize
-1)

1226 >> 
	`PXT4_BLOCK_SIZE_BITS
(
öode
->
i_sb
);

1227 i‡(
íd
 >
max_block
)

1228 
íd
 = 
max_block
;

1229 i‡((
°¨t
 >
íd
Ë|| (°¨à> 
max_block
))

1232 
n
 = 
	`pxt4_block_to_∑th
(
öode
, 
°¨t
, 
off£ts
, 
NULL
);

1233 
n2
 = 
	`pxt4_block_to_∑th
(
öode
, 
íd
, 
off£ts2
, 
NULL
);

1235 
	`BUG_ON
(
n
 > 
n2
);

1237 i‡((
n
 =1Ë&& (¿=
n2
)) {

1239 
	`pxt4_‰ì_d©a
(
h™dÀ
, 
öode
, 
NULL
, 
i_d©a
 + 
off£ts
[0],

1240 
i_d©a
 + 
off£ts2
[0]);

1242 } i‡(
n2
 > 
n
) {

1250 i‡(
n
 == 1) {

1255 
	`pxt4_‰ì_d©a
(
h™dÀ
, 
öode
, 
NULL
, 
i_d©a
 + 
off£ts
[0],

1256 
i_d©a
 + 
PXT4_NDIR_BLOCKS
);

1257 
íd_ønge
;

1261 
∑πül
 = 
p
 = 
	`pxt4_föd_sh¨ed
(
öode
, 
n
, 
off£ts
, 
chaö
, &
ƒ
);

1262 i‡(
ƒ
) {

1263 i‡(
∑πül
 =
chaö
) {

1265 
	`pxt4_‰ì_bønches
(
h™dÀ
, 
öode
, 
NULL
,

1266 &
ƒ
, &ƒ+1, (
chaö
+
n
-1Ë- 
∑πül
);

1267 *
∑πül
->
p
 = 0;

1270 
	`BUFFER_TRACE
(
∑πül
->
bh
, "get_write_access");

1271 
	`pxt4_‰ì_bønches
(
h™dÀ
, 
öode
, 
∑πül
->
bh
,

1272 
∑πül
->
p
,

1273 
∑πül
->
p
+1, (
chaö
+
n
-1) -Öartial);

1281 
∑πül
 > 
chaö
) {

1282 
	`pxt4_‰ì_bønches
(
h™dÀ
, 
öode
, 
∑πül
->
bh
,

1283 
∑πül
->
p
 + 1,

1284 (
__À32
 *)
∑πül
->
bh
->
b_d©a
+
addr_≥r_block
,

1285 (
chaö
+
n
-1Ë- 
∑πül
);

1286 
∑πül
--;

1289 
íd_ønge
:

1290 
∑πül2
 = 
p2
 = 
	`pxt4_föd_sh¨ed
(
öode
, 
n2
, 
off£ts2
, 
chaö2
, &
ƒ2
);

1291 i‡(
ƒ2
) {

1292 i‡(
∑πül2
 =
chaö2
) {

1299 
do_ödúe˘s
;

1308 
∑πül2
->
p
++;

1315 
∑πül2
 > 
chaö2
) {

1316 
	`pxt4_‰ì_bønches
(
h™dÀ
, 
öode
, 
∑πül2
->
bh
,

1317 (
__À32
 *)
∑πül2
->
bh
->
b_d©a
,

1318 
∑πül2
->
p
,

1319 (
chaö2
+
n2
-1Ë- 
∑πül2
);

1320 
∑πül2
--;

1322 
do_ödúe˘s
;

1326 
∑πül
 = 
p
 = 
	`pxt4_föd_sh¨ed
(
öode
, 
n
, 
off£ts
, 
chaö
, &
ƒ
);

1327 
∑πül2
 = 
p2
 = 
	`pxt4_föd_sh¨ed
(
öode
, 
n2
, 
off£ts2
, 
chaö2
, &
ƒ2
);

1330 i‡(
ƒ
) {

1331 
Àvñ
 = 
	`mö
(
∑πül
 - 
chaö
, 
∑πül2
 - 
chaö2
);

1332 
i
;

1333 
subåì
 = 1;

1335 
i
 = 0; i <
Àvñ
; i++) {

1336 i‡(
off£ts
[
i
] !
off£ts2
[i]) {

1337 
subåì
 = 0;

1342 i‡(!
subåì
) {

1343 i‡(
∑πül
 =
chaö
) {

1345 
	`pxt4_‰ì_bønches
(
h™dÀ
, 
öode
, 
NULL
,

1346 &
ƒ
, &nr+1,

1347 (
chaö
+
n
-1Ë- 
∑πül
);

1348 *
∑πül
->
p
 = 0;

1351 
	`BUFFER_TRACE
(
∑πül
->
bh
, "get_write_access");

1352 
	`pxt4_‰ì_bønches
(
h™dÀ
, 
öode
, 
∑πül
->
bh
,

1353 
∑πül
->
p
,

1354 
∑πül
->
p
+1,

1355 (
chaö
+
n
-1Ë- 
∑πül
);

1360 i‡(!
ƒ2
) {

1367 
∑πül2
->
p
++;

1370 
∑πül
 > 
chaö
 || 
∑πül2
 > 
chaö2
) {

1371 
dïth
 = (
chaö
+
n
-1Ë- 
∑πül
;

1372 
dïth2
 = (
chaö2
+
n2
-1Ë- 
∑πül2
;

1374 i‡(
∑πül
 > 
chaö
 && 
∑πül2
 > 
chaö2
 &&

1375 
∑πül
->
bh
->
b_blockƒ
 =
∑πül2
->bh->b_blocknr) {

1380 
	`pxt4_‰ì_bønches
(
h™dÀ
, 
öode
, 
∑πül
->
bh
,

1381 
∑πül
->
p
 + 1,

1382 
∑πül2
->
p
,

1383 (
chaö
+
n
-1Ë- 
∑πül
);

1384 
˛ónup
;

1394 i‡(
∑πül
 > 
chaö
 && 
dïth
 <
dïth2
) {

1395 
	`pxt4_‰ì_bønches
(
h™dÀ
, 
öode
, 
∑πül
->
bh
,

1396 
∑πül
->
p
 + 1,

1397 (
__À32
 *)
∑πül
->
bh
->
b_d©a
+
addr_≥r_block
,

1398 (
chaö
+
n
-1Ë- 
∑πül
);

1399 
∑πül
--;

1401 i‡(
∑πül2
 > 
chaö2
 && 
dïth2
 <
dïth
) {

1402 
	`pxt4_‰ì_bønches
(
h™dÀ
, 
öode
, 
∑πül2
->
bh
,

1403 (
__À32
 *)
∑πül2
->
bh
->
b_d©a
,

1404 
∑πül2
->
p
,

1405 (
chaö2
+
n2
-1Ë- 
∑πül2
);

1406 
∑πül2
--;

1410 
˛ónup
:

1411 
p
 &&Ö > 
chaö
) {

1412 
	`BUFFER_TRACE
(
p
->
bh
, "call brelse");

1413 
	`bªl£
(
p
->
bh
);

1414 
p
--;

1416 
p2
 &&Ö2 > 
chaö2
) {

1417 
	`BUFFER_TRACE
(
p2
->
bh
, "call brelse");

1418 
	`bªl£
(
p2
->
bh
);

1419 
p2
--;

1423 
do_ödúe˘s
:

1425 
off£ts
[0]) {

1427 i‡(++
n
 >
n2
)

1429 
ƒ
 = 
i_d©a
[
PXT4_IND_BLOCK
];

1430 i‡(
ƒ
) {

1431 
	`pxt4_‰ì_bønches
(
h™dÀ
, 
öode
, 
NULL
, &
ƒ
, &nr+1, 1);

1432 
i_d©a
[
PXT4_IND_BLOCK
] = 0;

1435 
PXT4_IND_BLOCK
:

1436 i‡(++
n
 >
n2
)

1438 
ƒ
 = 
i_d©a
[
PXT4_DIND_BLOCK
];

1439 i‡(
ƒ
) {

1440 
	`pxt4_‰ì_bønches
(
h™dÀ
, 
öode
, 
NULL
, &
ƒ
, &nr+1, 2);

1441 
i_d©a
[
PXT4_DIND_BLOCK
] = 0;

1444 
PXT4_DIND_BLOCK
:

1445 i‡(++
n
 >
n2
)

1447 
ƒ
 = 
i_d©a
[
PXT4_TIND_BLOCK
];

1448 i‡(
ƒ
) {

1449 
	`pxt4_‰ì_bønches
(
h™dÀ
, 
öode
, 
NULL
, &
ƒ
, &nr+1, 3);

1450 
i_d©a
[
PXT4_TIND_BLOCK
] = 0;

1453 
PXT4_TIND_BLOCK
:

1456 
˛ónup
;

1457 
	}
}

	@inline.c

7 
	~<löux/iom≠.h
>

8 
	~<löux/fõm≠.h
>

9 
	~<löux/ivîsi⁄.h
>

11 
	~"pxt4_jbd3.h
"

12 
	~"pxt4.h
"

13 
	~"x©å.h
"

14 
	~"åunˇã.h
"

16 
	#PXT4_XATTR_SYSTEM_DATA
 "d©a"

	)

17 
	#PXT4_MIN_INLINE_DATA_SIZE
 (((
__À32
Ë* 
PXT4_N_BLOCKS
))

	)

18 
	#PXT4_INLINE_DOTDOT_OFFSET
 2

	)

19 
	#PXT4_INLINE_DOTDOT_SIZE
 4

	)

21 
	$pxt4_gë_ölöe_size
(
öode
 *inode)

23 i‡(
	`PXT4_I
(
öode
)->
i_ölöe_off
)

24  
	`PXT4_I
(
öode
)->
i_ölöe_size
;

27 
	}
}

29 
	$gë_max_ölöe_x©å_vÆue_size
(
öode
 *inode,

30 
pxt4_ûoc
 *
ûoc
)

32 
pxt4_x©å_ibody_hódî
 *
hódî
;

33 
pxt4_x©å_íåy
 *
íåy
;

34 
pxt4_öode
 *
øw_öode
;

35 
‰ì
, 
mö_offs
;

37 
mö_offs
 = 
	`PXT4_SB
(
öode
->
i_sb
)->
s_öode_size
 -

38 
PXT4_GOOD_OLD_INODE_SIZE
 -

39 
	`PXT4_I
(
öode
)->
i_exåa_isize
 -

40 (
pxt4_x©å_ibody_hódî
);

47 i‡(!
	`pxt4_ã°_öode_°©e
(
öode
, 
PXT4_STATE_XATTR
))

48  
	`PXT4_XATTR_SIZE
(
mö_offs
 -

49 
	`PXT4_XATTR_LEN
(
	`°æí
(
PXT4_XATTR_SYSTEM_DATA
)) -

50 
PXT4_XATTR_ROUND
 - (
__u32
));

52 
øw_öode
 = 
	`pxt4_øw_öode
(
ûoc
);

53 
hódî
 = 
	`IHDR
(
öode
, 
øw_öode
);

54 
íåy
 = 
	`IFIRST
(
hódî
);

57 ; !
	`IS_LAST_ENTRY
(
íåy
);É¡ry = 
	`PXT4_XATTR_NEXT
(entry)) {

58 i‡(!
íåy
->
e_vÆue_öum
 &&É¡ry->
e_vÆue_size
) {

59 
size_t
 
offs
 = 
	`À16_to_˝u
(
íåy
->
e_vÆue_offs
);

60 i‡(
offs
 < 
mö_offs
)

61 
mö_offs
 = 
offs
;

64 
‰ì
 = 
mö_offs
 -

65 ((*)
íåy
 - (*)
	`IFIRST
(
hódî
)Ë- (
__u32
);

67 i‡(
	`PXT4_I
(
öode
)->
i_ölöe_off
) {

68 
íåy
 = (
pxt4_x©å_íåy
 *)

69 ((*)
øw_öode
 + 
	`PXT4_I
(
öode
)->
i_ölöe_off
);

71 
‰ì
 +
	`PXT4_XATTR_SIZE
(
	`À32_to_˝u
(
íåy
->
e_vÆue_size
));

72 
out
;

75 
‰ì
 -
	`PXT4_XATTR_LEN
(
	`°æí
(
PXT4_XATTR_SYSTEM_DATA
));

77 i‡(
‰ì
 > 
PXT4_XATTR_ROUND
)

78 
‰ì
 = 
	`PXT4_XATTR_SIZE
(‰ì - 
PXT4_XATTR_ROUND
);

80 
‰ì
 = 0;

82 
out
:

83  
‰ì
;

84 
	}
}

91 
	$pxt4_gë_max_ölöe_size
(
öode
 *inode)

93 
îr‹
, 
max_ölöe_size
;

94 
pxt4_ûoc
 
ûoc
;

96 i‡(
	`PXT4_I
(
öode
)->
i_exåa_isize
 == 0)

99 
îr‹
 = 
	`pxt4_gë_öode_loc
(
öode
, &
ûoc
);

100 i‡(
îr‹
) {

101 
	`pxt4_îr‹_öode
(
öode
, 
__func__
, 
__LINE__
, 0,

103 
öode
->
i_öo
);

107 
	`down_ªad
(&
	`PXT4_I
(
öode
)->
x©å_£m
);

108 
max_ölöe_size
 = 
	`gë_max_ölöe_x©å_vÆue_size
(
öode
, &
ûoc
);

109 
	`up_ªad
(&
	`PXT4_I
(
öode
)->
x©å_£m
);

111 
	`bªl£
(
ûoc
.
bh
);

113 i‡(!
max_ölöe_size
)

116  
max_ölöe_size
 + 
PXT4_MIN_INLINE_DATA_SIZE
;

117 
	}
}

124 
	$pxt4_föd_ölöe_d©a_nﬁock
(
öode
 *inode)

126 
pxt4_x©å_ibody_föd
 
is
 = {

127 .
s
 = { .
nŸ_found
 = -
ENODATA
, },

129 
pxt4_x©å_öfo
 
i
 = {

130 .
«me_ödex
 = 
PXT4_XATTR_INDEX_SYSTEM
,

131 .
«me
 = 
PXT4_XATTR_SYSTEM_DATA
,

133 
îr‹
;

135 i‡(
	`PXT4_I
(
öode
)->
i_exåa_isize
 == 0)

138 
îr‹
 = 
	`pxt4_gë_öode_loc
(
öode
, &
is
.
ûoc
);

139 i‡(
îr‹
)

140  
îr‹
;

142 
îr‹
 = 
	`pxt4_x©å_ibody_föd
(
öode
, &
i
, &
is
);

143 i‡(
îr‹
)

144 
out
;

146 i‡(!
is
.
s
.
nŸ_found
) {

147 i‡(
is
.
s
.
hîe
->
e_vÆue_öum
) {

148 
	`PXT4_ERROR_INODE
(
öode
, "inline data xattrÑefers "

150 
îr‹
 = -
EFSCORRUPTED
;

151 
out
;

153 
	`PXT4_I
(
öode
)->
i_ölöe_off
 = (
u16
)((*)
is
.
s
.
hîe
 -

154 (*)
	`pxt4_øw_öode
(&
is
.
ûoc
));

155 
	`PXT4_I
(
öode
)->
i_ölöe_size
 = 
PXT4_MIN_INLINE_DATA_SIZE
 +

156 
	`À32_to_˝u
(
is
.
s
.
hîe
->
e_vÆue_size
);

157 
	`pxt4_£t_öode_°©e
(
öode
, 
PXT4_STATE_MAY_INLINE_DATA
);

159 
out
:

160 
	`bªl£
(
is
.
ûoc
.
bh
);

161  
îr‹
;

162 
	}
}

164 
	$pxt4_ªad_ölöe_d©a
(
öode
 *öode, *
buf„r
,

165 
Àn
,

166 
pxt4_ûoc
 *
ûoc
)

168 
pxt4_x©å_íåy
 *
íåy
;

169 
pxt4_x©å_ibody_hódî
 *
hódî
;

170 
˝_Àn
 = 0;

171 
pxt4_öode
 *
øw_öode
;

173 i‡(!
Àn
)

176 
	`BUG_ON
(
Àn
 > 
	`PXT4_I
(
öode
)->
i_ölöe_size
);

178 
˝_Àn
 = 
Àn
 < 
PXT4_MIN_INLINE_DATA_SIZE
 ?

179 
Àn
 : 
PXT4_MIN_INLINE_DATA_SIZE
;

181 
øw_öode
 = 
	`pxt4_øw_öode
(
ûoc
);

182 
	`mem˝y
(
buf„r
, (*)(
øw_öode
->
i_block
), 
˝_Àn
);

184 
Àn
 -
˝_Àn
;

185 
buf„r
 +
˝_Àn
;

187 i‡(!
Àn
)

188 
out
;

190 
hódî
 = 
	`IHDR
(
öode
, 
øw_öode
);

191 
íåy
 = (
pxt4_x©å_íåy
 *)((*)
øw_öode
 +

192 
	`PXT4_I
(
öode
)->
i_ölöe_off
);

193 
Àn
 = 
	`mö_t
(,Üen,

194 ()
	`À32_to_˝u
(
íåy
->
e_vÆue_size
));

196 
	`mem˝y
(
buf„r
,

197 (*)
	`IFIRST
(
hódî
Ë+ 
	`À16_to_˝u
(
íåy
->
e_vÆue_offs
), 
Àn
);

198 
˝_Àn
 +
Àn
;

200 
out
:

201  
˝_Àn
;

202 
	}
}

210 
	$pxt4_wrôe_ölöe_d©a
(
öode
 *öode, 
pxt4_ûoc
 *
ûoc
,

211 *
buf„r
, 
loff_t
 
pos
, 
Àn
)

213 
pxt4_x©å_íåy
 *
íåy
;

214 
pxt4_x©å_ibody_hódî
 *
hódî
;

215 
pxt4_öode
 *
øw_öode
;

216 
˝_Àn
 = 0;

218 i‡(
	`u∆ikñy
(
	`pxt4_f‹˚d_shutdown
(
	`PXT4_SB
(
öode
->
i_sb
))))

221 
	`BUG_ON
(!
	`PXT4_I
(
öode
)->
i_ölöe_off
);

222 
	`BUG_ON
(
pos
 + 
Àn
 > 
	`PXT4_I
(
öode
)->
i_ölöe_size
);

224 
øw_öode
 = 
	`pxt4_øw_öode
(
ûoc
);

225 
buf„r
 +
pos
;

227 i‡(
pos
 < 
PXT4_MIN_INLINE_DATA_SIZE
) {

228 
˝_Àn
 = 
pos
 + 
Àn
 > 
PXT4_MIN_INLINE_DATA_SIZE
 ?

229 
PXT4_MIN_INLINE_DATA_SIZE
 - 
pos
 : 
Àn
;

230 
	`mem˝y
((*)
øw_öode
->
i_block
 + 
pos
, 
buf„r
, 
˝_Àn
);

232 
Àn
 -
˝_Àn
;

233 
buf„r
 +
˝_Àn
;

234 
pos
 +
˝_Àn
;

237 i‡(!
Àn
)

240 
pos
 -
PXT4_MIN_INLINE_DATA_SIZE
;

241 
hódî
 = 
	`IHDR
(
öode
, 
øw_öode
);

242 
íåy
 = (
pxt4_x©å_íåy
 *)((*)
øw_öode
 +

243 
	`PXT4_I
(
öode
)->
i_ölöe_off
);

245 
	`mem˝y
((*)
	`IFIRST
(
hódî
Ë+ 
	`À16_to_˝u
(
íåy
->
e_vÆue_offs
Ë+ 
pos
,

246 
buf„r
, 
Àn
);

247 
	}
}

249 
	$pxt4_¸óã_ölöe_d©a
(
h™dÀ_t
 *
h™dÀ
,

250 
öode
 *öode, 
Àn
)

252 
îr‹
;

253 *
vÆue
 = 
NULL
;

254 
pxt4_x©å_ibody_föd
 
is
 = {

255 .
s
 = { .
nŸ_found
 = -
ENODATA
, },

257 
pxt4_x©å_öfo
 
i
 = {

258 .
«me_ödex
 = 
PXT4_XATTR_INDEX_SYSTEM
,

259 .
«me
 = 
PXT4_XATTR_SYSTEM_DATA
,

262 
îr‹
 = 
	`pxt4_gë_öode_loc
(
öode
, &
is
.
ûoc
);

263 i‡(
îr‹
)

264  
îr‹
;

266 
	`BUFFER_TRACE
(
is
.
ûoc
.
bh
, "get_write_access");

267 
îr‹
 = 
	`pxt4_jou∫Æ_gë_wrôe_ac˚ss
(
h™dÀ
, 
is
.
ûoc
.
bh
);

268 i‡(
îr‹
)

269 
out
;

271 i‡(
Àn
 > 
PXT4_MIN_INLINE_DATA_SIZE
) {

272 
vÆue
 = 
PXT4_ZERO_XATTR_VALUE
;

273 
Àn
 -
PXT4_MIN_INLINE_DATA_SIZE
;

275 
vÆue
 = "";

276 
Àn
 = 0;

280 
i
.
vÆue
 = value;

281 
i
.
vÆue_Àn
 = 
Àn
;

283 
îr‹
 = 
	`pxt4_x©å_ibody_föd
(
öode
, &
i
, &
is
);

284 i‡(
îr‹
)

285 
out
;

287 
	`BUG_ON
(!
is
.
s
.
nŸ_found
);

289 
îr‹
 = 
	`pxt4_x©å_ibody_ölöe_£t
(
h™dÀ
, 
öode
, &
i
, &
is
);

290 i‡(
îr‹
) {

291 i‡(
îr‹
 =-
ENOSPC
)

292 
	`pxt4_˛ór_öode_°©e
(
öode
,

293 
PXT4_STATE_MAY_INLINE_DATA
);

294 
out
;

297 
	`mem£t
((*)
	`pxt4_øw_öode
(&
is
.
ûoc
)->
i_block
,

298 0, 
PXT4_MIN_INLINE_DATA_SIZE
);

300 
	`PXT4_I
(
öode
)->
i_ölöe_off
 = (
u16
)((*)
is
.
s
.
hîe
 -

301 (*)
	`pxt4_øw_öode
(&
is
.
ûoc
));

302 
	`PXT4_I
(
öode
)->
i_ölöe_size
 = 
Àn
 + 
PXT4_MIN_INLINE_DATA_SIZE
;

303 
	`pxt4_˛ór_öode_Êag
(
öode
, 
PXT4_INODE_EXTENTS
);

304 
	`pxt4_£t_öode_Êag
(
öode
, 
PXT4_INODE_INLINE_DATA
);

305 
	`gë_bh
(
is
.
ûoc
.
bh
);

306 
îr‹
 = 
	`pxt4_m¨k_ûoc_dúty
(
h™dÀ
, 
öode
, &
is
.
ûoc
);

308 
out
:

309 
	`bªl£
(
is
.
ûoc
.
bh
);

310  
îr‹
;

311 
	}
}

313 
	$pxt4_upd©e_ölöe_d©a
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *inode,

314 
Àn
)

316 
îr‹
;

317 *
vÆue
 = 
NULL
;

318 
pxt4_x©å_ibody_föd
 
is
 = {

319 .
s
 = { .
nŸ_found
 = -
ENODATA
, },

321 
pxt4_x©å_öfo
 
i
 = {

322 .
«me_ödex
 = 
PXT4_XATTR_INDEX_SYSTEM
,

323 .
«me
 = 
PXT4_XATTR_SYSTEM_DATA
,

327 i‡(
Àn
 <
	`PXT4_I
(
öode
)->
i_ölöe_size
)

330 
îr‹
 = 
	`pxt4_gë_öode_loc
(
öode
, &
is
.
ûoc
);

331 i‡(
îr‹
)

332  
îr‹
;

334 
îr‹
 = 
	`pxt4_x©å_ibody_föd
(
öode
, &
i
, &
is
);

335 i‡(
îr‹
)

336 
out
;

338 
	`BUG_ON
(
is
.
s
.
nŸ_found
);

340 
Àn
 -
PXT4_MIN_INLINE_DATA_SIZE
;

341 
vÆue
 = 
	`kzÆloc
(
Àn
, 
GFP_NOFS
);

342 i‡(!
vÆue
) {

343 
îr‹
 = -
ENOMEM
;

344 
out
;

347 
îr‹
 = 
	`pxt4_x©å_ibody_gë
(
öode
, 
i
.
«me_ödex
, i.
«me
,

348 
vÆue
, 
Àn
);

349 i‡(
îr‹
 =-
ENODATA
)

350 
out
;

352 
	`BUFFER_TRACE
(
is
.
ûoc
.
bh
, "get_write_access");

353 
îr‹
 = 
	`pxt4_jou∫Æ_gë_wrôe_ac˚ss
(
h™dÀ
, 
is
.
ûoc
.
bh
);

354 i‡(
îr‹
)

355 
out
;

358 
i
.
vÆue
 = value;

359 
i
.
vÆue_Àn
 = 
Àn
;

361 
îr‹
 = 
	`pxt4_x©å_ibody_ölöe_£t
(
h™dÀ
, 
öode
, &
i
, &
is
);

362 i‡(
îr‹
)

363 
out
;

365 
	`PXT4_I
(
öode
)->
i_ölöe_off
 = (
u16
)((*)
is
.
s
.
hîe
 -

366 (*)
	`pxt4_øw_öode
(&
is
.
ûoc
));

367 
	`PXT4_I
(
öode
)->
i_ölöe_size
 = 
PXT4_MIN_INLINE_DATA_SIZE
 +

368 
	`À32_to_˝u
(
is
.
s
.
hîe
->
e_vÆue_size
);

369 
	`pxt4_£t_öode_°©e
(
öode
, 
PXT4_STATE_MAY_INLINE_DATA
);

370 
	`gë_bh
(
is
.
ûoc
.
bh
);

371 
îr‹
 = 
	`pxt4_m¨k_ûoc_dúty
(
h™dÀ
, 
öode
, &
is
.
ûoc
);

373 
out
:

374 
	`k‰ì
(
vÆue
);

375 
	`bªl£
(
is
.
ûoc
.
bh
);

376  
îr‹
;

377 
	}
}

379 
	$pxt4_¥ï¨e_ölöe_d©a
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *inode,

380 
Àn
)

382 
ªt
, 
size
, 
no_ex∑nd
;

383 
pxt4_öode_öfo
 *
ei
 = 
	`PXT4_I
(
öode
);

385 i‡(!
	`pxt4_ã°_öode_°©e
(
öode
, 
PXT4_STATE_MAY_INLINE_DATA
))

386  -
ENOSPC
;

388 
size
 = 
	`pxt4_gë_max_ölöe_size
(
öode
);

389 i‡(
size
 < 
Àn
)

390  -
ENOSPC
;

392 
	`pxt4_wrôe_lock_x©å
(
öode
, &
no_ex∑nd
);

394 i‡(
ei
->
i_ölöe_off
)

395 
ªt
 = 
	`pxt4_upd©e_ölöe_d©a
(
h™dÀ
, 
öode
, 
Àn
);

397 
ªt
 = 
	`pxt4_¸óã_ölöe_d©a
(
h™dÀ
, 
öode
, 
Àn
);

399 
	`pxt4_wrôe_u∆ock_x©å
(
öode
, &
no_ex∑nd
);

400  
ªt
;

401 
	}
}

403 
	$pxt4_de°roy_ölöe_d©a_nﬁock
(
h™dÀ_t
 *
h™dÀ
,

404 
öode
 *inode)

406 
pxt4_öode_öfo
 *
ei
 = 
	`PXT4_I
(
öode
);

407 
pxt4_x©å_ibody_föd
 
is
 = {

408 .
s
 = { .
nŸ_found
 = 0, },

410 
pxt4_x©å_öfo
 
i
 = {

411 .
«me_ödex
 = 
PXT4_XATTR_INDEX_SYSTEM
,

412 .
«me
 = 
PXT4_XATTR_SYSTEM_DATA
,

413 .
vÆue
 = 
NULL
,

414 .
vÆue_Àn
 = 0,

416 
îr‹
;

418 i‡(!
ei
->
i_ölöe_off
)

421 
îr‹
 = 
	`pxt4_gë_öode_loc
(
öode
, &
is
.
ûoc
);

422 i‡(
îr‹
)

423  
îr‹
;

425 
îr‹
 = 
	`pxt4_x©å_ibody_föd
(
öode
, &
i
, &
is
);

426 i‡(
îr‹
)

427 
out
;

429 
	`BUFFER_TRACE
(
is
.
ûoc
.
bh
, "get_write_access");

430 
îr‹
 = 
	`pxt4_jou∫Æ_gë_wrôe_ac˚ss
(
h™dÀ
, 
is
.
ûoc
.
bh
);

431 i‡(
îr‹
)

432 
out
;

434 
îr‹
 = 
	`pxt4_x©å_ibody_ölöe_£t
(
h™dÀ
, 
öode
, &
i
, &
is
);

435 i‡(
îr‹
)

436 
out
;

438 
	`mem£t
((*)
	`pxt4_øw_öode
(&
is
.
ûoc
)->
i_block
,

439 0, 
PXT4_MIN_INLINE_DATA_SIZE
);

440 
	`mem£t
(
ei
->
i_d©a
, 0, 
PXT4_MIN_INLINE_DATA_SIZE
);

442 i‡(
	`pxt4_has_„©uª_exã¡s
(
öode
->
i_sb
)) {

443 i‡(
	`S_ISDIR
(
öode
->
i_mode
) ||

444 
	`S_ISREG
(
öode
->
i_mode
Ë|| 
	`S_ISLNK
(inode->i_mode)) {

445 
	`pxt4_£t_öode_Êag
(
öode
, 
PXT4_INODE_EXTENTS
);

446 
	`pxt4_ext_åì_öô
(
h™dÀ
, 
öode
);

449 
	`pxt4_˛ór_öode_Êag
(
öode
, 
PXT4_INODE_INLINE_DATA
);

451 
	`gë_bh
(
is
.
ûoc
.
bh
);

452 
îr‹
 = 
	`pxt4_m¨k_ûoc_dúty
(
h™dÀ
, 
öode
, &
is
.
ûoc
);

454 
	`PXT4_I
(
öode
)->
i_ölöe_off
 = 0;

455 
	`PXT4_I
(
öode
)->
i_ölöe_size
 = 0;

456 
	`pxt4_˛ór_öode_°©e
(
öode
, 
PXT4_STATE_MAY_INLINE_DATA
);

457 
out
:

458 
	`bªl£
(
is
.
ûoc
.
bh
);

459 i‡(
îr‹
 =-
ENODATA
)

460 
îr‹
 = 0;

461  
îr‹
;

462 
	}
}

464 
	$pxt4_ªad_ölöe_∑ge
(
öode
 *öode, 
∑ge
 *page)

466 *
kaddr
;

467 
ªt
 = 0;

468 
size_t
 
Àn
;

469 
pxt4_ûoc
 
ûoc
;

471 
	`BUG_ON
(!
	`PageLocked
(
∑ge
));

472 
	`BUG_ON
(!
	`pxt4_has_ölöe_d©a
(
öode
));

473 
	`BUG_ON
(
∑ge
->
ödex
);

475 i‡(!
	`PXT4_I
(
öode
)->
i_ölöe_off
) {

476 
	`pxt4_w¨nög
(
öode
->
i_sb
, "inode %lu doesn't have inline data.",

477 
öode
->
i_öo
);

478 
out
;

481 
ªt
 = 
	`pxt4_gë_öode_loc
(
öode
, &
ûoc
);

482 i‡(
ªt
)

483 
out
;

485 
Àn
 = 
	`mö_t
(
size_t
, 
	`pxt4_gë_ölöe_size
(
öode
), 
	`i_size_ªad
(inode));

486 
kaddr
 = 
	`km≠_©omic
(
∑ge
);

487 
ªt
 = 
	`pxt4_ªad_ölöe_d©a
(
öode
, 
kaddr
, 
Àn
, &
ûoc
);

488 
	`Êush_dˇche_∑ge
(
∑ge
);

489 
	`kunm≠_©omic
(
kaddr
);

490 
	`zîo_u£r_£gmít
(
∑ge
, 
Àn
, 
PAGE_SIZE
);

491 
	`SëPageU±od©e
(
∑ge
);

492 
	`bªl£
(
ûoc
.
bh
);

494 
out
:

495  
ªt
;

496 
	}
}

498 
	$pxt4_ªad∑ge_ölöe
(
öode
 *öode, 
∑ge
 *page)

500 
ªt
 = 0;

502 
	`down_ªad
(&
	`PXT4_I
(
öode
)->
x©å_£m
);

503 i‡(!
	`pxt4_has_ölöe_d©a
(
öode
)) {

504 
	`up_ªad
(&
	`PXT4_I
(
öode
)->
x©å_£m
);

505  -
EAGAIN
;

512 i‡(!
∑ge
->
ödex
)

513 
ªt
 = 
	`pxt4_ªad_ölöe_∑ge
(
öode
, 
∑ge
);

514 i‡(!
	`PageU±od©e
(
∑ge
)) {

515 
	`zîo_u£r_£gmít
(
∑ge
, 0, 
PAGE_SIZE
);

516 
	`SëPageU±od©e
(
∑ge
);

519 
	`up_ªad
(&
	`PXT4_I
(
öode
)->
x©å_£m
);

521 
	`u∆ock_∑ge
(
∑ge
);

522  
ªt
 >= 0 ? 0 :Ñet;

523 
	}
}

525 
	$pxt4_c⁄vît_ölöe_d©a_to_exã¡
(
addªss_•a˚
 *
m≠pög
,

526 
öode
 *inode,

527 
Êags
)

529 
ªt
, 
√eded_blocks
, 
no_ex∑nd
;

530 
h™dÀ_t
 *
h™dÀ
 = 
NULL
;

531 
ªåõs
 = 0, 
£m_hñd
 = 0;

532 
∑ge
 *∑gê
NULL
;

533 
‰om
, 
to
;

534 
pxt4_ûoc
 
ûoc
;

536 i‡(!
	`pxt4_has_ölöe_d©a
(
öode
)) {

541 
	`pxt4_˛ór_öode_°©e
(
öode
, 
PXT4_STATE_MAY_INLINE_DATA
);

545 
√eded_blocks
 = 
	`pxt4_wrôïage_å™s_blocks
(
öode
);

547 
ªt
 = 
	`pxt4_gë_öode_loc
(
öode
, &
ûoc
);

548 i‡(
ªt
)

549  
ªt
;

551 
ªåy
:

552 
h™dÀ
 = 
	`pxt4_jou∫Æ_°¨t
(
öode
, 
PXT4_HT_WRITE_PAGE
, 
√eded_blocks
);

553 i‡(
	`IS_ERR
(
h™dÀ
)) {

554 
ªt
 = 
	`PTR_ERR
(
h™dÀ
);

555 
h™dÀ
 = 
NULL
;

556 
out
;

561 
Êags
 |
AOP_FLAG_NOFS
;

563 
∑ge
 = 
	`gøb_ˇche_∑ge_wrôe_begö
(
m≠pög
, 0, 
Êags
);

564 i‡(!
∑ge
) {

565 
ªt
 = -
ENOMEM
;

566 
out
;

569 
	`pxt4_wrôe_lock_x©å
(
öode
, &
no_ex∑nd
);

570 
£m_hñd
 = 1;

572 i‡(!
	`pxt4_has_ölöe_d©a
(
öode
)) {

573 
ªt
 = 0;

574 
out
;

577 
‰om
 = 0;

578 
to
 = 
	`pxt4_gë_ölöe_size
(
öode
);

579 i‡(!
	`PageU±od©e
(
∑ge
)) {

580 
ªt
 = 
	`pxt4_ªad_ölöe_∑ge
(
öode
, 
∑ge
);

581 i‡(
ªt
 < 0)

582 
out
;

585 
ªt
 = 
	`pxt4_de°roy_ölöe_d©a_nﬁock
(
h™dÀ
, 
öode
);

586 i‡(
ªt
)

587 
out
;

589 i‡(
	`pxt4_should_di‹ód_nﬁock
(
öode
)) {

590 
ªt
 = 
	`__block_wrôe_begö
(
∑ge
, 
‰om
, 
to
,

591 
pxt4_gë_block_unwrôãn
);

593 
ªt
 = 
	`__block_wrôe_begö
(
∑ge
, 
‰om
, 
to
, 
pxt4_gë_block
);

595 i‡(!
ªt
 && 
	`pxt4_should_jou∫Æ_d©a
(
öode
)) {

596 
ªt
 = 
	`pxt4_wÆk_∑ge_buf„rs
(
h™dÀ
, 
	`∑ge_buf„rs
(
∑ge
),

597 
‰om
, 
to
, 
NULL
,

598 
do_jou∫Æ_gë_wrôe_ac˚ss
);

601 i‡(
ªt
) {

602 
	`u∆ock_∑ge
(
∑ge
);

603 
	`put_∑ge
(
∑ge
);

604 
∑ge
 = 
NULL
;

605 
	`pxt4_‹ph™_add
(
h™dÀ
, 
öode
);

606 
	`pxt4_wrôe_u∆ock_x©å
(
öode
, &
no_ex∑nd
);

607 
£m_hñd
 = 0;

608 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

609 
h™dÀ
 = 
NULL
;

610 
	`pxt4_åunˇã_Áûed_wrôe
(
öode
);

617 i‡(
öode
->
i_∆ök
)

618 
	`pxt4_‹ph™_dñ
(
NULL
, 
öode
);

621 i‡(
ªt
 =-
ENOSPC
 && 
	`pxt4_should_ªåy_Æloc
(
öode
->
i_sb
, &
ªåõs
))

622 
ªåy
;

624 i‡(
∑ge
)

625 
	`block_commô_wrôe
(
∑ge
, 
‰om
, 
to
);

626 
out
:

627 i‡(
∑ge
) {

628 
	`u∆ock_∑ge
(
∑ge
);

629 
	`put_∑ge
(
∑ge
);

631 i‡(
£m_hñd
)

632 
	`pxt4_wrôe_u∆ock_x©å
(
öode
, &
no_ex∑nd
);

633 i‡(
h™dÀ
)

634 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

635 
	`bªl£
(
ûoc
.
bh
);

636  
ªt
;

637 
	}
}

645 
	$pxt4_åy_to_wrôe_ölöe_d©a
(
addªss_•a˚
 *
m≠pög
,

646 
öode
 *inode,

647 
loff_t
 
pos
, 
Àn
,

648 
Êags
,

649 
∑ge
 **
∑gï
)

651 
ªt
;

652 
h™dÀ_t
 *
h™dÀ
;

653 
∑ge
 *page;

654 
pxt4_ûoc
 
ûoc
;

656 i‡(
pos
 + 
Àn
 > 
	`pxt4_gë_max_ölöe_size
(
öode
))

657 
c⁄vît
;

659 
ªt
 = 
	`pxt4_gë_öode_loc
(
öode
, &
ûoc
);

660 i‡(
ªt
)

661  
ªt
;

667 
h™dÀ
 = 
	`pxt4_jou∫Æ_°¨t
(
öode
, 
PXT4_HT_INODE
, 1);

668 i‡(
	`IS_ERR
(
h™dÀ
)) {

669 
ªt
 = 
	`PTR_ERR
(
h™dÀ
);

670 
h™dÀ
 = 
NULL
;

671 
out
;

674 
ªt
 = 
	`pxt4_¥ï¨e_ölöe_d©a
(
h™dÀ
, 
öode
, 
pos
 + 
Àn
);

675 i‡(
ªt
 &&Ñë !-
ENOSPC
)

676 
out
;

679 i‡(
ªt
 =-
ENOSPC
) {

680 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

681 
	`bªl£
(
ûoc
.
bh
);

682 
c⁄vît
;

685 
ªt
 = 
	`pxt4_jou∫Æ_gë_wrôe_ac˚ss
(
h™dÀ
, 
ûoc
.
bh
);

686 i‡(
ªt
)

687 
out
;

689 
Êags
 |
AOP_FLAG_NOFS
;

691 
∑ge
 = 
	`gøb_ˇche_∑ge_wrôe_begö
(
m≠pög
, 0, 
Êags
);

692 i‡(!
∑ge
) {

693 
ªt
 = -
ENOMEM
;

694 
out
;

697 *
∑gï
 = 
∑ge
;

698 
	`down_ªad
(&
	`PXT4_I
(
öode
)->
x©å_£m
);

699 i‡(!
	`pxt4_has_ölöe_d©a
(
öode
)) {

700 
ªt
 = 0;

701 
	`u∆ock_∑ge
(
∑ge
);

702 
	`put_∑ge
(
∑ge
);

703 
out_up_ªad
;

706 i‡(!
	`PageU±od©e
(
∑ge
)) {

707 
ªt
 = 
	`pxt4_ªad_ölöe_∑ge
(
öode
, 
∑ge
);

708 i‡(
ªt
 < 0) {

709 
	`u∆ock_∑ge
(
∑ge
);

710 
	`put_∑ge
(
∑ge
);

711 
out_up_ªad
;

715 
ªt
 = 1;

716 
h™dÀ
 = 
NULL
;

717 
out_up_ªad
:

718 
	`up_ªad
(&
	`PXT4_I
(
öode
)->
x©å_£m
);

719 
out
:

720 i‡(
h™dÀ
 && (
ªt
 != 1))

721 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

722 
	`bªl£
(
ûoc
.
bh
);

723  
ªt
;

724 
c⁄vît
:

725  
	`pxt4_c⁄vît_ölöe_d©a_to_exã¡
(
m≠pög
,

726 
öode
, 
Êags
);

727 
	}
}

729 
	$pxt4_wrôe_ölöe_d©a_íd
(
öode
 *öode, 
loff_t
 
pos
, 
Àn
,

730 
c›õd
, 
∑ge
 *page)

732 
ªt
, 
no_ex∑nd
;

733 *
kaddr
;

734 
pxt4_ûoc
 
ûoc
;

736 i‡(
	`u∆ikñy
(
c›õd
 < 
Àn
)) {

737 i‡(!
	`PageU±od©e
(
∑ge
)) {

738 
c›õd
 = 0;

739 
out
;

743 
ªt
 = 
	`pxt4_gë_öode_loc
(
öode
, &
ûoc
);

744 i‡(
ªt
) {

745 
	`pxt4_°d_îr‹
(
öode
->
i_sb
, 
ªt
);

746 
c›õd
 = 0;

747 
out
;

750 
	`pxt4_wrôe_lock_x©å
(
öode
, &
no_ex∑nd
);

751 
	`BUG_ON
(!
	`pxt4_has_ölöe_d©a
(
öode
));

757 (Ë
	`pxt4_föd_ölöe_d©a_nﬁock
(
öode
);

759 
kaddr
 = 
	`km≠_©omic
(
∑ge
);

760 
	`pxt4_wrôe_ölöe_d©a
(
öode
, &
ûoc
, 
kaddr
, 
pos
, 
Àn
);

761 
	`kunm≠_©omic
(
kaddr
);

762 
	`SëPageU±od©e
(
∑ge
);

764 
	`CÀ¨PageDúty
(
∑ge
);

766 
	`pxt4_wrôe_u∆ock_x©å
(
öode
, &
no_ex∑nd
);

767 
	`bªl£
(
ûoc
.
bh
);

768 
	`m¨k_öode_dúty
(
öode
);

769 
out
:

770  
c›õd
;

771 
	}
}

773 
buf„r_hód
 *

774 
	$pxt4_jou∫ÆÀd_wrôe_ölöe_d©a
(
öode
 *inode,

775 
Àn
,

776 
∑ge
 *page)

778 
ªt
, 
no_ex∑nd
;

779 *
kaddr
;

780 
pxt4_ûoc
 
ûoc
;

782 
ªt
 = 
	`pxt4_gë_öode_loc
(
öode
, &
ûoc
);

783 i‡(
ªt
) {

784 
	`pxt4_°d_îr‹
(
öode
->
i_sb
, 
ªt
);

785  
NULL
;

788 
	`pxt4_wrôe_lock_x©å
(
öode
, &
no_ex∑nd
);

789 
kaddr
 = 
	`km≠_©omic
(
∑ge
);

790 
	`pxt4_wrôe_ölöe_d©a
(
öode
, &
ûoc
, 
kaddr
, 0, 
Àn
);

791 
	`kunm≠_©omic
(
kaddr
);

792 
	`pxt4_wrôe_u∆ock_x©å
(
öode
, &
no_ex∑nd
);

794  
ûoc
.
bh
;

795 
	}
}

806 
	$pxt4_da_c⁄vît_ölöe_d©a_to_exã¡
(
addªss_•a˚
 *
m≠pög
,

807 
öode
 *inode,

808 
Êags
,

809 **
fsd©a
)

811 
ªt
 = 0, 
ölöe_size
;

812 
∑ge
 *page;

814 
∑ge
 = 
	`gøb_ˇche_∑ge_wrôe_begö
(
m≠pög
, 0, 
Êags
);

815 i‡(!
∑ge
)

816  -
ENOMEM
;

818 
	`down_ªad
(&
	`PXT4_I
(
öode
)->
x©å_£m
);

819 i‡(!
	`pxt4_has_ölöe_d©a
(
öode
)) {

820 
	`pxt4_˛ór_öode_°©e
(
öode
, 
PXT4_STATE_MAY_INLINE_DATA
);

821 
out
;

824 
ölöe_size
 = 
	`pxt4_gë_ölöe_size
(
öode
);

826 i‡(!
	`PageU±od©e
(
∑ge
)) {

827 
ªt
 = 
	`pxt4_ªad_ölöe_∑ge
(
öode
, 
∑ge
);

828 i‡(
ªt
 < 0)

829 
out
;

832 
ªt
 = 
	`__block_wrôe_begö
(
∑ge
, 0, 
ölöe_size
,

833 
pxt4_da_gë_block_¥ï
);

834 i‡(
ªt
) {

835 
	`up_ªad
(&
	`PXT4_I
(
öode
)->
x©å_£m
);

836 
	`u∆ock_∑ge
(
∑ge
);

837 
	`put_∑ge
(
∑ge
);

838 
	`pxt4_åunˇã_Áûed_wrôe
(
öode
);

839  
ªt
;

842 
	`SëPageDúty
(
∑ge
);

843 
	`SëPageU±od©e
(
∑ge
);

844 
	`pxt4_˛ór_öode_°©e
(
öode
, 
PXT4_STATE_MAY_INLINE_DATA
);

845 *
fsd©a
 = (*)
CONVERT_INLINE_DATA
;

847 
out
:

848 
	`up_ªad
(&
	`PXT4_I
(
öode
)->
x©å_£m
);

849 i‡(
∑ge
) {

850 
	`u∆ock_∑ge
(
∑ge
);

851 
	`put_∑ge
(
∑ge
);

853  
ªt
;

854 
	}
}

864 
	$pxt4_da_wrôe_ölöe_d©a_begö
(
addªss_•a˚
 *
m≠pög
,

865 
öode
 *inode,

866 
loff_t
 
pos
, 
Àn
,

867 
Êags
,

868 
∑ge
 **
∑gï
,

869 **
fsd©a
)

871 
ªt
, 
ölöe_size
;

872 
h™dÀ_t
 *
h™dÀ
;

873 
∑ge
 *page;

874 
pxt4_ûoc
 
ûoc
;

875 
ªåõs
 = 0;

877 
ªt
 = 
	`pxt4_gë_öode_loc
(
öode
, &
ûoc
);

878 i‡(
ªt
)

879  
ªt
;

881 
ªåy_jou∫Æ
:

882 
h™dÀ
 = 
	`pxt4_jou∫Æ_°¨t
(
öode
, 
PXT4_HT_INODE
, 1);

883 i‡(
	`IS_ERR
(
h™dÀ
)) {

884 
ªt
 = 
	`PTR_ERR
(
h™dÀ
);

885 
out
;

888 
ölöe_size
 = 
	`pxt4_gë_max_ölöe_size
(
öode
);

890 
ªt
 = -
ENOSPC
;

891 i‡(
ölöe_size
 >
pos
 + 
Àn
) {

892 
ªt
 = 
	`pxt4_¥ï¨e_ölöe_d©a
(
h™dÀ
, 
öode
, 
pos
 + 
Àn
);

893 i‡(
ªt
 &&Ñë !-
ENOSPC
)

894 
out_jou∫Æ
;

901 
Êags
 |
AOP_FLAG_NOFS
;

903 i‡(
ªt
 =-
ENOSPC
) {

904 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

905 
ªt
 = 
	`pxt4_da_c⁄vît_ölöe_d©a_to_exã¡
(
m≠pög
,

906 
öode
,

907 
Êags
,

908 
fsd©a
);

909 i‡(
ªt
 =-
ENOSPC
 &&

910 
	`pxt4_should_ªåy_Æloc
(
öode
->
i_sb
, &
ªåõs
))

911 
ªåy_jou∫Æ
;

912 
out
;

915 
∑ge
 = 
	`gøb_ˇche_∑ge_wrôe_begö
(
m≠pög
, 0, 
Êags
);

916 i‡(!
∑ge
) {

917 
ªt
 = -
ENOMEM
;

918 
out_jou∫Æ
;

921 
	`down_ªad
(&
	`PXT4_I
(
öode
)->
x©å_£m
);

922 i‡(!
	`pxt4_has_ölöe_d©a
(
öode
)) {

923 
ªt
 = 0;

924 
out_ªÀa£_∑ge
;

927 i‡(!
	`PageU±od©e
(
∑ge
)) {

928 
ªt
 = 
	`pxt4_ªad_ölöe_∑ge
(
öode
, 
∑ge
);

929 i‡(
ªt
 < 0)

930 
out_ªÀa£_∑ge
;

932 
ªt
 = 
	`pxt4_jou∫Æ_gë_wrôe_ac˚ss
(
h™dÀ
, 
ûoc
.
bh
);

933 i‡(
ªt
)

934 
out_ªÀa£_∑ge
;

936 
	`up_ªad
(&
	`PXT4_I
(
öode
)->
x©å_£m
);

937 *
∑gï
 = 
∑ge
;

938 
	`bªl£
(
ûoc
.
bh
);

940 
out_ªÀa£_∑ge
:

941 
	`up_ªad
(&
	`PXT4_I
(
öode
)->
x©å_£m
);

942 
	`u∆ock_∑ge
(
∑ge
);

943 
	`put_∑ge
(
∑ge
);

944 
out_jou∫Æ
:

945 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

946 
out
:

947 
	`bªl£
(
ûoc
.
bh
);

948  
ªt
;

949 
	}
}

951 
	$pxt4_da_wrôe_ölöe_d©a_íd
(
öode
 *öode, 
loff_t
 
pos
,

952 
Àn
, 
c›õd
,

953 
∑ge
 *page)

955 
ªt
;

957 
ªt
 = 
	`pxt4_wrôe_ölöe_d©a_íd
(
öode
, 
pos
, 
Àn
, 
c›õd
, 
∑ge
);

958 i‡(
ªt
 < 0) {

959 
	`u∆ock_∑ge
(
∑ge
);

960 
	`put_∑ge
(
∑ge
);

961  
ªt
;

963 
c›õd
 = 
ªt
;

972 i‡(
pos
+
c›õd
 > 
öode
->
i_size
)

973 
	`i_size_wrôe
(
öode
, 
pos
+
c›õd
);

974 
	`u∆ock_∑ge
(
∑ge
);

975 
	`put_∑ge
(
∑ge
);

983 
	`m¨k_öode_dúty
(
öode
);

985  
c›õd
;

986 
	}
}

988 #ifde‡
INLINE_DIR_DEBUG


989 
	$pxt4_show_ölöe_dú
(
öode
 *
dú
, 
buf„r_hód
 *
bh
,

990 *
ölöe_°¨t
, 
ölöe_size
)

992 
off£t
;

993 
de_Àn
;

994 
pxt4_dú_íåy_2
 *
de
 = 
ölöe_°¨t
;

995 *
dlimô
 = 
ölöe_°¨t
 + 
ölöe_size
;

997 
	`åa˚_¥ötk
("öodê%lu\n", 
dú
->
i_öo
);

998 
off£t
 = 0;

999 (*)
de
 < 
dlimô
) {

1000 
de_Àn
 = 
	`pxt4_ªc_Àn_‰om_disk
(
de
->
ªc_Àn
, 
ölöe_size
);

1001 
	`åa˚_¥ötk
("de: off %uÑlen %uÇame %.*sÇlen %u ino %u\n",

1002 
off£t
, 
de_Àn
, 
de
->
«me_Àn
, de->
«me
,

1003 
de
->
«me_Àn
, 
	`À32_to_˝u
(de->
öode
));

1004 i‡(
	`pxt4_check_dú_íåy
(
dú
, 
NULL
, 
de
, 
bh
,

1005 
ölöe_°¨t
, 
ölöe_size
, 
off£t
))

1006 
	`BUG
();

1008 
off£t
 +
de_Àn
;

1009 
de
 = (
pxt4_dú_íåy_2
 *Ë((*Ëdê+ 
de_Àn
);

1011 
	}
}

1013 
	#pxt4_show_ölöe_dú
(
dú
, 
bh
, 
ölöe_°¨t
, 
ölöe_size
)

	)

1021 
	$pxt4_add_dúít_to_ölöe
(
h™dÀ_t
 *
h™dÀ
,

1022 
pxt4_fûíame
 *
‚ame
,

1023 
öode
 *
dú
,

1024 
öode
 *inode,

1025 
pxt4_ûoc
 *
ûoc
,

1026 *
ölöe_°¨t
, 
ölöe_size
)

1028 
îr
;

1029 
pxt4_dú_íåy_2
 *
de
;

1031 
îr
 = 
	`pxt4_föd_de°_de
(
dú
, 
öode
, 
ûoc
->
bh
, 
ölöe_°¨t
,

1032 
ölöe_size
, 
‚ame
, &
de
);

1033 i‡(
îr
)

1034  
îr
;

1036 
	`BUFFER_TRACE
(
ûoc
->
bh
, "get_write_access");

1037 
îr
 = 
	`pxt4_jou∫Æ_gë_wrôe_ac˚ss
(
h™dÀ
, 
ûoc
->
bh
);

1038 i‡(
îr
)

1039  
îr
;

1040 
	`pxt4_ö£π_díåy
(
öode
, 
de
, 
ölöe_size
, 
‚ame
);

1042 
	`pxt4_show_ölöe_dú
(
dú
, 
ûoc
->
bh
, 
ölöe_°¨t
, 
ölöe_size
);

1055 
dú
->
i_mtime
 = dú->
i_˘ime
 = 
	`cuºít_time
(dir);

1056 
	`pxt4_upd©e_dx_Êag
(
dú
);

1057 
	`öode_öc_ivîsi⁄
(
dú
);

1059 
	}
}

1061 *
	$pxt4_gë_ölöe_x©å_pos
(
öode
 *inode,

1062 
pxt4_ûoc
 *
ûoc
)

1064 
pxt4_x©å_íåy
 *
íåy
;

1065 
pxt4_x©å_ibody_hódî
 *
hódî
;

1067 
	`BUG_ON
(!
	`PXT4_I
(
öode
)->
i_ölöe_off
);

1069 
hódî
 = 
	`IHDR
(
öode
, 
	`pxt4_øw_öode
(
ûoc
));

1070 
íåy
 = (
pxt4_x©å_íåy
 *)((*)
	`pxt4_øw_öode
(
ûoc
) +

1071 
	`PXT4_I
(
öode
)->
i_ölöe_off
);

1073  (*)
	`IFIRST
(
hódî
Ë+ 
	`À16_to_˝u
(
íåy
->
e_vÆue_offs
);

1074 
	}
}

1077 
	$pxt4_upd©e_föÆ_de
(*
de_buf
, 
ﬁd_size
, 
√w_size
)

1079 
pxt4_dú_íåy_2
 *
de
, *
¥ev_de
;

1080 *
limô
;

1081 
de_Àn
;

1083 
de
 = (
pxt4_dú_íåy_2
 *)
de_buf
;

1084 i‡(
ﬁd_size
) {

1085 
limô
 = 
de_buf
 + 
ﬁd_size
;

1087 
¥ev_de
 = 
de
;

1088 
de_Àn
 = 
	`pxt4_ªc_Àn_‰om_disk
(
de
->
ªc_Àn
, 
ﬁd_size
);

1089 
de_buf
 +
de_Àn
;

1090 
de
 = (
pxt4_dú_íåy_2
 *)
de_buf
;

1091 } 
de_buf
 < 
limô
);

1093 
¥ev_de
->
ªc_Àn
 = 
	`pxt4_ªc_Àn_to_disk
(
de_Àn
 + 
√w_size
 -

1094 
ﬁd_size
, 
√w_size
);

1097 
de
->
öode
 = 0;

1098 
de
->
ªc_Àn
 = 
	`pxt4_ªc_Àn_to_disk
(
√w_size
,Çew_size);

1100 
	}
}

1102 
	$pxt4_upd©e_ölöe_dú
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *
dú
,

1103 
pxt4_ûoc
 *
ûoc
)

1105 
ªt
;

1106 
ﬁd_size
 = 
	`PXT4_I
(
dú
)->
i_ölöe_size
 - 
PXT4_MIN_INLINE_DATA_SIZE
;

1107 
√w_size
 = 
	`gë_max_ölöe_x©å_vÆue_size
(
dú
, 
ûoc
);

1109 i‡(
√w_size
 - 
ﬁd_size
 <
	`PXT4_DIR_REC_LEN
(1))

1110  -
ENOSPC
;

1112 
ªt
 = 
	`pxt4_upd©e_ölöe_d©a
(
h™dÀ
, 
dú
,

1113 
√w_size
 + 
PXT4_MIN_INLINE_DATA_SIZE
);

1114 i‡(
ªt
)

1115  
ªt
;

1117 
	`pxt4_upd©e_föÆ_de
(
	`pxt4_gë_ölöe_x©å_pos
(
dú
, 
ûoc
), 
ﬁd_size
,

1118 
	`PXT4_I
(
dú
)->
i_ölöe_size
 -

1119 
PXT4_MIN_INLINE_DATA_SIZE
);

1120 
dú
->
i_size
 = 
	`PXT4_I
(dú)->
i_disksize
 = PXT4_I(dú)->
i_ölöe_size
;

1122 
	}
}

1124 
	$pxt4_ª°‹e_ölöe_d©a
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *inode,

1125 
pxt4_ûoc
 *
ûoc
,

1126 *
buf
, 
ölöe_size
)

1128 
	`pxt4_¸óã_ölöe_d©a
(
h™dÀ
, 
öode
, 
ölöe_size
);

1129 
	`pxt4_wrôe_ölöe_d©a
(
öode
, 
ûoc
, 
buf
, 0, 
ölöe_size
);

1130 
	`pxt4_£t_öode_°©e
(
öode
, 
PXT4_STATE_MAY_INLINE_DATA
);

1131 
	}
}

1133 
	$pxt4_föish_c⁄vît_ölöe_dú
(
h™dÀ_t
 *
h™dÀ
,

1134 
öode
 *inode,

1135 
buf„r_hód
 *
dú_block
,

1136 *
buf
,

1137 
ölöe_size
)

1139 
îr
, 
csum_size
 = 0, 
hódî_size
 = 0;

1140 
pxt4_dú_íåy_2
 *
de
;

1141 *
èrgë
 = 
dú_block
->
b_d©a
;

1147 
de
 = (
pxt4_dú_íåy_2
 *)
èrgë
;

1148 
de
 = 
	`pxt4_öô_dŸ_dŸdŸ
(
öode
, de,

1149 
öode
->
i_sb
->
s_blocksize
, 
csum_size
,

1150 
	`À32_to_˝u
(((
pxt4_dú_íåy_2
 *)
buf
)->
öode
), 1);

1151 
hódî_size
 = (*)
de
 - 
èrgë
;

1153 
	`mem˝y
((*)
de
, 
buf
 + 
PXT4_INLINE_DOTDOT_SIZE
,

1154 
ölöe_size
 - 
PXT4_INLINE_DOTDOT_SIZE
);

1156 i‡(
	`pxt4_has_mëad©a_csum
(
öode
->
i_sb
))

1157 
csum_size
 = (
pxt4_dú_íåy_èû
);

1159 
öode
->
i_size
 = inode->
i_sb
->
s_blocksize
;

1160 
	`i_size_wrôe
(
öode
, inode->
i_sb
->
s_blocksize
);

1161 
	`PXT4_I
(
öode
)->
i_disksize
 = inode->
i_sb
->
s_blocksize
;

1162 
	`pxt4_upd©e_föÆ_de
(
dú_block
->
b_d©a
,

1163 
ölöe_size
 - 
PXT4_INLINE_DOTDOT_SIZE
 + 
hódî_size
,

1164 
öode
->
i_sb
->
s_blocksize
 - 
csum_size
);

1166 i‡(
csum_size
)

1167 
	`pxt4_öôülize_dúít_èû
(
dú_block
,

1168 
öode
->
i_sb
->
s_blocksize
);

1169 
	`£t_buf„r_u±od©e
(
dú_block
);

1170 
îr
 = 
	`pxt4_h™dÀ_dúty_dúblock
(
h™dÀ
, 
öode
, 
dú_block
);

1171 i‡(
îr
)

1172  
îr
;

1173 
	`£t_buf„r_vîifõd
(
dú_block
);

1174  
	`pxt4_m¨k_öode_dúty
(
h™dÀ
, 
öode
);

1175 
	}
}

1177 
	$pxt4_c⁄vît_ölöe_d©a_nﬁock
(
h™dÀ_t
 *
h™dÀ
,

1178 
öode
 *inode,

1179 
pxt4_ûoc
 *
ûoc
)

1181 
îr‹
;

1182 *
buf
 = 
NULL
;

1183 
buf„r_hód
 *
d©a_bh
 = 
NULL
;

1184 
pxt4_m≠_blocks
 
m≠
;

1185 
ölöe_size
;

1187 
ölöe_size
 = 
	`pxt4_gë_ölöe_size
(
öode
);

1188 
buf
 = 
	`kmÆloc
(
ölöe_size
, 
GFP_NOFS
);

1189 i‡(!
buf
) {

1190 
îr‹
 = -
ENOMEM
;

1191 
out
;

1194 
îr‹
 = 
	`pxt4_ªad_ölöe_d©a
(
öode
, 
buf
, 
ölöe_size
, 
ûoc
);

1195 i‡(
îr‹
 < 0)

1196 
out
;

1202 i‡(
	`S_ISDIR
(
öode
->
i_mode
)) {

1203 
îr‹
 = 
	`pxt4_check_Æl_de
(
öode
, 
ûoc
->
bh
,

1204 
buf
 + 
PXT4_INLINE_DOTDOT_SIZE
,

1205 
ölöe_size
 - 
PXT4_INLINE_DOTDOT_SIZE
);

1206 i‡(
îr‹
)

1207 
out
;

1210 
îr‹
 = 
	`pxt4_de°roy_ölöe_d©a_nﬁock
(
h™dÀ
, 
öode
);

1211 i‡(
îr‹
)

1212 
out
;

1214 
m≠
.
m_lblk
 = 0;

1215 
m≠
.
m_Àn
 = 1;

1216 
m≠
.
m_Êags
 = 0;

1217 
îr‹
 = 
	`pxt4_m≠_blocks
(
h™dÀ
, 
öode
, &
m≠
, 
PXT4_GET_BLOCKS_CREATE
);

1218 i‡(
îr‹
 < 0)

1219 
out_ª°‹e
;

1220 i‡(!(
m≠
.
m_Êags
 & 
PXT4_MAP_MAPPED
)) {

1221 
îr‹
 = -
EIO
;

1222 
out_ª°‹e
;

1225 
d©a_bh
 = 
	`sb_gëblk
(
öode
->
i_sb
, 
m≠
.
m_pblk
);

1226 i‡(!
d©a_bh
) {

1227 
îr‹
 = -
ENOMEM
;

1228 
out_ª°‹e
;

1231 
	`lock_buf„r
(
d©a_bh
);

1232 
îr‹
 = 
	`pxt4_jou∫Æ_gë_¸óã_ac˚ss
(
h™dÀ
, 
d©a_bh
);

1233 i‡(
îr‹
) {

1234 
	`u∆ock_buf„r
(
d©a_bh
);

1235 
îr‹
 = -
EIO
;

1236 
out_ª°‹e
;

1238 
	`mem£t
(
d©a_bh
->
b_d©a
, 0, 
öode
->
i_sb
->
s_blocksize
);

1240 i‡(!
	`S_ISDIR
(
öode
->
i_mode
)) {

1241 
	`mem˝y
(
d©a_bh
->
b_d©a
, 
buf
, 
ölöe_size
);

1242 
	`£t_buf„r_u±od©e
(
d©a_bh
);

1243 
îr‹
 = 
	`pxt4_h™dÀ_dúty_mëad©a
(
h™dÀ
,

1244 
öode
, 
d©a_bh
);

1246 
îr‹
 = 
	`pxt4_föish_c⁄vît_ölöe_dú
(
h™dÀ
, 
öode
, 
d©a_bh
,

1247 
buf
, 
ölöe_size
);

1250 
	`u∆ock_buf„r
(
d©a_bh
);

1251 
out_ª°‹e
:

1252 i‡(
îr‹
)

1253 
	`pxt4_ª°‹e_ölöe_d©a
(
h™dÀ
, 
öode
, 
ûoc
, 
buf
, 
ölöe_size
);

1255 
out
:

1256 
	`bªl£
(
d©a_bh
);

1257 
	`k‰ì
(
buf
);

1258  
îr‹
;

1259 
	}
}

1266 
	$pxt4_åy_add_ölöe_íåy
(
h™dÀ_t
 *
h™dÀ
, 
pxt4_fûíame
 *
‚ame
,

1267 
öode
 *
dú
, inode *inode)

1269 
ªt
, 
ölöe_size
, 
no_ex∑nd
;

1270 *
ölöe_°¨t
;

1271 
pxt4_ûoc
 
ûoc
;

1273 
ªt
 = 
	`pxt4_gë_öode_loc
(
dú
, &
ûoc
);

1274 i‡(
ªt
)

1275  
ªt
;

1277 
	`pxt4_wrôe_lock_x©å
(
dú
, &
no_ex∑nd
);

1278 i‡(!
	`pxt4_has_ölöe_d©a
(
dú
))

1279 
out
;

1281 
ölöe_°¨t
 = (*)
	`pxt4_øw_öode
(&
ûoc
)->
i_block
 +

1282 
PXT4_INLINE_DOTDOT_SIZE
;

1283 
ölöe_size
 = 
PXT4_MIN_INLINE_DATA_SIZE
 - 
PXT4_INLINE_DOTDOT_SIZE
;

1285 
ªt
 = 
	`pxt4_add_dúít_to_ölöe
(
h™dÀ
, 
‚ame
, 
dú
, 
öode
, &
ûoc
,

1286 
ölöe_°¨t
, 
ölöe_size
);

1287 i‡(
ªt
 !-
ENOSPC
)

1288 
out
;

1291 
ölöe_size
 = 
	`PXT4_I
(
dú
)->
i_ölöe_size
 -

1292 
PXT4_MIN_INLINE_DATA_SIZE
;

1293 i‡(!
ölöe_size
) {

1295 
ªt
 = 
	`pxt4_upd©e_ölöe_dú
(
h™dÀ
, 
dú
, &
ûoc
);

1296 i‡(
ªt
 &&Ñë !-
ENOSPC
)

1297 
out
;

1299 
ölöe_size
 = 
	`PXT4_I
(
dú
)->
i_ölöe_size
 -

1300 
PXT4_MIN_INLINE_DATA_SIZE
;

1303 i‡(
ölöe_size
) {

1304 
ölöe_°¨t
 = 
	`pxt4_gë_ölöe_x©å_pos
(
dú
, &
ûoc
);

1306 
ªt
 = 
	`pxt4_add_dúít_to_ölöe
(
h™dÀ
, 
‚ame
, 
dú
,

1307 
öode
, &
ûoc
, 
ölöe_°¨t
,

1308 
ölöe_size
);

1310 i‡(
ªt
 !-
ENOSPC
)

1311 
out
;

1319 
ªt
 = 
	`pxt4_c⁄vît_ölöe_d©a_nﬁock
(
h™dÀ
, 
dú
, &
ûoc
);

1321 
out
:

1322 
	`pxt4_wrôe_u∆ock_x©å
(
dú
, &
no_ex∑nd
);

1323 
	`pxt4_m¨k_öode_dúty
(
h™dÀ
, 
dú
);

1324 
	`bªl£
(
ûoc
.
bh
);

1325  
ªt
;

1326 
	}
}

1333 
	$pxt4_ölöedú_to_åì
(
fûe
 *
dú_fûe
,

1334 
öode
 *
dú
, 
pxt4_lblk_t
 
block
,

1335 
dx_hash_öfo
 *
höfo
,

1336 
__u32
 
°¨t_hash
, __u32 
°¨t_mö‹_hash
,

1337 *
has_ölöe_d©a
)

1339 
îr
 = 0, 
cou¡
 = 0;

1340 
∑ª¡_öo
;

1341 
pos
;

1342 
pxt4_dú_íåy_2
 *
de
;

1343 
öode
 *öodê
	`fûe_öode
(
dú_fûe
);

1344 
ªt
, 
ölöe_size
 = 0;

1345 
pxt4_ûoc
 
ûoc
;

1346 *
dú_buf
 = 
NULL
;

1347 
pxt4_dú_íåy_2
 
Áke
;

1348 
fs¸y±_°r
 
tmp_°r
;

1350 
ªt
 = 
	`pxt4_gë_öode_loc
(
öode
, &
ûoc
);

1351 i‡(
ªt
)

1352  
ªt
;

1354 
	`down_ªad
(&
	`PXT4_I
(
öode
)->
x©å_£m
);

1355 i‡(!
	`pxt4_has_ölöe_d©a
(
öode
)) {

1356 
	`up_ªad
(&
	`PXT4_I
(
öode
)->
x©å_£m
);

1357 *
has_ölöe_d©a
 = 0;

1358 
out
;

1361 
ölöe_size
 = 
	`pxt4_gë_ölöe_size
(
öode
);

1362 
dú_buf
 = 
	`kmÆloc
(
ölöe_size
, 
GFP_NOFS
);

1363 i‡(!
dú_buf
) {

1364 
ªt
 = -
ENOMEM
;

1365 
	`up_ªad
(&
	`PXT4_I
(
öode
)->
x©å_£m
);

1366 
out
;

1369 
ªt
 = 
	`pxt4_ªad_ölöe_d©a
(
öode
, 
dú_buf
, 
ölöe_size
, &
ûoc
);

1370 
	`up_ªad
(&
	`PXT4_I
(
öode
)->
x©å_£m
);

1371 i‡(
ªt
 < 0)

1372 
out
;

1374 
pos
 = 0;

1375 
∑ª¡_öo
 = 
	`À32_to_˝u
(((
pxt4_dú_íåy_2
 *)
dú_buf
)->
öode
);

1376 
pos
 < 
ölöe_size
) {

1382 i‡(
pos
 == 0) {

1383 
Áke
.
öode
 = 
	`˝u_to_À32
(öode->
i_öo
);

1384 
Áke
.
«me_Àn
 = 1;

1385 
	`°r˝y
(
Áke
.
«me
, ".");

1386 
Áke
.
ªc_Àn
 = 
	`pxt4_ªc_Àn_to_disk
(

1387 
	`PXT4_DIR_REC_LEN
(
Áke
.
«me_Àn
),

1388 
ölöe_size
);

1389 
	`pxt4_£t_de_ty≥
(
öode
->
i_sb
, &
Áke
, 
S_IFDIR
);

1390 
de
 = &
Áke
;

1391 
pos
 = 
PXT4_INLINE_DOTDOT_OFFSET
;

1392 } i‡(
pos
 =
PXT4_INLINE_DOTDOT_OFFSET
) {

1393 
Áke
.
öode
 = 
	`˝u_to_À32
(
∑ª¡_öo
);

1394 
Áke
.
«me_Àn
 = 2;

1395 
	`°r˝y
(
Áke
.
«me
, "..");

1396 
Áke
.
ªc_Àn
 = 
	`pxt4_ªc_Àn_to_disk
(

1397 
	`PXT4_DIR_REC_LEN
(
Áke
.
«me_Àn
),

1398 
ölöe_size
);

1399 
	`pxt4_£t_de_ty≥
(
öode
->
i_sb
, &
Áke
, 
S_IFDIR
);

1400 
de
 = &
Áke
;

1401 
pos
 = 
PXT4_INLINE_DOTDOT_SIZE
;

1403 
de
 = (
pxt4_dú_íåy_2
 *)(
dú_buf
 + 
pos
);

1404 
pos
 +
	`pxt4_ªc_Àn_‰om_disk
(
de
->
ªc_Àn
, 
ölöe_size
);

1405 i‡(
	`pxt4_check_dú_íåy
(
öode
, 
dú_fûe
, 
de
,

1406 
ûoc
.
bh
, 
dú_buf
,

1407 
ölöe_size
, 
pos
)) {

1408 
ªt
 = 
cou¡
;

1409 
out
;

1413 
	`pxt4fs_dúhash
(
dú
, 
de
->
«me
, de->
«me_Àn
, 
höfo
);

1414 i‡((
höfo
->
hash
 < 
°¨t_hash
) ||

1415 ((
höfo
->
hash
 =
°¨t_hash
) &&

1416 (
höfo
->
mö‹_hash
 < 
°¨t_mö‹_hash
)))

1418 i‡(
de
->
öode
 == 0)

1420 
tmp_°r
.
«me
 = 
de
->name;

1421 
tmp_°r
.
Àn
 = 
de
->
«me_Àn
;

1422 
îr
 = 
	`pxt4_håì_°‹e_dúít
(
dú_fûe
, 
höfo
->
hash
,

1423 
höfo
->
mö‹_hash
, 
de
, &
tmp_°r
);

1424 i‡(
îr
) {

1425 
ªt
 = 
îr
;

1426 
out
;

1428 
cou¡
++;

1430 
ªt
 = 
cou¡
;

1431 
out
:

1432 
	`k‰ì
(
dú_buf
);

1433 
	`bªl£
(
ûoc
.
bh
);

1434  
ªt
;

1435 
	}
}

1445 
	$pxt4_ªad_ölöe_dú
(
fûe
 *file,

1446 
dú_c⁄ãxt
 *
˘x
,

1447 *
has_ölöe_d©a
)

1449 
off£t
, 
∑ª¡_öo
;

1450 
i
;

1451 
pxt4_dú_íåy_2
 *
de
;

1452 
su≥r_block
 *
sb
;

1453 
öode
 *öodê
	`fûe_öode
(
fûe
);

1454 
ªt
, 
ölöe_size
 = 0;

1455 
pxt4_ûoc
 
ûoc
;

1456 *
dú_buf
 = 
NULL
;

1457 
dŸdŸ_off£t
, 
dŸdŸ_size
, 
exåa_off£t
, 
exåa_size
;

1459 
ªt
 = 
	`pxt4_gë_öode_loc
(
öode
, &
ûoc
);

1460 i‡(
ªt
)

1461  
ªt
;

1463 
	`down_ªad
(&
	`PXT4_I
(
öode
)->
x©å_£m
);

1464 i‡(!
	`pxt4_has_ölöe_d©a
(
öode
)) {

1465 
	`up_ªad
(&
	`PXT4_I
(
öode
)->
x©å_£m
);

1466 *
has_ölöe_d©a
 = 0;

1467 
out
;

1470 
ölöe_size
 = 
	`pxt4_gë_ölöe_size
(
öode
);

1471 
dú_buf
 = 
	`kmÆloc
(
ölöe_size
, 
GFP_NOFS
);

1472 i‡(!
dú_buf
) {

1473 
ªt
 = -
ENOMEM
;

1474 
	`up_ªad
(&
	`PXT4_I
(
öode
)->
x©å_£m
);

1475 
out
;

1478 
ªt
 = 
	`pxt4_ªad_ölöe_d©a
(
öode
, 
dú_buf
, 
ölöe_size
, &
ûoc
);

1479 
	`up_ªad
(&
	`PXT4_I
(
öode
)->
x©å_£m
);

1480 i‡(
ªt
 < 0)

1481 
out
;

1483 
ªt
 = 0;

1484 
sb
 = 
öode
->
i_sb
;

1485 
∑ª¡_öo
 = 
	`À32_to_˝u
(((
pxt4_dú_íåy_2
 *)
dú_buf
)->
öode
);

1486 
off£t
 = 
˘x
->
pos
;

1495 
dŸdŸ_off£t
 = 
	`PXT4_DIR_REC_LEN
(1);

1496 
dŸdŸ_size
 = 
dŸdŸ_off£t
 + 
	`PXT4_DIR_REC_LEN
(2);

1497 
exåa_off£t
 = 
dŸdŸ_size
 - 
PXT4_INLINE_DOTDOT_SIZE
;

1498 
exåa_size
 = 
exåa_off£t
 + 
ölöe_size
;

1506 i‡(!
	`öode_eq_ivîsi⁄
(
öode
, 
fûe
->
f_vîsi⁄
)) {

1507 
i
 = 0; i < 
exåa_size
 && i < 
off£t
;) {

1512 i‡(!
i
) {

1513 
i
 = 
dŸdŸ_off£t
;

1515 } i‡(
i
 =
dŸdŸ_off£t
) {

1516 
i
 = 
dŸdŸ_size
;

1522 
de
 = (
pxt4_dú_íåy_2
 *)

1523 (
dú_buf
 + 
i
 - 
exåa_off£t
);

1530 i‡(
	`pxt4_ªc_Àn_‰om_disk
(
de
->
ªc_Àn
, 
exåa_size
)

1531 < 
	`PXT4_DIR_REC_LEN
(1))

1533 
i
 +
	`pxt4_ªc_Àn_‰om_disk
(
de
->
ªc_Àn
,

1534 
exåa_size
);

1536 
off£t
 = 
i
;

1537 
˘x
->
pos
 = 
off£t
;

1538 
fûe
->
f_vîsi⁄
 = 
	`öode_quîy_ivîsi⁄
(
öode
);

1541 
˘x
->
pos
 < 
exåa_size
) {

1542 i‡(
˘x
->
pos
 == 0) {

1543 i‡(!
	`dú_emô
(
˘x
, ".", 1, 
öode
->
i_öo
, 
DT_DIR
))

1544 
out
;

1545 
˘x
->
pos
 = 
dŸdŸ_off£t
;

1549 i‡(
˘x
->
pos
 =
dŸdŸ_off£t
) {

1550 i‡(!
	`dú_emô
(
˘x
, "..", 2, 
∑ª¡_öo
, 
DT_DIR
))

1551 
out
;

1552 
˘x
->
pos
 = 
dŸdŸ_size
;

1556 
de
 = (
pxt4_dú_íåy_2
 *)

1557 (
dú_buf
 + 
˘x
->
pos
 - 
exåa_off£t
);

1558 i‡(
	`pxt4_check_dú_íåy
(
öode
, 
fûe
, 
de
, 
ûoc
.
bh
, 
dú_buf
,

1559 
exåa_size
, 
˘x
->
pos
))

1560 
out
;

1561 i‡(
	`À32_to_˝u
(
de
->
öode
)) {

1562 i‡(!
	`dú_emô
(
˘x
, 
de
->
«me
, de->
«me_Àn
,

1563 
	`À32_to_˝u
(
de
->
öode
),

1564 
	`gë_dty≥
(
sb
, 
de
->
fûe_ty≥
)))

1565 
out
;

1567 
˘x
->
pos
 +
	`pxt4_ªc_Àn_‰om_disk
(
de
->
ªc_Àn
, 
exåa_size
);

1569 
out
:

1570 
	`k‰ì
(
dú_buf
);

1571 
	`bªl£
(
ûoc
.
bh
);

1572  
ªt
;

1573 
	}
}

1575 
buf„r_hód
 *
	$pxt4_gë_fú°_ölöe_block
(
öode
 *inode,

1576 
pxt4_dú_íåy_2
 **
∑ª¡_de
,

1577 *
ªtvÆ
)

1579 
pxt4_ûoc
 
ûoc
;

1581 *
ªtvÆ
 = 
	`pxt4_gë_öode_loc
(
öode
, &
ûoc
);

1582 i‡(*
ªtvÆ
)

1583  
NULL
;

1585 *
∑ª¡_de
 = (
pxt4_dú_íåy_2
 *)
	`pxt4_øw_öode
(&
ûoc
)->
i_block
;

1587  
ûoc
.
bh
;

1588 
	}
}

1595 
	$pxt4_åy_¸óã_ölöe_dú
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *
∑ª¡
,

1596 
öode
 *inode)

1598 
ªt
, 
ölöe_size
 = 
PXT4_MIN_INLINE_DATA_SIZE
;

1599 
pxt4_ûoc
 
ûoc
;

1600 
pxt4_dú_íåy_2
 *
de
;

1602 
ªt
 = 
	`pxt4_gë_öode_loc
(
öode
, &
ûoc
);

1603 i‡(
ªt
)

1604  
ªt
;

1606 
ªt
 = 
	`pxt4_¥ï¨e_ölöe_d©a
(
h™dÀ
, 
öode
, 
ölöe_size
);

1607 i‡(
ªt
)

1608 
out
;

1614 
de
 = (
pxt4_dú_íåy_2
 *)
	`pxt4_øw_öode
(&
ûoc
)->
i_block
;

1615 
de
->
öode
 = 
	`˝u_to_À32
(
∑ª¡
->
i_öo
);

1616 
de
 = (
pxt4_dú_íåy_2
 *)((*)dê+ 
PXT4_INLINE_DOTDOT_SIZE
);

1617 
de
->
öode
 = 0;

1618 
de
->
ªc_Àn
 = 
	`pxt4_ªc_Àn_to_disk
(

1619 
ölöe_size
 - 
PXT4_INLINE_DOTDOT_SIZE
,

1620 
ölöe_size
);

1621 
	`£t_∆ök
(
öode
, 2);

1622 
öode
->
i_size
 = 
	`PXT4_I
(öode)->
i_disksize
 = 
ölöe_size
;

1623 
out
:

1624 
	`bªl£
(
ûoc
.
bh
);

1625  
ªt
;

1626 
	}
}

1628 
buf„r_hód
 *
	$pxt4_föd_ölöe_íåy
(
öode
 *
dú
,

1629 
pxt4_fûíame
 *
‚ame
,

1630 
pxt4_dú_íåy_2
 **
ªs_dú
,

1631 *
has_ölöe_d©a
)

1633 
ªt
;

1634 
pxt4_ûoc
 
ûoc
;

1635 *
ölöe_°¨t
;

1636 
ölöe_size
;

1638 i‡(
	`pxt4_gë_öode_loc
(
dú
, &
ûoc
))

1639  
NULL
;

1641 
	`down_ªad
(&
	`PXT4_I
(
dú
)->
x©å_£m
);

1642 i‡(!
	`pxt4_has_ölöe_d©a
(
dú
)) {

1643 *
has_ölöe_d©a
 = 0;

1644 
out
;

1647 
ölöe_°¨t
 = (*)
	`pxt4_øw_öode
(&
ûoc
)->
i_block
 +

1648 
PXT4_INLINE_DOTDOT_SIZE
;

1649 
ölöe_size
 = 
PXT4_MIN_INLINE_DATA_SIZE
 - 
PXT4_INLINE_DOTDOT_SIZE
;

1650 
ªt
 = 
	`pxt4_£¨ch_dú
(
ûoc
.
bh
, 
ölöe_°¨t
, 
ölöe_size
,

1651 
dú
, 
‚ame
, 0, 
ªs_dú
);

1652 i‡(
ªt
 == 1)

1653 
out_föd
;

1654 i‡(
ªt
 < 0)

1655 
out
;

1657 i‡(
	`pxt4_gë_ölöe_size
(
dú
Ë=
PXT4_MIN_INLINE_DATA_SIZE
)

1658 
out
;

1660 
ölöe_°¨t
 = 
	`pxt4_gë_ölöe_x©å_pos
(
dú
, &
ûoc
);

1661 
ölöe_size
 = 
	`pxt4_gë_ölöe_size
(
dú
Ë- 
PXT4_MIN_INLINE_DATA_SIZE
;

1663 
ªt
 = 
	`pxt4_£¨ch_dú
(
ûoc
.
bh
, 
ölöe_°¨t
, 
ölöe_size
,

1664 
dú
, 
‚ame
, 0, 
ªs_dú
);

1665 i‡(
ªt
 == 1)

1666 
out_föd
;

1668 
out
:

1669 
	`bªl£
(
ûoc
.
bh
);

1670 
ûoc
.
bh
 = 
NULL
;

1671 
out_föd
:

1672 
	`up_ªad
(&
	`PXT4_I
(
dú
)->
x©å_£m
);

1673  
ûoc
.
bh
;

1674 
	}
}

1676 
	$pxt4_dñëe_ölöe_íåy
(
h™dÀ_t
 *
h™dÀ
,

1677 
öode
 *
dú
,

1678 
pxt4_dú_íåy_2
 *
de_dñ
,

1679 
buf„r_hód
 *
bh
,

1680 *
has_ölöe_d©a
)

1682 
îr
, 
ölöe_size
, 
no_ex∑nd
;

1683 
pxt4_ûoc
 
ûoc
;

1684 *
ölöe_°¨t
;

1686 
îr
 = 
	`pxt4_gë_öode_loc
(
dú
, &
ûoc
);

1687 i‡(
îr
)

1688  
îr
;

1690 
	`pxt4_wrôe_lock_x©å
(
dú
, &
no_ex∑nd
);

1691 i‡(!
	`pxt4_has_ölöe_d©a
(
dú
)) {

1692 *
has_ölöe_d©a
 = 0;

1693 
out
;

1696 i‡((*)
de_dñ
 - ((*)
	`pxt4_øw_öode
(&
ûoc
)->
i_block
) <

1697 
PXT4_MIN_INLINE_DATA_SIZE
) {

1698 
ölöe_°¨t
 = (*)
	`pxt4_øw_öode
(&
ûoc
)->
i_block
 +

1699 
PXT4_INLINE_DOTDOT_SIZE
;

1700 
ölöe_size
 = 
PXT4_MIN_INLINE_DATA_SIZE
 -

1701 
PXT4_INLINE_DOTDOT_SIZE
;

1703 
ölöe_°¨t
 = 
	`pxt4_gë_ölöe_x©å_pos
(
dú
, &
ûoc
);

1704 
ölöe_size
 = 
	`pxt4_gë_ölöe_size
(
dú
) -

1705 
PXT4_MIN_INLINE_DATA_SIZE
;

1708 
	`BUFFER_TRACE
(
bh
, "get_write_access");

1709 
îr
 = 
	`pxt4_jou∫Æ_gë_wrôe_ac˚ss
(
h™dÀ
, 
bh
);

1710 i‡(
îr
)

1711 
out
;

1713 
îr
 = 
	`pxt4_gíîic_dñëe_íåy
(
h™dÀ
, 
dú
, 
de_dñ
, 
bh
,

1714 
ölöe_°¨t
, 
ölöe_size
, 0);

1715 i‡(
îr
)

1716 
out
;

1718 
	`pxt4_show_ölöe_dú
(
dú
, 
ûoc
.
bh
, 
ölöe_°¨t
, 
ölöe_size
);

1719 
out
:

1720 
	`pxt4_wrôe_u∆ock_x©å
(
dú
, &
no_ex∑nd
);

1721 i‡(
	`likñy
(
îr
 == 0))

1722 
îr
 = 
	`pxt4_m¨k_öode_dúty
(
h™dÀ
, 
dú
);

1723 
	`bªl£
(
ûoc
.
bh
);

1724 i‡(
îr
 !-
ENOENT
)

1725 
	`pxt4_°d_îr‹
(
dú
->
i_sb
, 
îr
);

1726  
îr
;

1727 
	}
}

1732 
ölöe
 
pxt4_dú_íåy_2
 *

1733 
	$pxt4_gë_ölöe_íåy
(
öode
 *inode,

1734 
pxt4_ûoc
 *
ûoc
,

1735 
off£t
,

1736 **
ölöe_°¨t
,

1737 *
ölöe_size
)

1739 *
ölöe_pos
;

1741 
	`BUG_ON
(
off£t
 > 
	`pxt4_gë_ölöe_size
(
öode
));

1743 i‡(
off£t
 < 
PXT4_MIN_INLINE_DATA_SIZE
) {

1744 
ölöe_pos
 = (*)
	`pxt4_øw_öode
(
ûoc
)->
i_block
;

1745 *
ölöe_size
 = 
PXT4_MIN_INLINE_DATA_SIZE
;

1747 
ölöe_pos
 = 
	`pxt4_gë_ölöe_x©å_pos
(
öode
, 
ûoc
);

1748 
off£t
 -
PXT4_MIN_INLINE_DATA_SIZE
;

1749 *
ölöe_size
 = 
	`pxt4_gë_ölöe_size
(
öode
) -

1750 
PXT4_MIN_INLINE_DATA_SIZE
;

1753 i‡(
ölöe_°¨t
)

1754 *
ölöe_°¨t
 = 
ölöe_pos
;

1755  (
pxt4_dú_íåy_2
 *)(
ölöe_pos
 + 
off£t
);

1756 
	}
}

1758 
boﬁ
 
	$em±y_ölöe_dú
(
öode
 *
dú
, *
has_ölöe_d©a
)

1760 
îr
, 
ölöe_size
;

1761 
pxt4_ûoc
 
ûoc
;

1762 
size_t
 
ölöe_Àn
;

1763 *
ölöe_pos
;

1764 
off£t
;

1765 
pxt4_dú_íåy_2
 *
de
;

1766 
boﬁ
 
ªt
 = 
åue
;

1768 
îr
 = 
	`pxt4_gë_öode_loc
(
dú
, &
ûoc
);

1769 i‡(
îr
) {

1770 
	`PXT4_ERROR_INODE
(
dú
, "error %d getting inode %lu block",

1771 
îr
, 
dú
->
i_öo
);

1772  
åue
;

1775 
	`down_ªad
(&
	`PXT4_I
(
dú
)->
x©å_£m
);

1776 i‡(!
	`pxt4_has_ölöe_d©a
(
dú
)) {

1777 *
has_ölöe_d©a
 = 0;

1778 
out
;

1781 
de
 = (
pxt4_dú_íåy_2
 *)
	`pxt4_øw_öode
(&
ûoc
)->
i_block
;

1782 i‡(!
	`À32_to_˝u
(
de
->
öode
)) {

1783 
	`pxt4_w¨nög
(
dú
->
i_sb
,

1785 
dú
->
i_öo
);

1786 
ªt
 = 
åue
;

1787 
out
;

1790 
ölöe_Àn
 = 
	`pxt4_gë_ölöe_size
(
dú
);

1791 
off£t
 = 
PXT4_INLINE_DOTDOT_SIZE
;

1792 
off£t
 < 
ölöe_Àn
) {

1793 
de
 = 
	`pxt4_gë_ölöe_íåy
(
dú
, &
ûoc
, 
off£t
,

1794 &
ölöe_pos
, &
ölöe_size
);

1795 i‡(
	`pxt4_check_dú_íåy
(
dú
, 
NULL
, 
de
,

1796 
ûoc
.
bh
, 
ölöe_pos
,

1797 
ölöe_size
, 
off£t
)) {

1798 
	`pxt4_w¨nög
(
dú
->
i_sb
,

1802 
dú
->
i_öo
, 
	`À32_to_˝u
(
de
->
öode
),

1803 
	`À16_to_˝u
(
de
->
ªc_Àn
), de->
«me_Àn
,

1804 
ölöe_size
);

1805 
ªt
 = 
åue
;

1806 
out
;

1808 i‡(
	`À32_to_˝u
(
de
->
öode
)) {

1809 
ªt
 = 
Ál£
;

1810 
out
;

1812 
off£t
 +
	`pxt4_ªc_Àn_‰om_disk
(
de
->
ªc_Àn
, 
ölöe_size
);

1815 
out
:

1816 
	`up_ªad
(&
	`PXT4_I
(
dú
)->
x©å_£m
);

1817 
	`bªl£
(
ûoc
.
bh
);

1818  
ªt
;

1819 
	}
}

1821 
	$pxt4_de°roy_ölöe_d©a
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *inode)

1823 
ªt
, 
no_ex∑nd
;

1825 
	`pxt4_wrôe_lock_x©å
(
öode
, &
no_ex∑nd
);

1826 
ªt
 = 
	`pxt4_de°roy_ölöe_d©a_nﬁock
(
h™dÀ
, 
öode
);

1827 
	`pxt4_wrôe_u∆ock_x©å
(
öode
, &
no_ex∑nd
);

1829  
ªt
;

1830 
	}
}

1832 
	$pxt4_ölöe_d©a_iom≠
(
öode
 *öode, 
iom≠
 *iomap)

1834 
__u64
 
addr
;

1835 
îr‹
 = -
EAGAIN
;

1836 
pxt4_ûoc
 
ûoc
;

1838 
	`down_ªad
(&
	`PXT4_I
(
öode
)->
x©å_£m
);

1839 i‡(!
	`pxt4_has_ölöe_d©a
(
öode
))

1840 
out
;

1842 
îr‹
 = 
	`pxt4_gë_öode_loc
(
öode
, &
ûoc
);

1843 i‡(
îr‹
)

1844 
out
;

1846 
addr
 = (
__u64
)
ûoc
.
bh
->
b_blockƒ
 << 
öode
->
i_sb
->
s_blocksize_bôs
;

1847 
addr
 +(*)
	`pxt4_øw_öode
(&
ûoc
Ë- iloc.
bh
->
b_d©a
;

1848 
addr
 +
	`off£tof
(
pxt4_öode
, 
i_block
);

1850 
	`bªl£
(
ûoc
.
bh
);

1852 
iom≠
->
addr
 =áddr;

1853 
iom≠
->
off£t
 = 0;

1854 
iom≠
->
Àngth
 = 
	`mö_t
(
loff_t
, 
	`pxt4_gë_ölöe_size
(
öode
),

1855 
	`i_size_ªad
(
öode
));

1856 
iom≠
->
ty≥
 = 
IOMAP_INLINE
;

1857 
iom≠
->
Êags
 = 0;

1859 
out
:

1860 
	`up_ªad
(&
	`PXT4_I
(
öode
)->
x©å_£m
);

1861  
îr‹
;

1862 
	}
}

1864 
	$pxt4_ölöe_d©a_fõm≠
(
öode
 *inode,

1865 
fõm≠_exã¡_öfo
 *
fõöfo
,

1866 *
has_ölöe
, 
__u64
 
°¨t
, __u64 
Àn
)

1868 
__u64
 
physiˇl
 = 0;

1869 
__u64
 
ölöe_Àn
;

1870 
__u32
 
Êags
 = 
FIEMAP_EXTENT_DATA_INLINE
 | 
FIEMAP_EXTENT_NOT_ALIGNED
 |

1871 
FIEMAP_EXTENT_LAST
;

1872 
îr‹
 = 0;

1873 
pxt4_ûoc
 
ûoc
;

1875 
	`down_ªad
(&
	`PXT4_I
(
öode
)->
x©å_£m
);

1876 i‡(!
	`pxt4_has_ölöe_d©a
(
öode
)) {

1877 *
has_ölöe
 = 0;

1878 
out
;

1880 
ölöe_Àn
 = 
	`mö_t
(
size_t
, 
	`pxt4_gë_ölöe_size
(
öode
),

1881 
	`i_size_ªad
(
öode
));

1882 i‡(
°¨t
 >
ölöe_Àn
)

1883 
out
;

1884 i‡(
°¨t
 + 
Àn
 < 
ölöe_Àn
)

1885 
ölöe_Àn
 = 
°¨t
 + 
Àn
;

1886 
ölöe_Àn
 -
°¨t
;

1888 
îr‹
 = 
	`pxt4_gë_öode_loc
(
öode
, &
ûoc
);

1889 i‡(
îr‹
)

1890 
out
;

1892 
physiˇl
 = (
__u64
)
ûoc
.
bh
->
b_blockƒ
 << 
öode
->
i_sb
->
s_blocksize_bôs
;

1893 
physiˇl
 +(*)
	`pxt4_øw_öode
(&
ûoc
Ë- iloc.
bh
->
b_d©a
;

1894 
physiˇl
 +
	`off£tof
(
pxt4_öode
, 
i_block
);

1896 
	`bªl£
(
ûoc
.
bh
);

1897 
out
:

1898 
	`up_ªad
(&
	`PXT4_I
(
öode
)->
x©å_£m
);

1899 i‡(
physiˇl
)

1900 
îr‹
 = 
	`fõm≠_fûl_√xt_exã¡
(
fõöfo
, 
°¨t
, 
physiˇl
,

1901 
ölöe_Àn
, 
Êags
);

1902  (
îr‹
 < 0 ?Érror : 0);

1903 
	}
}

1905 
	$pxt4_ölöe_d©a_åunˇã
(
öode
 *öode, *
has_ölöe
)

1907 
h™dÀ_t
 *
h™dÀ
;

1908 
ölöe_size
, 
vÆue_Àn
, 
√eded_blocks
, 
no_ex∑nd
, 
îr
 = 0;

1909 
size_t
 
i_size
;

1910 *
vÆue
 = 
NULL
;

1911 
pxt4_x©å_ibody_föd
 
is
 = {

1912 .
s
 = { .
nŸ_found
 = -
ENODATA
, },

1914 
pxt4_x©å_öfo
 
i
 = {

1915 .
«me_ödex
 = 
PXT4_XATTR_INDEX_SYSTEM
,

1916 .
«me
 = 
PXT4_XATTR_SYSTEM_DATA
,

1920 
√eded_blocks
 = 
	`pxt4_wrôïage_å™s_blocks
(
öode
);

1921 
h™dÀ
 = 
	`pxt4_jou∫Æ_°¨t
(
öode
, 
PXT4_HT_INODE
, 
√eded_blocks
);

1922 i‡(
	`IS_ERR
(
h™dÀ
))

1923  
	`PTR_ERR
(
h™dÀ
);

1925 
	`pxt4_wrôe_lock_x©å
(
öode
, &
no_ex∑nd
);

1926 i‡(!
	`pxt4_has_ölöe_d©a
(
öode
)) {

1927 
	`pxt4_wrôe_u∆ock_x©å
(
öode
, &
no_ex∑nd
);

1928 *
has_ölöe
 = 0;

1929 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

1933 i‡((
îr
 = 
	`pxt4_‹ph™_add
(
h™dÀ
, 
öode
)) != 0)

1934 
out
;

1936 i‡((
îr
 = 
	`pxt4_gë_öode_loc
(
öode
, &
is
.
ûoc
)) != 0)

1937 
out
;

1939 
	`down_wrôe
(&
	`PXT4_I
(
öode
)->
i_d©a_£m
);

1940 
i_size
 = 
öode
->i_size;

1941 
ölöe_size
 = 
	`pxt4_gë_ölöe_size
(
öode
);

1942 
	`PXT4_I
(
öode
)->
i_disksize
 = 
i_size
;

1944 i‡(
i_size
 < 
ölöe_size
) {

1946 i‡(
ölöe_size
 > 
PXT4_MIN_INLINE_DATA_SIZE
) {

1947 i‡((
îr
 = 
	`pxt4_x©å_ibody_föd
(
öode
, &
i
, &
is
)) != 0)

1948 
out_îr‹
;

1950 
	`BUG_ON
(
is
.
s
.
nŸ_found
);

1952 
vÆue_Àn
 = 
	`À32_to_˝u
(
is
.
s
.
hîe
->
e_vÆue_size
);

1953 
vÆue
 = 
	`kmÆloc
(
vÆue_Àn
, 
GFP_NOFS
);

1954 i‡(!
vÆue
) {

1955 
îr
 = -
ENOMEM
;

1956 
out_îr‹
;

1959 
îr
 = 
	`pxt4_x©å_ibody_gë
(
öode
, 
i
.
«me_ödex
,

1960 
i
.
«me
, 
vÆue
, 
vÆue_Àn
);

1961 i‡(
îr
 <= 0)

1962 
out_îr‹
;

1964 
i
.
vÆue
 = value;

1965 
i
.
vÆue_Àn
 = 
i_size
 > 
PXT4_MIN_INLINE_DATA_SIZE
 ?

1966 
i_size
 - 
PXT4_MIN_INLINE_DATA_SIZE
 : 0;

1967 
îr
 = 
	`pxt4_x©å_ibody_ölöe_£t
(
h™dÀ
, 
öode
,

1968 &
i
, &
is
);

1969 i‡(
îr
)

1970 
out_îr‹
;

1974 i‡(
i_size
 < 
PXT4_MIN_INLINE_DATA_SIZE
) {

1975 *
p
 = (*Ë
	`pxt4_øw_öode
(&
is
.
ûoc
)->
i_block
;

1976 
	`mem£t
(
p
 + 
i_size
, 0,

1977 
PXT4_MIN_INLINE_DATA_SIZE
 - 
i_size
);

1980 
	`PXT4_I
(
öode
)->
i_ölöe_size
 = 
i_size
 <

1981 
PXT4_MIN_INLINE_DATA_SIZE
 ?

1982 
PXT4_MIN_INLINE_DATA_SIZE
 : 
i_size
;

1985 
out_îr‹
:

1986 
	`up_wrôe
(&
	`PXT4_I
(
öode
)->
i_d©a_£m
);

1987 
out
:

1988 
	`bªl£
(
is
.
ûoc
.
bh
);

1989 
	`pxt4_wrôe_u∆ock_x©å
(
öode
, &
no_ex∑nd
);

1990 
	`k‰ì
(
vÆue
);

1991 i‡(
öode
->
i_∆ök
)

1992 
	`pxt4_‹ph™_dñ
(
h™dÀ
, 
öode
);

1994 i‡(
îr
 == 0) {

1995 
öode
->
i_mtime
 = inode->
i_˘ime
 = 
	`cuºít_time
(inode);

1996 
îr
 = 
	`pxt4_m¨k_öode_dúty
(
h™dÀ
, 
öode
);

1997 i‡(
	`IS_SYNC
(
öode
))

1998 
	`pxt4_h™dÀ_sync
(
h™dÀ
);

2000 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

2001  
îr
;

2002 
	}
}

2004 
	$pxt4_c⁄vît_ölöe_d©a
(
öode
 *inode)

2006 
îr‹
, 
√eded_blocks
, 
no_ex∑nd
;

2007 
h™dÀ_t
 *
h™dÀ
;

2008 
pxt4_ûoc
 
ûoc
;

2010 i‡(!
	`pxt4_has_ölöe_d©a
(
öode
)) {

2011 
	`pxt4_˛ór_öode_°©e
(
öode
, 
PXT4_STATE_MAY_INLINE_DATA
);

2015 
√eded_blocks
 = 
	`pxt4_wrôïage_å™s_blocks
(
öode
);

2017 
ûoc
.
bh
 = 
NULL
;

2018 
îr‹
 = 
	`pxt4_gë_öode_loc
(
öode
, &
ûoc
);

2019 i‡(
îr‹
)

2020  
îr‹
;

2022 
h™dÀ
 = 
	`pxt4_jou∫Æ_°¨t
(
öode
, 
PXT4_HT_WRITE_PAGE
, 
√eded_blocks
);

2023 i‡(
	`IS_ERR
(
h™dÀ
)) {

2024 
îr‹
 = 
	`PTR_ERR
(
h™dÀ
);

2025 
out_‰ì
;

2028 
	`pxt4_wrôe_lock_x©å
(
öode
, &
no_ex∑nd
);

2029 i‡(
	`pxt4_has_ölöe_d©a
(
öode
))

2030 
îr‹
 = 
	`pxt4_c⁄vît_ölöe_d©a_nﬁock
(
h™dÀ
, 
öode
, &
ûoc
);

2031 
	`pxt4_wrôe_u∆ock_x©å
(
öode
, &
no_ex∑nd
);

2032 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

2033 
out_‰ì
:

2034 
	`bªl£
(
ûoc
.
bh
);

2035  
îr‹
;

2036 
	}
}

	@inode.c

22 
	~<löux/fs.h
>

23 
	~<löux/time.h
>

24 
	~<löux/highuid.h
>

25 
	~<löux/∑gem≠.h
>

26 
	~<löux/dax.h
>

27 
	~<löux/quŸa›s.h
>

28 
	~<löux/°rög.h
>

29 
	~<löux/buf„r_hód.h
>

30 
	~<löux/wrôeback.h
>

31 
	~<löux/∑gevec.h
>

32 
	~<löux/m∑ge.h
>

33 
	~<löux/«mei.h
>

34 
	~<löux/uio.h
>

35 
	~<löux/bio.h
>

36 
	~<löux/w‹kqueue.h
>

37 
	~<löux/kî√l.h
>

38 
	~<löux/¥ötk.h
>

39 
	~<löux/¶ab.h
>

40 
	~<löux/bô›s.h
>

41 
	~<löux/iom≠.h
>

42 
	~<löux/ivîsi⁄.h
>

44 
	~"pxt4_jbd3.h
"

45 
	~"x©å.h
"

46 
	~"a˛.h
"

47 
	~"åunˇã.h
"

49 
	~<åa˚/evíts/pxt4.h
>

51 
	#MPAGE_DA_EXTENT_TAIL
 0x01

	)

53 
__u32
 
	$pxt4_öode_csum
(
öode
 *öode, 
pxt4_öode
 *
øw
,

54 
pxt4_öode_öfo
 *
ei
)

56 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
öode
->
i_sb
);

57 
__u32
 
csum
;

58 
__u16
 
dummy_csum
 = 0;

59 
off£t
 = 
	`off£tof
(
pxt4_öode
, 
i_checksum_lo
);

60 
csum_size
 = (
dummy_csum
);

62 
csum
 = 
	`pxt4_chksum
(
sbi
, 
ei
->
i_csum_£ed
, (
__u8
 *)
øw
, 
off£t
);

63 
csum
 = 
	`pxt4_chksum
(
sbi
, csum, (
__u8
 *)&
dummy_csum
, 
csum_size
);

64 
off£t
 +
csum_size
;

65 
csum
 = 
	`pxt4_chksum
(
sbi
, csum, (
__u8
 *)
øw
 + 
off£t
,

66 
PXT4_GOOD_OLD_INODE_SIZE
 - 
off£t
);

68 i‡(
	`PXT4_INODE_SIZE
(
öode
->
i_sb
Ë> 
PXT4_GOOD_OLD_INODE_SIZE
) {

69 
off£t
 = 
	`off£tof
(
pxt4_öode
, 
i_checksum_hi
);

70 
csum
 = 
	`pxt4_chksum
(
sbi
, csum, (
__u8
 *)
øw
 +

71 
PXT4_GOOD_OLD_INODE_SIZE
,

72 
off£t
 - 
PXT4_GOOD_OLD_INODE_SIZE
);

73 i‡(
	`PXT4_FITS_IN_INODE
(
øw
, 
ei
, 
i_checksum_hi
)) {

74 
csum
 = 
	`pxt4_chksum
(
sbi
, csum, (
__u8
 *)&
dummy_csum
,

75 
csum_size
);

76 
off£t
 +
csum_size
;

78 
csum
 = 
	`pxt4_chksum
(
sbi
, csum, (
__u8
 *)
øw
 + 
off£t
,

79 
	`PXT4_INODE_SIZE
(
öode
->
i_sb
Ë- 
off£t
);

82  
csum
;

83 
	}
}

85 
	$pxt4_öode_csum_vîify
(
öode
 *öode, 
pxt4_öode
 *
øw
,

86 
pxt4_öode_öfo
 *
ei
)

88 
__u32
 
¥ovided
, 
ˇlcuœãd
;

90 i‡(
	`PXT4_SB
(
öode
->
i_sb
)->
s_es
->
s_¸ót‹_os
 !=

91 
	`˝u_to_À32
(
PXT4_OS_LINUX
) ||

92 !
	`pxt4_has_mëad©a_csum
(
öode
->
i_sb
))

95 
¥ovided
 = 
	`À16_to_˝u
(
øw
->
i_checksum_lo
);

96 
ˇlcuœãd
 = 
	`pxt4_öode_csum
(
öode
, 
øw
, 
ei
);

97 i‡(
	`PXT4_INODE_SIZE
(
öode
->
i_sb
Ë> 
PXT4_GOOD_OLD_INODE_SIZE
 &&

98 
	`PXT4_FITS_IN_INODE
(
øw
, 
ei
, 
i_checksum_hi
))

99 
¥ovided
 |((
__u32
)
	`À16_to_˝u
(
øw
->
i_checksum_hi
)) << 16;

101 
ˇlcuœãd
 &= 0xFFFF;

103  
¥ovided
 =
ˇlcuœãd
;

104 
	}
}

106 
	$pxt4_öode_csum_£t
(
öode
 *öode, 
pxt4_öode
 *
øw
,

107 
pxt4_öode_öfo
 *
ei
)

109 
__u32
 
csum
;

111 i‡(
	`PXT4_SB
(
öode
->
i_sb
)->
s_es
->
s_¸ót‹_os
 !=

112 
	`˝u_to_À32
(
PXT4_OS_LINUX
) ||

113 !
	`pxt4_has_mëad©a_csum
(
öode
->
i_sb
))

116 
csum
 = 
	`pxt4_öode_csum
(
öode
, 
øw
, 
ei
);

117 
øw
->
i_checksum_lo
 = 
	`˝u_to_À16
(
csum
 & 0xFFFF);

118 i‡(
	`PXT4_INODE_SIZE
(
öode
->
i_sb
Ë> 
PXT4_GOOD_OLD_INODE_SIZE
 &&

119 
	`PXT4_FITS_IN_INODE
(
øw
, 
ei
, 
i_checksum_hi
))

120 
øw
->
i_checksum_hi
 = 
	`˝u_to_À16
(
csum
 >> 16);

121 
	}
}

123 
ölöe
 
	$pxt4_begö_‹dîed_åunˇã
(
öode
 *inode,

124 
loff_t
 
√w_size
)

126 
	`åa˚_pxt4_begö_‹dîed_åunˇã
(
öode
, 
√w_size
);

133 i‡(!
	`PXT4_I
(
öode
)->
jöode
)

135  
	`jbd3_jou∫Æ_begö_‹dîed_åunˇã
(
	`PXT4_JOURNAL
(
öode
),

136 
	`PXT4_I
(
öode
)->
jöode
,

137 
√w_size
);

138 
	}
}

140 
pxt4_övÆid©ïage
(
∑ge
 *∑ge, 
off£t
,

141 
Àngth
);

142 
__pxt4_jou∫ÆÀd_wrôïage
(
∑ge
 *∑ge, 
Àn
);

143 
pxt4_bh_dñay_‹_unwrôãn
(
h™dÀ_t
 *
h™dÀ
, 
buf„r_hód
 *
bh
);

144 
pxt4_mëa_å™s_blocks
(
öode
 *öode, 
lblocks
,

145 
≥xã¡s
);

151 
	$pxt4_öode_is_Á°_symlök
(
öode
 *inode)

153 i‡(!(
	`PXT4_I
(
öode
)->
i_Êags
 & 
PXT4_EA_INODE_FL
)) {

154 
ó_blocks
 = 
	`PXT4_I
(
öode
)->
i_fûe_a˛
 ?

155 
	`PXT4_CLUSTER_SIZE
(
öode
->
i_sb
) >> 9 : 0;

157 i‡(
	`pxt4_has_ölöe_d©a
(
öode
))

160  (
	`S_ISLNK
(
öode
->
i_mode
Ë&& inode->
i_blocks
 - 
ó_blocks
 == 0);

162  
	`S_ISLNK
(
öode
->
i_mode
Ë&& inode->
i_size
 &&

163 (
öode
->
i_size
 < 
PXT4_N_BLOCKS
 * 4);

164 
	}
}

171 
	$pxt4_åunˇã_ª°¨t_å™s
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *inode,

172 
nblocks
)

174 
ªt
;

182 
	`BUG_ON
(
	`PXT4_JOURNAL
(
öode
Ë=
NULL
);

183 
	`jbd_debug
(2, "ª°¨tög h™dÀ %p\n", 
h™dÀ
);

184 
	`up_wrôe
(&
	`PXT4_I
(
öode
)->
i_d©a_£m
);

185 
ªt
 = 
	`pxt4_jou∫Æ_ª°¨t
(
h™dÀ
, 
nblocks
);

186 
	`down_wrôe
(&
	`PXT4_I
(
öode
)->
i_d©a_£m
);

187 
	`pxt4_disˇrd_¥óŒoˇti⁄s
(
öode
);

189  
ªt
;

190 
	}
}

195 
	$pxt4_evi˘_öode
(
öode
 *inode)

197 
h™dÀ_t
 *
h™dÀ
;

198 
îr
;

204 
exåa_¸edôs
 = 6;

205 
pxt4_x©å_öode_¨øy
 *
ó_öode_¨øy
 = 
NULL
;

206 
boﬁ
 
‰ìze_¥Ÿe˘ed
 = 
Ál£
;

208 
	`åa˚_pxt4_evi˘_öode
(
öode
);

210 i‡(
öode
->
i_∆ök
) {

229 i‡(
öode
->
i_öo
 !
PXT4_JOURNAL_INO
 &&

230 
	`pxt4_should_jou∫Æ_d©a
(
öode
) &&

231 (
	`S_ISLNK
(
öode
->
i_mode
Ë|| 
	`S_ISREG
(inode->i_mode)) &&

232 
öode
->
i_d©a
.
ƒ∑ges
) {

233 
jou∫Æ_t
 *
jou∫Æ
 = 
	`PXT4_SB
(
öode
->
i_sb
)->
s_jou∫Æ
;

234 
tid_t
 
commô_tid
 = 
	`PXT4_I
(
öode
)->
i_d©async_tid
;

236 
	`jbd3_com∂ëe_å™ß˘i⁄
(
jou∫Æ
, 
commô_tid
);

237 
	`fûem≠_wrôe_™d_waô
(&
öode
->
i_d©a
);

239 
	`åunˇã_öode_∑ges_föÆ
(&
öode
->
i_d©a
);

241 
no_dñëe
;

244 i‡(
	`is_bad_öode
(
öode
))

245 
no_dñëe
;

246 
	`dquŸ_öôülize
(
öode
);

248 i‡(
	`pxt4_should_‹dî_d©a
(
öode
))

249 
	`pxt4_begö_‹dîed_åunˇã
(
öode
, 0);

250 
	`åunˇã_öode_∑ges_föÆ
(&
öode
->
i_d©a
);

258 i‡(!
	`pxt4_jou∫Æ_cuºít_h™dÀ
()) {

259 
	`sb_°¨t_ötwrôe
(
öode
->
i_sb
);

260 
‰ìze_¥Ÿe˘ed
 = 
åue
;

263 i‡(!
	`IS_NOQUOTA
(
öode
))

264 
exåa_¸edôs
 +
	`PXT4_MAXQUOTAS_DEL_BLOCKS
(
öode
->
i_sb
);

270 
h™dÀ
 = 
	`pxt4_jou∫Æ_°¨t
(
öode
, 
PXT4_HT_TRUNCATE
,

271 
	`pxt4_blocks_f‹_åunˇã
(
öode
Ë+ 
exåa_¸edôs
 - 3);

272 i‡(
	`IS_ERR
(
h™dÀ
)) {

273 
	`pxt4_°d_îr‹
(
öode
->
i_sb
, 
	`PTR_ERR
(
h™dÀ
));

279 
	`pxt4_‹ph™_dñ
(
NULL
, 
öode
);

280 i‡(
‰ìze_¥Ÿe˘ed
)

281 
	`sb_íd_ötwrôe
(
öode
->
i_sb
);

282 
no_dñëe
;

285 i‡(
	`IS_SYNC
(
öode
))

286 
	`pxt4_h™dÀ_sync
(
h™dÀ
);

295 i‡(
	`pxt4_öode_is_Á°_symlök
(
öode
))

296 
	`mem£t
(
	`PXT4_I
(
öode
)->
i_d©a
, 0, (PXT4_I(inode)->i_data));

297 
öode
->
i_size
 = 0;

298 
îr
 = 
	`pxt4_m¨k_öode_dúty
(
h™dÀ
, 
öode
);

299 i‡(
îr
) {

300 
	`pxt4_w¨nög
(
öode
->
i_sb
,

301 "couldn'àm¨k inodêdúty (î∏%d)", 
îr
);

302 
°›_h™dÀ
;

304 i‡(
öode
->
i_blocks
) {

305 
îr
 = 
	`pxt4_åunˇã
(
öode
);

306 i‡(
îr
) {

307 
	`pxt4_îr‹
(
öode
->
i_sb
,

309 
öode
->
i_öo
, 
îr
);

310 
°›_h™dÀ
;

315 
îr
 = 
	`pxt4_x©å_dñëe_öode
(
h™dÀ
, 
öode
, &
ó_öode_¨øy
,

316 
exåa_¸edôs
);

317 i‡(
îr
) {

318 
	`pxt4_w¨nög
(
öode
->
i_sb
, "x©å dñëê”º %d)", 
îr
);

319 
°›_h™dÀ
:

320 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

321 
	`pxt4_‹ph™_dñ
(
NULL
, 
öode
);

322 i‡(
‰ìze_¥Ÿe˘ed
)

323 
	`sb_íd_ötwrôe
(
öode
->
i_sb
);

324 
	`pxt4_x©å_öode_¨øy_‰ì
(
ó_öode_¨øy
);

325 
no_dñëe
;

336 
	`pxt4_‹ph™_dñ
(
h™dÀ
, 
öode
);

337 
	`PXT4_I
(
öode
)->
i_dtime
 = (
__u32
)
	`ktime_gë_ªÆ_£c⁄ds
();

346 i‡(
	`pxt4_m¨k_öode_dúty
(
h™dÀ
, 
öode
))

348 
	`pxt4_˛ór_öode
(
öode
);

350 
	`pxt4_‰ì_öode
(
h™dÀ
, 
öode
);

351 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

352 i‡(
‰ìze_¥Ÿe˘ed
)

353 
	`sb_íd_ötwrôe
(
öode
->
i_sb
);

354 
	`pxt4_x©å_öode_¨øy_‰ì
(
ó_öode_¨øy
);

356 
no_dñëe
:

357 
	`pxt4_˛ór_öode
(
öode
);

358 
	}
}

360 #ifde‡
CONFIG_QUOTA


361 
qsize_t
 *
	$pxt4_gë_ª£rved_•a˚
(
öode
 *inode)

363  &
	`PXT4_I
(
öode
)->
i_ª£rved_quŸa
;

364 
	}
}

371 
	$pxt4_da_upd©e_ª£rve_•a˚
(
öode
 *inode,

372 
u£d
, 
quŸa_˛aim
)

374 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
öode
->
i_sb
);

375 
pxt4_öode_öfo
 *
ei
 = 
	`PXT4_I
(
öode
);

377 
	`•ö_lock
(&
ei
->
i_block_ª£rv©i⁄_lock
);

378 
	`åa˚_pxt4_da_upd©e_ª£rve_•a˚
(
öode
, 
u£d
, 
quŸa_˛aim
);

379 i‡(
	`u∆ikñy
(
u£d
 > 
ei
->
i_ª£rved_d©a_blocks
)) {

380 
	`pxt4_w¨nög
(
öode
->
i_sb
, "%s: ino %lu, used %d "

382 
__func__
, 
öode
->
i_öo
, 
u£d
,

383 
ei
->
i_ª£rved_d©a_blocks
);

384 
	`WARN_ON
(1);

385 
u£d
 = 
ei
->
i_ª£rved_d©a_blocks
;

389 
ei
->
i_ª£rved_d©a_blocks
 -
u£d
;

390 
	`≥r˝u_cou¡î_sub
(&
sbi
->
s_dúty˛u°îs_cou¡î
, 
u£d
);

392 
	`•ö_u∆ock
(&
	`PXT4_I
(
öode
)->
i_block_ª£rv©i⁄_lock
);

395 i‡(
quŸa_˛aim
)

396 
	`dquŸ_˛aim_block
(
öode
, 
	`PXT4_C2B
(
sbi
, 
u£d
));

403 
	`dquŸ_ªÀa£_ª£rv©i⁄_block
(
öode
, 
	`PXT4_C2B
(
sbi
, 
u£d
));

411 i‡((
ei
->
i_ª£rved_d©a_blocks
 == 0) &&

412 !
	`öode_is_›í_f‹_wrôe
(
öode
))

413 
	`pxt4_disˇrd_¥óŒoˇti⁄s
(
öode
);

414 
	}
}

416 
	$__check_block_vÆidôy
(
öode
 *öode, c⁄° *
func
,

417 
löe
,

418 
pxt4_m≠_blocks
 *
m≠
)

420 i‡(
	`pxt4_has_„©uª_jou∫Æ
(
öode
->
i_sb
) &&

421 (
öode
->
i_öo
 ==

422 
	`À32_to_˝u
(
	`PXT4_SB
(
öode
->
i_sb
)->
s_es
->
s_jou∫Æ_öum
)))

424 i‡(!
	`pxt4_d©a_block_vÆid
(
	`PXT4_SB
(
öode
->
i_sb
), 
m≠
->
m_pblk
,

425 
m≠
->
m_Àn
)) {

426 
	`pxt4_îr‹_öode
(
öode
, 
func
, 
löe
, 
m≠
->
m_pblk
,

428 "÷ígth %d)", (Ë
m≠
->
m_lblk
,

429 
m≠
->
m_pblk
, m≠->
m_Àn
);

430  -
EFSCORRUPTED
;

433 
	}
}

435 
	$pxt4_issue_zîoout
(
öode
 *öode, 
pxt4_lblk_t
 
lblk
, 
pxt4_fsblk_t
 
pblk
,

436 
pxt4_lblk_t
 
Àn
)

438 
ªt
;

440 i‡(
	`IS_ENCRYPTED
(
öode
))

441  
	`fs¸y±_zîoout_ønge
(
öode
, 
lblk
, 
pblk
, 
Àn
);

443 
ªt
 = 
	`sb_issue_zîoout
(
öode
->
i_sb
, 
pblk
, 
Àn
, 
GFP_NOFS
);

444 i‡(
ªt
 > 0)

445 
ªt
 = 0;

447  
ªt
;

448 
	}
}

450 
	#check_block_vÆidôy
(
öode
, 
m≠
) \

451 
	`__check_block_vÆidôy
((
öode
), 
__func__
, 
__LINE__
, (
m≠
))

	)

453 #ifde‡
ES_AGGRESSIVE_TEST


454 
	$pxt4_m≠_blocks_es_ªcheck
(
h™dÀ_t
 *
h™dÀ
,

455 
öode
 *inode,

456 
pxt4_m≠_blocks
 *
es_m≠
,

457 
pxt4_m≠_blocks
 *
m≠
,

458 
Êags
)

460 
ªtvÆ
;

462 
m≠
->
m_Êags
 = 0;

470 
	`down_ªad
(&
	`PXT4_I
(
öode
)->
i_d©a_£m
);

471 i‡(
	`pxt4_ã°_öode_Êag
(
öode
, 
PXT4_INODE_EXTENTS
)) {

472 
ªtvÆ
 = 
	`pxt4_ext_m≠_blocks
(
h™dÀ
, 
öode
, 
m≠
, 
Êags
 &

473 
PXT4_GET_BLOCKS_KEEP_SIZE
);

475 
ªtvÆ
 = 
	`pxt4_öd_m≠_blocks
(
h™dÀ
, 
öode
, 
m≠
, 
Êags
 &

476 
PXT4_GET_BLOCKS_KEEP_SIZE
);

478 
	`up_ªad
((&
	`PXT4_I
(
öode
)->
i_d©a_£m
));

484 i‡(
es_m≠
->
m_lblk
 !
m≠
->m_lblk ||

485 
es_m≠
->
m_Êags
 !
m≠
->m_flags ||

486 
es_m≠
->
m_pblk
 !
m≠
->m_pblk) {

487 
	`¥ötk
("ES cacheássertion failed for inode: %lu "

490 
öode
->
i_öo
, 
es_m≠
->
m_lblk
,És_m≠->
m_Àn
,

491 
es_m≠
->
m_pblk
,És_m≠->
m_Êags
, 
m≠
->
m_lblk
,

492 
m≠
->
m_Àn
, m≠->
m_pblk
, m≠->
m_Êags
,

493 
ªtvÆ
, 
Êags
);

495 
	}
}

520 
	$pxt4_m≠_blocks
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *inode,

521 
pxt4_m≠_blocks
 *
m≠
, 
Êags
)

523 
exã¡_°©us
 
es
;

524 
ªtvÆ
;

525 
ªt
 = 0;

526 #ifde‡
ES_AGGRESSIVE_TEST


527 
pxt4_m≠_blocks
 
‹ig_m≠
;

529 
	`mem˝y
(&
‹ig_m≠
, 
m≠
, (*map));

532 
m≠
->
m_Êags
 = 0;

533 
	`ext_debug
("pxt4_map_blocks(): inode %lu, flag %d, max_blocks %u,"

534 "logiˇ»block %lu\n", 
öode
->
i_öo
, 
Êags
, 
m≠
->
m_Àn
,

535 (Ë
m≠
->
m_lblk
);

540 i‡(
	`u∆ikñy
(
m≠
->
m_Àn
 > 
INT_MAX
))

541 
m≠
->
m_Àn
 = 
INT_MAX
;

544 i‡(
	`u∆ikñy
(
m≠
->
m_lblk
 >
EXT_MAX_BLOCKS
))

545  -
EFSCORRUPTED
;

548 i‡(
	`pxt4_es_lookup_exã¡
(
öode
, 
m≠
->
m_lblk
, 
NULL
, &
es
)) {

549 i‡(
	`pxt4_es_is_wrôãn
(&
es
Ë|| 
	`pxt4_es_is_unwrôãn
(&es)) {

550 
m≠
->
m_pblk
 = 
	`pxt4_es_pblock
(&
es
) +

551 
m≠
->
m_lblk
 - 
es
.
es_lblk
;

552 
m≠
->
m_Êags
 |
	`pxt4_es_is_wrôãn
(&
es
) ?

553 
PXT4_MAP_MAPPED
 : 
PXT4_MAP_UNWRITTEN
;

554 
ªtvÆ
 = 
es
.
es_Àn
 - (
m≠
->
m_lblk
 -És.
es_lblk
);

555 i‡(
ªtvÆ
 > 
m≠
->
m_Àn
)

556 
ªtvÆ
 = 
m≠
->
m_Àn
;

557 
m≠
->
m_Àn
 = 
ªtvÆ
;

558 } i‡(
	`pxt4_es_is_dñayed
(&
es
Ë|| 
	`pxt4_es_is_hﬁe
(&es)) {

559 
m≠
->
m_pblk
 = 0;

560 
ªtvÆ
 = 
es
.
es_Àn
 - (
m≠
->
m_lblk
 -És.
es_lblk
);

561 i‡(
ªtvÆ
 > 
m≠
->
m_Àn
)

562 
ªtvÆ
 = 
m≠
->
m_Àn
;

563 
m≠
->
m_Àn
 = 
ªtvÆ
;

564 
ªtvÆ
 = 0;

566 
	`BUG
();

568 #ifde‡
ES_AGGRESSIVE_TEST


569 
	`pxt4_m≠_blocks_es_ªcheck
(
h™dÀ
, 
öode
, 
m≠
,

570 &
‹ig_m≠
, 
Êags
);

572 
found
;

579 
	`down_ªad
(&
	`PXT4_I
(
öode
)->
i_d©a_£m
);

580 i‡(
	`pxt4_ã°_öode_Êag
(
öode
, 
PXT4_INODE_EXTENTS
)) {

581 
ªtvÆ
 = 
	`pxt4_ext_m≠_blocks
(
h™dÀ
, 
öode
, 
m≠
, 
Êags
 &

582 
PXT4_GET_BLOCKS_KEEP_SIZE
);

584 
ªtvÆ
 = 
	`pxt4_öd_m≠_blocks
(
h™dÀ
, 
öode
, 
m≠
, 
Êags
 &

585 
PXT4_GET_BLOCKS_KEEP_SIZE
);

587 i‡(
ªtvÆ
 > 0) {

588 
°©us
;

590 i‡(
	`u∆ikñy
(
ªtvÆ
 !
m≠
->
m_Àn
)) {

591 
	`pxt4_w¨nög
(
öode
->
i_sb
,

594 
öode
->
i_öo
, 
ªtvÆ
, 
m≠
->
m_Àn
);

595 
	`WARN_ON
(1);

598 
°©us
 = 
m≠
->
m_Êags
 & 
PXT4_MAP_UNWRITTEN
 ?

599 
EXTENT_STATUS_UNWRITTEN
 : 
EXTENT_STATUS_WRITTEN
;

600 i‡(!(
Êags
 & 
PXT4_GET_BLOCKS_DELALLOC_RESERVE
) &&

601 !(
°©us
 & 
EXTENT_STATUS_WRITTEN
) &&

602 
	`pxt4_es_sˇn_ønge
(
öode
, &
pxt4_es_is_dñayed
, 
m≠
->
m_lblk
,

603 
m≠
->
m_lblk
 + m≠->
m_Àn
 - 1))

604 
°©us
 |
EXTENT_STATUS_DELAYED
;

605 
ªt
 = 
	`pxt4_es_ö£π_exã¡
(
öode
, 
m≠
->
m_lblk
,

606 
m≠
->
m_Àn
, m≠->
m_pblk
, 
°©us
);

607 i‡(
ªt
 < 0)

608 
ªtvÆ
 = 
ªt
;

610 
	`up_ªad
((&
	`PXT4_I
(
öode
)->
i_d©a_£m
));

612 
found
:

613 i‡(
ªtvÆ
 > 0 && 
m≠
->
m_Êags
 & 
PXT4_MAP_MAPPED
) {

614 
ªt
 = 
	`check_block_vÆidôy
(
öode
, 
m≠
);

615 i‡(
ªt
 != 0)

616  
ªt
;

620 i‡((
Êags
 & 
PXT4_GET_BLOCKS_CREATE
) == 0)

621  
ªtvÆ
;

630 i‡(
ªtvÆ
 > 0 && 
m≠
->
m_Êags
 & 
PXT4_MAP_MAPPED
)

636 i‡(!(
Êags
 & 
PXT4_GET_BLOCKS_CONVERT_UNWRITTEN
))

637  
ªtvÆ
;

643 
m≠
->
m_Êags
 &~
PXT4_MAP_FLAGS
;

651 
	`down_wrôe
(&
	`PXT4_I
(
öode
)->
i_d©a_£m
);

657 i‡(
	`pxt4_ã°_öode_Êag
(
öode
, 
PXT4_INODE_EXTENTS
)) {

658 
ªtvÆ
 = 
	`pxt4_ext_m≠_blocks
(
h™dÀ
, 
öode
, 
m≠
, 
Êags
);

660 
ªtvÆ
 = 
	`pxt4_öd_m≠_blocks
(
h™dÀ
, 
öode
, 
m≠
, 
Êags
);

662 i‡(
ªtvÆ
 > 0 && 
m≠
->
m_Êags
 & 
PXT4_MAP_NEW
) {

668 
	`pxt4_˛ór_öode_°©e
(
öode
, 
PXT4_STATE_EXT_MIGRATE
);

677 i‡((
ªtvÆ
 > 0) &&

678 (
Êags
 & 
PXT4_GET_BLOCKS_DELALLOC_RESERVE
))

679 
	`pxt4_da_upd©e_ª£rve_•a˚
(
öode
, 
ªtvÆ
, 1);

682 i‡(
ªtvÆ
 > 0) {

683 
°©us
;

685 i‡(
	`u∆ikñy
(
ªtvÆ
 !
m≠
->
m_Àn
)) {

686 
	`pxt4_w¨nög
(
öode
->
i_sb
,

689 
öode
->
i_öo
, 
ªtvÆ
, 
m≠
->
m_Àn
);

690 
	`WARN_ON
(1);

700 i‡(
Êags
 & 
PXT4_GET_BLOCKS_ZERO
 &&

701 
m≠
->
m_Êags
 & 
PXT4_MAP_MAPPED
 &&

702 
m≠
->
m_Êags
 & 
PXT4_MAP_NEW
) {

703 
ªt
 = 
	`pxt4_issue_zîoout
(
öode
, 
m≠
->
m_lblk
,

704 
m≠
->
m_pblk
, m≠->
m_Àn
);

705 i‡(
ªt
) {

706 
ªtvÆ
 = 
ªt
;

707 
out_£m
;

715 i‡((
Êags
 & 
PXT4_GET_BLOCKS_PRE_IO
) &&

716 
	`pxt4_es_lookup_exã¡
(
öode
, 
m≠
->
m_lblk
, 
NULL
, &
es
)) {

717 i‡(
	`pxt4_es_is_wrôãn
(&
es
))

718 
out_£m
;

720 
°©us
 = 
m≠
->
m_Êags
 & 
PXT4_MAP_UNWRITTEN
 ?

721 
EXTENT_STATUS_UNWRITTEN
 : 
EXTENT_STATUS_WRITTEN
;

722 i‡(!(
Êags
 & 
PXT4_GET_BLOCKS_DELALLOC_RESERVE
) &&

723 !(
°©us
 & 
EXTENT_STATUS_WRITTEN
) &&

724 
	`pxt4_es_sˇn_ønge
(
öode
, &
pxt4_es_is_dñayed
, 
m≠
->
m_lblk
,

725 
m≠
->
m_lblk
 + m≠->
m_Àn
 - 1))

726 
°©us
 |
EXTENT_STATUS_DELAYED
;

727 
ªt
 = 
	`pxt4_es_ö£π_exã¡
(
öode
, 
m≠
->
m_lblk
, m≠->
m_Àn
,

728 
m≠
->
m_pblk
, 
°©us
);

729 i‡(
ªt
 < 0) {

730 
ªtvÆ
 = 
ªt
;

731 
out_£m
;

735 
out_£m
:

736 
	`up_wrôe
((&
	`PXT4_I
(
öode
)->
i_d©a_£m
));

737 i‡(
ªtvÆ
 > 0 && 
m≠
->
m_Êags
 & 
PXT4_MAP_MAPPED
) {

738 
ªt
 = 
	`check_block_vÆidôy
(
öode
, 
m≠
);

739 i‡(
ªt
 != 0)

740  
ªt
;

747 i‡(
m≠
->
m_Êags
 & 
PXT4_MAP_NEW
 &&

748 !(
m≠
->
m_Êags
 & 
PXT4_MAP_UNWRITTEN
) &&

749 !(
Êags
 & 
PXT4_GET_BLOCKS_ZERO
) &&

750 !
	`pxt4_is_quŸa_fûe
(
öode
) &&

751 
	`pxt4_should_‹dî_d©a
(
öode
)) {

752 
loff_t
 
°¨t_byã
 =

753 (
loff_t
)
m≠
->
m_lblk
 << 
öode
->
i_blkbôs
;

754 
loff_t
 
Àngth
 = (loff_t)
m≠
->
m_Àn
 << 
öode
->
i_blkbôs
;

756 i‡(
Êags
 & 
PXT4_GET_BLOCKS_IO_SUBMIT
)

757 
ªt
 = 
	`pxt4_jbd3_öode_add_waô
(
h™dÀ
, 
öode
,

758 
°¨t_byã
, 
Àngth
);

760 
ªt
 = 
	`pxt4_jbd3_öode_add_wrôe
(
h™dÀ
, 
öode
,

761 
°¨t_byã
, 
Àngth
);

762 i‡(
ªt
)

763  
ªt
;

766  
ªtvÆ
;

767 
	}
}

773 
	$pxt4_upd©e_bh_°©e
(
buf„r_hód
 *
bh
, 
Êags
)

775 
ﬁd_°©e
;

776 
√w_°©e
;

778 
Êags
 &
PXT4_MAP_FLAGS
;

781 i‡(!
bh
->
b_∑ge
) {

782 
bh
->
b_°©e
 = (bh->b_°©ê& ~
PXT4_MAP_FLAGS
Ë| 
Êags
;

791 
ﬁd_°©e
 = 
	`READ_ONCE
(
bh
->
b_°©e
);

792 
√w_°©e
 = (
ﬁd_°©e
 & ~
PXT4_MAP_FLAGS
Ë| 
Êags
;

793 } 
	`u∆ikñy
(

794 
	`cmpxchg
(&
bh
->
b_°©e
, 
ﬁd_°©e
, 
√w_°©e
) != old_state));

795 
	}
}

797 
	$_pxt4_gë_block
(
öode
 *öode, 
£˘‹_t
 
iblock
,

798 
buf„r_hód
 *
bh
, 
Êags
)

800 
pxt4_m≠_blocks
 
m≠
;

801 
ªt
 = 0;

803 i‡(
	`pxt4_has_ölöe_d©a
(
öode
))

804  -
ERANGE
;

806 
m≠
.
m_lblk
 = 
iblock
;

807 
m≠
.
m_Àn
 = 
bh
->
b_size
 >> 
öode
->
i_blkbôs
;

809 
ªt
 = 
	`pxt4_m≠_blocks
(
	`pxt4_jou∫Æ_cuºít_h™dÀ
(), 
öode
, &
m≠
,

810 
Êags
);

811 i‡(
ªt
 > 0) {

812 
	`m≠_bh
(
bh
, 
öode
->
i_sb
, 
m≠
.
m_pblk
);

813 
	`pxt4_upd©e_bh_°©e
(
bh
, 
m≠
.
m_Êags
);

814 
bh
->
b_size
 = 
öode
->
i_sb
->
s_blocksize
 * 
m≠
.
m_Àn
;

815 
ªt
 = 0;

816 } i‡(
ªt
 == 0) {

818 
bh
->
b_size
 = 
öode
->
i_sb
->
s_blocksize
 * 
m≠
.
m_Àn
;

820  
ªt
;

821 
	}
}

823 
	$pxt4_gë_block
(
öode
 *öode, 
£˘‹_t
 
iblock
,

824 
buf„r_hód
 *
bh
, 
¸óã
)

826  
	`_pxt4_gë_block
(
öode
, 
iblock
, 
bh
,

827 
¸óã
 ? 
PXT4_GET_BLOCKS_CREATE
 : 0);

828 
	}
}

835 
	$pxt4_gë_block_unwrôãn
(
öode
 *öode, 
£˘‹_t
 
iblock
,

836 
buf„r_hód
 *
bh_ªsu…
, 
¸óã
)

838 
	`pxt4_debug
("pxt4_get_block_unwritten: inode %lu, create flag %d\n",

839 
öode
->
i_öo
, 
¸óã
);

840  
	`_pxt4_gë_block
(
öode
, 
iblock
, 
bh_ªsu…
,

841 
PXT4_GET_BLOCKS_IO_CREATE_EXT
);

842 
	}
}

845 
	#DIO_MAX_BLOCKS
 4096

	)

852 
	$pxt4_gë_block_å™s
(
öode
 *öode, 
£˘‹_t
 
iblock
,

853 
buf„r_hód
 *
bh_ªsu…
, 
Êags
)

855 
dio_¸edôs
;

856 
h™dÀ_t
 *
h™dÀ
;

857 
ªåõs
 = 0;

858 
ªt
;

861 i‡(
bh_ªsu…
->
b_size
 >> 
öode
->
i_blkbôs
 > 
DIO_MAX_BLOCKS
)

862 
bh_ªsu…
->
b_size
 = 
DIO_MAX_BLOCKS
 << 
öode
->
i_blkbôs
;

863 
dio_¸edôs
 = 
	`pxt4_chunk_å™s_blocks
(
öode
,

864 
bh_ªsu…
->
b_size
 >> 
öode
->
i_blkbôs
);

865 
ªåy
:

866 
h™dÀ
 = 
	`pxt4_jou∫Æ_°¨t
(
öode
, 
PXT4_HT_MAP_BLOCKS
, 
dio_¸edôs
);

867 i‡(
	`IS_ERR
(
h™dÀ
))

868  
	`PTR_ERR
(
h™dÀ
);

870 
ªt
 = 
	`_pxt4_gë_block
(
öode
, 
iblock
, 
bh_ªsu…
, 
Êags
);

871 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

873 i‡(
ªt
 =-
ENOSPC
 && 
	`pxt4_should_ªåy_Æloc
(
öode
->
i_sb
, &
ªåõs
))

874 
ªåy
;

875  
ªt
;

876 
	}
}

879 
	$pxt4_dio_gë_block
(
öode
 *öode, 
£˘‹_t
 
iblock
,

880 
buf„r_hód
 *
bh
, 
¸óã
)

883 
	`WARN_ON_ONCE
(
	`pxt4_jou∫Æ_cuºít_h™dÀ
());

885 i‡(!
¸óã
)

886  
	`_pxt4_gë_block
(
öode
, 
iblock
, 
bh
, 0);

887  
	`pxt4_gë_block_å™s
(
öode
, 
iblock
, 
bh
, 
PXT4_GET_BLOCKS_CREATE
);

888 
	}
}

895 
	$pxt4_dio_gë_block_unwrôãn_async
(
öode
 *inode,

896 
£˘‹_t
 
iblock
, 
buf„r_hód
 *
bh_ªsu…
, 
¸óã
)

898 
ªt
;

901 
	`WARN_ON_ONCE
(
	`pxt4_jou∫Æ_cuºít_h™dÀ
());

903 
ªt
 = 
	`pxt4_gë_block_å™s
(
öode
, 
iblock
, 
bh_ªsu…
,

904 
PXT4_GET_BLOCKS_IO_CREATE_EXT
);

913 i‡(!
ªt
 && 
	`buf„r_unwrôãn
(
bh_ªsu…
)) {

914 i‡(!
bh_ªsu…
->
b_¥iv©e
) {

915 
pxt4_io_íd_t
 *
io_íd
;

917 
io_íd
 = 
	`pxt4_öô_io_íd
(
öode
, 
GFP_KERNEL
);

918 i‡(!
io_íd
)

919  -
ENOMEM
;

920 
bh_ªsu…
->
b_¥iv©e
 = 
io_íd
;

921 
	`pxt4_£t_io_unwrôãn_Êag
(
öode
, 
io_íd
);

923 
	`£t_buf„r_de„r_com∂ëi⁄
(
bh_ªsu…
);

926  
ªt
;

927 
	}
}

934 
	$pxt4_dio_gë_block_unwrôãn_sync
(
öode
 *inode,

935 
£˘‹_t
 
iblock
, 
buf„r_hód
 *
bh_ªsu…
, 
¸óã
)

937 
ªt
;

940 
	`WARN_ON_ONCE
(
	`pxt4_jou∫Æ_cuºít_h™dÀ
());

942 
ªt
 = 
	`pxt4_gë_block_å™s
(
öode
, 
iblock
, 
bh_ªsu…
,

943 
PXT4_GET_BLOCKS_IO_CREATE_EXT
);

950 i‡(!
ªt
 && 
	`buf„r_unwrôãn
(
bh_ªsu…
))

951 
	`pxt4_£t_öode_°©e
(
öode
, 
PXT4_STATE_DIO_UNWRITTEN
);

953  
ªt
;

954 
	}
}

956 
	$pxt4_dio_gë_block_ovîwrôe
(
öode
 *öode, 
£˘‹_t
 
iblock
,

957 
buf„r_hód
 *
bh_ªsu…
, 
¸óã
)

959 
ªt
;

961 
	`pxt4_debug
("pxt4_dio_get_block_overwrite: inode %lu, create flag %d\n",

962 
öode
->
i_öo
, 
¸óã
);

964 
	`WARN_ON_ONCE
(
	`pxt4_jou∫Æ_cuºít_h™dÀ
());

966 
ªt
 = 
	`_pxt4_gë_block
(
öode
, 
iblock
, 
bh_ªsu…
, 0);

971 
	`WARN_ON_ONCE
(!
	`buf„r_m≠≥d
(
bh_ªsu…
Ë|| 
	`buf„r_unwrôãn
(bh_result));

973  
ªt
;

974 
	}
}

980 
buf„r_hód
 *
	$pxt4_gëblk
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *inode,

981 
pxt4_lblk_t
 
block
, 
m≠_Êags
)

983 
pxt4_m≠_blocks
 
m≠
;

984 
buf„r_hód
 *
bh
;

985 
¸óã
 = 
m≠_Êags
 & 
PXT4_GET_BLOCKS_CREATE
;

986 
îr
;

988 
	`J_ASSERT
(
h™dÀ
 !
NULL
 || 
¸óã
 == 0);

990 
m≠
.
m_lblk
 = 
block
;

991 
m≠
.
m_Àn
 = 1;

992 
îr
 = 
	`pxt4_m≠_blocks
(
h™dÀ
, 
öode
, &
m≠
, 
m≠_Êags
);

994 i‡(
îr
 == 0)

995  
¸óã
 ? 
	`ERR_PTR
(-
ENOSPC
Ë: 
NULL
;

996 i‡(
îr
 < 0)

997  
	`ERR_PTR
(
îr
);

999 
bh
 = 
	`sb_gëblk
(
öode
->
i_sb
, 
m≠
.
m_pblk
);

1000 i‡(
	`u∆ikñy
(!
bh
))

1001  
	`ERR_PTR
(-
ENOMEM
);

1002 i‡(
m≠
.
m_Êags
 & 
PXT4_MAP_NEW
) {

1003 
	`J_ASSERT
(
¸óã
 != 0);

1004 
	`J_ASSERT
(
h™dÀ
 !
NULL
);

1013 
	`lock_buf„r
(
bh
);

1014 
	`BUFFER_TRACE
(
bh
, "call get_create_access");

1015 
îr
 = 
	`pxt4_jou∫Æ_gë_¸óã_ac˚ss
(
h™dÀ
, 
bh
);

1016 i‡(
	`u∆ikñy
(
îr
)) {

1017 
	`u∆ock_buf„r
(
bh
);

1018 
îrout
;

1020 i‡(!
	`buf„r_u±od©e
(
bh
)) {

1021 
	`mem£t
(
bh
->
b_d©a
, 0, 
öode
->
i_sb
->
s_blocksize
);

1022 
	`£t_buf„r_u±od©e
(
bh
);

1024 
	`u∆ock_buf„r
(
bh
);

1025 
	`BUFFER_TRACE
(
bh
, "callÖxt4_handle_dirty_metadata");

1026 
îr
 = 
	`pxt4_h™dÀ_dúty_mëad©a
(
h™dÀ
, 
öode
, 
bh
);

1027 i‡(
	`u∆ikñy
(
îr
))

1028 
îrout
;

1030 
	`BUFFER_TRACE
(
bh
, "notáÇew buffer");

1031  
bh
;

1032 
îrout
:

1033 
	`bªl£
(
bh
);

1034  
	`ERR_PTR
(
îr
);

1035 
	}
}

1037 
buf„r_hód
 *
	$pxt4_bªad
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *inode,

1038 
pxt4_lblk_t
 
block
, 
m≠_Êags
)

1040 
buf„r_hód
 *
bh
;

1042 
bh
 = 
	`pxt4_gëblk
(
h™dÀ
, 
öode
, 
block
, 
m≠_Êags
);

1043 i‡(
	`IS_ERR
(
bh
))

1044  
bh
;

1045 i‡(!
bh
 || 
	`pxt4_buf„r_u±od©e
(bh))

1046  
bh
;

1047 
	`Œ_rw_block
(
REQ_OP_READ
, 
REQ_META
 | 
REQ_PRIO
, 1, &
bh
);

1048 
	`waô_⁄_buf„r
(
bh
);

1049 i‡(
	`buf„r_u±od©e
(
bh
))

1050  
bh
;

1051 
	`put_bh
(
bh
);

1052  
	`ERR_PTR
(-
EIO
);

1053 
	}
}

1056 
	$pxt4_bªad_b©ch
(
öode
 *öode, 
pxt4_lblk_t
 
block
, 
bh_cou¡
,

1057 
boﬁ
 
waô
, 
buf„r_hód
 **
bhs
)

1059 
i
, 
îr
;

1061 
i
 = 0; i < 
bh_cou¡
; i++) {

1062 
bhs
[
i
] = 
	`pxt4_gëblk
(
NULL
, 
öode
, 
block
 + i, 0 );

1063 i‡(
	`IS_ERR
(
bhs
[
i
])) {

1064 
îr
 = 
	`PTR_ERR
(
bhs
[
i
]);

1065 
bh_cou¡
 = 
i
;

1066 
out_bªl£
;

1070 
i
 = 0; i < 
bh_cou¡
; i++)

1072 i‡(
bhs
[
i
] && !
	`pxt4_buf„r_u±od©e
(bhs[i]))

1073 
	`Œ_rw_block
(
REQ_OP_READ
, 
REQ_META
 | 
REQ_PRIO
, 1,

1074 &
bhs
[
i
]);

1076 i‡(!
waô
)

1079 
i
 = 0; i < 
bh_cou¡
; i++)

1080 i‡(
bhs
[
i
])

1081 
	`waô_⁄_buf„r
(
bhs
[
i
]);

1083 
i
 = 0; i < 
bh_cou¡
; i++) {

1084 i‡(
bhs
[
i
] && !
	`buf„r_u±od©e
(bhs[i])) {

1085 
îr
 = -
EIO
;

1086 
out_bªl£
;

1091 
out_bªl£
:

1092 
i
 = 0; i < 
bh_cou¡
; i++) {

1093 
	`bªl£
(
bhs
[
i
]);

1094 
bhs
[
i
] = 
NULL
;

1096  
îr
;

1097 
	}
}

1099 
	$pxt4_wÆk_∑ge_buf„rs
(
h™dÀ_t
 *
h™dÀ
,

1100 
buf„r_hód
 *
hód
,

1101 
‰om
,

1102 
to
,

1103 *
∑πül
,

1104 (*
‚
)(
h™dÀ_t
 *
h™dÀ
,

1105 
buf„r_hód
 *
bh
))

1107 
buf„r_hód
 *
bh
;

1108 
block_°¨t
, 
block_íd
;

1109 
blocksize
 = 
hód
->
b_size
;

1110 
îr
, 
ªt
 = 0;

1111 
buf„r_hód
 *
√xt
;

1113 
bh
 = 
hód
, 
block_°¨t
 = 0;

1114 
ªt
 =0 && (
bh
 !
hód
 || !
block_°¨t
);

1115 
block_°¨t
 = 
block_íd
, 
bh
 = 
√xt
) {

1116 
√xt
 = 
bh
->
b_this_∑ge
;

1117 
block_íd
 = 
block_°¨t
 + 
blocksize
;

1118 i‡(
block_íd
 <
‰om
 || 
block_°¨t
 >
to
) {

1119 i‡(
∑πül
 && !
	`buf„r_u±od©e
(
bh
))

1120 *
∑πül
 = 1;

1123 
îr
 = (*
‚
)(
h™dÀ
, 
bh
);

1124 i‡(!
ªt
)

1125 
ªt
 = 
îr
;

1127  
ªt
;

1128 
	}
}

1154 
	$do_jou∫Æ_gë_wrôe_ac˚ss
(
h™dÀ_t
 *
h™dÀ
,

1155 
buf„r_hód
 *
bh
)

1157 
dúty
 = 
	`buf„r_dúty
(
bh
);

1158 
ªt
;

1160 i‡(!
	`buf„r_m≠≥d
(
bh
Ë|| 
	`buf„r_‰ìd
(bh))

1170 i‡(
dúty
)

1171 
	`˛ór_buf„r_dúty
(
bh
);

1172 
	`BUFFER_TRACE
(
bh
, "get writeáccess");

1173 
ªt
 = 
	`pxt4_jou∫Æ_gë_wrôe_ac˚ss
(
h™dÀ
, 
bh
);

1174 i‡(!
ªt
 && 
dúty
)

1175 
ªt
 = 
	`pxt4_h™dÀ_dúty_mëad©a
(
h™dÀ
, 
NULL
, 
bh
);

1176  
ªt
;

1177 
	}
}

1179 #ifde‡
CONFIG_FS_ENCRYPTION


1180 
	$pxt4_block_wrôe_begö
(
∑ge
 *∑ge, 
loff_t
 
pos
, 
Àn
,

1181 
gë_block_t
 *
gë_block
)

1183 
‰om
 = 
pos
 & (
PAGE_SIZE
 - 1);

1184 
to
 = 
‰om
 + 
Àn
;

1185 
öode
 *öodê
∑ge
->
m≠pög
->
ho°
;

1186 
block_°¨t
, 
block_íd
;

1187 
£˘‹_t
 
block
;

1188 
îr
 = 0;

1189 
blocksize
 = 
öode
->
i_sb
->
s_blocksize
;

1190 
bbôs
;

1191 
buf„r_hód
 *
bh
, *
hód
, *
waô
[2];

1192 
ƒ_waô
 = 0;

1193 
i
;

1195 
	`BUG_ON
(!
	`PageLocked
(
∑ge
));

1196 
	`BUG_ON
(
‰om
 > 
PAGE_SIZE
);

1197 
	`BUG_ON
(
to
 > 
PAGE_SIZE
);

1198 
	`BUG_ON
(
‰om
 > 
to
);

1200 i‡(!
	`∑ge_has_buf„rs
(
∑ge
))

1201 
	`¸óã_em±y_buf„rs
(
∑ge
, 
blocksize
, 0);

1202 
hód
 = 
	`∑ge_buf„rs
(
∑ge
);

1203 
bbôs
 = 
	`ûog2
(
blocksize
);

1204 
block
 = (
£˘‹_t
)
∑ge
->
ödex
 << (
PAGE_SHIFT
 - 
bbôs
);

1206 
bh
 = 
hód
, 
block_°¨t
 = 0; bh != head || !block_start;

1207 
block
++, 
block_°¨t
 = 
block_íd
, 
bh
 = bh->
b_this_∑ge
) {

1208 
block_íd
 = 
block_°¨t
 + 
blocksize
;

1209 i‡(
block_íd
 <
‰om
 || 
block_°¨t
 >
to
) {

1210 i‡(
	`PageU±od©e
(
∑ge
)) {

1211 i‡(!
	`buf„r_u±od©e
(
bh
))

1212 
	`£t_buf„r_u±od©e
(
bh
);

1216 i‡(
	`buf„r_√w
(
bh
))

1217 
	`˛ór_buf„r_√w
(
bh
);

1218 i‡(!
	`buf„r_m≠≥d
(
bh
)) {

1219 
	`WARN_ON
(
bh
->
b_size
 !
blocksize
);

1220 
îr
 = 
	`gë_block
(
öode
, 
block
, 
bh
, 1);

1221 i‡(
îr
)

1223 i‡(
	`buf„r_√w
(
bh
)) {

1224 i‡(
	`PageU±od©e
(
∑ge
)) {

1225 
	`˛ór_buf„r_√w
(
bh
);

1226 
	`£t_buf„r_u±od©e
(
bh
);

1227 
	`m¨k_buf„r_dúty
(
bh
);

1230 i‡(
block_íd
 > 
to
 || 
block_°¨t
 < 
‰om
)

1231 
	`zîo_u£r_£gmíts
(
∑ge
, 
to
, 
block_íd
,

1232 
block_°¨t
, 
‰om
);

1236 i‡(
	`PageU±od©e
(
∑ge
)) {

1237 i‡(!
	`buf„r_u±od©e
(
bh
))

1238 
	`£t_buf„r_u±od©e
(
bh
);

1241 i‡(!
	`buf„r_u±od©e
(
bh
Ë&& !
	`buf„r_dñay
(bh) &&

1242 !
	`buf„r_unwrôãn
(
bh
) &&

1243 (
block_°¨t
 < 
‰om
 || 
block_íd
 > 
to
)) {

1244 
	`Œ_rw_block
(
REQ_OP_READ
, 0, 1, &
bh
);

1245 
waô
[
ƒ_waô
++] = 
bh
;

1251 
i
 = 0; i < 
ƒ_waô
; i++) {

1252 
	`waô_⁄_buf„r
(
waô
[
i
]);

1253 i‡(!
	`buf„r_u±od©e
(
waô
[
i
]))

1254 
îr
 = -
EIO
;

1256 i‡(
	`u∆ikñy
(
îr
)) {

1257 
	`∑ge_zîo_√w_buf„rs
(
∑ge
, 
‰om
, 
to
);

1258 } i‡(
	`IS_ENCRYPTED
(
öode
Ë&& 
	`S_ISREG
(öode->
i_mode
)) {

1259 
i
 = 0; i < 
ƒ_waô
; i++) {

1260 
îr2
;

1262 
îr2
 = 
	`fs¸y±_de¸y±_∑geˇche_blocks
(
∑ge
, 
blocksize
,

1263 
	`bh_off£t
(
waô
[
i
]));

1264 i‡(
îr2
) {

1265 
	`˛ór_buf„r_u±od©e
(
waô
[
i
]);

1266 
îr
 = 
îr2
;

1271  
îr
;

1272 
	}
}

1275 
	$pxt4_wrôe_begö
(
fûe
 *fûe, 
addªss_•a˚
 *
m≠pög
,

1276 
loff_t
 
pos
, 
Àn
, 
Êags
,

1277 
∑ge
 **
∑gï
, **
fsd©a
)

1279 
öode
 *öodê
m≠pög
->
ho°
;

1280 
ªt
, 
√eded_blocks
;

1281 
h™dÀ_t
 *
h™dÀ
;

1282 
ªåõs
 = 0;

1283 
∑ge
 *page;

1284 
pgoff_t
 
ödex
;

1285 
‰om
, 
to
;

1287 i‡(
	`u∆ikñy
(
	`pxt4_f‹˚d_shutdown
(
	`PXT4_SB
(
öode
->
i_sb
))))

1288  -
EIO
;

1290 
	`åa˚_pxt4_wrôe_begö
(
öode
, 
pos
, 
Àn
, 
Êags
);

1295 
√eded_blocks
 = 
	`pxt4_wrôïage_å™s_blocks
(
öode
) + 1;

1296 
ödex
 = 
pos
 >> 
PAGE_SHIFT
;

1297 
‰om
 = 
pos
 & (
PAGE_SIZE
 - 1);

1298 
to
 = 
‰om
 + 
Àn
;

1300 i‡(
	`pxt4_ã°_öode_°©e
(
öode
, 
PXT4_STATE_MAY_INLINE_DATA
)) {

1301 
ªt
 = 
	`pxt4_åy_to_wrôe_ölöe_d©a
(
m≠pög
, 
öode
, 
pos
, 
Àn
,

1302 
Êags
, 
∑gï
);

1303 i‡(
ªt
 < 0)

1304  
ªt
;

1305 i‡(
ªt
 == 1)

1316 
ªåy_gøb
:

1317 
∑ge
 = 
	`gøb_ˇche_∑ge_wrôe_begö
(
m≠pög
, 
ödex
, 
Êags
);

1318 i‡(!
∑ge
)

1319  -
ENOMEM
;

1320 
	`u∆ock_∑ge
(
∑ge
);

1322 
ªåy_jou∫Æ
:

1323 
h™dÀ
 = 
	`pxt4_jou∫Æ_°¨t
(
öode
, 
PXT4_HT_WRITE_PAGE
, 
√eded_blocks
);

1324 i‡(
	`IS_ERR
(
h™dÀ
)) {

1325 
	`put_∑ge
(
∑ge
);

1326  
	`PTR_ERR
(
h™dÀ
);

1329 
	`lock_∑ge
(
∑ge
);

1330 i‡(
∑ge
->
m≠pög
 != mapping) {

1332 
	`u∆ock_∑ge
(
∑ge
);

1333 
	`put_∑ge
(
∑ge
);

1334 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

1335 
ªåy_gøb
;

1338 
	`waô_f‹_°abÀ_∑ge
(
∑ge
);

1340 #ifde‡
CONFIG_FS_ENCRYPTION


1341 i‡(
	`pxt4_should_di‹ód_nﬁock
(
öode
))

1342 
ªt
 = 
	`pxt4_block_wrôe_begö
(
∑ge
, 
pos
, 
Àn
,

1343 
pxt4_gë_block_unwrôãn
);

1345 
ªt
 = 
	`pxt4_block_wrôe_begö
(
∑ge
, 
pos
, 
Àn
,

1346 
pxt4_gë_block
);

1348 i‡(
	`pxt4_should_di‹ód_nﬁock
(
öode
))

1349 
ªt
 = 
	`__block_wrôe_begö
(
∑ge
, 
pos
, 
Àn
,

1350 
pxt4_gë_block_unwrôãn
);

1352 
ªt
 = 
	`__block_wrôe_begö
(
∑ge
, 
pos
, 
Àn
, 
pxt4_gë_block
);

1354 i‡(!
ªt
 && 
	`pxt4_should_jou∫Æ_d©a
(
öode
)) {

1355 
ªt
 = 
	`pxt4_wÆk_∑ge_buf„rs
(
h™dÀ
, 
	`∑ge_buf„rs
(
∑ge
),

1356 
‰om
, 
to
, 
NULL
,

1357 
do_jou∫Æ_gë_wrôe_ac˚ss
);

1360 i‡(
ªt
) {

1361 
boﬁ
 
exãnded
 = (
pos
 + 
Àn
 > 
öode
->
i_size
) &&

1362 !
	`pxt4_vîôy_ö_¥ogªss
(
öode
);

1364 
	`u∆ock_∑ge
(
∑ge
);

1373 i‡(
exãnded
 && 
	`pxt4_ˇn_åunˇã
(
öode
))

1374 
	`pxt4_‹ph™_add
(
h™dÀ
, 
öode
);

1376 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

1377 i‡(
exãnded
) {

1378 
	`pxt4_åunˇã_Áûed_wrôe
(
öode
);

1385 i‡(
öode
->
i_∆ök
)

1386 
	`pxt4_‹ph™_dñ
(
NULL
, 
öode
);

1389 i‡(
ªt
 =-
ENOSPC
 &&

1390 
	`pxt4_should_ªåy_Æloc
(
öode
->
i_sb
, &
ªåõs
))

1391 
ªåy_jou∫Æ
;

1392 
	`put_∑ge
(
∑ge
);

1393  
ªt
;

1395 *
∑gï
 = 
∑ge
;

1396  
ªt
;

1397 
	}
}

1400 
	$wrôe_íd_‚
(
h™dÀ_t
 *
h™dÀ
, 
buf„r_hód
 *
bh
)

1402 
ªt
;

1403 i‡(!
	`buf„r_m≠≥d
(
bh
Ë|| 
	`buf„r_‰ìd
(bh))

1405 
	`£t_buf„r_u±od©e
(
bh
);

1406 
ªt
 = 
	`pxt4_h™dÀ_dúty_mëad©a
(
h™dÀ
, 
NULL
, 
bh
);

1407 
	`˛ór_buf„r_mëa
(
bh
);

1408 
	`˛ór_buf„r_¥io
(
bh
);

1409  
ªt
;

1410 
	}
}

1419 
	$pxt4_wrôe_íd
(
fûe
 *file,

1420 
addªss_•a˚
 *
m≠pög
,

1421 
loff_t
 
pos
, 
Àn
, 
c›õd
,

1422 
∑ge
 *∑ge, *
fsd©a
)

1424 
h™dÀ_t
 *
h™dÀ
 = 
	`pxt4_jou∫Æ_cuºít_h™dÀ
();

1425 
öode
 *öodê
m≠pög
->
ho°
;

1426 
loff_t
 
ﬁd_size
 = 
öode
->
i_size
;

1427 
ªt
 = 0, 
ªt2
;

1428 
i_size_ch™ged
 = 0;

1429 
ölöe_d©a
 = 
	`pxt4_has_ölöe_d©a
(
öode
);

1430 
boﬁ
 
vîôy
 = 
	`pxt4_vîôy_ö_¥ogªss
(
öode
);

1432 
	`åa˚_pxt4_wrôe_íd
(
öode
, 
pos
, 
Àn
, 
c›õd
);

1433 i‡(
ölöe_d©a
) {

1434 
ªt
 = 
	`pxt4_wrôe_ölöe_d©a_íd
(
öode
, 
pos
, 
Àn
,

1435 
c›õd
, 
∑ge
);

1436 i‡(
ªt
 < 0) {

1437 
	`u∆ock_∑ge
(
∑ge
);

1438 
	`put_∑ge
(
∑ge
);

1439 
îrout
;

1441 
c›õd
 = 
ªt
;

1443 
c›õd
 = 
	`block_wrôe_íd
(
fûe
, 
m≠pög
, 
pos
,

1444 
Àn
, 
c›õd
, 
∑ge
, 
fsd©a
);

1452 i‡(!
vîôy
)

1453 
i_size_ch™ged
 = 
	`pxt4_upd©e_öode_size
(
öode
, 
pos
 + 
c›õd
);

1454 
	`u∆ock_∑ge
(
∑ge
);

1455 
	`put_∑ge
(
∑ge
);

1457 i‡(
ﬁd_size
 < 
pos
 && !
vîôy
)

1458 
	`∑geˇche_isize_exãnded
(
öode
, 
ﬁd_size
, 
pos
);

1465 i‡(
i_size_ch™ged
 || 
ölöe_d©a
)

1466 
	`pxt4_m¨k_öode_dúty
(
h™dÀ
, 
öode
);

1468 i‡(
pos
 + 
Àn
 > 
öode
->
i_size
 && !
vîôy
 && 
	`pxt4_ˇn_åunˇã
(inode))

1473 
	`pxt4_‹ph™_add
(
h™dÀ
, 
öode
);

1474 
îrout
:

1475 
ªt2
 = 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

1476 i‡(!
ªt
)

1477 
ªt
 = 
ªt2
;

1479 i‡(
pos
 + 
Àn
 > 
öode
->
i_size
 && !
vîôy
) {

1480 
	`pxt4_åunˇã_Áûed_wrôe
(
öode
);

1486 i‡(
öode
->
i_∆ök
)

1487 
	`pxt4_‹ph™_dñ
(
NULL
, 
öode
);

1490  
ªt
 ?Ñë : 
c›õd
;

1491 
	}
}

1498 
	$pxt4_jou∫ÆÀd_zîo_√w_buf„rs
(
h™dÀ_t
 *
h™dÀ
,

1499 
∑ge
 *page,

1500 
‰om
, 
to
)

1502 
block_°¨t
 = 0, 
block_íd
;

1503 
buf„r_hód
 *
hód
, *
bh
;

1505 
bh
 = 
hód
 = 
	`∑ge_buf„rs
(
∑ge
);

1507 
block_íd
 = 
block_°¨t
 + 
bh
->
b_size
;

1508 i‡(
	`buf„r_√w
(
bh
)) {

1509 i‡(
block_íd
 > 
‰om
 && 
block_°¨t
 < 
to
) {

1510 i‡(!
	`PageU±od©e
(
∑ge
)) {

1511 
°¨t
, 
size
;

1513 
°¨t
 = 
	`max
(
‰om
, 
block_°¨t
);

1514 
size
 = 
	`mö
(
to
, 
block_íd
Ë- 
°¨t
;

1516 
	`zîo_u£r
(
∑ge
, 
°¨t
, 
size
);

1517 
	`wrôe_íd_‚
(
h™dÀ
, 
bh
);

1519 
	`˛ór_buf„r_√w
(
bh
);

1522 
block_°¨t
 = 
block_íd
;

1523 
bh
 = bh->
b_this_∑ge
;

1524 } 
bh
 !
hód
);

1525 
	}
}

1527 
	$pxt4_jou∫ÆÀd_wrôe_íd
(
fûe
 *file,

1528 
addªss_•a˚
 *
m≠pög
,

1529 
loff_t
 
pos
, 
Àn
, 
c›õd
,

1530 
∑ge
 *∑ge, *
fsd©a
)

1532 
h™dÀ_t
 *
h™dÀ
 = 
	`pxt4_jou∫Æ_cuºít_h™dÀ
();

1533 
öode
 *öodê
m≠pög
->
ho°
;

1534 
loff_t
 
ﬁd_size
 = 
öode
->
i_size
;

1535 
ªt
 = 0, 
ªt2
;

1536 
∑πül
 = 0;

1537 
‰om
, 
to
;

1538 
size_ch™ged
 = 0;

1539 
ölöe_d©a
 = 
	`pxt4_has_ölöe_d©a
(
öode
);

1540 
boﬁ
 
vîôy
 = 
	`pxt4_vîôy_ö_¥ogªss
(
öode
);

1542 
	`åa˚_pxt4_jou∫ÆÀd_wrôe_íd
(
öode
, 
pos
, 
Àn
, 
c›õd
);

1543 
‰om
 = 
pos
 & (
PAGE_SIZE
 - 1);

1544 
to
 = 
‰om
 + 
Àn
;

1546 
	`BUG_ON
(!
	`pxt4_h™dÀ_vÆid
(
h™dÀ
));

1548 i‡(
ölöe_d©a
) {

1549 
ªt
 = 
	`pxt4_wrôe_ölöe_d©a_íd
(
öode
, 
pos
, 
Àn
,

1550 
c›õd
, 
∑ge
);

1551 i‡(
ªt
 < 0) {

1552 
	`u∆ock_∑ge
(
∑ge
);

1553 
	`put_∑ge
(
∑ge
);

1554 
îrout
;

1556 
c›õd
 = 
ªt
;

1557 } i‡(
	`u∆ikñy
(
c›õd
 < 
Àn
Ë&& !
	`PageU±od©e
(
∑ge
)) {

1558 
c›õd
 = 0;

1559 
	`pxt4_jou∫ÆÀd_zîo_√w_buf„rs
(
h™dÀ
, 
∑ge
, 
‰om
, 
to
);

1561 i‡(
	`u∆ikñy
(
c›õd
 < 
Àn
))

1562 
	`pxt4_jou∫ÆÀd_zîo_√w_buf„rs
(
h™dÀ
, 
∑ge
,

1563 
‰om
 + 
c›õd
, 
to
);

1564 
ªt
 = 
	`pxt4_wÆk_∑ge_buf„rs
(
h™dÀ
, 
	`∑ge_buf„rs
(
∑ge
), 
‰om
,

1565 
‰om
 + 
c›õd
, &
∑πül
,

1566 
wrôe_íd_‚
);

1567 i‡(!
∑πül
)

1568 
	`SëPageU±od©e
(
∑ge
);

1570 i‡(!
vîôy
)

1571 
size_ch™ged
 = 
	`pxt4_upd©e_öode_size
(
öode
, 
pos
 + 
c›õd
);

1572 
	`pxt4_£t_öode_°©e
(
öode
, 
PXT4_STATE_JDATA
);

1573 
	`PXT4_I
(
öode
)->
i_d©async_tid
 = 
h™dÀ
->
h_å™ß˘i⁄
->
t_tid
;

1574 
	`u∆ock_∑ge
(
∑ge
);

1575 
	`put_∑ge
(
∑ge
);

1577 i‡(
ﬁd_size
 < 
pos
 && !
vîôy
)

1578 
	`∑geˇche_isize_exãnded
(
öode
, 
ﬁd_size
, 
pos
);

1580 i‡(
size_ch™ged
 || 
ölöe_d©a
) {

1581 
ªt2
 = 
	`pxt4_m¨k_öode_dúty
(
h™dÀ
, 
öode
);

1582 i‡(!
ªt
)

1583 
ªt
 = 
ªt2
;

1586 i‡(
pos
 + 
Àn
 > 
öode
->
i_size
 && !
vîôy
 && 
	`pxt4_ˇn_åunˇã
(inode))

1591 
	`pxt4_‹ph™_add
(
h™dÀ
, 
öode
);

1593 
îrout
:

1594 
ªt2
 = 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

1595 i‡(!
ªt
)

1596 
ªt
 = 
ªt2
;

1597 i‡(
pos
 + 
Àn
 > 
öode
->
i_size
 && !
vîôy
) {

1598 
	`pxt4_åunˇã_Áûed_wrôe
(
öode
);

1604 i‡(
öode
->
i_∆ök
)

1605 
	`pxt4_‹ph™_dñ
(
NULL
, 
öode
);

1608  
ªt
 ?Ñë : 
c›õd
;

1609 
	}
}

1614 
	$pxt4_da_ª£rve_•a˚
(
öode
 *inode)

1616 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
öode
->
i_sb
);

1617 
pxt4_öode_öfo
 *
ei
 = 
	`PXT4_I
(
öode
);

1618 
ªt
;

1625 
ªt
 = 
	`dquŸ_ª£rve_block
(
öode
, 
	`PXT4_C2B
(
sbi
, 1));

1626 i‡(
ªt
)

1627  
ªt
;

1629 
	`•ö_lock
(&
ei
->
i_block_ª£rv©i⁄_lock
);

1630 i‡(
	`pxt4_˛aim_‰ì_˛u°îs
(
sbi
, 1, 0)) {

1631 
	`•ö_u∆ock
(&
ei
->
i_block_ª£rv©i⁄_lock
);

1632 
	`dquŸ_ªÀa£_ª£rv©i⁄_block
(
öode
, 
	`PXT4_C2B
(
sbi
, 1));

1633  -
ENOSPC
;

1635 
ei
->
i_ª£rved_d©a_blocks
++;

1636 
	`åa˚_pxt4_da_ª£rve_•a˚
(
öode
);

1637 
	`•ö_u∆ock
(&
ei
->
i_block_ª£rv©i⁄_lock
);

1640 
	}
}

1642 
	$pxt4_da_ªÀa£_•a˚
(
öode
 *öode, 
to_‰ì
)

1644 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
öode
->
i_sb
);

1645 
pxt4_öode_öfo
 *
ei
 = 
	`PXT4_I
(
öode
);

1647 i‡(!
to_‰ì
)

1650 
	`•ö_lock
(&
	`PXT4_I
(
öode
)->
i_block_ª£rv©i⁄_lock
);

1652 
	`åa˚_pxt4_da_ªÀa£_•a˚
(
öode
, 
to_‰ì
);

1653 i‡(
	`u∆ikñy
(
to_‰ì
 > 
ei
->
i_ª£rved_d©a_blocks
)) {

1660 
	`pxt4_w¨nög
(
öode
->
i_sb
, "pxt4_da_release_space: "

1662 "d©®blocks", 
öode
->
i_öo
, 
to_‰ì
,

1663 
ei
->
i_ª£rved_d©a_blocks
);

1664 
	`WARN_ON
(1);

1665 
to_‰ì
 = 
ei
->
i_ª£rved_d©a_blocks
;

1667 
ei
->
i_ª£rved_d©a_blocks
 -
to_‰ì
;

1670 
	`≥r˝u_cou¡î_sub
(&
sbi
->
s_dúty˛u°îs_cou¡î
, 
to_‰ì
);

1672 
	`•ö_u∆ock
(&
	`PXT4_I
(
öode
)->
i_block_ª£rv©i⁄_lock
);

1674 
	`dquŸ_ªÀa£_ª£rv©i⁄_block
(
öode
, 
	`PXT4_C2B
(
sbi
, 
to_‰ì
));

1675 
	}
}

1681 
	sm∑ge_da_d©a
 {

1682 
öode
 *
	möode
;

1683 
wrôeback_c⁄åﬁ
 *
	mwbc
;

1685 
pgoff_t
 
	mfú°_∑ge
;

1686 
pgoff_t
 
	m√xt_∑ge
;

1687 
pgoff_t
 
	mœ°_∑ge
;

1693 
pxt4_m≠_blocks
 
	mm≠
;

1694 
pxt4_io_submô
 
	mio_submô
;

1695 
	mdo_m≠
:1;

1698 
	$m∑ge_ªÀa£_unu£d_∑ges
(
m∑ge_da_d©a
 *
mpd
,

1699 
boﬁ
 
övÆid©e
)

1701 
ƒ_∑ges
, 
i
;

1702 
pgoff_t
 
ödex
, 
íd
;

1703 
∑gevec
 
pvec
;

1704 
öode
 *öodê
mpd
->inode;

1705 
addªss_•a˚
 *
m≠pög
 = 
öode
->
i_m≠pög
;

1708 i‡(
mpd
->
fú°_∑ge
 >mpd->
√xt_∑ge
)

1711 
ödex
 = 
mpd
->
fú°_∑ge
;

1712 
íd
 = 
mpd
->
√xt_∑ge
 - 1;

1713 i‡(
övÆid©e
) {

1714 
pxt4_lblk_t
 
°¨t
, 
œ°
;

1715 
°¨t
 = 
ödex
 << (
PAGE_SHIFT
 - 
öode
->
i_blkbôs
);

1716 
œ°
 = 
íd
 << (
PAGE_SHIFT
 - 
öode
->
i_blkbôs
);

1717 
	`pxt4_es_ªmove_exã¡
(
öode
, 
°¨t
, 
œ°
 - start + 1);

1720 
	`∑gevec_öô
(&
pvec
);

1721 
ödex
 <
íd
) {

1722 
ƒ_∑ges
 = 
	`∑gevec_lookup_ønge
(&
pvec
, 
m≠pög
, &
ödex
, 
íd
);

1723 i‡(
ƒ_∑ges
 == 0)

1725 
i
 = 0; i < 
ƒ_∑ges
; i++) {

1726 
∑ge
 *∑gê
pvec
.
∑ges
[
i
];

1728 
	`BUG_ON
(!
	`PageLocked
(
∑ge
));

1729 
	`BUG_ON
(
	`PageWrôeback
(
∑ge
));

1730 i‡(
övÆid©e
) {

1731 i‡(
	`∑ge_m≠≥d
(
∑ge
))

1732 
	`˛ór_∑ge_dúty_f‹_io
(
∑ge
);

1733 
	`block_övÆid©ïage
(
∑ge
, 0, 
PAGE_SIZE
);

1734 
	`CÀ¨PageU±od©e
(
∑ge
);

1736 
	`u∆ock_∑ge
(
∑ge
);

1738 
	`∑gevec_ªÀa£
(&
pvec
);

1740 
	}
}

1742 
	$pxt4_¥öt_‰ì_blocks
(
öode
 *inode)

1744 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
öode
->
i_sb
);

1745 
su≥r_block
 *
sb
 = 
öode
->
i_sb
;

1746 
pxt4_öode_öfo
 *
ei
 = 
	`PXT4_I
(
öode
);

1748 
	`pxt4_msg
(
sb
, 
KERN_CRIT
, "Total free blocks count %lld",

1749 
	`PXT4_C2B
(
	`PXT4_SB
(
öode
->
i_sb
),

1750 
	`pxt4_cou¡_‰ì_˛u°îs
(
sb
)));

1751 
	`pxt4_msg
(
sb
, 
KERN_CRIT
, "Free/Dirty block details");

1752 
	`pxt4_msg
(
sb
, 
KERN_CRIT
, "free_blocks=%lld",

1753 (Ë
	`PXT4_C2B
(
	`PXT4_SB
(
sb
),

1754 
	`≥r˝u_cou¡î_sum
(&
sbi
->
s_‰ì˛u°îs_cou¡î
)));

1755 
	`pxt4_msg
(
sb
, 
KERN_CRIT
, "dirty_blocks=%lld",

1756 (Ë
	`PXT4_C2B
(
	`PXT4_SB
(
sb
),

1757 
	`≥r˝u_cou¡î_sum
(&
sbi
->
s_dúty˛u°îs_cou¡î
)));

1758 
	`pxt4_msg
(
sb
, 
KERN_CRIT
, "BlockÑeservation details");

1759 
	`pxt4_msg
(
sb
, 
KERN_CRIT
, "i_reserved_data_blocks=%u",

1760 
ei
->
i_ª£rved_d©a_blocks
);

1762 
	}
}

1764 
	$pxt4_bh_dñay_‹_unwrôãn
(
h™dÀ_t
 *
h™dÀ
, 
buf„r_hód
 *
bh
)

1766  (
	`buf„r_dñay
(
bh
Ë|| 
	`buf„r_unwrôãn
(bh)Ë&& 
	`buf„r_dúty
(bh);

1767 
	}
}

1780 
	$pxt4_ö£π_dñayed_block
(
öode
 *öode, 
pxt4_lblk_t
 
lblk
)

1782 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
öode
->
i_sb
);

1783 
ªt
;

1784 
boﬁ
 
Æloˇãd
 = 
Ál£
;

1797 i‡(
sbi
->
s_˛u°î_øtio
 == 1) {

1798 
ªt
 = 
	`pxt4_da_ª£rve_•a˚
(
öode
);

1799 i‡(
ªt
 != 0)

1800 
îrout
;

1802 i‡(!
	`pxt4_es_sˇn_˛u
(
öode
, &
pxt4_es_is_dñ⁄ly
, 
lblk
)) {

1803 i‡(!
	`pxt4_es_sˇn_˛u
(
öode
,

1804 &
pxt4_es_is_m≠≥d
, 
lblk
)) {

1805 
ªt
 = 
	`pxt4_˛u_m≠≥d
(
öode
,

1806 
	`PXT4_B2C
(
sbi
, 
lblk
));

1807 i‡(
ªt
 < 0)

1808 
îrout
;

1809 i‡(
ªt
 == 0) {

1810 
ªt
 = 
	`pxt4_da_ª£rve_•a˚
(
öode
);

1811 i‡(
ªt
 != 0)

1812 
îrout
;

1814 
Æloˇãd
 = 
åue
;

1817 
Æloˇãd
 = 
åue
;

1822 
ªt
 = 
	`pxt4_es_ö£π_dñayed_block
(
öode
, 
lblk
, 
Æloˇãd
);

1824 
îrout
:

1825  
ªt
;

1826 
	}
}

1834 
	$pxt4_da_m≠_blocks
(
öode
 *öode, 
£˘‹_t
 
iblock
,

1835 
pxt4_m≠_blocks
 *
m≠
,

1836 
buf„r_hód
 *
bh
)

1838 
exã¡_°©us
 
es
;

1839 
ªtvÆ
;

1840 
£˘‹_t
 
övÆid_block
 = ~((sector_t) 0xffff);

1841 #ifde‡
ES_AGGRESSIVE_TEST


1842 
pxt4_m≠_blocks
 
‹ig_m≠
;

1844 
	`mem˝y
(&
‹ig_m≠
, 
m≠
, (*map));

1847 i‡(
övÆid_block
 < 
	`pxt4_blocks_cou¡
(
	`PXT4_SB
(
öode
->
i_sb
)->
s_es
))

1848 
övÆid_block
 = ~0;

1850 
m≠
->
m_Êags
 = 0;

1851 
	`ext_debug
("pxt4_da_map_blocks(): inode %lu, max_blocks %u,"

1852 "logiˇ»block %lu\n", 
öode
->
i_öo
, 
m≠
->
m_Àn
,

1853 (Ë
m≠
->
m_lblk
);

1856 i‡(
	`pxt4_es_lookup_exã¡
(
öode
, 
iblock
, 
NULL
, &
es
)) {

1857 i‡(
	`pxt4_es_is_hﬁe
(&
es
)) {

1858 
ªtvÆ
 = 0;

1859 
	`down_ªad
(&
	`PXT4_I
(
öode
)->
i_d©a_£m
);

1860 
add_dñayed
;

1867 i‡(
	`pxt4_es_is_dñayed
(&
es
Ë&& !
	`pxt4_es_is_unwrôãn
(&es)) {

1868 
	`m≠_bh
(
bh
, 
öode
->
i_sb
, 
övÆid_block
);

1869 
	`£t_buf„r_√w
(
bh
);

1870 
	`£t_buf„r_dñay
(
bh
);

1874 
m≠
->
m_pblk
 = 
	`pxt4_es_pblock
(&
es
Ë+ 
iblock
 -És.
es_lblk
;

1875 
ªtvÆ
 = 
es
.
es_Àn
 - (
iblock
 -És.
es_lblk
);

1876 i‡(
ªtvÆ
 > 
m≠
->
m_Àn
)

1877 
ªtvÆ
 = 
m≠
->
m_Àn
;

1878 
m≠
->
m_Àn
 = 
ªtvÆ
;

1879 i‡(
	`pxt4_es_is_wrôãn
(&
es
))

1880 
m≠
->
m_Êags
 |
PXT4_MAP_MAPPED
;

1881 i‡(
	`pxt4_es_is_unwrôãn
(&
es
))

1882 
m≠
->
m_Êags
 |
PXT4_MAP_UNWRITTEN
;

1884 
	`BUG
();

1886 #ifde‡
ES_AGGRESSIVE_TEST


1887 
	`pxt4_m≠_blocks_es_ªcheck
(
NULL
, 
öode
, 
m≠
, &
‹ig_m≠
, 0);

1889  
ªtvÆ
;

1896 
	`down_ªad
(&
	`PXT4_I
(
öode
)->
i_d©a_£m
);

1897 i‡(
	`pxt4_has_ölöe_d©a
(
öode
))

1898 
ªtvÆ
 = 0;

1899 i‡(
	`pxt4_ã°_öode_Êag
(
öode
, 
PXT4_INODE_EXTENTS
))

1900 
ªtvÆ
 = 
	`pxt4_ext_m≠_blocks
(
NULL
, 
öode
, 
m≠
, 0);

1902 
ªtvÆ
 = 
	`pxt4_öd_m≠_blocks
(
NULL
, 
öode
, 
m≠
, 0);

1904 
add_dñayed
:

1905 i‡(
ªtvÆ
 == 0) {

1906 
ªt
;

1913 
ªt
 = 
	`pxt4_ö£π_dñayed_block
(
öode
, 
m≠
->
m_lblk
);

1914 i‡(
ªt
 != 0) {

1915 
ªtvÆ
 = 
ªt
;

1916 
out_u∆ock
;

1919 
	`m≠_bh
(
bh
, 
öode
->
i_sb
, 
övÆid_block
);

1920 
	`£t_buf„r_√w
(
bh
);

1921 
	`£t_buf„r_dñay
(
bh
);

1922 } i‡(
ªtvÆ
 > 0) {

1923 
ªt
;

1924 
°©us
;

1926 i‡(
	`u∆ikñy
(
ªtvÆ
 !
m≠
->
m_Àn
)) {

1927 
	`pxt4_w¨nög
(
öode
->
i_sb
,

1930 
öode
->
i_öo
, 
ªtvÆ
, 
m≠
->
m_Àn
);

1931 
	`WARN_ON
(1);

1934 
°©us
 = 
m≠
->
m_Êags
 & 
PXT4_MAP_UNWRITTEN
 ?

1935 
EXTENT_STATUS_UNWRITTEN
 : 
EXTENT_STATUS_WRITTEN
;

1936 
ªt
 = 
	`pxt4_es_ö£π_exã¡
(
öode
, 
m≠
->
m_lblk
, m≠->
m_Àn
,

1937 
m≠
->
m_pblk
, 
°©us
);

1938 i‡(
ªt
 != 0)

1939 
ªtvÆ
 = 
ªt
;

1942 
out_u∆ock
:

1943 
	`up_ªad
((&
	`PXT4_I
(
öode
)->
i_d©a_£m
));

1945  
ªtvÆ
;

1946 
	}
}

1960 
	$pxt4_da_gë_block_¥ï
(
öode
 *öode, 
£˘‹_t
 
iblock
,

1961 
buf„r_hód
 *
bh
, 
¸óã
)

1963 
pxt4_m≠_blocks
 
m≠
;

1964 
ªt
 = 0;

1966 
	`BUG_ON
(
¸óã
 == 0);

1967 
	`BUG_ON
(
bh
->
b_size
 !
öode
->
i_sb
->
s_blocksize
);

1969 
m≠
.
m_lblk
 = 
iblock
;

1970 
m≠
.
m_Àn
 = 1;

1977 
ªt
 = 
	`pxt4_da_m≠_blocks
(
öode
, 
iblock
, &
m≠
, 
bh
);

1978 i‡(
ªt
 <= 0)

1979  
ªt
;

1981 
	`m≠_bh
(
bh
, 
öode
->
i_sb
, 
m≠
.
m_pblk
);

1982 
	`pxt4_upd©e_bh_°©e
(
bh
, 
m≠
.
m_Êags
);

1984 i‡(
	`buf„r_unwrôãn
(
bh
)) {

1991 
	`£t_buf„r_√w
(
bh
);

1992 
	`£t_buf„r_m≠≥d
(
bh
);

1995 
	}
}

1997 
	$bgë_⁄e
(
h™dÀ_t
 *
h™dÀ
, 
buf„r_hód
 *
bh
)

1999 
	`gë_bh
(
bh
);

2001 
	}
}

2003 
	$bput_⁄e
(
h™dÀ_t
 *
h™dÀ
, 
buf„r_hód
 *
bh
)

2005 
	`put_bh
(
bh
);

2007 
	}
}

2009 
	$__pxt4_jou∫ÆÀd_wrôïage
(
∑ge
 *page,

2010 
Àn
)

2012 
addªss_•a˚
 *
m≠pög
 = 
∑ge
->mapping;

2013 
öode
 *öodê
m≠pög
->
ho°
;

2014 
buf„r_hód
 *
∑ge_bufs
 = 
NULL
;

2015 
h™dÀ_t
 *
h™dÀ
 = 
NULL
;

2016 
ªt
 = 0, 
îr
 = 0;

2017 
ölöe_d©a
 = 
	`pxt4_has_ölöe_d©a
(
öode
);

2018 
buf„r_hód
 *
öode_bh
 = 
NULL
;

2020 
	`CÀ¨PageChecked
(
∑ge
);

2022 i‡(
ölöe_d©a
) {

2023 
	`BUG_ON
(
∑ge
->
ödex
 != 0);

2024 
	`BUG_ON
(
Àn
 > 
	`pxt4_gë_max_ölöe_size
(
öode
));

2025 
öode_bh
 = 
	`pxt4_jou∫ÆÀd_wrôe_ölöe_d©a
(
öode
, 
Àn
, 
∑ge
);

2026 i‡(
öode_bh
 =
NULL
)

2027 
out
;

2029 
∑ge_bufs
 = 
	`∑ge_buf„rs
(
∑ge
);

2030 i‡(!
∑ge_bufs
) {

2031 
	`BUG
();

2032 
out
;

2034 
	`pxt4_wÆk_∑ge_buf„rs
(
h™dÀ
, 
∑ge_bufs
, 0, 
Àn
,

2035 
NULL
, 
bgë_⁄e
);

2042 
	`gë_∑ge
(
∑ge
);

2043 
	`u∆ock_∑ge
(
∑ge
);

2045 
h™dÀ
 = 
	`pxt4_jou∫Æ_°¨t
(
öode
, 
PXT4_HT_WRITE_PAGE
,

2046 
	`pxt4_wrôïage_å™s_blocks
(
öode
));

2047 i‡(
	`IS_ERR
(
h™dÀ
)) {

2048 
ªt
 = 
	`PTR_ERR
(
h™dÀ
);

2049 
	`put_∑ge
(
∑ge
);

2050 
out_no_∑gñock
;

2052 
	`BUG_ON
(!
	`pxt4_h™dÀ_vÆid
(
h™dÀ
));

2054 
	`lock_∑ge
(
∑ge
);

2055 
	`put_∑ge
(
∑ge
);

2056 i‡(
∑ge
->
m≠pög
 != mapping) {

2058 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

2059 
ªt
 = 0;

2060 
out
;

2063 i‡(
ölöe_d©a
) {

2064 
ªt
 = 
	`pxt4_m¨k_öode_dúty
(
h™dÀ
, 
öode
);

2066 
ªt
 = 
	`pxt4_wÆk_∑ge_buf„rs
(
h™dÀ
, 
∑ge_bufs
, 0, 
Àn
, 
NULL
,

2067 
do_jou∫Æ_gë_wrôe_ac˚ss
);

2069 
îr
 = 
	`pxt4_wÆk_∑ge_buf„rs
(
h™dÀ
, 
∑ge_bufs
, 0, 
Àn
, 
NULL
,

2070 
wrôe_íd_‚
);

2072 i‡(
ªt
 == 0)

2073 
ªt
 = 
îr
;

2074 
	`PXT4_I
(
öode
)->
i_d©async_tid
 = 
h™dÀ
->
h_å™ß˘i⁄
->
t_tid
;

2075 
îr
 = 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

2076 i‡(!
ªt
)

2077 
ªt
 = 
îr
;

2079 
	`pxt4_£t_öode_°©e
(
öode
, 
PXT4_STATE_JDATA
);

2080 
out
:

2081 
	`u∆ock_∑ge
(
∑ge
);

2082 
out_no_∑gñock
:

2083 i‡(!
ölöe_d©a
 && 
∑ge_bufs
)

2084 
	`pxt4_wÆk_∑ge_buf„rs
(
NULL
, 
∑ge_bufs
, 0, 
Àn
,

2085 
NULL
, 
bput_⁄e
);

2086 
	`bªl£
(
öode_bh
);

2087  
ªt
;

2088 
	}
}

2131 
	$pxt4_wrôïage
(
∑ge
 *page,

2132 
wrôeback_c⁄åﬁ
 *
wbc
)

2134 
ªt
 = 0;

2135 
loff_t
 
size
;

2136 
Àn
;

2137 
buf„r_hód
 *
∑ge_bufs
 = 
NULL
;

2138 
öode
 *öodê
∑ge
->
m≠pög
->
ho°
;

2139 
pxt4_io_submô
 
io_submô
;

2140 
boﬁ
 
kìp_towrôe
 = 
Ál£
;

2142 i‡(
	`u∆ikñy
(
	`pxt4_f‹˚d_shutdown
(
	`PXT4_SB
(
öode
->
i_sb
)))) {

2143 
öode
->
i_m≠pög
->
a_›s
->
	`övÆid©ïage
(
∑ge
, 0, 
PAGE_SIZE
);

2144 
	`u∆ock_∑ge
(
∑ge
);

2145  -
EIO
;

2148 
	`åa˚_pxt4_wrôïage
(
∑ge
);

2149 
size
 = 
	`i_size_ªad
(
öode
);

2150 i‡(
∑ge
->
ödex
 =
size
 >> 
PAGE_SHIFT
 &&

2151 !
	`pxt4_vîôy_ö_¥ogªss
(
öode
))

2152 
Àn
 = 
size
 & ~
PAGE_MASK
;

2154 
Àn
 = 
PAGE_SIZE
;

2156 
∑ge_bufs
 = 
	`∑ge_buf„rs
(
∑ge
);

2174 i‡(
	`pxt4_wÆk_∑ge_buf„rs
(
NULL
, 
∑ge_bufs
, 0, 
Àn
, NULL,

2175 
pxt4_bh_dñay_‹_unwrôãn
)) {

2176 
	`ªdúty_∑ge_f‹_wrôïage
(
wbc
, 
∑ge
);

2177 i‡((
cuºít
->
Êags
 & 
PF_MEMALLOC
) ||

2178 (
öode
->
i_sb
->
s_blocksize
 =
PAGE_SIZE
)) {

2184 
	`WARN_ON_ONCE
((
cuºít
->
Êags
 & (
PF_MEMALLOC
|
PF_KSWAPD
))

2185 =
PF_MEMALLOC
);

2186 
	`u∆ock_∑ge
(
∑ge
);

2189 
kìp_towrôe
 = 
åue
;

2192 i‡(
	`PageChecked
(
∑ge
Ë&& 
	`pxt4_should_jou∫Æ_d©a
(
öode
))

2197  
	`__pxt4_jou∫ÆÀd_wrôïage
(
∑ge
, 
Àn
);

2199 
	`pxt4_io_submô_öô
(&
io_submô
, 
wbc
);

2200 
io_submô
.
io_íd
 = 
	`pxt4_öô_io_íd
(
öode
, 
GFP_NOFS
);

2201 i‡(!
io_submô
.
io_íd
) {

2202 
	`ªdúty_∑ge_f‹_wrôïage
(
wbc
, 
∑ge
);

2203 
	`u∆ock_∑ge
(
∑ge
);

2204  -
ENOMEM
;

2206 
ªt
 = 
	`pxt4_bio_wrôe_∑ge
(&
io_submô
, 
∑ge
, 
Àn
, 
wbc
, 
kìp_towrôe
);

2207 
	`pxt4_io_submô
(&
io_submô
);

2209 
	`pxt4_put_io_íd_de„r
(
io_submô
.
io_íd
);

2210  
ªt
;

2211 
	}
}

2213 
	$m∑ge_submô_∑ge
(
m∑ge_da_d©a
 *
mpd
, 
∑ge
 *page)

2215 
Àn
;

2216 
loff_t
 
size
;

2217 
îr
;

2219 
	`BUG_ON
(
∑ge
->
ödex
 !
mpd
->
fú°_∑ge
);

2220 
	`˛ór_∑ge_dúty_f‹_io
(
∑ge
);

2234 
size
 = 
	`i_size_ªad
(
mpd
->
öode
);

2235 i‡(
∑ge
->
ödex
 =
size
 >> 
PAGE_SHIFT
 &&

2236 !
	`pxt4_vîôy_ö_¥ogªss
(
mpd
->
öode
))

2237 
Àn
 = 
size
 & ~
PAGE_MASK
;

2239 
Àn
 = 
PAGE_SIZE
;

2240 
îr
 = 
	`pxt4_bio_wrôe_∑ge
(&
mpd
->
io_submô
, 
∑ge
, 
Àn
, mpd->
wbc
, 
Ál£
);

2241 i‡(!
îr
)

2242 
mpd
->
wbc
->
ƒ_to_wrôe
--;

2243 
mpd
->
fú°_∑ge
++;

2245  
îr
;

2246 
	}
}

2248 
	#BH_FLAGS
 ((1 << 
BH_Unwrôãn
Ë| (1 << 
BH_Dñay
))

	)

2255 
	#MAX_WRITEPAGES_EXTENT_LEN
 2048

	)

2271 
boﬁ
 
	$m∑ge_add_bh_to_exã¡
(
m∑ge_da_d©a
 *
mpd
, 
pxt4_lblk_t
 
lblk
,

2272 
buf„r_hód
 *
bh
)

2274 
pxt4_m≠_blocks
 *
m≠
 = &
mpd
->map;

2277 i‡(!
	`buf„r_dúty
(
bh
Ë|| !
	`buf„r_m≠≥d
(bh) ||

2278 (!
	`buf„r_dñay
(
bh
Ë&& !
	`buf„r_unwrôãn
(bh))) {

2280 i‡(
m≠
->
m_Àn
 == 0)

2281  
åue
;

2282  
Ál£
;

2286 i‡(
m≠
->
m_Àn
 == 0) {

2288 i‡(!
mpd
->
do_m≠
)

2289  
Ál£
;

2290 
m≠
->
m_lblk
 = 
lblk
;

2291 
m≠
->
m_Àn
 = 1;

2292 
m≠
->
m_Êags
 = 
bh
->
b_°©e
 & 
BH_FLAGS
;

2293  
åue
;

2297 i‡(
m≠
->
m_Àn
 >
MAX_WRITEPAGES_EXTENT_LEN
)

2298  
Ál£
;

2301 i‡(
lblk
 =
m≠
->
m_lblk
 + m≠->
m_Àn
 &&

2302 (
bh
->
b_°©e
 & 
BH_FLAGS
Ë=
m≠
->
m_Êags
) {

2303 
m≠
->
m_Àn
++;

2304  
åue
;

2306  
Ál£
;

2307 
	}
}

2325 
	$m∑ge_¥o˚ss_∑ge_bufs
(
m∑ge_da_d©a
 *
mpd
,

2326 
buf„r_hód
 *
hód
,

2327 
buf„r_hód
 *
bh
,

2328 
pxt4_lblk_t
 
lblk
)

2330 
öode
 *öodê
mpd
->inode;

2331 
îr
;

2332 
pxt4_lblk_t
 
blocks
 = (
	`i_size_ªad
(
öode
Ë+ 
	`i_blocksize
(inode) - 1)

2333 >> 
öode
->
i_blkbôs
;

2335 i‡(
	`pxt4_vîôy_ö_¥ogªss
(
öode
))

2336 
blocks
 = 
EXT_MAX_BLOCKS
;

2339 
	`BUG_ON
(
	`buf„r_locked
(
bh
));

2341 i‡(
lblk
 >
blocks
 || !
	`m∑ge_add_bh_to_exã¡
(
mpd
,Üblk, 
bh
)) {

2343 i‡(
mpd
->
m≠
.
m_Àn
)

2346 i‡(!
mpd
->
do_m≠
)

2351 } 
lblk
++, (
bh
 = bh->
b_this_∑ge
Ë!
hód
);

2353 i‡(
mpd
->
m≠
.
m_Àn
 == 0) {

2354 
îr
 = 
	`m∑ge_submô_∑ge
(
mpd
, 
hód
->
b_∑ge
);

2355 i‡(
îr
 < 0)

2356  
îr
;

2358  
lblk
 < 
blocks
;

2359 
	}
}

2375 
	$m∑ge_m≠_™d_submô_buf„rs
(
m∑ge_da_d©a
 *
mpd
)

2377 
∑gevec
 
pvec
;

2378 
ƒ_∑ges
, 
i
;

2379 
öode
 *öodê
mpd
->inode;

2380 
buf„r_hód
 *
hód
, *
bh
;

2381 
bµ_bôs
 = 
PAGE_SHIFT
 - 
öode
->
i_blkbôs
;

2382 
pgoff_t
 
°¨t
, 
íd
;

2383 
pxt4_lblk_t
 
lblk
;

2384 
£˘‹_t
 
pblock
;

2385 
îr
;

2387 
°¨t
 = 
mpd
->
m≠
.
m_lblk
 >> 
bµ_bôs
;

2388 
íd
 = (
mpd
->
m≠
.
m_lblk
 + mpd->m≠.
m_Àn
 - 1Ë>> 
bµ_bôs
;

2389 
lblk
 = 
°¨t
 << 
bµ_bôs
;

2390 
pblock
 = 
mpd
->
m≠
.
m_pblk
;

2392 
	`∑gevec_öô
(&
pvec
);

2393 
°¨t
 <
íd
) {

2394 
ƒ_∑ges
 = 
	`∑gevec_lookup_ønge
(&
pvec
, 
öode
->
i_m≠pög
,

2395 &
°¨t
, 
íd
);

2396 i‡(
ƒ_∑ges
 == 0)

2398 
i
 = 0; i < 
ƒ_∑ges
; i++) {

2399 
∑ge
 *∑gê
pvec
.
∑ges
[
i
];

2401 
bh
 = 
hód
 = 
	`∑ge_buf„rs
(
∑ge
);

2403 i‡(
lblk
 < 
mpd
->
m≠
.
m_lblk
)

2405 i‡(
lblk
 >
mpd
->
m≠
.
m_lblk
 + mpd->m≠.
m_Àn
) {

2410 
mpd
->
m≠
.
m_Àn
 = 0;

2411 
mpd
->
m≠
.
m_Êags
 = 0;

2419 
îr
 = 
	`m∑ge_¥o˚ss_∑ge_bufs
(
mpd
, 
hód
,

2420 
bh
, 
lblk
);

2421 
	`∑gevec_ªÀa£
(&
pvec
);

2422 i‡(
îr
 > 0)

2423 
îr
 = 0;

2424  
îr
;

2426 i‡(
	`buf„r_dñay
(
bh
)) {

2427 
	`˛ór_buf„r_dñay
(
bh
);

2428 
bh
->
b_blockƒ
 = 
pblock
++;

2430 
	`˛ór_buf„r_unwrôãn
(
bh
);

2431 } 
lblk
++, (
bh
 = bh->
b_this_∑ge
Ë!
hód
);

2438 
mpd
->
io_submô
.
io_íd
->
size
 +
PAGE_SIZE
;

2440 
îr
 = 
	`m∑ge_submô_∑ge
(
mpd
, 
∑ge
);

2441 i‡(
îr
 < 0) {

2442 
	`∑gevec_ªÀa£
(&
pvec
);

2443  
îr
;

2446 
	`∑gevec_ªÀa£
(&
pvec
);

2449 
mpd
->
m≠
.
m_Àn
 = 0;

2450 
mpd
->
m≠
.
m_Êags
 = 0;

2452 
	}
}

2454 
	$m∑ge_m≠_⁄e_exã¡
(
h™dÀ_t
 *
h™dÀ
, 
m∑ge_da_d©a
 *
mpd
)

2456 
öode
 *öodê
mpd
->inode;

2457 
pxt4_m≠_blocks
 *
m≠
 = &
mpd
->map;

2458 
gë_blocks_Êags
;

2459 
îr
, 
di‹ód_nﬁock
;

2461 
	`åa˚_pxt4_da_wrôe_∑ges_exã¡
(
öode
, 
m≠
);

2477 
gë_blocks_Êags
 = 
PXT4_GET_BLOCKS_CREATE
 |

2478 
PXT4_GET_BLOCKS_METADATA_NOFAIL
 |

2479 
PXT4_GET_BLOCKS_IO_SUBMIT
;

2480 
di‹ód_nﬁock
 = 
	`pxt4_should_di‹ód_nﬁock
(
öode
);

2481 i‡(
di‹ód_nﬁock
)

2482 
gë_blocks_Êags
 |
PXT4_GET_BLOCKS_IO_CREATE_EXT
;

2483 i‡(
m≠
->
m_Êags
 & (1 << 
BH_Dñay
))

2484 
gë_blocks_Êags
 |
PXT4_GET_BLOCKS_DELALLOC_RESERVE
;

2486 
îr
 = 
	`pxt4_m≠_blocks
(
h™dÀ
, 
öode
, 
m≠
, 
gë_blocks_Êags
);

2487 i‡(
îr
 < 0)

2488  
îr
;

2489 i‡(
di‹ód_nﬁock
 && (
m≠
->
m_Êags
 & 
PXT4_MAP_UNWRITTEN
)) {

2490 i‡(!
mpd
->
io_submô
.
io_íd
->
h™dÀ
 &&

2491 
	`pxt4_h™dÀ_vÆid
(
h™dÀ
)) {

2492 
mpd
->
io_submô
.
io_íd
->
h™dÀ
 = h™dÀ->
h_rsv_h™dÀ
;

2493 
h™dÀ
->
h_rsv_h™dÀ
 = 
NULL
;

2495 
	`pxt4_£t_io_unwrôãn_Êag
(
öode
, 
mpd
->
io_submô
.
io_íd
);

2498 
	`BUG_ON
(
m≠
->
m_Àn
 == 0);

2500 
	}
}

2522 
	$m∑ge_m≠_™d_submô_exã¡
(
h™dÀ_t
 *
h™dÀ
,

2523 
m∑ge_da_d©a
 *
mpd
,

2524 
boﬁ
 *
give_up_⁄_wrôe
)

2526 
öode
 *öodê
mpd
->inode;

2527 
pxt4_m≠_blocks
 *
m≠
 = &
mpd
->map;

2528 
îr
;

2529 
loff_t
 
disksize
;

2530 
¥ogªss
 = 0;

2532 
mpd
->
io_submô
.
io_íd
->
off£t
 =

2533 ((
loff_t
)
m≠
->
m_lblk
Ë<< 
öode
->
i_blkbôs
;

2535 
îr
 = 
	`m∑ge_m≠_⁄e_exã¡
(
h™dÀ
, 
mpd
);

2536 i‡(
îr
 < 0) {

2537 
su≥r_block
 *
sb
 = 
öode
->
i_sb
;

2539 i‡(
	`pxt4_f‹˚d_shutdown
(
	`PXT4_SB
(
sb
)) ||

2540 
	`PXT4_SB
(
sb
)->
s_mou¡_Êags
 & 
PXT4_MF_FS_ABORTED
)

2541 
övÆid©e_dúty_∑ges
;

2547 i‡((
îr
 =-
ENOMEM
) ||

2548 (
îr
 =-
ENOSPC
 && 
	`pxt4_cou¡_‰ì_˛u°îs
(
sb
))) {

2549 i‡(
¥ogªss
)

2550 
upd©e_disksize
;

2551  
îr
;

2553 
	`pxt4_msg
(
sb
, 
KERN_CRIT
,

2557 
öode
->
i_öo
,

2558 ()
m≠
->
m_lblk
,

2559 ()
m≠
->
m_Àn
, -
îr
);

2560 
	`pxt4_msg
(
sb
, 
KERN_CRIT
,

2563 i‡(
îr
 =-
ENOSPC
)

2564 
	`pxt4_¥öt_‰ì_blocks
(
öode
);

2565 
övÆid©e_dúty_∑ges
:

2566 *
give_up_⁄_wrôe
 = 
åue
;

2567  
îr
;

2569 
¥ogªss
 = 1;

2574 
îr
 = 
	`m∑ge_m≠_™d_submô_buf„rs
(
mpd
);

2575 i‡(
îr
 < 0)

2576 
upd©e_disksize
;

2577 } 
m≠
->
m_Àn
);

2579 
upd©e_disksize
:

2584 
disksize
 = ((
loff_t
)
mpd
->
fú°_∑ge
Ë<< 
PAGE_SHIFT
;

2585 i‡(
disksize
 > 
	`READ_ONCE
(
	`PXT4_I
(
öode
)->
i_disksize
)) {

2586 
îr2
;

2587 
loff_t
 
i_size
;

2589 
	`down_wrôe
(&
	`PXT4_I
(
öode
)->
i_d©a_£m
);

2590 
i_size
 = 
	`i_size_ªad
(
öode
);

2591 i‡(
disksize
 > 
i_size
)

2592 
disksize
 = 
i_size
;

2593 i‡(
disksize
 > 
	`PXT4_I
(
öode
)->
i_disksize
)

2594 
	`PXT4_I
(
öode
)->
i_disksize
 = 
disksize
;

2595 
	`up_wrôe
(&
	`PXT4_I
(
öode
)->
i_d©a_£m
);

2596 
îr2
 = 
	`pxt4_m¨k_öode_dúty
(
h™dÀ
, 
öode
);

2597 i‡(
îr2
)

2598 
	`pxt4_îr‹
(
öode
->
i_sb
,

2600 
öode
->
i_öo
);

2601 i‡(!
îr
)

2602 
îr
 = 
îr2
;

2604  
îr
;

2605 
	}
}

2614 
	$pxt4_da_wrôïages_å™s_blocks
(
öode
 *inode)

2616 
bµ
 = 
	`pxt4_jou∫Æ_blocks_≥r_∑ge
(
öode
);

2618  
	`pxt4_mëa_å™s_blocks
(
öode
,

2619 
MAX_WRITEPAGES_EXTENT_LEN
 + 
bµ
 - 1, bpp);

2620 
	}
}

2640 
	$m∑ge_¥ï¨e_exã¡_to_m≠
(
m∑ge_da_d©a
 *
mpd
)

2642 
addªss_•a˚
 *
m≠pög
 = 
mpd
->
öode
->
i_m≠pög
;

2643 
∑gevec
 
pvec
;

2644 
ƒ_∑ges
;

2645 
À·
 = 
mpd
->
wbc
->
ƒ_to_wrôe
;

2646 
pgoff_t
 
ödex
 = 
mpd
->
fú°_∑ge
;

2647 
pgoff_t
 
íd
 = 
mpd
->
œ°_∑ge
;

2648 
xa_m¨k_t
 
èg
;

2649 
i
, 
îr
 = 0;

2650 
blkbôs
 = 
mpd
->
öode
->
i_blkbôs
;

2651 
pxt4_lblk_t
 
lblk
;

2652 
buf„r_hód
 *
hód
;

2654 i‡(
mpd
->
wbc
->
sync_mode
 =
WB_SYNC_ALL
 || mpd->wbc->
ègged_wrôïages
)

2655 
èg
 = 
PAGECACHE_TAG_TOWRITE
;

2657 
èg
 = 
PAGECACHE_TAG_DIRTY
;

2659 
	`∑gevec_öô
(&
pvec
);

2660 
mpd
->
m≠
.
m_Àn
 = 0;

2661 
mpd
->
√xt_∑ge
 = 
ödex
;

2662 
ödex
 <
íd
) {

2663 
ƒ_∑ges
 = 
	`∑gevec_lookup_ønge_èg
(&
pvec
, 
m≠pög
, &
ödex
, 
íd
,

2664 
èg
);

2665 i‡(
ƒ_∑ges
 == 0)

2666 
out
;

2668 
i
 = 0; i < 
ƒ_∑ges
; i++) {

2669 
∑ge
 *∑gê
pvec
.
∑ges
[
i
];

2679 i‡(
mpd
->
wbc
->
sync_mode
 =
WB_SYNC_NONE
 && 
À·
 <= 0)

2680 
out
;

2683 i‡(
mpd
->
m≠
.
m_Àn
 > 0 && mpd->
√xt_∑ge
 !
∑ge
->
ödex
)

2684 
out
;

2686 
	`lock_∑ge
(
∑ge
);

2694 i‡(!
	`PageDúty
(
∑ge
) ||

2695 (
	`PageWrôeback
(
∑ge
) &&

2696 (
mpd
->
wbc
->
sync_mode
 =
WB_SYNC_NONE
)) ||

2697 
	`u∆ikñy
(
∑ge
->
m≠pög
 != mapping)) {

2698 
	`u∆ock_∑ge
(
∑ge
);

2702 
	`waô_⁄_∑ge_wrôeback
(
∑ge
);

2703 
	`BUG_ON
(
	`PageWrôeback
(
∑ge
));

2705 i‡(
mpd
->
m≠
.
m_Àn
 == 0)

2706 
mpd
->
fú°_∑ge
 = 
∑ge
->
ödex
;

2707 
mpd
->
√xt_∑ge
 = 
∑ge
->
ödex
 + 1;

2709 
lblk
 = ((
pxt4_lblk_t
)
∑ge
->
ödex
) <<

2710 (
PAGE_SHIFT
 - 
blkbôs
);

2711 
hód
 = 
	`∑ge_buf„rs
(
∑ge
);

2712 
îr
 = 
	`m∑ge_¥o˚ss_∑ge_bufs
(
mpd
, 
hód
, hód, 
lblk
);

2713 i‡(
îr
 <= 0)

2714 
out
;

2715 
îr
 = 0;

2716 
À·
--;

2718 
	`∑gevec_ªÀa£
(&
pvec
);

2719 
	`c⁄d_ªsched
();

2722 
out
:

2723 
	`∑gevec_ªÀa£
(&
pvec
);

2724  
îr
;

2725 
	}
}

2727 
	$pxt4_wrôïages
(
addªss_•a˚
 *
m≠pög
,

2728 
wrôeback_c⁄åﬁ
 *
wbc
)

2730 
pgoff_t
 
wrôeback_ödex
 = 0;

2731 
ƒ_to_wrôe
 = 
wbc
->nr_to_write;

2732 
ønge_whﬁe
 = 0;

2733 
cy˛ed
 = 1;

2734 
h™dÀ_t
 *
h™dÀ
 = 
NULL
;

2735 
m∑ge_da_d©a
 
mpd
;

2736 
öode
 *öodê
m≠pög
->
ho°
;

2737 
√eded_blocks
, 
rsv_blocks
 = 0, 
ªt
 = 0;

2738 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
m≠pög
->
ho°
->
i_sb
);

2739 
boﬁ
 
d⁄e
;

2740 
blk_∂ug
 
∂ug
;

2741 
boﬁ
 
give_up_⁄_wrôe
 = 
Ál£
;

2743 i‡(
	`u∆ikñy
(
	`pxt4_f‹˚d_shutdown
(
	`PXT4_SB
(
öode
->
i_sb
))))

2744  -
EIO
;

2746 
	`≥r˝u_down_ªad
(&
sbi
->
s_wrôïages_rw£m
);

2747 
	`åa˚_pxt4_wrôïages
(
öode
, 
wbc
);

2754 i‡(!
m≠pög
->
ƒ∑ges
 || !
	`m≠pög_ègged
(m≠pög, 
PAGECACHE_TAG_DIRTY
))

2755 
out_wrôïages
;

2757 i‡(
	`pxt4_should_jou∫Æ_d©a
(
öode
)) {

2758 
ªt
 = 
	`gíîic_wrôïages
(
m≠pög
, 
wbc
);

2759 
out_wrôïages
;

2772 i‡(
	`u∆ikñy
(
	`pxt4_f‹˚d_shutdown
(
	`PXT4_SB
(
m≠pög
->
ho°
->
i_sb
)) ||

2773 
sbi
->
s_mou¡_Êags
 & 
PXT4_MF_FS_ABORTED
)) {

2774 
ªt
 = -
EROFS
;

2775 
out_wrôïages
;

2783 i‡(
	`pxt4_has_ölöe_d©a
(
öode
)) {

2785 
h™dÀ
 = 
	`pxt4_jou∫Æ_°¨t
(
öode
, 
PXT4_HT_INODE
, 1);

2786 i‡(
	`IS_ERR
(
h™dÀ
)) {

2787 
ªt
 = 
	`PTR_ERR
(
h™dÀ
);

2788 
out_wrôïages
;

2790 
	`BUG_ON
(
	`pxt4_ã°_öode_°©e
(
öode
,

2791 
PXT4_STATE_MAY_INLINE_DATA
));

2792 
	`pxt4_de°roy_ölöe_d©a
(
h™dÀ
, 
öode
);

2793 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

2796 i‡(
	`pxt4_should_di‹ód_nﬁock
(
öode
)) {

2801 
rsv_blocks
 = 1 + 
	`pxt4_chunk_å™s_blocks
(
öode
,

2802 
PAGE_SIZE
 >> 
öode
->
i_blkbôs
);

2805 i‡(
wbc
->
ønge_°¨t
 =0 && wbc->
ønge_íd
 =
LLONG_MAX
)

2806 
ønge_whﬁe
 = 1;

2808 i‡(
wbc
->
ønge_cy˛ic
) {

2809 
wrôeback_ödex
 = 
m≠pög
->writeback_index;

2810 i‡(
wrôeback_ödex
)

2811 
cy˛ed
 = 0;

2812 
mpd
.
fú°_∑ge
 = 
wrôeback_ödex
;

2813 
mpd
.
œ°_∑ge
 = -1;

2815 
mpd
.
fú°_∑ge
 = 
wbc
->
ønge_°¨t
 >> 
PAGE_SHIFT
;

2816 
mpd
.
œ°_∑ge
 = 
wbc
->
ønge_íd
 >> 
PAGE_SHIFT
;

2819 
mpd
.
öode
 = inode;

2820 
mpd
.
wbc
 = wbc;

2821 
	`pxt4_io_submô_öô
(&
mpd
.
io_submô
, 
wbc
);

2822 
ªåy
:

2823 i‡(
wbc
->
sync_mode
 =
WB_SYNC_ALL
 || wbc->
ègged_wrôïages
)

2824 
	`èg_∑ges_f‹_wrôeback
(
m≠pög
, 
mpd
.
fú°_∑ge
, mpd.
œ°_∑ge
);

2825 
d⁄e
 = 
Ál£
;

2826 
	`blk_°¨t_∂ug
(&
∂ug
);

2834 
mpd
.
do_m≠
 = 0;

2835 
mpd
.
io_submô
.
io_íd
 = 
	`pxt4_öô_io_íd
(
öode
, 
GFP_KERNEL
);

2836 i‡(!
mpd
.
io_submô
.
io_íd
) {

2837 
ªt
 = -
ENOMEM
;

2838 
u≈lug
;

2840 
ªt
 = 
	`m∑ge_¥ï¨e_exã¡_to_m≠
(&
mpd
);

2842 
	`m∑ge_ªÀa£_unu£d_∑ges
(&
mpd
, 
Ál£
);

2844 
	`pxt4_io_submô
(&
mpd
.
io_submô
);

2845 
	`pxt4_put_io_íd_de„r
(
mpd
.
io_submô
.
io_íd
);

2846 
mpd
.
io_submô
.
io_íd
 = 
NULL
;

2847 i‡(
ªt
 < 0)

2848 
u≈lug
;

2850 !
d⁄e
 && 
mpd
.
fú°_∑ge
 <mpd.
œ°_∑ge
) {

2852 
mpd
.
io_submô
.
io_íd
 = 
	`pxt4_öô_io_íd
(
öode
, 
GFP_KERNEL
);

2853 i‡(!
mpd
.
io_submô
.
io_íd
) {

2854 
ªt
 = -
ENOMEM
;

2865 
	`BUG_ON
(
	`pxt4_should_jou∫Æ_d©a
(
öode
));

2866 
√eded_blocks
 = 
	`pxt4_da_wrôïages_å™s_blocks
(
öode
);

2869 
h™dÀ
 = 
	`pxt4_jou∫Æ_°¨t_wôh_ª£rve
(
öode
,

2870 
PXT4_HT_WRITE_PAGE
, 
√eded_blocks
, 
rsv_blocks
);

2871 i‡(
	`IS_ERR
(
h™dÀ
)) {

2872 
ªt
 = 
	`PTR_ERR
(
h™dÀ
);

2873 
	`pxt4_msg
(
öode
->
i_sb
, 
KERN_CRIT
, "%s: jbd3_start: "

2874 "%ldÖages, inÿ%lu;Éº %d", 
__func__
,

2875 
wbc
->
ƒ_to_wrôe
, 
öode
->
i_öo
, 
ªt
);

2877 
	`pxt4_put_io_íd
(
mpd
.
io_submô
.
io_íd
);

2878 
mpd
.
io_submô
.
io_íd
 = 
NULL
;

2881 
mpd
.
do_m≠
 = 1;

2883 
	`åa˚_pxt4_da_wrôe_∑ges
(
öode
, 
mpd
.
fú°_∑ge
, mpd.
wbc
);

2884 
ªt
 = 
	`m∑ge_¥ï¨e_exã¡_to_m≠
(&
mpd
);

2885 i‡(!
ªt
) {

2886 i‡(
mpd
.
m≠
.
m_Àn
)

2887 
ªt
 = 
	`m∑ge_m≠_™d_submô_exã¡
(
h™dÀ
, &
mpd
,

2888 &
give_up_⁄_wrôe
);

2896 
d⁄e
 = 
åue
;

2909 i‡(!
	`pxt4_h™dÀ_vÆid
(
h™dÀ
Ë|| h™dÀ->
h_sync
 == 0) {

2910 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

2911 
h™dÀ
 = 
NULL
;

2912 
mpd
.
do_m≠
 = 0;

2915 
	`m∑ge_ªÀa£_unu£d_∑ges
(&
mpd
, 
give_up_⁄_wrôe
);

2917 
	`pxt4_io_submô
(&
mpd
.
io_submô
);

2926 i‡(
h™dÀ
) {

2927 
	`pxt4_put_io_íd_de„r
(
mpd
.
io_submô
.
io_íd
);

2928 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

2930 
	`pxt4_put_io_íd
(
mpd
.
io_submô
.
io_íd
);

2931 
mpd
.
io_submô
.
io_íd
 = 
NULL
;

2933 i‡(
ªt
 =-
ENOSPC
 && 
sbi
->
s_jou∫Æ
) {

2939 
	`jbd3_jou∫Æ_f‹˚_commô_√°ed
(
sbi
->
s_jou∫Æ
);

2940 
ªt
 = 0;

2944 i‡(
ªt
)

2947 
u≈lug
:

2948 
	`blk_föish_∂ug
(&
∂ug
);

2949 i‡(!
ªt
 && !
cy˛ed
 && 
wbc
->
ƒ_to_wrôe
 > 0) {

2950 
cy˛ed
 = 1;

2951 
mpd
.
œ°_∑ge
 = 
wrôeback_ödex
 - 1;

2952 
mpd
.
fú°_∑ge
 = 0;

2953 
ªåy
;

2957 i‡(
wbc
->
ønge_cy˛ic
 || (
ønge_whﬁe
 && wbc->
ƒ_to_wrôe
 > 0))

2962 
m≠pög
->
wrôeback_ödex
 = 
mpd
.
fú°_∑ge
;

2964 
out_wrôïages
:

2965 
	`åa˚_pxt4_wrôïages_ªsu…
(
öode
, 
wbc
, 
ªt
,

2966 
ƒ_to_wrôe
 - 
wbc
->nr_to_write);

2967 
	`≥r˝u_up_ªad
(&
sbi
->
s_wrôïages_rw£m
);

2968  
ªt
;

2969 
	}
}

2971 
	$pxt4_dax_wrôïages
(
addªss_•a˚
 *
m≠pög
,

2972 
wrôeback_c⁄åﬁ
 *
wbc
)

2974 
ªt
;

2975 
ƒ_to_wrôe
 = 
wbc
->nr_to_write;

2976 
öode
 *öodê
m≠pög
->
ho°
;

2977 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
m≠pög
->
ho°
->
i_sb
);

2979 i‡(
	`u∆ikñy
(
	`pxt4_f‹˚d_shutdown
(
	`PXT4_SB
(
öode
->
i_sb
))))

2980  -
EIO
;

2982 
	`≥r˝u_down_ªad
(&
sbi
->
s_wrôïages_rw£m
);

2983 
	`åa˚_pxt4_wrôïages
(
öode
, 
wbc
);

2985 
ªt
 = 
	`dax_wrôeback_m≠pög_ønge
(
m≠pög
, 
öode
->
i_sb
->
s_bdev
, 
wbc
);

2986 
	`åa˚_pxt4_wrôïages_ªsu…
(
öode
, 
wbc
, 
ªt
,

2987 
ƒ_to_wrôe
 - 
wbc
->nr_to_write);

2988 
	`≥r˝u_up_ªad
(&
sbi
->
s_wrôïages_rw£m
);

2989  
ªt
;

2990 
	}
}

2992 
	$pxt4_n⁄da_swôch
(
su≥r_block
 *
sb
)

2994 
s64
 
‰ì_˛u°îs
, 
dúty_˛u°îs
;

2995 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
sb
);

3005 
‰ì_˛u°îs
 =

3006 
	`≥r˝u_cou¡î_ªad_posôive
(&
sbi
->
s_‰ì˛u°îs_cou¡î
);

3007 
dúty_˛u°îs
 =

3008 
	`≥r˝u_cou¡î_ªad_posôive
(&
sbi
->
s_dúty˛u°îs_cou¡î
);

3012 i‡(
dúty_˛u°îs
 && (
‰ì_˛u°îs
 < 2 * dirty_clusters))

3013 
	`åy_to_wrôeback_öodes_sb
(
sb
, 
WB_REASON_FS_FREE_SPACE
);

3015 i‡(2 * 
‰ì_˛u°îs
 < 3 * 
dúty_˛u°îs
 ||

3016 
‰ì_˛u°îs
 < (
dúty_˛u°îs
 + 
PXT4_FREECLUSTERS_WATERMARK
)) {

3024 
	}
}

3027 
	$pxt4_da_wrôe_¸edôs
(
öode
 *öode, 
loff_t
 
pos
, 
Àn
)

3029 i‡(
	`likñy
(
	`pxt4_has_„©uª_œrge_fûe
(
öode
->
i_sb
)))

3032 i‡(
pos
 + 
Àn
 <= 0x7fffffffULL)

3037 
	}
}

3039 
	$pxt4_da_wrôe_begö
(
fûe
 *fûe, 
addªss_•a˚
 *
m≠pög
,

3040 
loff_t
 
pos
, 
Àn
, 
Êags
,

3041 
∑ge
 **
∑gï
, **
fsd©a
)

3043 
ªt
, 
ªåõs
 = 0;

3044 
∑ge
 *page;

3045 
pgoff_t
 
ödex
;

3046 
öode
 *öodê
m≠pög
->
ho°
;

3047 
h™dÀ_t
 *
h™dÀ
;

3049 i‡(
	`u∆ikñy
(
	`pxt4_f‹˚d_shutdown
(
	`PXT4_SB
(
öode
->
i_sb
))))

3050  -
EIO
;

3052 
ödex
 = 
pos
 >> 
PAGE_SHIFT
;

3054 i‡(
	`pxt4_n⁄da_swôch
(
öode
->
i_sb
Ë|| 
	`S_ISLNK
(öode->
i_mode
) ||

3055 
	`pxt4_vîôy_ö_¥ogªss
(
öode
)) {

3056 *
fsd©a
 = (*)
FALL_BACK_TO_NONDELALLOC
;

3057  
	`pxt4_wrôe_begö
(
fûe
, 
m≠pög
, 
pos
,

3058 
Àn
, 
Êags
, 
∑gï
, 
fsd©a
);

3060 *
fsd©a
 = (*)0;

3061 
	`åa˚_pxt4_da_wrôe_begö
(
öode
, 
pos
, 
Àn
, 
Êags
);

3063 i‡(
	`pxt4_ã°_öode_°©e
(
öode
, 
PXT4_STATE_MAY_INLINE_DATA
)) {

3064 
ªt
 = 
	`pxt4_da_wrôe_ölöe_d©a_begö
(
m≠pög
, 
öode
,

3065 
pos
, 
Àn
, 
Êags
,

3066 
∑gï
, 
fsd©a
);

3067 i‡(
ªt
 < 0)

3068  
ªt
;

3069 i‡(
ªt
 == 1)

3080 
ªåy_gøb
:

3081 
∑ge
 = 
	`gøb_ˇche_∑ge_wrôe_begö
(
m≠pög
, 
ödex
, 
Êags
);

3082 i‡(!
∑ge
)

3083  -
ENOMEM
;

3084 
	`u∆ock_∑ge
(
∑ge
);

3092 
ªåy_jou∫Æ
:

3093 
h™dÀ
 = 
	`pxt4_jou∫Æ_°¨t
(
öode
, 
PXT4_HT_WRITE_PAGE
,

3094 
	`pxt4_da_wrôe_¸edôs
(
öode
, 
pos
, 
Àn
));

3095 i‡(
	`IS_ERR
(
h™dÀ
)) {

3096 
	`put_∑ge
(
∑ge
);

3097  
	`PTR_ERR
(
h™dÀ
);

3100 
	`lock_∑ge
(
∑ge
);

3101 i‡(
∑ge
->
m≠pög
 != mapping) {

3103 
	`u∆ock_∑ge
(
∑ge
);

3104 
	`put_∑ge
(
∑ge
);

3105 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

3106 
ªåy_gøb
;

3109 
	`waô_f‹_°abÀ_∑ge
(
∑ge
);

3111 #ifde‡
CONFIG_FS_ENCRYPTION


3112 
ªt
 = 
	`pxt4_block_wrôe_begö
(
∑ge
, 
pos
, 
Àn
,

3113 
pxt4_da_gë_block_¥ï
);

3115 
ªt
 = 
	`__block_wrôe_begö
(
∑ge
, 
pos
, 
Àn
, 
pxt4_da_gë_block_¥ï
);

3117 i‡(
ªt
 < 0) {

3118 
	`u∆ock_∑ge
(
∑ge
);

3119 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

3125 i‡(
pos
 + 
Àn
 > 
öode
->
i_size
)

3126 
	`pxt4_åunˇã_Áûed_wrôe
(
öode
);

3128 i‡(
ªt
 =-
ENOSPC
 &&

3129 
	`pxt4_should_ªåy_Æloc
(
öode
->
i_sb
, &
ªåõs
))

3130 
ªåy_jou∫Æ
;

3132 
	`put_∑ge
(
∑ge
);

3133  
ªt
;

3136 *
∑gï
 = 
∑ge
;

3137  
ªt
;

3138 
	}
}

3144 
	$pxt4_da_should_upd©e_i_disksize
(
∑ge
 *page,

3145 
off£t
)

3147 
buf„r_hód
 *
bh
;

3148 
öode
 *öodê
∑ge
->
m≠pög
->
ho°
;

3149 
idx
;

3150 
i
;

3152 
bh
 = 
	`∑ge_buf„rs
(
∑ge
);

3153 
idx
 = 
off£t
 >> 
öode
->
i_blkbôs
;

3155 
i
 = 0; i < 
idx
; i++)

3156 
bh
 = bh->
b_this_∑ge
;

3158 i‡(!
	`buf„r_m≠≥d
(
bh
Ë|| (
	`buf„r_dñay
(bh)Ë|| 
	`buf„r_unwrôãn
(bh))

3161 
	}
}

3163 
	$pxt4_da_wrôe_íd
(
fûe
 *file,

3164 
addªss_•a˚
 *
m≠pög
,

3165 
loff_t
 
pos
, 
Àn
, 
c›õd
,

3166 
∑ge
 *∑ge, *
fsd©a
)

3168 
öode
 *öodê
m≠pög
->
ho°
;

3169 
ªt
 = 0, 
ªt2
;

3170 
h™dÀ_t
 *
h™dÀ
 = 
	`pxt4_jou∫Æ_cuºít_h™dÀ
();

3171 
loff_t
 
√w_i_size
;

3172 
°¨t
, 
íd
;

3173 
wrôe_mode
 = ()()
fsd©a
;

3175 i‡(
wrôe_mode
 =
FALL_BACK_TO_NONDELALLOC
)

3176  
	`pxt4_wrôe_íd
(
fûe
, 
m≠pög
, 
pos
,

3177 
Àn
, 
c›õd
, 
∑ge
, 
fsd©a
);

3179 
	`åa˚_pxt4_da_wrôe_íd
(
öode
, 
pos
, 
Àn
, 
c›õd
);

3180 
°¨t
 = 
pos
 & (
PAGE_SIZE
 - 1);

3181 
íd
 = 
°¨t
 + 
c›õd
 - 1;

3188 
√w_i_size
 = 
pos
 + 
c›õd
;

3189 i‡(
c›õd
 && 
√w_i_size
 > 
	`PXT4_I
(
öode
)->
i_disksize
) {

3190 i‡(
	`pxt4_has_ölöe_d©a
(
öode
) ||

3191 
	`pxt4_da_should_upd©e_i_disksize
(
∑ge
, 
íd
)) {

3192 
	`pxt4_upd©e_i_disksize
(
öode
, 
√w_i_size
);

3197 
	`pxt4_m¨k_öode_dúty
(
h™dÀ
, 
öode
);

3201 i‡(
wrôe_mode
 !
CONVERT_INLINE_DATA
 &&

3202 
	`pxt4_ã°_öode_°©e
(
öode
, 
PXT4_STATE_MAY_INLINE_DATA
) &&

3203 
	`pxt4_has_ölöe_d©a
(
öode
))

3204 
ªt2
 = 
	`pxt4_da_wrôe_ölöe_d©a_íd
(
öode
, 
pos
, 
Àn
, 
c›õd
,

3205 
∑ge
);

3207 
ªt2
 = 
	`gíîic_wrôe_íd
(
fûe
, 
m≠pög
, 
pos
, 
Àn
, 
c›õd
,

3208 
∑ge
, 
fsd©a
);

3210 
c›õd
 = 
ªt2
;

3211 i‡(
ªt2
 < 0)

3212 
ªt
 = 
ªt2
;

3213 
ªt2
 = 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

3214 i‡(!
ªt
)

3215 
ªt
 = 
ªt2
;

3217  
ªt
 ?Ñë : 
c›õd
;

3218 
	}
}

3223 
	$pxt4_Æloc_da_blocks
(
öode
 *inode)

3225 
	`åa˚_pxt4_Æloc_da_blocks
(
öode
);

3227 i‡(!
	`PXT4_I
(
öode
)->
i_ª£rved_d©a_blocks
)

3261  
	`fûem≠_Êush
(
öode
->
i_m≠pög
);

3262 
	}
}

3278 
£˘‹_t
 
	$pxt4_bm≠
(
addªss_•a˚
 *
m≠pög
, 
£˘‹_t
 
block
)

3280 
öode
 *öodê
m≠pög
->
ho°
;

3281 
jou∫Æ_t
 *
jou∫Æ
;

3282 
îr
;

3287 i‡(
	`pxt4_has_ölöe_d©a
(
öode
))

3290 i‡(
	`m≠pög_ègged
(
m≠pög
, 
PAGECACHE_TAG_DIRTY
) &&

3291 
	`ã°_›t
(
öode
->
i_sb
, 
DELALLOC
)) {

3297 
	`fûem≠_wrôe_™d_waô
(
m≠pög
);

3300 i‡(
	`PXT4_JOURNAL
(
öode
) &&

3301 
	`pxt4_ã°_öode_°©e
(
öode
, 
PXT4_STATE_JDATA
)) {

3320 
	`pxt4_˛ór_öode_°©e
(
öode
, 
PXT4_STATE_JDATA
);

3321 
jou∫Æ
 = 
	`PXT4_JOURNAL
(
öode
);

3322 
	`jbd3_jou∫Æ_lock_upd©es
(
jou∫Æ
);

3323 
îr
 = 
	`jbd3_jou∫Æ_Êush
(
jou∫Æ
);

3324 
	`jbd3_jou∫Æ_u∆ock_upd©es
(
jou∫Æ
);

3326 i‡(
îr
)

3330  
	`gíîic_block_bm≠
(
m≠pög
, 
block
, 
pxt4_gë_block
);

3331 
	}
}

3333 
	$pxt4_ªad∑ge
(
fûe
 *fûe, 
∑ge
 *page)

3335 
ªt
 = -
EAGAIN
;

3336 
öode
 *öodê
∑ge
->
m≠pög
->
ho°
;

3338 
	`åa˚_pxt4_ªad∑ge
(
∑ge
);

3340 i‡(
	`pxt4_has_ölöe_d©a
(
öode
))

3341 
ªt
 = 
	`pxt4_ªad∑ge_ölöe
(
öode
, 
∑ge
);

3343 i‡(
ªt
 =-
EAGAIN
)

3344  
	`pxt4_m∑ge_ªad∑ges
(
∑ge
->
m≠pög
, 
NULL
,Öage, 1,

3345 
Ál£
);

3347  
ªt
;

3348 
	}
}

3351 
	$pxt4_ªad∑ges
(
fûe
 *fûe, 
addªss_•a˚
 *
m≠pög
,

3352 
li°_hód
 *
∑ges
, 
ƒ_∑ges
)

3354 
öode
 *öodê
m≠pög
->
ho°
;

3357 i‡(
	`pxt4_has_ölöe_d©a
(
öode
))

3360  
	`pxt4_m∑ge_ªad∑ges
(
m≠pög
, 
∑ges
, 
NULL
, 
ƒ_∑ges
, 
åue
);

3361 
	}
}

3363 
	$pxt4_övÆid©ïage
(
∑ge
 *∑ge, 
off£t
,

3364 
Àngth
)

3366 
	`åa˚_pxt4_övÆid©ïage
(
∑ge
, 
off£t
, 
Àngth
);

3369 
	`WARN_ON
(
	`∑ge_has_buf„rs
(
∑ge
Ë&& 
	`buf„r_jbd
(
	`∑ge_buf„rs
(page)));

3371 
	`block_övÆid©ïage
(
∑ge
, 
off£t
, 
Àngth
);

3372 
	}
}

3374 
	$__pxt4_jou∫ÆÀd_övÆid©ïage
(
∑ge
 *page,

3375 
off£t
,

3376 
Àngth
)

3378 
jou∫Æ_t
 *
jou∫Æ
 = 
	`PXT4_JOURNAL
(
∑ge
->
m≠pög
->
ho°
);

3380 
	`åa˚_pxt4_jou∫ÆÀd_övÆid©ïage
(
∑ge
, 
off£t
, 
Àngth
);

3385 i‡(
off£t
 =0 && 
Àngth
 =
PAGE_SIZE
)

3386 
	`CÀ¨PageChecked
(
∑ge
);

3388  
	`jbd3_jou∫Æ_övÆid©ïage
(
jou∫Æ
, 
∑ge
, 
off£t
, 
Àngth
);

3389 
	}
}

3392 
	$pxt4_jou∫ÆÀd_övÆid©ïage
(
∑ge
 *page,

3393 
off£t
,

3394 
Àngth
)

3396 
	`WARN_ON
(
	`__pxt4_jou∫ÆÀd_övÆid©ïage
(
∑ge
, 
off£t
, 
Àngth
) < 0);

3397 
	}
}

3399 
	$pxt4_ªÀa£∑ge
(
∑ge
 *∑ge, 
gÂ_t
 
waô
)

3401 
jou∫Æ_t
 *
jou∫Æ
 = 
	`PXT4_JOURNAL
(
∑ge
->
m≠pög
->
ho°
);

3403 
	`åa˚_pxt4_ªÀa£∑ge
(
∑ge
);

3406 i‡(
	`PageChecked
(
∑ge
))

3408 i‡(
jou∫Æ
)

3409  
	`jbd3_jou∫Æ_åy_to_‰ì_buf„rs
(
jou∫Æ
, 
∑ge
, 
waô
);

3411  
	`åy_to_‰ì_buf„rs
(
∑ge
);

3412 
	}
}

3414 
boﬁ
 
	$pxt4_öode_d©async_dúty
(
öode
 *inode)

3416 
jou∫Æ_t
 *
jou∫Æ
 = 
	`PXT4_SB
(
öode
->
i_sb
)->
s_jou∫Æ
;

3418 i‡(
jou∫Æ
)

3419  !
	`jbd3_å™ß˘i⁄_commôãd
(
jou∫Æ
,

3420 
	`PXT4_I
(
öode
)->
i_d©async_tid
);

3422 i‡(!
	`li°_em±y
(&
öode
->
i_m≠pög
->
¥iv©e_li°
))

3423  
åue
;

3424  
öode
->
i_°©e
 & 
I_DIRTY_DATASYNC
;

3425 
	}
}

3427 
	$pxt4_iom≠_begö
(
öode
 *öode, 
loff_t
 
off£t
,Üoff_à
Àngth
,

3428 
Êags
, 
iom≠
 *iomap)

3430 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
öode
->
i_sb
);

3431 
blkbôs
 = 
öode
->
i_blkbôs
;

3432 
fú°_block
, 
œ°_block
;

3433 
pxt4_m≠_blocks
 
m≠
;

3434 
boﬁ
 
dñÆloc
 = 
Ál£
;

3435 
ªt
;

3437 i‡((
off£t
 >> 
blkbôs
Ë> 
PXT4_MAX_LOGICAL_BLOCK
)

3438  -
EINVAL
;

3439 
fú°_block
 = 
off£t
 >> 
blkbôs
;

3440 
œ°_block
 = 
	`mö_t
(
loff_t
, (
off£t
 + 
Àngth
 - 1Ë>> 
blkbôs
,

3441 
PXT4_MAX_LOGICAL_BLOCK
);

3443 i‡(
Êags
 & 
IOMAP_REPORT
) {

3444 i‡(
	`pxt4_has_ölöe_d©a
(
öode
)) {

3445 
ªt
 = 
	`pxt4_ölöe_d©a_iom≠
(
öode
, 
iom≠
);

3446 i‡(
ªt
 !-
EAGAIN
) {

3447 i‡(
ªt
 =0 && 
off£t
 >
iom≠
->
Àngth
)

3448 
ªt
 = -
ENOENT
;

3449  
ªt
;

3453 i‡(
	`WARN_ON_ONCE
(
	`pxt4_has_ölöe_d©a
(
öode
)))

3454  -
ERANGE
;

3457 
m≠
.
m_lblk
 = 
fú°_block
;

3458 
m≠
.
m_Àn
 = 
œ°_block
 - 
fú°_block
 + 1;

3460 i‡(
Êags
 & 
IOMAP_REPORT
) {

3461 
ªt
 = 
	`pxt4_m≠_blocks
(
NULL
, 
öode
, &
m≠
, 0);

3462 i‡(
ªt
 < 0)

3463  
ªt
;

3465 i‡(
ªt
 == 0) {

3466 
pxt4_lblk_t
 
íd
 = 
m≠
.
m_lblk
 + m≠.
m_Àn
 - 1;

3467 
exã¡_°©us
 
es
;

3469 
	`pxt4_es_föd_exã¡_ønge
(
öode
, &
pxt4_es_is_dñayed
,

3470 
m≠
.
m_lblk
, 
íd
, &
es
);

3472 i‡(!
es
.
es_Àn
 ||És.
es_lblk
 > 
íd
) {

3474 } i‡(
es
.
es_lblk
 > 
m≠
.
m_lblk
) {

3476 
m≠
.
m_Àn
 = 
es
.
es_lblk
 - m≠.
m_lblk
;

3478 
pxt4_lblk_t
 
offs
 = 0;

3480 i‡(
es
.
es_lblk
 < 
m≠
.
m_lblk
)

3481 
offs
 = 
m≠
.
m_lblk
 - 
es
.
es_lblk
;

3482 
m≠
.
m_lblk
 = 
es
.
es_lblk
 + 
offs
;

3483 
m≠
.
m_Àn
 = 
es
.
es_Àn
 - 
offs
;

3484 
dñÆloc
 = 
åue
;

3487 } i‡(
Êags
 & 
IOMAP_WRITE
) {

3488 
dio_¸edôs
;

3489 
h™dÀ_t
 *
h™dÀ
;

3490 
ªåõs
 = 0;

3493 i‡(
m≠
.
m_Àn
 > 
DIO_MAX_BLOCKS
)

3494 
m≠
.
m_Àn
 = 
DIO_MAX_BLOCKS
;

3495 
dio_¸edôs
 = 
	`pxt4_chunk_å™s_blocks
(
öode
, 
m≠
.
m_Àn
);

3496 
ªåy
:

3503 
h™dÀ
 = 
	`pxt4_jou∫Æ_°¨t
(
öode
, 
PXT4_HT_MAP_BLOCKS
,

3504 
dio_¸edôs
);

3505 i‡(
	`IS_ERR
(
h™dÀ
))

3506  
	`PTR_ERR
(
h™dÀ
);

3508 
ªt
 = 
	`pxt4_m≠_blocks
(
h™dÀ
, 
öode
, &
m≠
,

3509 
PXT4_GET_BLOCKS_CREATE_ZERO
);

3510 i‡(
ªt
 < 0) {

3511 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

3512 i‡(
ªt
 =-
ENOSPC
 &&

3513 
	`pxt4_should_ªåy_Æloc
(
öode
->
i_sb
, &
ªåõs
))

3514 
ªåy
;

3515  
ªt
;

3527 i‡(!(
Êags
 & 
IOMAP_FAULT
Ë&& 
fú°_block
 + 
m≠
.
m_Àn
 >

3528 (
	`i_size_ªad
(
öode
Ë+ (1 << 
blkbôs
) - 1) >> blkbits) {

3529 
îr
;

3531 
îr
 = 
	`pxt4_‹ph™_add
(
h™dÀ
, 
öode
);

3532 i‡(
îr
 < 0) {

3533 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

3534  
îr
;

3537 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

3539 
ªt
 = 
	`pxt4_m≠_blocks
(
NULL
, 
öode
, &
m≠
, 0);

3540 i‡(
ªt
 < 0)

3541  
ªt
;

3549 
iom≠
->
Êags
 = 0;

3550 i‡(
	`pxt4_öode_d©async_dúty
(
öode
) ||

3551 
off£t
 + 
Àngth
 > 
	`i_size_ªad
(
öode
))

3552 
iom≠
->
Êags
 |
IOMAP_F_DIRTY
;

3553 
iom≠
->
bdev
 = 
öode
->
i_sb
->
s_bdev
;

3554 
iom≠
->
dax_dev
 = 
sbi
->
s_daxdev
;

3555 
iom≠
->
off£t
 = (
u64
)
fú°_block
 << 
blkbôs
;

3556 
iom≠
->
Àngth
 = (
u64
)
m≠
.
m_Àn
 << 
blkbôs
;

3558 i‡(
ªt
 == 0) {

3559 
iom≠
->
ty≥
 = 
dñÆloc
 ? 
IOMAP_DELALLOC
 : 
IOMAP_HOLE
;

3560 
iom≠
->
addr
 = 
IOMAP_NULL_ADDR
;

3562 i‡(
m≠
.
m_Êags
 & 
PXT4_MAP_MAPPED
) {

3563 
iom≠
->
ty≥
 = 
IOMAP_MAPPED
;

3564 } i‡(
m≠
.
m_Êags
 & 
PXT4_MAP_UNWRITTEN
) {

3565 
iom≠
->
ty≥
 = 
IOMAP_UNWRITTEN
;

3567 
	`WARN_ON_ONCE
(1);

3568  -
EIO
;

3570 
iom≠
->
addr
 = (
u64
)
m≠
.
m_pblk
 << 
blkbôs
;

3573 i‡(
m≠
.
m_Êags
 & 
PXT4_MAP_NEW
)

3574 
iom≠
->
Êags
 |
IOMAP_F_NEW
;

3577 
	}
}

3579 
	$pxt4_iom≠_íd
(
öode
 *öode, 
loff_t
 
off£t
,Üoff_à
Àngth
,

3580 
ssize_t
 
wrôãn
, 
Êags
, 
iom≠
 *iomap)

3582 
ªt
 = 0;

3583 
h™dÀ_t
 *
h™dÀ
;

3584 
blkbôs
 = 
öode
->
i_blkbôs
;

3585 
boﬁ
 
åunˇã
 = 
Ál£
;

3587 i‡(!(
Êags
 & 
IOMAP_WRITE
Ë|| (Êag†& 
IOMAP_FAULT
))

3590 
h™dÀ
 = 
	`pxt4_jou∫Æ_°¨t
(
öode
, 
PXT4_HT_INODE
, 2);

3591 i‡(
	`IS_ERR
(
h™dÀ
)) {

3592 
ªt
 = 
	`PTR_ERR
(
h™dÀ
);

3593 
‹ph™_dñ
;

3595 i‡(
	`pxt4_upd©e_öode_size
(
öode
, 
off£t
 + 
wrôãn
))

3596 
	`pxt4_m¨k_öode_dúty
(
h™dÀ
, 
öode
);

3600 i‡(
iom≠
->
off£t
 + iom≠->
Àngth
 >

3601 
	`ALIGN
(
öode
->
i_size
, 1 << 
blkbôs
)) {

3602 
pxt4_lblk_t
 
wrôãn_blk
, 
íd_blk
;

3604 
wrôãn_blk
 = (
off£t
 + 
wrôãn
Ë>> 
blkbôs
;

3605 
íd_blk
 = (
off£t
 + 
Àngth
Ë>> 
blkbôs
;

3606 i‡(
wrôãn_blk
 < 
íd_blk
 && 
	`pxt4_ˇn_åunˇã
(
öode
))

3607 
åunˇã
 = 
åue
;

3613 i‡(!
åunˇã
 && 
öode
->
i_∆ök
 &&

3614 !
	`li°_em±y
(&
	`PXT4_I
(
öode
)->
i_‹ph™
))

3615 
	`pxt4_‹ph™_dñ
(
h™dÀ
, 
öode
);

3616 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

3617 i‡(
åunˇã
) {

3618 
	`pxt4_åunˇã_Áûed_wrôe
(
öode
);

3619 
‹ph™_dñ
:

3625 i‡(
öode
->
i_∆ök
)

3626 
	`pxt4_‹ph™_dñ
(
NULL
, 
öode
);

3628  
ªt
;

3629 
	}
}

3631 c⁄° 
iom≠_›s
 
	gpxt4_iom≠_›s
 = {

3632 .
iom≠_begö
 = 
pxt4_iom≠_begö
,

3633 .
	giom≠_íd
 = 
pxt4_iom≠_íd
,

3636 
	$pxt4_íd_io_dio
(
kiocb
 *
iocb
, 
loff_t
 
off£t
,

3637 
ssize_t
 
size
, *
¥iv©e
)

3639 
pxt4_io_íd_t
 *
io_íd
 = 
¥iv©e
;

3642 i‡(!
io_íd
)

3645 
	`ext_debug
("pxt4_end_io_dio(): io_end 0x%p "

3647 
io_íd
, io_íd->
öode
->
i_öo
, 
iocb
, 
off£t
, 
size
);

3653 i‡(
size
 <= 0) {

3654 
	`pxt4_˛ór_io_unwrôãn_Êag
(
io_íd
);

3655 
size
 = 0;

3657 
io_íd
->
off£t
 = offset;

3658 
io_íd
->
size
 = size;

3659 
	`pxt4_put_io_íd
(
io_íd
);

3662 
	}
}

3685 
ssize_t
 
	$pxt4_dúe˘_IO_wrôe
(
kiocb
 *
iocb
, 
iov_ôî
 *
ôî
)

3687 
fûe
 *fûê
iocb
->
ki_fûp
;

3688 
öode
 *öodê
fûe
->
f_m≠pög
->
ho°
;

3689 
pxt4_öode_öfo
 *
ei
 = 
	`PXT4_I
(
öode
);

3690 
ssize_t
 
ªt
;

3691 
loff_t
 
off£t
 = 
iocb
->
ki_pos
;

3692 
size_t
 
cou¡
 = 
	`iov_ôî_cou¡
(
ôî
);

3693 
ovîwrôe
 = 0;

3694 
gë_block_t
 *
gë_block_func
 = 
NULL
;

3695 
dio_Êags
 = 0;

3696 
loff_t
 
föÆ_size
 = 
off£t
 + 
cou¡
;

3697 
‹ph™
 = 0;

3698 
h™dÀ_t
 *
h™dÀ
;

3700 i‡(
föÆ_size
 > 
öode
->
i_size
 || föÆ_sizê> 
ei
->
i_disksize
) {

3702 
h™dÀ
 = 
	`pxt4_jou∫Æ_°¨t
(
öode
, 
PXT4_HT_INODE
, 2);

3703 i‡(
	`IS_ERR
(
h™dÀ
)) {

3704 
ªt
 = 
	`PTR_ERR
(
h™dÀ
);

3705 
out
;

3707 
ªt
 = 
	`pxt4_‹ph™_add
(
h™dÀ
, 
öode
);

3708 i‡(
ªt
) {

3709 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

3710 
out
;

3712 
‹ph™
 = 1;

3713 
	`pxt4_upd©e_i_disksize
(
öode
, inode->
i_size
);

3714 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

3717 
	`BUG_ON
(
iocb
->
¥iv©e
 =
NULL
);

3724 
	`öode_dio_begö
(
öode
);

3727 
ovîwrôe
 = *((*)
iocb
->
¥iv©e
);

3729 i‡(
ovîwrôe
)

3730 
	`öode_u∆ock
(
öode
);

3752 
iocb
->
¥iv©e
 = 
NULL
;

3753 i‡(
ovîwrôe
)

3754 
gë_block_func
 = 
pxt4_dio_gë_block_ovîwrôe
;

3755 i‡(!
	`pxt4_ã°_öode_Êag
(
öode
, 
PXT4_INODE_EXTENTS
) ||

3756 
	`round_down
(
off£t
, 
	`i_blocksize
(
öode
)Ë>öode->
i_size
) {

3757 
gë_block_func
 = 
pxt4_dio_gë_block
;

3758 
dio_Êags
 = 
DIO_LOCKING
 | 
DIO_SKIP_HOLES
;

3759 } i‡(
	`is_sync_kiocb
(
iocb
)) {

3760 
gë_block_func
 = 
pxt4_dio_gë_block_unwrôãn_sync
;

3761 
dio_Êags
 = 
DIO_LOCKING
;

3763 
gë_block_func
 = 
pxt4_dio_gë_block_unwrôãn_async
;

3764 
dio_Êags
 = 
DIO_LOCKING
;

3766 
ªt
 = 
	`__blockdev_dúe˘_IO
(
iocb
, 
öode
, inode->
i_sb
->
s_bdev
, 
ôî
,

3767 
gë_block_func
, 
pxt4_íd_io_dio
, 
NULL
,

3768 
dio_Êags
);

3770 i‡(
ªt
 > 0 && !
ovîwrôe
 && 
	`pxt4_ã°_öode_°©e
(
öode
,

3771 
PXT4_STATE_DIO_UNWRITTEN
)) {

3772 
îr
;

3777 
îr
 = 
	`pxt4_c⁄vît_unwrôãn_exã¡s
(
NULL
, 
öode
,

3778 
off£t
, 
ªt
);

3779 i‡(
îr
 < 0)

3780 
ªt
 = 
îr
;

3781 
	`pxt4_˛ór_öode_°©e
(
öode
, 
PXT4_STATE_DIO_UNWRITTEN
);

3784 
	`öode_dio_íd
(
öode
);

3786 i‡(
ovîwrôe
)

3787 
	`öode_lock
(
öode
);

3789 i‡(
ªt
 < 0 && 
föÆ_size
 > 
öode
->
i_size
)

3790 
	`pxt4_åunˇã_Áûed_wrôe
(
öode
);

3793 i‡(
‹ph™
) {

3794 
îr
;

3797 
h™dÀ
 = 
	`pxt4_jou∫Æ_°¨t
(
öode
, 
PXT4_HT_INODE
, 2);

3798 i‡(
	`IS_ERR
(
h™dÀ
)) {

3809 i‡(!
ªt
)

3810 
ªt
 = 
	`PTR_ERR
(
h™dÀ
);

3811 i‡(
öode
->
i_∆ök
)

3812 
	`pxt4_‹ph™_dñ
(
NULL
, 
öode
);

3814 
out
;

3816 i‡(
öode
->
i_∆ök
)

3817 
	`pxt4_‹ph™_dñ
(
h™dÀ
, 
öode
);

3818 i‡(
ªt
 > 0) {

3819 
loff_t
 
íd
 = 
off£t
 + 
ªt
;

3820 i‡(
íd
 > 
öode
->
i_size
 ||Énd > 
ei
->
i_disksize
) {

3821 
	`pxt4_upd©e_i_disksize
(
öode
, 
íd
);

3822 i‡(
íd
 > 
öode
->
i_size
)

3823 
	`i_size_wrôe
(
öode
, 
íd
);

3831 
	`pxt4_m¨k_öode_dúty
(
h™dÀ
, 
öode
);

3834 
îr
 = 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

3835 i‡(
ªt
 == 0)

3836 
ªt
 = 
îr
;

3838 
out
:

3839  
ªt
;

3840 
	}
}

3842 
ssize_t
 
	$pxt4_dúe˘_IO_ªad
(
kiocb
 *
iocb
, 
iov_ôî
 *
ôî
)

3844 
addªss_•a˚
 *
m≠pög
 = 
iocb
->
ki_fûp
->
f_m≠pög
;

3845 
öode
 *öodê
m≠pög
->
ho°
;

3846 
size_t
 
cou¡
 = 
	`iov_ôî_cou¡
(
ôî
);

3847 
ssize_t
 
ªt
;

3848 
loff_t
 
off£t
 = 
iocb
->
ki_pos
;

3849 
loff_t
 
size
 = 
	`i_size_ªad
(
öode
);

3851 i‡(
off£t
 >
size
)

3859 i‡(
iocb
->
ki_Êags
 & 
IOCB_NOWAIT
) {

3860 i‡(!
	`öode_åylock_sh¨ed
(
öode
))

3861  -
EAGAIN
;

3863 
	`öode_lock_sh¨ed
(
öode
);

3866 
ªt
 = 
	`fûem≠_wrôe_™d_waô_ønge
(
m≠pög
, 
iocb
->
ki_pos
,

3867 
iocb
->
ki_pos
 + 
cou¡
 - 1);

3868 i‡(
ªt
)

3869 
out_u∆ock
;

3870 
ªt
 = 
	`__blockdev_dúe˘_IO
(
iocb
, 
öode
, inode->
i_sb
->
s_bdev
,

3871 
ôî
, 
pxt4_dio_gë_block
, 
NULL
, NULL, 0);

3872 
out_u∆ock
:

3873 
	`öode_u∆ock_sh¨ed
(
öode
);

3874  
ªt
;

3875 
	}
}

3877 
ssize_t
 
	$pxt4_dúe˘_IO
(
kiocb
 *
iocb
, 
iov_ôî
 *
ôî
)

3879 
fûe
 *fûê
iocb
->
ki_fûp
;

3880 
öode
 *öodê
fûe
->
f_m≠pög
->
ho°
;

3881 
size_t
 
cou¡
 = 
	`iov_ôî_cou¡
(
ôî
);

3882 
loff_t
 
off£t
 = 
iocb
->
ki_pos
;

3883 
ssize_t
 
ªt
;

3885 #ifde‡
CONFIG_FS_ENCRYPTION


3886 i‡(
	`IS_ENCRYPTED
(
öode
Ë&& 
	`S_ISREG
(öode->
i_mode
))

3889 i‡(
	`fsvîôy_a˘ive
(
öode
))

3895 i‡(
	`pxt4_should_jou∫Æ_d©a
(
öode
))

3899 i‡(
	`pxt4_has_ölöe_d©a
(
öode
))

3902 
	`åa˚_pxt4_dúe˘_IO_íãr
(
öode
, 
off£t
, 
cou¡
, 
	`iov_ôî_rw
(
ôî
));

3903 i‡(
	`iov_ôî_rw
(
ôî
Ë=
READ
)

3904 
ªt
 = 
	`pxt4_dúe˘_IO_ªad
(
iocb
, 
ôî
);

3906 
ªt
 = 
	`pxt4_dúe˘_IO_wrôe
(
iocb
, 
ôî
);

3907 
	`åa˚_pxt4_dúe˘_IO_exô
(
öode
, 
off£t
, 
cou¡
, 
	`iov_ôî_rw
(
ôî
), 
ªt
);

3908  
ªt
;

3909 
	}
}

3924 
	$pxt4_jou∫ÆÀd_£t_∑ge_dúty
(
∑ge
 *page)

3926 
	`SëPageChecked
(
∑ge
);

3927  
	`__£t_∑ge_dúty_nobuf„rs
(
∑ge
);

3928 
	}
}

3930 
	$pxt4_£t_∑ge_dúty
(
∑ge
 *page)

3932 
	`WARN_ON_ONCE
(!
	`PageLocked
(
∑ge
Ë&& !
	`PageDúty
(page));

3933 
	`WARN_ON_ONCE
(!
	`∑ge_has_buf„rs
(
∑ge
));

3934  
	`__£t_∑ge_dúty_buf„rs
(
∑ge
);

3935 
	}
}

3937 c⁄° 
addªss_•a˚_›î©i⁄s
 
	gpxt4_a›s
 = {

3938 .
ªad∑ge
 = 
pxt4_ªad∑ge
,

3939 .
	gªad∑ges
 = 
pxt4_ªad∑ges
,

3940 .
	gwrôïage
 = 
pxt4_wrôïage
,

3941 .
	gwrôïages
 = 
pxt4_wrôïages
,

3942 .
	gwrôe_begö
 = 
pxt4_wrôe_begö
,

3943 .
	gwrôe_íd
 = 
pxt4_wrôe_íd
,

3944 .
	g£t_∑ge_dúty
 = 
pxt4_£t_∑ge_dúty
,

3945 .
	gbm≠
 = 
pxt4_bm≠
,

3946 .
	gövÆid©ïage
 = 
pxt4_övÆid©ïage
,

3947 .
	gªÀa£∑ge
 = 
pxt4_ªÀa£∑ge
,

3948 .
	gdúe˘_IO
 = 
pxt4_dúe˘_IO
,

3949 .
	gmigøã∑ge
 = 
buf„r_migøã_∑ge
,

3950 .
	gis_∑πüŒy_u±od©e
 = 
block_is_∑πüŒy_u±od©e
,

3951 .
	gîr‹_ªmove_∑ge
 = 
gíîic_îr‹_ªmove_∑ge
,

3954 c⁄° 
addªss_•a˚_›î©i⁄s
 
	gpxt4_jou∫ÆÀd_a›s
 = {

3955 .
ªad∑ge
 = 
pxt4_ªad∑ge
,

3956 .
	gªad∑ges
 = 
pxt4_ªad∑ges
,

3957 .
	gwrôïage
 = 
pxt4_wrôïage
,

3958 .
	gwrôïages
 = 
pxt4_wrôïages
,

3959 .
	gwrôe_begö
 = 
pxt4_wrôe_begö
,

3960 .
	gwrôe_íd
 = 
pxt4_jou∫ÆÀd_wrôe_íd
,

3961 .
	g£t_∑ge_dúty
 = 
pxt4_jou∫ÆÀd_£t_∑ge_dúty
,

3962 .
	gbm≠
 = 
pxt4_bm≠
,

3963 .
	gövÆid©ïage
 = 
pxt4_jou∫ÆÀd_övÆid©ïage
,

3964 .
	gªÀa£∑ge
 = 
pxt4_ªÀa£∑ge
,

3965 .
	gdúe˘_IO
 = 
pxt4_dúe˘_IO
,

3966 .
	gis_∑πüŒy_u±od©e
 = 
block_is_∑πüŒy_u±od©e
,

3967 .
	gîr‹_ªmove_∑ge
 = 
gíîic_îr‹_ªmove_∑ge
,

3970 c⁄° 
addªss_•a˚_›î©i⁄s
 
	gpxt4_da_a›s
 = {

3971 .
ªad∑ge
 = 
pxt4_ªad∑ge
,

3972 .
	gªad∑ges
 = 
pxt4_ªad∑ges
,

3973 .
	gwrôïage
 = 
pxt4_wrôïage
,

3974 .
	gwrôïages
 = 
pxt4_wrôïages
,

3975 .
	gwrôe_begö
 = 
pxt4_da_wrôe_begö
,

3976 .
	gwrôe_íd
 = 
pxt4_da_wrôe_íd
,

3977 .
	g£t_∑ge_dúty
 = 
pxt4_£t_∑ge_dúty
,

3978 .
	gbm≠
 = 
pxt4_bm≠
,

3979 .
	gövÆid©ïage
 = 
pxt4_övÆid©ïage
,

3980 .
	gªÀa£∑ge
 = 
pxt4_ªÀa£∑ge
,

3981 .
	gdúe˘_IO
 = 
pxt4_dúe˘_IO
,

3982 .
	gmigøã∑ge
 = 
buf„r_migøã_∑ge
,

3983 .
	gis_∑πüŒy_u±od©e
 = 
block_is_∑πüŒy_u±od©e
,

3984 .
	gîr‹_ªmove_∑ge
 = 
gíîic_îr‹_ªmove_∑ge
,

3987 c⁄° 
addªss_•a˚_›î©i⁄s
 
	gpxt4_dax_a›s
 = {

3988 .
wrôïages
 = 
pxt4_dax_wrôïages
,

3989 .
	gdúe˘_IO
 = 
no›_dúe˘_IO
,

3990 .
	g£t_∑ge_dúty
 = 
no›_£t_∑ge_dúty
,

3991 .
	gbm≠
 = 
pxt4_bm≠
,

3992 .
	gövÆid©ïage
 = 
no›_övÆid©ïage
,

3995 
	$pxt4_£t_a›s
(
öode
 *inode)

3997 
	`pxt4_öode_jou∫Æ_mode
(
öode
)) {

3998 
PXT4_INODE_ORDERED_DATA_MODE
:

3999 
PXT4_INODE_WRITEBACK_DATA_MODE
:

4001 
PXT4_INODE_JOURNAL_DATA_MODE
:

4002 
öode
->
i_m≠pög
->
a_›s
 = &
pxt4_jou∫ÆÀd_a›s
;

4005 
	`BUG
();

4007 i‡(
	`IS_DAX
(
öode
))

4008 
öode
->
i_m≠pög
->
a_›s
 = &
pxt4_dax_a›s
;

4009 i‡(
	`ã°_›t
(
öode
->
i_sb
, 
DELALLOC
))

4010 
öode
->
i_m≠pög
->
a_›s
 = &
pxt4_da_a›s
;

4012 
öode
->
i_m≠pög
->
a_›s
 = &
pxt4_a›s
;

4013 
	}
}

4015 
	$__pxt4_block_zîo_∑ge_ønge
(
h™dÀ_t
 *
h™dÀ
,

4016 
addªss_•a˚
 *
m≠pög
, 
loff_t
 
‰om
,Üoff_à
Àngth
)

4018 
pxt4_fsblk_t
 
ödex
 = 
‰om
 >> 
PAGE_SHIFT
;

4019 
off£t
 = 
‰om
 & (
PAGE_SIZE
-1);

4020 
blocksize
, 
pos
;

4021 
pxt4_lblk_t
 
iblock
;

4022 
öode
 *öodê
m≠pög
->
ho°
;

4023 
buf„r_hód
 *
bh
;

4024 
∑ge
 *page;

4025 
îr
 = 0;

4027 
∑ge
 = 
	`föd_‹_¸óã_∑ge
(
m≠pög
, 
‰om
 >> 
PAGE_SHIFT
,

4028 
	`m≠pög_gÂ_c⁄°øöt
(
m≠pög
, ~
__GFP_FS
));

4029 i‡(!
∑ge
)

4030  -
ENOMEM
;

4032 
blocksize
 = 
öode
->
i_sb
->
s_blocksize
;

4034 
iblock
 = 
ödex
 << (
PAGE_SHIFT
 - 
öode
->
i_sb
->
s_blocksize_bôs
);

4036 i‡(!
	`∑ge_has_buf„rs
(
∑ge
))

4037 
	`¸óã_em±y_buf„rs
(
∑ge
, 
blocksize
, 0);

4040 
bh
 = 
	`∑ge_buf„rs
(
∑ge
);

4041 
pos
 = 
blocksize
;

4042 
off£t
 >
pos
) {

4043 
bh
 = bh->
b_this_∑ge
;

4044 
iblock
++;

4045 
pos
 +
blocksize
;

4047 i‡(
	`buf„r_‰ìd
(
bh
)) {

4048 
	`BUFFER_TRACE
(
bh
, "freed: skip");

4049 
u∆ock
;

4051 i‡(!
	`buf„r_m≠≥d
(
bh
)) {

4052 
	`BUFFER_TRACE
(
bh
, "unmapped");

4053 
	`pxt4_gë_block
(
öode
, 
iblock
, 
bh
, 0);

4055 i‡(!
	`buf„r_m≠≥d
(
bh
)) {

4056 
	`BUFFER_TRACE
(
bh
, "still unmapped");

4057 
u∆ock
;

4062 i‡(
	`PageU±od©e
(
∑ge
))

4063 
	`£t_buf„r_u±od©e
(
bh
);

4065 i‡(!
	`buf„r_u±od©e
(
bh
)) {

4066 
îr
 = -
EIO
;

4067 
	`Œ_rw_block
(
REQ_OP_READ
, 0, 1, &
bh
);

4068 
	`waô_⁄_buf„r
(
bh
);

4070 i‡(!
	`buf„r_u±od©e
(
bh
))

4071 
u∆ock
;

4072 i‡(
	`S_ISREG
(
öode
->
i_mode
Ë&& 
	`IS_ENCRYPTED
(inode)) {

4074 
	`BUG_ON
(!
	`fs¸y±_has_í¸y±i⁄_key
(
öode
));

4075 
	`WARN_ON_ONCE
(
	`fs¸y±_de¸y±_∑geˇche_blocks
(

4076 
∑ge
, 
blocksize
, 
	`bh_off£t
(
bh
)));

4079 i‡(
	`pxt4_should_jou∫Æ_d©a
(
öode
)) {

4080 
	`BUFFER_TRACE
(
bh
, "get writeáccess");

4081 
îr
 = 
	`pxt4_jou∫Æ_gë_wrôe_ac˚ss
(
h™dÀ
, 
bh
);

4082 i‡(
îr
)

4083 
u∆ock
;

4085 
	`zîo_u£r
(
∑ge
, 
off£t
, 
Àngth
);

4086 
	`BUFFER_TRACE
(
bh
, "zeroedÉnd of block");

4088 i‡(
	`pxt4_should_jou∫Æ_d©a
(
öode
)) {

4089 
îr
 = 
	`pxt4_h™dÀ_dúty_mëad©a
(
h™dÀ
, 
öode
, 
bh
);

4091 
îr
 = 0;

4092 
	`m¨k_buf„r_dúty
(
bh
);

4093 i‡(
	`pxt4_should_‹dî_d©a
(
öode
))

4094 
îr
 = 
	`pxt4_jbd3_öode_add_wrôe
(
h™dÀ
, 
öode
, 
‰om
,

4095 
Àngth
);

4098 
u∆ock
:

4099 
	`u∆ock_∑ge
(
∑ge
);

4100 
	`put_∑ge
(
∑ge
);

4101  
îr
;

4102 
	}
}

4111 
	$pxt4_block_zîo_∑ge_ønge
(
h™dÀ_t
 *
h™dÀ
,

4112 
addªss_•a˚
 *
m≠pög
, 
loff_t
 
‰om
,Üoff_à
Àngth
)

4114 
öode
 *öodê
m≠pög
->
ho°
;

4115 
off£t
 = 
‰om
 & (
PAGE_SIZE
-1);

4116 
blocksize
 = 
öode
->
i_sb
->
s_blocksize
;

4117 
max
 = 
blocksize
 - (
off£t
 & (blocksize - 1));

4123 i‡(
Àngth
 > 
max
 ||Üength < 0)

4124 
Àngth
 = 
max
;

4126 i‡(
	`IS_DAX
(
öode
)) {

4127  
	`iom≠_zîo_ønge
(
öode
, 
‰om
, 
Àngth
, 
NULL
,

4128 &
pxt4_iom≠_›s
);

4130  
	`__pxt4_block_zîo_∑ge_ønge
(
h™dÀ
, 
m≠pög
, 
‰om
, 
Àngth
);

4131 
	}
}

4139 
	$pxt4_block_åunˇã_∑ge
(
h™dÀ_t
 *
h™dÀ
,

4140 
addªss_•a˚
 *
m≠pög
, 
loff_t
 
‰om
)

4142 
off£t
 = 
‰om
 & (
PAGE_SIZE
-1);

4143 
Àngth
;

4144 
blocksize
;

4145 
öode
 *öodê
m≠pög
->
ho°
;

4148 i‡(
	`IS_ENCRYPTED
(
öode
Ë&& !
	`fs¸y±_has_í¸y±i⁄_key
(inode))

4151 
blocksize
 = 
öode
->
i_sb
->
s_blocksize
;

4152 
Àngth
 = 
blocksize
 - (
off£t
 & (blocksize - 1));

4154  
	`pxt4_block_zîo_∑ge_ønge
(
h™dÀ
, 
m≠pög
, 
‰om
, 
Àngth
);

4155 
	}
}

4157 
	$pxt4_zîo_∑πül_blocks
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *inode,

4158 
loff_t
 
l°¨t
,Üoff_à
Àngth
)

4160 
su≥r_block
 *
sb
 = 
öode
->
i_sb
;

4161 
addªss_•a˚
 *
m≠pög
 = 
öode
->
i_m≠pög
;

4162 
∑πül_°¨t
, 
∑πül_íd
;

4163 
pxt4_fsblk_t
 
°¨t
, 
íd
;

4164 
loff_t
 
byã_íd
 = (
l°¨t
 + 
Àngth
 - 1);

4165 
îr
 = 0;

4167 
∑πül_°¨t
 = 
l°¨t
 & (
sb
->
s_blocksize
 - 1);

4168 
∑πül_íd
 = 
byã_íd
 & (
sb
->
s_blocksize
 - 1);

4170 
°¨t
 = 
l°¨t
 >> 
sb
->
s_blocksize_bôs
;

4171 
íd
 = 
byã_íd
 >> 
sb
->
s_blocksize_bôs
;

4174 i‡(
°¨t
 =
íd
 &&

4175 (
∑πül_°¨t
 || (
∑πül_íd
 !
sb
->
s_blocksize
 - 1))) {

4176 
îr
 = 
	`pxt4_block_zîo_∑ge_ønge
(
h™dÀ
, 
m≠pög
,

4177 
l°¨t
, 
Àngth
);

4178  
îr
;

4181 i‡(
∑πül_°¨t
) {

4182 
îr
 = 
	`pxt4_block_zîo_∑ge_ønge
(
h™dÀ
, 
m≠pög
,

4183 
l°¨t
, 
sb
->
s_blocksize
);

4184 i‡(
îr
)

4185  
îr
;

4188 i‡(
∑πül_íd
 !
sb
->
s_blocksize
 - 1)

4189 
îr
 = 
	`pxt4_block_zîo_∑ge_ønge
(
h™dÀ
, 
m≠pög
,

4190 
byã_íd
 - 
∑πül_íd
,

4191 
∑πül_íd
 + 1);

4192  
îr
;

4193 
	}
}

4195 
	$pxt4_ˇn_åunˇã
(
öode
 *inode)

4197 i‡(
	`S_ISREG
(
öode
->
i_mode
))

4199 i‡(
	`S_ISDIR
(
öode
->
i_mode
))

4201 i‡(
	`S_ISLNK
(
öode
->
i_mode
))

4202  !
	`pxt4_öode_is_Á°_symlök
(
öode
);

4204 
	}
}

4212 
	$pxt4_upd©e_disksize_bef‹e_punch
(
öode
 *öode, 
loff_t
 
off£t
,

4213 
loff_t
 
Àn
)

4215 
h™dÀ_t
 *
h™dÀ
;

4216 
loff_t
 
size
 = 
	`i_size_ªad
(
öode
);

4218 
	`WARN_ON
(!
	`öode_is_locked
(
öode
));

4219 i‡(
off£t
 > 
size
 || off£à+ 
Àn
 < size)

4222 i‡(
	`PXT4_I
(
öode
)->
i_disksize
 >
size
)

4225 
h™dÀ
 = 
	`pxt4_jou∫Æ_°¨t
(
öode
, 
PXT4_HT_MISC
, 1);

4226 i‡(
	`IS_ERR
(
h™dÀ
))

4227  
	`PTR_ERR
(
h™dÀ
);

4228 
	`pxt4_upd©e_i_disksize
(
öode
, 
size
);

4229 
	`pxt4_m¨k_öode_dúty
(
h™dÀ
, 
öode
);

4230 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

4233 
	}
}

4235 
	$pxt4_waô_dax_∑ge
(
pxt4_öode_öfo
 *
ei
)

4237 
	`up_wrôe
(&
ei
->
i_mm≠_£m
);

4238 
	`scheduÀ
();

4239 
	`down_wrôe
(&
ei
->
i_mm≠_£m
);

4240 
	}
}

4242 
	$pxt4_bªak_œyouts
(
öode
 *inode)

4244 
pxt4_öode_öfo
 *
ei
 = 
	`PXT4_I
(
öode
);

4245 
∑ge
 *page;

4246 
îr‹
;

4248 i‡(
	`WARN_ON_ONCE
(!
	`rw£m_is_locked
(&
ei
->
i_mm≠_£m
)))

4249  -
EINVAL
;

4252 
∑ge
 = 
	`dax_œyout_busy_∑ge
(
öode
->
i_m≠pög
);

4253 i‡(!
∑ge
)

4256 
îr‹
 = 
	`___waô_v¨_evít
(&
∑ge
->
_ªfcou¡
,

4257 
	`©omic_ªad
(&
∑ge
->
_ªfcou¡
) == 1,

4258 
TASK_INTERRUPTIBLE
, 0, 0,

4259 
	`pxt4_waô_dax_∑ge
(
ei
));

4260 } 
îr‹
 == 0);

4262  
îr‹
;

4263 
	}
}

4276 
	$pxt4_punch_hﬁe
(
öode
 *öode, 
loff_t
 
off£t
,Üoff_à
Àngth
)

4278 
su≥r_block
 *
sb
 = 
öode
->
i_sb
;

4279 
pxt4_lblk_t
 
fú°_block
, 
°›_block
;

4280 
addªss_•a˚
 *
m≠pög
 = 
öode
->
i_m≠pög
;

4281 
loff_t
 
fú°_block_off£t
, 
œ°_block_off£t
;

4282 
h™dÀ_t
 *
h™dÀ
;

4283 
¸edôs
;

4284 
ªt
 = 0;

4286 i‡(!
	`S_ISREG
(
öode
->
i_mode
))

4287  -
EOPNOTSUPP
;

4289 
	`åa˚_pxt4_punch_hﬁe
(
öode
, 
off£t
, 
Àngth
, 0);

4291 
	`pxt4_˛ór_öode_°©e
(
öode
, 
PXT4_STATE_MAY_INLINE_DATA
);

4292 i‡(
	`pxt4_has_ölöe_d©a
(
öode
)) {

4293 
	`down_wrôe
(&
	`PXT4_I
(
öode
)->
i_mm≠_£m
);

4294 
ªt
 = 
	`pxt4_c⁄vît_ölöe_d©a
(
öode
);

4295 
	`up_wrôe
(&
	`PXT4_I
(
öode
)->
i_mm≠_£m
);

4296 i‡(
ªt
)

4297  
ªt
;

4304 i‡(
	`m≠pög_ègged
(
m≠pög
, 
PAGECACHE_TAG_DIRTY
)) {

4305 
ªt
 = 
	`fûem≠_wrôe_™d_waô_ønge
(
m≠pög
, 
off£t
,

4306 
off£t
 + 
Àngth
 - 1);

4307 i‡(
ªt
)

4308  
ªt
;

4311 
	`öode_lock
(
öode
);

4314 i‡(
off£t
 >
öode
->
i_size
)

4315 
out_muãx
;

4321 i‡(
off£t
 + 
Àngth
 > 
öode
->
i_size
) {

4322 
Àngth
 = 
öode
->
i_size
 +

4323 
PAGE_SIZE
 - (
öode
->
i_size
 & (PAGE_SIZE - 1)) -

4324 
off£t
;

4327 i‡(
off£t
 & (
sb
->
s_blocksize
 - 1) ||

4328 (
off£t
 + 
Àngth
Ë& (
sb
->
s_blocksize
 - 1)) {

4333 
ªt
 = 
	`pxt4_öode_©èch_jöode
(
öode
);

4334 i‡(
ªt
 < 0)

4335 
out_muãx
;

4340 
	`öode_dio_waô
(
öode
);

4346 
	`down_wrôe
(&
	`PXT4_I
(
öode
)->
i_mm≠_£m
);

4348 
ªt
 = 
	`pxt4_bªak_œyouts
(
öode
);

4349 i‡(
ªt
)

4350 
out_dio
;

4352 
fú°_block_off£t
 = 
	`round_up
(
off£t
, 
sb
->
s_blocksize
);

4353 
œ°_block_off£t
 = 
	`round_down
((
off£t
 + 
Àngth
), 
sb
->
s_blocksize
) - 1;

4356 i‡(
œ°_block_off£t
 > 
fú°_block_off£t
) {

4357 
ªt
 = 
	`pxt4_upd©e_disksize_bef‹e_punch
(
öode
, 
off£t
, 
Àngth
);

4358 i‡(
ªt
)

4359 
out_dio
;

4360 
	`åunˇã_∑geˇche_ønge
(
öode
, 
fú°_block_off£t
,

4361 
œ°_block_off£t
);

4364 i‡(
	`pxt4_ã°_öode_Êag
(
öode
, 
PXT4_INODE_EXTENTS
))

4365 
¸edôs
 = 
	`pxt4_wrôïage_å™s_blocks
(
öode
);

4367 
¸edôs
 = 
	`pxt4_blocks_f‹_åunˇã
(
öode
);

4368 
h™dÀ
 = 
	`pxt4_jou∫Æ_°¨t
(
öode
, 
PXT4_HT_TRUNCATE
, 
¸edôs
);

4369 i‡(
	`IS_ERR
(
h™dÀ
)) {

4370 
ªt
 = 
	`PTR_ERR
(
h™dÀ
);

4371 
	`pxt4_°d_îr‹
(
sb
, 
ªt
);

4372 
out_dio
;

4375 
ªt
 = 
	`pxt4_zîo_∑πül_blocks
(
h™dÀ
, 
öode
, 
off£t
,

4376 
Àngth
);

4377 i‡(
ªt
)

4378 
out_°›
;

4380 
fú°_block
 = (
off£t
 + 
sb
->
s_blocksize
 - 1) >>

4381 
	`PXT4_BLOCK_SIZE_BITS
(
sb
);

4382 
°›_block
 = (
off£t
 + 
Àngth
Ë>> 
	`PXT4_BLOCK_SIZE_BITS
(
sb
);

4385 i‡(
°›_block
 > 
fú°_block
) {

4387 
	`down_wrôe
(&
	`PXT4_I
(
öode
)->
i_d©a_£m
);

4388 
	`pxt4_disˇrd_¥óŒoˇti⁄s
(
öode
);

4390 
ªt
 = 
	`pxt4_es_ªmove_exã¡
(
öode
, 
fú°_block
,

4391 
°›_block
 - 
fú°_block
);

4392 i‡(
ªt
) {

4393 
	`up_wrôe
(&
	`PXT4_I
(
öode
)->
i_d©a_£m
);

4394 
out_°›
;

4397 i‡(
	`pxt4_ã°_öode_Êag
(
öode
, 
PXT4_INODE_EXTENTS
))

4398 
ªt
 = 
	`pxt4_ext_ªmove_•a˚
(
öode
, 
fú°_block
,

4399 
°›_block
 - 1);

4401 
ªt
 = 
	`pxt4_öd_ªmove_•a˚
(
h™dÀ
, 
öode
, 
fú°_block
,

4402 
°›_block
);

4404 
	`up_wrôe
(&
	`PXT4_I
(
öode
)->
i_d©a_£m
);

4406 i‡(
	`IS_SYNC
(
öode
))

4407 
	`pxt4_h™dÀ_sync
(
h™dÀ
);

4409 
öode
->
i_mtime
 = inode->
i_˘ime
 = 
	`cuºít_time
(inode);

4410 
	`pxt4_m¨k_öode_dúty
(
h™dÀ
, 
öode
);

4411 i‡(
ªt
 >= 0)

4412 
	`pxt4_upd©e_öode_fsync_å™s
(
h™dÀ
, 
öode
, 1);

4413 
out_°›
:

4414 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

4415 
out_dio
:

4416 
	`up_wrôe
(&
	`PXT4_I
(
öode
)->
i_mm≠_£m
);

4417 
out_muãx
:

4418 
	`öode_u∆ock
(
öode
);

4419  
ªt
;

4420 
	}
}

4422 
	$pxt4_öode_©èch_jöode
(
öode
 *inode)

4424 
pxt4_öode_öfo
 *
ei
 = 
	`PXT4_I
(
öode
);

4425 
jbd3_öode
 *
jöode
;

4427 i‡(
ei
->
jöode
 || !
	`PXT4_SB
(
öode
->
i_sb
)->
s_jou∫Æ
)

4430 
jöode
 = 
	`jbd3_Æloc_öode
(
GFP_KERNEL
);

4431 
	`•ö_lock
(&
öode
->
i_lock
);

4432 i‡(!
ei
->
jöode
) {

4433 i‡(!
jöode
) {

4434 
	`•ö_u∆ock
(&
öode
->
i_lock
);

4435  -
ENOMEM
;

4437 
ei
->
jöode
 = jinode;

4438 
	`jbd3_jou∫Æ_öô_jbd_öode
(
ei
->
jöode
, 
öode
);

4439 
jöode
 = 
NULL
;

4441 
	`•ö_u∆ock
(&
öode
->
i_lock
);

4442 i‡(
	`u∆ikñy
(
jöode
 !
NULL
))

4443 
	`jbd3_‰ì_öode
(
jöode
);

4445 
	}
}

4475 
	$pxt4_åunˇã
(
öode
 *inode)

4477 
pxt4_öode_öfo
 *
ei
 = 
	`PXT4_I
(
öode
);

4478 
¸edôs
;

4479 
îr
 = 0;

4480 
h™dÀ_t
 *
h™dÀ
;

4481 
addªss_•a˚
 *
m≠pög
 = 
öode
->
i_m≠pög
;

4488 i‡(!(
öode
->
i_°©e
 & (
I_NEW
|
I_FREEING
)))

4489 
	`WARN_ON
(!
	`öode_is_locked
(
öode
));

4490 
	`åa˚_pxt4_åunˇã_íãr
(
öode
);

4492 i‡(!
	`pxt4_ˇn_åunˇã
(
öode
))

4495 
	`pxt4_˛ór_öode_Êag
(
öode
, 
PXT4_INODE_EOFBLOCKS
);

4497 i‡(
öode
->
i_size
 =0 && !
	`ã°_›t
(öode->
i_sb
, 
NO_AUTO_DA_ALLOC
))

4498 
	`pxt4_£t_öode_°©e
(
öode
, 
PXT4_STATE_DA_ALLOC_CLOSE
);

4500 i‡(
	`pxt4_has_ölöe_d©a
(
öode
)) {

4501 
has_ölöe
 = 1;

4503 
îr
 = 
	`pxt4_ölöe_d©a_åunˇã
(
öode
, &
has_ölöe
);

4504 i‡(
îr
)

4505  
îr
;

4506 i‡(
has_ölöe
)

4511 i‡(
öode
->
i_size
 & (öode->
i_sb
->
s_blocksize
 - 1)) {

4512 i‡(
	`pxt4_öode_©èch_jöode
(
öode
) < 0)

4516 i‡(
	`pxt4_ã°_öode_Êag
(
öode
, 
PXT4_INODE_EXTENTS
))

4517 
¸edôs
 = 
	`pxt4_wrôïage_å™s_blocks
(
öode
);

4519 
¸edôs
 = 
	`pxt4_blocks_f‹_åunˇã
(
öode
);

4521 
h™dÀ
 = 
	`pxt4_jou∫Æ_°¨t
(
öode
, 
PXT4_HT_TRUNCATE
, 
¸edôs
);

4522 i‡(
	`IS_ERR
(
h™dÀ
))

4523  
	`PTR_ERR
(
h™dÀ
);

4525 i‡(
öode
->
i_size
 & (öode->
i_sb
->
s_blocksize
 - 1))

4526 
	`pxt4_block_åunˇã_∑ge
(
h™dÀ
, 
m≠pög
, 
öode
->
i_size
);

4537 
îr
 = 
	`pxt4_‹ph™_add
(
h™dÀ
, 
öode
);

4538 i‡(
îr
)

4539 
out_°›
;

4541 
	`down_wrôe
(&
	`PXT4_I
(
öode
)->
i_d©a_£m
);

4543 
	`pxt4_disˇrd_¥óŒoˇti⁄s
(
öode
);

4545 i‡(
	`pxt4_ã°_öode_Êag
(
öode
, 
PXT4_INODE_EXTENTS
))

4546 
îr
 = 
	`pxt4_ext_åunˇã
(
h™dÀ
, 
öode
);

4548 
	`pxt4_öd_åunˇã
(
h™dÀ
, 
öode
);

4550 
	`up_wrôe
(&
ei
->
i_d©a_£m
);

4551 i‡(
îr
)

4552 
out_°›
;

4554 i‡(
	`IS_SYNC
(
öode
))

4555 
	`pxt4_h™dÀ_sync
(
h™dÀ
);

4557 
out_°›
:

4565 i‡(
öode
->
i_∆ök
)

4566 
	`pxt4_‹ph™_dñ
(
h™dÀ
, 
öode
);

4568 
öode
->
i_mtime
 = inode->
i_˘ime
 = 
	`cuºít_time
(inode);

4569 
	`pxt4_m¨k_öode_dúty
(
h™dÀ
, 
öode
);

4570 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

4572 
	`åa˚_pxt4_åunˇã_exô
(
öode
);

4573  
îr
;

4574 
	}
}

4582 
	$__pxt4_gë_öode_loc
(
öode
 *inode,

4583 
pxt4_ûoc
 *
ûoc
, 
ö_mem
)

4585 
pxt4_group_desc
 *
gdp
;

4586 
buf„r_hód
 *
bh
;

4587 
su≥r_block
 *
sb
 = 
öode
->
i_sb
;

4588 
pxt4_fsblk_t
 
block
;

4589 
blk_∂ug
 
∂ug
;

4590 
öodes_≥r_block
, 
öode_off£t
;

4592 
ûoc
->
bh
 = 
NULL
;

4593 i‡(
öode
->
i_öo
 < 
PXT4_ROOT_INO
 ||

4594 
öode
->
i_öo
 > 
	`À32_to_˝u
(
	`PXT4_SB
(
sb
)->
s_es
->
s_öodes_cou¡
))

4595  -
EFSCORRUPTED
;

4597 
ûoc
->
block_group
 = (
öode
->
i_öo
 - 1Ë/ 
	`PXT4_INODES_PER_GROUP
(
sb
);

4598 
gdp
 = 
	`pxt4_gë_group_desc
(
sb
, 
ûoc
->
block_group
, 
NULL
);

4599 i‡(!
gdp
)

4600  -
EIO
;

4605 
öodes_≥r_block
 = 
	`PXT4_SB
(
sb
)->
s_öodes_≥r_block
;

4606 
öode_off£t
 = ((
öode
->
i_öo
 - 1) %

4607 
	`PXT4_INODES_PER_GROUP
(
sb
));

4608 
block
 = 
	`pxt4_öode_èbÀ
(
sb
, 
gdp
Ë+ (
öode_off£t
 / 
öodes_≥r_block
);

4609 
ûoc
->
off£t
 = (
öode_off£t
 % 
öodes_≥r_block
Ë* 
	`PXT4_INODE_SIZE
(
sb
);

4611 
bh
 = 
	`sb_gëblk
(
sb
, 
block
);

4612 i‡(
	`u∆ikñy
(!
bh
))

4613  -
ENOMEM
;

4614 i‡(!
	`buf„r_u±od©e
(
bh
)) {

4615 
	`lock_buf„r
(
bh
);

4623 i‡(
	`buf„r_wrôe_io_îr‹
(
bh
Ë&& !
	`buf„r_u±od©e
(bh))

4624 
	`£t_buf„r_u±od©e
(
bh
);

4626 i‡(
	`buf„r_u±od©e
(
bh
)) {

4628 
	`u∆ock_buf„r
(
bh
);

4629 
has_buf„r
;

4637 i‡(
ö_mem
) {

4638 
buf„r_hód
 *
bôm≠_bh
;

4639 
i
, 
°¨t
;

4641 
°¨t
 = 
öode_off£t
 & ~(
öodes_≥r_block
 - 1);

4644 
bôm≠_bh
 = 
	`sb_gëblk
(
sb
, 
	`pxt4_öode_bôm≠
(sb, 
gdp
));

4645 i‡(
	`u∆ikñy
(!
bôm≠_bh
))

4646 
make_io
;

4653 i‡(!
	`buf„r_u±od©e
(
bôm≠_bh
)) {

4654 
	`bªl£
(
bôm≠_bh
);

4655 
make_io
;

4657 
i
 = 
°¨t
; i < sèπ + 
öodes_≥r_block
; i++) {

4658 i‡(
i
 =
öode_off£t
)

4660 i‡(
	`pxt4_ã°_bô
(
i
, 
bôm≠_bh
->
b_d©a
))

4663 
	`bªl£
(
bôm≠_bh
);

4664 i‡(
i
 =
°¨t
 + 
öodes_≥r_block
) {

4666 
	`mem£t
(
bh
->
b_d©a
, 0, bh->
b_size
);

4667 
	`£t_buf„r_u±od©e
(
bh
);

4668 
	`u∆ock_buf„r
(
bh
);

4669 
has_buf„r
;

4673 
make_io
:

4678 
	`blk_°¨t_∂ug
(&
∂ug
);

4679 i‡(
	`PXT4_SB
(
sb
)->
s_öode_ªadahód_blks
) {

4680 
pxt4_fsblk_t
 
b
, 
íd
, 
èbÀ
;

4681 
num
;

4682 
__u32
 
ø_blks
 = 
	`PXT4_SB
(
sb
)->
s_öode_ªadahód_blks
;

4684 
èbÀ
 = 
	`pxt4_öode_èbÀ
(
sb
, 
gdp
);

4686 
b
 = 
block
 & ~((
pxt4_fsblk_t
Ë
ø_blks
 - 1);

4687 i‡(
èbÀ
 > 
b
)

4688 
b
 = 
èbÀ
;

4689 
íd
 = 
b
 + 
ø_blks
;

4690 
num
 = 
	`PXT4_INODES_PER_GROUP
(
sb
);

4691 i‡(
	`pxt4_has_group_desc_csum
(
sb
))

4692 
num
 -
	`pxt4_ôabÀ_unu£d_cou¡
(
sb
, 
gdp
);

4693 
èbÀ
 +
num
 / 
öodes_≥r_block
;

4694 i‡(
íd
 > 
èbÀ
)

4695 
íd
 = 
èbÀ
;

4696 
b
 <
íd
)

4697 
	`sb_bªadahód_unmovabÀ
(
sb
, 
b
++);

4705 
	`åa˚_pxt4_lﬂd_öode
(
öode
);

4706 
	`gë_bh
(
bh
);

4707 
bh
->
b_íd_io
 = 
íd_buf„r_ªad_sync
;

4708 
	`submô_bh
(
REQ_OP_READ
, 
REQ_META
 | 
REQ_PRIO
, 
bh
);

4709 
	`blk_föish_∂ug
(&
∂ug
);

4710 
	`waô_⁄_buf„r
(
bh
);

4711 i‡(!
	`buf„r_u±od©e
(
bh
)) {

4712 
	`PXT4_ERROR_INODE_BLOCK
(
öode
, 
block
,

4714 
	`bªl£
(
bh
);

4715  -
EIO
;

4718 
has_buf„r
:

4719 
ûoc
->
bh
 = bh;

4721 
	}
}

4723 
	$pxt4_gë_öode_loc
(
öode
 *öode, 
pxt4_ûoc
 *
ûoc
)

4726  
	`__pxt4_gë_öode_loc
(
öode
, 
ûoc
,

4727 !
	`pxt4_ã°_öode_°©e
(
öode
, 
PXT4_STATE_XATTR
));

4728 
	}
}

4730 
boﬁ
 
	$pxt4_should_u£_dax
(
öode
 *inode)

4732 i‡(!
	`ã°_›t
(
öode
->
i_sb
, 
DAX
))

4733  
Ál£
;

4734 i‡(!
	`S_ISREG
(
öode
->
i_mode
))

4735  
Ál£
;

4736 i‡(
	`pxt4_should_jou∫Æ_d©a
(
öode
))

4737  
Ál£
;

4738 i‡(
	`pxt4_has_ölöe_d©a
(
öode
))

4739  
Ál£
;

4740 i‡(
	`pxt4_ã°_öode_Êag
(
öode
, 
PXT4_INODE_ENCRYPT
))

4741  
Ál£
;

4742 i‡(
	`pxt4_ã°_öode_Êag
(
öode
, 
PXT4_INODE_VERITY
))

4743  
Ál£
;

4744  
åue
;

4745 
	}
}

4747 
	$pxt4_£t_öode_Êags
(
öode
 *inode)

4749 
Êags
 = 
	`PXT4_I
(
öode
)->
i_Êags
;

4750 
√w_Ê
 = 0;

4752 i‡(
Êags
 & 
PXT4_SYNC_FL
)

4753 
√w_Ê
 |
S_SYNC
;

4754 i‡(
Êags
 & 
PXT4_APPEND_FL
)

4755 
√w_Ê
 |
S_APPEND
;

4756 i‡(
Êags
 & 
PXT4_IMMUTABLE_FL
)

4757 
√w_Ê
 |
S_IMMUTABLE
;

4758 i‡(
Êags
 & 
PXT4_NOATIME_FL
)

4759 
√w_Ê
 |
S_NOATIME
;

4760 i‡(
Êags
 & 
PXT4_DIRSYNC_FL
)

4761 
√w_Ê
 |
S_DIRSYNC
;

4762 i‡(
	`pxt4_should_u£_dax
(
öode
))

4763 
√w_Ê
 |
S_DAX
;

4764 i‡(
Êags
 & 
PXT4_ENCRYPT_FL
)

4765 
√w_Ê
 |
S_ENCRYPTED
;

4766 i‡(
Êags
 & 
PXT4_CASEFOLD_FL
)

4767 
√w_Ê
 |
S_CASEFOLD
;

4768 i‡(
Êags
 & 
PXT4_VERITY_FL
)

4769 
√w_Ê
 |
S_VERITY
;

4770 
	`öode_£t_Êags
(
öode
, 
√w_Ê
,

4771 
S_SYNC
|
S_APPEND
|
S_IMMUTABLE
|
S_NOATIME
|
S_DIRSYNC
|
S_DAX
|

4772 
S_ENCRYPTED
|
S_CASEFOLD
|
S_VERITY
);

4773 
	}
}

4775 
blk˙t_t
 
	$pxt4_öode_blocks
(
pxt4_öode
 *
øw_öode
,

4776 
pxt4_öode_öfo
 *
ei
)

4778 
blk˙t_t
 
i_blocks
 ;

4779 
öode
 *öodê&(
ei
->
vfs_öode
);

4780 
su≥r_block
 *
sb
 = 
öode
->
i_sb
;

4782 i‡(
	`pxt4_has_„©uª_huge_fûe
(
sb
)) {

4784 
i_blocks
 = ((
u64
)
	`À16_to_˝u
(
øw_öode
->
i_blocks_high
)) << 32 |

4785 
	`À32_to_˝u
(
øw_öode
->
i_blocks_lo
);

4786 i‡(
	`pxt4_ã°_öode_Êag
(
öode
, 
PXT4_INODE_HUGE_FILE
)) {

4788  
i_blocks
 << (
öode
->
i_blkbôs
 - 9);

4790  
i_blocks
;

4793  
	`À32_to_˝u
(
øw_öode
->
i_blocks_lo
);

4795 
	}
}

4797 
ölöe
 
	$pxt4_igë_exåa_öode
(
öode
 *inode,

4798 
pxt4_öode
 *
øw_öode
,

4799 
pxt4_öode_öfo
 *
ei
)

4801 
__À32
 *
magic
 = (*)
øw_öode
 +

4802 
PXT4_GOOD_OLD_INODE_SIZE
 + 
ei
->
i_exåa_isize
;

4804 i‡(
PXT4_GOOD_OLD_INODE_SIZE
 + 
ei
->
i_exåa_isize
 + (
__À32
) <=

4805 
	`PXT4_INODE_SIZE
(
öode
->
i_sb
) &&

4806 *
magic
 =
	`˝u_to_À32
(
PXT4_XATTR_MAGIC
)) {

4807 
	`pxt4_£t_öode_°©e
(
öode
, 
PXT4_STATE_XATTR
);

4808  
	`pxt4_föd_ölöe_d©a_nﬁock
(
öode
);

4810 
	`PXT4_I
(
öode
)->
i_ölöe_off
 = 0;

4812 
	}
}

4814 
	$pxt4_gë_¥ojid
(
öode
 *öode, 
k¥ojid_t
 *
¥ojid
)

4816 i‡(!
	`pxt4_has_„©uª_¥oje˘
(
öode
->
i_sb
))

4817  -
EOPNOTSUPP
;

4818 *
¥ojid
 = 
	`PXT4_I
(
öode
)->
i_¥ojid
;

4820 
	}
}

4827 
ölöe
 
	$pxt4_öode_£t_ivîsi⁄_quîõd
(
öode
 *öode, 
u64
 
vÆ
)

4829 i‡(
	`u∆ikñy
(
	`PXT4_I
(
öode
)->
i_Êags
 & 
PXT4_EA_INODE_FL
))

4830 
	`öode_£t_ivîsi⁄_øw
(
öode
, 
vÆ
);

4832 
	`öode_£t_ivîsi⁄_quîõd
(
öode
, 
vÆ
);

4833 
	}
}

4834 
ölöe
 
u64
 
	$pxt4_öode_≥ek_ivîsi⁄
(c⁄° 
öode
 *inode)

4836 i‡(
	`u∆ikñy
(
	`PXT4_I
(
öode
)->
i_Êags
 & 
PXT4_EA_INODE_FL
))

4837  
	`öode_≥ek_ivîsi⁄_øw
(
öode
);

4839  
	`öode_≥ek_ivîsi⁄
(
öode
);

4840 
	}
}

4842 
öode
 *
	$__pxt4_igë
(
su≥r_block
 *
sb
, 
öo
,

4843 
pxt4_igë_Êags
 
Êags
, c⁄° *
fun˘i⁄
,

4844 
löe
)

4846 
pxt4_ûoc
 
ûoc
;

4847 
pxt4_öode
 *
øw_öode
;

4848 
pxt4_öode_öfo
 *
ei
;

4849 
öode
 *inode;

4850 
jou∫Æ_t
 *
jou∫Æ
 = 
	`PXT4_SB
(
sb
)->
s_jou∫Æ
;

4851 
ªt
;

4852 
loff_t
 
size
;

4853 
block
;

4854 
uid_t
 
i_uid
;

4855 
gid_t
 
i_gid
;

4856 
¥ojid_t
 
i_¥ojid
;

4858 i‡((!(
Êags
 & 
PXT4_IGET_SPECIAL
) &&

4859 (
öo
 < 
	`PXT4_FIRST_INO
(
sb
Ë&& inÿ!
PXT4_ROOT_INO
)) ||

4860 (
öo
 < 
PXT4_ROOT_INO
) ||

4861 (
öo
 > 
	`À32_to_˝u
(
	`PXT4_SB
(
sb
)->
s_es
->
s_öodes_cou¡
))) {

4862 i‡(
Êags
 & 
PXT4_IGET_HANDLE
)

4863  
	`ERR_PTR
(-
ESTALE
);

4864 
	`__pxt4_îr‹
(
sb
, 
fun˘i⁄
, 
löe
,

4866 
öo
, 
cuºít
->
comm
);

4867  
	`ERR_PTR
(-
EFSCORRUPTED
);

4870 
öode
 = 
	`igë_locked
(
sb
, 
öo
);

4871 i‡(!
öode
)

4872  
	`ERR_PTR
(-
ENOMEM
);

4873 i‡(!(
öode
->
i_°©e
 & 
I_NEW
))

4874  
öode
;

4876 
ei
 = 
	`PXT4_I
(
öode
);

4877 
ûoc
.
bh
 = 
NULL
;

4879 
ªt
 = 
	`__pxt4_gë_öode_loc
(
öode
, &
ûoc
, 0);

4880 i‡(
ªt
 < 0)

4881 
bad_öode
;

4882 
øw_öode
 = 
	`pxt4_øw_öode
(&
ûoc
);

4884 i‡((
öo
 =
PXT4_ROOT_INO
Ë&& (
øw_öode
->
i_löks_cou¡
 == 0)) {

4885 
	`pxt4_îr‹_öode
(
öode
, 
fun˘i⁄
, 
löe
, 0,

4887 
ªt
 = -
EFSCORRUPTED
;

4888 
bad_öode
;

4891 i‡((
Êags
 & 
PXT4_IGET_HANDLE
) &&

4892 (
øw_öode
->
i_löks_cou¡
 =0Ë&& (øw_öode->
i_mode
 == 0)) {

4893 
ªt
 = -
ESTALE
;

4894 
bad_öode
;

4897 i‡(
	`PXT4_INODE_SIZE
(
öode
->
i_sb
Ë> 
PXT4_GOOD_OLD_INODE_SIZE
) {

4898 
ei
->
i_exåa_isize
 = 
	`À16_to_˝u
(
øw_öode
->i_extra_isize);

4899 i‡(
PXT4_GOOD_OLD_INODE_SIZE
 + 
ei
->
i_exåa_isize
 >

4900 
	`PXT4_INODE_SIZE
(
öode
->
i_sb
) ||

4901 (
ei
->
i_exåa_isize
 & 3)) {

4902 
	`pxt4_îr‹_öode
(
öode
, 
fun˘i⁄
, 
löe
, 0,

4905 
ei
->
i_exåa_isize
,

4906 
	`PXT4_INODE_SIZE
(
öode
->
i_sb
));

4907 
ªt
 = -
EFSCORRUPTED
;

4908 
bad_öode
;

4911 
ei
->
i_exåa_isize
 = 0;

4914 i‡(
	`pxt4_has_mëad©a_csum
(
sb
)) {

4915 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
öode
->
i_sb
);

4916 
__u32
 
csum
;

4917 
__À32
 
öum
 = 
	`˝u_to_À32
(
öode
->
i_öo
);

4918 
__À32
 
gí
 = 
øw_öode
->
i_gíî©i⁄
;

4919 
csum
 = 
	`pxt4_chksum
(
sbi
, sbi->
s_csum_£ed
, (
__u8
 *)&
öum
,

4920 (
öum
));

4921 
ei
->
i_csum_£ed
 = 
	`pxt4_chksum
(
sbi
, 
csum
, (
__u8
 *)&
gí
,

4922 (
gí
));

4925 i‡(!
	`pxt4_öode_csum_vîify
(
öode
, 
øw_öode
, 
ei
)) {

4926 
	`pxt4_îr‹_öode
(
öode
, 
fun˘i⁄
, 
löe
, 0,

4928 
ªt
 = -
EFSBADCRC
;

4929 
bad_öode
;

4932 
öode
->
i_mode
 = 
	`À16_to_˝u
(
øw_öode
->i_mode);

4933 
i_uid
 = (
uid_t
)
	`À16_to_˝u
(
øw_öode
->
i_uid_low
);

4934 
i_gid
 = (
gid_t
)
	`À16_to_˝u
(
øw_öode
->
i_gid_low
);

4935 i‡(
	`pxt4_has_„©uª_¥oje˘
(
sb
) &&

4936 
	`PXT4_INODE_SIZE
(
sb
Ë> 
PXT4_GOOD_OLD_INODE_SIZE
 &&

4937 
	`PXT4_FITS_IN_INODE
(
øw_öode
, 
ei
, 
i_¥ojid
))

4938 
i_¥ojid
 = (
¥ojid_t
)
	`À32_to_˝u
(
øw_öode
->i_projid);

4940 
i_¥ojid
 = 
PXT4_DEF_PROJID
;

4942 i‡(!(
	`ã°_›t
(
öode
->
i_sb
, 
NO_UID32
))) {

4943 
i_uid
 |
	`À16_to_˝u
(
øw_öode
->
i_uid_high
) << 16;

4944 
i_gid
 |
	`À16_to_˝u
(
øw_öode
->
i_gid_high
) << 16;

4946 
	`i_uid_wrôe
(
öode
, 
i_uid
);

4947 
	`i_gid_wrôe
(
öode
, 
i_gid
);

4948 
ei
->
i_¥ojid
 = 
	`make_k¥ojid
(&
öô_u£r_ns
, i_projid);

4949 
	`£t_∆ök
(
öode
, 
	`À16_to_˝u
(
øw_öode
->
i_löks_cou¡
));

4951 
	`pxt4_˛ór_°©e_Êags
(
ei
);

4952 
ei
->
i_ölöe_off
 = 0;

4953 
ei
->
i_dú_°¨t_lookup
 = 0;

4954 
ei
->
i_dtime
 = 
	`À32_to_˝u
(
øw_öode
->i_dtime);

4960 i‡(
öode
->
i_∆ök
 == 0) {

4961 i‡((
öode
->
i_mode
 == 0 ||

4962 !(
	`PXT4_SB
(
öode
->
i_sb
)->
s_mou¡_°©e
 & 
PXT4_ORPHAN_FS
)) &&

4963 
öo
 !
PXT4_BOOT_LOADER_INO
) {

4965 
ªt
 = -
ESTALE
;

4966 
bad_öode
;

4975 
ei
->
i_Êags
 = 
	`À32_to_˝u
(
øw_öode
->i_flags);

4976 
	`pxt4_£t_öode_Êags
(
öode
);

4977 
öode
->
i_blocks
 = 
	`pxt4_öode_blocks
(
øw_öode
, 
ei
);

4978 
ei
->
i_fûe_a˛
 = 
	`À32_to_˝u
(
øw_öode
->
i_fûe_a˛_lo
);

4979 i‡(
	`pxt4_has_„©uª_64bô
(
sb
))

4980 
ei
->
i_fûe_a˛
 |=

4981 ((
__u64
)
	`À16_to_˝u
(
øw_öode
->
i_fûe_a˛_high
)) << 32;

4982 
öode
->
i_size
 = 
	`pxt4_isize
(
sb
, 
øw_öode
);

4983 i‡((
size
 = 
	`i_size_ªad
(
öode
)) < 0) {

4984 
	`pxt4_îr‹_öode
(
öode
, 
fun˘i⁄
, 
löe
, 0,

4985 "igë: bad i_sizêvÆue: %Œd", 
size
);

4986 
ªt
 = -
EFSCORRUPTED
;

4987 
bad_öode
;

4994 i‡(!
	`pxt4_has_„©uª_dú_ödex
(
sb
Ë&& 
	`pxt4_has_mëad©a_csum
(sb) &&

4995 
	`pxt4_ã°_öode_Êag
(
öode
, 
PXT4_INODE_INDEX
)) {

4996 
	`pxt4_îr‹_öode
(
öode
, 
fun˘i⁄
, 
löe
, 0,

4998 
ªt
 = -
EFSCORRUPTED
;

4999 
bad_öode
;

5001 
ei
->
i_disksize
 = 
öode
->
i_size
;

5002 #ifde‡
CONFIG_QUOTA


5003 
ei
->
i_ª£rved_quŸa
 = 0;

5005 
öode
->
i_gíî©i⁄
 = 
	`À32_to_˝u
(
øw_öode
->i_generation);

5006 
ei
->
i_block_group
 = 
ûoc
.
block_group
;

5007 
ei
->
i_œ°_Æloc_group
 = ~0;

5012 
block
 = 0; block < 
PXT4_N_BLOCKS
; block++)

5013 
ei
->
i_d©a
[
block
] = 
øw_öode
->
i_block
[block];

5014 
	`INIT_LIST_HEAD
(&
ei
->
i_‹ph™
);

5023 i‡(
jou∫Æ
) {

5024 
å™ß˘i⁄_t
 *
å™ß˘i⁄
;

5025 
tid_t
 
tid
;

5027 
	`ªad_lock
(&
jou∫Æ
->
j_°©e_lock
);

5028 i‡(
jou∫Æ
->
j_ru¬ög_å™ß˘i⁄
)

5029 
å™ß˘i⁄
 = 
jou∫Æ
->
j_ru¬ög_å™ß˘i⁄
;

5031 
å™ß˘i⁄
 = 
jou∫Æ
->
j_commôtög_å™ß˘i⁄
;

5032 i‡(
å™ß˘i⁄
)

5033 
tid
 = 
å™ß˘i⁄
->
t_tid
;

5035 
tid
 = 
jou∫Æ
->
j_commô_£quí˚
;

5036 
	`ªad_u∆ock
(&
jou∫Æ
->
j_°©e_lock
);

5037 
ei
->
i_sync_tid
 = 
tid
;

5038 
ei
->
i_d©async_tid
 = 
tid
;

5041 i‡(
	`PXT4_INODE_SIZE
(
öode
->
i_sb
Ë> 
PXT4_GOOD_OLD_INODE_SIZE
) {

5042 i‡(
ei
->
i_exåa_isize
 == 0) {

5044 
	`BUILD_BUG_ON
((
pxt4_öode
) & 3);

5045 
ei
->
i_exåa_isize
 = (
pxt4_öode
) -

5046 
PXT4_GOOD_OLD_INODE_SIZE
;

5048 
ªt
 = 
	`pxt4_igë_exåa_öode
(
öode
, 
øw_öode
, 
ei
);

5049 i‡(
ªt
)

5050 
bad_öode
;

5054 
	`PXT4_INODE_GET_XTIME
(
i_˘ime
, 
öode
, 
øw_öode
);

5055 
	`PXT4_INODE_GET_XTIME
(
i_mtime
, 
öode
, 
øw_öode
);

5056 
	`PXT4_INODE_GET_XTIME
(
i_©ime
, 
öode
, 
øw_öode
);

5057 
	`PXT4_EINODE_GET_XTIME
(
i_¸time
, 
ei
, 
øw_öode
);

5059 i‡(
	`likñy
(!
	`ã°_›t2
(
öode
->
i_sb
, 
HURD_COMPAT
))) {

5060 
u64
 
ivîs
 = 
	`À32_to_˝u
(
øw_öode
->
i_disk_vîsi⁄
);

5062 i‡(
	`PXT4_INODE_SIZE
(
öode
->
i_sb
Ë> 
PXT4_GOOD_OLD_INODE_SIZE
) {

5063 i‡(
	`PXT4_FITS_IN_INODE
(
øw_öode
, 
ei
, 
i_vîsi⁄_hi
))

5064 
ivîs
 |=

5065 (
__u64
)(
	`À32_to_˝u
(
øw_öode
->
i_vîsi⁄_hi
)) << 32;

5067 
	`pxt4_öode_£t_ivîsi⁄_quîõd
(
öode
, 
ivîs
);

5070 
ªt
 = 0;

5071 i‡(
ei
->
i_fûe_a˛
 &&

5072 !
	`pxt4_d©a_block_vÆid
(
	`PXT4_SB
(
sb
), 
ei
->
i_fûe_a˛
, 1)) {

5073 
	`pxt4_îr‹_öode
(
öode
, 
fun˘i⁄
, 
löe
, 0,

5075 
ei
->
i_fûe_a˛
);

5076 
ªt
 = -
EFSCORRUPTED
;

5077 
bad_öode
;

5078 } i‡(!
	`pxt4_has_ölöe_d©a
(
öode
)) {

5080 i‡(
	`S_ISREG
(
öode
->
i_mode
Ë|| 
	`S_ISDIR
(inode->i_mode) ||

5081 (
	`S_ISLNK
(
öode
->
i_mode
) &&

5082 !
	`pxt4_öode_is_Á°_symlök
(
öode
))) {

5083 i‡(
	`pxt4_ã°_öode_Êag
(
öode
, 
PXT4_INODE_EXTENTS
))

5084 
ªt
 = 
	`pxt4_ext_check_öode
(
öode
);

5086 
ªt
 = 
	`pxt4_öd_check_öode
(
öode
);

5089 i‡(
ªt
)

5090 
bad_öode
;

5092 i‡(
	`S_ISREG
(
öode
->
i_mode
)) {

5093 
öode
->
i_›
 = &
pxt4_fûe_öode_›î©i⁄s
;

5094 
öode
->
i_f›
 = &
pxt4_fûe_›î©i⁄s
;

5095 
	`pxt4_£t_a›s
(
öode
);

5096 } i‡(
	`S_ISDIR
(
öode
->
i_mode
)) {

5097 
öode
->
i_›
 = &
pxt4_dú_öode_›î©i⁄s
;

5098 
öode
->
i_f›
 = &
pxt4_dú_›î©i⁄s
;

5099 } i‡(
	`S_ISLNK
(
öode
->
i_mode
)) {

5101 i‡(
	`IS_APPEND
(
öode
Ë|| 
	`IS_IMMUTABLE
(inode)) {

5102 
	`pxt4_îr‹_öode
(
öode
, 
fun˘i⁄
, 
löe
, 0,

5105 
ªt
 = -
EFSCORRUPTED
;

5106 
bad_öode
;

5108 i‡(
	`IS_ENCRYPTED
(
öode
)) {

5109 
öode
->
i_›
 = &
pxt4_í¸y±ed_symlök_öode_›î©i⁄s
;

5110 
	`pxt4_£t_a›s
(
öode
);

5111 } i‡(
	`pxt4_öode_is_Á°_symlök
(
öode
)) {

5112 
öode
->
i_lök
 = (*)
ei
->
i_d©a
;

5113 
öode
->
i_›
 = &
pxt4_Á°_symlök_öode_›î©i⁄s
;

5114 
	`nd_ãrmö©e_lök
(
ei
->
i_d©a
, 
öode
->
i_size
,

5115 (
ei
->
i_d©a
) - 1);

5117 
öode
->
i_›
 = &
pxt4_symlök_öode_›î©i⁄s
;

5118 
	`pxt4_£t_a›s
(
öode
);

5120 
	`öode_nohighmem
(
öode
);

5121 } i‡(
	`S_ISCHR
(
öode
->
i_mode
Ë|| 
	`S_ISBLK
(inode->i_mode) ||

5122 
	`S_ISFIFO
(
öode
->
i_mode
Ë|| 
	`S_ISSOCK
(inode->i_mode)) {

5123 
öode
->
i_›
 = &
pxt4_•ecül_öode_›î©i⁄s
;

5124 i‡(
øw_öode
->
i_block
[0])

5125 
	`öô_•ecül_öode
(
öode
, inode->
i_mode
,

5126 
	`ﬁd_decode_dev
(
	`À32_to_˝u
(
øw_öode
->
i_block
[0])));

5128 
	`öô_•ecül_öode
(
öode
, inode->
i_mode
,

5129 
	`√w_decode_dev
(
	`À32_to_˝u
(
øw_öode
->
i_block
[1])));

5130 } i‡(
öo
 =
PXT4_BOOT_LOADER_INO
) {

5131 
	`make_bad_öode
(
öode
);

5133 
ªt
 = -
EFSCORRUPTED
;

5134 
	`pxt4_îr‹_öode
(
öode
, 
fun˘i⁄
, 
löe
, 0,

5135 "igë: bogu†i_modê(%o)", 
öode
->
i_mode
);

5136 
bad_öode
;

5138 i‡(
	`IS_CASEFOLDED
(
öode
Ë&& !
	`pxt4_has_„©uª_ˇ£fﬁd
(öode->
i_sb
))

5139 
	`pxt4_îr‹_öode
(
öode
, 
fun˘i⁄
, 
löe
, 0,

5141 
	`bªl£
(
ûoc
.
bh
);

5143 
	`u∆ock_√w_öode
(
öode
);

5144  
öode
;

5146 
bad_öode
:

5147 
	`bªl£
(
ûoc
.
bh
);

5148 
	`igë_Áûed
(
öode
);

5149  
	`ERR_PTR
(
ªt
);

5150 
	}
}

5152 
	$pxt4_öode_blocks_£t
(
h™dÀ_t
 *
h™dÀ
,

5153 
pxt4_öode
 *
øw_öode
,

5154 
pxt4_öode_öfo
 *
ei
)

5156 
öode
 *öodê&(
ei
->
vfs_öode
);

5157 
u64
 
i_blocks
 = 
	`READ_ONCE
(
öode
->i_blocks);

5158 
su≥r_block
 *
sb
 = 
öode
->
i_sb
;

5160 i‡(
i_blocks
 <= ~0U) {

5165 
øw_öode
->
i_blocks_lo
 = 
	`˝u_to_À32
(
i_blocks
);

5166 
øw_öode
->
i_blocks_high
 = 0;

5167 
	`pxt4_˛ór_öode_Êag
(
öode
, 
PXT4_INODE_HUGE_FILE
);

5170 i‡(!
	`pxt4_has_„©uª_huge_fûe
(
sb
))

5171  -
EFBIG
;

5173 i‡(
i_blocks
 <= 0xffffffffffffULL) {

5178 
øw_öode
->
i_blocks_lo
 = 
	`˝u_to_À32
(
i_blocks
);

5179 
øw_öode
->
i_blocks_high
 = 
	`˝u_to_À16
(
i_blocks
 >> 32);

5180 
	`pxt4_˛ór_öode_Êag
(
öode
, 
PXT4_INODE_HUGE_FILE
);

5182 
	`pxt4_£t_öode_Êag
(
öode
, 
PXT4_INODE_HUGE_FILE
);

5184 
i_blocks
 = i_block†>> (
öode
->
i_blkbôs
 - 9);

5185 
øw_öode
->
i_blocks_lo
 = 
	`˝u_to_À32
(
i_blocks
);

5186 
øw_öode
->
i_blocks_high
 = 
	`˝u_to_À16
(
i_blocks
 >> 32);

5189 
	}
}

5191 
	sŸhî_öode
 {

5192 
	m‹ig_öo
;

5193 
pxt4_öode
 *
	møw_öode
;

5196 
	$Ÿhî_öode_m©ch
(
öode
 * inode, 
öo
,

5197 *
d©a
)

5199 
Ÿhî_öode
 *
oi
 = (Ÿhî_öodê*Ë
d©a
;

5201 i‡((
öode
->
i_öo
 !
öo
) ||

5202 (
öode
->
i_°©e
 & (
I_FREEING
 | 
I_WILL_FREE
 | 
I_NEW
 |

5203 
I_DIRTY_INODE
)) ||

5204 ((
öode
->
i_°©e
 & 
I_DIRTY_TIME
) == 0))

5206 
	`•ö_lock
(&
öode
->
i_lock
);

5207 i‡(((
öode
->
i_°©e
 & (
I_FREEING
 | 
I_WILL_FREE
 | 
I_NEW
 |

5208 
I_DIRTY_INODE
)) == 0) &&

5209 (
öode
->
i_°©e
 & 
I_DIRTY_TIME
)) {

5210 
pxt4_öode_öfo
 *
ei
 = 
	`PXT4_I
(
öode
);

5212 
öode
->
i_°©e
 &~
I_DIRTY_TIME
;

5213 
	`•ö_u∆ock
(&
öode
->
i_lock
);

5215 
	`•ö_lock
(&
ei
->
i_øw_lock
);

5216 
	`PXT4_INODE_SET_XTIME
(
i_˘ime
, 
öode
, 
oi
->
øw_öode
);

5217 
	`PXT4_INODE_SET_XTIME
(
i_mtime
, 
öode
, 
oi
->
øw_öode
);

5218 
	`PXT4_INODE_SET_XTIME
(
i_©ime
, 
öode
, 
oi
->
øw_öode
);

5219 
	`pxt4_öode_csum_£t
(
öode
, 
oi
->
øw_öode
, 
ei
);

5220 
	`•ö_u∆ock
(&
ei
->
i_øw_lock
);

5221 
	`åa˚_pxt4_Ÿhî_öode_upd©e_time
(
öode
, 
oi
->
‹ig_öo
);

5224 
	`•ö_u∆ock
(&
öode
->
i_lock
);

5226 
	}
}

5232 
	$pxt4_upd©e_Ÿhî_öodes_time
(
su≥r_block
 *
sb
,

5233 
‹ig_öo
, *
buf
)

5235 
Ÿhî_öode
 
oi
;

5236 
öo
;

5237 
i
, 
öodes_≥r_block
 = 
	`PXT4_SB
(
sb
)->
s_öodes_≥r_block
;

5238 
öode_size
 = 
	`PXT4_INODE_SIZE
(
sb
);

5240 
oi
.
‹ig_öo
 = orig_ino;

5246 
öo
 = ((
‹ig_öo
 - 1Ë& ~(
öodes_≥r_block
 - 1)) + 1;

5247 
i
 = 0; i < 
öodes_≥r_block
; i++, 
öo
++, 
buf
 +
öode_size
) {

5248 i‡(
öo
 =
‹ig_öo
)

5250 
oi
.
øw_öode
 = (
pxt4_öode
 *Ë
buf
;

5251 (Ë
	`föd_öode_nowaô
(
sb
, 
öo
, 
Ÿhî_öode_m©ch
, &
oi
);

5253 
	}
}

5262 
	$pxt4_do_upd©e_öode
(
h™dÀ_t
 *
h™dÀ
,

5263 
öode
 *inode,

5264 
pxt4_ûoc
 *
ûoc
)

5266 
pxt4_öode
 *
øw_öode
 = 
	`pxt4_øw_öode
(
ûoc
);

5267 
pxt4_öode_öfo
 *
ei
 = 
	`PXT4_I
(
öode
);

5268 
buf„r_hód
 *
bh
 = 
ûoc
->bh;

5269 
su≥r_block
 *
sb
 = 
öode
->
i_sb
;

5270 
îr
 = 0, 
block
;

5271 
√ed_d©async
 = 0, 
£t_œrge_fûe
 = 0;

5272 
uid_t
 
i_uid
;

5273 
gid_t
 
i_gid
;

5274 
¥ojid_t
 
i_¥ojid
;

5276 
	`•ö_lock
(&
ei
->
i_øw_lock
);

5280 i‡(
	`pxt4_ã°_öode_°©e
(
öode
, 
PXT4_STATE_NEW
))

5281 
	`mem£t
(
øw_öode
, 0, 
	`PXT4_SB
(
öode
->
i_sb
)->
s_öode_size
);

5283 
îr
 = 
	`pxt4_öode_blocks_£t
(
h™dÀ
, 
øw_öode
, 
ei
);

5284 i‡(
îr
) {

5285 
	`•ö_u∆ock
(&
ei
->
i_øw_lock
);

5286 
out_bªl£
;

5289 
øw_öode
->
i_mode
 = 
	`˝u_to_À16
(
öode
->i_mode);

5290 
i_uid
 = 
	`i_uid_ªad
(
öode
);

5291 
i_gid
 = 
	`i_gid_ªad
(
öode
);

5292 
i_¥ojid
 = 
	`‰om_k¥ojid
(&
öô_u£r_ns
, 
ei
->i_projid);

5293 i‡(!(
	`ã°_›t
(
öode
->
i_sb
, 
NO_UID32
))) {

5294 
øw_öode
->
i_uid_low
 = 
	`˝u_to_À16
(
	`low_16_bôs
(
i_uid
));

5295 
øw_öode
->
i_gid_low
 = 
	`˝u_to_À16
(
	`low_16_bôs
(
i_gid
));

5300 i‡(
ei
->
i_dtime
 && 
	`li°_em±y
(&ei->
i_‹ph™
)) {

5301 
øw_öode
->
i_uid_high
 = 0;

5302 
øw_öode
->
i_gid_high
 = 0;

5304 
øw_öode
->
i_uid_high
 =

5305 
	`˝u_to_À16
(
	`high_16_bôs
(
i_uid
));

5306 
øw_öode
->
i_gid_high
 =

5307 
	`˝u_to_À16
(
	`high_16_bôs
(
i_gid
));

5310 
øw_öode
->
i_uid_low
 = 
	`˝u_to_À16
(
	`fs_high2lowuid
(
i_uid
));

5311 
øw_öode
->
i_gid_low
 = 
	`˝u_to_À16
(
	`fs_high2lowgid
(
i_gid
));

5312 
øw_öode
->
i_uid_high
 = 0;

5313 
øw_öode
->
i_gid_high
 = 0;

5315 
øw_öode
->
i_löks_cou¡
 = 
	`˝u_to_À16
(
öode
->
i_∆ök
);

5317 
	`PXT4_INODE_SET_XTIME
(
i_˘ime
, 
öode
, 
øw_öode
);

5318 
	`PXT4_INODE_SET_XTIME
(
i_mtime
, 
öode
, 
øw_öode
);

5319 
	`PXT4_INODE_SET_XTIME
(
i_©ime
, 
öode
, 
øw_öode
);

5320 
	`PXT4_EINODE_SET_XTIME
(
i_¸time
, 
ei
, 
øw_öode
);

5322 
øw_öode
->
i_dtime
 = 
	`˝u_to_À32
(
ei
->i_dtime);

5323 
øw_öode
->
i_Êags
 = 
	`˝u_to_À32
(
ei
->i_flags & 0xFFFFFFFF);

5324 i‡(
	`likñy
(!
	`ã°_›t2
(
öode
->
i_sb
, 
HURD_COMPAT
)))

5325 
øw_öode
->
i_fûe_a˛_high
 =

5326 
	`˝u_to_À16
(
ei
->
i_fûe_a˛
 >> 32);

5327 
øw_öode
->
i_fûe_a˛_lo
 = 
	`˝u_to_À32
(
ei
->
i_fûe_a˛
);

5328 i‡(
	`READ_ONCE
(
ei
->
i_disksize
Ë!
	`pxt4_isize
(
öode
->
i_sb
, 
øw_öode
)) {

5329 
	`pxt4_isize_£t
(
øw_öode
, 
ei
->
i_disksize
);

5330 
√ed_d©async
 = 1;

5332 i‡(
ei
->
i_disksize
 > 0x7fffffffULL) {

5333 i‡(!
	`pxt4_has_„©uª_œrge_fûe
(
sb
) ||

5334 
	`PXT4_SB
(
sb
)->
s_es
->
s_ªv_Àvñ
 ==

5335 
	`˝u_to_À32
(
PXT4_GOOD_OLD_REV
))

5336 
£t_œrge_fûe
 = 1;

5338 
øw_öode
->
i_gíî©i⁄
 = 
	`˝u_to_À32
(
öode
->i_generation);

5339 i‡(
	`S_ISCHR
(
öode
->
i_mode
Ë|| 
	`S_ISBLK
(inode->i_mode)) {

5340 i‡(
	`ﬁd_vÆid_dev
(
öode
->
i_rdev
)) {

5341 
øw_öode
->
i_block
[0] =

5342 
	`˝u_to_À32
(
	`ﬁd_ícode_dev
(
öode
->
i_rdev
));

5343 
øw_öode
->
i_block
[1] = 0;

5345 
øw_öode
->
i_block
[0] = 0;

5346 
øw_öode
->
i_block
[1] =

5347 
	`˝u_to_À32
(
	`√w_ícode_dev
(
öode
->
i_rdev
));

5348 
øw_öode
->
i_block
[2] = 0;

5350 } i‡(!
	`pxt4_has_ölöe_d©a
(
öode
)) {

5351 
block
 = 0; block < 
PXT4_N_BLOCKS
; block++)

5352 
øw_öode
->
i_block
[
block
] = 
ei
->
i_d©a
[block];

5355 i‡(
	`likñy
(!
	`ã°_›t2
(
öode
->
i_sb
, 
HURD_COMPAT
))) {

5356 
u64
 
ivîs
 = 
	`pxt4_öode_≥ek_ivîsi⁄
(
öode
);

5358 
øw_öode
->
i_disk_vîsi⁄
 = 
	`˝u_to_À32
(
ivîs
);

5359 i‡(
ei
->
i_exåa_isize
) {

5360 i‡(
	`PXT4_FITS_IN_INODE
(
øw_öode
, 
ei
, 
i_vîsi⁄_hi
))

5361 
øw_öode
->
i_vîsi⁄_hi
 =

5362 
	`˝u_to_À32
(
ivîs
 >> 32);

5363 
øw_öode
->
i_exåa_isize
 =

5364 
	`˝u_to_À16
(
ei
->
i_exåa_isize
);

5368 
	`BUG_ON
(!
	`pxt4_has_„©uª_¥oje˘
(
öode
->
i_sb
) &&

5369 
i_¥ojid
 !
PXT4_DEF_PROJID
);

5371 i‡(
	`PXT4_INODE_SIZE
(
öode
->
i_sb
Ë> 
PXT4_GOOD_OLD_INODE_SIZE
 &&

5372 
	`PXT4_FITS_IN_INODE
(
øw_öode
, 
ei
, 
i_¥ojid
))

5373 
øw_öode
->
i_¥ojid
 = 
	`˝u_to_À32
(i_projid);

5375 
	`pxt4_öode_csum_£t
(
öode
, 
øw_öode
, 
ei
);

5376 
	`•ö_u∆ock
(&
ei
->
i_øw_lock
);

5377 i‡(
öode
->
i_sb
->
s_Êags
 & 
SB_LAZYTIME
)

5378 
	`pxt4_upd©e_Ÿhî_öodes_time
(
öode
->
i_sb
, inode->
i_öo
,

5379 
bh
->
b_d©a
);

5381 
	`BUFFER_TRACE
(
bh
, "callÖxt4_handle_dirty_metadata");

5382 
îr
 = 
	`pxt4_h™dÀ_dúty_mëad©a
(
h™dÀ
, 
NULL
, 
bh
);

5383 i‡(
îr
)

5384 
out_bªl£
;

5385 
	`pxt4_˛ór_öode_°©e
(
öode
, 
PXT4_STATE_NEW
);

5386 i‡(
£t_œrge_fûe
) {

5387 
	`BUFFER_TRACE
(
	`PXT4_SB
(
sb
)->
s_sbh
, "get writeáccess");

5388 
îr
 = 
	`pxt4_jou∫Æ_gë_wrôe_ac˚ss
(
h™dÀ
, 
	`PXT4_SB
(
sb
)->
s_sbh
);

5389 i‡(
îr
)

5390 
out_bªl£
;

5391 
	`pxt4_£t_„©uª_œrge_fûe
(
sb
);

5392 
	`pxt4_h™dÀ_sync
(
h™dÀ
);

5393 
îr
 = 
	`pxt4_h™dÀ_dúty_su≥r
(
h™dÀ
, 
sb
);

5395 
	`pxt4_upd©e_öode_fsync_å™s
(
h™dÀ
, 
öode
, 
√ed_d©async
);

5396 
out_bªl£
:

5397 
	`bªl£
(
bh
);

5398 
	`pxt4_°d_îr‹
(
öode
->
i_sb
, 
îr
);

5399  
îr
;

5400 
	}
}

5436 
	$pxt4_wrôe_öode
(
öode
 *öode, 
wrôeback_c⁄åﬁ
 *
wbc
)

5438 
îr
;

5440 i‡(
	`WARN_ON_ONCE
(
cuºít
->
Êags
 & 
PF_MEMALLOC
) ||

5441 
	`sb_rd⁄ly
(
öode
->
i_sb
))

5444 i‡(
	`u∆ikñy
(
	`pxt4_f‹˚d_shutdown
(
	`PXT4_SB
(
öode
->
i_sb
))))

5445  -
EIO
;

5447 i‡(
	`PXT4_SB
(
öode
->
i_sb
)->
s_jou∫Æ
) {

5448 i‡(
	`pxt4_jou∫Æ_cuºít_h™dÀ
()) {

5449 
	`jbd_debug
(1, "calledÑecursively,Çon-PF_MEMALLOC!\n");

5450 
	`dump_°ack
();

5451  -
EIO
;

5459 i‡(
wbc
->
sync_mode
 !
WB_SYNC_ALL
 || wbc->
f‹_sync
)

5462 
îr
 = 
	`jbd3_com∂ëe_å™ß˘i⁄
(
	`PXT4_SB
(
öode
->
i_sb
)->
s_jou∫Æ
,

5463 
	`PXT4_I
(
öode
)->
i_sync_tid
);

5465 
pxt4_ûoc
 
ûoc
;

5467 
îr
 = 
	`__pxt4_gë_öode_loc
(
öode
, &
ûoc
, 0);

5468 i‡(
îr
)

5469  
îr
;

5474 i‡(
wbc
->
sync_mode
 =
WB_SYNC_ALL
 && !wbc->
f‹_sync
)

5475 
	`sync_dúty_buf„r
(
ûoc
.
bh
);

5476 i‡(
	`buf„r_ªq
(
ûoc
.
bh
Ë&& !
	`buf„r_u±od©e
(iloc.bh)) {

5477 
	`PXT4_ERROR_INODE_BLOCK
(
öode
, 
ûoc
.
bh
->
b_blockƒ
,

5479 
îr
 = -
EIO
;

5481 
	`bªl£
(
ûoc
.
bh
);

5483  
îr
;

5484 
	}
}

5491 
	$pxt4_waô_f‹_èû_∑ge_commô
(
öode
 *inode)

5493 
∑ge
 *page;

5494 
off£t
;

5495 
jou∫Æ_t
 *
jou∫Æ
 = 
	`PXT4_SB
(
öode
->
i_sb
)->
s_jou∫Æ
;

5496 
tid_t
 
commô_tid
 = 0;

5497 
ªt
;

5499 
off£t
 = 
öode
->
i_size
 & (
PAGE_SIZE
 - 1);

5509 i‡(!
off£t
 || off£à> (
PAGE_SIZE
 - 
	`i_blocksize
(
öode
)))

5512 
∑ge
 = 
	`föd_lock_∑ge
(
öode
->
i_m≠pög
,

5513 
öode
->
i_size
 >> 
PAGE_SHIFT
);

5514 i‡(!
∑ge
)

5516 
ªt
 = 
	`__pxt4_jou∫ÆÀd_övÆid©ïage
(
∑ge
, 
off£t
,

5517 
PAGE_SIZE
 - 
off£t
);

5518 
	`u∆ock_∑ge
(
∑ge
);

5519 
	`put_∑ge
(
∑ge
);

5520 i‡(
ªt
 !-
EBUSY
)

5522 
commô_tid
 = 0;

5523 
	`ªad_lock
(&
jou∫Æ
->
j_°©e_lock
);

5524 i‡(
jou∫Æ
->
j_commôtög_å™ß˘i⁄
)

5525 
commô_tid
 = 
jou∫Æ
->
j_commôtög_å™ß˘i⁄
->
t_tid
;

5526 
	`ªad_u∆ock
(&
jou∫Æ
->
j_°©e_lock
);

5527 i‡(
commô_tid
)

5528 
	`jbd3_log_waô_commô
(
jou∫Æ
, 
commô_tid
);

5530 
	}
}

5556 
	$pxt4_£èâr
(
díåy
 *díåy, 
üâr
 *
©å
)

5558 
öode
 *öodê
	`d_öode
(
díåy
);

5559 
îr‹
, 
rc
 = 0;

5560 
‹ph™
 = 0;

5561 c⁄° 
ü_vÆid
 = 
©å
->ia_valid;

5563 i‡(
	`u∆ikñy
(
	`pxt4_f‹˚d_shutdown
(
	`PXT4_SB
(
öode
->
i_sb
))))

5564  -
EIO
;

5566 i‡(
	`u∆ikñy
(
	`IS_IMMUTABLE
(
öode
)))

5567  -
EPERM
;

5569 i‡(
	`u∆ikñy
(
	`IS_APPEND
(
öode
) &&

5570 (
ü_vÆid
 & (
ATTR_MODE
 | 
ATTR_UID
 |

5571 
ATTR_GID
 | 
ATTR_TIMES_SET
))))

5572  -
EPERM
;

5574 
îr‹
 = 
	`£èâr_¥ï¨e
(
díåy
, 
©å
);

5575 i‡(
îr‹
)

5576  
îr‹
;

5578 
îr‹
 = 
	`fs¸y±_¥ï¨e_£èâr
(
díåy
, 
©å
);

5579 i‡(
îr‹
)

5580  
îr‹
;

5582 
îr‹
 = 
	`fsvîôy_¥ï¨e_£èâr
(
díåy
, 
©å
);

5583 i‡(
îr‹
)

5584  
îr‹
;

5586 i‡(
	`is_quŸa_modifiˇti⁄
(
öode
, 
©å
)) {

5587 
îr‹
 = 
	`dquŸ_öôülize
(
öode
);

5588 i‡(
îr‹
)

5589  
îr‹
;

5591 i‡((
ü_vÆid
 & 
ATTR_UID
 && !
	`uid_eq
(
©å
->
ü_uid
, 
öode
->
i_uid
)) ||

5592 (
ü_vÆid
 & 
ATTR_GID
 && !
	`gid_eq
(
©å
->
ü_gid
, 
öode
->
i_gid
))) {

5593 
h™dÀ_t
 *
h™dÀ
;

5597 
h™dÀ
 = 
	`pxt4_jou∫Æ_°¨t
(
öode
, 
PXT4_HT_QUOTA
,

5598 (
	`PXT4_MAXQUOTAS_INIT_BLOCKS
(
öode
->
i_sb
) +

5599 
	`PXT4_MAXQUOTAS_DEL_BLOCKS
(
öode
->
i_sb
)) + 3);

5600 i‡(
	`IS_ERR
(
h™dÀ
)) {

5601 
îr‹
 = 
	`PTR_ERR
(
h™dÀ
);

5602 
îr_out
;

5608 
	`down_ªad
(&
	`PXT4_I
(
öode
)->
x©å_£m
);

5609 
îr‹
 = 
	`dquŸ_å™s„r
(
öode
, 
©å
);

5610 
	`up_ªad
(&
	`PXT4_I
(
öode
)->
x©å_£m
);

5612 i‡(
îr‹
) {

5613 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

5614  
îr‹
;

5618 i‡(
©å
->
ü_vÆid
 & 
ATTR_UID
)

5619 
öode
->
i_uid
 = 
©å
->
ü_uid
;

5620 i‡(
©å
->
ü_vÆid
 & 
ATTR_GID
)

5621 
öode
->
i_gid
 = 
©å
->
ü_gid
;

5622 
îr‹
 = 
	`pxt4_m¨k_öode_dúty
(
h™dÀ
, 
öode
);

5623 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

5626 i‡(
©å
->
ü_vÆid
 & 
ATTR_SIZE
) {

5627 
h™dÀ_t
 *
h™dÀ
;

5628 
loff_t
 
ﬁdsize
 = 
öode
->
i_size
;

5629 
shrök
 = (
©å
->
ü_size
 < 
öode
->
i_size
);

5631 i‡(!(
	`pxt4_ã°_öode_Êag
(
öode
, 
PXT4_INODE_EXTENTS
))) {

5632 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
öode
->
i_sb
);

5634 i‡(
©å
->
ü_size
 > 
sbi
->
s_bôm≠_maxbyãs
)

5635  -
EFBIG
;

5637 i‡(!
	`S_ISREG
(
öode
->
i_mode
))

5638  -
EINVAL
;

5640 i‡(
	`IS_I_VERSION
(
öode
Ë&& 
©å
->
ü_size
 !öode->
i_size
)

5641 
	`öode_öc_ivîsi⁄
(
öode
);

5643 i‡(
shrök
) {

5644 i‡(
	`pxt4_should_‹dî_d©a
(
öode
)) {

5645 
îr‹
 = 
	`pxt4_begö_‹dîed_åunˇã
(
öode
,

5646 
©å
->
ü_size
);

5647 i‡(
îr‹
)

5648 
îr_out
;

5654 
	`öode_dio_waô
(
öode
);

5657 
	`down_wrôe
(&
	`PXT4_I
(
öode
)->
i_mm≠_£m
);

5659 
rc
 = 
	`pxt4_bªak_œyouts
(
öode
);

5660 i‡(
rc
) {

5661 
	`up_wrôe
(&
	`PXT4_I
(
öode
)->
i_mm≠_£m
);

5662  
rc
;

5665 i‡(
©å
->
ü_size
 !
öode
->
i_size
) {

5666 
h™dÀ
 = 
	`pxt4_jou∫Æ_°¨t
(
öode
, 
PXT4_HT_INODE
, 3);

5667 i‡(
	`IS_ERR
(
h™dÀ
)) {

5668 
îr‹
 = 
	`PTR_ERR
(
h™dÀ
);

5669 
out_mm≠_£m
;

5671 i‡(
	`pxt4_h™dÀ_vÆid
(
h™dÀ
Ë&& 
shrök
) {

5672 
îr‹
 = 
	`pxt4_‹ph™_add
(
h™dÀ
, 
öode
);

5673 
‹ph™
 = 1;

5679 i‡(!
shrök
) {

5680 
öode
->
i_mtime
 = 
	`cuºít_time
(inode);

5681 
öode
->
i_˘ime
 = inode->
i_mtime
;

5683 
	`down_wrôe
(&
	`PXT4_I
(
öode
)->
i_d©a_£m
);

5684 
	`PXT4_I
(
öode
)->
i_disksize
 = 
©å
->
ü_size
;

5685 
rc
 = 
	`pxt4_m¨k_öode_dúty
(
h™dÀ
, 
öode
);

5686 i‡(!
îr‹
)

5687 
îr‹
 = 
rc
;

5693 i‡(!
îr‹
)

5694 
	`i_size_wrôe
(
öode
, 
©å
->
ü_size
);

5695 
	`up_wrôe
(&
	`PXT4_I
(
öode
)->
i_d©a_£m
);

5696 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

5697 i‡(
îr‹
)

5698 
out_mm≠_£m
;

5699 i‡(!
shrök
) {

5700 
	`∑geˇche_isize_exãnded
(
öode
, 
ﬁdsize
,

5701 
öode
->
i_size
);

5702 } i‡(
	`pxt4_should_jou∫Æ_d©a
(
öode
)) {

5703 
	`pxt4_waô_f‹_èû_∑ge_commô
(
öode
);

5711 
	`åunˇã_∑geˇche
(
öode
, inode->
i_size
);

5716 i‡(
©å
->
ü_size
 <
ﬁdsize
) {

5717 
rc
 = 
	`pxt4_åunˇã
(
öode
);

5718 i‡(
rc
)

5719 
îr‹
 = 
rc
;

5721 
out_mm≠_£m
:

5722 
	`up_wrôe
(&
	`PXT4_I
(
öode
)->
i_mm≠_£m
);

5725 i‡(!
îr‹
) {

5726 
	`£èâr_c›y
(
öode
, 
©å
);

5727 
	`m¨k_öode_dúty
(
öode
);

5734 i‡(
‹ph™
 && 
öode
->
i_∆ök
)

5735 
	`pxt4_‹ph™_dñ
(
NULL
, 
öode
);

5737 i‡(!
îr‹
 && (
ü_vÆid
 & 
ATTR_MODE
))

5738 
rc
 = 
	`posix_a˛_chmod
(
öode
, inode->
i_mode
);

5740 
îr_out
:

5741 
	`pxt4_°d_îr‹
(
öode
->
i_sb
, 
îr‹
);

5742 i‡(!
îr‹
)

5743 
îr‹
 = 
rc
;

5744  
îr‹
;

5745 
	}
}

5747 
	$pxt4_gë©å
(c⁄° 
∑th
 *∑th, 
k°©
 *
°©
,

5748 
u32
 
ªque°_mask
, 
quîy_Êags
)

5750 
öode
 *öodê
	`d_öode
(
∑th
->
díåy
);

5751 
pxt4_öode
 *
øw_öode
;

5752 
pxt4_öode_öfo
 *
ei
 = 
	`PXT4_I
(
öode
);

5753 
Êags
;

5755 i‡(
	`PXT4_FITS_IN_INODE
(
øw_öode
, 
ei
, 
i_¸time
)) {

5756 
°©
->
ªsu…_mask
 |
STATX_BTIME
;

5757 
°©
->
btime
.
tv_£c
 = 
ei
->
i_¸time
.tv_sec;

5758 
°©
->
btime
.
tv_n£c
 = 
ei
->
i_¸time
.tv_nsec;

5761 
Êags
 = 
ei
->
i_Êags
 & 
PXT4_FL_USER_VISIBLE
;

5762 i‡(
Êags
 & 
PXT4_APPEND_FL
)

5763 
°©
->
©åibuãs
 |
STATX_ATTR_APPEND
;

5764 i‡(
Êags
 & 
PXT4_COMPR_FL
)

5765 
°©
->
©åibuãs
 |
STATX_ATTR_COMPRESSED
;

5766 i‡(
Êags
 & 
PXT4_ENCRYPT_FL
)

5767 
°©
->
©åibuãs
 |
STATX_ATTR_ENCRYPTED
;

5768 i‡(
Êags
 & 
PXT4_IMMUTABLE_FL
)

5769 
°©
->
©åibuãs
 |
STATX_ATTR_IMMUTABLE
;

5770 i‡(
Êags
 & 
PXT4_NODUMP_FL
)

5771 
°©
->
©åibuãs
 |
STATX_ATTR_NODUMP
;

5773 
°©
->
©åibuãs_mask
 |(
STATX_ATTR_APPEND
 |

5774 
STATX_ATTR_COMPRESSED
 |

5775 
STATX_ATTR_ENCRYPTED
 |

5776 
STATX_ATTR_IMMUTABLE
 |

5777 
STATX_ATTR_NODUMP
);

5779 
	`gíîic_fûœâr
(
öode
, 
°©
);

5781 
	}
}

5783 
	$pxt4_fûe_gë©å
(c⁄° 
∑th
 *∑th, 
k°©
 *
°©
,

5784 
u32
 
ªque°_mask
, 
quîy_Êags
)

5786 
öode
 *öodê
	`d_öode
(
∑th
->
díåy
);

5787 
u64
 
dñÆloc_blocks
;

5789 
	`pxt4_gë©å
(
∑th
, 
°©
, 
ªque°_mask
, 
quîy_Êags
);

5797 i‡(
	`u∆ikñy
(
	`pxt4_has_ölöe_d©a
(
öode
)))

5798 
°©
->
blocks
 +(°©->
size
 + 511) >> 9;

5810 
dñÆloc_blocks
 = 
	`PXT4_C2B
(
	`PXT4_SB
(
öode
->
i_sb
),

5811 
	`PXT4_I
(
öode
)->
i_ª£rved_d©a_blocks
);

5812 
°©
->
blocks
 +
dñÆloc_blocks
 << (
öode
->
i_sb
->
s_blocksize_bôs
 - 9);

5814 
	}
}

5816 
	$pxt4_ödex_å™s_blocks
(
öode
 *öode, 
lblocks
,

5817 
≥xã¡s
)

5819 i‡(!(
	`pxt4_ã°_öode_Êag
(
öode
, 
PXT4_INODE_EXTENTS
)))

5820  
	`pxt4_öd_å™s_blocks
(
öode
, 
lblocks
);

5821  
	`pxt4_ext_ödex_å™s_blocks
(
öode
, 
≥xã¡s
);

5822 
	}
}

5835 
	$pxt4_mëa_å™s_blocks
(
öode
 *öode, 
lblocks
,

5836 
≥xã¡s
)

5838 
pxt4_group_t
 
groups
, 
ngroups
 = 
	`pxt4_gë_groups_cou¡
(
öode
->
i_sb
);

5839 
gdpblocks
;

5840 
idxblocks
;

5841 
ªt
 = 0;

5847 
idxblocks
 = 
	`pxt4_ödex_å™s_blocks
(
öode
, 
lblocks
, 
≥xã¡s
);

5849 
ªt
 = 
idxblocks
;

5855 
groups
 = 
idxblocks
 + 
≥xã¡s
;

5856 
gdpblocks
 = 
groups
;

5857 i‡(
groups
 > 
ngroups
)

5858 
groups
 = 
ngroups
;

5859 i‡(
groups
 > 
	`PXT4_SB
(
öode
->
i_sb
)->
s_gdb_cou¡
)

5860 
gdpblocks
 = 
	`PXT4_SB
(
öode
->
i_sb
)->
s_gdb_cou¡
;

5863 
ªt
 +
groups
 + 
gdpblocks
;

5866 
ªt
 +
	`PXT4_META_TRANS_BLOCKS
(
öode
->
i_sb
);

5868  
ªt
;

5869 
	}
}

5881 
	$pxt4_wrôïage_å™s_blocks
(
öode
 *inode)

5883 
bµ
 = 
	`pxt4_jou∫Æ_blocks_≥r_∑ge
(
öode
);

5884 
ªt
;

5886 
ªt
 = 
	`pxt4_mëa_å™s_blocks
(
öode
, 
bµ
, bpp);

5889 i‡(
	`pxt4_should_jou∫Æ_d©a
(
öode
))

5890 
ªt
 +
bµ
;

5891  
ªt
;

5892 
	}
}

5903 
	$pxt4_chunk_å™s_blocks
(
öode
 *öode, 
ƒblocks
)

5905  
	`pxt4_mëa_å™s_blocks
(
öode
, 
ƒblocks
, 1);

5906 
	}
}

5912 
	$pxt4_m¨k_ûoc_dúty
(
h™dÀ_t
 *
h™dÀ
,

5913 
öode
 *öode, 
pxt4_ûoc
 *
ûoc
)

5915 
îr
 = 0;

5917 i‡(
	`u∆ikñy
(
	`pxt4_f‹˚d_shutdown
(
	`PXT4_SB
(
öode
->
i_sb
)))) {

5918 
	`put_bh
(
ûoc
->
bh
);

5919  -
EIO
;

5921 i‡(
	`IS_I_VERSION
(
öode
))

5922 
	`öode_öc_ivîsi⁄
(
öode
);

5925 
	`gë_bh
(
ûoc
->
bh
);

5928 
îr
 = 
	`pxt4_do_upd©e_öode
(
h™dÀ
, 
öode
, 
ûoc
);

5929 
	`put_bh
(
ûoc
->
bh
);

5930  
îr
;

5931 
	}
}

5939 
	$pxt4_ª£rve_öode_wrôe
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *inode,

5940 
pxt4_ûoc
 *
ûoc
)

5942 
îr
;

5944 i‡(
	`u∆ikñy
(
	`pxt4_f‹˚d_shutdown
(
	`PXT4_SB
(
öode
->
i_sb
))))

5945  -
EIO
;

5947 
îr
 = 
	`pxt4_gë_öode_loc
(
öode
, 
ûoc
);

5948 i‡(!
îr
) {

5949 
	`BUFFER_TRACE
(
ûoc
->
bh
, "get_write_access");

5950 
îr
 = 
	`pxt4_jou∫Æ_gë_wrôe_ac˚ss
(
h™dÀ
, 
ûoc
->
bh
);

5951 i‡(
îr
) {

5952 
	`bªl£
(
ûoc
->
bh
);

5953 
ûoc
->
bh
 = 
NULL
;

5956 
	`pxt4_°d_îr‹
(
öode
->
i_sb
, 
îr
);

5957  
îr
;

5958 
	}
}

5960 
	$__pxt4_ex∑nd_exåa_isize
(
öode
 *inode,

5961 
√w_exåa_isize
,

5962 
pxt4_ûoc
 *
ûoc
,

5963 
h™dÀ_t
 *
h™dÀ
, *
no_ex∑nd
)

5965 
pxt4_öode
 *
øw_öode
;

5966 
pxt4_x©å_ibody_hódî
 *
hódî
;

5967 
öode_size
 = 
	`PXT4_INODE_SIZE
(
öode
->
i_sb
);

5968 
pxt4_öode_öfo
 *
ei
 = 
	`PXT4_I
(
öode
);

5969 
îr‹
;

5972 i‡((
PXT4_GOOD_OLD_INODE_SIZE
 + 
ei
->
i_exåa_isize
 > 
öode_size
) ||

5973 (
ei
->
i_exåa_isize
 & 3)) {

5974 
	`PXT4_ERROR_INODE
(
öode
, "badÉxtra_isize %u (inode size %u)",

5975 
ei
->
i_exåa_isize
,

5976 
	`PXT4_INODE_SIZE
(
öode
->
i_sb
));

5977  -
EFSCORRUPTED
;

5979 i‡((
√w_exåa_isize
 < 
ei
->
i_exåa_isize
) ||

5980 (
√w_exåa_isize
 < 4) ||

5981 (
√w_exåa_isize
 > 
öode_size
 - 
PXT4_GOOD_OLD_INODE_SIZE
))

5982  -
EINVAL
;

5984 
øw_öode
 = 
	`pxt4_øw_öode
(
ûoc
);

5986 
hódî
 = 
	`IHDR
(
öode
, 
øw_öode
);

5989 i‡(!
	`pxt4_ã°_öode_°©e
(
öode
, 
PXT4_STATE_XATTR
) ||

5990 
hódî
->
h_magic
 !
	`˝u_to_À32
(
PXT4_XATTR_MAGIC
)) {

5991 
	`mem£t
((*)
øw_öode
 + 
PXT4_GOOD_OLD_INODE_SIZE
 +

5992 
	`PXT4_I
(
öode
)->
i_exåa_isize
, 0,

5993 
√w_exåa_isize
 - 
	`PXT4_I
(
öode
)->
i_exåa_isize
);

5994 
	`PXT4_I
(
öode
)->
i_exåa_isize
 = 
√w_exåa_isize
;

5999 
îr‹
 = 
	`pxt4_ex∑nd_exåa_isize_ó
(
öode
, 
√w_exåa_isize
,

6000 
øw_öode
, 
h™dÀ
);

6001 i‡(
îr‹
) {

6005 *
no_ex∑nd
 = 1;

6008  
îr‹
;

6009 
	}
}

6015 
	$pxt4_åy_to_ex∑nd_exåa_isize
(
öode
 *inode,

6016 
√w_exåa_isize
,

6017 
pxt4_ûoc
 
ûoc
,

6018 
h™dÀ_t
 *
h™dÀ
)

6020 
no_ex∑nd
;

6021 
îr‹
;

6023 i‡(
	`pxt4_ã°_öode_°©e
(
öode
, 
PXT4_STATE_NO_EXPAND
))

6024  -
EOVERFLOW
;

6035 i‡(
	`pxt4_h™dÀ_vÆid
(
h™dÀ
) &&

6036 
	`jbd3_jou∫Æ_exãnd
(
h™dÀ
,

6037 
	`PXT4_DATA_TRANS_BLOCKS
(
öode
->
i_sb
)) != 0)

6038  -
ENOSPC
;

6040 i‡(
	`pxt4_wrôe_åylock_x©å
(
öode
, &
no_ex∑nd
) == 0)

6041  -
EBUSY
;

6043 
îr‹
 = 
	`__pxt4_ex∑nd_exåa_isize
(
öode
, 
√w_exåa_isize
, &
ûoc
,

6044 
h™dÀ
, &
no_ex∑nd
);

6045 
	`pxt4_wrôe_u∆ock_x©å
(
öode
, &
no_ex∑nd
);

6047  
îr‹
;

6048 
	}
}

6050 
	$pxt4_ex∑nd_exåa_isize
(
öode
 *inode,

6051 
√w_exåa_isize
,

6052 
pxt4_ûoc
 *
ûoc
)

6054 
h™dÀ_t
 *
h™dÀ
;

6055 
no_ex∑nd
;

6056 
îr‹
, 
rc
;

6058 i‡(
	`pxt4_ã°_öode_°©e
(
öode
, 
PXT4_STATE_NO_EXPAND
)) {

6059 
	`bªl£
(
ûoc
->
bh
);

6060  -
EOVERFLOW
;

6063 
h™dÀ
 = 
	`pxt4_jou∫Æ_°¨t
(
öode
, 
PXT4_HT_INODE
,

6064 
	`PXT4_DATA_TRANS_BLOCKS
(
öode
->
i_sb
));

6065 i‡(
	`IS_ERR
(
h™dÀ
)) {

6066 
îr‹
 = 
	`PTR_ERR
(
h™dÀ
);

6067 
	`bªl£
(
ûoc
->
bh
);

6068  
îr‹
;

6071 
	`pxt4_wrôe_lock_x©å
(
öode
, &
no_ex∑nd
);

6073 
	`BUFFER_TRACE
(
ûoc
->
bh
, "get_write_access");

6074 
îr‹
 = 
	`pxt4_jou∫Æ_gë_wrôe_ac˚ss
(
h™dÀ
, 
ûoc
->
bh
);

6075 i‡(
îr‹
) {

6076 
	`bªl£
(
ûoc
->
bh
);

6077 
out_u∆ock
;

6080 
îr‹
 = 
	`__pxt4_ex∑nd_exåa_isize
(
öode
, 
√w_exåa_isize
, 
ûoc
,

6081 
h™dÀ
, &
no_ex∑nd
);

6083 
rc
 = 
	`pxt4_m¨k_ûoc_dúty
(
h™dÀ
, 
öode
, 
ûoc
);

6084 i‡(!
îr‹
)

6085 
îr‹
 = 
rc
;

6087 
out_u∆ock
:

6088 
	`pxt4_wrôe_u∆ock_x©å
(
öode
, &
no_ex∑nd
);

6089 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

6090  
îr‹
;

6091 
	}
}

6106 
	$pxt4_m¨k_öode_dúty
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *inode)

6108 
pxt4_ûoc
 
ûoc
;

6109 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
öode
->
i_sb
);

6110 
îr
;

6112 
	`might_¶ìp
();

6113 
	`åa˚_pxt4_m¨k_öode_dúty
(
öode
, 
_RET_IP_
);

6114 
îr
 = 
	`pxt4_ª£rve_öode_wrôe
(
h™dÀ
, 
öode
, &
ûoc
);

6115 i‡(
îr
)

6116  
îr
;

6118 i‡(
	`PXT4_I
(
öode
)->
i_exåa_isize
 < 
sbi
->
s_w™t_exåa_isize
)

6119 
	`pxt4_åy_to_ex∑nd_exåa_isize
(
öode
, 
sbi
->
s_w™t_exåa_isize
,

6120 
ûoc
, 
h™dÀ
);

6122  
	`pxt4_m¨k_ûoc_dúty
(
h™dÀ
, 
öode
, &
ûoc
);

6123 
	}
}

6143 
	$pxt4_dúty_öode
(
öode
 *öode, 
Êags
)

6145 
h™dÀ_t
 *
h™dÀ
;

6147 i‡(
Êags
 =
I_DIRTY_TIME
)

6149 
h™dÀ
 = 
	`pxt4_jou∫Æ_°¨t
(
öode
, 
PXT4_HT_INODE
, 2);

6150 i‡(
	`IS_ERR
(
h™dÀ
))

6151 
out
;

6153 
	`pxt4_m¨k_öode_dúty
(
h™dÀ
, 
öode
);

6155 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

6156 
out
:

6158 
	}
}

6160 
	$pxt4_ch™ge_öode_jou∫Æ_Êag
(
öode
 *öode, 
vÆ
)

6162 
jou∫Æ_t
 *
jou∫Æ
;

6163 
h™dÀ_t
 *
h™dÀ
;

6164 
îr
;

6165 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
öode
->
i_sb
);

6177 
jou∫Æ
 = 
	`PXT4_JOURNAL
(
öode
);

6178 i‡(!
jou∫Æ
)

6180 i‡(
	`is_jou∫Æ_ab‹ãd
(
jou∫Æ
))

6181  -
EROFS
;

6184 
	`öode_dio_waô
(
öode
);

6194 i‡(
vÆ
) {

6195 
	`down_wrôe
(&
	`PXT4_I
(
öode
)->
i_mm≠_£m
);

6196 
îr
 = 
	`fûem≠_wrôe_™d_waô
(
öode
->
i_m≠pög
);

6197 i‡(
îr
 < 0) {

6198 
	`up_wrôe
(&
	`PXT4_I
(
öode
)->
i_mm≠_£m
);

6199  
îr
;

6203 
	`≥r˝u_down_wrôe
(&
sbi
->
s_wrôïages_rw£m
);

6204 
	`jbd3_jou∫Æ_lock_upd©es
(
jou∫Æ
);

6214 i‡(
vÆ
)

6215 
	`pxt4_£t_öode_Êag
(
öode
, 
PXT4_INODE_JOURNAL_DATA
);

6217 
îr
 = 
	`jbd3_jou∫Æ_Êush
(
jou∫Æ
);

6218 i‡(
îr
 < 0) {

6219 
	`jbd3_jou∫Æ_u∆ock_upd©es
(
jou∫Æ
);

6220 
	`≥r˝u_up_wrôe
(&
sbi
->
s_wrôïages_rw£m
);

6221  
îr
;

6223 
	`pxt4_˛ór_öode_Êag
(
öode
, 
PXT4_INODE_JOURNAL_DATA
);

6225 
	`pxt4_£t_a›s
(
öode
);

6227 
	`jbd3_jou∫Æ_u∆ock_upd©es
(
jou∫Æ
);

6228 
	`≥r˝u_up_wrôe
(&
sbi
->
s_wrôïages_rw£m
);

6230 i‡(
vÆ
)

6231 
	`up_wrôe
(&
	`PXT4_I
(
öode
)->
i_mm≠_£m
);

6235 
h™dÀ
 = 
	`pxt4_jou∫Æ_°¨t
(
öode
, 
PXT4_HT_INODE
, 1);

6236 i‡(
	`IS_ERR
(
h™dÀ
))

6237  
	`PTR_ERR
(
h™dÀ
);

6239 
îr
 = 
	`pxt4_m¨k_öode_dúty
(
h™dÀ
, 
öode
);

6240 
	`pxt4_h™dÀ_sync
(
h™dÀ
);

6241 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

6242 
	`pxt4_°d_îr‹
(
öode
->
i_sb
, 
îr
);

6244  
îr
;

6245 
	}
}

6247 
	$pxt4_bh_unm≠≥d
(
h™dÀ_t
 *
h™dÀ
, 
buf„r_hód
 *
bh
)

6249  !
	`buf„r_m≠≥d
(
bh
);

6250 
	}
}

6252 
vm_Áu…_t
 
	$pxt4_∑ge_mkwrôe
(
vm_Áu…
 *
vmf
)

6254 
vm_¨ó_°ru˘
 *
vma
 = 
vmf
->vma;

6255 
∑ge
 *∑gê
vmf
->page;

6256 
loff_t
 
size
;

6257 
Àn
;

6258 
îr
;

6259 
vm_Áu…_t
 
ªt
;

6260 
fûe
 *fûê
vma
->
vm_fûe
;

6261 
öode
 *öodê
	`fûe_öode
(
fûe
);

6262 
addªss_•a˚
 *
m≠pög
 = 
öode
->
i_m≠pög
;

6263 
h™dÀ_t
 *
h™dÀ
;

6264 
gë_block_t
 *
gë_block
;

6265 
ªåõs
 = 0;

6267 i‡(
	`u∆ikñy
(
	`IS_IMMUTABLE
(
öode
)))

6268  
VM_FAULT_SIGBUS
;

6270 
	`sb_°¨t_∑geÁu…
(
öode
->
i_sb
);

6271 
	`fûe_upd©e_time
(
vma
->
vm_fûe
);

6273 
	`down_ªad
(&
	`PXT4_I
(
öode
)->
i_mm≠_£m
);

6275 
îr
 = 
	`pxt4_c⁄vît_ölöe_d©a
(
öode
);

6276 i‡(
îr
)

6277 
out_ªt
;

6280 i‡(
	`ã°_›t
(
öode
->
i_sb
, 
DELALLOC
) &&

6281 !
	`pxt4_should_jou∫Æ_d©a
(
öode
) &&

6282 !
	`pxt4_n⁄da_swôch
(
öode
->
i_sb
)) {

6284 
îr
 = 
	`block_∑ge_mkwrôe
(
vma
, 
vmf
,

6285 
pxt4_da_gë_block_¥ï
);

6286 } 
îr
 =-
ENOSPC
 &&

6287 
	`pxt4_should_ªåy_Æloc
(
öode
->
i_sb
, &
ªåõs
));

6288 
out_ªt
;

6291 
	`lock_∑ge
(
∑ge
);

6292 
size
 = 
	`i_size_ªad
(
öode
);

6294 i‡(
∑ge
->
m≠pög
 !m≠pög || 
	`∑ge_off£t
’ageË> 
size
) {

6295 
	`u∆ock_∑ge
(
∑ge
);

6296 
ªt
 = 
VM_FAULT_NOPAGE
;

6297 
out
;

6300 i‡(
∑ge
->
ödex
 =
size
 >> 
PAGE_SHIFT
)

6301 
Àn
 = 
size
 & ~
PAGE_MASK
;

6303 
Àn
 = 
PAGE_SIZE
;

6308 i‡(
	`∑ge_has_buf„rs
(
∑ge
)) {

6309 i‡(!
	`pxt4_wÆk_∑ge_buf„rs
(
NULL
, 
	`∑ge_buf„rs
(
∑ge
),

6310 0, 
Àn
, 
NULL
,

6311 
pxt4_bh_unm≠≥d
)) {

6313 
	`waô_f‹_°abÀ_∑ge
(
∑ge
);

6314 
ªt
 = 
VM_FAULT_LOCKED
;

6315 
out
;

6318 
	`u∆ock_∑ge
(
∑ge
);

6320 i‡(
	`pxt4_should_di‹ód_nﬁock
(
öode
))

6321 
gë_block
 = 
pxt4_gë_block_unwrôãn
;

6323 
gë_block
 = 
pxt4_gë_block
;

6324 
ªåy_Æloc
:

6325 
h™dÀ
 = 
	`pxt4_jou∫Æ_°¨t
(
öode
, 
PXT4_HT_WRITE_PAGE
,

6326 
	`pxt4_wrôïage_å™s_blocks
(
öode
));

6327 i‡(
	`IS_ERR
(
h™dÀ
)) {

6328 
ªt
 = 
VM_FAULT_SIGBUS
;

6329 
out
;

6331 
îr
 = 
	`block_∑ge_mkwrôe
(
vma
, 
vmf
, 
gë_block
);

6332 i‡(!
îr
 && 
	`pxt4_should_jou∫Æ_d©a
(
öode
)) {

6333 i‡(
	`pxt4_wÆk_∑ge_buf„rs
(
h™dÀ
, 
	`∑ge_buf„rs
(
∑ge
), 0,

6334 
PAGE_SIZE
, 
NULL
, 
do_jou∫Æ_gë_wrôe_ac˚ss
)) {

6335 
	`u∆ock_∑ge
(
∑ge
);

6336 
ªt
 = 
VM_FAULT_SIGBUS
;

6337 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

6338 
out
;

6340 
	`pxt4_£t_öode_°©e
(
öode
, 
PXT4_STATE_JDATA
);

6342 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

6343 i‡(
îr
 =-
ENOSPC
 && 
	`pxt4_should_ªåy_Æloc
(
öode
->
i_sb
, &
ªåõs
))

6344 
ªåy_Æloc
;

6345 
out_ªt
:

6346 
ªt
 = 
	`block_∑ge_mkwrôe_ªtu∫
(
îr
);

6347 
out
:

6348 
	`up_ªad
(&
	`PXT4_I
(
öode
)->
i_mm≠_£m
);

6349 
	`sb_íd_∑geÁu…
(
öode
->
i_sb
);

6350  
ªt
;

6351 
	}
}

6353 
vm_Áu…_t
 
	$pxt4_fûem≠_Áu…
(
vm_Áu…
 *
vmf
)

6355 
öode
 *öodê
	`fûe_öode
(
vmf
->
vma
->
vm_fûe
);

6356 
vm_Áu…_t
 
ªt
;

6358 
	`down_ªad
(&
	`PXT4_I
(
öode
)->
i_mm≠_£m
);

6359 
ªt
 = 
	`fûem≠_Áu…
(
vmf
);

6360 
	`up_ªad
(&
	`PXT4_I
(
öode
)->
i_mm≠_£m
);

6362  
ªt
;

6363 
	}
}

	@ioctl.c

11 
	~<löux/fs.h
>

12 
	~<löux/ˇ∑bûôy.h
>

13 
	~<löux/time.h
>

14 
	~<löux/com∑t.h
>

15 
	~<löux/mou¡.h
>

16 
	~<löux/fûe.h
>

17 
	~<löux/quŸa›s.h
>

18 
	~<löux/øndom.h
>

19 
	~<löux/uuid.h
>

20 
	~<löux/uac˚ss.h
>

21 
	~<löux/dñay.h
>

22 
	~<löux/ivîsi⁄.h
>

23 
	~"pxt4_jbd3.h
"

24 
	~"pxt4.h
"

25 
	~<löux/fsm≠.h
>

26 
	~"fsm≠.h
"

27 
	~<åa˚/evíts/pxt4.h
>

37 
	$memsw≠
(*
a
, *
b
, 
size_t
 
Àn
)

39 *
≠
, *
bp
;

41 
≠
 = (*)
a
;

42 
bp
 = (*)
b
;

43 
Àn
-- > 0) {

44 
	`sw≠
(*
≠
, *
bp
);

45 
≠
++;

46 
bp
++;

48 
	}
}

61 
	$sw≠_öode_d©a
(
öode
 *
öode1
, öodê*
öode2
)

63 
loff_t
 
isize
;

64 
pxt4_öode_öfo
 *
ei1
;

65 
pxt4_öode_öfo
 *
ei2
;

66 
tmp
;

68 
ei1
 = 
	`PXT4_I
(
öode1
);

69 
ei2
 = 
	`PXT4_I
(
öode2
);

71 
	`sw≠
(
öode1
->
i_vîsi⁄
, 
öode2
->i_version);

72 
	`sw≠
(
öode1
->
i_©ime
, 
öode2
->i_atime);

73 
	`sw≠
(
öode1
->
i_mtime
, 
öode2
->i_mtime);

75 
	`memsw≠
(
ei1
->
i_d©a
, 
ei2
->i_data, (ei1->i_data));

76 
tmp
 = 
ei1
->
i_Êags
 & 
PXT4_FL_SHOULD_SWAP
;

77 
ei1
->
i_Êags
 = (
ei2
->i_Êag†& 
PXT4_FL_SHOULD_SWAP
) |

78 (
ei1
->
i_Êags
 & ~
PXT4_FL_SHOULD_SWAP
);

79 
ei2
->
i_Êags
 = 
tmp
 | (ei2->i_Êag†& ~
PXT4_FL_SHOULD_SWAP
);

80 
	`sw≠
(
ei1
->
i_disksize
, 
ei2
->i_disksize);

81 
	`pxt4_es_ªmove_exã¡
(
öode1
, 0, 
EXT_MAX_BLOCKS
);

82 
	`pxt4_es_ªmove_exã¡
(
öode2
, 0, 
EXT_MAX_BLOCKS
);

84 
isize
 = 
	`i_size_ªad
(
öode1
);

85 
	`i_size_wrôe
(
öode1
, 
	`i_size_ªad
(
öode2
));

86 
	`i_size_wrôe
(
öode2
, 
isize
);

87 
	}
}

89 
	$ª£t_öode_£ed
(
öode
 *inode)

91 
pxt4_öode_öfo
 *
ei
 = 
	`PXT4_I
(
öode
);

92 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
öode
->
i_sb
);

93 
__À32
 
öum
 = 
	`˝u_to_À32
(
öode
->
i_öo
);

94 
__À32
 
gí
 = 
	`˝u_to_À32
(
öode
->
i_gíî©i⁄
);

95 
__u32
 
csum
;

97 i‡(!
	`pxt4_has_mëad©a_csum
(
öode
->
i_sb
))

100 
csum
 = 
	`pxt4_chksum
(
sbi
, sbi->
s_csum_£ed
, (
__u8
 *)&
öum
, (inum));

101 
ei
->
i_csum_£ed
 = 
	`pxt4_chksum
(
sbi
, 
csum
, (
__u8
 *)&
gí
, (gen));

102 
	}
}

113 
	$sw≠_öode_boŸ_lﬂdî
(
su≥r_block
 *
sb
,

114 
öode
 *inode)

116 
h™dÀ_t
 *
h™dÀ
;

117 
îr
;

118 
öode
 *
öode_bl
;

119 
pxt4_öode_öfo
 *
ei_bl
;

120 
qsize_t
 
size
, 
size_bl
, 
diff
;

121 
blk˙t_t
 
blocks
;

122 
byãs
;

124 
öode_bl
 = 
	`pxt4_igë
(
sb
, 
PXT4_BOOT_LOADER_INO
, 
PXT4_IGET_SPECIAL
);

125 i‡(
	`IS_ERR
(
öode_bl
))

126  
	`PTR_ERR
(
öode_bl
);

127 
ei_bl
 = 
	`PXT4_I
(
öode_bl
);

131 
	`lock_two_n⁄dúe˘‹õs
(
öode
, 
öode_bl
);

133 i‡(
öode
->
i_∆ök
 !1 || !
	`S_ISREG
(öode->
i_mode
) ||

134 
	`IS_SWAPFILE
(
öode
Ë|| 
	`IS_ENCRYPTED
(inode) ||

135 (
	`PXT4_I
(
öode
)->
i_Êags
 & 
PXT4_JOURNAL_DATA_FL
) ||

136 
	`pxt4_has_ölöe_d©a
(
öode
)) {

137 
îr
 = -
EINVAL
;

138 
jou∫Æ_îr_out
;

141 i‡(
	`IS_RDONLY
(
öode
Ë|| 
	`IS_APPEND
(öodeË|| 
	`IS_IMMUTABLE
(inode) ||

142 !
	`öode_ow√r_‹_ˇ∑bÀ
(
öode
Ë|| !
	`ˇ∑bÀ
(
CAP_SYS_ADMIN
)) {

143 
îr
 = -
EPERM
;

144 
jou∫Æ_îr_out
;

147 
	`down_wrôe
(&
	`PXT4_I
(
öode
)->
i_mm≠_£m
);

148 
îr
 = 
	`fûem≠_wrôe_™d_waô
(
öode
->
i_m≠pög
);

149 i‡(
îr
)

150 
îr_out
;

152 
îr
 = 
	`fûem≠_wrôe_™d_waô
(
öode_bl
->
i_m≠pög
);

153 i‡(
îr
)

154 
îr_out
;

157 
	`öode_dio_waô
(
öode
);

158 
	`öode_dio_waô
(
öode_bl
);

160 
	`åunˇã_öode_∑ges
(&
öode
->
i_d©a
, 0);

161 
	`åunˇã_öode_∑ges
(&
öode_bl
->
i_d©a
, 0);

163 
h™dÀ
 = 
	`pxt4_jou∫Æ_°¨t
(
öode_bl
, 
PXT4_HT_MOVE_EXTENTS
, 2);

164 i‡(
	`IS_ERR
(
h™dÀ
)) {

165 
îr
 = -
EINVAL
;

166 
îr_out
;

170 
	`pxt4_doubÀ_down_wrôe_d©a_£m
(
öode
, 
öode_bl
);

172 i‡(
öode_bl
->
i_∆ök
 == 0) {

174 
	`£t_∆ök
(
öode_bl
, 1);

175 
	`i_uid_wrôe
(
öode_bl
, 0);

176 
	`i_gid_wrôe
(
öode_bl
, 0);

177 
öode_bl
->
i_Êags
 = 0;

178 
ei_bl
->
i_Êags
 = 0;

179 
	`öode_£t_ivîsi⁄
(
öode_bl
, 1);

180 
	`i_size_wrôe
(
öode_bl
, 0);

181 
öode_bl
->
i_mode
 = 
S_IFREG
;

182 i‡(
	`pxt4_has_„©uª_exã¡s
(
sb
)) {

183 
	`pxt4_£t_öode_Êag
(
öode_bl
, 
PXT4_INODE_EXTENTS
);

184 
	`pxt4_ext_åì_öô
(
h™dÀ
, 
öode_bl
);

186 
	`mem£t
(
ei_bl
->
i_d©a
, 0, (ei_bl->i_data));

189 
îr
 = 
	`dquŸ_öôülize
(
öode
);

190 i‡(
îr
)

191 
îr_out1
;

193 
size
 = (
qsize_t
)(
öode
->
i_blocks
Ë* (1 << 9Ë+ inode->
i_byãs
;

194 
size_bl
 = (
qsize_t
)(
öode_bl
->
i_blocks
Ë* (1 << 9Ë+ inode_bl->
i_byãs
;

195 
diff
 = 
size
 - 
size_bl
;

196 
	`sw≠_öode_d©a
(
öode
, 
öode_bl
);

198 
öode
->
i_˘ime
 = 
öode_bl
->i_˘imê
	`cuºít_time
(inode);

200 
öode
->
i_gíî©i⁄
 = 
	`¥™dom_u32
();

201 
öode_bl
->
i_gíî©i⁄
 = 
	`¥™dom_u32
();

202 
	`ª£t_öode_£ed
(
öode
);

203 
	`ª£t_öode_£ed
(
öode_bl
);

205 
	`pxt4_disˇrd_¥óŒoˇti⁄s
(
öode
);

207 
îr
 = 
	`pxt4_m¨k_öode_dúty
(
h™dÀ
, 
öode
);

208 i‡(
îr
 < 0) {

210 
	`pxt4_w¨nög
(
öode
->
i_sb
,

212 
öode
->
i_öo
, 
îr
);

214 
	`sw≠_öode_d©a
(
öode
, 
öode_bl
);

215 
	`pxt4_m¨k_öode_dúty
(
h™dÀ
, 
öode
);

216 
îr_out1
;

219 
blocks
 = 
öode_bl
->
i_blocks
;

220 
byãs
 = 
öode_bl
->
i_byãs
;

221 
öode_bl
->
i_blocks
 = 
öode
->i_blocks;

222 
öode_bl
->
i_byãs
 = 
öode
->i_bytes;

223 
îr
 = 
	`pxt4_m¨k_öode_dúty
(
h™dÀ
, 
öode_bl
);

224 i‡(
îr
 < 0) {

226 
	`pxt4_w¨nög
(
öode_bl
->
i_sb
,

228 
öode_bl
->
i_öo
, 
îr
);

229 
ªvît
;

233 i‡(
diff
 > 0)

234 
	`dquŸ_‰ì_•a˚
(
öode
, 
diff
);

236 
îr
 = 
	`dquŸ_Æloc_•a˚
(
öode
, -1 * 
diff
);

238 i‡(
îr
 < 0) {

239 
ªvît
:

241 
öode_bl
->
i_blocks
 = 
blocks
;

242 
öode_bl
->
i_byãs
 = 
byãs
;

243 
	`sw≠_öode_d©a
(
öode
, 
öode_bl
);

244 
	`pxt4_m¨k_öode_dúty
(
h™dÀ
, 
öode
);

245 
	`pxt4_m¨k_öode_dúty
(
h™dÀ
, 
öode_bl
);

248 
îr_out1
:

249 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

250 
	`pxt4_doubÀ_up_wrôe_d©a_£m
(
öode
, 
öode_bl
);

252 
îr_out
:

253 
	`up_wrôe
(&
	`PXT4_I
(
öode
)->
i_mm≠_£m
);

254 
jou∫Æ_îr_out
:

255 
	`u∆ock_two_n⁄dúe˘‹õs
(
öode
, 
öode_bl
);

256 
	`ùut
(
öode_bl
);

257  
îr
;

258 
	}
}

260 #ifde‡
CONFIG_FS_ENCRYPTION


261 
	$uuid_is_zîo
(
__u8
 
u
[16])

263 
i
;

265 
i
 = 0; i < 16; i++)

266 i‡(
u
[
i
])

269 
	}
}

277 
	$pxt4_io˘l_check_immuèbÀ
(
öode
 *öode, 
__u32
 
√w_¥ojid
,

278 
Êags
)

280 
pxt4_öode_öfo
 *
ei
 = 
	`PXT4_I
(
öode
);

281 
ﬁdÊags
 = 
ei
->
i_Êags
;

283 i‡(!(
ﬁdÊags
 & 
PXT4_IMMUTABLE_FL
Ë|| !(
Êags
 & PXT4_IMMUTABLE_FL))

286 i‡((
ﬁdÊags
 & ~
PXT4_IMMUTABLE_FL
Ë!(
Êags
 & ~PXT4_IMMUTABLE_FL))

287  -
EPERM
;

288 i‡(
	`pxt4_has_„©uª_¥oje˘
(
öode
->
i_sb
) &&

289 
	`__k¥ojid_vÆ
(
ei
->
i_¥ojid
Ë!
√w_¥ojid
)

290  -
EPERM
;

293 
	}
}

295 
	$pxt4_io˘l_£tÊags
(
öode
 *inode,

296 
Êags
)

298 
pxt4_öode_öfo
 *
ei
 = 
	`PXT4_I
(
öode
);

299 
h™dÀ_t
 *
h™dÀ
 = 
NULL
;

300 
îr
 = -
EPERM
, 
migøã
 = 0;

301 
pxt4_ûoc
 
ûoc
;

302 
ﬁdÊags
, 
mask
, 
i
;

303 
jÊag
;

304 
su≥r_block
 *
sb
 = 
öode
->
i_sb
;

307 i‡(
	`pxt4_is_quŸa_fûe
(
öode
))

308 
Êags_out
;

310 
ﬁdÊags
 = 
ei
->
i_Êags
;

313 
jÊag
 = 
Êags
 & 
PXT4_JOURNAL_DATA_FL
;

315 
îr
 = 
	`vfs_ioc_£tÊags_¥ï¨e
(
öode
, 
ﬁdÊags
, 
Êags
);

316 i‡(
îr
)

317 
Êags_out
;

323 i‡((
jÊag
 ^ 
ﬁdÊags
Ë& (
PXT4_JOURNAL_DATA_FL
)) {

324 i‡(!
	`ˇ∑bÀ
(
CAP_SYS_RESOURCE
))

325 
Êags_out
;

327 i‡((
Êags
 ^ 
ﬁdÊags
Ë& 
PXT4_EXTENTS_FL
)

328 
migøã
 = 1;

330 i‡(
Êags
 & 
PXT4_EOFBLOCKS_FL
) {

332 i‡(!(
ﬁdÊags
 & 
PXT4_EOFBLOCKS_FL
)) {

333 
îr
 = -
EOPNOTSUPP
;

334 
Êags_out
;

336 } i‡(
ﬁdÊags
 & 
PXT4_EOFBLOCKS_FL
) {

337 
îr
 = 
	`pxt4_åunˇã
(
öode
);

338 i‡(
îr
)

339 
Êags_out
;

342 i‡((
Êags
 ^ 
ﬁdÊags
Ë& 
PXT4_CASEFOLD_FL
) {

343 i‡(!
	`pxt4_has_„©uª_ˇ£fﬁd
(
sb
)) {

344 
îr
 = -
EOPNOTSUPP
;

345 
Êags_out
;

348 i‡(!
	`S_ISDIR
(
öode
->
i_mode
)) {

349 
îr
 = -
ENOTDIR
;

350 
Êags_out
;

353 i‡(!
	`pxt4_em±y_dú
(
öode
)) {

354 
îr
 = -
ENOTEMPTY
;

355 
Êags_out
;

365 i‡(
	`S_ISREG
(
öode
->
i_mode
Ë&& !
	`IS_IMMUTABLE
(inode) &&

366 (
Êags
 & 
PXT4_IMMUTABLE_FL
)) {

367 
	`öode_dio_waô
(
öode
);

368 
îr
 = 
	`fûem≠_wrôe_™d_waô
(
öode
->
i_m≠pög
);

369 i‡(
îr
)

370 
Êags_out
;

373 
h™dÀ
 = 
	`pxt4_jou∫Æ_°¨t
(
öode
, 
PXT4_HT_INODE
, 1);

374 i‡(
	`IS_ERR
(
h™dÀ
)) {

375 
îr
 = 
	`PTR_ERR
(
h™dÀ
);

376 
Êags_out
;

378 i‡(
	`IS_SYNC
(
öode
))

379 
	`pxt4_h™dÀ_sync
(
h™dÀ
);

380 
îr
 = 
	`pxt4_ª£rve_öode_wrôe
(
h™dÀ
, 
öode
, &
ûoc
);

381 i‡(
îr
)

382 
Êags_îr
;

384 
i
 = 0, 
mask
 = 1; i < 32; i++, mask <<= 1) {

385 i‡(!(
mask
 & 
PXT4_FL_USER_MODIFIABLE
))

388 i‡(
mask
 =
PXT4_JOURNAL_DATA_FL
 || mask =
PXT4_EXTENTS_FL
)

390 i‡(
mask
 & 
Êags
)

391 
	`pxt4_£t_öode_Êag
(
öode
, 
i
);

393 
	`pxt4_˛ór_öode_Êag
(
öode
, 
i
);

396 
	`pxt4_£t_öode_Êags
(
öode
);

397 
öode
->
i_˘ime
 = 
	`cuºít_time
(inode);

399 
îr
 = 
	`pxt4_m¨k_ûoc_dúty
(
h™dÀ
, 
öode
, &
ûoc
);

400 
Êags_îr
:

401 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

402 i‡(
îr
)

403 
Êags_out
;

405 i‡((
jÊag
 ^ 
ﬁdÊags
Ë& (
PXT4_JOURNAL_DATA_FL
)) {

410 i‡(
	`ã°_›t
(
öode
->
i_sb
, 
DAX
)) {

411 
îr
 = -
EBUSY
;

412 
Êags_out
;

415 
îr
 = 
	`pxt4_ch™ge_öode_jou∫Æ_Êag
(
öode
, 
jÊag
);

416 i‡(
îr
)

417 
Êags_out
;

419 i‡(
migøã
) {

420 i‡(
Êags
 & 
PXT4_EXTENTS_FL
)

421 
îr
 = 
	`pxt4_ext_migøã
(
öode
);

423 
îr
 = 
	`pxt4_öd_migøã
(
öode
);

426 
Êags_out
:

427  
îr
;

428 
	}
}

430 #ifde‡
CONFIG_QUOTA


431 
	$pxt4_io˘l_£çroje˘
(
fûe
 *
fûp
, 
__u32
 
¥ojid
)

433 
öode
 *öodê
	`fûe_öode
(
fûp
);

434 
su≥r_block
 *
sb
 = 
öode
->
i_sb
;

435 
pxt4_öode_öfo
 *
ei
 = 
	`PXT4_I
(
öode
);

436 
îr
, 
rc
;

437 
h™dÀ_t
 *
h™dÀ
;

438 
k¥ojid_t
 
k¥ojid
;

439 
pxt4_ûoc
 
ûoc
;

440 
pxt4_öode
 *
øw_öode
;

441 
dquŸ
 *
å™s„r_to
[
MAXQUOTAS
] = { };

443 i‡(!
	`pxt4_has_„©uª_¥oje˘
(
sb
)) {

444 i‡(
¥ojid
 !
PXT4_DEF_PROJID
)

445  -
EOPNOTSUPP
;

450 i‡(
	`PXT4_INODE_SIZE
(
sb
Ë<
PXT4_GOOD_OLD_INODE_SIZE
)

451  -
EOPNOTSUPP
;

453 
k¥ojid
 = 
	`make_k¥ojid
(&
öô_u£r_ns
, (
¥ojid_t
)
¥ojid
);

455 i‡(
	`¥ojid_eq
(
k¥ojid
, 
	`PXT4_I
(
öode
)->
i_¥ojid
))

458 
îr
 = -
EPERM
;

460 i‡(
	`pxt4_is_quŸa_fûe
(
öode
))

461  
îr
;

463 
îr
 = 
	`pxt4_gë_öode_loc
(
öode
, &
ûoc
);

464 i‡(
îr
)

465  
îr
;

467 
øw_öode
 = 
	`pxt4_øw_öode
(&
ûoc
);

468 i‡(!
	`PXT4_FITS_IN_INODE
(
øw_öode
, 
ei
, 
i_¥ojid
)) {

469 
îr
 = 
	`pxt4_ex∑nd_exåa_isize
(
öode
,

470 
	`PXT4_SB
(
sb
)->
s_w™t_exåa_isize
,

471 &
ûoc
);

472 i‡(
îr
)

473  
îr
;

475 
	`bªl£
(
ûoc
.
bh
);

478 
îr
 = 
	`dquŸ_öôülize
(
öode
);

479 i‡(
îr
)

480  
îr
;

482 
h™dÀ
 = 
	`pxt4_jou∫Æ_°¨t
(
öode
, 
PXT4_HT_QUOTA
,

483 
	`PXT4_QUOTA_INIT_BLOCKS
(
sb
) +

484 
	`PXT4_QUOTA_DEL_BLOCKS
(
sb
) + 3);

485 i‡(
	`IS_ERR
(
h™dÀ
))

486  
	`PTR_ERR
(
h™dÀ
);

488 
îr
 = 
	`pxt4_ª£rve_öode_wrôe
(
h™dÀ
, 
öode
, &
ûoc
);

489 i‡(
îr
)

490 
out_°›
;

492 
å™s„r_to
[
PRJQUOTA
] = 
	`dqgë
(
sb
, 
	`make_kqid_¥ojid
(
k¥ojid
));

493 i‡(!
	`IS_ERR
(
å™s„r_to
[
PRJQUOTA
])) {

498 
	`down_ªad
(&
	`PXT4_I
(
öode
)->
x©å_£m
);

499 
îr
 = 
	`__dquŸ_å™s„r
(
öode
, 
å™s„r_to
);

500 
	`up_ªad
(&
	`PXT4_I
(
öode
)->
x©å_£m
);

501 
	`dqput
(
å™s„r_to
[
PRJQUOTA
]);

502 i‡(
îr
)

503 
out_dúty
;

506 
	`PXT4_I
(
öode
)->
i_¥ojid
 = 
k¥ojid
;

507 
öode
->
i_˘ime
 = 
	`cuºít_time
(inode);

508 
out_dúty
:

509 
rc
 = 
	`pxt4_m¨k_ûoc_dúty
(
h™dÀ
, 
öode
, &
ûoc
);

510 i‡(!
îr
)

511 
îr
 = 
rc
;

512 
out_°›
:

513 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

514  
îr
;

515 
	}
}

517 
	$pxt4_io˘l_£çroje˘
(
fûe
 *
fûp
, 
__u32
 
¥ojid
)

519 i‡(
¥ojid
 !
PXT4_DEF_PROJID
)

520  -
EOPNOTSUPP
;

522 
	}
}

526 
ölöe
 
__u32
 
	$pxt4_iÊags_to_xÊags
(
iÊags
)

528 
__u32
 
xÊags
 = 0;

530 i‡(
iÊags
 & 
PXT4_SYNC_FL
)

531 
xÊags
 |
FS_XFLAG_SYNC
;

532 i‡(
iÊags
 & 
PXT4_IMMUTABLE_FL
)

533 
xÊags
 |
FS_XFLAG_IMMUTABLE
;

534 i‡(
iÊags
 & 
PXT4_APPEND_FL
)

535 
xÊags
 |
FS_XFLAG_APPEND
;

536 i‡(
iÊags
 & 
PXT4_NODUMP_FL
)

537 
xÊags
 |
FS_XFLAG_NODUMP
;

538 i‡(
iÊags
 & 
PXT4_NOATIME_FL
)

539 
xÊags
 |
FS_XFLAG_NOATIME
;

540 i‡(
iÊags
 & 
PXT4_PROJINHERIT_FL
)

541 
xÊags
 |
FS_XFLAG_PROJINHERIT
;

542  
xÊags
;

543 
	}
}

545 
	#PXT4_SUPPORTED_FS_XFLAGS
 (
FS_XFLAG_SYNC
 | 
FS_XFLAG_IMMUTABLE
 | \

546 
FS_XFLAG_APPEND
 | 
FS_XFLAG_NODUMP
 | \

547 
FS_XFLAG_NOATIME
 | 
FS_XFLAG_PROJINHERIT
)

	)

550 
ölöe
 
	$pxt4_xÊags_to_iÊags
(
__u32
 
xÊags
)

552 
iÊags
 = 0;

554 i‡(
xÊags
 & 
FS_XFLAG_SYNC
)

555 
iÊags
 |
PXT4_SYNC_FL
;

556 i‡(
xÊags
 & 
FS_XFLAG_IMMUTABLE
)

557 
iÊags
 |
PXT4_IMMUTABLE_FL
;

558 i‡(
xÊags
 & 
FS_XFLAG_APPEND
)

559 
iÊags
 |
PXT4_APPEND_FL
;

560 i‡(
xÊags
 & 
FS_XFLAG_NODUMP
)

561 
iÊags
 |
PXT4_NODUMP_FL
;

562 i‡(
xÊags
 & 
FS_XFLAG_NOATIME
)

563 
iÊags
 |
PXT4_NOATIME_FL
;

564 i‡(
xÊags
 & 
FS_XFLAG_PROJINHERIT
)

565 
iÊags
 |
PXT4_PROJINHERIT_FL
;

567  
iÊags
;

568 
	}
}

570 
	$pxt4_shutdown
(
su≥r_block
 *
sb
, 
¨g
)

572 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
sb
);

573 
__u32
 
Êags
;

575 i‡(!
	`ˇ∑bÀ
(
CAP_SYS_ADMIN
))

576  -
EPERM
;

578 i‡(
	`gë_u£r
(
Êags
, (
__u32
 
__u£r
 *)
¨g
))

579  -
EFAULT
;

581 i‡(
Êags
 > 
PXT4_GOING_FLAGS_NOLOGFLUSH
)

582  -
EINVAL
;

584 i‡(
	`pxt4_f‹˚d_shutdown
(
sbi
))

587 
	`pxt4_msg
(
sb
, 
KERN_ALERT
, "shuàdow¿ªque°ed (%d)", 
Êags
);

588 
	`åa˚_pxt4_shutdown
(
sb
, 
Êags
);

590 
Êags
) {

591 
PXT4_GOING_FLAGS_DEFAULT
:

592 
	`‰ìze_bdev
(
sb
->
s_bdev
);

593 
	`£t_bô
(
PXT4_FLAGS_SHUTDOWN
, &
sbi
->
s_pxt4_Êags
);

594 
	`thaw_bdev
(
sb
->
s_bdev
, sb);

596 
PXT4_GOING_FLAGS_LOGFLUSH
:

597 
	`£t_bô
(
PXT4_FLAGS_SHUTDOWN
, &
sbi
->
s_pxt4_Êags
);

598 i‡(
sbi
->
s_jou∫Æ
 && !
	`is_jou∫Æ_ab‹ãd
(sbi->s_journal)) {

599 (Ë
	`pxt4_f‹˚_commô
(
sb
);

600 
	`jbd3_jou∫Æ_ab‹t
(
sbi
->
s_jou∫Æ
, -
ESHUTDOWN
);

603 
PXT4_GOING_FLAGS_NOLOGFLUSH
:

604 
	`£t_bô
(
PXT4_FLAGS_SHUTDOWN
, &
sbi
->
s_pxt4_Êags
);

605 i‡(
sbi
->
s_jou∫Æ
 && !
	`is_jou∫Æ_ab‹ãd
(sbi->s_journal))

606 
	`jbd3_jou∫Æ_ab‹t
(
sbi
->
s_jou∫Æ
, -
ESHUTDOWN
);

609  -
EINVAL
;

611 
	`˛ór_›t
(
sb
, 
DISCARD
);

613 
	}
}

615 
	sgëfsm≠_öfo
 {

616 
su≥r_block
 *
	mgi_sb
;

617 
fsm≠_hód
 
__u£r
 *
	mgi_d©a
;

618 
	mgi_idx
;

619 
__u32
 
	mgi_œ°_Êags
;

622 
	$pxt4_gëfsm≠_f‹m©
(
pxt4_fsm≠
 *
xfm
, *
¥iv
)

624 
gëfsm≠_öfo
 *
öfo
 = 
¥iv
;

625 
fsm≠
 
fm
;

627 
	`åa˚_pxt4_gëfsm≠_m≠pög
(
öfo
->
gi_sb
, 
xfm
);

629 
öfo
->
gi_œ°_Êags
 = 
xfm
->
fmr_Êags
;

630 
	`pxt4_fsm≠_‰om_öã∫Æ
(
öfo
->
gi_sb
, &
fm
, 
xfm
);

631 i‡(
	`c›y_to_u£r
(&
öfo
->
gi_d©a
->
fmh_ªcs
[öfo->
gi_idx
++], &
fm
,

632 (
fsm≠
)))

633  -
EFAULT
;

636 
	}
}

638 
	$pxt4_ioc_gëfsm≠
(
su≥r_block
 *
sb
,

639 
fsm≠_hód
 
__u£r
 *
¨g
)

641 
gëfsm≠_öfo
 
öfo
 = { 
NULL
 };

642 
pxt4_fsm≠_hód
 
xhód
 = {0};

643 
fsm≠_hód
 
hód
;

644 
boﬁ
 
ab‹ãd
 = 
Ál£
;

645 
îr‹
;

647 i‡(
	`c›y_‰om_u£r
(&
hód
, 
¨g
, (
fsm≠_hód
)))

648  -
EFAULT
;

649 i‡(
	`memchr_öv
(
hód
.
fmh_ª£rved
, 0, (head.fmh_reserved)) ||

650 
	`memchr_öv
(
hód
.
fmh_keys
[0].
fmr_ª£rved
, 0,

651 (
hód
.
fmh_keys
[0].
fmr_ª£rved
)) ||

652 
	`memchr_öv
(
hód
.
fmh_keys
[1].
fmr_ª£rved
, 0,

653 (
hód
.
fmh_keys
[1].
fmr_ª£rved
)))

654  -
EINVAL
;

659 i‡(
hód
.
fmh_keys
[0].
fmr_off£t
 ||

660 (
hód
.
fmh_keys
[1].
fmr_off£t
 != 0 &&

661 
hód
.
fmh_keys
[1].
fmr_off£t
 != -1ULL))

662  -
EINVAL
;

664 
xhód
.
fmh_iÊags
 = 
hód
.fmh_iflags;

665 
xhód
.
fmh_cou¡
 = 
hód
.fmh_count;

666 
	`pxt4_fsm≠_to_öã∫Æ
(
sb
, &
xhód
.
fmh_keys
[0], &
hód
.fmh_keys[0]);

667 
	`pxt4_fsm≠_to_öã∫Æ
(
sb
, &
xhód
.
fmh_keys
[1], &
hód
.fmh_keys[1]);

669 
	`åa˚_pxt4_gëfsm≠_low_key
(
sb
, &
xhód
.
fmh_keys
[0]);

670 
	`åa˚_pxt4_gëfsm≠_high_key
(
sb
, &
xhód
.
fmh_keys
[1]);

672 
öfo
.
gi_sb
 = 
sb
;

673 
öfo
.
gi_d©a
 = 
¨g
;

674 
îr‹
 = 
	`pxt4_gëfsm≠
(
sb
, &
xhód
, 
pxt4_gëfsm≠_f‹m©
, &
öfo
);

675 i‡(
îr‹
 =
PXT4_QUERY_RANGE_ABORT
) {

676 
îr‹
 = 0;

677 
ab‹ãd
 = 
åue
;

678 } i‡(
îr‹
)

679  
îr‹
;

682 i‡(!
ab‹ãd
 && 
öfo
.
gi_idx
) {

683 
öfo
.
gi_œ°_Êags
 |
FMR_OF_LAST
;

684 i‡(
	`c›y_to_u£r
(&
öfo
.
gi_d©a
->
fmh_ªcs
[öfo.
gi_idx
 - 1].
fmr_Êags
,

685 &
öfo
.
gi_œ°_Êags
,

686 (
öfo
.
gi_œ°_Êags
)))

687  -
EFAULT
;

691 
hód
.
fmh_íåõs
 = 
xhód
.fmh_entries;

692 
hód
.
fmh_oÊags
 = 
xhód
.fmh_oflags;

693 i‡(
	`c›y_to_u£r
(
¨g
, &
hód
, (
fsm≠_hód
)))

694  -
EFAULT
;

697 
	}
}

699 
	$pxt4_io˘l_group_add
(
fûe
 *file,

700 
pxt4_√w_group_d©a
 *
öput
)

702 
su≥r_block
 *
sb
 = 
	`fûe_öode
(
fûe
)->
i_sb
;

703 
îr
, 
îr2
=0;

705 
îr
 = 
	`pxt4_ªsize_begö
(
sb
);

706 i‡(
îr
)

707  
îr
;

709 i‡(
	`pxt4_has_„©uª_bigÆloc
(
sb
)) {

710 
	`pxt4_msg
(
sb
, 
KERN_ERR
,

712 
îr
 = -
EOPNOTSUPP
;

713 
group_add_out
;

716 
îr
 = 
	`m¡_w™t_wrôe_fûe
(
fûe
);

717 i‡(
îr
)

718 
group_add_out
;

720 
îr
 = 
	`pxt4_group_add
(
sb
, 
öput
);

721 i‡(
	`PXT4_SB
(
sb
)->
s_jou∫Æ
) {

722 
	`jbd3_jou∫Æ_lock_upd©es
(
	`PXT4_SB
(
sb
)->
s_jou∫Æ
);

723 
îr2
 = 
	`jbd3_jou∫Æ_Êush
(
	`PXT4_SB
(
sb
)->
s_jou∫Æ
);

724 
	`jbd3_jou∫Æ_u∆ock_upd©es
(
	`PXT4_SB
(
sb
)->
s_jou∫Æ
);

726 i‡(
îr
 == 0)

727 
îr
 = 
îr2
;

728 
	`m¡_dr›_wrôe_fûe
(
fûe
);

729 i‡(!
îr
 && 
	`pxt4_has_group_desc_csum
(
sb
) &&

730 
	`ã°_›t
(
sb
, 
INIT_INODE_TABLE
))

731 
îr
 = 
	`pxt4_ªgi°î_li_ªque°
(
sb
, 
öput
->
group
);

732 
group_add_out
:

733 
	`pxt4_ªsize_íd
(
sb
);

734  
îr
;

735 
	}
}

737 
	$pxt4_fûl_fsx©å
(
öode
 *öode, 
fsx©å
 *
Á
)

739 
pxt4_öode_öfo
 *
ei
 = 
	`PXT4_I
(
öode
);

741 
	`sim∂e_fûl_fsx©å
(
Á
, 
	`pxt4_iÊags_to_xÊags
(
ei
->
i_Êags
 &

742 
PXT4_FL_USER_VISIBLE
));

744 i‡(
	`pxt4_has_„©uª_¥oje˘
(
öode
->
i_sb
))

745 
Á
->
fsx_¥ojid
 = 
	`‰om_k¥ojid
(&
öô_u£r_ns
, 
ei
->
i_¥ojid
);

746 
	}
}

749 
	$fõm≠_check_ønges
(
su≥r_block
 *
sb
,

750 
u64
 
°¨t
, u64 
Àn
, u64 *
√w_Àn
)

752 
u64
 
maxbyãs
 = (u64Ë
sb
->
s_maxbyãs
;

754 *
√w_Àn
 = 
Àn
;

756 i‡(
Àn
 == 0)

757  -
EINVAL
;

759 i‡(
°¨t
 > 
maxbyãs
)

760  -
EFBIG
;

765 i‡(
Àn
 > 
maxbyãs
 || (maxbyã†-ÜíË< 
°¨t
)

766 *
√w_Àn
 = 
maxbyãs
 - 
°¨t
;

769 
	}
}

772 
	#FIEMAP_MAX_EXTENTS
 (
UINT_MAX
 / (
fõm≠_exã¡
))

	)

774 
	$pxt4_io˘l_gë_es_ˇche
(
fûe
 *
fûp
, 
¨g
)

776 
fõm≠
 fiemap;

777 
fõm≠
 
__u£r
 *
ufõm≠
 = (fõm≠ __u£∏*Ë
¨g
;

778 
fõm≠_exã¡_öfo
 
fõöfo
 = { 0, };

779 
öode
 *öodê
	`fûe_öode
(
fûp
);

780 
su≥r_block
 *
sb
 = 
öode
->
i_sb
;

781 
u64
 
Àn
;

782 
îr‹
;

784 i‡(
	`c›y_‰om_u£r
(&
fõm≠
, 
ufõm≠
, (fiemap)))

785  -
EFAULT
;

787 i‡(
fõm≠
.
fm_exã¡_cou¡
 > 
FIEMAP_MAX_EXTENTS
)

788  -
EINVAL
;

790 
îr‹
 = 
	`fõm≠_check_ønges
(
sb
, 
fõm≠
.
fm_°¨t
, fõm≠.
fm_Àngth
,

791 &
Àn
);

792 i‡(
îr‹
)

793  
îr‹
;

795 
fõöfo
.
fi_Êags
 = 
fõm≠
.
fm_Êags
;

796 
fõöfo
.
fi_exã¡s_max
 = 
fõm≠
.
fm_exã¡_cou¡
;

797 
fõöfo
.
fi_exã¡s_°¨t
 = 
ufõm≠
->
fm_exã¡s
;

799 i‡(
fõm≠
.
fm_exã¡_cou¡
 != 0 &&

800 !
	`ac˚ss_ok
(
fõöfo
.
fi_exã¡s_°¨t
,

801 
fõöfo
.
fi_exã¡s_max
 * (
fõm≠_exã¡
)))

802  -
EFAULT
;

804 i‡(
fõöfo
.
fi_Êags
 & 
FIEMAP_FLAG_SYNC
)

805 
	`fûem≠_wrôe_™d_waô
(
öode
->
i_m≠pög
);

807 
îr‹
 = 
	`pxt4_gë_es_ˇche
(
öode
, &
fõöfo
, 
fõm≠
.
fm_°¨t
, 
Àn
);

808 
fõm≠
.
fm_Êags
 = 
fõöfo
.
fi_Êags
;

809 
fõm≠
.
fm_m≠≥d_exã¡s
 = 
fõöfo
.
fi_exã¡s_m≠≥d
;

810 i‡(
	`c›y_to_u£r
(
ufõm≠
, &
fõm≠
, (fiemap)))

811 
îr‹
 = -
EFAULT
;

813  
îr‹
;

814 
	}
}

816 
	$pxt4_io˘l
(
fûe
 *
fûp
, 
cmd
, 
¨g
)

818 
öode
 *öodê
	`fûe_öode
(
fûp
);

819 
su≥r_block
 *
sb
 = 
öode
->
i_sb
;

820 
pxt4_öode_öfo
 *
ei
 = 
	`PXT4_I
(
öode
);

821 
Êags
;

823 
	`pxt4_debug
("cmd = %u,árg = %lu\n", 
cmd
, 
¨g
);

825 
cmd
) {

826 
FS_IOC_GETFSMAP
:

827  
	`pxt4_ioc_gëfsm≠
(
sb
, (
__u£r
 *)
¨g
);

828 
PXT4_IOC_GETFLAGS
:

829 
Êags
 = 
ei
->
i_Êags
 & 
PXT4_FL_USER_VISIBLE
;

830 i‡(
	`S_ISREG
(
öode
->
i_mode
))

831 
Êags
 &~
PXT4_PROJINHERIT_FL
;

832  
	`put_u£r
(
Êags
, (
__u£r
 *Ë
¨g
);

833 
PXT4_IOC_SETFLAGS
: {

834 
îr
;

836 i‡(!
	`öode_ow√r_‹_ˇ∑bÀ
(
öode
))

837  -
EACCES
;

839 i‡(
	`gë_u£r
(
Êags
, (
__u£r
 *Ë
¨g
))

840  -
EFAULT
;

842 i‡(
Êags
 & ~
PXT4_FL_USER_VISIBLE
)

843  -
EOPNOTSUPP
;

850 
Êags
 &
PXT4_FL_USER_MODIFIABLE
;

851 i‡(
	`pxt4_mask_Êags
(
öode
->
i_mode
, 
Êags
) != flags)

852  -
EOPNOTSUPP
;

854 
îr
 = 
	`m¡_w™t_wrôe_fûe
(
fûp
);

855 i‡(
îr
)

856  
îr
;

858 
	`öode_lock
(
öode
);

859 
îr
 = 
	`pxt4_io˘l_check_immuèbÀ
(
öode
,

860 
	`‰om_k¥ojid
(&
öô_u£r_ns
, 
ei
->
i_¥ojid
),

861 
Êags
);

862 i‡(!
îr
)

863 
îr
 = 
	`pxt4_io˘l_£tÊags
(
öode
, 
Êags
);

864 
	`öode_u∆ock
(
öode
);

865 
	`m¡_dr›_wrôe_fûe
(
fûp
);

866  
îr
;

868 
PXT4_IOC_GETVERSION
:

869 
PXT4_IOC_GETVERSION_OLD
:

870  
	`put_u£r
(
öode
->
i_gíî©i⁄
, (
__u£r
 *Ë
¨g
);

871 
PXT4_IOC_SETVERSION
:

872 
PXT4_IOC_SETVERSION_OLD
: {

873 
h™dÀ_t
 *
h™dÀ
;

874 
pxt4_ûoc
 
ûoc
;

875 
__u32
 
gíî©i⁄
;

876 
îr
;

878 i‡(!
	`öode_ow√r_‹_ˇ∑bÀ
(
öode
))

879  -
EPERM
;

881 i‡(
	`pxt4_has_mëad©a_csum
(
öode
->
i_sb
)) {

882 
	`pxt4_w¨nög
(
sb
, "Setting inode version isÇot "

884  -
ENOTTY
;

887 
îr
 = 
	`m¡_w™t_wrôe_fûe
(
fûp
);

888 i‡(
îr
)

889  
îr
;

890 i‡(
	`gë_u£r
(
gíî©i⁄
, (
__u£r
 *Ë
¨g
)) {

891 
îr
 = -
EFAULT
;

892 
£tvîsi⁄_out
;

895 
	`öode_lock
(
öode
);

896 
h™dÀ
 = 
	`pxt4_jou∫Æ_°¨t
(
öode
, 
PXT4_HT_INODE
, 1);

897 i‡(
	`IS_ERR
(
h™dÀ
)) {

898 
îr
 = 
	`PTR_ERR
(
h™dÀ
);

899 
u∆ock_out
;

901 
îr
 = 
	`pxt4_ª£rve_öode_wrôe
(
h™dÀ
, 
öode
, &
ûoc
);

902 i‡(
îr
 == 0) {

903 
öode
->
i_˘ime
 = 
	`cuºít_time
(inode);

904 
öode
->
i_gíî©i⁄
 = 
gíî©i⁄
;

905 
îr
 = 
	`pxt4_m¨k_ûoc_dúty
(
h™dÀ
, 
öode
, &
ûoc
);

907 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

909 
u∆ock_out
:

910 
	`öode_u∆ock
(
öode
);

911 
£tvîsi⁄_out
:

912 
	`m¡_dr›_wrôe_fûe
(
fûp
);

913  
îr
;

915 
PXT4_IOC_GROUP_EXTEND
: {

916 
pxt4_fsblk_t
 
n_blocks_cou¡
;

917 
îr
, 
îr2
=0;

919 
îr
 = 
	`pxt4_ªsize_begö
(
sb
);

920 i‡(
îr
)

921  
îr
;

923 i‡(
	`gë_u£r
(
n_blocks_cou¡
, (
__u32
 
__u£r
 *)
¨g
)) {

924 
îr
 = -
EFAULT
;

925 
group_exãnd_out
;

928 i‡(
	`pxt4_has_„©uª_bigÆloc
(
sb
)) {

929 
	`pxt4_msg
(
sb
, 
KERN_ERR
,

931 
îr
 = -
EOPNOTSUPP
;

932 
group_exãnd_out
;

935 
îr
 = 
	`m¡_w™t_wrôe_fûe
(
fûp
);

936 i‡(
îr
)

937 
group_exãnd_out
;

939 
îr
 = 
	`pxt4_group_exãnd
(
sb
, 
	`PXT4_SB
(sb)->
s_es
, 
n_blocks_cou¡
);

940 i‡(
	`PXT4_SB
(
sb
)->
s_jou∫Æ
) {

941 
	`jbd3_jou∫Æ_lock_upd©es
(
	`PXT4_SB
(
sb
)->
s_jou∫Æ
);

942 
îr2
 = 
	`jbd3_jou∫Æ_Êush
(
	`PXT4_SB
(
sb
)->
s_jou∫Æ
);

943 
	`jbd3_jou∫Æ_u∆ock_upd©es
(
	`PXT4_SB
(
sb
)->
s_jou∫Æ
);

945 i‡(
îr
 == 0)

946 
îr
 = 
îr2
;

947 
	`m¡_dr›_wrôe_fûe
(
fûp
);

948 
group_exãnd_out
:

949 
	`pxt4_ªsize_íd
(
sb
);

950  
îr
;

953 
PXT4_IOC_MOVE_EXT
: {

954 
move_exã¡
 
me
;

955 
fd
 
d⁄‹
;

956 
îr
;

958 i‡(!(
fûp
->
f_mode
 & 
FMODE_READ
) ||

959 !(
fûp
->
f_mode
 & 
FMODE_WRITE
))

960  -
EBADF
;

962 i‡(
	`c›y_‰om_u£r
(&
me
,

963 (
move_exã¡
 
__u£r
 *)
¨g
, (
me
)))

964  -
EFAULT
;

965 
me
.
moved_Àn
 = 0;

967 
d⁄‹
 = 
	`fdgë
(
me
.
d⁄‹_fd
);

968 i‡(!
d⁄‹
.
fûe
)

969  -
EBADF
;

971 i‡(!(
d⁄‹
.
fûe
->
f_mode
 & 
FMODE_WRITE
)) {

972 
îr
 = -
EBADF
;

973 
mext_out
;

976 i‡(
	`pxt4_has_„©uª_bigÆloc
(
sb
)) {

977 
	`pxt4_msg
(
sb
, 
KERN_ERR
,

979 
îr
 = -
EOPNOTSUPP
;

980 
mext_out
;

981 } i‡(
	`IS_DAX
(
öode
)) {

982 
	`pxt4_msg
(
sb
, 
KERN_ERR
,

984 
îr
 = -
EOPNOTSUPP
;

985 
mext_out
;

988 
îr
 = 
	`m¡_w™t_wrôe_fûe
(
fûp
);

989 i‡(
îr
)

990 
mext_out
;

992 
îr
 = 
	`pxt4_move_exã¡s
(
fûp
, 
d⁄‹
.
fûe
, 
me
.
‹ig_°¨t
,

993 
me
.
d⁄‹_°¨t
, me.
Àn
, &me.
moved_Àn
);

994 
	`m¡_dr›_wrôe_fûe
(
fûp
);

996 i‡(
	`c›y_to_u£r
((
move_exã¡
 
__u£r
 *)
¨g
,

997 &
me
, (me)))

998 
îr
 = -
EFAULT
;

999 
mext_out
:

1000 
	`fdput
(
d⁄‹
);

1001  
îr
;

1004 
PXT4_IOC_GROUP_ADD
: {

1005 
pxt4_√w_group_d©a
 
öput
;

1007 i‡(
	`c›y_‰om_u£r
(&
öput
, (
pxt4_√w_group_öput
 
__u£r
 *)
¨g
,

1008 (
öput
)))

1009  -
EFAULT
;

1011  
	`pxt4_io˘l_group_add
(
fûp
, &
öput
);

1014 
PXT4_IOC_MIGRATE
:

1016 
îr
;

1017 i‡(!
	`öode_ow√r_‹_ˇ∑bÀ
(
öode
))

1018  -
EACCES
;

1020 
îr
 = 
	`m¡_w™t_wrôe_fûe
(
fûp
);

1021 i‡(
îr
)

1022  
îr
;

1029 
	`öode_lock
((
öode
));

1030 
îr
 = 
	`pxt4_ext_migøã
(
öode
);

1031 
	`öode_u∆ock
((
öode
));

1032 
	`m¡_dr›_wrôe_fûe
(
fûp
);

1033  
îr
;

1036 
PXT4_IOC_ALLOC_DA_BLKS
:

1038 
îr
;

1039 i‡(!
	`öode_ow√r_‹_ˇ∑bÀ
(
öode
))

1040  -
EACCES
;

1042 
îr
 = 
	`m¡_w™t_wrôe_fûe
(
fûp
);

1043 i‡(
îr
)

1044  
îr
;

1045 
îr
 = 
	`pxt4_Æloc_da_blocks
(
öode
);

1046 
	`m¡_dr›_wrôe_fûe
(
fûp
);

1047  
îr
;

1050 
PXT4_IOC_SWAP_BOOT
:

1052 
îr
;

1053 i‡(!(
fûp
->
f_mode
 & 
FMODE_WRITE
))

1054  -
EBADF
;

1055 
îr
 = 
	`m¡_w™t_wrôe_fûe
(
fûp
);

1056 i‡(
îr
)

1057  
îr
;

1058 
îr
 = 
	`sw≠_öode_boŸ_lﬂdî
(
sb
, 
öode
);

1059 
	`m¡_dr›_wrôe_fûe
(
fûp
);

1060  
îr
;

1063 
PXT4_IOC_RESIZE_FS
: {

1064 
pxt4_fsblk_t
 
n_blocks_cou¡
;

1065 
îr
 = 0, 
îr2
 = 0;

1066 
pxt4_group_t
 
o_group
 = 
	`PXT4_SB
(
sb
)->
s_groups_cou¡
;

1068 i‡(
	`c›y_‰om_u£r
(&
n_blocks_cou¡
, (
__u64
 
__u£r
 *)
¨g
,

1069 (
__u64
))) {

1070  -
EFAULT
;

1073 
îr
 = 
	`pxt4_ªsize_begö
(
sb
);

1074 i‡(
îr
)

1075  
îr
;

1077 
îr
 = 
	`m¡_w™t_wrôe_fûe
(
fûp
);

1078 i‡(
îr
)

1079 
ªsizefs_out
;

1081 
îr
 = 
	`pxt4_ªsize_fs
(
sb
, 
n_blocks_cou¡
);

1082 i‡(
	`PXT4_SB
(
sb
)->
s_jou∫Æ
) {

1083 
	`jbd3_jou∫Æ_lock_upd©es
(
	`PXT4_SB
(
sb
)->
s_jou∫Æ
);

1084 
îr2
 = 
	`jbd3_jou∫Æ_Êush
(
	`PXT4_SB
(
sb
)->
s_jou∫Æ
);

1085 
	`jbd3_jou∫Æ_u∆ock_upd©es
(
	`PXT4_SB
(
sb
)->
s_jou∫Æ
);

1087 i‡(
îr
 == 0)

1088 
îr
 = 
îr2
;

1089 
	`m¡_dr›_wrôe_fûe
(
fûp
);

1090 i‡(!
îr
 && (
o_group
 < 
	`PXT4_SB
(
sb
)->
s_groups_cou¡
) &&

1091 
	`pxt4_has_group_desc_csum
(
sb
) &&

1092 
	`ã°_›t
(
sb
, 
INIT_INODE_TABLE
))

1093 
îr
 = 
	`pxt4_ªgi°î_li_ªque°
(
sb
, 
o_group
);

1095 
ªsizefs_out
:

1096 
	`pxt4_ªsize_íd
(
sb
);

1097  
îr
;

1100 
FITRIM
:

1102 
ªque°_queue
 *
q
 = 
	`bdev_gë_queue
(
sb
->
s_bdev
);

1103 
f°rim_ønge
 
ønge
;

1104 
ªt
 = 0;

1106 i‡(!
	`ˇ∑bÀ
(
CAP_SYS_ADMIN
))

1107  -
EPERM
;

1109 i‡(!
	`blk_queue_disˇrd
(
q
))

1110  -
EOPNOTSUPP
;

1116 i‡(
	`ã°_›t
(
sb
, 
NOLOAD
Ë&& 
	`pxt4_has_„©uª_jou∫Æ
(sb))

1117  -
EROFS
;

1119 i‡(
	`c›y_‰om_u£r
(&
ønge
, (
f°rim_ønge
 
__u£r
 *)
¨g
,

1120 (
ønge
)))

1121  -
EFAULT
;

1123 
ønge
.
möÀn
 = 
	`max
(()range.minlen,

1124 
q
->
limôs
.
disˇrd_gønuœrôy
);

1125 
ªt
 = 
	`pxt4_åim_fs
(
sb
, &
ønge
);

1126 i‡(
ªt
 < 0)

1127  
ªt
;

1129 i‡(
	`c›y_to_u£r
((
f°rim_ønge
 
__u£r
 *)
¨g
, &
ønge
,

1130 (
ønge
)))

1131  -
EFAULT
;

1135 
PXT4_IOC_PRECACHE_EXTENTS
:

1136  
	`pxt4_ext_¥eˇche
(
öode
);

1138 
PXT4_IOC_SET_ENCRYPTION_POLICY
:

1139 i‡(!
	`pxt4_has_„©uª_í¸y±
(
sb
))

1140  -
EOPNOTSUPP
;

1141  
	`fs¸y±_io˘l_£t_pﬁicy
(
fûp
, (c⁄° 
__u£r
 *)
¨g
);

1143 
PXT4_IOC_GET_ENCRYPTION_PWSALT
: {

1144 #ifde‡
CONFIG_FS_ENCRYPTION


1145 
îr
, 
îr2
;

1146 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
sb
);

1147 
h™dÀ_t
 *
h™dÀ
;

1149 i‡(!
	`pxt4_has_„©uª_í¸y±
(
sb
))

1150  -
EOPNOTSUPP
;

1151 i‡(
	`uuid_is_zîo
(
sbi
->
s_es
->
s_í¸y±_pw_ß…
)) {

1152 
îr
 = 
	`m¡_w™t_wrôe_fûe
(
fûp
);

1153 i‡(
îr
)

1154  
îr
;

1155 
h™dÀ
 = 
	`pxt4_jou∫Æ_°¨t_sb
(
sb
, 
PXT4_HT_MISC
, 1);

1156 i‡(
	`IS_ERR
(
h™dÀ
)) {

1157 
îr
 = 
	`PTR_ERR
(
h™dÀ
);

1158 
pwß…_îr_exô
;

1160 
îr
 = 
	`pxt4_jou∫Æ_gë_wrôe_ac˚ss
(
h™dÀ
, 
sbi
->
s_sbh
);

1161 i‡(
îr
)

1162 
pwß…_îr_jou∫Æ
;

1163 
	`lock_buf„r
(
sbi
->
s_sbh
);

1164 
	`gíî©e_øndom_uuid
(
sbi
->
s_es
->
s_í¸y±_pw_ß…
);

1165 
	`pxt4_su≥rblock_csum_£t
(
sb
);

1166 
	`u∆ock_buf„r
(
sbi
->
s_sbh
);

1167 
îr
 = 
	`pxt4_h™dÀ_dúty_mëad©a
(
h™dÀ
, 
NULL
,

1168 
sbi
->
s_sbh
);

1169 
pwß…_îr_jou∫Æ
:

1170 
îr2
 = 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

1171 i‡(
îr2
 && !
îr
)

1172 
îr
 = 
îr2
;

1173 
pwß…_îr_exô
:

1174 
	`m¡_dr›_wrôe_fûe
(
fûp
);

1175 i‡(
îr
)

1176  
îr
;

1178 i‡(
	`c›y_to_u£r
((
__u£r
 *Ë
¨g
,

1179 
sbi
->
s_es
->
s_í¸y±_pw_ß…
, 16))

1180  -
EFAULT
;

1183  -
EOPNOTSUPP
;

1186 
PXT4_IOC_GET_ENCRYPTION_POLICY
:

1187 i‡(!
	`pxt4_has_„©uª_í¸y±
(
sb
))

1188  -
EOPNOTSUPP
;

1189  
	`fs¸y±_io˘l_gë_pﬁicy
(
fûp
, (
__u£r
 *)
¨g
);

1191 
FS_IOC_GET_ENCRYPTION_POLICY_EX
:

1192 i‡(!
	`pxt4_has_„©uª_í¸y±
(
sb
))

1193  -
EOPNOTSUPP
;

1194  
	`fs¸y±_io˘l_gë_pﬁicy_ex
(
fûp
, (
__u£r
 *)
¨g
);

1196 
FS_IOC_ADD_ENCRYPTION_KEY
:

1197 i‡(!
	`pxt4_has_„©uª_í¸y±
(
sb
))

1198  -
EOPNOTSUPP
;

1199  
	`fs¸y±_io˘l_add_key
(
fûp
, (
__u£r
 *)
¨g
);

1201 
FS_IOC_REMOVE_ENCRYPTION_KEY
:

1202 i‡(!
	`pxt4_has_„©uª_í¸y±
(
sb
))

1203  -
EOPNOTSUPP
;

1204  
	`fs¸y±_io˘l_ªmove_key
(
fûp
, (
__u£r
 *)
¨g
);

1206 
FS_IOC_REMOVE_ENCRYPTION_KEY_ALL_USERS
:

1207 i‡(!
	`pxt4_has_„©uª_í¸y±
(
sb
))

1208  -
EOPNOTSUPP
;

1209  
	`fs¸y±_io˘l_ªmove_key_Æl_u£rs
(
fûp
,

1210 (
__u£r
 *)
¨g
);

1211 
FS_IOC_GET_ENCRYPTION_KEY_STATUS
:

1212 i‡(!
	`pxt4_has_„©uª_í¸y±
(
sb
))

1213  -
EOPNOTSUPP
;

1214  
	`fs¸y±_io˘l_gë_key_°©us
(
fûp
, (
__u£r
 *)
¨g
);

1216 
PXT4_IOC_CLEAR_ES_CACHE
:

1218 i‡(!
	`öode_ow√r_‹_ˇ∑bÀ
(
öode
))

1219  -
EACCES
;

1220 
	`pxt4_˛ór_öode_es
(
öode
);

1224 
PXT4_IOC_GETSTATE
:

1226 
__u32
 
°©e
 = 0;

1228 i‡(
	`pxt4_ã°_öode_°©e
(
öode
, 
PXT4_STATE_EXT_PRECACHED
))

1229 
°©e
 |
PXT4_STATE_FLAG_EXT_PRECACHED
;

1230 i‡(
	`pxt4_ã°_öode_°©e
(
öode
, 
PXT4_STATE_NEW
))

1231 
°©e
 |
PXT4_STATE_FLAG_NEW
;

1232 i‡(
	`pxt4_ã°_öode_°©e
(
öode
, 
PXT4_STATE_NEWENTRY
))

1233 
°©e
 |
PXT4_STATE_FLAG_NEWENTRY
;

1234 i‡(
	`pxt4_ã°_öode_°©e
(
öode
, 
PXT4_STATE_DA_ALLOC_CLOSE
))

1235 
°©e
 |
PXT4_STATE_FLAG_DA_ALLOC_CLOSE
;

1237  
	`put_u£r
(
°©e
, (
__u32
 
__u£r
 *Ë
¨g
);

1240 
PXT4_IOC_GET_ES_CACHE
:

1241  
	`pxt4_io˘l_gë_es_ˇche
(
fûp
, 
¨g
);

1243 
PXT4_IOC_FSGETXATTR
:

1245 
fsx©å
 
Á
;

1247 
	`pxt4_fûl_fsx©å
(
öode
, &
Á
);

1249 i‡(
	`c›y_to_u£r
((
fsx©å
 
__u£r
 *)
¨g
,

1250 &
Á
, (fa)))

1251  -
EFAULT
;

1254 
PXT4_IOC_FSSETXATTR
:

1256 
fsx©å
 
Á
, 
ﬁd_Á
;

1257 
îr
;

1259 i‡(
	`c›y_‰om_u£r
(&
Á
, (
fsx©å
 
__u£r
 *)
¨g
,

1260 (
Á
)))

1261  -
EFAULT
;

1264 i‡(!
	`öode_ow√r_‹_ˇ∑bÀ
(
öode
))

1265  -
EACCES
;

1267 i‡(
Á
.
fsx_xÊags
 & ~
PXT4_SUPPORTED_FS_XFLAGS
)

1268  -
EOPNOTSUPP
;

1270 
Êags
 = 
	`pxt4_xÊags_to_iÊags
(
Á
.
fsx_xÊags
);

1271 i‡(
	`pxt4_mask_Êags
(
öode
->
i_mode
, 
Êags
) != flags)

1272  -
EOPNOTSUPP
;

1274 
îr
 = 
	`m¡_w™t_wrôe_fûe
(
fûp
);

1275 i‡(
îr
)

1276  
îr
;

1278 
	`öode_lock
(
öode
);

1279 
	`pxt4_fûl_fsx©å
(
öode
, &
ﬁd_Á
);

1280 
îr
 = 
	`vfs_ioc_fs£tx©å_check
(
öode
, &
ﬁd_Á
, &
Á
);

1281 i‡(
îr
)

1282 
out
;

1283 
Êags
 = (
ei
->
i_Êags
 & ~
PXT4_FL_XFLAG_VISIBLE
) |

1284 (
Êags
 & 
PXT4_FL_XFLAG_VISIBLE
);

1285 
îr
 = 
	`pxt4_io˘l_check_immuèbÀ
(
öode
, 
Á
.
fsx_¥ojid
, 
Êags
);

1286 i‡(
îr
)

1287 
out
;

1288 
îr
 = 
	`pxt4_io˘l_£tÊags
(
öode
, 
Êags
);

1289 i‡(
îr
)

1290 
out
;

1291 
îr
 = 
	`pxt4_io˘l_£çroje˘
(
fûp
, 
Á
.
fsx_¥ojid
);

1292 
out
:

1293 
	`öode_u∆ock
(
öode
);

1294 
	`m¡_dr›_wrôe_fûe
(
fûp
);

1295  
îr
;

1297 
PXT4_IOC_SHUTDOWN
:

1298  
	`pxt4_shutdown
(
sb
, 
¨g
);

1300 
FS_IOC_ENABLE_VERITY
:

1301 i‡(!
	`pxt4_has_„©uª_vîôy
(
sb
))

1302  -
EOPNOTSUPP
;

1303  
	`fsvîôy_io˘l_íabÀ
(
fûp
, (c⁄° 
__u£r
 *)
¨g
);

1305 
FS_IOC_MEASURE_VERITY
:

1306 i‡(!
	`pxt4_has_„©uª_vîôy
(
sb
))

1307  -
EOPNOTSUPP
;

1308  
	`fsvîôy_io˘l_mósuª
(
fûp
, (
__u£r
 *)
¨g
);

1311  -
ENOTTY
;

1313 
	}
}

1315 #ifde‡
CONFIG_COMPAT


1316 
	$pxt4_com∑t_io˘l
(
fûe
 *fûe, 
cmd
, 
¨g
)

1319 
cmd
) {

1320 
PXT4_IOC32_GETFLAGS
:

1321 
cmd
 = 
PXT4_IOC_GETFLAGS
;

1323 
PXT4_IOC32_SETFLAGS
:

1324 
cmd
 = 
PXT4_IOC_SETFLAGS
;

1326 
PXT4_IOC32_GETVERSION
:

1327 
cmd
 = 
PXT4_IOC_GETVERSION
;

1329 
PXT4_IOC32_SETVERSION
:

1330 
cmd
 = 
PXT4_IOC_SETVERSION
;

1332 
PXT4_IOC32_GROUP_EXTEND
:

1333 
cmd
 = 
PXT4_IOC_GROUP_EXTEND
;

1335 
PXT4_IOC32_GETVERSION_OLD
:

1336 
cmd
 = 
PXT4_IOC_GETVERSION_OLD
;

1338 
PXT4_IOC32_SETVERSION_OLD
:

1339 
cmd
 = 
PXT4_IOC_SETVERSION_OLD
;

1341 
PXT4_IOC32_GETRSVSZ
:

1342 
cmd
 = 
PXT4_IOC_GETRSVSZ
;

1344 
PXT4_IOC32_SETRSVSZ
:

1345 
cmd
 = 
PXT4_IOC_SETRSVSZ
;

1347 
PXT4_IOC32_GROUP_ADD
: {

1348 
com∑t_pxt4_√w_group_öput
 
__u£r
 *
uöput
;

1349 
pxt4_√w_group_d©a
 
öput
;

1350 
îr
;

1352 
uöput
 = 
	`com∑t_±r
(
¨g
);

1353 
îr
 = 
	`gë_u£r
(
öput
.
group
, &
uöput
->group);

1354 
îr
 |
	`gë_u£r
(
öput
.
block_bôm≠
, &
uöput
->block_bitmap);

1355 
îr
 |
	`gë_u£r
(
öput
.
öode_bôm≠
, &
uöput
->inode_bitmap);

1356 
îr
 |
	`gë_u£r
(
öput
.
öode_èbÀ
, &
uöput
->inode_table);

1357 
îr
 |
	`gë_u£r
(
öput
.
blocks_cou¡
, &
uöput
->blocks_count);

1358 
îr
 |
	`gë_u£r
(
öput
.
ª£rved_blocks
,

1359 &
uöput
->
ª£rved_blocks
);

1360 i‡(
îr
)

1361  -
EFAULT
;

1362  
	`pxt4_io˘l_group_add
(
fûe
, &
öput
);

1364 
PXT4_IOC_MOVE_EXT
:

1365 
PXT4_IOC_RESIZE_FS
:

1366 
PXT4_IOC_PRECACHE_EXTENTS
:

1367 
PXT4_IOC_SET_ENCRYPTION_POLICY
:

1368 
PXT4_IOC_GET_ENCRYPTION_PWSALT
:

1369 
PXT4_IOC_GET_ENCRYPTION_POLICY
:

1370 
FS_IOC_GET_ENCRYPTION_POLICY_EX
:

1371 
FS_IOC_ADD_ENCRYPTION_KEY
:

1372 
FS_IOC_REMOVE_ENCRYPTION_KEY
:

1373 
FS_IOC_REMOVE_ENCRYPTION_KEY_ALL_USERS
:

1374 
FS_IOC_GET_ENCRYPTION_KEY_STATUS
:

1375 
PXT4_IOC_SHUTDOWN
:

1376 
FS_IOC_GETFSMAP
:

1377 
FS_IOC_ENABLE_VERITY
:

1378 
FS_IOC_MEASURE_VERITY
:

1379 
PXT4_IOC_CLEAR_ES_CACHE
:

1380 
PXT4_IOC_GETSTATE
:

1381 
PXT4_IOC_GET_ES_CACHE
:

1384  -
ENOIOCTLCMD
;

1386  
	`pxt4_io˘l
(
fûe
, 
cmd
, (Ë
	`com∑t_±r
(
¨g
));

1387 
	}
}

	@mballoc.c

12 
	~"pxt4_jbd3.h
"

13 
	~"mbÆloc.h
"

14 
	~<löux/log2.h
>

15 
	~<löux/moduÀ.h
>

16 
	~<löux/¶ab.h
>

17 
	~<löux/no•ec.h
>

18 
	~<löux/backög-dev.h
>

19 
	~<åa˚/evíts/pxt4.h
>

21 #ifde‡
CONFIG_PXT4_DEBUG


22 
ush‹t
 
pxt4_mbÆloc_debug
 
	g__ªad_mo°ly
;

24 
moduÀ_∑øm_«med
(
mbÆloc_debug
, 
pxt4_mbÆloc_debug
, 
ush‹t
, 0644);

25 
MODULE_PARM_DESC
(
mbÆloc_debug
, "DebuggingÜevel forÖxt4's mballoc");

339 
kmem_ˇche
 *
	gpxt4_p•a˚_ˇchï
;

340 
kmem_ˇche
 *
	gpxt4_ac_ˇchï
;

341 
kmem_ˇche
 *
	gpxt4_‰ì_d©a_ˇchï
;

346 
	#NR_GRPINFO_CACHES
 8

	)

347 
kmem_ˇche
 *
	gpxt4_groupöfo_ˇches
[
NR_GRPINFO_CACHES
];

349 c⁄° * c⁄° 
	gpxt4_groupöfo_¶ab_«mes
[
NR_GRPINFO_CACHES
] = {

355 
pxt4_mb_gíî©e_‰om_∑
(
su≥r_block
 *
sb
, *
bôm≠
,

356 
pxt4_group_t
 
group
);

357 
pxt4_mb_gíî©e_‰om_‰ìli°
(
su≥r_block
 *
sb
, *
bôm≠
,

358 
pxt4_group_t
 
group
);

360 
ölöe
 *
	$mb_c‹ª˘_addr_™d_bô
(*
bô
, *
addr
)

362 #i‡
BITS_PER_LONG
 == 64

363 *
bô
 +((Ë
addr
 & 7UL) << 3;

364 
addr
 = (*) (()áddr & ~7UL);

365 #ñi‡
BITS_PER_LONG
 == 32

366 *
bô
 +((Ë
addr
 & 3UL) << 3;

367 
addr
 = (*) (()áddr & ~3UL);

371  
addr
;

372 
	}
}

374 
ölöe
 
	$mb_ã°_bô
(
bô
, *
addr
)

380 
addr
 = 
	`mb_c‹ª˘_addr_™d_bô
(&
bô
,áddr);

381  
	`pxt4_ã°_bô
(
bô
, 
addr
);

382 
	}
}

384 
ölöe
 
	$mb_£t_bô
(
bô
, *
addr
)

386 
addr
 = 
	`mb_c‹ª˘_addr_™d_bô
(&
bô
,áddr);

387 
	`pxt4_£t_bô
(
bô
, 
addr
);

388 
	}
}

390 
ölöe
 
	$mb_˛ór_bô
(
bô
, *
addr
)

392 
addr
 = 
	`mb_c‹ª˘_addr_™d_bô
(&
bô
,áddr);

393 
	`pxt4_˛ór_bô
(
bô
, 
addr
);

394 
	}
}

396 
ölöe
 
	$mb_ã°_™d_˛ór_bô
(
bô
, *
addr
)

398 
addr
 = 
	`mb_c‹ª˘_addr_™d_bô
(&
bô
,áddr);

399  
	`pxt4_ã°_™d_˛ór_bô
(
bô
, 
addr
);

400 
	}
}

402 
ölöe
 
	$mb_föd_√xt_zîo_bô
(*
addr
, 
max
, 
°¨t
)

404 
fix
 = 0, 
ªt
, 
tmpmax
;

405 
addr
 = 
	`mb_c‹ª˘_addr_™d_bô
(&
fix
,áddr);

406 
tmpmax
 = 
max
 + 
fix
;

407 
°¨t
 +
fix
;

409 
ªt
 = 
	`pxt4_föd_√xt_zîo_bô
(
addr
, 
tmpmax
, 
°¨t
Ë- 
fix
;

410 i‡(
ªt
 > 
max
)

411  
max
;

412  
ªt
;

413 
	}
}

415 
ölöe
 
	$mb_föd_√xt_bô
(*
addr
, 
max
, 
°¨t
)

417 
fix
 = 0, 
ªt
, 
tmpmax
;

418 
addr
 = 
	`mb_c‹ª˘_addr_™d_bô
(&
fix
,áddr);

419 
tmpmax
 = 
max
 + 
fix
;

420 
°¨t
 +
fix
;

422 
ªt
 = 
	`pxt4_föd_√xt_bô
(
addr
, 
tmpmax
, 
°¨t
Ë- 
fix
;

423 i‡(
ªt
 > 
max
)

424  
max
;

425  
ªt
;

426 
	}
}

428 *
	$mb_föd_buddy
(
pxt4_buddy
 *
e4b
, 
‹dî
, *
max
)

430 *
bb
;

432 
	`BUG_ON
(
e4b
->
bd_bôm≠
 =e4b->
bd_buddy
);

433 
	`BUG_ON
(
max
 =
NULL
);

435 i‡(
‹dî
 > 
e4b
->
bd_blkbôs
 + 1) {

436 *
max
 = 0;

437  
NULL
;

441 i‡(
‹dî
 == 0) {

442 *
max
 = 1 << (
e4b
->
bd_blkbôs
 + 3);

443  
e4b
->
bd_bôm≠
;

446 
bb
 = 
e4b
->
bd_buddy
 + 
	`PXT4_SB
”4b->
bd_sb
)->
s_mb_off£ts
[
‹dî
];

447 *
max
 = 
	`PXT4_SB
(
e4b
->
bd_sb
)->
s_mb_maxs
[
‹dî
];

449  
bb
;

450 
	}
}

452 #ifde‡
DOUBLE_CHECK


453 
	$mb_‰ì_blocks_doubÀ
(
öode
 *öode, 
pxt4_buddy
 *
e4b
,

454 
fú°
, 
cou¡
)

456 
i
;

457 
su≥r_block
 *
sb
 = 
e4b
->
bd_sb
;

459 i‡(
	`u∆ikñy
(
e4b
->
bd_öfo
->
bb_bôm≠
 =
NULL
))

461 
	`as£π_•ö_locked
(
	`pxt4_group_lock_±r
(
sb
, 
e4b
->
bd_group
));

462 
i
 = 0; i < 
cou¡
; i++) {

463 i‡(!
	`mb_ã°_bô
(
fú°
 + 
i
, 
e4b
->
bd_öfo
->
bb_bôm≠
)) {

464 
pxt4_fsblk_t
 
blockƒ
;

466 
blockƒ
 = 
	`pxt4_group_fú°_block_no
(
sb
, 
e4b
->
bd_group
);

467 
blockƒ
 +
	`PXT4_C2B
(
	`PXT4_SB
(
sb
), 
fú°
 + 
i
);

468 
	`pxt4_gΩ_locked_îr‹
(
sb
, 
e4b
->
bd_group
,

469 
öode
 ? inode->
i_öo
 : 0,

470 
blockƒ
,

473 
fú°
 + 
i
);

474 
	`pxt4_m¨k_group_bôm≠_c‹ru±ed
(
sb
, 
e4b
->
bd_group
,

475 
PXT4_GROUP_INFO_BBITMAP_CORRUPT
);

477 
	`mb_˛ór_bô
(
fú°
 + 
i
, 
e4b
->
bd_öfo
->
bb_bôm≠
);

479 
	}
}

481 
	$mb_m¨k_u£d_doubÀ
(
pxt4_buddy
 *
e4b
, 
fú°
, 
cou¡
)

483 
i
;

485 i‡(
	`u∆ikñy
(
e4b
->
bd_öfo
->
bb_bôm≠
 =
NULL
))

487 
	`as£π_•ö_locked
(
	`pxt4_group_lock_±r
(
e4b
->
bd_sb
,É4b->
bd_group
));

488 
i
 = 0; i < 
cou¡
; i++) {

489 
	`BUG_ON
(
	`mb_ã°_bô
(
fú°
 + 
i
, 
e4b
->
bd_öfo
->
bb_bôm≠
));

490 
	`mb_£t_bô
(
fú°
 + 
i
, 
e4b
->
bd_öfo
->
bb_bôm≠
);

492 
	}
}

494 
	$mb_cmp_bôm≠s
(
pxt4_buddy
 *
e4b
, *
bôm≠
)

496 i‡(
	`memcmp
(
e4b
->
bd_öfo
->
bb_bôm≠
, 
bôm≠
,É4b->
bd_sb
->
s_blocksize
)) {

497 *
b1
, *
b2
;

498 
i
;

499 
b1
 = (*Ë
e4b
->
bd_öfo
->
bb_bôm≠
;

500 
b2
 = (*Ë
bôm≠
;

501 
i
 = 0; i < 
e4b
->
bd_sb
->
s_blocksize
; i++) {

502 i‡(
b1
[
i
] !
b2
[i]) {

503 
	`pxt4_msg
(
e4b
->
bd_sb
, 
KERN_ERR
,

507 
e4b
->
bd_group
, 
i
, i * 8, 
b1
[i], 
b2
[i]);

508 
	`BUG
();

512 
	}
}

515 
ölöe
 
	$mb_‰ì_blocks_doubÀ
(
öode
 *inode,

516 
pxt4_buddy
 *
e4b
, 
fú°
, 
cou¡
)

519 
	}
}

520 
ölöe
 
	$mb_m¨k_u£d_doubÀ
(
pxt4_buddy
 *
e4b
,

521 
fú°
, 
cou¡
)

524 
	}
}

525 
ölöe
 
	$mb_cmp_bôm≠s
(
pxt4_buddy
 *
e4b
, *
bôm≠
)

528 
	}
}

531 #ifde‡
AGGRESSIVE_CHECK


533 
	#MB_CHECK_ASSERT
(
as£π
) \

535 i‡(!(
as£π
)) { \

536 
	`¥ötk
(
KERN_EMERG
 \

538 
fun˘i⁄
, 
fûe
, 
löe
, #assert); \

539 
	`BUG
(); \

541 } 0)

	)

543 
	$__mb_check_buddy
(
pxt4_buddy
 *
e4b
, *
fûe
,

544 c⁄° *
fun˘i⁄
, 
löe
)

546 
su≥r_block
 *
sb
 = 
e4b
->
bd_sb
;

547 
‹dî
 = 
e4b
->
bd_blkbôs
 + 1;

548 
max
;

549 
max2
;

550 
i
;

551 
j
;

552 
k
;

553 
cou¡
;

554 
pxt4_group_öfo
 *
gΩ
;

555 
‰agmíts
 = 0;

556 
f°¨t
;

557 
li°_hód
 *
cur
;

558 *
buddy
;

559 *
buddy2
;

562 
mb_check_cou¡î
;

563 i‡(
mb_check_cou¡î
++ % 100 != 0)

567 
‹dî
 > 1) {

568 
buddy
 = 
	`mb_föd_buddy
(
e4b
, 
‹dî
, &
max
);

569 
	`MB_CHECK_ASSERT
(
buddy
);

570 
buddy2
 = 
	`mb_föd_buddy
(
e4b
, 
‹dî
 - 1, &
max2
);

571 
	`MB_CHECK_ASSERT
(
buddy2
);

572 
	`MB_CHECK_ASSERT
(
buddy
 !
buddy2
);

573 
	`MB_CHECK_ASSERT
(
max
 * 2 =
max2
);

575 
cou¡
 = 0;

576 
i
 = 0; i < 
max
; i++) {

578 i‡(
	`mb_ã°_bô
(
i
, 
buddy
)) {

580 i‡(!
	`mb_ã°_bô
(
i
 << 1, 
buddy2
)) {

581 
	`MB_CHECK_ASSERT
(

582 
	`mb_ã°_bô
((
i
<<1)+1, 
buddy2
));

583 } i‡(!
	`mb_ã°_bô
((
i
 << 1Ë+ 1, 
buddy2
)) {

584 
	`MB_CHECK_ASSERT
(

585 
	`mb_ã°_bô
(
i
 << 1, 
buddy2
));

591 
	`MB_CHECK_ASSERT
(
	`mb_ã°_bô
(
i
 << 1, 
buddy2
));

592 
	`MB_CHECK_ASSERT
(
	`mb_ã°_bô
((
i
 << 1Ë+ 1, 
buddy2
));

594 
j
 = 0; j < (1 << 
‹dî
); j++) {

595 
k
 = (
i
 * (1 << 
‹dî
)Ë+ 
j
;

596 
	`MB_CHECK_ASSERT
(

597 !
	`mb_ã°_bô
(
k
, 
e4b
->
bd_bôm≠
));

599 
cou¡
++;

601 
	`MB_CHECK_ASSERT
(
e4b
->
bd_öfo
->
bb_cou¡îs
[
‹dî
] =
cou¡
);

602 
‹dî
--;

605 
f°¨t
 = -1;

606 
buddy
 = 
	`mb_föd_buddy
(
e4b
, 0, &
max
);

607 
i
 = 0; i < 
max
; i++) {

608 i‡(!
	`mb_ã°_bô
(
i
, 
buddy
)) {

609 
	`MB_CHECK_ASSERT
(
i
 >
e4b
->
bd_öfo
->
bb_fú°_‰ì
);

610 i‡(
f°¨t
 == -1) {

611 
‰agmíts
++;

612 
f°¨t
 = 
i
;

616 
f°¨t
 = -1;

618 
j
 = 0; j < 
e4b
->
bd_blkbôs
 + 1; j++) {

619 
buddy2
 = 
	`mb_föd_buddy
(
e4b
, 
j
, &
max2
);

620 
k
 = 
i
 >> 
j
;

621 
	`MB_CHECK_ASSERT
(
k
 < 
max2
);

622 
	`MB_CHECK_ASSERT
(
	`mb_ã°_bô
(
k
, 
buddy2
));

625 
	`MB_CHECK_ASSERT
(!
	`PXT4_MB_GRP_NEED_INIT
(
e4b
->
bd_öfo
));

626 
	`MB_CHECK_ASSERT
(
e4b
->
bd_öfo
->
bb_‰agmíts
 =
‰agmíts
);

628 
gΩ
 = 
	`pxt4_gë_group_öfo
(
sb
, 
e4b
->
bd_group
);

629 
	`li°_f‹_óch
(
cur
, &
gΩ
->
bb_¥óŒoc_li°
) {

630 
pxt4_group_t
 
grou≤r
;

631 
pxt4_¥óŒoc_•a˚
 *
∑
;

632 
∑
 = 
	`li°_íåy
(
cur
, 
pxt4_¥óŒoc_•a˚
, 
∑_group_li°
);

633 
	`pxt4_gë_group_no_™d_off£t
(
sb
, 
∑
->
∑_p°¨t
, &
grou≤r
, &
k
);

634 
	`MB_CHECK_ASSERT
(
grou≤r
 =
e4b
->
bd_group
);

635 
i
 = 0; i < 
∑
->
∑_Àn
; i++)

636 
	`MB_CHECK_ASSERT
(
	`mb_ã°_bô
(
k
 + 
i
, 
buddy
));

639 
	}
}

640 #unde‡
MB_CHECK_ASSERT


641 
	#mb_check_buddy
(
e4b
Ë
	`__mb_check_buddy
(e4b, \

642 
__FILE__
, 
__func__
, 
__LINE__
)

	)

644 
	#mb_check_buddy
(
e4b
)

	)

653 
	$pxt4_mb_m¨k_‰ì_sim∂e
(
su≥r_block
 *
sb
,

654 *
buddy
, 
pxt4_gΩblk_t
 
fú°
,Öxt4_gΩblk_à
Àn
,

655 
pxt4_group_öfo
 *
gΩ
)

657 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
sb
);

658 
pxt4_gΩblk_t
 
mö
;

659 
pxt4_gΩblk_t
 
max
;

660 
pxt4_gΩblk_t
 
chunk
;

661 
b‹dî
;

663 
	`BUG_ON
(
Àn
 > 
	`PXT4_CLUSTERS_PER_GROUP
(
sb
));

665 
b‹dî
 = 2 << 
sb
->
s_blocksize_bôs
;

667 
Àn
 > 0) {

669 
max
 = 
	`ffs
(
fú°
 | 
b‹dî
) - 1;

672 
mö
 = 
	`Ês
(
Àn
) - 1;

674 i‡(
max
 < 
mö
)

675 
mö
 = 
max
;

676 
chunk
 = 1 << 
mö
;

679 
gΩ
->
bb_cou¡îs
[
mö
]++;

680 i‡(
mö
 > 0)

681 
	`mb_˛ór_bô
(
fú°
 >> 
mö
,

682 
buddy
 + 
sbi
->
s_mb_off£ts
[
mö
]);

684 
Àn
 -
chunk
;

685 
fú°
 +
chunk
;

687 
	}
}

694 
	$mb_£t_œrge°_‰ì_‹dî
(
su≥r_block
 *
sb
, 
pxt4_group_öfo
 *
gΩ
)

696 
i
;

697 
bôs
;

699 
gΩ
->
bb_œrge°_‰ì_‹dî
 = -1;

701 
bôs
 = 
sb
->
s_blocksize_bôs
 + 1;

702 
i
 = 
bôs
; i >= 0; i--) {

703 i‡(
gΩ
->
bb_cou¡îs
[
i
] > 0) {

704 
gΩ
->
bb_œrge°_‰ì_‹dî
 = 
i
;

708 
	}
}

710 
noölöe_f‹_°ack


711 
	$pxt4_mb_gíî©e_buddy
(
su≥r_block
 *
sb
,

712 *
buddy
, *
bôm≠
, 
pxt4_group_t
 
group
)

714 
pxt4_group_öfo
 *
gΩ
 = 
	`pxt4_gë_group_öfo
(
sb
, 
group
);

715 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
sb
);

716 
pxt4_gΩblk_t
 
max
 = 
	`PXT4_CLUSTERS_PER_GROUP
(
sb
);

717 
pxt4_gΩblk_t
 
i
 = 0;

718 
pxt4_gΩblk_t
 
fú°
;

719 
pxt4_gΩblk_t
 
Àn
;

720 
‰ì
 = 0;

721 
‰agmíts
 = 0;

722 
≥riod
 = 
	`gë_cy˛es
();

726 
i
 = 
	`mb_föd_√xt_zîo_bô
(
bôm≠
, 
max
, 0);

727 
gΩ
->
bb_fú°_‰ì
 = 
i
;

728 
i
 < 
max
) {

729 
‰agmíts
++;

730 
fú°
 = 
i
;

731 
i
 = 
	`mb_föd_√xt_bô
(
bôm≠
, 
max
, i);

732 
Àn
 = 
i
 - 
fú°
;

733 
‰ì
 +
Àn
;

734 i‡(
Àn
 > 1)

735 
	`pxt4_mb_m¨k_‰ì_sim∂e
(
sb
, 
buddy
, 
fú°
, 
Àn
, 
gΩ
);

737 
gΩ
->
bb_cou¡îs
[0]++;

738 i‡(
i
 < 
max
)

739 
i
 = 
	`mb_föd_√xt_zîo_bô
(
bôm≠
, 
max
, i);

741 
gΩ
->
bb_‰agmíts
 = 
‰agmíts
;

743 i‡(
‰ì
 !
gΩ
->
bb_‰ì
) {

744 
	`pxt4_gΩ_locked_îr‹
(
sb
, 
group
, 0, 0,

747 
‰ì
, 
gΩ
->
bb_‰ì
);

752 
gΩ
->
bb_‰ì
 = 
‰ì
;

753 
	`pxt4_m¨k_group_bôm≠_c‹ru±ed
(
sb
, 
group
,

754 
PXT4_GROUP_INFO_BBITMAP_CORRUPT
);

756 
	`mb_£t_œrge°_‰ì_‹dî
(
sb
, 
gΩ
);

758 
	`˛ór_bô
(
PXT4_GROUP_INFO_NEED_INIT_BIT
, &(
gΩ
->
bb_°©e
));

760 
≥riod
 = 
	`gë_cy˛es
() -Öeriod;

761 
	`•ö_lock
(&
sbi
->
s_bÆ_lock
);

762 
sbi
->
s_mb_buddõs_gíî©ed
++;

763 
sbi
->
s_mb_gíî©i⁄_time
 +
≥riod
;

764 
	`•ö_u∆ock
(&
sbi
->
s_bÆ_lock
);

765 
	}
}

767 
	$mb_ªgíî©e_buddy
(
pxt4_buddy
 *
e4b
)

769 
cou¡
;

770 
‹dî
 = 1;

771 *
buddy
;

773 (
buddy
 = 
	`mb_föd_buddy
(
e4b
, 
‹dî
++, &
cou¡
))) {

774 
	`pxt4_£t_bôs
(
buddy
, 0, 
cou¡
);

776 
e4b
->
bd_öfo
->
bb_‰agmíts
 = 0;

777 
	`mem£t
(
e4b
->
bd_öfo
->
bb_cou¡îs
, 0,

778 (*
e4b
->
bd_öfo
->
bb_cou¡îs
) *

779 (
e4b
->
bd_sb
->
s_blocksize_bôs
 + 2));

781 
	`pxt4_mb_gíî©e_buddy
(
e4b
->
bd_sb
,É4b->
bd_buddy
,

782 
e4b
->
bd_bôm≠
,É4b->
bd_group
);

783 
	}
}

805 
	$pxt4_mb_öô_ˇche
(
∑ge
 *∑ge, *
öc‹e
, 
gÂ_t
 
gÂ
)

807 
pxt4_group_t
 
ngroups
;

808 
blocksize
;

809 
blocks_≥r_∑ge
;

810 
groups_≥r_∑ge
;

811 
îr
 = 0;

812 
i
;

813 
pxt4_group_t
 
fú°_group
, 
group
;

814 
fú°_block
;

815 
su≥r_block
 *
sb
;

816 
buf„r_hód
 *
bhs
;

817 
buf„r_hód
 **
bh
 = 
NULL
;

818 
öode
 *inode;

819 *
d©a
;

820 *
bôm≠
;

821 
pxt4_group_öfo
 *
gröfo
;

823 
	`mb_debug
(1, "öôÖagê%lu\n", 
∑ge
->
ödex
);

825 
öode
 = 
∑ge
->
m≠pög
->
ho°
;

826 
sb
 = 
öode
->
i_sb
;

827 
ngroups
 = 
	`pxt4_gë_groups_cou¡
(
sb
);

828 
blocksize
 = 
	`i_blocksize
(
öode
);

829 
blocks_≥r_∑ge
 = 
PAGE_SIZE
 / 
blocksize
;

831 
groups_≥r_∑ge
 = 
blocks_≥r_∑ge
 >> 1;

832 i‡(
groups_≥r_∑ge
 == 0)

833 
groups_≥r_∑ge
 = 1;

836 i‡(
groups_≥r_∑ge
 > 1) {

837 
i
 = (
buf„r_hód
 *Ë* 
groups_≥r_∑ge
;

838 
bh
 = 
	`kzÆloc
(
i
, 
gÂ
);

839 i‡(
bh
 =
NULL
) {

840 
îr
 = -
ENOMEM
;

841 
out
;

844 
bh
 = &
bhs
;

846 
fú°_group
 = 
∑ge
->
ödex
 * 
blocks_≥r_∑ge
 / 2;

849 
i
 = 0, 
group
 = 
fú°_group
; i < 
groups_≥r_∑ge
; i++, group++) {

850 i‡(
group
 >
ngroups
)

853 
gröfo
 = 
	`pxt4_gë_group_öfo
(
sb
, 
group
);

860 i‡(
	`PageU±od©e
(
∑ge
Ë&& !
	`PXT4_MB_GRP_NEED_INIT
(
gröfo
)) {

861 
bh
[
i
] = 
NULL
;

864 
bh
[
i
] = 
	`pxt4_ªad_block_bôm≠_nowaô
(
sb
, 
group
);

865 i‡(
	`IS_ERR
(
bh
[
i
])) {

866 
îr
 = 
	`PTR_ERR
(
bh
[
i
]);

867 
bh
[
i
] = 
NULL
;

868 
out
;

870 
	`mb_debug
(1, "ªad bôm≠ f‹ grou∞%u\n", 
group
);

874 
i
 = 0, 
group
 = 
fú°_group
; i < 
groups_≥r_∑ge
; i++, group++) {

875 
îr2
;

877 i‡(!
bh
[
i
])

879 
îr2
 = 
	`pxt4_waô_block_bôm≠
(
sb
, 
group
, 
bh
[
i
]);

880 i‡(!
îr
)

881 
îr
 = 
îr2
;

884 
fú°_block
 = 
∑ge
->
ödex
 * 
blocks_≥r_∑ge
;

885 
i
 = 0; i < 
blocks_≥r_∑ge
; i++) {

886 
group
 = (
fú°_block
 + 
i
) >> 1;

887 i‡(
group
 >
ngroups
)

890 i‡(!
bh
[
group
 - 
fú°_group
])

894 i‡(!
	`buf„r_vîifõd
(
bh
[
group
 - 
fú°_group
]))

897 
îr
 = 0;

905 
d©a
 = 
	`∑ge_addªss
(
∑ge
Ë+ (
i
 * 
blocksize
);

906 
bôm≠
 = 
bh
[
group
 - 
fú°_group
]->
b_d©a
;

912 i‡((
fú°_block
 + 
i
) & 1) {

914 
	`BUG_ON
(
öc‹e
 =
NULL
);

915 
	`mb_debug
(1, "put buddy for group %u inÖage %lu/%x\n",

916 
group
, 
∑ge
->
ödex
, 
i
 * 
blocksize
);

917 
	`åa˚_pxt4_mb_buddy_bôm≠_lﬂd
(
sb
, 
group
);

918 
gröfo
 = 
	`pxt4_gë_group_öfo
(
sb
, 
group
);

919 
gröfo
->
bb_‰agmíts
 = 0;

920 
	`mem£t
(
gröfo
->
bb_cou¡îs
, 0,

921 (*
gröfo
->
bb_cou¡îs
) *

922 (
sb
->
s_blocksize_bôs
+2));

926 
	`pxt4_lock_group
(
sb
, 
group
);

928 
	`mem£t
(
d©a
, 0xff, 
blocksize
);

929 
	`pxt4_mb_gíî©e_buddy
(
sb
, 
d©a
, 
öc‹e
, 
group
);

930 
	`pxt4_u∆ock_group
(
sb
, 
group
);

931 
öc‹e
 = 
NULL
;

934 
	`BUG_ON
(
öc‹e
 !
NULL
);

935 
	`mb_debug
(1, "put bitmap for group %u inÖage %lu/%x\n",

936 
group
, 
∑ge
->
ödex
, 
i
 * 
blocksize
);

937 
	`åa˚_pxt4_mb_bôm≠_lﬂd
(
sb
, 
group
);

940 
	`pxt4_lock_group
(
sb
, 
group
);

941 
	`mem˝y
(
d©a
, 
bôm≠
, 
blocksize
);

944 
	`pxt4_mb_gíî©e_‰om_∑
(
sb
, 
d©a
, 
group
);

945 
	`pxt4_mb_gíî©e_‰om_‰ìli°
(
sb
, 
d©a
, 
group
);

946 
	`pxt4_u∆ock_group
(
sb
, 
group
);

951 
öc‹e
 = 
d©a
;

954 
	`SëPageU±od©e
(
∑ge
);

956 
out
:

957 i‡(
bh
) {

958 
i
 = 0; i < 
groups_≥r_∑ge
; i++)

959 
	`bªl£
(
bh
[
i
]);

960 i‡(
bh
 !&
bhs
)

961 
	`k‰ì
(
bh
);

963  
îr
;

964 
	}
}

972 
	$pxt4_mb_gë_buddy_∑ge_lock
(
su≥r_block
 *
sb
,

973 
pxt4_group_t
 
group
, 
pxt4_buddy
 *
e4b
, 
gÂ_t
 
gÂ
)

975 
öode
 *öodê
	`PXT4_SB
(
sb
)->
s_buddy_ˇche
;

976 
block
, 
≤um
, 
poff
;

977 
blocks_≥r_∑ge
;

978 
∑ge
 *page;

980 
e4b
->
bd_buddy_∑ge
 = 
NULL
;

981 
e4b
->
bd_bôm≠_∑ge
 = 
NULL
;

983 
blocks_≥r_∑ge
 = 
PAGE_SIZE
 / 
sb
->
s_blocksize
;

989 
block
 = 
group
 * 2;

990 
≤um
 = 
block
 / 
blocks_≥r_∑ge
;

991 
poff
 = 
block
 % 
blocks_≥r_∑ge
;

992 
∑ge
 = 
	`föd_‹_¸óã_∑ge
(
öode
->
i_m≠pög
, 
≤um
, 
gÂ
);

993 i‡(!
∑ge
)

994  -
ENOMEM
;

995 
	`BUG_ON
(
∑ge
->
m≠pög
 !
öode
->
i_m≠pög
);

996 
e4b
->
bd_bôm≠_∑ge
 = 
∑ge
;

997 
e4b
->
bd_bôm≠
 = 
	`∑ge_addªss
(
∑ge
Ë+ (
poff
 * 
sb
->
s_blocksize
);

999 i‡(
blocks_≥r_∑ge
 >= 2) {

1004 
block
++;

1005 
≤um
 = 
block
 / 
blocks_≥r_∑ge
;

1006 
∑ge
 = 
	`föd_‹_¸óã_∑ge
(
öode
->
i_m≠pög
, 
≤um
, 
gÂ
);

1007 i‡(!
∑ge
)

1008  -
ENOMEM
;

1009 
	`BUG_ON
(
∑ge
->
m≠pög
 !
öode
->
i_m≠pög
);

1010 
e4b
->
bd_buddy_∑ge
 = 
∑ge
;

1012 
	}
}

1014 
	$pxt4_mb_put_buddy_∑ge_lock
(
pxt4_buddy
 *
e4b
)

1016 i‡(
e4b
->
bd_bôm≠_∑ge
) {

1017 
	`u∆ock_∑ge
(
e4b
->
bd_bôm≠_∑ge
);

1018 
	`put_∑ge
(
e4b
->
bd_bôm≠_∑ge
);

1020 i‡(
e4b
->
bd_buddy_∑ge
) {

1021 
	`u∆ock_∑ge
(
e4b
->
bd_buddy_∑ge
);

1022 
	`put_∑ge
(
e4b
->
bd_buddy_∑ge
);

1024 
	}
}

1031 
noölöe_f‹_°ack


1032 
	$pxt4_mb_öô_group
(
su≥r_block
 *
sb
, 
pxt4_group_t
 
group
, 
gÂ_t
 
gÂ
)

1035 
pxt4_group_öfo
 *
this_gΩ
;

1036 
pxt4_buddy
 
e4b
;

1037 
∑ge
 *page;

1038 
ªt
 = 0;

1040 
	`might_¶ìp
();

1041 
	`mb_debug
(1, "öô grou∞%u\n", 
group
);

1042 
this_gΩ
 = 
	`pxt4_gë_group_öfo
(
sb
, 
group
);

1052 
ªt
 = 
	`pxt4_mb_gë_buddy_∑ge_lock
(
sb
, 
group
, &
e4b
, 
gÂ
);

1053 i‡(
ªt
 || !
	`PXT4_MB_GRP_NEED_INIT
(
this_gΩ
)) {

1058 
îr
;

1061 
∑ge
 = 
e4b
.
bd_bôm≠_∑ge
;

1062 
ªt
 = 
	`pxt4_mb_öô_ˇche
(
∑ge
, 
NULL
, 
gÂ
);

1063 i‡(
ªt
)

1064 
îr
;

1065 i‡(!
	`PageU±od©e
(
∑ge
)) {

1066 
ªt
 = -
EIO
;

1067 
îr
;

1070 i‡(
e4b
.
bd_buddy_∑ge
 =
NULL
) {

1076 
ªt
 = 0;

1077 
îr
;

1080 
∑ge
 = 
e4b
.
bd_buddy_∑ge
;

1081 
ªt
 = 
	`pxt4_mb_öô_ˇche
(
∑ge
, 
e4b
.
bd_bôm≠
, 
gÂ
);

1082 i‡(
ªt
)

1083 
îr
;

1084 i‡(!
	`PageU±od©e
(
∑ge
)) {

1085 
ªt
 = -
EIO
;

1086 
îr
;

1088 
îr
:

1089 
	`pxt4_mb_put_buddy_∑ge_lock
(&
e4b
);

1090  
ªt
;

1091 
	}
}

1098 
noölöe_f‹_°ack
 

1099 
	$pxt4_mb_lﬂd_buddy_gÂ
(
su≥r_block
 *
sb
, 
pxt4_group_t
 
group
,

1100 
pxt4_buddy
 *
e4b
, 
gÂ_t
 
gÂ
)

1102 
blocks_≥r_∑ge
;

1103 
block
;

1104 
≤um
;

1105 
poff
;

1106 
∑ge
 *page;

1107 
ªt
;

1108 
pxt4_group_öfo
 *
gΩ
;

1109 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
sb
);

1110 
öode
 *öodê
sbi
->
s_buddy_ˇche
;

1112 
	`might_¶ìp
();

1113 
	`mb_debug
(1, "lﬂd grou∞%u\n", 
group
);

1115 
blocks_≥r_∑ge
 = 
PAGE_SIZE
 / 
sb
->
s_blocksize
;

1116 
gΩ
 = 
	`pxt4_gë_group_öfo
(
sb
, 
group
);

1118 
e4b
->
bd_blkbôs
 = 
sb
->
s_blocksize_bôs
;

1119 
e4b
->
bd_öfo
 = 
gΩ
;

1120 
e4b
->
bd_sb
 = 
sb
;

1121 
e4b
->
bd_group
 = 
group
;

1122 
e4b
->
bd_buddy_∑ge
 = 
NULL
;

1123 
e4b
->
bd_bôm≠_∑ge
 = 
NULL
;

1125 i‡(
	`u∆ikñy
(
	`PXT4_MB_GRP_NEED_INIT
(
gΩ
))) {

1130 
ªt
 = 
	`pxt4_mb_öô_group
(
sb
, 
group
, 
gÂ
);

1131 i‡(
ªt
)

1132  
ªt
;

1140 
block
 = 
group
 * 2;

1141 
≤um
 = 
block
 / 
blocks_≥r_∑ge
;

1142 
poff
 = 
block
 % 
blocks_≥r_∑ge
;

1146 
∑ge
 = 
	`föd_gë_∑ge_Êags
(
öode
->
i_m≠pög
, 
≤um
, 
FGP_ACCESSED
);

1147 i‡(
∑ge
 =
NULL
 || !
	`PageU±od©e
(page)) {

1148 i‡(
∑ge
)

1157 
	`put_∑ge
(
∑ge
);

1158 
∑ge
 = 
	`föd_‹_¸óã_∑ge
(
öode
->
i_m≠pög
, 
≤um
, 
gÂ
);

1159 i‡(
∑ge
) {

1160 
	`BUG_ON
(
∑ge
->
m≠pög
 !
öode
->
i_m≠pög
);

1161 i‡(!
	`PageU±od©e
(
∑ge
)) {

1162 
ªt
 = 
	`pxt4_mb_öô_ˇche
(
∑ge
, 
NULL
, 
gÂ
);

1163 i‡(
ªt
) {

1164 
	`u∆ock_∑ge
(
∑ge
);

1165 
îr
;

1167 
	`mb_cmp_bôm≠s
(
e4b
, 
	`∑ge_addªss
(
∑ge
) +

1168 (
poff
 * 
sb
->
s_blocksize
));

1170 
	`u∆ock_∑ge
(
∑ge
);

1173 i‡(
∑ge
 =
NULL
) {

1174 
ªt
 = -
ENOMEM
;

1175 
îr
;

1177 i‡(!
	`PageU±od©e
(
∑ge
)) {

1178 
ªt
 = -
EIO
;

1179 
îr
;

1183 
e4b
->
bd_bôm≠_∑ge
 = 
∑ge
;

1184 
e4b
->
bd_bôm≠
 = 
	`∑ge_addªss
(
∑ge
Ë+ (
poff
 * 
sb
->
s_blocksize
);

1186 
block
++;

1187 
≤um
 = 
block
 / 
blocks_≥r_∑ge
;

1188 
poff
 = 
block
 % 
blocks_≥r_∑ge
;

1190 
∑ge
 = 
	`föd_gë_∑ge_Êags
(
öode
->
i_m≠pög
, 
≤um
, 
FGP_ACCESSED
);

1191 i‡(
∑ge
 =
NULL
 || !
	`PageU±od©e
(page)) {

1192 i‡(
∑ge
)

1193 
	`put_∑ge
(
∑ge
);

1194 
∑ge
 = 
	`föd_‹_¸óã_∑ge
(
öode
->
i_m≠pög
, 
≤um
, 
gÂ
);

1195 i‡(
∑ge
) {

1196 
	`BUG_ON
(
∑ge
->
m≠pög
 !
öode
->
i_m≠pög
);

1197 i‡(!
	`PageU±od©e
(
∑ge
)) {

1198 
ªt
 = 
	`pxt4_mb_öô_ˇche
(
∑ge
, 
e4b
->
bd_bôm≠
,

1199 
gÂ
);

1200 i‡(
ªt
) {

1201 
	`u∆ock_∑ge
(
∑ge
);

1202 
îr
;

1205 
	`u∆ock_∑ge
(
∑ge
);

1208 i‡(
∑ge
 =
NULL
) {

1209 
ªt
 = -
ENOMEM
;

1210 
îr
;

1212 i‡(!
	`PageU±od©e
(
∑ge
)) {

1213 
ªt
 = -
EIO
;

1214 
îr
;

1218 
e4b
->
bd_buddy_∑ge
 = 
∑ge
;

1219 
e4b
->
bd_buddy
 = 
	`∑ge_addªss
(
∑ge
Ë+ (
poff
 * 
sb
->
s_blocksize
);

1221 
	`BUG_ON
(
e4b
->
bd_bôm≠_∑ge
 =
NULL
);

1222 
	`BUG_ON
(
e4b
->
bd_buddy_∑ge
 =
NULL
);

1226 
îr
:

1227 i‡(
∑ge
)

1228 
	`put_∑ge
(
∑ge
);

1229 i‡(
e4b
->
bd_bôm≠_∑ge
)

1230 
	`put_∑ge
(
e4b
->
bd_bôm≠_∑ge
);

1231 i‡(
e4b
->
bd_buddy_∑ge
)

1232 
	`put_∑ge
(
e4b
->
bd_buddy_∑ge
);

1233 
e4b
->
bd_buddy
 = 
NULL
;

1234 
e4b
->
bd_bôm≠
 = 
NULL
;

1235  
ªt
;

1236 
	}
}

1238 
	$pxt4_mb_lﬂd_buddy
(
su≥r_block
 *
sb
, 
pxt4_group_t
 
group
,

1239 
pxt4_buddy
 *
e4b
)

1241  
	`pxt4_mb_lﬂd_buddy_gÂ
(
sb
, 
group
, 
e4b
, 
GFP_NOFS
);

1242 
	}
}

1244 
	$pxt4_mb_u∆ﬂd_buddy
(
pxt4_buddy
 *
e4b
)

1246 i‡(
e4b
->
bd_bôm≠_∑ge
)

1247 
	`put_∑ge
(
e4b
->
bd_bôm≠_∑ge
);

1248 i‡(
e4b
->
bd_buddy_∑ge
)

1249 
	`put_∑ge
(
e4b
->
bd_buddy_∑ge
);

1250 
	}
}

1253 
	$mb_föd_‹dî_f‹_block
(
pxt4_buddy
 *
e4b
, 
block
)

1255 
‹dî
 = 1;

1256 
bb_ö¸
 = 1 << (
e4b
->
bd_blkbôs
 - 1);

1257 *
bb
;

1259 
	`BUG_ON
(
e4b
->
bd_bôm≠
 =e4b->
bd_buddy
);

1260 
	`BUG_ON
(
block
 >(1 << (
e4b
->
bd_blkbôs
 + 3)));

1262 
bb
 = 
e4b
->
bd_buddy
;

1263 
‹dî
 <
e4b
->
bd_blkbôs
 + 1) {

1264 
block
 = block >> 1;

1265 i‡(!
	`mb_ã°_bô
(
block
, 
bb
)) {

1267  
‹dî
;

1269 
bb
 +
bb_ö¸
;

1270 
bb_ö¸
 >>= 1;

1271 
‹dî
++;

1274 
	}
}

1276 
	$mb_˛ór_bôs
(*
bm
, 
cur
, 
Àn
)

1278 
__u32
 *
addr
;

1280 
Àn
 = 
cur
 +Üen;

1281 
cur
 < 
Àn
) {

1282 i‡((
cur
 & 31Ë=0 && (
Àn
 - cur) >= 32) {

1284 
addr
 = 
bm
 + (
cur
 >> 3);

1285 *
addr
 = 0;

1286 
cur
 += 32;

1289 
	`mb_˛ór_bô
(
cur
, 
bm
);

1290 
cur
++;

1292 
	}
}

1297 
	$mb_ã°_™d_˛ór_bôs
(*
bm
, 
cur
, 
Àn
)

1299 
__u32
 *
addr
;

1300 
zîo_bô
 = -1;

1302 
Àn
 = 
cur
 +Üen;

1303 
cur
 < 
Àn
) {

1304 i‡((
cur
 & 31Ë=0 && (
Àn
 - cur) >= 32) {

1306 
addr
 = 
bm
 + (
cur
 >> 3);

1307 i‡(*
addr
 !(
__u32
)(-1Ë&& 
zîo_bô
 == -1)

1308 
zîo_bô
 = 
cur
 + 
	`mb_föd_√xt_zîo_bô
(
addr
, 32, 0);

1309 *
addr
 = 0;

1310 
cur
 += 32;

1313 i‡(!
	`mb_ã°_™d_˛ór_bô
(
cur
, 
bm
Ë&& 
zîo_bô
 == -1)

1314 
zîo_bô
 = 
cur
;

1315 
cur
++;

1318  
zîo_bô
;

1319 
	}
}

1321 
	$pxt4_£t_bôs
(*
bm
, 
cur
, 
Àn
)

1323 
__u32
 *
addr
;

1325 
Àn
 = 
cur
 +Üen;

1326 
cur
 < 
Àn
) {

1327 i‡((
cur
 & 31Ë=0 && (
Àn
 - cur) >= 32) {

1329 
addr
 = 
bm
 + (
cur
 >> 3);

1330 *
addr
 = 0xffffffff;

1331 
cur
 += 32;

1334 
	`mb_£t_bô
(
cur
, 
bm
);

1335 
cur
++;

1337 
	}
}

1342 
ölöe
 
	$mb_buddy_adju°_b‹dî
(* 
bô
, * 
bôm≠
, 
side
)

1344 i‡(
	`mb_ã°_bô
(*
bô
 + 
side
, 
bôm≠
)) {

1345 
	`mb_˛ór_bô
(*
bô
, 
bôm≠
);

1346 (*
bô
Ë-
side
;

1350 (*
bô
Ë+
side
;

1351 
	`mb_£t_bô
(*
bô
, 
bôm≠
);

1354 
	}
}

1356 
	$mb_buddy_m¨k_‰ì
(
pxt4_buddy
 *
e4b
, 
fú°
, 
œ°
)

1358 
max
;

1359 
‹dî
 = 1;

1360 *
buddy
 = 
	`mb_föd_buddy
(
e4b
, 
‹dî
, &
max
);

1362 
buddy
) {

1363 *
buddy2
;

1394 i‡(
fú°
 & 1)

1395 
e4b
->
bd_öfo
->
bb_cou¡îs
[
‹dî
] +
	`mb_buddy_adju°_b‹dî
(&
fú°
, 
buddy
, -1);

1396 i‡(!(
œ°
 & 1))

1397 
e4b
->
bd_öfo
->
bb_cou¡îs
[
‹dî
] +
	`mb_buddy_adju°_b‹dî
(&
œ°
, 
buddy
, 1);

1398 i‡(
fú°
 > 
œ°
)

1400 
‹dî
++;

1402 i‡(
fú°
 =
œ°
 || !(
buddy2
 = 
	`mb_föd_buddy
(
e4b
, 
‹dî
, &
max
))) {

1403 
	`mb_˛ór_bôs
(
buddy
, 
fú°
, 
œ°
 - first + 1);

1404 
e4b
->
bd_öfo
->
bb_cou¡îs
[
‹dî
 - 1] +
œ°
 - 
fú°
 + 1;

1407 
fú°
 >>= 1;

1408 
œ°
 >>= 1;

1409 
buddy
 = 
buddy2
;

1411 
	}
}

1413 
	$mb_‰ì_blocks
(
öode
 *öode, 
pxt4_buddy
 *
e4b
,

1414 
fú°
, 
cou¡
)

1416 
À·_is_‰ì
 = 0;

1417 
right_is_‰ì
 = 0;

1418 
block
;

1419 
œ°
 = 
fú°
 + 
cou¡
 - 1;

1420 
su≥r_block
 *
sb
 = 
e4b
->
bd_sb
;

1422 i‡(
	`WARN_ON
(
cou¡
 == 0))

1424 
	`BUG_ON
(
œ°
 >(
sb
->
s_blocksize
 << 3));

1425 
	`as£π_•ö_locked
(
	`pxt4_group_lock_±r
(
sb
, 
e4b
->
bd_group
));

1427 i‡(
	`u∆ikñy
(
	`PXT4_MB_GRP_BBITMAP_CORRUPT
(
e4b
->
bd_öfo
)))

1430 
	`mb_check_buddy
(
e4b
);

1431 
	`mb_‰ì_blocks_doubÀ
(
öode
, 
e4b
, 
fú°
, 
cou¡
);

1433 
e4b
->
bd_öfo
->
bb_‰ì
 +
cou¡
;

1434 i‡(
fú°
 < 
e4b
->
bd_öfo
->
bb_fú°_‰ì
)

1435 
e4b
->
bd_öfo
->
bb_fú°_‰ì
 = 
fú°
;

1440 i‡(
fú°
 != 0)

1441 
À·_is_‰ì
 = !
	`mb_ã°_bô
(
fú°
 - 1, 
e4b
->
bd_bôm≠
);

1442 
block
 = 
	`mb_ã°_™d_˛ór_bôs
(
e4b
->
bd_bôm≠
, 
fú°
, 
cou¡
);

1443 i‡(
œ°
 + 1 < 
	`PXT4_SB
(
sb
)->
s_mb_maxs
[0])

1444 
right_is_‰ì
 = !
	`mb_ã°_bô
(
œ°
 + 1, 
e4b
->
bd_bôm≠
);

1446 i‡(
	`u∆ikñy
(
block
 != -1)) {

1447 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
sb
);

1448 
pxt4_fsblk_t
 
blockƒ
;

1450 
blockƒ
 = 
	`pxt4_group_fú°_block_no
(
sb
, 
e4b
->
bd_group
);

1451 
blockƒ
 +
	`PXT4_C2B
(
sbi
, 
block
);

1452 
	`pxt4_gΩ_locked_îr‹
(
sb
, 
e4b
->
bd_group
,

1453 
öode
 ? inode->
i_öo
 : 0,

1454 
blockƒ
,

1457 
block
);

1458 
	`pxt4_m¨k_group_bôm≠_c‹ru±ed
(
sb
, 
e4b
->
bd_group
,

1459 
PXT4_GROUP_INFO_BBITMAP_CORRUPT
);

1460 
	`mb_ªgíî©e_buddy
(
e4b
);

1461 
d⁄e
;

1465 i‡(
À·_is_‰ì
 && 
right_is_‰ì
)

1466 
e4b
->
bd_öfo
->
bb_‰agmíts
--;

1467 i‡(!
À·_is_‰ì
 && !
right_is_‰ì
)

1468 
e4b
->
bd_öfo
->
bb_‰agmíts
++;

1476 i‡(
fú°
 & 1) {

1477 
fú°
 +!
À·_is_‰ì
;

1478 
e4b
->
bd_öfo
->
bb_cou¡îs
[0] +
À·_is_‰ì
 ? -1 : 1;

1480 i‡(!(
œ°
 & 1)) {

1481 
œ°
 -!
right_is_‰ì
;

1482 
e4b
->
bd_öfo
->
bb_cou¡îs
[0] +
right_is_‰ì
 ? -1 : 1;

1485 i‡(
fú°
 <
œ°
)

1486 
	`mb_buddy_m¨k_‰ì
(
e4b
, 
fú°
 >> 1, 
œ°
 >> 1);

1488 
d⁄e
:

1489 
	`mb_£t_œrge°_‰ì_‹dî
(
sb
, 
e4b
->
bd_öfo
);

1490 
	`mb_check_buddy
(
e4b
);

1491 
	}
}

1493 
	$mb_föd_exã¡
(
pxt4_buddy
 *
e4b
, 
block
,

1494 
√eded
, 
pxt4_‰ì_exã¡
 *
ex
)

1496 
√xt
 = 
block
;

1497 
max
, 
‹dî
;

1498 *
buddy
;

1500 
	`as£π_•ö_locked
(
	`pxt4_group_lock_±r
(
e4b
->
bd_sb
,É4b->
bd_group
));

1501 
	`BUG_ON
(
ex
 =
NULL
);

1503 
buddy
 = 
	`mb_föd_buddy
(
e4b
, 0, &
max
);

1504 
	`BUG_ON
(
buddy
 =
NULL
);

1505 
	`BUG_ON
(
block
 >
max
);

1506 i‡(
	`mb_ã°_bô
(
block
, 
buddy
)) {

1507 
ex
->
„_Àn
 = 0;

1508 
ex
->
„_°¨t
 = 0;

1509 
ex
->
„_group
 = 0;

1514 
‹dî
 = 
	`mb_föd_‹dî_f‹_block
(
e4b
, 
block
);

1515 
block
 = block >> 
‹dî
;

1517 
ex
->
„_Àn
 = 1 << 
‹dî
;

1518 
ex
->
„_°¨t
 = 
block
 << 
‹dî
;

1519 
ex
->
„_group
 = 
e4b
->
bd_group
;

1522 
√xt
 =Çexà- 
ex
->
„_°¨t
;

1523 
ex
->
„_Àn
 -
√xt
;

1524 
ex
->
„_°¨t
 +
√xt
;

1526 
√eded
 > 
ex
->
„_Àn
 &&

1527 
	`mb_föd_buddy
(
e4b
, 
‹dî
, &
max
)) {

1529 i‡(
block
 + 1 >
max
)

1532 
√xt
 = (
block
 + 1Ë* (1 << 
‹dî
);

1533 i‡(
	`mb_ã°_bô
(
√xt
, 
e4b
->
bd_bôm≠
))

1536 
‹dî
 = 
	`mb_föd_‹dî_f‹_block
(
e4b
, 
√xt
);

1538 
block
 = 
√xt
 >> 
‹dî
;

1539 
ex
->
„_Àn
 +1 << 
‹dî
;

1542 i‡(
ex
->
„_°¨t
 +Éx->
„_Àn
 > 
	`PXT4_CLUSTERS_PER_GROUP
(
e4b
->
bd_sb
)) {

1544 
	`WARN_ON
(1);

1545 
	`pxt4_gΩ_locked_îr‹
(
e4b
->
bd_sb
,É4b->
bd_group
, 0, 0,

1548 
block
, 
‹dî
, 
√eded
, 
ex
->
„_group
,Éx->
„_°¨t
,

1549 
ex
->
„_Àn
,Éx->
„_logiˇl
);

1550 
ex
->
„_Àn
 = 0;

1551 
ex
->
„_°¨t
 = 0;

1552 
ex
->
„_group
 = 0;

1554  
ex
->
„_Àn
;

1555 
	}
}

1557 
	$mb_m¨k_u£d
(
pxt4_buddy
 *
e4b
, 
pxt4_‰ì_exã¡
 *
ex
)

1559 
‹d
;

1560 
mÀn
 = 0;

1561 
max
 = 0;

1562 
cur
;

1563 
°¨t
 = 
ex
->
„_°¨t
;

1564 
Àn
 = 
ex
->
„_Àn
;

1565 
ªt
 = 0;

1566 
Àn0
 = 
Àn
;

1567 *
buddy
;

1569 
	`BUG_ON
(
°¨t
 + 
Àn
 > (
e4b
->
bd_sb
->
s_blocksize
 << 3));

1570 
	`BUG_ON
(
e4b
->
bd_group
 !
ex
->
„_group
);

1571 
	`as£π_•ö_locked
(
	`pxt4_group_lock_±r
(
e4b
->
bd_sb
,É4b->
bd_group
));

1572 
	`mb_check_buddy
(
e4b
);

1573 
	`mb_m¨k_u£d_doubÀ
(
e4b
, 
°¨t
, 
Àn
);

1575 
e4b
->
bd_öfo
->
bb_‰ì
 -
Àn
;

1576 i‡(
e4b
->
bd_öfo
->
bb_fú°_‰ì
 =
°¨t
)

1577 
e4b
->
bd_öfo
->
bb_fú°_‰ì
 +
Àn
;

1580 i‡(
°¨t
 != 0)

1581 
mÀn
 = !
	`mb_ã°_bô
(
°¨t
 - 1, 
e4b
->
bd_bôm≠
);

1582 i‡(
°¨t
 + 
Àn
 < 
	`PXT4_SB
(
e4b
->
bd_sb
)->
s_mb_maxs
[0])

1583 
max
 = !
	`mb_ã°_bô
(
°¨t
 + 
Àn
, 
e4b
->
bd_bôm≠
);

1584 i‡(
mÀn
 && 
max
)

1585 
e4b
->
bd_öfo
->
bb_‰agmíts
++;

1586 i‡(!
mÀn
 && !
max
)

1587 
e4b
->
bd_öfo
->
bb_‰agmíts
--;

1590 
Àn
) {

1591 
‹d
 = 
	`mb_föd_‹dî_f‹_block
(
e4b
, 
°¨t
);

1593 i‡(((
°¨t
 >> 
‹d
Ë<< ordË=°¨à&& 
Àn
 >= (1 << ord)) {

1595 
mÀn
 = 1 << 
‹d
;

1596 
buddy
 = 
	`mb_föd_buddy
(
e4b
, 
‹d
, &
max
);

1597 
	`BUG_ON
((
°¨t
 >> 
‹d
Ë>
max
);

1598 
	`mb_£t_bô
(
°¨t
 >> 
‹d
, 
buddy
);

1599 
e4b
->
bd_öfo
->
bb_cou¡îs
[
‹d
]--;

1600 
°¨t
 +
mÀn
;

1601 
Àn
 -
mÀn
;

1602 
	`BUG_ON
(
Àn
 < 0);

1607 i‡(
ªt
 == 0)

1608 
ªt
 = 
Àn
 | (
‹d
 << 16);

1611 
	`BUG_ON
(
‹d
 <= 0);

1612 
buddy
 = 
	`mb_föd_buddy
(
e4b
, 
‹d
, &
max
);

1613 
	`mb_£t_bô
(
°¨t
 >> 
‹d
, 
buddy
);

1614 
e4b
->
bd_öfo
->
bb_cou¡îs
[
‹d
]--;

1616 
‹d
--;

1617 
cur
 = (
°¨t
 >> 
‹d
) & ~1U;

1618 
buddy
 = 
	`mb_föd_buddy
(
e4b
, 
‹d
, &
max
);

1619 
	`mb_˛ór_bô
(
cur
, 
buddy
);

1620 
	`mb_˛ór_bô
(
cur
 + 1, 
buddy
);

1621 
e4b
->
bd_öfo
->
bb_cou¡îs
[
‹d
]++;

1622 
e4b
->
bd_öfo
->
bb_cou¡îs
[
‹d
]++;

1624 
	`mb_£t_œrge°_‰ì_‹dî
(
e4b
->
bd_sb
,É4b->
bd_öfo
);

1626 
	`pxt4_£t_bôs
(
e4b
->
bd_bôm≠
, 
ex
->
„_°¨t
, 
Àn0
);

1627 
	`mb_check_buddy
(
e4b
);

1629  
ªt
;

1630 
	}
}

1635 
	$pxt4_mb_u£_be°_found
(
pxt4_Æloˇti⁄_c⁄ãxt
 *
ac
,

1636 
pxt4_buddy
 *
e4b
)

1638 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
ac
->
ac_sb
);

1639 
ªt
;

1641 
	`BUG_ON
(
ac
->
ac_b_ex
.
„_group
 !
e4b
->
bd_group
);

1642 
	`BUG_ON
(
ac
->
ac_°©us
 =
AC_STATUS_FOUND
);

1644 
ac
->
ac_b_ex
.
„_Àn
 = 
	`mö
◊c->ac_b_ex.„_Àn,ác->
ac_g_ex
.fe_len);

1645 
ac
->
ac_b_ex
.
„_logiˇl
 =ác->
ac_g_ex
.fe_logical;

1646 
ªt
 = 
	`mb_m¨k_u£d
(
e4b
, &
ac
->
ac_b_ex
);

1650 
ac
->
ac_f_ex
 =ác->
ac_b_ex
;

1652 
ac
->
ac_°©us
 = 
AC_STATUS_FOUND
;

1653 
ac
->
ac_èû
 = 
ªt
 & 0xffff;

1654 
ac
->
ac_buddy
 = 
ªt
 >> 16;

1663 
ac
->
ac_bôm≠_∑ge
 = 
e4b
->
bd_bôm≠_∑ge
;

1664 
	`gë_∑ge
(
ac
->
ac_bôm≠_∑ge
);

1665 
ac
->
ac_buddy_∑ge
 = 
e4b
->
bd_buddy_∑ge
;

1666 
	`gë_∑ge
(
ac
->
ac_buddy_∑ge
);

1668 i‡(
ac
->
ac_Êags
 & 
PXT4_MB_STREAM_ALLOC
) {

1669 
	`•ö_lock
(&
sbi
->
s_md_lock
);

1670 
sbi
->
s_mb_œ°_group
 = 
ac
->
ac_f_ex
.
„_group
;

1671 
sbi
->
s_mb_œ°_°¨t
 = 
ac
->
ac_f_ex
.
„_°¨t
;

1672 
	`•ö_u∆ock
(&
sbi
->
s_md_lock
);

1674 
	}
}

1680 
	$pxt4_mb_check_limôs
(
pxt4_Æloˇti⁄_c⁄ãxt
 *
ac
,

1681 
pxt4_buddy
 *
e4b
,

1682 
föish_group
)

1684 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
ac
->
ac_sb
);

1685 
pxt4_‰ì_exã¡
 *
bex
 = &
ac
->
ac_b_ex
;

1686 
pxt4_‰ì_exã¡
 *
gex
 = &
ac
->
ac_g_ex
;

1687 
pxt4_‰ì_exã¡
 
ex
;

1688 
max
;

1690 i‡(
ac
->
ac_°©us
 =
AC_STATUS_FOUND
)

1695 i‡(
ac
->
ac_found
 > 
sbi
->
s_mb_max_to_sˇn
 &&

1696 !(
ac
->
ac_Êags
 & 
PXT4_MB_HINT_FIRST
)) {

1697 
ac
->
ac_°©us
 = 
AC_STATUS_BREAK
;

1704 i‡(
bex
->
„_Àn
 < 
gex
->fe_len)

1707 i‡((
föish_group
 || 
ac
->
ac_found
 > 
sbi
->
s_mb_mö_to_sˇn
)

1708 && 
bex
->
„_group
 =
e4b
->
bd_group
) {

1712 
max
 = 
	`mb_föd_exã¡
(
e4b
, 
bex
->
„_°¨t
, 
gex
->
„_Àn
, &
ex
);

1713 i‡(
max
 >
gex
->
„_Àn
) {

1714 
	`pxt4_mb_u£_be°_found
(
ac
, 
e4b
);

1718 
	}
}

1730 
	$pxt4_mb_mósuª_exã¡
(
pxt4_Æloˇti⁄_c⁄ãxt
 *
ac
,

1731 
pxt4_‰ì_exã¡
 *
ex
,

1732 
pxt4_buddy
 *
e4b
)

1734 
pxt4_‰ì_exã¡
 *
bex
 = &
ac
->
ac_b_ex
;

1735 
pxt4_‰ì_exã¡
 *
gex
 = &
ac
->
ac_g_ex
;

1737 
	`BUG_ON
(
ex
->
„_Àn
 <= 0);

1738 
	`BUG_ON
(
ex
->
„_Àn
 > 
	`PXT4_CLUSTERS_PER_GROUP
(
ac
->
ac_sb
));

1739 
	`BUG_ON
(
ex
->
„_°¨t
 >
	`PXT4_CLUSTERS_PER_GROUP
(
ac
->
ac_sb
));

1740 
	`BUG_ON
(
ac
->
ac_°©us
 !
AC_STATUS_CONTINUE
);

1742 
ac
->
ac_found
++;

1747 i‡(
	`u∆ikñy
(
ac
->
ac_Êags
 & 
PXT4_MB_HINT_FIRST
)) {

1748 *
bex
 = *
ex
;

1749 
	`pxt4_mb_u£_be°_found
(
ac
, 
e4b
);

1756 i‡(
ex
->
„_Àn
 =
gex
->fe_len) {

1757 *
bex
 = *
ex
;

1758 
	`pxt4_mb_u£_be°_found
(
ac
, 
e4b
);

1765 i‡(
bex
->
„_Àn
 == 0) {

1766 *
bex
 = *
ex
;

1773 i‡(
bex
->
„_Àn
 < 
gex
->fe_len) {

1776 i‡(
ex
->
„_Àn
 > 
bex
->fe_len)

1777 *
bex
 = *
ex
;

1778 } i‡(
ex
->
„_Àn
 > 
gex
->fe_len) {

1782 i‡(
ex
->
„_Àn
 < 
bex
->fe_len)

1783 *
bex
 = *
ex
;

1786 
	`pxt4_mb_check_limôs
(
ac
, 
e4b
, 0);

1787 
	}
}

1789 
noölöe_f‹_°ack


1790 
	$pxt4_mb_åy_be°_found
(
pxt4_Æloˇti⁄_c⁄ãxt
 *
ac
,

1791 
pxt4_buddy
 *
e4b
)

1793 
pxt4_‰ì_exã¡
 
ex
 = 
ac
->
ac_b_ex
;

1794 
pxt4_group_t
 
group
 = 
ex
.
„_group
;

1795 
max
;

1796 
îr
;

1798 
	`BUG_ON
(
ex
.
„_Àn
 <= 0);

1799 
îr
 = 
	`pxt4_mb_lﬂd_buddy
(
ac
->
ac_sb
, 
group
, 
e4b
);

1800 i‡(
îr
)

1801  
îr
;

1803 
	`pxt4_lock_group
(
ac
->
ac_sb
, 
group
);

1804 
max
 = 
	`mb_föd_exã¡
(
e4b
, 
ex
.
„_°¨t
,Éx.
„_Àn
, &ex);

1806 i‡(
max
 > 0) {

1807 
ac
->
ac_b_ex
 = 
ex
;

1808 
	`pxt4_mb_u£_be°_found
(
ac
, 
e4b
);

1811 
	`pxt4_u∆ock_group
(
ac
->
ac_sb
, 
group
);

1812 
	`pxt4_mb_u∆ﬂd_buddy
(
e4b
);

1815 
	}
}

1817 
noölöe_f‹_°ack


1818 
	$pxt4_mb_föd_by_gﬂl
(
pxt4_Æloˇti⁄_c⁄ãxt
 *
ac
,

1819 
pxt4_buddy
 *
e4b
)

1821 
pxt4_group_t
 
group
 = 
ac
->
ac_g_ex
.
„_group
;

1822 
max
;

1823 
îr
;

1824 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
ac
->
ac_sb
);

1825 
pxt4_group_öfo
 *
gΩ
 = 
	`pxt4_gë_group_öfo
(
ac
->
ac_sb
, 
group
);

1826 
pxt4_‰ì_exã¡
 
ex
;

1828 i‡(!(
ac
->
ac_Êags
 & 
PXT4_MB_HINT_TRY_GOAL
))

1830 i‡(
gΩ
->
bb_‰ì
 == 0)

1833 
îr
 = 
	`pxt4_mb_lﬂd_buddy
(
ac
->
ac_sb
, 
group
, 
e4b
);

1834 i‡(
îr
)

1835  
îr
;

1837 i‡(
	`u∆ikñy
(
	`PXT4_MB_GRP_BBITMAP_CORRUPT
(
e4b
->
bd_öfo
))) {

1838 
	`pxt4_mb_u∆ﬂd_buddy
(
e4b
);

1842 
	`pxt4_lock_group
(
ac
->
ac_sb
, 
group
);

1843 
max
 = 
	`mb_föd_exã¡
(
e4b
, 
ac
->
ac_g_ex
.
„_°¨t
,

1844 
ac
->
ac_g_ex
.
„_Àn
, &
ex
);

1845 
ex
.
„_logiˇl
 = 0xDEADFA11;

1847 i‡(
max
 >
ac
->
ac_g_ex
.
„_Àn
 &&ác->ac_g_ex.„_À¿=
sbi
->
s_°rùe
) {

1848 
pxt4_fsblk_t
 
°¨t
;

1850 
°¨t
 = 
	`pxt4_group_fú°_block_no
(
ac
->
ac_sb
, 
e4b
->
bd_group
) +

1851 
ex
.
„_°¨t
;

1853 i‡(
	`do_div
(
°¨t
, 
sbi
->
s_°rùe
) == 0) {

1854 
ac
->
ac_found
++;

1855 
ac
->
ac_b_ex
 = 
ex
;

1856 
	`pxt4_mb_u£_be°_found
(
ac
, 
e4b
);

1858 } i‡(
max
 >
ac
->
ac_g_ex
.
„_Àn
) {

1859 
	`BUG_ON
(
ex
.
„_Àn
 <= 0);

1860 
	`BUG_ON
(
ex
.
„_group
 !
ac
->
ac_g_ex
.fe_group);

1861 
	`BUG_ON
(
ex
.
„_°¨t
 !
ac
->
ac_g_ex
.fe_start);

1862 
ac
->
ac_found
++;

1863 
ac
->
ac_b_ex
 = 
ex
;

1864 
	`pxt4_mb_u£_be°_found
(
ac
, 
e4b
);

1865 } i‡(
max
 > 0 && (
ac
->
ac_Êags
 & 
PXT4_MB_HINT_MERGE
)) {

1868 
	`BUG_ON
(
ex
.
„_Àn
 <= 0);

1869 
	`BUG_ON
(
ex
.
„_group
 !
ac
->
ac_g_ex
.fe_group);

1870 
	`BUG_ON
(
ex
.
„_°¨t
 !
ac
->
ac_g_ex
.fe_start);

1871 
ac
->
ac_found
++;

1872 
ac
->
ac_b_ex
 = 
ex
;

1873 
	`pxt4_mb_u£_be°_found
(
ac
, 
e4b
);

1875 
	`pxt4_u∆ock_group
(
ac
->
ac_sb
, 
group
);

1876 
	`pxt4_mb_u∆ﬂd_buddy
(
e4b
);

1879 
	}
}

1885 
noölöe_f‹_°ack


1886 
	$pxt4_mb_sim∂e_sˇn_group
(
pxt4_Æloˇti⁄_c⁄ãxt
 *
ac
,

1887 
pxt4_buddy
 *
e4b
)

1889 
su≥r_block
 *
sb
 = 
ac
->
ac_sb
;

1890 
pxt4_group_öfo
 *
gΩ
 = 
e4b
->
bd_öfo
;

1891 *
buddy
;

1892 
i
;

1893 
k
;

1894 
max
;

1896 
	`BUG_ON
(
ac
->
ac_2‹dî
 <= 0);

1897 
i
 = 
ac
->
ac_2‹dî
; i <
sb
->
s_blocksize_bôs
 + 1; i++) {

1898 i‡(
gΩ
->
bb_cou¡îs
[
i
] == 0)

1901 
buddy
 = 
	`mb_föd_buddy
(
e4b
, 
i
, &
max
);

1902 
	`BUG_ON
(
buddy
 =
NULL
);

1904 
k
 = 
	`mb_föd_√xt_zîo_bô
(
buddy
, 
max
, 0);

1905 i‡(
k
 >
max
) {

1906 
	`pxt4_gΩ_locked_îr‹
(
ac
->
ac_sb
, 
e4b
->
bd_group
, 0, 0,

1908 
gΩ
->
bb_cou¡îs
[
i
], i);

1909 
	`pxt4_m¨k_group_bôm≠_c‹ru±ed
(
ac
->
ac_sb
,

1910 
e4b
->
bd_group
,

1911 
PXT4_GROUP_INFO_BBITMAP_CORRUPT
);

1914 
ac
->
ac_found
++;

1916 
ac
->
ac_b_ex
.
„_Àn
 = 1 << 
i
;

1917 
ac
->
ac_b_ex
.
„_°¨t
 = 
k
 << 
i
;

1918 
ac
->
ac_b_ex
.
„_group
 = 
e4b
->
bd_group
;

1920 
	`pxt4_mb_u£_be°_found
(
ac
, 
e4b
);

1922 
	`BUG_ON
(
ac
->
ac_b_ex
.
„_Àn
 !ac->
ac_g_ex
.fe_len);

1924 i‡(
	`PXT4_SB
(
sb
)->
s_mb_°©s
)

1925 
	`©omic_öc
(&
	`PXT4_SB
(
sb
)->
s_bÆ_2‹dîs
);

1929 
	}
}

1936 
noölöe_f‹_°ack


1937 
	$pxt4_mb_com∂ex_sˇn_group
(
pxt4_Æloˇti⁄_c⁄ãxt
 *
ac
,

1938 
pxt4_buddy
 *
e4b
)

1940 
su≥r_block
 *
sb
 = 
ac
->
ac_sb
;

1941 *
bôm≠
 = 
e4b
->
bd_bôm≠
;

1942 
pxt4_‰ì_exã¡
 
ex
;

1943 
i
;

1944 
‰ì
;

1946 
‰ì
 = 
e4b
->
bd_öfo
->
bb_‰ì
;

1947 i‡(
	`WARN_ON
(
‰ì
 <= 0))

1950 
i
 = 
e4b
->
bd_öfo
->
bb_fú°_‰ì
;

1952 
‰ì
 && 
ac
->
ac_°©us
 =
AC_STATUS_CONTINUE
) {

1953 
i
 = 
	`mb_föd_√xt_zîo_bô
(
bôm≠
,

1954 
	`PXT4_CLUSTERS_PER_GROUP
(
sb
), 
i
);

1955 i‡(
i
 >
	`PXT4_CLUSTERS_PER_GROUP
(
sb
)) {

1961 
	`pxt4_gΩ_locked_îr‹
(
sb
, 
e4b
->
bd_group
, 0, 0,

1964 
‰ì
);

1965 
	`pxt4_m¨k_group_bôm≠_c‹ru±ed
(
sb
, 
e4b
->
bd_group
,

1966 
PXT4_GROUP_INFO_BBITMAP_CORRUPT
);

1970 
	`mb_föd_exã¡
(
e4b
, 
i
, 
ac
->
ac_g_ex
.
„_Àn
, &
ex
);

1971 i‡(
	`WARN_ON
(
ex
.
„_Àn
 <= 0))

1973 i‡(
‰ì
 < 
ex
.
„_Àn
) {

1974 
	`pxt4_gΩ_locked_îr‹
(
sb
, 
e4b
->
bd_group
, 0, 0,

1977 
‰ì
, 
ex
.
„_Àn
);

1978 
	`pxt4_m¨k_group_bôm≠_c‹ru±ed
(
sb
, 
e4b
->
bd_group
,

1979 
PXT4_GROUP_INFO_BBITMAP_CORRUPT
);

1987 
ex
.
„_logiˇl
 = 0xDEADC0DE;

1988 
	`pxt4_mb_mósuª_exã¡
(
ac
, &
ex
, 
e4b
);

1990 
i
 +
ex
.
„_Àn
;

1991 
‰ì
 -
ex
.
„_Àn
;

1994 
	`pxt4_mb_check_limôs
(
ac
, 
e4b
, 1);

1995 
	}
}

2001 
noölöe_f‹_°ack


2002 
	$pxt4_mb_sˇn_Æig√d
(
pxt4_Æloˇti⁄_c⁄ãxt
 *
ac
,

2003 
pxt4_buddy
 *
e4b
)

2005 
su≥r_block
 *
sb
 = 
ac
->
ac_sb
;

2006 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
sb
);

2007 *
bôm≠
 = 
e4b
->
bd_bôm≠
;

2008 
pxt4_‰ì_exã¡
 
ex
;

2009 
pxt4_fsblk_t
 
fú°_group_block
;

2010 
pxt4_fsblk_t
 
a
;

2011 
pxt4_gΩblk_t
 
i
;

2012 
max
;

2014 
	`BUG_ON
(
sbi
->
s_°rùe
 == 0);

2017 
fú°_group_block
 = 
	`pxt4_group_fú°_block_no
(
sb
, 
e4b
->
bd_group
);

2019 
a
 = 
fú°_group_block
 + 
sbi
->
s_°rùe
 - 1;

2020 
	`do_div
(
a
, 
sbi
->
s_°rùe
);

2021 
i
 = (
a
 * 
sbi
->
s_°rùe
Ë- 
fú°_group_block
;

2023 
i
 < 
	`PXT4_CLUSTERS_PER_GROUP
(
sb
)) {

2024 i‡(!
	`mb_ã°_bô
(
i
, 
bôm≠
)) {

2025 
max
 = 
	`mb_föd_exã¡
(
e4b
, 
i
, 
sbi
->
s_°rùe
, &
ex
);

2026 i‡(
max
 >
sbi
->
s_°rùe
) {

2027 
ac
->
ac_found
++;

2028 
ex
.
„_logiˇl
 = 0xDEADF00D;

2029 
ac
->
ac_b_ex
 = 
ex
;

2030 
	`pxt4_mb_u£_be°_found
(
ac
, 
e4b
);

2034 
i
 +
sbi
->
s_°rùe
;

2036 
	}
}

2044 
	$pxt4_mb_good_group
(
pxt4_Æloˇti⁄_c⁄ãxt
 *
ac
,

2045 
pxt4_group_t
 
group
, 
¸
)

2047 
‰ì
, 
‰agmíts
;

2048 
Êex_size
 = 
	`pxt4_Êex_bg_size
(
	`PXT4_SB
(
ac
->
ac_sb
));

2049 
pxt4_group_öfo
 *
gΩ
 = 
	`pxt4_gë_group_öfo
(
ac
->
ac_sb
, 
group
);

2051 
	`BUG_ON
(
¸
 < 0 || cr >= 4);

2053 
‰ì
 = 
gΩ
->
bb_‰ì
;

2054 i‡(
‰ì
 == 0)

2056 i‡(
¸
 <2 && 
‰ì
 < 
ac
->
ac_g_ex
.
„_Àn
)

2059 i‡(
	`u∆ikñy
(
	`PXT4_MB_GRP_BBITMAP_CORRUPT
(
gΩ
)))

2063 i‡(
	`u∆ikñy
(
	`PXT4_MB_GRP_NEED_INIT
(
gΩ
))) {

2064 
ªt
 = 
	`pxt4_mb_öô_group
(
ac
->
ac_sb
, 
group
, 
GFP_NOFS
);

2065 i‡(
ªt
)

2066  
ªt
;

2069 
‰agmíts
 = 
gΩ
->
bb_‰agmíts
;

2070 i‡(
‰agmíts
 == 0)

2073 
¸
) {

2075 
	`BUG_ON
(
ac
->
ac_2‹dî
 == 0);

2078 i‡((
ac
->
ac_Êags
 & 
PXT4_MB_HINT_DATA
) &&

2079 (
Êex_size
 >
PXT4_FLEX_SIZE_DIR_ALLOC_SCHEME
) &&

2080 ((
group
 % 
Êex_size
) == 0))

2083 i‡((
ac
->
ac_2‹dî
 >ác->
ac_sb
->
s_blocksize_bôs
+1) ||

2084 (
‰ì
 / 
‰agmíts
Ë>
ac
->
ac_g_ex
.
„_Àn
)

2087 i‡(
gΩ
->
bb_œrge°_‰ì_‹dî
 < 
ac
->
ac_2‹dî
)

2092 i‡((
‰ì
 / 
‰agmíts
Ë>
ac
->
ac_g_ex
.
„_Àn
)

2096 i‡(
‰ì
 >
ac
->
ac_g_ex
.
„_Àn
)

2102 
	`BUG
();

2106 
	}
}

2108 
noölöe_f‹_°ack
 

2109 
	$pxt4_mb_ªguœr_Æloˇt‹
(
pxt4_Æloˇti⁄_c⁄ãxt
 *
ac
)

2111 
pxt4_group_t
 
ngroups
, 
group
, 
i
;

2112 
¸
;

2113 
îr
 = 0, 
fú°_îr
 = 0;

2114 
pxt4_sb_öfo
 *
sbi
;

2115 
su≥r_block
 *
sb
;

2116 
pxt4_buddy
 
e4b
;

2118 
sb
 = 
ac
->
ac_sb
;

2119 
sbi
 = 
	`PXT4_SB
(
sb
);

2120 
ngroups
 = 
	`pxt4_gë_groups_cou¡
(
sb
);

2122 i‡(!(
	`pxt4_ã°_öode_Êag
(
ac
->
ac_öode
, 
PXT4_INODE_EXTENTS
)))

2123 
ngroups
 = 
sbi
->
s_blockfûe_groups
;

2125 
	`BUG_ON
(
ac
->
ac_°©us
 =
AC_STATUS_FOUND
);

2128 
îr
 = 
	`pxt4_mb_föd_by_gﬂl
(
ac
, &
e4b
);

2129 i‡(
îr
 || 
ac
->
ac_°©us
 =
AC_STATUS_FOUND
)

2130 
out
;

2132 i‡(
	`u∆ikñy
(
ac
->
ac_Êags
 & 
PXT4_MB_HINT_GOAL_ONLY
))

2133 
out
;

2140 
i
 = 
	`Ês
(
ac
->
ac_g_ex
.
„_Àn
);

2141 
ac
->
ac_2‹dî
 = 0;

2149 i‡(
i
 >
sbi
->
s_mb_‹dî2_ªqs
 && i <
sb
->
s_blocksize_bôs
 + 2) {

2153 i‡((
ac
->
ac_g_ex
.
„_Àn
 & (~(1 << (
i
 - 1)))) == 0)

2154 
ac
->
ac_2‹dî
 = 
	`¨øy_ödex_no•ec
(
i
 - 1,

2155 
sb
->
s_blocksize_bôs
 + 2);

2159 i‡(
ac
->
ac_Êags
 & 
PXT4_MB_STREAM_ALLOC
) {

2161 
	`•ö_lock
(&
sbi
->
s_md_lock
);

2162 
ac
->
ac_g_ex
.
„_group
 = 
sbi
->
s_mb_œ°_group
;

2163 
ac
->
ac_g_ex
.
„_°¨t
 = 
sbi
->
s_mb_œ°_°¨t
;

2164 
	`•ö_u∆ock
(&
sbi
->
s_md_lock
);

2168 
¸
 = 
ac
->
ac_2‹dî
 ? 0 : 1;

2173 
ª≥©
:

2174 ; 
¸
 < 4 && 
ac
->
ac_°©us
 =
AC_STATUS_CONTINUE
; cr++) {

2175 
ac
->
ac_¸ôîü
 = 
¸
;

2180 
group
 = 
ac
->
ac_g_ex
.
„_group
;

2182 
i
 = 0; i < 
ngroups
; 
group
++, i++) {

2183 
ªt
 = 0;

2184 
	`c⁄d_ªsched
();

2189 i‡(
group
 >
ngroups
)

2190 
group
 = 0;

2193 
ªt
 = 
	`pxt4_mb_good_group
(
ac
, 
group
, 
¸
);

2194 i‡(
ªt
 <= 0) {

2195 i‡(!
fú°_îr
)

2196 
fú°_îr
 = 
ªt
;

2200 
îr
 = 
	`pxt4_mb_lﬂd_buddy
(
sb
, 
group
, &
e4b
);

2201 i‡(
îr
)

2202 
out
;

2204 
	`pxt4_lock_group
(
sb
, 
group
);

2210 
ªt
 = 
	`pxt4_mb_good_group
(
ac
, 
group
, 
¸
);

2211 i‡(
ªt
 <= 0) {

2212 
	`pxt4_u∆ock_group
(
sb
, 
group
);

2213 
	`pxt4_mb_u∆ﬂd_buddy
(&
e4b
);

2214 i‡(!
fú°_îr
)

2215 
fú°_îr
 = 
ªt
;

2219 
ac
->
ac_groups_sˇ¬ed
++;

2220 i‡(
¸
 == 0)

2221 
	`pxt4_mb_sim∂e_sˇn_group
(
ac
, &
e4b
);

2222 i‡(
¸
 =1 && 
sbi
->
s_°rùe
 &&

2223 !(
ac
->
ac_g_ex
.
„_Àn
 % 
sbi
->
s_°rùe
))

2224 
	`pxt4_mb_sˇn_Æig√d
(
ac
, &
e4b
);

2226 
	`pxt4_mb_com∂ex_sˇn_group
(
ac
, &
e4b
);

2228 
	`pxt4_u∆ock_group
(
sb
, 
group
);

2229 
	`pxt4_mb_u∆ﬂd_buddy
(&
e4b
);

2231 i‡(
ac
->
ac_°©us
 !
AC_STATUS_CONTINUE
)

2236 i‡(
ac
->
ac_b_ex
.
„_Àn
 > 0 &&ác->
ac_°©us
 !
AC_STATUS_FOUND
 &&

2237 !(
ac
->
ac_Êags
 & 
PXT4_MB_HINT_FIRST
)) {

2243 
	`pxt4_mb_åy_be°_found
(
ac
, &
e4b
);

2244 i‡(
ac
->
ac_°©us
 !
AC_STATUS_FOUND
) {

2251 
ac
->
ac_b_ex
.
„_group
 = 0;

2252 
ac
->
ac_b_ex
.
„_°¨t
 = 0;

2253 
ac
->
ac_b_ex
.
„_Àn
 = 0;

2254 
ac
->
ac_°©us
 = 
AC_STATUS_CONTINUE
;

2255 
ac
->
ac_Êags
 |
PXT4_MB_HINT_FIRST
;

2256 
¸
 = 3;

2257 
	`©omic_öc
(&
sbi
->
s_mb_lo°_chunks
);

2258 
ª≥©
;

2261 
out
:

2262 i‡(!
îr
 && 
ac
->
ac_°©us
 !
AC_STATUS_FOUND
 && 
fú°_îr
)

2263 
îr
 = 
fú°_îr
;

2264  
îr
;

2265 
	}
}

2267 *
	$pxt4_mb_£q_groups_°¨t
(
£q_fûe
 *
£q
, 
loff_t
 *
pos
)

2269 
su≥r_block
 *
sb
 = 
	`PDE_DATA
(
	`fûe_öode
(
£q
->
fûe
));

2270 
pxt4_group_t
 
group
;

2272 i‡(*
pos
 < 0 || *po†>
	`pxt4_gë_groups_cou¡
(
sb
))

2273  
NULL
;

2274 
group
 = *
pos
 + 1;

2275  (*Ë((Ë
group
);

2276 
	}
}

2278 *
	$pxt4_mb_£q_groups_√xt
(
£q_fûe
 *
£q
, *
v
, 
loff_t
 *
pos
)

2280 
su≥r_block
 *
sb
 = 
	`PDE_DATA
(
	`fûe_öode
(
£q
->
fûe
));

2281 
pxt4_group_t
 
group
;

2283 ++*
pos
;

2284 i‡(*
pos
 < 0 || *po†>
	`pxt4_gë_groups_cou¡
(
sb
))

2285  
NULL
;

2286 
group
 = *
pos
 + 1;

2287  (*Ë((Ë
group
);

2288 
	}
}

2290 
	$pxt4_mb_£q_groups_show
(
£q_fûe
 *
£q
, *
v
)

2292 
su≥r_block
 *
sb
 = 
	`PDE_DATA
(
	`fûe_öode
(
£q
->
fûe
));

2293 
pxt4_group_t
 
group
 = (pxt4_group_tË((Ë
v
);

2294 
i
;

2295 
îr
, 
buddy_lﬂded
 = 0;

2296 
pxt4_buddy
 
e4b
;

2297 
pxt4_group_öfo
 *
gröfo
;

2298 
blocksize_bôs
 = 
	`mö_t
(,

2299 
sb
->
s_blocksize_bôs
,

2300 
PXT4_MAX_BLOCK_LOG_SIZE
);

2301 
	ssg
 {

2302 
pxt4_group_öfo
 
öfo
;

2303 
pxt4_gΩblk_t
 
cou¡îs
[
PXT4_MAX_BLOCK_LOG_SIZE
 + 2];

2304 } 
sg
;

2306 
group
--;

2307 i‡(
group
 == 0)

2308 
	`£q_puts
(
£q
, "#group: free frags first ["

2312 
i
 = (
blocksize_bôs
 + 2Ë* (
sg
.
öfo
.
bb_cou¡îs
[0]) +

2313 (
pxt4_group_öfo
);

2315 
gröfo
 = 
	`pxt4_gë_group_öfo
(
sb
, 
group
);

2317 i‡(
	`u∆ikñy
(
	`PXT4_MB_GRP_NEED_INIT
(
gröfo
))) {

2318 
îr
 = 
	`pxt4_mb_lﬂd_buddy
(
sb
, 
group
, &
e4b
);

2319 i‡(
îr
) {

2320 
	`£q_¥ötf
(
£q
, "#%-5u: I/OÉº‹\n", 
group
);

2323 
buddy_lﬂded
 = 1;

2326 
	`mem˝y
(&
sg
, 
	`pxt4_gë_group_öfo
(
sb
, 
group
), 
i
);

2328 i‡(
buddy_lﬂded
)

2329 
	`pxt4_mb_u∆ﬂd_buddy
(&
e4b
);

2331 
	`£q_¥ötf
(
£q
, "#%-5u: %-5u %-5u %-5u [", 
group
, 
sg
.
öfo
.
bb_‰ì
,

2332 
sg
.
öfo
.
bb_‰agmíts
, sg.öfo.
bb_fú°_‰ì
);

2333 
i
 = 0; i <= 13; i++)

2334 
	`£q_¥ötf
(
£q
, " %-5u", 
i
 <
blocksize_bôs
 + 1 ?

2335 
sg
.
öfo
.
bb_cou¡îs
[
i
] : 0);

2336 
	`£q_¥ötf
(
£q
, " ]\n");

2339 
	}
}

2341 
	$pxt4_mb_£q_groups_°›
(
£q_fûe
 *
£q
, *
v
)

2343 
	}
}

2345 c⁄° 
£q_›î©i⁄s
 
	gpxt4_mb_£q_groups_›s
 = {

2346 .
°¨t
 = 
pxt4_mb_£q_groups_°¨t
,

2347 .
	g√xt
 = 
pxt4_mb_£q_groups_√xt
,

2348 .
	g°›
 = 
pxt4_mb_£q_groups_°›
,

2349 .
	gshow
 = 
pxt4_mb_£q_groups_show
,

2352 
kmem_ˇche
 *
	$gë_groupöfo_ˇche
(
blocksize_bôs
)

2354 
ˇche_ödex
 = 
blocksize_bôs
 - 
PXT4_MIN_BLOCK_LOG_SIZE
;

2355 
kmem_ˇche
 *
ˇchï
 = 
pxt4_groupöfo_ˇches
[
ˇche_ödex
];

2357 
	`BUG_ON
(!
ˇchï
);

2358  
ˇchï
;

2359 
	}
}

2365 
	$pxt4_mb_Æloc_groupöfo
(
su≥r_block
 *
sb
, 
pxt4_group_t
 
ngroups
)

2367 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
sb
);

2368 
size
;

2369 
pxt4_group_öfo
 ***
ﬁd_groupöfo
, ***
√w_groupöfo
;

2371 
size
 = (
ngroups
 + 
	`PXT4_DESC_PER_BLOCK
(
sb
) - 1) >>

2372 
	`PXT4_DESC_PER_BLOCK_BITS
(
sb
);

2373 i‡(
size
 <
sbi
->
s_group_öfo_size
)

2376 
size
 = 
	`roundup_pow_of_two
((*
sbi
->
s_group_öfo
) * size);

2377 
√w_groupöfo
 = 
	`kvzÆloc
(
size
, 
GFP_KERNEL
);

2378 i‡(!
√w_groupöfo
) {

2379 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "can'tállocate buddy meta group");

2380  -
ENOMEM
;

2382 
	`rcu_ªad_lock
();

2383 
ﬁd_groupöfo
 = 
	`rcu_dîe„ªn˚
(
sbi
->
s_group_öfo
);

2384 i‡(
ﬁd_groupöfo
)

2385 
	`mem˝y
(
√w_groupöfo
, 
ﬁd_groupöfo
,

2386 
sbi
->
s_group_öfo_size
 * (*sbi->
s_group_öfo
));

2387 
	`rcu_ªad_u∆ock
();

2388 
	`rcu_assign_poöãr
(
sbi
->
s_group_öfo
, 
√w_groupöfo
);

2389 
sbi
->
s_group_öfo_size
 = 
size
 / (*sbi->
s_group_öfo
);

2390 i‡(
ﬁd_groupöfo
)

2391 
	`pxt4_kv‰ì_¨øy_rcu
(
ﬁd_groupöfo
);

2392 
	`pxt4_debug
("allocated s_groupinfoárray for %d meta_bg's\n",

2393 
sbi
->
s_group_öfo_size
);

2395 
	}
}

2398 
	$pxt4_mb_add_groupöfo
(
su≥r_block
 *
sb
, 
pxt4_group_t
 
group
,

2399 
pxt4_group_desc
 *
desc
)

2401 
i
;

2402 
mëÆí
 = 0;

2403 
idx
 = 
group
 >> 
	`PXT4_DESC_PER_BLOCK_BITS
(
sb
);

2404 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
sb
);

2405 
pxt4_group_öfo
 **
mëa_group_öfo
;

2406 
kmem_ˇche
 *
ˇchï
 = 
	`gë_groupöfo_ˇche
(
sb
->
s_blocksize_bôs
);

2413 i‡(
group
 % 
	`PXT4_DESC_PER_BLOCK
(
sb
) == 0) {

2414 
mëÆí
 = (*
mëa_group_öfo
) <<

2415 
	`PXT4_DESC_PER_BLOCK_BITS
(
sb
);

2416 
mëa_group_öfo
 = 
	`kmÆloc
(
mëÆí
, 
GFP_NOFS
);

2417 i‡(
mëa_group_öfo
 =
NULL
) {

2418 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "can'tállocate mem "

2420 
exô_mëa_group_öfo
;

2422 
	`rcu_ªad_lock
();

2423 
	`rcu_dîe„ªn˚
(
sbi
->
s_group_öfo
)[
idx
] = 
mëa_group_öfo
;

2424 
	`rcu_ªad_u∆ock
();

2427 
mëa_group_öfo
 = 
	`sbi_¨øy_rcu_dîef
(
sbi
, 
s_group_öfo
, 
idx
);

2428 
i
 = 
group
 & (
	`PXT4_DESC_PER_BLOCK
(
sb
) - 1);

2430 
mëa_group_öfo
[
i
] = 
	`kmem_ˇche_zÆloc
(
ˇchï
, 
GFP_NOFS
);

2431 i‡(
mëa_group_öfo
[
i
] =
NULL
) {

2432 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "can'tállocate buddy mem");

2433 
exô_group_öfo
;

2435 
	`£t_bô
(
PXT4_GROUP_INFO_NEED_INIT_BIT
,

2436 &(
mëa_group_öfo
[
i
]->
bb_°©e
));

2442 i‡(
	`pxt4_has_group_desc_csum
(
sb
) &&

2443 (
desc
->
bg_Êags
 & 
	`˝u_to_À16
(
PXT4_BG_BLOCK_UNINIT
))) {

2444 
mëa_group_öfo
[
i
]->
bb_‰ì
 =

2445 
	`pxt4_‰ì_˛u°îs_a·î_öô
(
sb
, 
group
, 
desc
);

2447 
mëa_group_öfo
[
i
]->
bb_‰ì
 =

2448 
	`pxt4_‰ì_group_˛u°îs
(
sb
, 
desc
);

2451 
	`INIT_LIST_HEAD
(&
mëa_group_öfo
[
i
]->
bb_¥óŒoc_li°
);

2452 
	`öô_rw£m
(&
mëa_group_öfo
[
i
]->
Æloc_£m
);

2453 
mëa_group_öfo
[
i
]->
bb_‰ì_roŸ
 = 
RB_ROOT
;

2454 
mëa_group_öfo
[
i
]->
bb_œrge°_‰ì_‹dî
 = -1;

2456 #ifde‡
DOUBLE_CHECK


2458 
buf„r_hód
 *
bh
;

2459 
mëa_group_öfo
[
i
]->
bb_bôm≠
 =

2460 
	`kmÆloc
(
sb
->
s_blocksize
, 
GFP_NOFS
);

2461 
	`BUG_ON
(
mëa_group_öfo
[
i
]->
bb_bôm≠
 =
NULL
);

2462 
bh
 = 
	`pxt4_ªad_block_bôm≠
(
sb
, 
group
);

2463 
	`BUG_ON
(
	`IS_ERR_OR_NULL
(
bh
));

2464 
	`mem˝y
(
mëa_group_öfo
[
i
]->
bb_bôm≠
, 
bh
->
b_d©a
,

2465 
sb
->
s_blocksize
);

2466 
	`put_bh
(
bh
);

2472 
exô_group_öfo
:

2474 i‡(
group
 % 
	`PXT4_DESC_PER_BLOCK
(
sb
) == 0) {

2475 
pxt4_group_öfo
 ***
group_öfo
;

2477 
	`rcu_ªad_lock
();

2478 
group_öfo
 = 
	`rcu_dîe„ªn˚
(
sbi
->
s_group_öfo
);

2479 
	`k‰ì
(
group_öfo
[
idx
]);

2480 
group_öfo
[
idx
] = 
NULL
;

2481 
	`rcu_ªad_u∆ock
();

2483 
exô_mëa_group_öfo
:

2484  -
ENOMEM
;

2485 
	}
}

2487 
	$pxt4_mb_öô_backíd
(
su≥r_block
 *
sb
)

2489 
pxt4_group_t
 
ngroups
 = 
	`pxt4_gë_groups_cou¡
(
sb
);

2490 
pxt4_group_t
 
i
;

2491 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
sb
);

2492 
îr
;

2493 
pxt4_group_desc
 *
desc
;

2494 
pxt4_group_öfo
 ***
group_öfo
;

2495 
kmem_ˇche
 *
ˇchï
;

2497 
îr
 = 
	`pxt4_mb_Æloc_groupöfo
(
sb
, 
ngroups
);

2498 i‡(
îr
)

2499  
îr
;

2501 
sbi
->
s_buddy_ˇche
 = 
	`√w_öode
(
sb
);

2502 i‡(
sbi
->
s_buddy_ˇche
 =
NULL
) {

2503 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "can't getÇew inode");

2504 
îr_‰ìsgi
;

2510 
sbi
->
s_buddy_ˇche
->
i_öo
 = 
PXT4_BAD_INO
;

2511 
	`PXT4_I
(
sbi
->
s_buddy_ˇche
)->
i_disksize
 = 0;

2512 
i
 = 0; i < 
ngroups
; i++) {

2513 
	`c⁄d_ªsched
();

2514 
desc
 = 
	`pxt4_gë_group_desc
(
sb
, 
i
, 
NULL
);

2515 i‡(
desc
 =
NULL
) {

2516 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "ˇn'àªad des¸ùt‹ %u", 
i
);

2517 
îr_‰ìbuddy
;

2519 i‡(
	`pxt4_mb_add_groupöfo
(
sb
, 
i
, 
desc
) != 0)

2520 
îr_‰ìbuddy
;

2525 
îr_‰ìbuddy
:

2526 
ˇchï
 = 
	`gë_groupöfo_ˇche
(
sb
->
s_blocksize_bôs
);

2527 
i
-- > 0)

2528 
	`kmem_ˇche_‰ì
(
ˇchï
, 
	`pxt4_gë_group_öfo
(
sb
, 
i
));

2529 
i
 = 
sbi
->
s_group_öfo_size
;

2530 
	`rcu_ªad_lock
();

2531 
group_öfo
 = 
	`rcu_dîe„ªn˚
(
sbi
->
s_group_öfo
);

2532 
i
-- > 0)

2533 
	`k‰ì
(
group_öfo
[
i
]);

2534 
	`rcu_ªad_u∆ock
();

2535 
	`ùut
(
sbi
->
s_buddy_ˇche
);

2536 
îr_‰ìsgi
:

2537 
	`rcu_ªad_lock
();

2538 
	`kv‰ì
(
	`rcu_dîe„ªn˚
(
sbi
->
s_group_öfo
));

2539 
	`rcu_ªad_u∆ock
();

2540  -
ENOMEM
;

2541 
	}
}

2543 
	$pxt4_groupöfo_de°roy_¶abs
()

2545 
i
;

2547 
i
 = 0; i < 
NR_GRPINFO_CACHES
; i++) {

2548 
	`kmem_ˇche_de°roy
(
pxt4_groupöfo_ˇches
[
i
]);

2549 
pxt4_groupöfo_ˇches
[
i
] = 
NULL
;

2551 
	}
}

2553 
	$pxt4_groupöfo_¸óã_¶ab
(
size_t
 
size
)

2555 
	`DEFINE_MUTEX
(
pxt4_gΩöfo_¶ab_¸óã_muãx
);

2556 
¶ab_size
;

2557 
blocksize_bôs
 = 
	`‹dî_ba£_2
(
size
);

2558 
ˇche_ödex
 = 
blocksize_bôs
 - 
PXT4_MIN_BLOCK_LOG_SIZE
;

2559 
kmem_ˇche
 *
ˇchï
;

2561 i‡(
ˇche_ödex
 >
NR_GRPINFO_CACHES
)

2562  -
EINVAL
;

2564 i‡(
	`u∆ikñy
(
ˇche_ödex
 < 0))

2565 
ˇche_ödex
 = 0;

2567 
	`muãx_lock
(&
pxt4_gΩöfo_¶ab_¸óã_muãx
);

2568 i‡(
pxt4_groupöfo_ˇches
[
ˇche_ödex
]) {

2569 
	`muãx_u∆ock
(&
pxt4_gΩöfo_¶ab_¸óã_muãx
);

2573 
¶ab_size
 = 
	`off£tof
(
pxt4_group_öfo
,

2574 
bb_cou¡îs
[
blocksize_bôs
 + 2]);

2576 
ˇchï
 = 
	`kmem_ˇche_¸óã
(
pxt4_groupöfo_¶ab_«mes
[
ˇche_ödex
],

2577 
¶ab_size
, 0, 
SLAB_RECLAIM_ACCOUNT
,

2578 
NULL
);

2580 
pxt4_groupöfo_ˇches
[
ˇche_ödex
] = 
ˇchï
;

2582 
	`muãx_u∆ock
(&
pxt4_gΩöfo_¶ab_¸óã_muãx
);

2583 i‡(!
ˇchï
) {

2584 
	`¥ötk
(
KERN_EMERG


2586  -
ENOMEM
;

2590 
	}
}

2592 
	$pxt4_mb_öô
(
su≥r_block
 *
sb
)

2594 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
sb
);

2595 
i
, 
j
;

2596 
off£t
, 
off£t_ö¸
;

2597 
max
;

2598 
ªt
;

2600 
i
 = (
sb
->
s_blocksize_bôs
 + 2Ë* (*
sbi
->
s_mb_off£ts
);

2602 
sbi
->
s_mb_off£ts
 = 
	`kmÆloc
(
i
, 
GFP_KERNEL
);

2603 i‡(
sbi
->
s_mb_off£ts
 =
NULL
) {

2604 
ªt
 = -
ENOMEM
;

2605 
out
;

2608 
i
 = (
sb
->
s_blocksize_bôs
 + 2Ë* (*
sbi
->
s_mb_maxs
);

2609 
sbi
->
s_mb_maxs
 = 
	`kmÆloc
(
i
, 
GFP_KERNEL
);

2610 i‡(
sbi
->
s_mb_maxs
 =
NULL
) {

2611 
ªt
 = -
ENOMEM
;

2612 
out
;

2615 
ªt
 = 
	`pxt4_groupöfo_¸óã_¶ab
(
sb
->
s_blocksize
);

2616 i‡(
ªt
 < 0)

2617 
out
;

2620 
sbi
->
s_mb_maxs
[0] = 
sb
->
s_blocksize
 << 3;

2621 
sbi
->
s_mb_off£ts
[0] = 0;

2623 
i
 = 1;

2624 
off£t
 = 0;

2625 
off£t_ö¸
 = 1 << (
sb
->
s_blocksize_bôs
 - 1);

2626 
max
 = 
sb
->
s_blocksize
 << 2;

2628 
sbi
->
s_mb_off£ts
[
i
] = 
off£t
;

2629 
sbi
->
s_mb_maxs
[
i
] = 
max
;

2630 
off£t
 +
off£t_ö¸
;

2631 
off£t_ö¸
 = offset_incr >> 1;

2632 
max
 = max >> 1;

2633 
i
++;

2634 } 
i
 <
sb
->
s_blocksize_bôs
 + 1);

2636 
	`•ö_lock_öô
(&
sbi
->
s_md_lock
);

2637 
	`•ö_lock_öô
(&
sbi
->
s_bÆ_lock
);

2638 
sbi
->
s_mb_‰ì_≥ndög
 = 0;

2639 
	`INIT_LIST_HEAD
(&
sbi
->
s_‰ìd_d©a_li°
);

2641 
sbi
->
s_mb_max_to_sˇn
 = 
MB_DEFAULT_MAX_TO_SCAN
;

2642 
sbi
->
s_mb_mö_to_sˇn
 = 
MB_DEFAULT_MIN_TO_SCAN
;

2643 
sbi
->
s_mb_°©s
 = 
MB_DEFAULT_STATS
;

2644 
sbi
->
s_mb_°ªam_ªque°
 = 
MB_DEFAULT_STREAM_THRESHOLD
;

2645 
sbi
->
s_mb_‹dî2_ªqs
 = 
MB_DEFAULT_ORDER2_REQS
;

2658 
sbi
->
s_mb_group_¥óŒoc
 = 
	`max
(
MB_DEFAULT_GROUP_PREALLOC
 >>

2659 
sbi
->
s_˛u°î_bôs
, 32);

2668 i‡(
sbi
->
s_°rùe
 > 1) {

2669 
sbi
->
s_mb_group_¥óŒoc
 = 
	`roundup
(

2670 
sbi
->
s_mb_group_¥óŒoc
, sbi->
s_°rùe
);

2673 
sbi
->
s_loˇlôy_groups
 = 
	`Æloc_≥r˝u
(
pxt4_loˇlôy_group
);

2674 i‡(
sbi
->
s_loˇlôy_groups
 =
NULL
) {

2675 
ªt
 = -
ENOMEM
;

2676 
out
;

2678 
	`f‹_óch_possibÀ_˝u
(
i
) {

2679 
pxt4_loˇlôy_group
 *
lg
;

2680 
lg
 = 
	`≥r_˝u_±r
(
sbi
->
s_loˇlôy_groups
, 
i
);

2681 
	`muãx_öô
(&
lg
->
lg_muãx
);

2682 
j
 = 0; j < 
PREALLOC_TB_SIZE
; j++)

2683 
	`INIT_LIST_HEAD
(&
lg
->
lg_¥óŒoc_li°
[
j
]);

2684 
	`•ö_lock_öô
(&
lg
->
lg_¥óŒoc_lock
);

2688 
ªt
 = 
	`pxt4_mb_öô_backíd
(
sb
);

2689 i‡(
ªt
 != 0)

2690 
out_‰ì_loˇlôy_groups
;

2694 
out_‰ì_loˇlôy_groups
:

2695 
	`‰ì_≥r˝u
(
sbi
->
s_loˇlôy_groups
);

2696 
sbi
->
s_loˇlôy_groups
 = 
NULL
;

2697 
out
:

2698 
	`k‰ì
(
sbi
->
s_mb_off£ts
);

2699 
sbi
->
s_mb_off£ts
 = 
NULL
;

2700 
	`k‰ì
(
sbi
->
s_mb_maxs
);

2701 
sbi
->
s_mb_maxs
 = 
NULL
;

2702  
ªt
;

2703 
	}
}

2706 
	$pxt4_mb_˛ónup_∑
(
pxt4_group_öfo
 *
gΩ
)

2708 
pxt4_¥óŒoc_•a˚
 *
∑
;

2709 
li°_hód
 *
cur
, *
tmp
;

2710 
cou¡
 = 0;

2712 
	`li°_f‹_óch_ß„
(
cur
, 
tmp
, &
gΩ
->
bb_¥óŒoc_li°
) {

2713 
∑
 = 
	`li°_íåy
(
cur
, 
pxt4_¥óŒoc_•a˚
, 
∑_group_li°
);

2714 
	`li°_dñ
(&
∑
->
∑_group_li°
);

2715 
cou¡
++;

2716 
	`kmem_ˇche_‰ì
(
pxt4_p•a˚_ˇchï
, 
∑
);

2718 i‡(
cou¡
)

2719 
	`mb_debug
(1, "mbÆloc: %u PA†À·\n", 
cou¡
);

2721 
	}
}

2723 
	$pxt4_mb_ªÀa£
(
su≥r_block
 *
sb
)

2725 
pxt4_group_t
 
ngroups
 = 
	`pxt4_gë_groups_cou¡
(
sb
);

2726 
pxt4_group_t
 
i
;

2727 
num_mëa_group_öfos
;

2728 
pxt4_group_öfo
 *
gröfo
, ***
group_öfo
;

2729 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
sb
);

2730 
kmem_ˇche
 *
ˇchï
 = 
	`gë_groupöfo_ˇche
(
sb
->
s_blocksize_bôs
);

2732 i‡(
sbi
->
s_group_öfo
) {

2733 
i
 = 0; i < 
ngroups
; i++) {

2734 
	`c⁄d_ªsched
();

2735 
gröfo
 = 
	`pxt4_gë_group_öfo
(
sb
, 
i
);

2736 #ifde‡
DOUBLE_CHECK


2737 
	`k‰ì
(
gröfo
->
bb_bôm≠
);

2739 
	`pxt4_lock_group
(
sb
, 
i
);

2740 
	`pxt4_mb_˛ónup_∑
(
gröfo
);

2741 
	`pxt4_u∆ock_group
(
sb
, 
i
);

2742 
	`kmem_ˇche_‰ì
(
ˇchï
, 
gröfo
);

2744 
num_mëa_group_öfos
 = (
ngroups
 +

2745 
	`PXT4_DESC_PER_BLOCK
(
sb
) - 1) >>

2746 
	`PXT4_DESC_PER_BLOCK_BITS
(
sb
);

2747 
	`rcu_ªad_lock
();

2748 
group_öfo
 = 
	`rcu_dîe„ªn˚
(
sbi
->
s_group_öfo
);

2749 
i
 = 0; i < 
num_mëa_group_öfos
; i++)

2750 
	`k‰ì
(
group_öfo
[
i
]);

2751 
	`kv‰ì
(
group_öfo
);

2752 
	`rcu_ªad_u∆ock
();

2754 
	`k‰ì
(
sbi
->
s_mb_off£ts
);

2755 
	`k‰ì
(
sbi
->
s_mb_maxs
);

2756 
	`ùut
(
sbi
->
s_buddy_ˇche
);

2757 i‡(
sbi
->
s_mb_°©s
) {

2758 
	`pxt4_msg
(
sb
, 
KERN_INFO
,

2760 
	`©omic_ªad
(&
sbi
->
s_bÆ_Æloˇãd
),

2761 
	`©omic_ªad
(&
sbi
->
s_bÆ_ªqs
),

2762 
	`©omic_ªad
(&
sbi
->
s_bÆ_suc˚ss
));

2763 
	`pxt4_msg
(
sb
, 
KERN_INFO
,

2766 
	`©omic_ªad
(&
sbi
->
s_bÆ_ex_sˇ¬ed
),

2767 
	`©omic_ªad
(&
sbi
->
s_bÆ_gﬂls
),

2768 
	`©omic_ªad
(&
sbi
->
s_bÆ_2‹dîs
),

2769 
	`©omic_ªad
(&
sbi
->
s_bÆ_bªaks
),

2770 
	`©omic_ªad
(&
sbi
->
s_mb_lo°_chunks
));

2771 
	`pxt4_msg
(
sb
, 
KERN_INFO
,

2773 
sbi
->
s_mb_buddõs_gíî©ed
,

2774 
sbi
->
s_mb_gíî©i⁄_time
);

2775 
	`pxt4_msg
(
sb
, 
KERN_INFO
,

2777 
	`©omic_ªad
(&
sbi
->
s_mb_¥óŒoˇãd
),

2778 
	`©omic_ªad
(&
sbi
->
s_mb_disˇrded
));

2781 
	`‰ì_≥r˝u
(
sbi
->
s_loˇlôy_groups
);

2784 
	}
}

2786 
ölöe
 
	$pxt4_issue_disˇrd
(
su≥r_block
 *
sb
,

2787 
pxt4_group_t
 
block_group
, 
pxt4_gΩblk_t
 
˛u°î
, 
cou¡
,

2788 
bio
 **
bi›
)

2790 
pxt4_fsblk_t
 
disˇrd_block
;

2792 
disˇrd_block
 = (
	`PXT4_C2B
(
	`PXT4_SB
(
sb
), 
˛u°î
) +

2793 
	`pxt4_group_fú°_block_no
(
sb
, 
block_group
));

2794 
cou¡
 = 
	`PXT4_C2B
(
	`PXT4_SB
(
sb
), count);

2795 
	`åa˚_pxt4_disˇrd_blocks
(
sb
,

2796 (Ë
disˇrd_block
, 
cou¡
);

2797 i‡(
bi›
) {

2798  
	`__blkdev_issue_disˇrd
(
sb
->
s_bdev
,

2799 (
£˘‹_t
)
disˇrd_block
 << (
sb
->
s_blocksize_bôs
 - 9),

2800 (
£˘‹_t
)
cou¡
 << (
sb
->
s_blocksize_bôs
 - 9),

2801 
GFP_NOFS
, 0, 
bi›
);

2803  
	`sb_issue_disˇrd
(
sb
, 
disˇrd_block
, 
cou¡
, 
GFP_NOFS
, 0);

2804 
	}
}

2806 
	$pxt4_‰ì_d©a_ö_buddy
(
su≥r_block
 *
sb
,

2807 
pxt4_‰ì_d©a
 *
íåy
)

2809 
pxt4_buddy
 
e4b
;

2810 
pxt4_group_öfo
 *
db
;

2811 
îr
, 
cou¡
 = 0, 
cou¡2
 = 0;

2813 
	`mb_debug
(1, "gonna free %u blocks in group %u (0x%p):",

2814 
íåy
->
efd_cou¡
,É¡ry->
efd_group
,Éntry);

2816 
îr
 = 
	`pxt4_mb_lﬂd_buddy
(
sb
, 
íåy
->
efd_group
, &
e4b
);

2818 
	`BUG_ON
(
îr
 != 0);

2820 
	`•ö_lock
(&
	`PXT4_SB
(
sb
)->
s_md_lock
);

2821 
	`PXT4_SB
(
sb
)->
s_mb_‰ì_≥ndög
 -
íåy
->
efd_cou¡
;

2822 
	`•ö_u∆ock
(&
	`PXT4_SB
(
sb
)->
s_md_lock
);

2824 
db
 = 
e4b
.
bd_öfo
;

2826 
cou¡
 +
íåy
->
efd_cou¡
;

2827 
cou¡2
++;

2828 
	`pxt4_lock_group
(
sb
, 
íåy
->
efd_group
);

2830 
	`rb_îa£
(&
íåy
->
efd_node
, &(
db
->
bb_‰ì_roŸ
));

2831 
	`mb_‰ì_blocks
(
NULL
, &
e4b
, 
íåy
->
efd_°¨t_˛u°î
,É¡ry->
efd_cou¡
);

2839 i‡(!
	`ã°_›t
(
sb
, 
DISCARD
))

2840 
	`PXT4_MB_GRP_CLEAR_TRIMMED
(
db
);

2842 i‡(!
db
->
bb_‰ì_roŸ
.
rb_node
) {

2846 
	`put_∑ge
(
e4b
.
bd_buddy_∑ge
);

2847 
	`put_∑ge
(
e4b
.
bd_bôm≠_∑ge
);

2849 
	`pxt4_u∆ock_group
(
sb
, 
íåy
->
efd_group
);

2850 
	`kmem_ˇche_‰ì
(
pxt4_‰ì_d©a_ˇchï
, 
íåy
);

2851 
	`pxt4_mb_u∆ﬂd_buddy
(&
e4b
);

2853 
	`mb_debug
(1, "‰ìd %u block†ö %u såu˘uªs\n", 
cou¡
, 
cou¡2
);

2854 
	}
}

2860 
	$pxt4_¥o˚ss_‰ìd_d©a
(
su≥r_block
 *
sb
, 
tid_t
 
commô_tid
)

2862 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
sb
);

2863 
pxt4_‰ì_d©a
 *
íåy
, *
tmp
;

2864 
bio
 *
disˇrd_bio
 = 
NULL
;

2865 
li°_hód
 
‰ìd_d©a_li°
;

2866 
li°_hód
 *
cut_pos
 = 
NULL
;

2867 
îr
;

2869 
	`INIT_LIST_HEAD
(&
‰ìd_d©a_li°
);

2871 
	`•ö_lock
(&
sbi
->
s_md_lock
);

2872 
	`li°_f‹_óch_íåy
(
íåy
, &
sbi
->
s_‰ìd_d©a_li°
, 
efd_li°
) {

2873 i‡(
íåy
->
efd_tid
 !
commô_tid
)

2875 
cut_pos
 = &
íåy
->
efd_li°
;

2877 i‡(
cut_pos
)

2878 
	`li°_cut_posôi⁄
(&
‰ìd_d©a_li°
, &
sbi
->
s_‰ìd_d©a_li°
,

2879 
cut_pos
);

2880 
	`•ö_u∆ock
(&
sbi
->
s_md_lock
);

2882 i‡(
	`ã°_›t
(
sb
, 
DISCARD
)) {

2883 
	`li°_f‹_óch_íåy
(
íåy
, &
‰ìd_d©a_li°
, 
efd_li°
) {

2884 
îr
 = 
	`pxt4_issue_disˇrd
(
sb
, 
íåy
->
efd_group
,

2885 
íåy
->
efd_°¨t_˛u°î
,

2886 
íåy
->
efd_cou¡
,

2887 &
disˇrd_bio
);

2888 i‡(
îr
 &&Éº !-
EOPNOTSUPP
) {

2889 
	`pxt4_msg
(
sb
, 
KERN_WARNING
, "discardÑequest in"

2891 " wôh %d", 
íåy
->
efd_group
,

2892 
íåy
->
efd_°¨t_˛u°î
,

2893 
íåy
->
efd_cou¡
, 
îr
);

2894 } i‡(
îr
 =-
EOPNOTSUPP
)

2898 i‡(
disˇrd_bio
) {

2899 
	`submô_bio_waô
(
disˇrd_bio
);

2900 
	`bio_put
(
disˇrd_bio
);

2904 
	`li°_f‹_óch_íåy_ß„
(
íåy
, 
tmp
, &
‰ìd_d©a_li°
, 
efd_li°
)

2905 
	`pxt4_‰ì_d©a_ö_buddy
(
sb
, 
íåy
);

2906 
	}
}

2908 
__öô
 
	$pxt4_öô_mbÆloc
()

2910 
pxt4_p•a˚_ˇchï
 = 
	`KMEM_CACHE
(
pxt4_¥óŒoc_•a˚
,

2911 
SLAB_RECLAIM_ACCOUNT
);

2912 i‡(
pxt4_p•a˚_ˇchï
 =
NULL
)

2913  -
ENOMEM
;

2915 
pxt4_ac_ˇchï
 = 
	`KMEM_CACHE
(
pxt4_Æloˇti⁄_c⁄ãxt
,

2916 
SLAB_RECLAIM_ACCOUNT
);

2917 i‡(
pxt4_ac_ˇchï
 =
NULL
) {

2918 
	`kmem_ˇche_de°roy
(
pxt4_p•a˚_ˇchï
);

2919  -
ENOMEM
;

2922 
pxt4_‰ì_d©a_ˇchï
 = 
	`KMEM_CACHE
(
pxt4_‰ì_d©a
,

2923 
SLAB_RECLAIM_ACCOUNT
);

2924 i‡(
pxt4_‰ì_d©a_ˇchï
 =
NULL
) {

2925 
	`kmem_ˇche_de°roy
(
pxt4_p•a˚_ˇchï
);

2926 
	`kmem_ˇche_de°roy
(
pxt4_ac_ˇchï
);

2927  -
ENOMEM
;

2930 
	}
}

2932 
	$pxt4_exô_mbÆloc
()

2938 
	`rcu_b¨rõr
();

2939 
	`kmem_ˇche_de°roy
(
pxt4_p•a˚_ˇchï
);

2940 
	`kmem_ˇche_de°roy
(
pxt4_ac_ˇchï
);

2941 
	`kmem_ˇche_de°roy
(
pxt4_‰ì_d©a_ˇchï
);

2942 
	`pxt4_groupöfo_de°roy_¶abs
();

2943 
	}
}

2950 
noölöe_f‹_°ack
 

2951 
	$pxt4_mb_m¨k_disk•a˚_u£d
(
pxt4_Æloˇti⁄_c⁄ãxt
 *
ac
,

2952 
h™dÀ_t
 *
h™dÀ
, 
ª£rv_˛°rs
)

2954 
buf„r_hód
 *
bôm≠_bh
 = 
NULL
;

2955 
pxt4_group_desc
 *
gdp
;

2956 
buf„r_hód
 *
gdp_bh
;

2957 
pxt4_sb_öfo
 *
sbi
;

2958 
su≥r_block
 *
sb
;

2959 
pxt4_fsblk_t
 
block
;

2960 
îr
, 
Àn
;

2962 
	`BUG_ON
(
ac
->
ac_°©us
 !
AC_STATUS_FOUND
);

2963 
	`BUG_ON
(
ac
->
ac_b_ex
.
„_Àn
 <= 0);

2965 
sb
 = 
ac
->
ac_sb
;

2966 
sbi
 = 
	`PXT4_SB
(
sb
);

2968 
bôm≠_bh
 = 
	`pxt4_ªad_block_bôm≠
(
sb
, 
ac
->
ac_b_ex
.
„_group
);

2969 i‡(
	`IS_ERR
(
bôm≠_bh
)) {

2970 
îr
 = 
	`PTR_ERR
(
bôm≠_bh
);

2971 
bôm≠_bh
 = 
NULL
;

2972 
out_îr
;

2975 
	`BUFFER_TRACE
(
bôm≠_bh
, "getting writeáccess");

2976 
îr
 = 
	`pxt4_jou∫Æ_gë_wrôe_ac˚ss
(
h™dÀ
, 
bôm≠_bh
);

2977 i‡(
îr
)

2978 
out_îr
;

2980 
îr
 = -
EIO
;

2981 
gdp
 = 
	`pxt4_gë_group_desc
(
sb
, 
ac
->
ac_b_ex
.
„_group
, &
gdp_bh
);

2982 i‡(!
gdp
)

2983 
out_îr
;

2985 
	`pxt4_debug
("usög block grou∞%u(%d)\n", 
ac
->
ac_b_ex
.
„_group
,

2986 
	`pxt4_‰ì_group_˛u°îs
(
sb
, 
gdp
));

2988 
	`BUFFER_TRACE
(
gdp_bh
, "get_write_access");

2989 
îr
 = 
	`pxt4_jou∫Æ_gë_wrôe_ac˚ss
(
h™dÀ
, 
gdp_bh
);

2990 i‡(
îr
)

2991 
out_îr
;

2993 
block
 = 
	`pxt4_gΩ_offs_to_block
(
sb
, &
ac
->
ac_b_ex
);

2995 
Àn
 = 
	`PXT4_C2B
(
sbi
, 
ac
->
ac_b_ex
.
„_Àn
);

2996 i‡(!
	`pxt4_d©a_block_vÆid
(
sbi
, 
block
, 
Àn
)) {

2997 
	`pxt4_îr‹
(
sb
, "Allocating blocks %llu-%llu which overlap "

2998 "f†mëad©a", 
block
, block+
Àn
);

3003 
	`pxt4_lock_group
(
sb
, 
ac
->
ac_b_ex
.
„_group
);

3004 
	`pxt4_£t_bôs
(
bôm≠_bh
->
b_d©a
, 
ac
->
ac_b_ex
.
„_°¨t
,

3005 
ac
->
ac_b_ex
.
„_Àn
);

3006 
	`pxt4_u∆ock_group
(
sb
, 
ac
->
ac_b_ex
.
„_group
);

3007 
îr
 = 
	`pxt4_h™dÀ_dúty_mëad©a
(
h™dÀ
, 
NULL
, 
bôm≠_bh
);

3008 i‡(!
îr
)

3009 
îr
 = -
EFSCORRUPTED
;

3010 
out_îr
;

3013 
	`pxt4_lock_group
(
sb
, 
ac
->
ac_b_ex
.
„_group
);

3014 #ifde‡
AGGRESSIVE_CHECK


3016 
i
;

3017 
i
 = 0; i < 
ac
->
ac_b_ex
.
„_Àn
; i++) {

3018 
	`BUG_ON
(
	`mb_ã°_bô
(
ac
->
ac_b_ex
.
„_°¨t
 + 
i
,

3019 
bôm≠_bh
->
b_d©a
));

3023 
	`pxt4_£t_bôs
(
bôm≠_bh
->
b_d©a
, 
ac
->
ac_b_ex
.
„_°¨t
,

3024 
ac
->
ac_b_ex
.
„_Àn
);

3025 i‡(
	`pxt4_has_group_desc_csum
(
sb
) &&

3026 (
gdp
->
bg_Êags
 & 
	`˝u_to_À16
(
PXT4_BG_BLOCK_UNINIT
))) {

3027 
gdp
->
bg_Êags
 &
	`˝u_to_À16
(~
PXT4_BG_BLOCK_UNINIT
);

3028 
	`pxt4_‰ì_group_˛u°îs_£t
(
sb
, 
gdp
,

3029 
	`pxt4_‰ì_˛u°îs_a·î_öô
(
sb
,

3030 
ac
->
ac_b_ex
.
„_group
, 
gdp
));

3032 
Àn
 = 
	`pxt4_‰ì_group_˛u°îs
(
sb
, 
gdp
Ë- 
ac
->
ac_b_ex
.
„_Àn
;

3033 
	`pxt4_‰ì_group_˛u°îs_£t
(
sb
, 
gdp
, 
Àn
);

3034 
	`pxt4_block_bôm≠_csum_£t
(
sb
, 
ac
->
ac_b_ex
.
„_group
, 
gdp
, 
bôm≠_bh
);

3035 
	`pxt4_group_desc_csum_£t
(
sb
, 
ac
->
ac_b_ex
.
„_group
, 
gdp
);

3037 
	`pxt4_u∆ock_group
(
sb
, 
ac
->
ac_b_ex
.
„_group
);

3038 
	`≥r˝u_cou¡î_sub
(&
sbi
->
s_‰ì˛u°îs_cou¡î
, 
ac
->
ac_b_ex
.
„_Àn
);

3042 i‡(!(
ac
->
ac_Êags
 & 
PXT4_MB_DELALLOC_RESERVED
))

3044 
	`≥r˝u_cou¡î_sub
(&
sbi
->
s_dúty˛u°îs_cou¡î
,

3045 
ª£rv_˛°rs
);

3047 i‡(
sbi
->
s_log_groups_≥r_Êex
) {

3048 
pxt4_group_t
 
Êex_group
 = 
	`pxt4_Êex_group
(
sbi
,

3049 
ac
->
ac_b_ex
.
„_group
);

3050 
	`©omic64_sub
(
ac
->
ac_b_ex
.
„_Àn
,

3051 &
	`sbi_¨øy_rcu_dîef
(
sbi
, 
s_Êex_groups
,

3052 
Êex_group
)->
‰ì_˛u°îs
);

3055 
îr
 = 
	`pxt4_h™dÀ_dúty_mëad©a
(
h™dÀ
, 
NULL
, 
bôm≠_bh
);

3056 i‡(
îr
)

3057 
out_îr
;

3058 
îr
 = 
	`pxt4_h™dÀ_dúty_mëad©a
(
h™dÀ
, 
NULL
, 
gdp_bh
);

3060 
out_îr
:

3061 
	`bªl£
(
bôm≠_bh
);

3062  
îr
;

3063 
	}
}

3074 
	$pxt4_mb_n‹mÆize_group_ªque°
(
pxt4_Æloˇti⁄_c⁄ãxt
 *
ac
)

3076 
su≥r_block
 *
sb
 = 
ac
->
ac_sb
;

3077 
pxt4_loˇlôy_group
 *
lg
 = 
ac
->
ac_lg
;

3079 
	`BUG_ON
(
lg
 =
NULL
);

3080 
ac
->
ac_g_ex
.
„_Àn
 = 
	`PXT4_SB
(
sb
)->
s_mb_group_¥óŒoc
;

3081 
	`mb_debug
(1, "#%u: goal %u blocks forÜocality group\n",

3082 
cuºít
->
pid
, 
ac
->
ac_g_ex
.
„_Àn
);

3083 
	}
}

3089 
noölöe_f‹_°ack
 

3090 
	$pxt4_mb_n‹mÆize_ªque°
(
pxt4_Æloˇti⁄_c⁄ãxt
 *
ac
,

3091 
pxt4_Æloˇti⁄_ªque°
 *
¨
)

3093 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
ac
->
ac_sb
);

3094 
bsbôs
, 
max
;

3095 
pxt4_lblk_t
 
íd
;

3096 
loff_t
 
size
, 
°¨t_off
;

3097 
loff_t
 
‹ig_size
 
__maybe_unu£d
;

3098 
pxt4_lblk_t
 
°¨t
;

3099 
pxt4_öode_öfo
 *
ei
 = 
	`PXT4_I
(
ac
->
ac_öode
);

3100 
pxt4_¥óŒoc_•a˚
 *
∑
;

3104 i‡(!(
ac
->
ac_Êags
 & 
PXT4_MB_HINT_DATA
))

3108 i‡(
	`u∆ikñy
(
ac
->
ac_Êags
 & 
PXT4_MB_HINT_GOAL_ONLY
))

3113 i‡(
ac
->
ac_Êags
 & 
PXT4_MB_HINT_NOPREALLOC
)

3116 i‡(
ac
->
ac_Êags
 & 
PXT4_MB_HINT_GROUP_ALLOC
) {

3117 
	`pxt4_mb_n‹mÆize_group_ªque°
(
ac
);

3121 
bsbôs
 = 
ac
->
ac_sb
->
s_blocksize_bôs
;

3125 
size
 = 
ac
->
ac_o_ex
.
„_logiˇl
 + 
	`PXT4_C2B
(
sbi
,ác->ac_o_ex.
„_Àn
);

3126 
size
 = sizê<< 
bsbôs
;

3127 i‡(
size
 < 
	`i_size_ªad
(
ac
->
ac_öode
))

3128 
size
 = 
	`i_size_ªad
(
ac
->
ac_öode
);

3129 
‹ig_size
 = 
size
;

3132 
max
 = 2 << 
bsbôs
;

3134 
	#NRL_CHECK_SIZE
(
ªq
, 
size
, 
max
, 
chunk_size
) \

3135 (
ªq
 <(
size
Ë|| 
max
 <(
chunk_size
))

	)

3139 
°¨t_off
 = 0;

3140 i‡(
size
 <= 16 * 1024) {

3141 
size
 = 16 * 1024;

3142 } i‡(
size
 <= 32 * 1024) {

3143 
size
 = 32 * 1024;

3144 } i‡(
size
 <= 64 * 1024) {

3145 
size
 = 64 * 1024;

3146 } i‡(
size
 <= 128 * 1024) {

3147 
size
 = 128 * 1024;

3148 } i‡(
size
 <= 256 * 1024) {

3149 
size
 = 256 * 1024;

3150 } i‡(
size
 <= 512 * 1024) {

3151 
size
 = 512 * 1024;

3152 } i‡(
size
 <= 1024 * 1024) {

3153 
size
 = 1024 * 1024;

3154 } i‡(
	`NRL_CHECK_SIZE
(
size
, 4 * 1024 * 1024, 
max
, 2 * 1024)) {

3155 
°¨t_off
 = ((
loff_t
)
ac
->
ac_o_ex
.
„_logiˇl
 >>

3156 (21 - 
bsbôs
)) << 21;

3157 
size
 = 2 * 1024 * 1024;

3158 } i‡(
	`NRL_CHECK_SIZE
(
size
, 8 * 1024 * 1024, 
max
, 4 * 1024)) {

3159 
°¨t_off
 = ((
loff_t
)
ac
->
ac_o_ex
.
„_logiˇl
 >>

3160 (22 - 
bsbôs
)) << 22;

3161 
size
 = 4 * 1024 * 1024;

3162 } i‡(
	`NRL_CHECK_SIZE
(
ac
->
ac_o_ex
.
„_Àn
,

3163 (8<<20)>>
bsbôs
, 
max
, 8 * 1024)) {

3164 
°¨t_off
 = ((
loff_t
)
ac
->
ac_o_ex
.
„_logiˇl
 >>

3165 (23 - 
bsbôs
)) << 23;

3166 
size
 = 8 * 1024 * 1024;

3168 
°¨t_off
 = (
loff_t
Ë
ac
->
ac_o_ex
.
„_logiˇl
 << 
bsbôs
;

3169 
size
 = (
loff_t
Ë
	`PXT4_C2B
(
	`PXT4_SB
(
ac
->
ac_sb
),

3170 
ac
->
ac_o_ex
.
„_Àn
Ë<< 
bsbôs
;

3172 
size
 = sizê>> 
bsbôs
;

3173 
°¨t
 = 
°¨t_off
 >> 
bsbôs
;

3176 i‡(
¨
->
∂e·
 && 
°¨t
 <¨->
Œe·
) {

3177 
size
 -
¨
->
Œe·
 + 1 - 
°¨t
;

3178 
°¨t
 = 
¨
->
Œe·
 + 1;

3180 i‡(
¨
->
¥ight
 && 
°¨t
 + 
size
 - 1 >¨->
Ãight
)

3181 
size
 -
°¨t
 + sizê- 
¨
->
Ãight
;

3187 i‡(
size
 > 
	`PXT4_BLOCKS_PER_GROUP
(
ac
->
ac_sb
))

3188 
size
 = 
	`PXT4_BLOCKS_PER_GROUP
(
ac
->
ac_sb
);

3190 
íd
 = 
°¨t
 + 
size
;

3193 
	`rcu_ªad_lock
();

3194 
	`li°_f‹_óch_íåy_rcu
(
∑
, &
ei
->
i_¥óŒoc_li°
, 
∑_öode_li°
) {

3195 
pxt4_lblk_t
 
∑_íd
;

3197 i‡(
∑
->
∑_dñëed
)

3199 
	`•ö_lock
(&
∑
->
∑_lock
);

3200 i‡(
∑
->
∑_dñëed
) {

3201 
	`•ö_u∆ock
(&
∑
->
∑_lock
);

3205 
∑_íd
 = 
∑
->
∑_l°¨t
 + 
	`PXT4_C2B
(
	`PXT4_SB
(
ac
->
ac_sb
),

3206 
∑
->
∑_Àn
);

3209 
	`BUG_ON
(!(
ac
->
ac_o_ex
.
„_logiˇl
 >
∑_íd
 ||

3210 
ac
->
ac_o_ex
.
„_logiˇl
 < 
∑
->
∑_l°¨t
));

3213 i‡(
∑
->
∑_l°¨t
 >
íd
 || 
∑_íd
 <
°¨t
) {

3214 
	`•ö_u∆ock
(&
∑
->
∑_lock
);

3217 
	`BUG_ON
(
∑
->
∑_l°¨t
 <
°¨t
 && 
∑_íd
 >
íd
);

3220 i‡(
∑_íd
 <
ac
->
ac_o_ex
.
„_logiˇl
) {

3221 
	`BUG_ON
(
∑_íd
 < 
°¨t
);

3222 
°¨t
 = 
∑_íd
;

3223 } i‡(
∑
->
∑_l°¨t
 > 
ac
->
ac_o_ex
.
„_logiˇl
) {

3224 
	`BUG_ON
(
∑
->
∑_l°¨t
 > 
íd
);

3225 
íd
 = 
∑
->
∑_l°¨t
;

3227 
	`•ö_u∆ock
(&
∑
->
∑_lock
);

3229 
	`rcu_ªad_u∆ock
();

3230 
size
 = 
íd
 - 
°¨t
;

3233 
	`rcu_ªad_lock
();

3234 
	`li°_f‹_óch_íåy_rcu
(
∑
, &
ei
->
i_¥óŒoc_li°
, 
∑_öode_li°
) {

3235 
pxt4_lblk_t
 
∑_íd
;

3237 
	`•ö_lock
(&
∑
->
∑_lock
);

3238 i‡(
∑
->
∑_dñëed
 == 0) {

3239 
∑_íd
 = 
∑
->
∑_l°¨t
 + 
	`PXT4_C2B
(
	`PXT4_SB
(
ac
->
ac_sb
),

3240 
∑
->
∑_Àn
);

3241 
	`BUG_ON
(!(
°¨t
 >
∑_íd
 || 
íd
 <
∑
->
∑_l°¨t
));

3243 
	`•ö_u∆ock
(&
∑
->
∑_lock
);

3245 
	`rcu_ªad_u∆ock
();

3247 i‡(
°¨t
 + 
size
 <
ac
->
ac_o_ex
.
„_logiˇl
 &&

3248 
°¨t
 > 
ac
->
ac_o_ex
.
„_logiˇl
) {

3249 
	`pxt4_msg
(
ac
->
ac_sb
, 
KERN_ERR
,

3251 (Ë
°¨t
, (Ë
size
,

3252 (Ë
ac
->
ac_o_ex
.
„_logiˇl
);

3253 
	`BUG
();

3255 
	`BUG_ON
(
size
 <0 || sizê> 
	`PXT4_BLOCKS_PER_GROUP
(
ac
->
ac_sb
));

3261 
ac
->
ac_g_ex
.
„_logiˇl
 = 
°¨t
;

3262 
ac
->
ac_g_ex
.
„_Àn
 = 
	`PXT4_NUM_B2C
(
sbi
, 
size
);

3265 i‡(
¨
->
¥ight
 && (¨->
Ãight
 =(
°¨t
 + 
size
))) {

3267 
	`pxt4_gë_group_no_™d_off£t
(
ac
->
ac_sb
, 
¨
->
¥ight
 - 
size
,

3268 &
ac
->
ac_f_ex
.
„_group
,

3269 &
ac
->
ac_f_ex
.
„_°¨t
);

3270 
ac
->
ac_Êags
 |
PXT4_MB_HINT_TRY_GOAL
;

3272 i‡(
¨
->
∂e·
 && (¨->
Œe·
 + 1 =
°¨t
)) {

3274 
	`pxt4_gë_group_no_™d_off£t
(
ac
->
ac_sb
, 
¨
->
∂e·
 + 1,

3275 &
ac
->
ac_f_ex
.
„_group
,

3276 &
ac
->
ac_f_ex
.
„_°¨t
);

3277 
ac
->
ac_Êags
 |
PXT4_MB_HINT_TRY_GOAL
;

3280 
	`mb_debug
(1, "gﬂl: %u(wa†%uËblock†© %u\n", (Ë
size
,

3281 (Ë
‹ig_size
, (Ë
°¨t
);

3282 
	}
}

3284 
	$pxt4_mb_cﬁÀ˘_°©s
(
pxt4_Æloˇti⁄_c⁄ãxt
 *
ac
)

3286 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
ac
->
ac_sb
);

3288 i‡(
sbi
->
s_mb_°©s
 && 
ac
->
ac_g_ex
.
„_Àn
 > 1) {

3289 
	`©omic_öc
(&
sbi
->
s_bÆ_ªqs
);

3290 
	`©omic_add
(
ac
->
ac_b_ex
.
„_Àn
, &
sbi
->
s_bÆ_Æloˇãd
);

3291 i‡(
ac
->
ac_b_ex
.
„_Àn
 >ac->
ac_o_ex
.fe_len)

3292 
	`©omic_öc
(&
sbi
->
s_bÆ_suc˚ss
);

3293 
	`©omic_add
(
ac
->
ac_found
, &
sbi
->
s_bÆ_ex_sˇ¬ed
);

3294 i‡(
ac
->
ac_g_ex
.
„_°¨t
 =ac->
ac_b_ex
.fe_start &&

3295 
ac
->
ac_g_ex
.
„_group
 =ac->
ac_b_ex
.fe_group)

3296 
	`©omic_öc
(&
sbi
->
s_bÆ_gﬂls
);

3297 i‡(
ac
->
ac_found
 > 
sbi
->
s_mb_max_to_sˇn
)

3298 
	`©omic_öc
(&
sbi
->
s_bÆ_bªaks
);

3301 i‡(
ac
->
ac_›
 =
PXT4_MB_HISTORY_ALLOC
)

3302 
	`åa˚_pxt4_mbÆloc_Æloc
(
ac
);

3304 
	`åa˚_pxt4_mbÆloc_¥óŒoc
(
ac
);

3305 
	}
}

3313 
	$pxt4_disˇrd_Æloˇãd_blocks
(
pxt4_Æloˇti⁄_c⁄ãxt
 *
ac
)

3315 
pxt4_¥óŒoc_•a˚
 *
∑
 = 
ac
->
ac_∑
;

3316 
pxt4_buddy
 
e4b
;

3317 
îr
;

3319 i‡(
∑
 =
NULL
) {

3320 i‡(
ac
->
ac_f_ex
.
„_Àn
 == 0)

3322 
îr
 = 
	`pxt4_mb_lﬂd_buddy
(
ac
->
ac_sb
,ác->
ac_f_ex
.
„_group
, &
e4b
);

3323 i‡(
îr
) {

3329 
	`WARN
(1, "mb_lﬂd_buddy faûed (%d)", 
îr
);

3332 
	`pxt4_lock_group
(
ac
->
ac_sb
,ác->
ac_f_ex
.
„_group
);

3333 
	`mb_‰ì_blocks
(
ac
->
ac_öode
, &
e4b
,ác->
ac_f_ex
.
„_°¨t
,

3334 
ac
->
ac_f_ex
.
„_Àn
);

3335 
	`pxt4_u∆ock_group
(
ac
->
ac_sb
,ác->
ac_f_ex
.
„_group
);

3336 
	`pxt4_mb_u∆ﬂd_buddy
(&
e4b
);

3339 i‡(
∑
->
∑_ty≥
 =
MB_INODE_PA
)

3340 
∑
->
∑_‰ì
 +
ac
->
ac_b_ex
.
„_Àn
;

3341 
	}
}

3346 
	$pxt4_mb_u£_öode_∑
(
pxt4_Æloˇti⁄_c⁄ãxt
 *
ac
,

3347 
pxt4_¥óŒoc_•a˚
 *
∑
)

3349 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
ac
->
ac_sb
);

3350 
pxt4_fsblk_t
 
°¨t
;

3351 
pxt4_fsblk_t
 
íd
;

3352 
Àn
;

3355 
°¨t
 = 
∑
->
∑_p°¨t
 + (
ac
->
ac_o_ex
.
„_logiˇl
 -Öa->
∑_l°¨t
);

3356 
íd
 = 
	`mö
(
∑
->
∑_p°¨t
 + 
	`PXT4_C2B
(
sbi
,Öa->
∑_Àn
),

3357 
°¨t
 + 
	`PXT4_C2B
(
sbi
, 
ac
->
ac_o_ex
.
„_Àn
));

3358 
Àn
 = 
	`PXT4_NUM_B2C
(
sbi
, 
íd
 - 
°¨t
);

3359 
	`pxt4_gë_group_no_™d_off£t
(
ac
->
ac_sb
, 
°¨t
, &ac->
ac_b_ex
.
„_group
,

3360 &
ac
->
ac_b_ex
.
„_°¨t
);

3361 
ac
->
ac_b_ex
.
„_Àn
 = 
Àn
;

3362 
ac
->
ac_°©us
 = 
AC_STATUS_FOUND
;

3363 
ac
->
ac_∑
 = 
∑
;

3365 
	`BUG_ON
(
°¨t
 < 
∑
->
∑_p°¨t
);

3366 
	`BUG_ON
(
íd
 > 
∑
->
∑_p°¨t
 + 
	`PXT4_C2B
(
sbi
,Öa->
∑_Àn
));

3367 
	`BUG_ON
(
∑
->
∑_‰ì
 < 
Àn
);

3368 
∑
->
∑_‰ì
 -
Àn
;

3370 
	`mb_debug
(1, "u£ %Œu/%u from inodê∑ %p\n", 
°¨t
, 
Àn
, 
∑
);

3371 
	}
}

3376 
	$pxt4_mb_u£_group_∑
(
pxt4_Æloˇti⁄_c⁄ãxt
 *
ac
,

3377 
pxt4_¥óŒoc_•a˚
 *
∑
)

3379 
Àn
 = 
ac
->
ac_o_ex
.
„_Àn
;

3381 
	`pxt4_gë_group_no_™d_off£t
(
ac
->
ac_sb
, 
∑
->
∑_p°¨t
,

3382 &
ac
->
ac_b_ex
.
„_group
,

3383 &
ac
->
ac_b_ex
.
„_°¨t
);

3384 
ac
->
ac_b_ex
.
„_Àn
 = 
Àn
;

3385 
ac
->
ac_°©us
 = 
AC_STATUS_FOUND
;

3386 
ac
->
ac_∑
 = 
∑
;

3394 
	`mb_debug
(1, "u£ %u/%u from grou∞∑ %p\n", 
∑
->
∑_l°¨t
-
Àn
,Üen,Öa);

3395 
	}
}

3403 
pxt4_¥óŒoc_•a˚
 *

3404 
	$pxt4_mb_check_group_∑
(
pxt4_fsblk_t
 
gﬂl_block
,

3405 
pxt4_¥óŒoc_•a˚
 *
∑
,

3406 
pxt4_¥óŒoc_•a˚
 *
˝a
)

3408 
pxt4_fsblk_t
 
cur_di°™˚
, 
√w_di°™˚
;

3410 i‡(
˝a
 =
NULL
) {

3411 
	`©omic_öc
(&
∑
->
∑_cou¡
);

3412  
∑
;

3414 
cur_di°™˚
 = 
	`abs
(
gﬂl_block
 - 
˝a
->
∑_p°¨t
);

3415 
√w_di°™˚
 = 
	`abs
(
gﬂl_block
 - 
∑
->
∑_p°¨t
);

3417 i‡(
cur_di°™˚
 <
√w_di°™˚
)

3418  
˝a
;

3421 
	`©omic_dec
(&
˝a
->
∑_cou¡
);

3422 
	`©omic_öc
(&
∑
->
∑_cou¡
);

3423  
∑
;

3424 
	}
}

3429 
noölöe_f‹_°ack
 

3430 
	$pxt4_mb_u£_¥óŒoˇãd
(
pxt4_Æloˇti⁄_c⁄ãxt
 *
ac
)

3432 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
ac
->
ac_sb
);

3433 
‹dî
, 
i
;

3434 
pxt4_öode_öfo
 *
ei
 = 
	`PXT4_I
(
ac
->
ac_öode
);

3435 
pxt4_loˇlôy_group
 *
lg
;

3436 
pxt4_¥óŒoc_•a˚
 *
∑
, *
˝a
 = 
NULL
;

3437 
pxt4_fsblk_t
 
gﬂl_block
;

3440 i‡(!(
ac
->
ac_Êags
 & 
PXT4_MB_HINT_DATA
))

3444 
	`rcu_ªad_lock
();

3445 
	`li°_f‹_óch_íåy_rcu
(
∑
, &
ei
->
i_¥óŒoc_li°
, 
∑_öode_li°
) {

3449 i‡(
ac
->
ac_o_ex
.
„_logiˇl
 < 
∑
->
∑_l°¨t
 ||

3450 
ac
->
ac_o_ex
.
„_logiˇl
 >(
∑
->
∑_l°¨t
 +

3451 
	`PXT4_C2B
(
sbi
, 
∑
->
∑_Àn
)))

3455 i‡(!(
	`pxt4_ã°_öode_Êag
(
ac
->
ac_öode
, 
PXT4_INODE_EXTENTS
)) &&

3456 (
∑
->
∑_p°¨t
 + 
	`PXT4_C2B
(
sbi
,Öa->
∑_Àn
) >

3457 
PXT4_MAX_BLOCK_FILE_PHYS
))

3461 
	`•ö_lock
(&
∑
->
∑_lock
);

3462 i‡(
∑
->
∑_dñëed
 =0 &&Öa->
∑_‰ì
) {

3463 
	`©omic_öc
(&
∑
->
∑_cou¡
);

3464 
	`pxt4_mb_u£_öode_∑
(
ac
, 
∑
);

3465 
	`•ö_u∆ock
(&
∑
->
∑_lock
);

3466 
ac
->
ac_¸ôîü
 = 10;

3467 
	`rcu_ªad_u∆ock
();

3470 
	`•ö_u∆ock
(&
∑
->
∑_lock
);

3472 
	`rcu_ªad_u∆ock
();

3475 i‡(!(
ac
->
ac_Êags
 & 
PXT4_MB_HINT_GROUP_ALLOC
))

3479 
lg
 = 
ac
->
ac_lg
;

3480 i‡(
lg
 =
NULL
)

3482 
‹dî
 = 
	`Ês
(
ac
->
ac_o_ex
.
„_Àn
) - 1;

3483 i‡(
‹dî
 > 
PREALLOC_TB_SIZE
 - 1)

3485 
‹dî
 = 
PREALLOC_TB_SIZE
 - 1;

3487 
gﬂl_block
 = 
	`pxt4_gΩ_offs_to_block
(
ac
->
ac_sb
, &ac->
ac_g_ex
);

3492 
i
 = 
‹dî
; i < 
PREALLOC_TB_SIZE
; i++) {

3493 
	`rcu_ªad_lock
();

3494 
	`li°_f‹_óch_íåy_rcu
(
∑
, &
lg
->
lg_¥óŒoc_li°
[
i
],

3495 
∑_öode_li°
) {

3496 
	`•ö_lock
(&
∑
->
∑_lock
);

3497 i‡(
∑
->
∑_dñëed
 == 0 &&

3498 
∑
->
∑_‰ì
 >
ac
->
ac_o_ex
.
„_Àn
) {

3500 
˝a
 = 
	`pxt4_mb_check_group_∑
(
gﬂl_block
,

3501 
∑
, 
˝a
);

3503 
	`•ö_u∆ock
(&
∑
->
∑_lock
);

3505 
	`rcu_ªad_u∆ock
();

3507 i‡(
˝a
) {

3508 
	`pxt4_mb_u£_group_∑
(
ac
, 
˝a
);

3509 
ac
->
ac_¸ôîü
 = 20;

3513 
	}
}

3521 
	$pxt4_mb_gíî©e_‰om_‰ìli°
(
su≥r_block
 *
sb
, *
bôm≠
,

3522 
pxt4_group_t
 
group
)

3524 
rb_node
 *
n
;

3525 
pxt4_group_öfo
 *
gΩ
;

3526 
pxt4_‰ì_d©a
 *
íåy
;

3528 
gΩ
 = 
	`pxt4_gë_group_öfo
(
sb
, 
group
);

3529 
n
 = 
	`rb_fú°
(&(
gΩ
->
bb_‰ì_roŸ
));

3531 
n
) {

3532 
íåy
 = 
	`rb_íåy
(
n
, 
pxt4_‰ì_d©a
, 
efd_node
);

3533 
	`pxt4_£t_bôs
(
bôm≠
, 
íåy
->
efd_°¨t_˛u°î
,É¡ry->
efd_cou¡
);

3534 
n
 = 
	`rb_√xt
(n);

3537 
	}
}

3544 
noölöe_f‹_°ack


3545 
	$pxt4_mb_gíî©e_‰om_∑
(
su≥r_block
 *
sb
, *
bôm≠
,

3546 
pxt4_group_t
 
group
)

3548 
pxt4_group_öfo
 *
gΩ
 = 
	`pxt4_gë_group_öfo
(
sb
, 
group
);

3549 
pxt4_¥óŒoc_•a˚
 *
∑
;

3550 
li°_hód
 *
cur
;

3551 
pxt4_group_t
 
grou≤r
;

3552 
pxt4_gΩblk_t
 
°¨t
;

3553 
¥óŒoˇãd
 = 0;

3554 
Àn
;

3564 
	`li°_f‹_óch
(
cur
, &
gΩ
->
bb_¥óŒoc_li°
) {

3565 
∑
 = 
	`li°_íåy
(
cur
, 
pxt4_¥óŒoc_•a˚
, 
∑_group_li°
);

3566 
	`•ö_lock
(&
∑
->
∑_lock
);

3567 
	`pxt4_gë_group_no_™d_off£t
(
sb
, 
∑
->
∑_p°¨t
,

3568 &
grou≤r
, &
°¨t
);

3569 
Àn
 = 
∑
->
∑_Àn
;

3570 
	`•ö_u∆ock
(&
∑
->
∑_lock
);

3571 i‡(
	`u∆ikñy
(
Àn
 == 0))

3573 
	`BUG_ON
(
grou≤r
 !
group
);

3574 
	`pxt4_£t_bôs
(
bôm≠
, 
°¨t
, 
Àn
);

3575 
¥óŒoˇãd
 +
Àn
;

3577 
	`mb_debug
(1, "¥óŒoˇãd %u f‹ grou∞%u\n", 
¥óŒoˇãd
, 
group
);

3578 
	}
}

3580 
	$pxt4_mb_∑_ˇŒback
(
rcu_hód
 *
hód
)

3582 
pxt4_¥óŒoc_•a˚
 *
∑
;

3583 
∑
 = 
	`c⁄èöî_of
(
hód
, 
pxt4_¥óŒoc_•a˚
, 
u
.
∑_rcu
);

3585 
	`BUG_ON
(
	`©omic_ªad
(&
∑
->
∑_cou¡
));

3586 
	`BUG_ON
(
∑
->
∑_dñëed
 == 0);

3587 
	`kmem_ˇche_‰ì
(
pxt4_p•a˚_ˇchï
, 
∑
);

3588 
	}
}

3594 
	$pxt4_mb_put_∑
(
pxt4_Æloˇti⁄_c⁄ãxt
 *
ac
,

3595 
su≥r_block
 *
sb
, 
pxt4_¥óŒoc_•a˚
 *
∑
)

3597 
pxt4_group_t
 
gΩ
;

3598 
pxt4_fsblk_t
 
gΩ_blk
;

3601 
	`•ö_lock
(&
∑
->
∑_lock
);

3602 i‡(!
	`©omic_dec_™d_ã°
(&
∑
->
∑_cou¡
Ë||Öa->
∑_‰ì
 != 0) {

3603 
	`•ö_u∆ock
(&
∑
->
∑_lock
);

3607 i‡(
∑
->
∑_dñëed
 == 1) {

3608 
	`•ö_u∆ock
(&
∑
->
∑_lock
);

3612 
∑
->
∑_dñëed
 = 1;

3613 
	`•ö_u∆ock
(&
∑
->
∑_lock
);

3615 
gΩ_blk
 = 
∑
->
∑_p°¨t
;

3620 i‡(
∑
->
∑_ty≥
 =
MB_GROUP_PA
)

3621 
gΩ_blk
--;

3623 
gΩ
 = 
	`pxt4_gë_group_numbî
(
sb
, 
gΩ_blk
);

3639 
	`pxt4_lock_group
(
sb
, 
gΩ
);

3640 
	`li°_dñ
(&
∑
->
∑_group_li°
);

3641 
	`pxt4_u∆ock_group
(
sb
, 
gΩ
);

3643 
	`•ö_lock
(
∑
->
∑_obj_lock
);

3644 
	`li°_dñ_rcu
(&
∑
->
∑_öode_li°
);

3645 
	`•ö_u∆ock
(
∑
->
∑_obj_lock
);

3647 
	`ˇŒ_rcu
(&(
∑
)->
u
.
∑_rcu
, 
pxt4_mb_∑_ˇŒback
);

3648 
	}
}

3653 
noölöe_f‹_°ack
 

3654 
	$pxt4_mb_√w_öode_∑
(
pxt4_Æloˇti⁄_c⁄ãxt
 *
ac
)

3656 
su≥r_block
 *
sb
 = 
ac
->
ac_sb
;

3657 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
sb
);

3658 
pxt4_¥óŒoc_•a˚
 *
∑
;

3659 
pxt4_group_öfo
 *
gΩ
;

3660 
pxt4_öode_öfo
 *
ei
;

3663 
	`BUG_ON
(
ac
->
ac_o_ex
.
„_Àn
 >ac->
ac_b_ex
.fe_len);

3664 
	`BUG_ON
(
ac
->
ac_°©us
 !
AC_STATUS_FOUND
);

3665 
	`BUG_ON
(!
	`S_ISREG
(
ac
->
ac_öode
->
i_mode
));

3667 
∑
 = 
	`kmem_ˇche_Æloc
(
pxt4_p•a˚_ˇchï
, 
GFP_NOFS
);

3668 i‡(
∑
 =
NULL
)

3669  -
ENOMEM
;

3671 i‡(
ac
->
ac_b_ex
.
„_Àn
 <ác->
ac_g_ex
.fe_len) {

3672 
wöl
;

3673 
wös
;

3674 
wö
;

3675 
offs
;

3680 
	`BUG_ON
(
ac
->
ac_g_ex
.
„_logiˇl
 >ác->
ac_o_ex
.fe_logical);

3681 
	`BUG_ON
(
ac
->
ac_g_ex
.
„_Àn
 <ác->
ac_o_ex
.fe_len);

3686 
wöl
 = 
ac
->
ac_o_ex
.
„_logiˇl
 -ác->
ac_g_ex
.fe_logical;

3689 
wös
 = 
	`PXT4_C2B
(
sbi
, 
ac
->
ac_b_ex
.
„_Àn
 -ác->
ac_o_ex
.fe_len);

3692 
wö
 = 
	`mö
(
wöl
, 
wös
);

3694 
offs
 = 
ac
->
ac_o_ex
.
„_logiˇl
 %

3695 
	`PXT4_C2B
(
sbi
, 
ac
->
ac_b_ex
.
„_Àn
);

3696 i‡(
offs
 && off†< 
wö
)

3697 
wö
 = 
offs
;

3699 
ac
->
ac_b_ex
.
„_logiˇl
 =ác->
ac_o_ex
.fe_logical -

3700 
	`PXT4_NUM_B2C
(
sbi
, 
wö
);

3701 
	`BUG_ON
(
ac
->
ac_o_ex
.
„_logiˇl
 <ác->
ac_b_ex
.fe_logical);

3702 
	`BUG_ON
(
ac
->
ac_o_ex
.
„_Àn
 >ác->
ac_b_ex
.fe_len);

3707 
ac
->
ac_f_ex
 =ác->
ac_b_ex
;

3709 
∑
->
∑_l°¨t
 = 
ac
->
ac_b_ex
.
„_logiˇl
;

3710 
∑
->
∑_p°¨t
 = 
	`pxt4_gΩ_offs_to_block
(
sb
, &
ac
->
ac_b_ex
);

3711 
∑
->
∑_Àn
 = 
ac
->
ac_b_ex
.
„_Àn
;

3712 
∑
->
∑_‰ì
 =Öa->
∑_Àn
;

3713 
	`©omic_£t
(&
∑
->
∑_cou¡
, 1);

3714 
	`•ö_lock_öô
(&
∑
->
∑_lock
);

3715 
	`INIT_LIST_HEAD
(&
∑
->
∑_öode_li°
);

3716 
	`INIT_LIST_HEAD
(&
∑
->
∑_group_li°
);

3717 
∑
->
∑_dñëed
 = 0;

3718 
∑
->
∑_ty≥
 = 
MB_INODE_PA
;

3720 
	`mb_debug
(1, "√w inodê∑ %p: %Œu/%u f‹ %u\n", 
∑
,

3721 
∑
->
∑_p°¨t
,Öa->
∑_Àn
,Öa->
∑_l°¨t
);

3722 
	`åa˚_pxt4_mb_√w_öode_∑
(
ac
, 
∑
);

3724 
	`pxt4_mb_u£_öode_∑
(
ac
, 
∑
);

3725 
	`©omic_add
(
∑
->
∑_‰ì
, &
sbi
->
s_mb_¥óŒoˇãd
);

3727 
ei
 = 
	`PXT4_I
(
ac
->
ac_öode
);

3728 
gΩ
 = 
	`pxt4_gë_group_öfo
(
sb
, 
ac
->
ac_b_ex
.
„_group
);

3730 
∑
->
∑_obj_lock
 = &
ei
->
i_¥óŒoc_lock
;

3731 
∑
->
∑_öode
 = 
ac
->
ac_öode
;

3733 
	`pxt4_lock_group
(
sb
, 
ac
->
ac_b_ex
.
„_group
);

3734 
	`li°_add
(&
∑
->
∑_group_li°
, &
gΩ
->
bb_¥óŒoc_li°
);

3735 
	`pxt4_u∆ock_group
(
sb
, 
ac
->
ac_b_ex
.
„_group
);

3737 
	`•ö_lock
(
∑
->
∑_obj_lock
);

3738 
	`li°_add_rcu
(&
∑
->
∑_öode_li°
, &
ei
->
i_¥óŒoc_li°
);

3739 
	`•ö_u∆ock
(
∑
->
∑_obj_lock
);

3742 
	}
}

3747 
noölöe_f‹_°ack
 

3748 
	$pxt4_mb_√w_group_∑
(
pxt4_Æloˇti⁄_c⁄ãxt
 *
ac
)

3750 
su≥r_block
 *
sb
 = 
ac
->
ac_sb
;

3751 
pxt4_loˇlôy_group
 *
lg
;

3752 
pxt4_¥óŒoc_•a˚
 *
∑
;

3753 
pxt4_group_öfo
 *
gΩ
;

3756 
	`BUG_ON
(
ac
->
ac_o_ex
.
„_Àn
 >ac->
ac_b_ex
.fe_len);

3757 
	`BUG_ON
(
ac
->
ac_°©us
 !
AC_STATUS_FOUND
);

3758 
	`BUG_ON
(!
	`S_ISREG
(
ac
->
ac_öode
->
i_mode
));

3760 
	`BUG_ON
(
pxt4_p•a˚_ˇchï
 =
NULL
);

3761 
∑
 = 
	`kmem_ˇche_Æloc
(
pxt4_p•a˚_ˇchï
, 
GFP_NOFS
);

3762 i‡(
∑
 =
NULL
)

3763  -
ENOMEM
;

3767 
ac
->
ac_f_ex
 =ác->
ac_b_ex
;

3769 
∑
->
∑_p°¨t
 = 
	`pxt4_gΩ_offs_to_block
(
sb
, &
ac
->
ac_b_ex
);

3770 
∑
->
∑_l°¨t
 =Öa->
∑_p°¨t
;

3771 
∑
->
∑_Àn
 = 
ac
->
ac_b_ex
.
„_Àn
;

3772 
∑
->
∑_‰ì
 =Öa->
∑_Àn
;

3773 
	`©omic_£t
(&
∑
->
∑_cou¡
, 1);

3774 
	`•ö_lock_öô
(&
∑
->
∑_lock
);

3775 
	`INIT_LIST_HEAD
(&
∑
->
∑_öode_li°
);

3776 
	`INIT_LIST_HEAD
(&
∑
->
∑_group_li°
);

3777 
∑
->
∑_dñëed
 = 0;

3778 
∑
->
∑_ty≥
 = 
MB_GROUP_PA
;

3780 
	`mb_debug
(1, "√w grou∞∑ %p: %Œu/%u f‹ %u\n", 
∑
,

3781 
∑
->
∑_p°¨t
,Öa->
∑_Àn
,Öa->
∑_l°¨t
);

3782 
	`åa˚_pxt4_mb_√w_group_∑
(
ac
, 
∑
);

3784 
	`pxt4_mb_u£_group_∑
(
ac
, 
∑
);

3785 
	`©omic_add
(
∑
->
∑_‰ì
, &
	`PXT4_SB
(
sb
)->
s_mb_¥óŒoˇãd
);

3787 
gΩ
 = 
	`pxt4_gë_group_öfo
(
sb
, 
ac
->
ac_b_ex
.
„_group
);

3788 
lg
 = 
ac
->
ac_lg
;

3789 
	`BUG_ON
(
lg
 =
NULL
);

3791 
∑
->
∑_obj_lock
 = &
lg
->
lg_¥óŒoc_lock
;

3792 
∑
->
∑_öode
 = 
NULL
;

3794 
	`pxt4_lock_group
(
sb
, 
ac
->
ac_b_ex
.
„_group
);

3795 
	`li°_add
(&
∑
->
∑_group_li°
, &
gΩ
->
bb_¥óŒoc_li°
);

3796 
	`pxt4_u∆ock_group
(
sb
, 
ac
->
ac_b_ex
.
„_group
);

3803 
	}
}

3805 
	$pxt4_mb_√w_¥óŒoˇti⁄
(
pxt4_Æloˇti⁄_c⁄ãxt
 *
ac
)

3807 
îr
;

3809 i‡(
ac
->
ac_Êags
 & 
PXT4_MB_HINT_GROUP_ALLOC
)

3810 
îr
 = 
	`pxt4_mb_√w_group_∑
(
ac
);

3812 
îr
 = 
	`pxt4_mb_√w_öode_∑
(
ac
);

3813  
îr
;

3814 
	}
}

3824 
noölöe_f‹_°ack
 

3825 
	$pxt4_mb_ªÀa£_öode_∑
(
pxt4_buddy
 *
e4b
, 
buf„r_hód
 *
bôm≠_bh
,

3826 
pxt4_¥óŒoc_•a˚
 *
∑
)

3828 
su≥r_block
 *
sb
 = 
e4b
->
bd_sb
;

3829 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
sb
);

3830 
íd
;

3831 
√xt
;

3832 
pxt4_group_t
 
group
;

3833 
pxt4_gΩblk_t
 
bô
;

3834 
gΩ_blk_°¨t
;

3835 
‰ì
 = 0;

3837 
	`BUG_ON
(
∑
->
∑_dñëed
 == 0);

3838 
	`pxt4_gë_group_no_™d_off£t
(
sb
, 
∑
->
∑_p°¨t
, &
group
, &
bô
);

3839 
gΩ_blk_°¨t
 = 
∑
->
∑_p°¨t
 - 
	`PXT4_C2B
(
sbi
, 
bô
);

3840 
	`BUG_ON
(
group
 !
e4b
->
bd_group
 && 
∑
->
∑_Àn
 != 0);

3841 
íd
 = 
bô
 + 
∑
->
∑_Àn
;

3843 
bô
 < 
íd
) {

3844 
bô
 = 
	`mb_föd_√xt_zîo_bô
(
bôm≠_bh
->
b_d©a
, 
íd
, bit);

3845 i‡(
bô
 >
íd
)

3847 
√xt
 = 
	`mb_föd_√xt_bô
(
bôm≠_bh
->
b_d©a
, 
íd
, 
bô
);

3848 
	`mb_debug
(1, " freeÖreallocated %u/%u in group %u\n",

3849 (Ë
	`pxt4_group_fú°_block_no
(
sb
, 
group
Ë+ 
bô
,

3850 (Ë
√xt
 - 
bô
, (Ë
group
);

3851 
‰ì
 +
√xt
 - 
bô
;

3853 
	`åa˚_pxt4_mbÆloc_disˇrd
(
sb
, 
NULL
, 
group
, 
bô
, 
√xt
 - bit);

3854 
	`åa˚_pxt4_mb_ªÀa£_öode_∑
(
∑
, (
gΩ_blk_°¨t
 +

3855 
	`PXT4_C2B
(
sbi
, 
bô
)),

3856 
√xt
 - 
bô
);

3857 
	`mb_‰ì_blocks
(
∑
->
∑_öode
, 
e4b
, 
bô
, 
√xt
 - bit);

3858 
bô
 = 
√xt
 + 1;

3860 i‡(
‰ì
 !
∑
->
∑_‰ì
) {

3861 
	`pxt4_msg
(
e4b
->
bd_sb
, 
KERN_CRIT
,

3863 
∑
, (Ë∑->
∑_l°¨t
,

3864 (Ë
∑
->
∑_p°¨t
,

3865 (Ë
∑
->
∑_Àn
);

3866 
	`pxt4_gΩ_locked_îr‹
(
sb
, 
group
, 0, 0, "free %u,Öa_free %u",

3867 
‰ì
, 
∑
->
∑_‰ì
);

3873 
	`©omic_add
(
‰ì
, &
sbi
->
s_mb_disˇrded
);

3876 
	}
}

3878 
noölöe_f‹_°ack
 

3879 
	$pxt4_mb_ªÀa£_group_∑
(
pxt4_buddy
 *
e4b
,

3880 
pxt4_¥óŒoc_•a˚
 *
∑
)

3882 
su≥r_block
 *
sb
 = 
e4b
->
bd_sb
;

3883 
pxt4_group_t
 
group
;

3884 
pxt4_gΩblk_t
 
bô
;

3886 
	`åa˚_pxt4_mb_ªÀa£_group_∑
(
sb
, 
∑
);

3887 
	`BUG_ON
(
∑
->
∑_dñëed
 == 0);

3888 
	`pxt4_gë_group_no_™d_off£t
(
sb
, 
∑
->
∑_p°¨t
, &
group
, &
bô
);

3889 
	`BUG_ON
(
group
 !
e4b
->
bd_group
 && 
∑
->
∑_Àn
 != 0);

3890 
	`mb_‰ì_blocks
(
∑
->
∑_öode
, 
e4b
, 
bô
,Öa->
∑_Àn
);

3891 
	`©omic_add
(
∑
->
∑_Àn
, &
	`PXT4_SB
(
sb
)->
s_mb_disˇrded
);

3892 
	`åa˚_pxt4_mbÆloc_disˇrd
(
sb
, 
NULL
, 
group
, 
bô
, 
∑
->
∑_Àn
);

3895 
	}
}

3906 
noölöe_f‹_°ack
 

3907 
	$pxt4_mb_disˇrd_group_¥óŒoˇti⁄s
(
su≥r_block
 *
sb
,

3908 
pxt4_group_t
 
group
, 
√eded
)

3910 
pxt4_group_öfo
 *
gΩ
 = 
	`pxt4_gë_group_öfo
(
sb
, 
group
);

3911 
buf„r_hód
 *
bôm≠_bh
 = 
NULL
;

3912 
pxt4_¥óŒoc_•a˚
 *
∑
, *
tmp
;

3913 
li°_hód
 
li°
;

3914 
pxt4_buddy
 
e4b
;

3915 
îr
;

3916 
busy
 = 0;

3917 
‰ì
 = 0;

3919 
	`mb_debug
(1, "disˇrdÖªÆloˇti⁄ f‹ grou∞%u\n", 
group
);

3921 i‡(
	`li°_em±y
(&
gΩ
->
bb_¥óŒoc_li°
))

3924 
bôm≠_bh
 = 
	`pxt4_ªad_block_bôm≠
(
sb
, 
group
);

3925 i‡(
	`IS_ERR
(
bôm≠_bh
)) {

3926 
îr
 = 
	`PTR_ERR
(
bôm≠_bh
);

3927 
	`pxt4_îr‹
(
sb
, "Error %dÑeading block bitmap for %u",

3928 
îr
, 
group
);

3932 
îr
 = 
	`pxt4_mb_lﬂd_buddy
(
sb
, 
group
, &
e4b
);

3933 i‡(
îr
) {

3934 
	`pxt4_w¨nög
(
sb
, "Error %dÜoading buddy information for %u",

3935 
îr
, 
group
);

3936 
	`put_bh
(
bôm≠_bh
);

3940 i‡(
√eded
 == 0)

3941 
√eded
 = 
	`PXT4_CLUSTERS_PER_GROUP
(
sb
) + 1;

3943 
	`INIT_LIST_HEAD
(&
li°
);

3944 
ª≥©
:

3945 
	`pxt4_lock_group
(
sb
, 
group
);

3946 
	`li°_f‹_óch_íåy_ß„
(
∑
, 
tmp
,

3947 &
gΩ
->
bb_¥óŒoc_li°
, 
∑_group_li°
) {

3948 
	`•ö_lock
(&
∑
->
∑_lock
);

3949 i‡(
	`©omic_ªad
(&
∑
->
∑_cou¡
)) {

3950 
	`•ö_u∆ock
(&
∑
->
∑_lock
);

3951 
busy
 = 1;

3954 i‡(
∑
->
∑_dñëed
) {

3955 
	`•ö_u∆ock
(&
∑
->
∑_lock
);

3960 
∑
->
∑_dñëed
 = 1;

3963 
‰ì
 +
∑
->
∑_‰ì
;

3965 
	`•ö_u∆ock
(&
∑
->
∑_lock
);

3967 
	`li°_dñ
(&
∑
->
∑_group_li°
);

3968 
	`li°_add
(&
∑
->
u
.
∑_tmp_li°
, &
li°
);

3972 i‡(
‰ì
 < 
√eded
 && 
busy
) {

3973 
busy
 = 0;

3974 
	`pxt4_u∆ock_group
(
sb
, 
group
);

3975 
	`c⁄d_ªsched
();

3976 
ª≥©
;

3980 i‡(
	`li°_em±y
(&
li°
)) {

3981 
	`BUG_ON
(
‰ì
 != 0);

3982 
out
;

3986 
	`li°_f‹_óch_íåy_ß„
(
∑
, 
tmp
, &
li°
, 
u
.
∑_tmp_li°
) {

3989 
	`•ö_lock
(
∑
->
∑_obj_lock
);

3990 
	`li°_dñ_rcu
(&
∑
->
∑_öode_li°
);

3991 
	`•ö_u∆ock
(
∑
->
∑_obj_lock
);

3993 i‡(
∑
->
∑_ty≥
 =
MB_GROUP_PA
)

3994 
	`pxt4_mb_ªÀa£_group_∑
(&
e4b
, 
∑
);

3996 
	`pxt4_mb_ªÀa£_öode_∑
(&
e4b
, 
bôm≠_bh
, 
∑
);

3998 
	`li°_dñ
(&
∑
->
u
.
∑_tmp_li°
);

3999 
	`ˇŒ_rcu
(&(
∑
)->
u
.
∑_rcu
, 
pxt4_mb_∑_ˇŒback
);

4002 
out
:

4003 
	`pxt4_u∆ock_group
(
sb
, 
group
);

4004 
	`pxt4_mb_u∆ﬂd_buddy
(&
e4b
);

4005 
	`put_bh
(
bôm≠_bh
);

4006  
‰ì
;

4007 
	}
}

4018 
	$pxt4_disˇrd_¥óŒoˇti⁄s
(
öode
 *inode)

4020 
pxt4_öode_öfo
 *
ei
 = 
	`PXT4_I
(
öode
);

4021 
su≥r_block
 *
sb
 = 
öode
->
i_sb
;

4022 
buf„r_hód
 *
bôm≠_bh
 = 
NULL
;

4023 
pxt4_¥óŒoc_•a˚
 *
∑
, *
tmp
;

4024 
pxt4_group_t
 
group
 = 0;

4025 
li°_hód
 
li°
;

4026 
pxt4_buddy
 
e4b
;

4027 
îr
;

4029 i‡(!
	`S_ISREG
(
öode
->
i_mode
)) {

4034 
	`mb_debug
(1, "disˇrdÖªÆloˇti⁄ f‹ inodê%lu\n", 
öode
->
i_öo
);

4035 
	`åa˚_pxt4_disˇrd_¥óŒoˇti⁄s
(
öode
);

4037 
	`INIT_LIST_HEAD
(&
li°
);

4039 
ª≥©
:

4041 
	`•ö_lock
(&
ei
->
i_¥óŒoc_lock
);

4042 !
	`li°_em±y
(&
ei
->
i_¥óŒoc_li°
)) {

4043 
∑
 = 
	`li°_íåy
(
ei
->
i_¥óŒoc_li°
.
√xt
,

4044 
pxt4_¥óŒoc_•a˚
, 
∑_öode_li°
);

4045 
	`BUG_ON
(
∑
->
∑_obj_lock
 !&
ei
->
i_¥óŒoc_lock
);

4046 
	`•ö_lock
(&
∑
->
∑_lock
);

4047 i‡(
	`©omic_ªad
(&
∑
->
∑_cou¡
)) {

4050 
	`•ö_u∆ock
(&
∑
->
∑_lock
);

4051 
	`•ö_u∆ock
(&
ei
->
i_¥óŒoc_lock
);

4052 
	`pxt4_msg
(
sb
, 
KERN_ERR
,

4054 
	`WARN_ON
(1);

4055 
	`scheduÀ_timeout_unöãºu±ibÀ
(
HZ
);

4056 
ª≥©
;

4059 i‡(
∑
->
∑_dñëed
 == 0) {

4060 
∑
->
∑_dñëed
 = 1;

4061 
	`•ö_u∆ock
(&
∑
->
∑_lock
);

4062 
	`li°_dñ_rcu
(&
∑
->
∑_öode_li°
);

4063 
	`li°_add
(&
∑
->
u
.
∑_tmp_li°
, &
li°
);

4068 
	`•ö_u∆ock
(&
∑
->
∑_lock
);

4069 
	`•ö_u∆ock
(&
ei
->
i_¥óŒoc_lock
);

4083 
	`scheduÀ_timeout_unöãºu±ibÀ
(
HZ
);

4084 
ª≥©
;

4086 
	`•ö_u∆ock
(&
ei
->
i_¥óŒoc_lock
);

4088 
	`li°_f‹_óch_íåy_ß„
(
∑
, 
tmp
, &
li°
, 
u
.
∑_tmp_li°
) {

4089 
	`BUG_ON
(
∑
->
∑_ty≥
 !
MB_INODE_PA
);

4090 
group
 = 
	`pxt4_gë_group_numbî
(
sb
, 
∑
->
∑_p°¨t
);

4092 
îr
 = 
	`pxt4_mb_lﬂd_buddy_gÂ
(
sb
, 
group
, &
e4b
,

4093 
GFP_NOFS
|
__GFP_NOFAIL
);

4094 i‡(
îr
) {

4095 
	`pxt4_îr‹
(
sb
, "Error %dÜoading buddy information for %u",

4096 
îr
, 
group
);

4100 
bôm≠_bh
 = 
	`pxt4_ªad_block_bôm≠
(
sb
, 
group
);

4101 i‡(
	`IS_ERR
(
bôm≠_bh
)) {

4102 
îr
 = 
	`PTR_ERR
(
bôm≠_bh
);

4103 
	`pxt4_îr‹
(
sb
, "Error %dÑeading block bitmap for %u",

4104 
îr
, 
group
);

4105 
	`pxt4_mb_u∆ﬂd_buddy
(&
e4b
);

4109 
	`pxt4_lock_group
(
sb
, 
group
);

4110 
	`li°_dñ
(&
∑
->
∑_group_li°
);

4111 
	`pxt4_mb_ªÀa£_öode_∑
(&
e4b
, 
bôm≠_bh
, 
∑
);

4112 
	`pxt4_u∆ock_group
(
sb
, 
group
);

4114 
	`pxt4_mb_u∆ﬂd_buddy
(&
e4b
);

4115 
	`put_bh
(
bôm≠_bh
);

4117 
	`li°_dñ
(&
∑
->
u
.
∑_tmp_li°
);

4118 
	`ˇŒ_rcu
(&(
∑
)->
u
.
∑_rcu
, 
pxt4_mb_∑_ˇŒback
);

4120 
	}
}

4122 #ifde‡
CONFIG_PXT4_DEBUG


4123 
	$pxt4_mb_show_ac
(
pxt4_Æloˇti⁄_c⁄ãxt
 *
ac
)

4125 
su≥r_block
 *
sb
 = 
ac
->
ac_sb
;

4126 
pxt4_group_t
 
ngroups
, 
i
;

4128 i‡(!
pxt4_mbÆloc_debug
 ||

4129 (
	`PXT4_SB
(
sb
)->
s_mou¡_Êags
 & 
PXT4_MF_FS_ABORTED
))

4132 
	`pxt4_msg
(
ac
->
ac_sb
, 
KERN_ERR
, "Can'tállocate:"

4134 
	`pxt4_msg
(
ac
->
ac_sb
, 
KERN_ERR
, "status %d flags %d",

4135 
ac
->
ac_°©us
,ác->
ac_Êags
);

4136 
	`pxt4_msg
(
ac
->
ac_sb
, 
KERN_ERR
, "orig %lu/%lu/%lu@%lu, "

4139 ()
ac
->
ac_o_ex
.
„_group
,

4140 ()
ac
->
ac_o_ex
.
„_°¨t
,

4141 ()
ac
->
ac_o_ex
.
„_Àn
,

4142 ()
ac
->
ac_o_ex
.
„_logiˇl
,

4143 ()
ac
->
ac_g_ex
.
„_group
,

4144 ()
ac
->
ac_g_ex
.
„_°¨t
,

4145 ()
ac
->
ac_g_ex
.
„_Àn
,

4146 ()
ac
->
ac_g_ex
.
„_logiˇl
,

4147 ()
ac
->
ac_b_ex
.
„_group
,

4148 ()
ac
->
ac_b_ex
.
„_°¨t
,

4149 ()
ac
->
ac_b_ex
.
„_Àn
,

4150 ()
ac
->
ac_b_ex
.
„_logiˇl
,

4151 ()
ac
->
ac_¸ôîü
);

4152 
	`pxt4_msg
(
ac
->
ac_sb
, 
KERN_ERR
, "%d found",ác->
ac_found
);

4153 
	`pxt4_msg
(
ac
->
ac_sb
, 
KERN_ERR
, "groups: ");

4154 
ngroups
 = 
	`pxt4_gë_groups_cou¡
(
sb
);

4155 
i
 = 0; i < 
ngroups
; i++) {

4156 
pxt4_group_öfo
 *
gΩ
 = 
	`pxt4_gë_group_öfo
(
sb
, 
i
);

4157 
pxt4_¥óŒoc_•a˚
 *
∑
;

4158 
pxt4_gΩblk_t
 
°¨t
;

4159 
li°_hód
 *
cur
;

4160 
	`pxt4_lock_group
(
sb
, 
i
);

4161 
	`li°_f‹_óch
(
cur
, &
gΩ
->
bb_¥óŒoc_li°
) {

4162 
∑
 = 
	`li°_íåy
(
cur
, 
pxt4_¥óŒoc_•a˚
,

4163 
∑_group_li°
);

4164 
	`•ö_lock
(&
∑
->
∑_lock
);

4165 
	`pxt4_gë_group_no_™d_off£t
(
sb
, 
∑
->
∑_p°¨t
,

4166 
NULL
, &
°¨t
);

4167 
	`•ö_u∆ock
(&
∑
->
∑_lock
);

4168 
	`¥ötk
(
KERN_ERR
 "PA:%u:%d:%u \n", 
i
,

4169 
°¨t
, 
∑
->
∑_Àn
);

4171 
	`pxt4_u∆ock_group
(
sb
, 
i
);

4173 i‡(
gΩ
->
bb_‰ì
 == 0)

4175 
	`¥ötk
(
KERN_ERR
 "%u: %d/%d \n",

4176 
i
, 
gΩ
->
bb_‰ì
, gΩ->
bb_‰agmíts
);

4178 
	`¥ötk
(
KERN_ERR
 "\n");

4179 
	}
}

4181 
ölöe
 
	$pxt4_mb_show_ac
(
pxt4_Æloˇti⁄_c⁄ãxt
 *
ac
)

4184 
	}
}

4194 
	$pxt4_mb_group_‹_fûe
(
pxt4_Æloˇti⁄_c⁄ãxt
 *
ac
)

4196 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
ac
->
ac_sb
);

4197 
bsbôs
 = 
ac
->
ac_sb
->
s_blocksize_bôs
;

4198 
loff_t
 
size
, 
isize
;

4200 i‡(!(
ac
->
ac_Êags
 & 
PXT4_MB_HINT_DATA
))

4203 i‡(
	`u∆ikñy
(
ac
->
ac_Êags
 & 
PXT4_MB_HINT_GOAL_ONLY
))

4206 
size
 = 
ac
->
ac_o_ex
.
„_logiˇl
 + 
	`PXT4_C2B
(
sbi
,ác->ac_o_ex.
„_Àn
);

4207 
isize
 = (
	`i_size_ªad
(
ac
->
ac_öode
Ë+ác->
ac_sb
->
s_blocksize
 - 1)

4208 >> 
bsbôs
;

4210 i‡((
size
 =
isize
Ë&& !
	`pxt4_fs_is_busy
(
sbi
) &&

4211 !
	`öode_is_›í_f‹_wrôe
(
ac
->
ac_öode
)) {

4212 
ac
->
ac_Êags
 |
PXT4_MB_HINT_NOPREALLOC
;

4216 i‡(
sbi
->
s_mb_group_¥óŒoc
 <= 0) {

4217 
ac
->
ac_Êags
 |
PXT4_MB_STREAM_ALLOC
;

4222 
size
 = 
	`max
(size, 
isize
);

4223 i‡(
size
 > 
sbi
->
s_mb_°ªam_ªque°
) {

4224 
ac
->
ac_Êags
 |
PXT4_MB_STREAM_ALLOC
;

4228 
	`BUG_ON
(
ac
->
ac_lg
 !
NULL
);

4234 
ac
->
ac_lg
 = 
	`øw_˝u_±r
(
sbi
->
s_loˇlôy_groups
);

4237 
ac
->
ac_Êags
 |
PXT4_MB_HINT_GROUP_ALLOC
;

4240 
	`muãx_lock
(&
ac
->
ac_lg
->
lg_muãx
);

4241 
	}
}

4243 
noölöe_f‹_°ack
 

4244 
	$pxt4_mb_öôülize_c⁄ãxt
(
pxt4_Æloˇti⁄_c⁄ãxt
 *
ac
,

4245 
pxt4_Æloˇti⁄_ªque°
 *
¨
)

4247 
su≥r_block
 *
sb
 = 
¨
->
öode
->
i_sb
;

4248 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
sb
);

4249 
pxt4_su≥r_block
 *
es
 = 
sbi
->
s_es
;

4250 
pxt4_group_t
 
group
;

4251 
Àn
;

4252 
pxt4_fsblk_t
 
gﬂl
;

4253 
pxt4_gΩblk_t
 
block
;

4256 
Àn
 = 
¨
->len;

4259 i‡(
Àn
 >
	`PXT4_CLUSTERS_PER_GROUP
(
sb
))

4260 
Àn
 = 
	`PXT4_CLUSTERS_PER_GROUP
(
sb
);

4263 
gﬂl
 = 
¨
->goal;

4264 i‡(
gﬂl
 < 
	`À32_to_˝u
(
es
->
s_fú°_d©a_block
) ||

4265 
gﬂl
 >
	`pxt4_blocks_cou¡
(
es
))

4266 
gﬂl
 = 
	`À32_to_˝u
(
es
->
s_fú°_d©a_block
);

4267 
	`pxt4_gë_group_no_™d_off£t
(
sb
, 
gﬂl
, &
group
, &
block
);

4270 
ac
->
ac_b_ex
.
„_logiˇl
 = 
	`PXT4_LBLK_CMASK
(
sbi
, 
¨
->
logiˇl
);

4271 
ac
->
ac_°©us
 = 
AC_STATUS_CONTINUE
;

4272 
ac
->
ac_sb
 = 
sb
;

4273 
ac
->
ac_öode
 = 
¨
->
öode
;

4274 
ac
->
ac_o_ex
.
„_logiˇl
 =ác->
ac_b_ex
.fe_logical;

4275 
ac
->
ac_o_ex
.
„_group
 = 
group
;

4276 
ac
->
ac_o_ex
.
„_°¨t
 = 
block
;

4277 
ac
->
ac_o_ex
.
„_Àn
 = 
Àn
;

4278 
ac
->
ac_g_ex
 =ác->
ac_o_ex
;

4279 
ac
->
ac_Êags
 = 
¨
->
Êags
;

4283 
	`pxt4_mb_group_‹_fûe
(
ac
);

4285 
	`mb_debug
(1, "initác: %u blocks @ %u, goal %u, flags %x, 2^%d, "

4287 (Ë
¨
->
Àn
, (Ë¨->
logiˇl
,

4288 (Ë
¨
->
gﬂl
, 
ac
->
ac_Êags
,ác->
ac_2‹dî
,

4289 (Ë
¨
->
Œe·
, (Ë¨->
∂e·
,

4290 (Ë
¨
->
Ãight
, (Ë¨->
¥ight
,

4291 
	`öode_is_›í_f‹_wrôe
(
¨
->
öode
) ? "" : "non-");

4294 
	}
}

4296 
noölöe_f‹_°ack
 

4297 
	$pxt4_mb_disˇrd_lg_¥óŒoˇti⁄s
(
su≥r_block
 *
sb
,

4298 
pxt4_loˇlôy_group
 *
lg
,

4299 
‹dî
, 
tŸÆ_íåõs
)

4301 
pxt4_group_t
 
group
 = 0;

4302 
pxt4_buddy
 
e4b
;

4303 
li°_hód
 
disˇrd_li°
;

4304 
pxt4_¥óŒoc_•a˚
 *
∑
, *
tmp
;

4306 
	`mb_debug
(1, "discardÜocality groupÖreallocation\n");

4308 
	`INIT_LIST_HEAD
(&
disˇrd_li°
);

4310 
	`•ö_lock
(&
lg
->
lg_¥óŒoc_lock
);

4311 
	`li°_f‹_óch_íåy_rcu
(
∑
, &
lg
->
lg_¥óŒoc_li°
[
‹dî
],

4312 
∑_öode_li°
) {

4313 
	`•ö_lock
(&
∑
->
∑_lock
);

4314 i‡(
	`©omic_ªad
(&
∑
->
∑_cou¡
)) {

4320 
	`•ö_u∆ock
(&
∑
->
∑_lock
);

4323 i‡(
∑
->
∑_dñëed
) {

4324 
	`•ö_u∆ock
(&
∑
->
∑_lock
);

4328 
	`BUG_ON
(
∑
->
∑_ty≥
 !
MB_GROUP_PA
);

4331 
∑
->
∑_dñëed
 = 1;

4332 
	`•ö_u∆ock
(&
∑
->
∑_lock
);

4334 
	`li°_dñ_rcu
(&
∑
->
∑_öode_li°
);

4335 
	`li°_add
(&
∑
->
u
.
∑_tmp_li°
, &
disˇrd_li°
);

4337 
tŸÆ_íåõs
--;

4338 i‡(
tŸÆ_íåõs
 <= 5) {

4348 
	`•ö_u∆ock
(&
lg
->
lg_¥óŒoc_lock
);

4350 
	`li°_f‹_óch_íåy_ß„
(
∑
, 
tmp
, &
disˇrd_li°
, 
u
.
∑_tmp_li°
) {

4351 
îr
;

4353 
group
 = 
	`pxt4_gë_group_numbî
(
sb
, 
∑
->
∑_p°¨t
);

4354 
îr
 = 
	`pxt4_mb_lﬂd_buddy_gÂ
(
sb
, 
group
, &
e4b
,

4355 
GFP_NOFS
|
__GFP_NOFAIL
);

4356 i‡(
îr
) {

4357 
	`pxt4_îr‹
(
sb
, "Error %dÜoading buddy information for %u",

4358 
îr
, 
group
);

4361 
	`pxt4_lock_group
(
sb
, 
group
);

4362 
	`li°_dñ
(&
∑
->
∑_group_li°
);

4363 
	`pxt4_mb_ªÀa£_group_∑
(&
e4b
, 
∑
);

4364 
	`pxt4_u∆ock_group
(
sb
, 
group
);

4366 
	`pxt4_mb_u∆ﬂd_buddy
(&
e4b
);

4367 
	`li°_dñ
(&
∑
->
u
.
∑_tmp_li°
);

4368 
	`ˇŒ_rcu
(&(
∑
)->
u
.
∑_rcu
, 
pxt4_mb_∑_ˇŒback
);

4370 
	}
}

4381 
	$pxt4_mb_add_n_åim
(
pxt4_Æloˇti⁄_c⁄ãxt
 *
ac
)

4383 
‹dî
, 
added
 = 0, 
lg_¥óŒoc_cou¡
 = 1;

4384 
su≥r_block
 *
sb
 = 
ac
->
ac_sb
;

4385 
pxt4_loˇlôy_group
 *
lg
 = 
ac
->
ac_lg
;

4386 
pxt4_¥óŒoc_•a˚
 *
tmp_∑
, *
∑
 = 
ac
->
ac_∑
;

4388 
‹dî
 = 
	`Ês
(
∑
->
∑_‰ì
) - 1;

4389 i‡(
‹dî
 > 
PREALLOC_TB_SIZE
 - 1)

4391 
‹dî
 = 
PREALLOC_TB_SIZE
 - 1;

4393 
	`•ö_lock
(&
lg
->
lg_¥óŒoc_lock
);

4394 
	`li°_f‹_óch_íåy_rcu
(
tmp_∑
, &
lg
->
lg_¥óŒoc_li°
[
‹dî
],

4395 
∑_öode_li°
) {

4396 
	`•ö_lock
(&
tmp_∑
->
∑_lock
);

4397 i‡(
tmp_∑
->
∑_dñëed
) {

4398 
	`•ö_u∆ock
(&
tmp_∑
->
∑_lock
);

4401 i‡(!
added
 && 
∑
->
∑_‰ì
 < 
tmp_∑
->pa_free) {

4403 
	`li°_add_èû_rcu
(&
∑
->
∑_öode_li°
,

4404 &
tmp_∑
->
∑_öode_li°
);

4405 
added
 = 1;

4411 
	`•ö_u∆ock
(&
tmp_∑
->
∑_lock
);

4412 
lg_¥óŒoc_cou¡
++;

4414 i‡(!
added
)

4415 
	`li°_add_èû_rcu
(&
∑
->
∑_öode_li°
,

4416 &
lg
->
lg_¥óŒoc_li°
[
‹dî
]);

4417 
	`•ö_u∆ock
(&
lg
->
lg_¥óŒoc_lock
);

4420 i‡(
lg_¥óŒoc_cou¡
 > 8) {

4421 
	`pxt4_mb_disˇrd_lg_¥óŒoˇti⁄s
(
sb
, 
lg
,

4422 
‹dî
, 
lg_¥óŒoc_cou¡
);

4426 
	}
}

4431 
	$pxt4_mb_ªÀa£_c⁄ãxt
(
pxt4_Æloˇti⁄_c⁄ãxt
 *
ac
)

4433 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
ac
->
ac_sb
);

4434 
pxt4_¥óŒoc_•a˚
 *
∑
 = 
ac
->
ac_∑
;

4435 i‡(
∑
) {

4436 i‡(
∑
->
∑_ty≥
 =
MB_GROUP_PA
) {

4438 
	`•ö_lock
(&
∑
->
∑_lock
);

4439 
∑
->
∑_p°¨t
 +
	`PXT4_C2B
(
sbi
, 
ac
->
ac_b_ex
.
„_Àn
);

4440 
∑
->
∑_l°¨t
 +
	`PXT4_C2B
(
sbi
, 
ac
->
ac_b_ex
.
„_Àn
);

4441 
∑
->
∑_‰ì
 -
ac
->
ac_b_ex
.
„_Àn
;

4442 
∑
->
∑_Àn
 -
ac
->
ac_b_ex
.
„_Àn
;

4443 
	`•ö_u∆ock
(&
∑
->
∑_lock
);

4446 i‡(
∑
) {

4453 i‡((
∑
->
∑_ty≥
 =
MB_GROUP_PA
Ë&& 
	`likñy
’a->
∑_‰ì
)) {

4454 
	`•ö_lock
(
∑
->
∑_obj_lock
);

4455 
	`li°_dñ_rcu
(&
∑
->
∑_öode_li°
);

4456 
	`•ö_u∆ock
(
∑
->
∑_obj_lock
);

4457 
	`pxt4_mb_add_n_åim
(
ac
);

4459 
	`pxt4_mb_put_∑
(
ac
,ác->
ac_sb
, 
∑
);

4461 i‡(
ac
->
ac_bôm≠_∑ge
)

4462 
	`put_∑ge
(
ac
->
ac_bôm≠_∑ge
);

4463 i‡(
ac
->
ac_buddy_∑ge
)

4464 
	`put_∑ge
(
ac
->
ac_buddy_∑ge
);

4465 i‡(
ac
->
ac_Êags
 & 
PXT4_MB_HINT_GROUP_ALLOC
)

4466 
	`muãx_u∆ock
(&
ac
->
ac_lg
->
lg_muãx
);

4467 
	`pxt4_mb_cﬁÀ˘_°©s
(
ac
);

4469 
	}
}

4471 
	$pxt4_mb_disˇrd_¥óŒoˇti⁄s
(
su≥r_block
 *
sb
, 
√eded
)

4473 
pxt4_group_t
 
i
, 
ngroups
 = 
	`pxt4_gë_groups_cou¡
(
sb
);

4474 
ªt
;

4475 
‰ìd
 = 0;

4477 
	`åa˚_pxt4_mb_disˇrd_¥óŒoˇti⁄s
(
sb
, 
√eded
);

4478 
i
 = 0; i < 
ngroups
 && 
√eded
 > 0; i++) {

4479 
ªt
 = 
	`pxt4_mb_disˇrd_group_¥óŒoˇti⁄s
(
sb
, 
i
, 
√eded
);

4480 
‰ìd
 +
ªt
;

4481 
√eded
 -
ªt
;

4484  
‰ìd
;

4485 
	}
}

4492 
pxt4_fsblk_t
 
	$pxt4_mb_√w_blocks
(
h™dÀ_t
 *
h™dÀ
,

4493 
pxt4_Æloˇti⁄_ªque°
 *
¨
, *
îΩ
)

4495 
‰ìd
;

4496 
pxt4_Æloˇti⁄_c⁄ãxt
 *
ac
 = 
NULL
;

4497 
pxt4_sb_öfo
 *
sbi
;

4498 
su≥r_block
 *
sb
;

4499 
pxt4_fsblk_t
 
block
 = 0;

4500 
öquŸa
 = 0;

4501 
ª£rv_˛°rs
 = 0;

4503 
	`might_¶ìp
();

4504 
sb
 = 
¨
->
öode
->
i_sb
;

4505 
sbi
 = 
	`PXT4_SB
(
sb
);

4507 
	`åa˚_pxt4_ªque°_blocks
(
¨
);

4510 i‡(
	`pxt4_is_quŸa_fûe
(
¨
->
öode
))

4511 
¨
->
Êags
 |
PXT4_MB_USE_ROOT_BLOCKS
;

4513 i‡((
¨
->
Êags
 & 
PXT4_MB_DELALLOC_RESERVED
) == 0) {

4518 
¨
->
Àn
 &&

4519 
	`pxt4_˛aim_‰ì_˛u°îs
(
sbi
, 
¨
->
Àn
,ár->
Êags
)) {

4522 
	`c⁄d_ªsched
();

4523 
¨
->
Àn
 =ár->len >> 1;

4525 i‡(!
¨
->
Àn
) {

4526 *
îΩ
 = -
ENOSPC
;

4529 
ª£rv_˛°rs
 = 
¨
->
Àn
;

4530 i‡(
¨
->
Êags
 & 
PXT4_MB_USE_ROOT_BLOCKS
) {

4531 
	`dquŸ_Æloc_block_noÁû
(
¨
->
öode
,

4532 
	`PXT4_C2B
(
sbi
, 
¨
->
Àn
));

4534 
¨
->
Àn
 &&

4535 
	`dquŸ_Æloc_block
(
¨
->
öode
,

4536 
	`PXT4_C2B
(
sbi
, 
¨
->
Àn
))) {

4538 
¨
->
Êags
 |
PXT4_MB_HINT_NOPREALLOC
;

4539 
¨
->
Àn
--;

4542 
öquŸa
 = 
¨
->
Àn
;

4543 i‡(
¨
->
Àn
 == 0) {

4544 *
îΩ
 = -
EDQUOT
;

4545 
out
;

4549 
ac
 = 
	`kmem_ˇche_zÆloc
(
pxt4_ac_ˇchï
, 
GFP_NOFS
);

4550 i‡(!
ac
) {

4551 
¨
->
Àn
 = 0;

4552 *
îΩ
 = -
ENOMEM
;

4553 
out
;

4556 *
îΩ
 = 
	`pxt4_mb_öôülize_c⁄ãxt
(
ac
, 
¨
);

4557 i‡(*
îΩ
) {

4558 
¨
->
Àn
 = 0;

4559 
out
;

4562 
ac
->
ac_›
 = 
PXT4_MB_HISTORY_PREALLOC
;

4563 i‡(!
	`pxt4_mb_u£_¥óŒoˇãd
(
ac
)) {

4564 
ac
->
ac_›
 = 
PXT4_MB_HISTORY_ALLOC
;

4565 
	`pxt4_mb_n‹mÆize_ªque°
(
ac
, 
¨
);

4566 
ª≥©
:

4568 *
îΩ
 = 
	`pxt4_mb_ªguœr_Æloˇt‹
(
ac
);

4569 i‡(*
îΩ
)

4570 
disˇrd_™d_exô
;

4575 i‡(
ac
->
ac_°©us
 =
AC_STATUS_FOUND
 &&

4576 
ac
->
ac_o_ex
.
„_Àn
 <ác->
ac_b_ex
.fe_len)

4577 *
îΩ
 = 
	`pxt4_mb_√w_¥óŒoˇti⁄
(
ac
);

4578 i‡(*
îΩ
) {

4579 
disˇrd_™d_exô
:

4580 
	`pxt4_disˇrd_Æloˇãd_blocks
(
ac
);

4581 
îrout
;

4584 i‡(
	`likñy
(
ac
->
ac_°©us
 =
AC_STATUS_FOUND
)) {

4585 *
îΩ
 = 
	`pxt4_mb_m¨k_disk•a˚_u£d
(
ac
, 
h™dÀ
, 
ª£rv_˛°rs
);

4586 i‡(*
îΩ
) {

4587 
	`pxt4_disˇrd_Æloˇãd_blocks
(
ac
);

4588 
îrout
;

4590 
block
 = 
	`pxt4_gΩ_offs_to_block
(
sb
, &
ac
->
ac_b_ex
);

4591 
¨
->
Àn
 = 
ac
->
ac_b_ex
.
„_Àn
;

4594 
‰ìd
 = 
	`pxt4_mb_disˇrd_¥óŒoˇti⁄s
(
sb
, 
ac
->
ac_o_ex
.
„_Àn
);

4595 i‡(
‰ìd
)

4596 
ª≥©
;

4597 *
îΩ
 = -
ENOSPC
;

4600 
îrout
:

4601 i‡(*
îΩ
) {

4602 
ac
->
ac_b_ex
.
„_Àn
 = 0;

4603 
¨
->
Àn
 = 0;

4604 
	`pxt4_mb_show_ac
(
ac
);

4606 
	`pxt4_mb_ªÀa£_c⁄ãxt
(
ac
);

4607 
out
:

4608 i‡(
ac
)

4609 
	`kmem_ˇche_‰ì
(
pxt4_ac_ˇchï
, 
ac
);

4610 i‡(
öquŸa
 && 
¨
->
Àn
 < inquota)

4611 
	`dquŸ_‰ì_block
(
¨
->
öode
, 
	`PXT4_C2B
(
sbi
, 
öquŸa
 -ár->
Àn
));

4612 i‡(!
¨
->
Àn
) {

4613 i‡((
¨
->
Êags
 & 
PXT4_MB_DELALLOC_RESERVED
) == 0)

4615 
	`≥r˝u_cou¡î_sub
(&
sbi
->
s_dúty˛u°îs_cou¡î
,

4616 
ª£rv_˛°rs
);

4619 
	`åa˚_pxt4_Æloˇã_blocks
(
¨
, ()
block
);

4621  
block
;

4622 
	}
}

4629 
	$pxt4_åy_mîge_‰ìd_exã¡
(
pxt4_sb_öfo
 *
sbi
,

4630 
pxt4_‰ì_d©a
 *
íåy
,

4631 
pxt4_‰ì_d©a
 *
√w_íåy
,

4632 
rb_roŸ
 *
íåy_rb_roŸ
)

4634 i‡((
íåy
->
efd_tid
 !
√w_íåy
->efd_tid) ||

4635 (
íåy
->
efd_group
 !
√w_íåy
->efd_group))

4637 i‡(
íåy
->
efd_°¨t_˛u°î
 +É¡ry->
efd_cou¡
 ==

4638 
√w_íåy
->
efd_°¨t_˛u°î
) {

4639 
√w_íåy
->
efd_°¨t_˛u°î
 = 
íåy
->efd_start_cluster;

4640 
√w_íåy
->
efd_cou¡
 +
íåy
->efd_count;

4641 } i‡(
√w_íåy
->
efd_°¨t_˛u°î
 +Çew_íåy->
efd_cou¡
 ==

4642 
íåy
->
efd_°¨t_˛u°î
) {

4643 
√w_íåy
->
efd_cou¡
 +
íåy
->efd_count;

4646 
	`•ö_lock
(&
sbi
->
s_md_lock
);

4647 
	`li°_dñ
(&
íåy
->
efd_li°
);

4648 
	`•ö_u∆ock
(&
sbi
->
s_md_lock
);

4649 
	`rb_îa£
(&
íåy
->
efd_node
, 
íåy_rb_roŸ
);

4650 
	`kmem_ˇche_‰ì
(
pxt4_‰ì_d©a_ˇchï
, 
íåy
);

4651 
	}
}

4653 
noölöe_f‹_°ack
 

4654 
	$pxt4_mb_‰ì_mëad©a
(
h™dÀ_t
 *
h™dÀ
, 
pxt4_buddy
 *
e4b
,

4655 
pxt4_‰ì_d©a
 *
√w_íåy
)

4657 
pxt4_group_t
 
group
 = 
e4b
->
bd_group
;

4658 
pxt4_gΩblk_t
 
˛u°î
;

4659 
pxt4_gΩblk_t
 
˛u°îs
 = 
√w_íåy
->
efd_cou¡
;

4660 
pxt4_‰ì_d©a
 *
íåy
;

4661 
pxt4_group_öfo
 *
db
 = 
e4b
->
bd_öfo
;

4662 
su≥r_block
 *
sb
 = 
e4b
->
bd_sb
;

4663 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
sb
);

4664 
rb_node
 **
n
 = &
db
->
bb_‰ì_roŸ
.rb_node, *
node
;

4665 
rb_node
 *
∑ª¡
 = 
NULL
, *
√w_node
;

4667 
	`BUG_ON
(!
	`pxt4_h™dÀ_vÆid
(
h™dÀ
));

4668 
	`BUG_ON
(
e4b
->
bd_bôm≠_∑ge
 =
NULL
);

4669 
	`BUG_ON
(
e4b
->
bd_buddy_∑ge
 =
NULL
);

4671 
√w_node
 = &
√w_íåy
->
efd_node
;

4672 
˛u°î
 = 
√w_íåy
->
efd_°¨t_˛u°î
;

4674 i‡(!*
n
) {

4680 
	`gë_∑ge
(
e4b
->
bd_buddy_∑ge
);

4681 
	`gë_∑ge
(
e4b
->
bd_bôm≠_∑ge
);

4683 *
n
) {

4684 
∑ª¡
 = *
n
;

4685 
íåy
 = 
	`rb_íåy
(
∑ª¡
, 
pxt4_‰ì_d©a
, 
efd_node
);

4686 i‡(
˛u°î
 < 
íåy
->
efd_°¨t_˛u°î
)

4687 
n
 = &(*n)->
rb_À·
;

4688 i‡(
˛u°î
 >(
íåy
->
efd_°¨t_˛u°î
 +É¡ry->
efd_cou¡
))

4689 
n
 = &(*n)->
rb_right
;

4691 
	`pxt4_gΩ_locked_îr‹
(
sb
, 
group
, 0,

4692 
	`pxt4_group_fú°_block_no
(
sb
, 
group
) +

4693 
	`PXT4_C2B
(
sbi
, 
˛u°î
),

4695 
	`kmem_ˇche_‰ì
(
pxt4_‰ì_d©a_ˇchï
, 
√w_íåy
);

4700 
	`rb_lök_node
(
√w_node
, 
∑ª¡
, 
n
);

4701 
	`rb_ö£π_cﬁ‹
(
√w_node
, &
db
->
bb_‰ì_roŸ
);

4704 
node
 = 
	`rb_¥ev
(
√w_node
);

4705 i‡(
node
) {

4706 
íåy
 = 
	`rb_íåy
(
node
, 
pxt4_‰ì_d©a
, 
efd_node
);

4707 
	`pxt4_åy_mîge_‰ìd_exã¡
(
sbi
, 
íåy
, 
√w_íåy
,

4708 &(
db
->
bb_‰ì_roŸ
));

4711 
node
 = 
	`rb_√xt
(
√w_node
);

4712 i‡(
node
) {

4713 
íåy
 = 
	`rb_íåy
(
node
, 
pxt4_‰ì_d©a
, 
efd_node
);

4714 
	`pxt4_åy_mîge_‰ìd_exã¡
(
sbi
, 
íåy
, 
√w_íåy
,

4715 &(
db
->
bb_‰ì_roŸ
));

4718 
	`•ö_lock
(&
sbi
->
s_md_lock
);

4719 
	`li°_add_èû
(&
√w_íåy
->
efd_li°
, &
sbi
->
s_‰ìd_d©a_li°
);

4720 
sbi
->
s_mb_‰ì_≥ndög
 +
˛u°îs
;

4721 
	`•ö_u∆ock
(&
sbi
->
s_md_lock
);

4723 
	}
}

4734 
	$pxt4_‰ì_blocks
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *inode,

4735 
buf„r_hód
 *
bh
, 
pxt4_fsblk_t
 
block
,

4736 
cou¡
, 
Êags
)

4738 
buf„r_hód
 *
bôm≠_bh
 = 
NULL
;

4739 
su≥r_block
 *
sb
 = 
öode
->
i_sb
;

4740 
pxt4_group_desc
 *
gdp
;

4741 
ovîÊow
;

4742 
pxt4_gΩblk_t
 
bô
;

4743 
buf„r_hód
 *
gd_bh
;

4744 
pxt4_group_t
 
block_group
;

4745 
pxt4_sb_öfo
 *
sbi
;

4746 
pxt4_buddy
 
e4b
;

4747 
cou¡_˛u°îs
;

4748 
îr
 = 0;

4749 
ªt
;

4751 
	`might_¶ìp
();

4752 i‡(
bh
) {

4753 i‡(
block
)

4754 
	`BUG_ON
(
block
 !
bh
->
b_blockƒ
);

4756 
block
 = 
bh
->
b_blockƒ
;

4759 
sbi
 = 
	`PXT4_SB
(
sb
);

4760 i‡(!(
Êags
 & 
PXT4_FREE_BLOCKS_VALIDATED
) &&

4761 !
	`pxt4_d©a_block_vÆid
(
sbi
, 
block
, 
cou¡
)) {

4762 
	`pxt4_îr‹
(
sb
, "Freeing blocksÇot in datazone - "

4763 "block = %Œu, cou¡ = %lu", 
block
, 
cou¡
);

4764 
îr‹_ªtu∫
;

4767 
	`pxt4_debug
("‰ìög block %Œu\n", 
block
);

4768 
	`åa˚_pxt4_‰ì_blocks
(
öode
, 
block
, 
cou¡
, 
Êags
);

4770 i‡(
bh
 && (
Êags
 & 
PXT4_FREE_BLOCKS_FORGET
)) {

4771 
	`BUG_ON
(
cou¡
 > 1);

4773 
	`pxt4_f‹gë
(
h™dÀ
, 
Êags
 & 
PXT4_FREE_BLOCKS_METADATA
,

4774 
öode
, 
bh
, 
block
);

4784 
ovîÊow
 = 
	`PXT4_PBLK_COFF
(
sbi
, 
block
);

4785 i‡(
ovîÊow
) {

4786 i‡(
Êags
 & 
PXT4_FREE_BLOCKS_NOFREE_FIRST_CLUSTER
) {

4787 
ovîÊow
 = 
sbi
->
s_˛u°î_øtio
 - overflow;

4788 
block
 +
ovîÊow
;

4789 i‡(
cou¡
 > 
ovîÊow
)

4790 
cou¡
 -
ovîÊow
;

4794 
block
 -
ovîÊow
;

4795 
cou¡
 +
ovîÊow
;

4798 
ovîÊow
 = 
	`PXT4_LBLK_COFF
(
sbi
, 
cou¡
);

4799 i‡(
ovîÊow
) {

4800 i‡(
Êags
 & 
PXT4_FREE_BLOCKS_NOFREE_LAST_CLUSTER
) {

4801 i‡(
cou¡
 > 
ovîÊow
)

4802 
cou¡
 -
ovîÊow
;

4806 
cou¡
 +
sbi
->
s_˛u°î_øtio
 - 
ovîÊow
;

4809 i‡(!
bh
 && (
Êags
 & 
PXT4_FREE_BLOCKS_FORGET
)) {

4810 
i
;

4811 
is_mëad©a
 = 
Êags
 & 
PXT4_FREE_BLOCKS_METADATA
;

4813 
i
 = 0; i < 
cou¡
; i++) {

4814 
	`c⁄d_ªsched
();

4815 i‡(
is_mëad©a
)

4816 
bh
 = 
	`sb_föd_gë_block
(
öode
->
i_sb
, 
block
 + 
i
);

4817 
	`pxt4_f‹gë
(
h™dÀ
, 
is_mëad©a
, 
öode
, 
bh
, 
block
 + 
i
);

4821 
do_m‹e
:

4822 
ovîÊow
 = 0;

4823 
	`pxt4_gë_group_no_™d_off£t
(
sb
, 
block
, &
block_group
, &
bô
);

4825 i‡(
	`u∆ikñy
(
	`PXT4_MB_GRP_BBITMAP_CORRUPT
(

4826 
	`pxt4_gë_group_öfo
(
sb
, 
block_group
))))

4833 i‡(
	`PXT4_C2B
(
sbi
, 
bô
Ë+ 
cou¡
 > 
	`PXT4_BLOCKS_PER_GROUP
(
sb
)) {

4834 
ovîÊow
 = 
	`PXT4_C2B
(
sbi
, 
bô
Ë+ 
cou¡
 -

4835 
	`PXT4_BLOCKS_PER_GROUP
(
sb
);

4836 
cou¡
 -
ovîÊow
;

4838 
cou¡_˛u°îs
 = 
	`PXT4_NUM_B2C
(
sbi
, 
cou¡
);

4839 
bôm≠_bh
 = 
	`pxt4_ªad_block_bôm≠
(
sb
, 
block_group
);

4840 i‡(
	`IS_ERR
(
bôm≠_bh
)) {

4841 
îr
 = 
	`PTR_ERR
(
bôm≠_bh
);

4842 
bôm≠_bh
 = 
NULL
;

4843 
îr‹_ªtu∫
;

4845 
gdp
 = 
	`pxt4_gë_group_desc
(
sb
, 
block_group
, &
gd_bh
);

4846 i‡(!
gdp
) {

4847 
îr
 = -
EIO
;

4848 
îr‹_ªtu∫
;

4851 i‡(
	`ö_ønge
(
	`pxt4_block_bôm≠
(
sb
, 
gdp
), 
block
, 
cou¡
) ||

4852 
	`ö_ønge
(
	`pxt4_öode_bôm≠
(
sb
, 
gdp
), 
block
, 
cou¡
) ||

4853 
	`ö_ønge
(
block
, 
	`pxt4_öode_èbÀ
(
sb
, 
gdp
),

4854 
sbi
->
s_ôb_≥r_group
) ||

4855 
	`ö_ønge
(
block
 + 
cou¡
 - 1, 
	`pxt4_öode_èbÀ
(
sb
, 
gdp
),

4856 
sbi
->
s_ôb_≥r_group
)) {

4858 
	`pxt4_îr‹
(
sb
, "Freeing blocks in system zone - "

4859 "Block = %Œu, cou¡ = %lu", 
block
, 
cou¡
);

4861 
îr‹_ªtu∫
;

4864 
	`BUFFER_TRACE
(
bôm≠_bh
, "getting writeáccess");

4865 
îr
 = 
	`pxt4_jou∫Æ_gë_wrôe_ac˚ss
(
h™dÀ
, 
bôm≠_bh
);

4866 i‡(
îr
)

4867 
îr‹_ªtu∫
;

4874 
	`BUFFER_TRACE
(
gd_bh
, "get_write_access");

4875 
îr
 = 
	`pxt4_jou∫Æ_gë_wrôe_ac˚ss
(
h™dÀ
, 
gd_bh
);

4876 i‡(
îr
)

4877 
îr‹_ªtu∫
;

4878 #ifde‡
AGGRESSIVE_CHECK


4880 
i
;

4881 
i
 = 0; i < 
cou¡_˛u°îs
; i++)

4882 
	`BUG_ON
(!
	`mb_ã°_bô
(
bô
 + 
i
, 
bôm≠_bh
->
b_d©a
));

4885 
	`åa˚_pxt4_mbÆloc_‰ì
(
sb
, 
öode
, 
block_group
, 
bô
, 
cou¡_˛u°îs
);

4888 
îr
 = 
	`pxt4_mb_lﬂd_buddy_gÂ
(
sb
, 
block_group
, &
e4b
,

4889 
GFP_NOFS
|
__GFP_NOFAIL
);

4890 i‡(
îr
)

4891 
îr‹_ªtu∫
;

4899 i‡(
	`pxt4_h™dÀ_vÆid
(
h™dÀ
) &&

4900 ((
Êags
 & 
PXT4_FREE_BLOCKS_METADATA
) ||

4901 !
	`pxt4_should_wrôeback_d©a
(
öode
))) {

4902 
pxt4_‰ì_d©a
 *
√w_íåy
;

4907 
√w_íåy
 = 
	`kmem_ˇche_Æloc
(
pxt4_‰ì_d©a_ˇchï
,

4908 
GFP_NOFS
|
__GFP_NOFAIL
);

4909 
√w_íåy
->
efd_°¨t_˛u°î
 = 
bô
;

4910 
√w_íåy
->
efd_group
 = 
block_group
;

4911 
√w_íåy
->
efd_cou¡
 = 
cou¡_˛u°îs
;

4912 
√w_íåy
->
efd_tid
 = 
h™dÀ
->
h_å™ß˘i⁄
->
t_tid
;

4914 
	`pxt4_lock_group
(
sb
, 
block_group
);

4915 
	`mb_˛ór_bôs
(
bôm≠_bh
->
b_d©a
, 
bô
, 
cou¡_˛u°îs
);

4916 
	`pxt4_mb_‰ì_mëad©a
(
h™dÀ
, &
e4b
, 
√w_íåy
);

4922 i‡(
	`ã°_›t
(
sb
, 
DISCARD
)) {

4923 
îr
 = 
	`pxt4_issue_disˇrd
(
sb
, 
block_group
, 
bô
, 
cou¡
,

4924 
NULL
);

4925 i‡(
îr
 &&Éº !-
EOPNOTSUPP
)

4926 
	`pxt4_msg
(
sb
, 
KERN_WARNING
, "discardÑequest in"

4928 " wôh %d", 
block_group
, 
bô
, 
cou¡
,

4929 
îr
);

4931 
	`PXT4_MB_GRP_CLEAR_TRIMMED
(
e4b
.
bd_öfo
);

4933 
	`pxt4_lock_group
(
sb
, 
block_group
);

4934 
	`mb_˛ór_bôs
(
bôm≠_bh
->
b_d©a
, 
bô
, 
cou¡_˛u°îs
);

4935 
	`mb_‰ì_blocks
(
öode
, &
e4b
, 
bô
, 
cou¡_˛u°îs
);

4938 
ªt
 = 
	`pxt4_‰ì_group_˛u°îs
(
sb
, 
gdp
Ë+ 
cou¡_˛u°îs
;

4939 
	`pxt4_‰ì_group_˛u°îs_£t
(
sb
, 
gdp
, 
ªt
);

4940 
	`pxt4_block_bôm≠_csum_£t
(
sb
, 
block_group
, 
gdp
, 
bôm≠_bh
);

4941 
	`pxt4_group_desc_csum_£t
(
sb
, 
block_group
, 
gdp
);

4942 
	`pxt4_u∆ock_group
(
sb
, 
block_group
);

4944 i‡(
sbi
->
s_log_groups_≥r_Êex
) {

4945 
pxt4_group_t
 
Êex_group
 = 
	`pxt4_Êex_group
(
sbi
, 
block_group
);

4946 
	`©omic64_add
(
cou¡_˛u°îs
,

4947 &
	`sbi_¨øy_rcu_dîef
(
sbi
, 
s_Êex_groups
,

4948 
Êex_group
)->
‰ì_˛u°îs
);

4956 i‡(!(
Êags
 & 
PXT4_FREE_BLOCKS_RERESERVE_CLUSTER
)) {

4957 i‡(!(
Êags
 & 
PXT4_FREE_BLOCKS_NO_QUOT_UPDATE
))

4958 
	`dquŸ_‰ì_block
(
öode
, 
	`PXT4_C2B
(
sbi
, 
cou¡_˛u°îs
));

4959 
	`≥r˝u_cou¡î_add
(&
sbi
->
s_‰ì˛u°îs_cou¡î
,

4960 
cou¡_˛u°îs
);

4963 
	`pxt4_mb_u∆ﬂd_buddy
(&
e4b
);

4966 
	`BUFFER_TRACE
(
bôm≠_bh
, "dirtied bitmap block");

4967 
îr
 = 
	`pxt4_h™dÀ_dúty_mëad©a
(
h™dÀ
, 
NULL
, 
bôm≠_bh
);

4970 
	`BUFFER_TRACE
(
gd_bh
, "dirtied group descriptor block");

4971 
ªt
 = 
	`pxt4_h™dÀ_dúty_mëad©a
(
h™dÀ
, 
NULL
, 
gd_bh
);

4972 i‡(!
îr
)

4973 
îr
 = 
ªt
;

4975 i‡(
ovîÊow
 && !
îr
) {

4976 
block
 +
cou¡
;

4977 
cou¡
 = 
ovîÊow
;

4978 
	`put_bh
(
bôm≠_bh
);

4979 
do_m‹e
;

4981 
îr‹_ªtu∫
:

4982 
	`bªl£
(
bôm≠_bh
);

4983 
	`pxt4_°d_îr‹
(
sb
, 
îr
);

4985 
	}
}

4996 
	$pxt4_group_add_blocks
(
h™dÀ_t
 *
h™dÀ
, 
su≥r_block
 *
sb
,

4997 
pxt4_fsblk_t
 
block
, 
cou¡
)

4999 
buf„r_hód
 *
bôm≠_bh
 = 
NULL
;

5000 
buf„r_hód
 *
gd_bh
;

5001 
pxt4_group_t
 
block_group
;

5002 
pxt4_gΩblk_t
 
bô
;

5003 
i
;

5004 
pxt4_group_desc
 *
desc
;

5005 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
sb
);

5006 
pxt4_buddy
 
e4b
;

5007 
îr
 = 0, 
ªt
, 
‰ì_˛u°îs_cou¡
;

5008 
pxt4_gΩblk_t
 
˛u°îs_‰ìd
;

5009 
pxt4_fsblk_t
 
fú°_˛u°î
 = 
	`PXT4_B2C
(
sbi
, 
block
);

5010 
pxt4_fsblk_t
 
œ°_˛u°î
 = 
	`PXT4_B2C
(
sbi
, 
block
 + 
cou¡
 - 1);

5011 
˛u°î_cou¡
 = 
œ°_˛u°î
 - 
fú°_˛u°î
 + 1;

5013 
	`pxt4_debug
("Addög block(sË%Œu-%Œu\n", 
block
, block + 
cou¡
 - 1);

5015 i‡(
cou¡
 == 0)

5018 
	`pxt4_gë_group_no_™d_off£t
(
sb
, 
block
, &
block_group
, &
bô
);

5023 i‡(
bô
 + 
˛u°î_cou¡
 > 
	`PXT4_CLUSTERS_PER_GROUP
(
sb
)) {

5024 
	`pxt4_w¨nög
(
sb
, "too many blocksáddedÅo group %u",

5025 
block_group
);

5026 
îr
 = -
EINVAL
;

5027 
îr‹_ªtu∫
;

5030 
bôm≠_bh
 = 
	`pxt4_ªad_block_bôm≠
(
sb
, 
block_group
);

5031 i‡(
	`IS_ERR
(
bôm≠_bh
)) {

5032 
îr
 = 
	`PTR_ERR
(
bôm≠_bh
);

5033 
bôm≠_bh
 = 
NULL
;

5034 
îr‹_ªtu∫
;

5037 
desc
 = 
	`pxt4_gë_group_desc
(
sb
, 
block_group
, &
gd_bh
);

5038 i‡(!
desc
) {

5039 
îr
 = -
EIO
;

5040 
îr‹_ªtu∫
;

5043 i‡(
	`ö_ønge
(
	`pxt4_block_bôm≠
(
sb
, 
desc
), 
block
, 
cou¡
) ||

5044 
	`ö_ønge
(
	`pxt4_öode_bôm≠
(
sb
, 
desc
), 
block
, 
cou¡
) ||

5045 
	`ö_ønge
(
block
, 
	`pxt4_öode_èbÀ
(
sb
, 
desc
), 
sbi
->
s_ôb_≥r_group
) ||

5046 
	`ö_ønge
(
block
 + 
cou¡
 - 1, 
	`pxt4_öode_èbÀ
(
sb
, 
desc
),

5047 
sbi
->
s_ôb_≥r_group
)) {

5048 
	`pxt4_îr‹
(
sb
, "Adding blocks in system zones - "

5050 
block
, 
cou¡
);

5051 
îr
 = -
EINVAL
;

5052 
îr‹_ªtu∫
;

5055 
	`BUFFER_TRACE
(
bôm≠_bh
, "getting writeáccess");

5056 
îr
 = 
	`pxt4_jou∫Æ_gë_wrôe_ac˚ss
(
h™dÀ
, 
bôm≠_bh
);

5057 i‡(
îr
)

5058 
îr‹_ªtu∫
;

5065 
	`BUFFER_TRACE
(
gd_bh
, "get_write_access");

5066 
îr
 = 
	`pxt4_jou∫Æ_gë_wrôe_ac˚ss
(
h™dÀ
, 
gd_bh
);

5067 i‡(
îr
)

5068 
îr‹_ªtu∫
;

5070 
i
 = 0, 
˛u°îs_‰ìd
 = 0; i < 
˛u°î_cou¡
; i++) {

5071 
	`BUFFER_TRACE
(
bôm≠_bh
, "clear bit");

5072 i‡(!
	`mb_ã°_bô
(
bô
 + 
i
, 
bôm≠_bh
->
b_d©a
)) {

5073 
	`pxt4_îr‹
(
sb
, "bitálready cleared for block %llu",

5074 (
pxt4_fsblk_t
)(
block
 + 
i
));

5075 
	`BUFFER_TRACE
(
bôm≠_bh
, "bitálready cleared");

5077 
˛u°îs_‰ìd
++;

5081 
îr
 = 
	`pxt4_mb_lﬂd_buddy
(
sb
, 
block_group
, &
e4b
);

5082 i‡(
îr
)

5083 
îr‹_ªtu∫
;

5090 
	`pxt4_lock_group
(
sb
, 
block_group
);

5091 
	`mb_˛ór_bôs
(
bôm≠_bh
->
b_d©a
, 
bô
, 
˛u°î_cou¡
);

5092 
	`mb_‰ì_blocks
(
NULL
, &
e4b
, 
bô
, 
˛u°î_cou¡
);

5093 
‰ì_˛u°îs_cou¡
 = 
˛u°îs_‰ìd
 +

5094 
	`pxt4_‰ì_group_˛u°îs
(
sb
, 
desc
);

5095 
	`pxt4_‰ì_group_˛u°îs_£t
(
sb
, 
desc
, 
‰ì_˛u°îs_cou¡
);

5096 
	`pxt4_block_bôm≠_csum_£t
(
sb
, 
block_group
, 
desc
, 
bôm≠_bh
);

5097 
	`pxt4_group_desc_csum_£t
(
sb
, 
block_group
, 
desc
);

5098 
	`pxt4_u∆ock_group
(
sb
, 
block_group
);

5099 
	`≥r˝u_cou¡î_add
(&
sbi
->
s_‰ì˛u°îs_cou¡î
,

5100 
˛u°îs_‰ìd
);

5102 i‡(
sbi
->
s_log_groups_≥r_Êex
) {

5103 
pxt4_group_t
 
Êex_group
 = 
	`pxt4_Êex_group
(
sbi
, 
block_group
);

5104 
	`©omic64_add
(
˛u°îs_‰ìd
,

5105 &
	`sbi_¨øy_rcu_dîef
(
sbi
, 
s_Êex_groups
,

5106 
Êex_group
)->
‰ì_˛u°îs
);

5109 
	`pxt4_mb_u∆ﬂd_buddy
(&
e4b
);

5112 
	`BUFFER_TRACE
(
bôm≠_bh
, "dirtied bitmap block");

5113 
îr
 = 
	`pxt4_h™dÀ_dúty_mëad©a
(
h™dÀ
, 
NULL
, 
bôm≠_bh
);

5116 
	`BUFFER_TRACE
(
gd_bh
, "dirtied group descriptor block");

5117 
ªt
 = 
	`pxt4_h™dÀ_dúty_mëad©a
(
h™dÀ
, 
NULL
, 
gd_bh
);

5118 i‡(!
îr
)

5119 
îr
 = 
ªt
;

5121 
îr‹_ªtu∫
:

5122 
	`bªl£
(
bôm≠_bh
);

5123 
	`pxt4_°d_îr‹
(
sb
, 
îr
);

5124  
îr
;

5125 
	}
}

5139 
	$pxt4_åim_exã¡
(
su≥r_block
 *
sb
, 
°¨t
, 
cou¡
,

5140 
pxt4_group_t
 
group
, 
pxt4_buddy
 *
e4b
)

5141 
	$__ªÀa£s
(
bôlock
)

5142 
	$__acquúes
(
bôlock
)

5144 
pxt4_‰ì_exã¡
 
ex
;

5145 
ªt
 = 0;

5147 
	`åa˚_pxt4_åim_exã¡
(
sb
, 
group
, 
°¨t
, 
cou¡
);

5149 
	`as£π_•ö_locked
(
	`pxt4_group_lock_±r
(
sb
, 
group
));

5151 
ex
.
„_°¨t
 = 
°¨t
;

5152 
ex
.
„_group
 = 
group
;

5153 
ex
.
„_Àn
 = 
cou¡
;

5159 
	`mb_m¨k_u£d
(
e4b
, &
ex
);

5160 
	`pxt4_u∆ock_group
(
sb
, 
group
);

5161 
ªt
 = 
	`pxt4_issue_disˇrd
(
sb
, 
group
, 
°¨t
, 
cou¡
, 
NULL
);

5162 
	`pxt4_lock_group
(
sb
, 
group
);

5163 
	`mb_‰ì_blocks
(
NULL
, 
e4b
, 
°¨t
, 
ex
.
„_Àn
);

5164  
ªt
;

5165 
	}
}

5185 
pxt4_gΩblk_t


5186 
	$pxt4_åim_Æl_‰ì
(
su≥r_block
 *
sb
, 
pxt4_group_t
 
group
,

5187 
pxt4_gΩblk_t
 
°¨t
,Öxt4_gΩblk_à
max
,

5188 
pxt4_gΩblk_t
 
möblocks
)

5190 *
bôm≠
;

5191 
pxt4_gΩblk_t
 
√xt
, 
cou¡
 = 0, 
‰ì_cou¡
 = 0;

5192 
pxt4_buddy
 
e4b
;

5193 
ªt
 = 0;

5195 
	`åa˚_pxt4_åim_Æl_‰ì
(
sb
, 
group
, 
°¨t
, 
max
);

5197 
ªt
 = 
	`pxt4_mb_lﬂd_buddy
(
sb
, 
group
, &
e4b
);

5198 i‡(
ªt
) {

5199 
	`pxt4_w¨nög
(
sb
, "Error %dÜoading buddy information for %u",

5200 
ªt
, 
group
);

5201  
ªt
;

5203 
bôm≠
 = 
e4b
.
bd_bôm≠
;

5205 
	`pxt4_lock_group
(
sb
, 
group
);

5206 i‡(
	`PXT4_MB_GRP_WAS_TRIMMED
(
e4b
.
bd_öfo
) &&

5207 
möblocks
 >
	`©omic_ªad
(&
	`PXT4_SB
(
sb
)->
s_œ°_åim_möblks
))

5208 
out
;

5210 
°¨t
 = (
e4b
.
bd_öfo
->
bb_fú°_‰ì
 > start) ?

5211 
e4b
.
bd_öfo
->
bb_fú°_‰ì
 : 
°¨t
;

5213 
°¨t
 <
max
) {

5214 
°¨t
 = 
	`mb_föd_√xt_zîo_bô
(
bôm≠
, 
max
 + 1, start);

5215 i‡(
°¨t
 > 
max
)

5217 
√xt
 = 
	`mb_föd_√xt_bô
(
bôm≠
, 
max
 + 1, 
°¨t
);

5219 i‡((
√xt
 - 
°¨t
Ë>
möblocks
) {

5220 
ªt
 = 
	`pxt4_åim_exã¡
(
sb
, 
°¨t
,

5221 
√xt
 - 
°¨t
, 
group
, &
e4b
);

5222 i‡(
ªt
 &&Ñë !-
EOPNOTSUPP
)

5224 
ªt
 = 0;

5225 
cou¡
 +
√xt
 - 
°¨t
;

5227 
‰ì_cou¡
 +
√xt
 - 
°¨t
;

5228 
°¨t
 = 
√xt
 + 1;

5230 i‡(
	`Áèl_sig«l_≥ndög
(
cuºít
)) {

5231 
cou¡
 = -
ERESTARTSYS
;

5235 i‡(
	`√ed_ªsched
()) {

5236 
	`pxt4_u∆ock_group
(
sb
, 
group
);

5237 
	`c⁄d_ªsched
();

5238 
	`pxt4_lock_group
(
sb
, 
group
);

5241 i‡((
e4b
.
bd_öfo
->
bb_‰ì
 - 
‰ì_cou¡
Ë< 
möblocks
)

5245 i‡(!
ªt
) {

5246 
ªt
 = 
cou¡
;

5247 
	`PXT4_MB_GRP_SET_TRIMMED
(
e4b
.
bd_öfo
);

5249 
out
:

5250 
	`pxt4_u∆ock_group
(
sb
, 
group
);

5251 
	`pxt4_mb_u∆ﬂd_buddy
(&
e4b
);

5253 
	`pxt4_debug
("trimmed %d blocks inÅhe group %d\n",

5254 
cou¡
, 
group
);

5256  
ªt
;

5257 
	}
}

5271 
	$pxt4_åim_fs
(
su≥r_block
 *
sb
, 
f°rim_ønge
 *
ønge
)

5273 
pxt4_group_öfo
 *
gΩ
;

5274 
pxt4_group_t
 
group
, 
fú°_group
, 
œ°_group
;

5275 
pxt4_gΩblk_t
 
˙t
 = 0, 
fú°_˛u°î
, 
œ°_˛u°î
;

5276 
uöt64_t
 
°¨t
, 
íd
, 
möÀn
, 
åimmed
 = 0;

5277 
pxt4_fsblk_t
 
fú°_d©a_blk
 =

5278 
	`À32_to_˝u
(
	`PXT4_SB
(
sb
)->
s_es
->
s_fú°_d©a_block
);

5279 
pxt4_fsblk_t
 
max_blks
 = 
	`pxt4_blocks_cou¡
(
	`PXT4_SB
(
sb
)->
s_es
);

5280 
ªt
 = 0;

5282 
°¨t
 = 
ønge
->°¨à>> 
sb
->
s_blocksize_bôs
;

5283 
íd
 = 
°¨t
 + (
ønge
->
Àn
 >> 
sb
->
s_blocksize_bôs
) - 1;

5284 
möÀn
 = 
	`PXT4_NUM_B2C
(
	`PXT4_SB
(
sb
),

5285 
ønge
->
möÀn
 >> 
sb
->
s_blocksize_bôs
);

5287 i‡(
möÀn
 > 
	`PXT4_CLUSTERS_PER_GROUP
(
sb
) ||

5288 
°¨t
 >
max_blks
 ||

5289 
ønge
->
Àn
 < 
sb
->
s_blocksize
)

5290  -
EINVAL
;

5291 i‡(
íd
 >
max_blks
)

5292 
íd
 = 
max_blks
 - 1;

5293 i‡(
íd
 <
fú°_d©a_blk
)

5294 
out
;

5295 i‡(
°¨t
 < 
fú°_d©a_blk
)

5296 
°¨t
 = 
fú°_d©a_blk
;

5299 
	`pxt4_gë_group_no_™d_off£t
(
sb
, (
pxt4_fsblk_t
Ë
°¨t
,

5300 &
fú°_group
, &
fú°_˛u°î
);

5301 
	`pxt4_gë_group_no_™d_off£t
(
sb
, (
pxt4_fsblk_t
Ë
íd
,

5302 &
œ°_group
, &
œ°_˛u°î
);

5305 
íd
 = 
	`PXT4_CLUSTERS_PER_GROUP
(
sb
) - 1;

5307 
group
 = 
fú°_group
; grou∞<
œ°_group
; group++) {

5308 
gΩ
 = 
	`pxt4_gë_group_öfo
(
sb
, 
group
);

5310 i‡(
	`u∆ikñy
(
	`PXT4_MB_GRP_NEED_INIT
(
gΩ
))) {

5311 
ªt
 = 
	`pxt4_mb_öô_group
(
sb
, 
group
, 
GFP_NOFS
);

5312 i‡(
ªt
)

5322 i‡(
group
 =
œ°_group
)

5323 
íd
 = 
œ°_˛u°î
;

5325 i‡(
gΩ
->
bb_‰ì
 >
möÀn
) {

5326 
˙t
 = 
	`pxt4_åim_Æl_‰ì
(
sb
, 
group
, 
fú°_˛u°î
,

5327 
íd
, 
möÀn
);

5328 i‡(
˙t
 < 0) {

5329 
ªt
 = 
˙t
;

5332 
åimmed
 +
˙t
;

5339 
fú°_˛u°î
 = 0;

5342 i‡(!
ªt
)

5343 
	`©omic_£t
(&
	`PXT4_SB
(
sb
)->
s_œ°_åim_möblks
, 
möÀn
);

5345 
out
:

5346 
ønge
->
Àn
 = 
	`PXT4_C2B
(
	`PXT4_SB
(
sb
), 
åimmed
Ë<< sb->
s_blocksize_bôs
;

5347  
ªt
;

5348 
	}
}

5352 
	$pxt4_mbÆloc_quîy_ønge
(

5353 
su≥r_block
 *
sb
,

5354 
pxt4_group_t
 
group
,

5355 
pxt4_gΩblk_t
 
°¨t
,

5356 
pxt4_gΩblk_t
 
íd
,

5357 
pxt4_mbÆloc_quîy_ønge_‚
 
f‹m©ãr
,

5358 *
¥iv
)

5360 *
bôm≠
;

5361 
pxt4_gΩblk_t
 
√xt
;

5362 
pxt4_buddy
 
e4b
;

5363 
îr‹
;

5365 
îr‹
 = 
	`pxt4_mb_lﬂd_buddy
(
sb
, 
group
, &
e4b
);

5366 i‡(
îr‹
)

5367  
îr‹
;

5368 
bôm≠
 = 
e4b
.
bd_bôm≠
;

5370 
	`pxt4_lock_group
(
sb
, 
group
);

5372 
°¨t
 = (
e4b
.
bd_öfo
->
bb_fú°_‰ì
 > start) ?

5373 
e4b
.
bd_öfo
->
bb_fú°_‰ì
 : 
°¨t
;

5374 i‡(
íd
 >
	`PXT4_CLUSTERS_PER_GROUP
(
sb
))

5375 
íd
 = 
	`PXT4_CLUSTERS_PER_GROUP
(
sb
) - 1;

5377 
°¨t
 <
íd
) {

5378 
°¨t
 = 
	`mb_föd_√xt_zîo_bô
(
bôm≠
, 
íd
 + 1, start);

5379 i‡(
°¨t
 > 
íd
)

5381 
√xt
 = 
	`mb_föd_√xt_bô
(
bôm≠
, 
íd
 + 1, 
°¨t
);

5383 
	`pxt4_u∆ock_group
(
sb
, 
group
);

5384 
îr‹
 = 
	`f‹m©ãr
(
sb
, 
group
, 
°¨t
, 
√xt
 - sèπ, 
¥iv
);

5385 i‡(
îr‹
)

5386 
out_u∆ﬂd
;

5387 
	`pxt4_lock_group
(
sb
, 
group
);

5389 
°¨t
 = 
√xt
 + 1;

5392 
	`pxt4_u∆ock_group
(
sb
, 
group
);

5393 
out_u∆ﬂd
:

5394 
	`pxt4_mb_u∆ﬂd_buddy
(&
e4b
);

5396  
îr‹
;

5397 
	}
}

	@mballoc.h

8 #i‚de‡
_PXT4_MBALLOC_H


9 
	#_PXT4_MBALLOC_H


	)

11 
	~<löux/time.h
>

12 
	~<löux/fs.h
>

13 
	~<löux/«mei.h
>

14 
	~<löux/quŸa›s.h
>

15 
	~<löux/buf„r_hód.h
>

16 
	~<löux/moduÀ.h
>

17 
	~<löux/sw≠.h
>

18 
	~<löux/¥oc_fs.h
>

19 
	~<löux/∑gem≠.h
>

20 
	~<löux/£q_fûe.h
>

21 
	~<löux/blkdev.h
>

22 
	~<löux/muãx.h
>

23 
	~"pxt4_jbd3.h
"

24 
	~"pxt4.h
"

28 #ifde‡
CONFIG_PXT4_DEBUG


29 
ush‹t
 
pxt4_mbÆloc_debug
;

31 
	#mb_debug
(
n
, 
fmt
, ...) \

33 i‡((
n
Ë<
pxt4_mbÆloc_debug
) { \

34 
	`¥ötk
(
KERN_DEBUG
 "(%s, %d): %s: " 
fmt
, \

35 
__FILE__
, 
__LINE__
, 
__func__
, ##
__VA_ARGS__
); \

37 } 0)

	)

39 
	#mb_debug
(
n
, 
fmt
, ...Ë
	`no_¥ötk
(fmt, ##
__VA_ARGS__
)

	)

42 
	#PXT4_MB_HISTORY_ALLOC
 1

	)

43 
	#PXT4_MB_HISTORY_PREALLOC
 2

	)

48 
	#MB_DEFAULT_MAX_TO_SCAN
 200

	)

53 
	#MB_DEFAULT_MIN_TO_SCAN
 10

	)

59 
	#MB_DEFAULT_STATS
 0

	)

68 
	#MB_DEFAULT_STREAM_THRESHOLD
 16

	)

73 
	#MB_DEFAULT_ORDER2_REQS
 2

	)

78 
	#MB_DEFAULT_GROUP_PREALLOC
 512

	)

81 
	spxt4_‰ì_d©a
 {

83 
li°_hód
 
	mefd_li°
;

86 
rb_node
 
	mefd_node
;

89 
pxt4_group_t
 
	mefd_group
;

92 
pxt4_gΩblk_t
 
	mefd_°¨t_˛u°î
;

93 
pxt4_gΩblk_t
 
	mefd_cou¡
;

96 
tid_t
 
	mefd_tid
;

99 
	spxt4_¥óŒoc_•a˚
 {

100 
li°_hód
 
	m∑_öode_li°
;

101 
li°_hód
 
	m∑_group_li°
;

103 
li°_hód
 
	m∑_tmp_li°
;

104 
rcu_hód
 
	m∑_rcu
;

105 } 
	mu
;

106 
•ölock_t
 
	m∑_lock
;

107 
©omic_t
 
	m∑_cou¡
;

108 
	m∑_dñëed
;

109 
pxt4_fsblk_t
 
	m∑_p°¨t
;

110 
pxt4_lblk_t
 
	m∑_l°¨t
;

111 
pxt4_gΩblk_t
 
	m∑_Àn
;

112 
pxt4_gΩblk_t
 
	m∑_‰ì
;

113 
	m∑_ty≥
;

114 
•ölock_t
 *
	m∑_obj_lock
;

115 
öode
 *
	m∑_öode
;

119 
	mMB_INODE_PA
 = 0,

120 
	mMB_GROUP_PA
 = 1

123 
	spxt4_‰ì_exã¡
 {

124 
pxt4_lblk_t
 
	m„_logiˇl
;

125 
pxt4_gΩblk_t
 
	m„_°¨t
;

126 
pxt4_group_t
 
	m„_group
;

127 
pxt4_gΩblk_t
 
	m„_Àn
;

138 
	#PREALLOC_TB_SIZE
 10

	)

139 
	spxt4_loˇlôy_group
 {

142 
muãx
 
	mlg_muãx
;

144 
li°_hód
 
	mlg_¥óŒoc_li°
[
PREALLOC_TB_SIZE
];

145 
•ölock_t
 
	mlg_¥óŒoc_lock
;

148 
	spxt4_Æloˇti⁄_c⁄ãxt
 {

149 
öode
 *
	mac_öode
;

150 
su≥r_block
 *
	mac_sb
;

153 
pxt4_‰ì_exã¡
 
	mac_o_ex
;

156 
pxt4_‰ì_exã¡
 
	mac_g_ex
;

159 
pxt4_‰ì_exã¡
 
	mac_b_ex
;

162 
pxt4_‰ì_exã¡
 
	mac_f_ex
;

164 
__u16
 
	mac_groups_sˇ¬ed
;

165 
__u16
 
	mac_found
;

166 
__u16
 
	mac_èû
;

167 
__u16
 
	mac_buddy
;

168 
__u16
 
	mac_Êags
;

169 
__u8
 
	mac_°©us
;

170 
__u8
 
	mac_¸ôîü
;

171 
__u8
 
	mac_2‹dî
;

173 
__u8
 
	mac_›
;

174 
∑ge
 *
	mac_bôm≠_∑ge
;

175 
∑ge
 *
	mac_buddy_∑ge
;

176 
pxt4_¥óŒoc_•a˚
 *
	mac_∑
;

177 
pxt4_loˇlôy_group
 *
	mac_lg
;

180 
	#AC_STATUS_CONTINUE
 1

	)

181 
	#AC_STATUS_FOUND
 2

	)

182 
	#AC_STATUS_BREAK
 3

	)

184 
	spxt4_buddy
 {

185 
∑ge
 *
	mbd_buddy_∑ge
;

186 *
	mbd_buddy
;

187 
∑ge
 *
	mbd_bôm≠_∑ge
;

188 *
	mbd_bôm≠
;

189 
pxt4_group_öfo
 *
	mbd_öfo
;

190 
su≥r_block
 *
	mbd_sb
;

191 
__u16
 
	mbd_blkbôs
;

192 
pxt4_group_t
 
	mbd_group
;

195 
ölöe
 
pxt4_fsblk_t
 
	$pxt4_gΩ_offs_to_block
(
su≥r_block
 *
sb
,

196 
pxt4_‰ì_exã¡
 *
„x
)

198  
	`pxt4_group_fú°_block_no
(
sb
, 
„x
->
„_group
) +

199 (
„x
->
„_°¨t
 << 
	`PXT4_SB
(
sb
)->
s_˛u°î_bôs
);

200 
	}
}

202 (*
	tpxt4_mbÆloc_quîy_ønge_‚
)(

203 
	tsu≥r_block
 *
	tsb
,

204 
	tpxt4_group_t
 
	tagno
,

205 
	tpxt4_gΩblk_t
 
	t°¨t
,

206 
	tpxt4_gΩblk_t
 
	tÀn
,

207 *
	t¥iv
);

210 
	`pxt4_mbÆloc_quîy_ønge
(

211 
su≥r_block
 *
sb
,

212 
pxt4_group_t
 
agno
,

213 
pxt4_gΩblk_t
 
°¨t
,

214 
pxt4_gΩblk_t
 
íd
,

215 
pxt4_mbÆloc_quîy_ønge_‚
 
f‹m©ãr
,

216 *
¥iv
);

	@migrate.c

8 
	~<löux/¶ab.h
>

9 
	~"pxt4_jbd3.h
"

10 
	~"pxt4_exã¡s.h
"

16 
	smigøã_°ru˘
 {

17 
pxt4_lblk_t
 
	mfú°_block
, 
	mœ°_block
, 
	mcuº_block
;

18 
pxt4_fsblk_t
 
	mfú°_pblock
, 
	mœ°_pblock
;

21 
	$föish_ønge
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *inode,

22 
migøã_°ru˘
 *
lb
)

25 
ªtvÆ
 = 0, 
√eded
;

26 
pxt4_exã¡
 
√wext
;

27 
pxt4_ext_∑th
 *
∑th
;

28 i‡(
lb
->
fú°_pblock
 == 0)

32 
√wext
.
ì_block
 = 
	`˝u_to_À32
(
lb
->
fú°_block
);

33 
√wext
.
ì_Àn
 = 
	`˝u_to_À16
(
lb
->
œ°_block
 -Üb->
fú°_block
 + 1);

34 
	`pxt4_ext_°‹e_pblock
(&
√wext
, 
lb
->
fú°_pblock
);

36 
	`down_wrôe
(&
	`PXT4_I
(
öode
)->
i_d©a_£m
);

37 
∑th
 = 
	`pxt4_föd_exã¡
(
öode
, 
lb
->
fú°_block
, 
NULL
, 0);

38 i‡(
	`IS_ERR
(
∑th
)) {

39 
ªtvÆ
 = 
	`PTR_ERR
(
∑th
);

40 
∑th
 = 
NULL
;

41 
îr_out
;

50 
√eded
 = 
	`pxt4_ext_ˇlc_¸edôs_f‹_sögÀ_exã¡
(
öode
,

51 
lb
->
œ°_block
 -Üb->
fú°_block
 + 1, 
∑th
);

56 i‡(
√eded
 && 
	`pxt4_h™dÀ_has_íough_¸edôs
(
h™dÀ
,

57 
PXT4_RESERVE_TRANS_BLOCKS
)) {

58 
	`up_wrôe
((&
	`PXT4_I
(
öode
)->
i_d©a_£m
));

59 
ªtvÆ
 = 
	`pxt4_jou∫Æ_ª°¨t
(
h™dÀ
, 
√eded
);

60 
	`down_wrôe
((&
	`PXT4_I
(
öode
)->
i_d©a_£m
));

61 i‡(
ªtvÆ
)

62 
îr_out
;

63 } i‡(
√eded
) {

64 
ªtvÆ
 = 
	`pxt4_jou∫Æ_exãnd
(
h™dÀ
, 
√eded
);

65 i‡(
ªtvÆ
) {

69 
	`up_wrôe
((&
	`PXT4_I
(
öode
)->
i_d©a_£m
));

70 
ªtvÆ
 = 
	`pxt4_jou∫Æ_ª°¨t
(
h™dÀ
, 
√eded
);

71 
	`down_wrôe
((&
	`PXT4_I
(
öode
)->
i_d©a_£m
));

72 i‡(
ªtvÆ
)

73 
îr_out
;

76 
ªtvÆ
 = 
	`pxt4_ext_ö£π_exã¡
(
h™dÀ
, 
öode
, &
∑th
, &
√wext
, 0);

77 
îr_out
:

78 
	`up_wrôe
((&
	`PXT4_I
(
öode
)->
i_d©a_£m
));

79 
	`pxt4_ext_dr›_ªfs
(
∑th
);

80 
	`k‰ì
(
∑th
);

81 
lb
->
fú°_pblock
 = 0;

82  
ªtvÆ
;

83 
	}
}

85 
	$upd©e_exã¡_ønge
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *inode,

86 
pxt4_fsblk_t
 
pblock
, 
migøã_°ru˘
 *
lb
)

88 
ªtvÆ
;

92 i‡(
lb
->
fú°_pblock
 &&

93 (
lb
->
œ°_pblock
+1 =
pblock
) &&

94 (
lb
->
œ°_block
+1 =lb->
cuº_block
)) {

95 
lb
->
œ°_pblock
 = 
pblock
;

96 
lb
->
œ°_block
 =Üb->
cuº_block
;

97 
lb
->
cuº_block
++;

103 
ªtvÆ
 = 
	`föish_ønge
(
h™dÀ
, 
öode
, 
lb
);

104 
lb
->
fú°_pblock
 =Üb->
œ°_pblock
 = 
pblock
;

105 
lb
->
fú°_block
 =Üb->
œ°_block
 =Üb->
cuº_block
;

106 
lb
->
cuº_block
++;

107  
ªtvÆ
;

108 
	}
}

110 
	$upd©e_öd_exã¡_ønge
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *inode,

111 
pxt4_fsblk_t
 
pblock
,

112 
migøã_°ru˘
 *
lb
)

114 
buf„r_hód
 *
bh
;

115 
__À32
 *
i_d©a
;

116 
i
, 
ªtvÆ
 = 0;

117 
max_íåõs
 = 
öode
->
i_sb
->
s_blocksize
 >> 2;

119 
bh
 = 
	`pxt4_sb_bªad
(
öode
->
i_sb
, 
pblock
, 0);

120 i‡(
	`IS_ERR
(
bh
))

121  
	`PTR_ERR
(
bh
);

123 
i_d©a
 = (
__À32
 *)
bh
->
b_d©a
;

124 
i
 = 0; i < 
max_íåõs
; i++) {

125 i‡(
i_d©a
[
i
]) {

126 
ªtvÆ
 = 
	`upd©e_exã¡_ønge
(
h™dÀ
, 
öode
,

127 
	`À32_to_˝u
(
i_d©a
[
i
]), 
lb
);

128 i‡(
ªtvÆ
)

131 
lb
->
cuº_block
++;

134 
	`put_bh
(
bh
);

135  
ªtvÆ
;

137 
	}
}

139 
	$upd©e_död_exã¡_ønge
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *inode,

140 
pxt4_fsblk_t
 
pblock
,

141 
migøã_°ru˘
 *
lb
)

143 
buf„r_hód
 *
bh
;

144 
__À32
 *
i_d©a
;

145 
i
, 
ªtvÆ
 = 0;

146 
max_íåõs
 = 
öode
->
i_sb
->
s_blocksize
 >> 2;

148 
bh
 = 
	`pxt4_sb_bªad
(
öode
->
i_sb
, 
pblock
, 0);

149 i‡(
	`IS_ERR
(
bh
))

150  
	`PTR_ERR
(
bh
);

152 
i_d©a
 = (
__À32
 *)
bh
->
b_d©a
;

153 
i
 = 0; i < 
max_íåõs
; i++) {

154 i‡(
i_d©a
[
i
]) {

155 
ªtvÆ
 = 
	`upd©e_öd_exã¡_ønge
(
h™dÀ
, 
öode
,

156 
	`À32_to_˝u
(
i_d©a
[
i
]), 
lb
);

157 i‡(
ªtvÆ
)

161 
lb
->
cuº_block
 +
max_íåõs
;

164 
	`put_bh
(
bh
);

165  
ªtvÆ
;

167 
	}
}

169 
	$upd©e_töd_exã¡_ønge
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *inode,

170 
pxt4_fsblk_t
 
pblock
,

171 
migøã_°ru˘
 *
lb
)

173 
buf„r_hód
 *
bh
;

174 
__À32
 *
i_d©a
;

175 
i
, 
ªtvÆ
 = 0;

176 
max_íåõs
 = 
öode
->
i_sb
->
s_blocksize
 >> 2;

178 
bh
 = 
	`pxt4_sb_bªad
(
öode
->
i_sb
, 
pblock
, 0);

179 i‡(
	`IS_ERR
(
bh
))

180  
	`PTR_ERR
(
bh
);

182 
i_d©a
 = (
__À32
 *)
bh
->
b_d©a
;

183 
i
 = 0; i < 
max_íåõs
; i++) {

184 i‡(
i_d©a
[
i
]) {

185 
ªtvÆ
 = 
	`upd©e_död_exã¡_ønge
(
h™dÀ
, 
öode
,

186 
	`À32_to_˝u
(
i_d©a
[
i
]), 
lb
);

187 i‡(
ªtvÆ
)

191 
lb
->
cuº_block
 +
max_íåõs
 * max_entries;

194 
	`put_bh
(
bh
);

195  
ªtvÆ
;

197 
	}
}

199 
	$exãnd_¸edô_f‹_blkdñ
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *inode)

201 
ªtvÆ
 = 0, 
√eded
;

203 i‡(
	`pxt4_h™dÀ_has_íough_¸edôs
(
h™dÀ
, 
PXT4_RESERVE_TRANS_BLOCKS
+1))

211 
√eded
 = 3 + 
	`PXT4_MAXQUOTAS_TRANS_BLOCKS
(
öode
->
i_sb
);

213 i‡(
	`pxt4_jou∫Æ_exãnd
(
h™dÀ
, 
√eded
) != 0)

214 
ªtvÆ
 = 
	`pxt4_jou∫Æ_ª°¨t
(
h™dÀ
, 
√eded
);

216  
ªtvÆ
;

217 
	}
}

219 
	$‰ì_död_blocks
(
h™dÀ_t
 *
h™dÀ
,

220 
öode
 *öode, 
__À32
 
i_d©a
)

222 
i
;

223 
__À32
 *
tmp_id©a
;

224 
buf„r_hód
 *
bh
;

225 
max_íåõs
 = 
öode
->
i_sb
->
s_blocksize
 >> 2;

227 
bh
 = 
	`pxt4_sb_bªad
(
öode
->
i_sb
, 
	`À32_to_˝u
(
i_d©a
), 0);

228 i‡(
	`IS_ERR
(
bh
))

229  
	`PTR_ERR
(
bh
);

231 
tmp_id©a
 = (
__À32
 *)
bh
->
b_d©a
;

232 
i
 = 0; i < 
max_íåõs
; i++) {

233 i‡(
tmp_id©a
[
i
]) {

234 
	`exãnd_¸edô_f‹_blkdñ
(
h™dÀ
, 
öode
);

235 
	`pxt4_‰ì_blocks
(
h™dÀ
, 
öode
, 
NULL
,

236 
	`À32_to_˝u
(
tmp_id©a
[
i
]), 1,

237 
PXT4_FREE_BLOCKS_METADATA
 |

238 
PXT4_FREE_BLOCKS_FORGET
);

241 
	`put_bh
(
bh
);

242 
	`exãnd_¸edô_f‹_blkdñ
(
h™dÀ
, 
öode
);

243 
	`pxt4_‰ì_blocks
(
h™dÀ
, 
öode
, 
NULL
, 
	`À32_to_˝u
(
i_d©a
), 1,

244 
PXT4_FREE_BLOCKS_METADATA
 |

245 
PXT4_FREE_BLOCKS_FORGET
);

247 
	}
}

249 
	$‰ì_töd_blocks
(
h™dÀ_t
 *
h™dÀ
,

250 
öode
 *öode, 
__À32
 
i_d©a
)

252 
i
, 
ªtvÆ
 = 0;

253 
__À32
 *
tmp_id©a
;

254 
buf„r_hód
 *
bh
;

255 
max_íåõs
 = 
öode
->
i_sb
->
s_blocksize
 >> 2;

257 
bh
 = 
	`pxt4_sb_bªad
(
öode
->
i_sb
, 
	`À32_to_˝u
(
i_d©a
), 0);

258 i‡(
	`IS_ERR
(
bh
))

259  
	`PTR_ERR
(
bh
);

261 
tmp_id©a
 = (
__À32
 *)
bh
->
b_d©a
;

262 
i
 = 0; i < 
max_íåõs
; i++) {

263 i‡(
tmp_id©a
[
i
]) {

264 
ªtvÆ
 = 
	`‰ì_död_blocks
(
h™dÀ
,

265 
öode
, 
tmp_id©a
[
i
]);

266 i‡(
ªtvÆ
) {

267 
	`put_bh
(
bh
);

268  
ªtvÆ
;

272 
	`put_bh
(
bh
);

273 
	`exãnd_¸edô_f‹_blkdñ
(
h™dÀ
, 
öode
);

274 
	`pxt4_‰ì_blocks
(
h™dÀ
, 
öode
, 
NULL
, 
	`À32_to_˝u
(
i_d©a
), 1,

275 
PXT4_FREE_BLOCKS_METADATA
 |

276 
PXT4_FREE_BLOCKS_FORGET
);

278 
	}
}

280 
	$‰ì_öd_block
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *öode, 
__À32
 *
i_d©a
)

282 
ªtvÆ
;

285 i‡(
i_d©a
[0]) {

286 
	`exãnd_¸edô_f‹_blkdñ
(
h™dÀ
, 
öode
);

287 
	`pxt4_‰ì_blocks
(
h™dÀ
, 
öode
, 
NULL
,

288 
	`À32_to_˝u
(
i_d©a
[0]), 1,

289 
PXT4_FREE_BLOCKS_METADATA
 |

290 
PXT4_FREE_BLOCKS_FORGET
);

294 i‡(
i_d©a
[1]) {

295 
ªtvÆ
 = 
	`‰ì_död_blocks
(
h™dÀ
, 
öode
, 
i_d©a
[1]);

296 i‡(
ªtvÆ
)

297  
ªtvÆ
;

301 i‡(
i_d©a
[2]) {

302 
ªtvÆ
 = 
	`‰ì_töd_blocks
(
h™dÀ
, 
öode
, 
i_d©a
[2]);

303 i‡(
ªtvÆ
)

304  
ªtvÆ
;

307 
	}
}

309 
	$pxt4_ext_sw≠_öode_d©a
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *inode,

310 
öode
 *
tmp_öode
)

312 
ªtvÆ
;

313 
__À32
 
i_d©a
[3];

314 
pxt4_öode_öfo
 *
ei
 = 
	`PXT4_I
(
öode
);

315 
pxt4_öode_öfo
 *
tmp_ei
 = 
	`PXT4_I
(
tmp_öode
);

321 
ªtvÆ
 = 
	`pxt4_jou∫Æ_exãnd
(
h™dÀ
, 1);

322 i‡(
ªtvÆ
) {

323 
ªtvÆ
 = 
	`pxt4_jou∫Æ_ª°¨t
(
h™dÀ
, 1);

324 i‡(
ªtvÆ
)

325 
îr_out
;

328 
i_d©a
[0] = 
ei
->i_d©a[
PXT4_IND_BLOCK
];

329 
i_d©a
[1] = 
ei
->i_d©a[
PXT4_DIND_BLOCK
];

330 
i_d©a
[2] = 
ei
->i_d©a[
PXT4_TIND_BLOCK
];

332 
	`down_wrôe
(&
	`PXT4_I
(
öode
)->
i_d©a_£m
);

338 i‡(!
	`pxt4_ã°_öode_°©e
(
öode
, 
PXT4_STATE_EXT_MIGRATE
)) {

339 
ªtvÆ
 = -
EAGAIN
;

340 
	`up_wrôe
(&
	`PXT4_I
(
öode
)->
i_d©a_£m
);

341 
îr_out
;

343 
	`pxt4_˛ór_öode_°©e
(
öode
, 
PXT4_STATE_EXT_MIGRATE
);

348 
	`pxt4_£t_öode_Êag
(
öode
, 
PXT4_INODE_EXTENTS
);

349 
	`mem˝y
(
ei
->
i_d©a
, 
tmp_ei
->i_data, (ei->i_data));

360 
	`•ö_lock
(&
öode
->
i_lock
);

361 
öode
->
i_blocks
 +
tmp_öode
->i_blocks;

362 
	`•ö_u∆ock
(&
öode
->
i_lock
);

363 
	`up_wrôe
(&
	`PXT4_I
(
öode
)->
i_d©a_£m
);

369 
ªtvÆ
 = 
	`‰ì_öd_block
(
h™dÀ
, 
öode
, 
i_d©a
);

370 
	`pxt4_m¨k_öode_dúty
(
h™dÀ
, 
öode
);

372 
îr_out
:

373  
ªtvÆ
;

374 
	}
}

376 
	$‰ì_ext_idx
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *inode,

377 
pxt4_exã¡_idx
 *
ix
)

379 
i
, 
ªtvÆ
 = 0;

380 
pxt4_fsblk_t
 
block
;

381 
buf„r_hód
 *
bh
;

382 
pxt4_exã¡_hódî
 *
eh
;

384 
block
 = 
	`pxt4_idx_pblock
(
ix
);

385 
bh
 = 
	`pxt4_sb_bªad
(
öode
->
i_sb
, 
block
, 0);

386 i‡(
	`IS_ERR
(
bh
))

387  
	`PTR_ERR
(
bh
);

389 
eh
 = (
pxt4_exã¡_hódî
 *)
bh
->
b_d©a
;

390 i‡(
eh
->
eh_dïth
 != 0) {

391 
ix
 = 
	`EXT_FIRST_INDEX
(
eh
);

392 
i
 = 0; i < 
	`À16_to_˝u
(
eh
->
eh_íåõs
); i++, 
ix
++) {

393 
ªtvÆ
 = 
	`‰ì_ext_idx
(
h™dÀ
, 
öode
, 
ix
);

394 i‡(
ªtvÆ
)

398 
	`put_bh
(
bh
);

399 
	`exãnd_¸edô_f‹_blkdñ
(
h™dÀ
, 
öode
);

400 
	`pxt4_‰ì_blocks
(
h™dÀ
, 
öode
, 
NULL
, 
block
, 1,

401 
PXT4_FREE_BLOCKS_METADATA
 | 
PXT4_FREE_BLOCKS_FORGET
);

402  
ªtvÆ
;

403 
	}
}

408 
	$‰ì_ext_block
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *inode)

410 
i
, 
ªtvÆ
 = 0;

411 
pxt4_öode_öfo
 *
ei
 = 
	`PXT4_I
(
öode
);

412 
pxt4_exã¡_hódî
 *
eh
 = (pxt4_exã¡_hódî *)
ei
->
i_d©a
;

413 
pxt4_exã¡_idx
 *
ix
;

414 i‡(
eh
->
eh_dïth
 == 0)

419 
ix
 = 
	`EXT_FIRST_INDEX
(
eh
);

420 
i
 = 0; i < 
	`À16_to_˝u
(
eh
->
eh_íåõs
); i++, 
ix
++) {

421 
ªtvÆ
 = 
	`‰ì_ext_idx
(
h™dÀ
, 
öode
, 
ix
);

422 i‡(
ªtvÆ
)

423  
ªtvÆ
;

425  
ªtvÆ
;

426 
	}
}

428 
	$pxt4_ext_migøã
(
öode
 *inode)

430 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
öode
->
i_sb
);

431 
h™dÀ_t
 *
h™dÀ
;

432 
ªtvÆ
 = 0, 
i
;

433 
__À32
 *
i_d©a
;

434 
pxt4_öode_öfo
 *
ei
;

435 
öode
 *
tmp_öode
 = 
NULL
;

436 
migøã_°ru˘
 
lb
;

437 
max_íåõs
;

438 
__u32
 
gﬂl
;

439 
uid_t
 
ow√r
[2];

445 i‡(!
	`pxt4_has_„©uª_exã¡s
(
öode
->
i_sb
) ||

446 (
	`pxt4_ã°_öode_Êag
(
öode
, 
PXT4_INODE_EXTENTS
)))

447  -
EINVAL
;

449 i‡(
	`S_ISLNK
(
öode
->
i_mode
Ë&& inode->
i_blocks
 == 0)

453  
ªtvÆ
;

455 
	`≥r˝u_down_wrôe
(&
sbi
->
s_wrôïages_rw£m
);

462 
h™dÀ
 = 
	`pxt4_jou∫Æ_°¨t
(
öode
, 
PXT4_HT_MIGRATE
,

463 4 + 
	`PXT4_MAXQUOTAS_TRANS_BLOCKS
(
öode
->
i_sb
));

465 i‡(
	`IS_ERR
(
h™dÀ
)) {

466 
ªtvÆ
 = 
	`PTR_ERR
(
h™dÀ
);

467 
out_u∆ock
;

469 
gﬂl
 = (((
öode
->
i_öo
 - 1Ë/ 
	`PXT4_INODES_PER_GROUP
(öode->
i_sb
)) *

470 
	`PXT4_INODES_PER_GROUP
(
öode
->
i_sb
)) + 1;

471 
ow√r
[0] = 
	`i_uid_ªad
(
öode
);

472 
ow√r
[1] = 
	`i_gid_ªad
(
öode
);

473 
tmp_öode
 = 
	`pxt4_√w_öode
(
h™dÀ
, 
	`d_öode
(
öode
->
i_sb
->
s_roŸ
),

474 
S_IFREG
, 
NULL
, 
gﬂl
, 
ow√r
, 0);

475 i‡(
	`IS_ERR
(
tmp_öode
)) {

476 
ªtvÆ
 = 
	`PTR_ERR
(
tmp_öode
);

477 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

478 
out_u∆ock
;

480 
	`i_size_wrôe
(
tmp_öode
, 
	`i_size_ªad
(
öode
));

485 
	`˛ór_∆ök
(
tmp_öode
);

487 
	`pxt4_ext_åì_öô
(
h™dÀ
, 
tmp_öode
);

488 
	`pxt4_‹ph™_add
(
h™dÀ
, 
tmp_öode
);

489 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

507 
	`down_ªad
(&
	`PXT4_I
(
öode
)->
i_d©a_£m
);

508 
	`pxt4_£t_öode_°©e
(
öode
, 
PXT4_STATE_EXT_MIGRATE
);

509 
	`up_ªad
((&
	`PXT4_I
(
öode
)->
i_d©a_£m
));

511 
h™dÀ
 = 
	`pxt4_jou∫Æ_°¨t
(
öode
, 
PXT4_HT_MIGRATE
, 1);

512 i‡(
	`IS_ERR
(
h™dÀ
)) {

518 
	`pxt4_‹ph™_dñ
(
NULL
, 
tmp_öode
);

519 
ªtvÆ
 = 
	`PTR_ERR
(
h™dÀ
);

520 
out_tmp_öode
;

523 
ei
 = 
	`PXT4_I
(
öode
);

524 
i_d©a
 = 
ei
->i_data;

525 
	`mem£t
(&
lb
, 0, (lb));

528 
max_íåõs
 = 
öode
->
i_sb
->
s_blocksize
 >> 2;

529 
i
 = 0; i < 
PXT4_NDIR_BLOCKS
; i++) {

530 i‡(
i_d©a
[
i
]) {

531 
ªtvÆ
 = 
	`upd©e_exã¡_ønge
(
h™dÀ
, 
tmp_öode
,

532 
	`À32_to_˝u
(
i_d©a
[
i
]), &
lb
);

533 i‡(
ªtvÆ
)

534 
îr_out
;

536 
lb
.
cuº_block
++;

538 i‡(
i_d©a
[
PXT4_IND_BLOCK
]) {

539 
ªtvÆ
 = 
	`upd©e_öd_exã¡_ønge
(
h™dÀ
, 
tmp_öode
,

540 
	`À32_to_˝u
(
i_d©a
[
PXT4_IND_BLOCK
]), &
lb
);

541 i‡(
ªtvÆ
)

542 
îr_out
;

544 
lb
.
cuº_block
 +
max_íåõs
;

545 i‡(
i_d©a
[
PXT4_DIND_BLOCK
]) {

546 
ªtvÆ
 = 
	`upd©e_död_exã¡_ønge
(
h™dÀ
, 
tmp_öode
,

547 
	`À32_to_˝u
(
i_d©a
[
PXT4_DIND_BLOCK
]), &
lb
);

548 i‡(
ªtvÆ
)

549 
îr_out
;

551 
lb
.
cuº_block
 +
max_íåõs
 * max_entries;

552 i‡(
i_d©a
[
PXT4_TIND_BLOCK
]) {

553 
ªtvÆ
 = 
	`upd©e_töd_exã¡_ønge
(
h™dÀ
, 
tmp_öode
,

554 
	`À32_to_˝u
(
i_d©a
[
PXT4_TIND_BLOCK
]), &
lb
);

555 i‡(
ªtvÆ
)

556 
îr_out
;

561 
ªtvÆ
 = 
	`föish_ønge
(
h™dÀ
, 
tmp_öode
, &
lb
);

562 
îr_out
:

563 i‡(
ªtvÆ
)

568 
	`‰ì_ext_block
(
h™dÀ
, 
tmp_öode
);

570 
ªtvÆ
 = 
	`pxt4_ext_sw≠_öode_d©a
(
h™dÀ
, 
öode
, 
tmp_öode
);

571 i‡(
ªtvÆ
)

576 
	`‰ì_ext_block
(
h™dÀ
, 
tmp_öode
);

580 i‡(
	`pxt4_jou∫Æ_exãnd
(
h™dÀ
, 1) != 0)

581 
	`pxt4_jou∫Æ_ª°¨t
(
h™dÀ
, 1);

586 
	`i_size_wrôe
(
tmp_öode
, 0);

596 
tmp_öode
->
i_blocks
 = 0;

599 
	`pxt4_ext_åì_öô
(
h™dÀ
, 
tmp_öode
);

600 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

601 
out_tmp_öode
:

602 
	`u∆ock_√w_öode
(
tmp_öode
);

603 
	`ùut
(
tmp_öode
);

604 
out_u∆ock
:

605 
	`≥r˝u_up_wrôe
(&
sbi
->
s_wrôïages_rw£m
);

606  
ªtvÆ
;

607 
	}
}

612 
	$pxt4_öd_migøã
(
öode
 *inode)

614 
pxt4_exã¡_hódî
 *
eh
;

615 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
öode
->
i_sb
);

616 
pxt4_su≥r_block
 *
es
 = 
sbi
->
s_es
;

617 
pxt4_öode_öfo
 *
ei
 = 
	`PXT4_I
(
öode
);

618 
pxt4_exã¡
 *
ex
;

619 
i
, 
Àn
;

620 
pxt4_lblk_t
 
°¨t
, 
íd
;

621 
pxt4_fsblk_t
 
blk
;

622 
h™dÀ_t
 *
h™dÀ
;

623 
ªt
;

625 i‡(!
	`pxt4_has_„©uª_exã¡s
(
öode
->
i_sb
) ||

626 (!
	`pxt4_ã°_öode_Êag
(
öode
, 
PXT4_INODE_EXTENTS
)))

627  -
EINVAL
;

629 i‡(
	`pxt4_has_„©uª_bigÆloc
(
öode
->
i_sb
))

630  -
EOPNOTSUPP
;

637 i‡(
	`ã°_›t
(
öode
->
i_sb
, 
DELALLOC
))

638 
	`pxt4_Æloc_da_blocks
(
öode
);

640 
	`≥r˝u_down_wrôe
(&
sbi
->
s_wrôïages_rw£m
);

642 
h™dÀ
 = 
	`pxt4_jou∫Æ_°¨t
(
öode
, 
PXT4_HT_MIGRATE
, 1);

643 i‡(
	`IS_ERR
(
h™dÀ
)) {

644 
ªt
 = 
	`PTR_ERR
(
h™dÀ
);

645 
out_u∆ock
;

648 
	`down_wrôe
(&
	`PXT4_I
(
öode
)->
i_d©a_£m
);

649 
ªt
 = 
	`pxt4_ext_check_öode
(
öode
);

650 i‡(
ªt
)

651 
îrout
;

653 
eh
 = 
	`ext_öode_hdr
(
öode
);

654 
ex
 = 
	`EXT_FIRST_EXTENT
(
eh
);

655 i‡(
	`pxt4_blocks_cou¡
(
es
Ë> 
PXT4_MAX_BLOCK_FILE_PHYS
 ||

656 
eh
->
eh_dïth
 !0 || 
	`À16_to_˝u
”h->
eh_íåõs
) > 1) {

657 
ªt
 = -
EOPNOTSUPP
;

658 
îrout
;

660 i‡(
eh
->
eh_íåõs
 == 0)

661 
blk
 = 
Àn
 = 
°¨t
 = 
íd
 = 0;

663 
Àn
 = 
	`À16_to_˝u
(
ex
->
ì_Àn
);

664 
blk
 = 
	`pxt4_ext_pblock
(
ex
);

665 
°¨t
 = 
	`À32_to_˝u
(
ex
->
ì_block
);

666 
íd
 = 
°¨t
 + 
Àn
 - 1;

667 i‡(
íd
 >
PXT4_NDIR_BLOCKS
) {

668 
ªt
 = -
EOPNOTSUPP
;

669 
îrout
;

673 
	`pxt4_˛ór_öode_Êag
(
öode
, 
PXT4_INODE_EXTENTS
);

674 
	`mem£t
(
ei
->
i_d©a
, 0, (ei->i_data));

675 
i
 = 
°¨t
; i <
íd
; i++)

676 
ei
->
i_d©a
[
i
] = 
	`˝u_to_À32
(
blk
++);

677 
	`pxt4_m¨k_öode_dúty
(
h™dÀ
, 
öode
);

678 
îrout
:

679 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

680 
	`up_wrôe
(&
	`PXT4_I
(
öode
)->
i_d©a_£m
);

681 
out_u∆ock
:

682 
	`≥r˝u_up_wrôe
(&
sbi
->
s_wrôïages_rw£m
);

683  
ªt
;

684 
	}
}

	@mmp.c

2 
	~<löux/fs.h
>

3 
	~<löux/øndom.h
>

4 
	~<löux/buf„r_hód.h
>

5 
	~<löux/ut¢ame.h
>

6 
	~<löux/kthªad.h
>

8 
	~"pxt4.h
"

11 
__À32
 
	$pxt4_mmp_csum
(
su≥r_block
 *
sb
, 
mmp_°ru˘
 *
mmp
)

13 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
sb
);

14 
off£t
 = 
	`off£tof
(
mmp_°ru˘
, 
mmp_checksum
);

15 
__u32
 
csum
;

17 
csum
 = 
	`pxt4_chksum
(
sbi
, sbi->
s_csum_£ed
, (*)
mmp
, 
off£t
);

19  
	`˝u_to_À32
(
csum
);

20 
	}
}

22 
	$pxt4_mmp_csum_vîify
(
su≥r_block
 *
sb
, 
mmp_°ru˘
 *
mmp
)

24 i‡(!
	`pxt4_has_mëad©a_csum
(
sb
))

27  
mmp
->
mmp_checksum
 =
	`pxt4_mmp_csum
(
sb
, mmp);

28 
	}
}

30 
	$pxt4_mmp_csum_£t
(
su≥r_block
 *
sb
, 
mmp_°ru˘
 *
mmp
)

32 i‡(!
	`pxt4_has_mëad©a_csum
(
sb
))

35 
mmp
->
mmp_checksum
 = 
	`pxt4_mmp_csum
(
sb
, mmp);

36 
	}
}

42 
	$wrôe_mmp_block
(
su≥r_block
 *
sb
, 
buf„r_hód
 *
bh
)

44 
mmp_°ru˘
 *
mmp
 = (mmp_°ru˘ *)(
bh
->
b_d©a
);

50 
	`sb_°¨t_wrôe
(
sb
);

51 
	`pxt4_mmp_csum_£t
(
sb
, 
mmp
);

52 
	`lock_buf„r
(
bh
);

53 
bh
->
b_íd_io
 = 
íd_buf„r_wrôe_sync
;

54 
	`gë_bh
(
bh
);

55 
	`submô_bh
(
REQ_OP_WRITE
, 
REQ_SYNC
 | 
REQ_META
 | 
REQ_PRIO
, 
bh
);

56 
	`waô_⁄_buf„r
(
bh
);

57 
	`sb_íd_wrôe
(
sb
);

58 i‡(
	`u∆ikñy
(!
	`buf„r_u±od©e
(
bh
)))

62 
	}
}

68 
	$ªad_mmp_block
(
su≥r_block
 *
sb
, 
buf„r_hód
 **
bh
,

69 
pxt4_fsblk_t
 
mmp_block
)

71 
mmp_°ru˘
 *
mmp
;

72 
ªt
;

74 i‡(*
bh
)

75 
	`˛ór_buf„r_u±od©e
(*
bh
);

80 i‡(!*
bh
) {

81 *
bh
 = 
	`sb_gëblk
(
sb
, 
mmp_block
);

82 i‡(!*
bh
) {

83 
ªt
 = -
ENOMEM
;

84 
w¨n_exô
;

88 
	`gë_bh
(*
bh
);

89 
	`lock_buf„r
(*
bh
);

90 (*
bh
)->
b_íd_io
 = 
íd_buf„r_ªad_sync
;

91 
	`submô_bh
(
REQ_OP_READ
, 
REQ_META
 | 
REQ_PRIO
, *
bh
);

92 
	`waô_⁄_buf„r
(*
bh
);

93 i‡(!
	`buf„r_u±od©e
(*
bh
)) {

94 
ªt
 = -
EIO
;

95 
w¨n_exô
;

97 
mmp
 = (
mmp_°ru˘
 *)((*
bh
)->
b_d©a
);

98 i‡(
	`À32_to_˝u
(
mmp
->
mmp_magic
Ë!
PXT4_MMP_MAGIC
) {

99 
ªt
 = -
EFSCORRUPTED
;

100 
w¨n_exô
;

102 i‡(!
	`pxt4_mmp_csum_vîify
(
sb
, 
mmp
)) {

103 
ªt
 = -
EFSBADCRC
;

104 
w¨n_exô
;

107 
w¨n_exô
:

108 
	`bªl£
(*
bh
);

109 *
bh
 = 
NULL
;

110 
	`pxt4_w¨nög
(
sb
, "Error %d whileÑeading MMP block %llu",

111 
ªt
, 
mmp_block
);

112  
ªt
;

113 
	}
}

118 
	$__dump_mmp_msg
(
su≥r_block
 *
sb
, 
mmp_°ru˘
 *
mmp
,

119 c⁄° *
fun˘i⁄
, 
löe
, c⁄° *
msg
)

121 
	`__pxt4_w¨nög
(
sb
, 
fun˘i⁄
, 
löe
, "%s", 
msg
);

122 
	`__pxt4_w¨nög
(
sb
, 
fun˘i⁄
, 
löe
,

124 ()
	`À64_to_˝u
(
mmp
->
mmp_time
),

125 ()(
mmp
->
mmp_nodíame
), mmp->mmp_nodename,

126 ()(
mmp
->
mmp_bdev«me
), mmp->mmp_bdevname);

127 
	}
}

132 
	$kmmpd
(*
d©a
)

134 
su≥r_block
 *
sb
 = ((
mmpd_d©a
 *Ë
d©a
)->sb;

135 
buf„r_hód
 *
bh
 = ((
mmpd_d©a
 *Ë
d©a
)->bh;

136 
pxt4_su≥r_block
 *
es
 = 
	`PXT4_SB
(
sb
)->
s_es
;

137 
mmp_°ru˘
 *
mmp
;

138 
pxt4_fsblk_t
 
mmp_block
;

139 
u32
 
£q
 = 0;

140 
Áûed_wrôes
 = 0;

141 
mmp_upd©e_öãrvÆ
 = 
	`À16_to_˝u
(
es
->
s_mmp_upd©e_öãrvÆ
);

142 
mmp_check_öãrvÆ
;

143 
œ°_upd©e_time
;

144 
diff
;

145 
ªtvÆ
;

147 
mmp_block
 = 
	`À64_to_˝u
(
es
->
s_mmp_block
);

148 
mmp
 = (
mmp_°ru˘
 *)(
bh
->
b_d©a
);

149 
mmp
->
mmp_time
 = 
	`˝u_to_À64
(
	`ktime_gë_ªÆ_£c⁄ds
());

154 
mmp_check_öãrvÆ
 = 
	`max
(
PXT4_MMP_CHECK_MULT
 * 
mmp_upd©e_öãrvÆ
,

155 
PXT4_MMP_MIN_CHECK_INTERVAL
);

156 
mmp
->
mmp_check_öãrvÆ
 = 
	`˝u_to_À16
(mmp_check_interval);

157 
	`BUILD_BUG_ON
((
mmp
->
mmp_bdev«me
Ë< 
BDEVNAME_SIZE
);

158 
	`bdev«me
(
bh
->
b_bdev
, 
mmp
->
mmp_bdev«me
);

160 
	`mem˝y
(
mmp
->
mmp_nodíame
, 
	`öô_ut¢ame
()->
nodíame
,

161 (
mmp
->
mmp_nodíame
));

163 !
	`kthªad_should_°›
()) {

164 i‡(++
£q
 > 
PXT4_MMP_SEQ_MAX
)

165 
£q
 = 1;

167 
mmp
->
mmp_£q
 = 
	`˝u_to_À32
(
£q
);

168 
mmp
->
mmp_time
 = 
	`˝u_to_À64
(
	`ktime_gë_ªÆ_£c⁄ds
());

169 
œ°_upd©e_time
 = 
jiffõs
;

171 
ªtvÆ
 = 
	`wrôe_mmp_block
(
sb
, 
bh
);

176 i‡(
ªtvÆ
) {

177 i‡((
Áûed_wrôes
 % 60) == 0)

178 
	`pxt4_îr‹
(
sb
, "Error writingÅo MMP block");

179 
Áûed_wrôes
++;

182 i‡(!(
	`À32_to_˝u
(
es
->
s_„©uª_öcom∑t
) &

183 
PXT4_FEATURE_INCOMPAT_MMP
)) {

184 
	`pxt4_w¨nög
(
sb
, "kmmpd being stopped since MMP feature"

186 
exô_thªad
;

189 i‡(
	`sb_rd⁄ly
(
sb
))

192 
diff
 = 
jiffõs
 - 
œ°_upd©e_time
;

193 i‡(
diff
 < 
mmp_upd©e_öãrvÆ
 * 
HZ
)

194 
	`scheduÀ_timeout_öãºu±ibÀ
(
mmp_upd©e_öãrvÆ
 *

195 
HZ
 - 
diff
);

202 
diff
 = 
jiffõs
 - 
œ°_upd©e_time
;

203 i‡(
diff
 > 
mmp_check_öãrvÆ
 * 
HZ
) {

204 
buf„r_hód
 *
bh_check
 = 
NULL
;

205 
mmp_°ru˘
 *
mmp_check
;

207 
ªtvÆ
 = 
	`ªad_mmp_block
(
sb
, &
bh_check
, 
mmp_block
);

208 i‡(
ªtvÆ
) {

209 
	`pxt4_îr‹
(
sb
, "errorÑeading MMP data: %d",

210 
ªtvÆ
);

211 
exô_thªad
;

214 
mmp_check
 = (
mmp_°ru˘
 *)(
bh_check
->
b_d©a
);

215 i‡(
mmp
->
mmp_£q
 !
mmp_check
->mmp_seq ||

216 
	`memcmp
(
mmp
->
mmp_nodíame
, 
mmp_check
->mmp_nodename,

217 (
mmp
->
mmp_nodíame
))) {

218 
	`dump_mmp_msg
(
sb
, 
mmp_check
,

222 
	`pxt4_îr‹
(
sb
, "abort");

223 
	`put_bh
(
bh_check
);

224 
ªtvÆ
 = -
EBUSY
;

225 
exô_thªad
;

227 
	`put_bh
(
bh_check
);

234 
mmp_check_öãrvÆ
 = 
	`max
(
	`mö
(
PXT4_MMP_CHECK_MULT
 * 
diff
 / 
HZ
,

235 
PXT4_MMP_MAX_CHECK_INTERVAL
),

236 
PXT4_MMP_MIN_CHECK_INTERVAL
);

237 
mmp
->
mmp_check_öãrvÆ
 = 
	`˝u_to_À16
(mmp_check_interval);

243 
mmp
->
mmp_£q
 = 
	`˝u_to_À32
(
PXT4_MMP_SEQ_CLEAN
);

244 
mmp
->
mmp_time
 = 
	`˝u_to_À64
(
	`ktime_gë_ªÆ_£c⁄ds
());

246 
ªtvÆ
 = 
	`wrôe_mmp_block
(
sb
, 
bh
);

248 
exô_thªad
:

249 
	`PXT4_SB
(
sb
)->
s_mmp_tsk
 = 
NULL
;

250 
	`k‰ì
(
d©a
);

251 
	`bªl£
(
bh
);

252  
ªtvÆ
;

253 
	}
}

259 
	$mmp_√w_£q
()

261 
u32
 
√w_£q
;

264 
√w_£q
 = 
	`¥™dom_u32
();

265 } 
√w_£q
 > 
PXT4_MMP_SEQ_MAX
);

267  
√w_£q
;

268 
	}
}

273 
	$pxt4_mu…i_mou¡_¥Ÿe˘
(
su≥r_block
 *
sb
,

274 
pxt4_fsblk_t
 
mmp_block
)

276 
pxt4_su≥r_block
 *
es
 = 
	`PXT4_SB
(
sb
)->
s_es
;

277 
buf„r_hód
 *
bh
 = 
NULL
;

278 
mmp_°ru˘
 *
mmp
 = 
NULL
;

279 
mmpd_d©a
 *mmpd_data;

280 
u32
 
£q
;

281 
mmp_check_öãrvÆ
 = 
	`À16_to_˝u
(
es
->
s_mmp_upd©e_öãrvÆ
);

282 
waô_time
 = 0;

283 
ªtvÆ
;

285 i‡(
mmp_block
 < 
	`À32_to_˝u
(
es
->
s_fú°_d©a_block
) ||

286 
mmp_block
 >
	`pxt4_blocks_cou¡
(
es
)) {

287 
	`pxt4_w¨nög
(
sb
, "Invalid MMP block in superblock");

288 
Áûed
;

291 
ªtvÆ
 = 
	`ªad_mmp_block
(
sb
, &
bh
, 
mmp_block
);

292 i‡(
ªtvÆ
)

293 
Áûed
;

295 
mmp
 = (
mmp_°ru˘
 *)(
bh
->
b_d©a
);

297 i‡(
mmp_check_öãrvÆ
 < 
PXT4_MMP_MIN_CHECK_INTERVAL
)

298 
mmp_check_öãrvÆ
 = 
PXT4_MMP_MIN_CHECK_INTERVAL
;

304 i‡(
	`À16_to_˝u
(
mmp
->
mmp_check_öãrvÆ
) > mmp_check_interval)

305 
mmp_check_öãrvÆ
 = 
	`À16_to_˝u
(
mmp
->mmp_check_interval);

307 
£q
 = 
	`À32_to_˝u
(
mmp
->
mmp_£q
);

308 i‡(
£q
 =
PXT4_MMP_SEQ_CLEAN
)

309 
skù
;

311 i‡(
£q
 =
PXT4_MMP_SEQ_FSCK
) {

312 
	`dump_mmp_msg
(
sb
, 
mmp
, "fsck isÑunning onÅhe filesystem");

313 
Áûed
;

316 
waô_time
 = 
	`mö
(
mmp_check_öãrvÆ
 * 2 + 1,

317 
mmp_check_öãrvÆ
 + 60);

320 i‡(
waô_time
 > 
PXT4_MMP_MIN_CHECK_INTERVAL
 * 4)

321 
	`pxt4_w¨nög
(
sb
, "MMP interval %u higherÅhanÉxpected,Ölease"

322 " waô.\n", 
waô_time
 * 2);

324 i‡(
	`scheduÀ_timeout_öãºu±ibÀ
(
HZ
 * 
waô_time
) != 0) {

325 
	`pxt4_w¨nög
(
sb
, "MMP startup interrupted, failing mount\n");

326 
Áûed
;

329 
ªtvÆ
 = 
	`ªad_mmp_block
(
sb
, &
bh
, 
mmp_block
);

330 i‡(
ªtvÆ
)

331 
Áûed
;

332 
mmp
 = (
mmp_°ru˘
 *)(
bh
->
b_d©a
);

333 i‡(
£q
 !
	`À32_to_˝u
(
mmp
->
mmp_£q
)) {

334 
	`dump_mmp_msg
(
sb
, 
mmp
,

336 
Áûed
;

339 
skù
:

343 
£q
 = 
	`mmp_√w_£q
();

344 
mmp
->
mmp_£q
 = 
	`˝u_to_À32
(
£q
);

346 
ªtvÆ
 = 
	`wrôe_mmp_block
(
sb
, 
bh
);

347 i‡(
ªtvÆ
)

348 
Áûed
;

353 i‡(
	`scheduÀ_timeout_öãºu±ibÀ
(
HZ
 * 
waô_time
) != 0) {

354 
	`pxt4_w¨nög
(
sb
, "MMP startup interrupted, failing mount");

355 
Áûed
;

358 
ªtvÆ
 = 
	`ªad_mmp_block
(
sb
, &
bh
, 
mmp_block
);

359 i‡(
ªtvÆ
)

360 
Áûed
;

361 
mmp
 = (
mmp_°ru˘
 *)(
bh
->
b_d©a
);

362 i‡(
£q
 !
	`À32_to_˝u
(
mmp
->
mmp_£q
)) {

363 
	`dump_mmp_msg
(
sb
, 
mmp
,

365 
Áûed
;

368 
mmpd_d©a
 = 
	`kmÆloc
((*mmpd_d©a), 
GFP_KERNEL
);

369 i‡(!
mmpd_d©a
) {

370 
	`pxt4_w¨nög
(
sb
, "notÉnough memory for mmpd_data");

371 
Áûed
;

373 
mmpd_d©a
->
sb
 = sb;

374 
mmpd_d©a
->
bh
 = bh;

379 
	`PXT4_SB
(
sb
)->
s_mmp_tsk
 = 
	`kthªad_run
(
kmmpd
, 
mmpd_d©a
, "kmmpd-%.*s",

380 ()(
mmp
->
mmp_bdev«me
),

381 
	`bdev«me
(
bh
->
b_bdev
,

382 
mmp
->
mmp_bdev«me
));

383 i‡(
	`IS_ERR
(
	`PXT4_SB
(
sb
)->
s_mmp_tsk
)) {

384 
	`PXT4_SB
(
sb
)->
s_mmp_tsk
 = 
NULL
;

385 
	`k‰ì
(
mmpd_d©a
);

386 
	`pxt4_w¨nög
(
sb
, "UnableÅo create kmmpdÅhread for %s.",

387 
sb
->
s_id
);

388 
Áûed
;

393 
Áûed
:

394 
	`bªl£
(
bh
);

396 
	}
}

	@move_extent.c

8 
	~<löux/fs.h
>

9 
	~<löux/quŸa›s.h
>

10 
	~<löux/¶ab.h
>

11 
	~"pxt4_jbd3.h
"

12 
	~"pxt4.h
"

13 
	~"pxt4_exã¡s.h
"

24 
ölöe
 

25 
	$gë_ext_∑th
(
öode
 *öode, 
pxt4_lblk_t
 
lblock
,

26 
pxt4_ext_∑th
 **
µ©h
)

28 
pxt4_ext_∑th
 *
∑th
;

30 
∑th
 = 
	`pxt4_föd_exã¡
(
öode
, 
lblock
, 
µ©h
, 
PXT4_EX_NOCACHE
);

31 i‡(
	`IS_ERR
(
∑th
))

32  
	`PTR_ERR
(
∑th
);

33 i‡(
∑th
[
	`ext_dïth
(
öode
)].
p_ext
 =
NULL
) {

34 
	`pxt4_ext_dr›_ªfs
(
∑th
);

35 
	`k‰ì
(
∑th
);

36 *
µ©h
 = 
NULL
;

37  -
ENODATA
;

39 *
µ©h
 = 
∑th
;

41 
	}
}

51 
	$pxt4_doubÀ_down_wrôe_d©a_£m
(
öode
 *
fú°
, öodê*
£c⁄d
)

53 i‡(
fú°
 < 
£c⁄d
) {

54 
	`down_wrôe
(&
	`PXT4_I
(
fú°
)->
i_d©a_£m
);

55 
	`down_wrôe_√°ed
(&
	`PXT4_I
(
£c⁄d
)->
i_d©a_£m
, 
I_DATA_SEM_OTHER
);

57 
	`down_wrôe
(&
	`PXT4_I
(
£c⁄d
)->
i_d©a_£m
);

58 
	`down_wrôe_√°ed
(&
	`PXT4_I
(
fú°
)->
i_d©a_£m
, 
I_DATA_SEM_OTHER
);

61 
	}
}

71 
	$pxt4_doubÀ_up_wrôe_d©a_£m
(
öode
 *
‹ig_öode
,

72 
öode
 *
d⁄‹_öode
)

74 
	`up_wrôe
(&
	`PXT4_I
(
‹ig_öode
)->
i_d©a_£m
);

75 
	`up_wrôe
(&
	`PXT4_I
(
d⁄‹_öode
)->
i_d©a_£m
);

76 
	}
}

90 
	$mext_check_covîage
(
öode
 *öode, 
pxt4_lblk_t
 
‰om
,Öxt4_lblk_à
cou¡
,

91 
unwrôãn
, *
îr
)

93 
pxt4_ext_∑th
 *
∑th
 = 
NULL
;

94 
pxt4_exã¡
 *
ext
;

95 
ªt
 = 0;

96 
pxt4_lblk_t
 
œ°
 = 
‰om
 + 
cou¡
;

97 
‰om
 < 
œ°
) {

98 *
îr
 = 
	`gë_ext_∑th
(
öode
, 
‰om
, &
∑th
);

99 i‡(*
îr
)

100 
out
;

101 
ext
 = 
∑th
[
	`ext_dïth
(
öode
)].
p_ext
;

102 i‡(
unwrôãn
 !
	`pxt4_ext_is_unwrôãn
(
ext
))

103 
out
;

104 
‰om
 +
	`pxt4_ext_gë_a˘uÆ_Àn
(
ext
);

105 
	`pxt4_ext_dr›_ªfs
(
∑th
);

107 
ªt
 = 1;

108 
out
:

109 
	`pxt4_ext_dr›_ªfs
(
∑th
);

110 
	`k‰ì
(
∑th
);

111  
ªt
;

112 
	}
}

126 
	$mext_∑ge_doubÀ_lock
(
öode
 *
öode1
, öodê*
öode2
,

127 
pgoff_t
 
ödex1
,Ögoff_à
ödex2
, 
∑ge
 *page[2])

129 
addªss_•a˚
 *
m≠pög
[2];

130 
Ê
 = 
AOP_FLAG_NOFS
;

132 
	`BUG_ON
(!
öode1
 || !
öode2
);

133 i‡(
öode1
 < 
öode2
) {

134 
m≠pög
[0] = 
öode1
->
i_m≠pög
;

135 
m≠pög
[1] = 
öode2
->
i_m≠pög
;

137 
	`sw≠
(
ödex1
, 
ödex2
);

138 
m≠pög
[0] = 
öode2
->
i_m≠pög
;

139 
m≠pög
[1] = 
öode1
->
i_m≠pög
;

142 
∑ge
[0] = 
	`gøb_ˇche_∑ge_wrôe_begö
(
m≠pög
[0], 
ödex1
, 
Ê
);

143 i‡(!
∑ge
[0])

144  -
ENOMEM
;

146 
∑ge
[1] = 
	`gøb_ˇche_∑ge_wrôe_begö
(
m≠pög
[1], 
ödex2
, 
Ê
);

147 i‡(!
∑ge
[1]) {

148 
	`u∆ock_∑ge
(
∑ge
[0]);

149 
	`put_∑ge
(
∑ge
[0]);

150  -
ENOMEM
;

157 
	`waô_⁄_∑ge_wrôeback
(
∑ge
[0]);

158 
	`waô_⁄_∑ge_wrôeback
(
∑ge
[1]);

159 i‡(
öode1
 > 
öode2
)

160 
	`sw≠
(
∑ge
[0],Öage[1]);

163 
	}
}

167 
	$mext_∑ge_mku±od©e
(
∑ge
 *∑ge, 
‰om
, 
to
)

169 
öode
 *öodê
∑ge
->
m≠pög
->
ho°
;

170 
£˘‹_t
 
block
;

171 
buf„r_hód
 *
bh
, *
hód
, *
¨r
[
MAX_BUF_PER_PAGE
];

172 
blocksize
, 
block_°¨t
, 
block_íd
;

173 
i
, 
îr
, 
ƒ
 = 0, 
∑πül
 = 0;

174 
	`BUG_ON
(!
	`PageLocked
(
∑ge
));

175 
	`BUG_ON
(
	`PageWrôeback
(
∑ge
));

177 i‡(
	`PageU±od©e
(
∑ge
))

180 
blocksize
 = 
	`i_blocksize
(
öode
);

181 i‡(!
	`∑ge_has_buf„rs
(
∑ge
))

182 
	`¸óã_em±y_buf„rs
(
∑ge
, 
blocksize
, 0);

184 
hód
 = 
	`∑ge_buf„rs
(
∑ge
);

185 
block
 = (
£˘‹_t
)
∑ge
->
ödex
 << (
PAGE_SHIFT
 - 
öode
->
i_blkbôs
);

186 
bh
 = 
hód
, 
block_°¨t
 = 0; bh != head || !block_start;

187 
block
++, 
block_°¨t
 = 
block_íd
, 
bh
 = bh->
b_this_∑ge
) {

188 
block_íd
 = 
block_°¨t
 + 
blocksize
;

189 i‡(
block_íd
 <
‰om
 || 
block_°¨t
 >
to
) {

190 i‡(!
	`buf„r_u±od©e
(
bh
))

191 
∑πül
 = 1;

194 i‡(
	`buf„r_u±od©e
(
bh
))

196 i‡(!
	`buf„r_m≠≥d
(
bh
)) {

197 
îr
 = 
	`pxt4_gë_block
(
öode
, 
block
, 
bh
, 0);

198 i‡(
îr
) {

199 
	`SëPageEº‹
(
∑ge
);

200  
îr
;

202 i‡(!
	`buf„r_m≠≥d
(
bh
)) {

203 
	`zîo_u£r
(
∑ge
, 
block_°¨t
, 
blocksize
);

204 
	`£t_buf„r_u±od©e
(
bh
);

208 
	`BUG_ON
(
ƒ
 >
MAX_BUF_PER_PAGE
);

209 
¨r
[
ƒ
++] = 
bh
;

212 i‡(!
ƒ
)

213 
out
;

215 
i
 = 0; i < 
ƒ
; i++) {

216 
bh
 = 
¨r
[
i
];

217 i‡(!
	`bh_u±od©e_‹_lock
(
bh
)) {

218 
îr
 = 
	`bh_submô_ªad
(
bh
);

219 i‡(
îr
)

220  
îr
;

223 
out
:

224 i‡(!
∑πül
)

225 
	`SëPageU±od©e
(
∑ge
);

227 
	}
}

247 
	$move_exã¡_≥r_∑ge
(
fûe
 *
o_fûp
, 
öode
 *
d⁄‹_öode
,

248 
pgoff_t
 
‹ig_∑ge_off£t
,Ögoff_à
d⁄‹_∑ge_off£t
,

249 
d©a_off£t_ö_∑ge
,

250 
block_Àn_ö_∑ge
, 
unwrôãn
, *
îr
)

252 
öode
 *
‹ig_öode
 = 
	`fûe_öode
(
o_fûp
);

253 
∑ge
 *
∑gï
[2] = {
NULL
, NULL};

254 
h™dÀ_t
 *
h™dÀ
;

255 
pxt4_lblk_t
 
‹ig_blk_off£t
, 
d⁄‹_blk_off£t
;

256 
blocksize
 = 
‹ig_öode
->
i_sb
->
s_blocksize
;

257 
tmp_d©a_size
, 
d©a_size
, 
ª∂a˚d_size
;

258 
i
, 
îr2
, 
jblocks
, 
ªåõs
 = 0;

259 
ª∂a˚d_cou¡
 = 0;

260 
‰om
 = 
d©a_off£t_ö_∑ge
 << 
‹ig_öode
->
i_blkbôs
;

261 
blocks_≥r_∑ge
 = 
PAGE_SIZE
 >> 
‹ig_öode
->
i_blkbôs
;

262 
su≥r_block
 *
sb
 = 
‹ig_öode
->
i_sb
;

263 
buf„r_hód
 *
bh
 = 
NULL
;

269 
agaö
:

270 *
îr
 = 0;

271 
jblocks
 = 
	`pxt4_wrôïage_å™s_blocks
(
‹ig_öode
) * 2;

272 
h™dÀ
 = 
	`pxt4_jou∫Æ_°¨t
(
‹ig_öode
, 
PXT4_HT_MOVE_EXTENTS
, 
jblocks
);

273 i‡(
	`IS_ERR
(
h™dÀ
)) {

274 *
îr
 = 
	`PTR_ERR
(
h™dÀ
);

278 
‹ig_blk_off£t
 = 
‹ig_∑ge_off£t
 * 
blocks_≥r_∑ge
 +

279 
d©a_off£t_ö_∑ge
;

281 
d⁄‹_blk_off£t
 = 
d⁄‹_∑ge_off£t
 * 
blocks_≥r_∑ge
 +

282 
d©a_off£t_ö_∑ge
;

285 i‡((
‹ig_blk_off£t
 + 
block_Àn_ö_∑ge
 - 1) ==

286 ((
‹ig_öode
->
i_size
 - 1Ë>> orig_öode->
i_blkbôs
)) {

288 
tmp_d©a_size
 = 
‹ig_öode
->
i_size
 & (
blocksize
 - 1);

293 i‡(
tmp_d©a_size
 == 0)

294 
tmp_d©a_size
 = 
blocksize
;

296 
d©a_size
 = 
tmp_d©a_size
 +

297 ((
block_Àn_ö_∑ge
 - 1Ë<< 
‹ig_öode
->
i_blkbôs
);

299 
d©a_size
 = 
block_Àn_ö_∑ge
 << 
‹ig_öode
->
i_blkbôs
;

301 
ª∂a˚d_size
 = 
d©a_size
;

303 *
îr
 = 
	`mext_∑ge_doubÀ_lock
(
‹ig_öode
, 
d⁄‹_öode
, 
‹ig_∑ge_off£t
,

304 
d⁄‹_∑ge_off£t
, 
∑gï
);

305 i‡(
	`u∆ikñy
(*
îr
 < 0))

306 
°›_jou∫Æ
;

314 i‡(
unwrôãn
) {

315 
	`pxt4_doubÀ_down_wrôe_d©a_£m
(
‹ig_öode
, 
d⁄‹_öode
);

318 
unwrôãn
 = 
	`mext_check_covîage
(
‹ig_öode
, 
‹ig_blk_off£t
,

319 
block_Àn_ö_∑ge
, 1, 
îr
);

320 i‡(*
îr
)

321 
dr›_d©a_£m
;

323 
unwrôãn
 &
	`mext_check_covîage
(
d⁄‹_öode
, 
d⁄‹_blk_off£t
,

324 
block_Àn_ö_∑ge
, 1, 
îr
);

325 i‡(*
îr
)

326 
dr›_d©a_£m
;

328 i‡(!
unwrôãn
) {

329 
	`pxt4_doubÀ_up_wrôe_d©a_£m
(
‹ig_öode
, 
d⁄‹_öode
);

330 
d©a_c›y
;

332 i‡((
	`∑ge_has_¥iv©e
(
∑gï
[0]) &&

333 !
	`åy_to_ªÀa£_∑ge
(
∑gï
[0], 0)) ||

334 (
	`∑ge_has_¥iv©e
(
∑gï
[1]) &&

335 !
	`åy_to_ªÀa£_∑ge
(
∑gï
[1], 0))) {

336 *
îr
 = -
EBUSY
;

337 
dr›_d©a_£m
;

339 
ª∂a˚d_cou¡
 = 
	`pxt4_sw≠_exã¡s
(
h™dÀ
, 
‹ig_öode
,

340 
d⁄‹_öode
, 
‹ig_blk_off£t
,

341 
d⁄‹_blk_off£t
,

342 
block_Àn_ö_∑ge
, 1, 
îr
);

343 
dr›_d©a_£m
:

344 
	`pxt4_doubÀ_up_wrôe_d©a_£m
(
‹ig_öode
, 
d⁄‹_öode
);

345 
u∆ock_∑ges
;

347 
d©a_c›y
:

348 *
îr
 = 
	`mext_∑ge_mku±od©e
(
∑gï
[0], 
‰om
, from + 
ª∂a˚d_size
);

349 i‡(*
îr
)

350 
u∆ock_∑ges
;

354 i‡((
	`∑ge_has_¥iv©e
(
∑gï
[0]Ë&& !
	`åy_to_ªÀa£_∑ge
(pagep[0], 0)) ||

355 (
	`∑ge_has_¥iv©e
(
∑gï
[1]Ë&& !
	`åy_to_ªÀa£_∑ge
(pagep[1], 0))) {

356 *
îr
 = -
EBUSY
;

357 
u∆ock_∑ges
;

359 
	`pxt4_doubÀ_down_wrôe_d©a_£m
(
‹ig_öode
, 
d⁄‹_öode
);

360 
ª∂a˚d_cou¡
 = 
	`pxt4_sw≠_exã¡s
(
h™dÀ
, 
‹ig_öode
, 
d⁄‹_öode
,

361 
‹ig_blk_off£t
, 
d⁄‹_blk_off£t
,

362 
block_Àn_ö_∑ge
, 1, 
îr
);

363 
	`pxt4_doubÀ_up_wrôe_d©a_£m
(
‹ig_öode
, 
d⁄‹_öode
);

364 i‡(*
îr
) {

365 i‡(
ª∂a˚d_cou¡
) {

366 
block_Àn_ö_∑ge
 = 
ª∂a˚d_cou¡
;

367 
ª∂a˚d_size
 =

368 
block_Àn_ö_∑ge
 << 
‹ig_öode
->
i_blkbôs
;

370 
u∆ock_∑ges
;

374 i‡(!
	`∑ge_has_buf„rs
(
∑gï
[0]))

375 
	`¸óã_em±y_buf„rs
(
∑gï
[0], 1 << 
‹ig_öode
->
i_blkbôs
, 0);

376 
bh
 = 
	`∑ge_buf„rs
(
∑gï
[0]);

377 
i
 = 0; i < 
d©a_off£t_ö_∑ge
; i++)

378 
bh
 = bh->
b_this_∑ge
;

379 
i
 = 0; i < 
block_Àn_ö_∑ge
; i++) {

380 *
îr
 = 
	`pxt4_gë_block
(
‹ig_öode
, 
‹ig_blk_off£t
 + 
i
, 
bh
, 0);

381 i‡(*
îr
 < 0)

383 
bh
 = bh->
b_this_∑ge
;

385 i‡(!*
îr
)

386 *
îr
 = 
	`block_commô_wrôe
(
∑gï
[0], 
‰om
, from + 
ª∂a˚d_size
);

388 i‡(
	`u∆ikñy
(*
îr
 < 0))

389 
ª∑ú_bønches
;

393 *
îr
 = 
	`pxt4_jbd3_öode_add_wrôe
(
h™dÀ
, 
‹ig_öode
,

394 (
loff_t
)
‹ig_∑ge_off£t
 << 
PAGE_SHIFT
, 
ª∂a˚d_size
);

396 
u∆ock_∑ges
:

397 
	`u∆ock_∑ge
(
∑gï
[0]);

398 
	`put_∑ge
(
∑gï
[0]);

399 
	`u∆ock_∑ge
(
∑gï
[1]);

400 
	`put_∑ge
(
∑gï
[1]);

401 
°›_jou∫Æ
:

402 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

403 i‡(*
îr
 =-
ENOSPC
 &&

404 
	`pxt4_should_ªåy_Æloc
(
sb
, &
ªåõs
))

405 
agaö
;

408 i‡(*
îr
 =-
EBUSY
 && 
ªåõs
++ < 4 && 
	`PXT4_SB
(
sb
)->
s_jou∫Æ
 &&

409 
	`jbd3_jou∫Æ_f‹˚_commô_√°ed
(
	`PXT4_SB
(
sb
)->
s_jou∫Æ
))

410 
agaö
;

411  
ª∂a˚d_cou¡
;

413 
ª∑ú_bønches
:

419 
	`pxt4_doubÀ_down_wrôe_d©a_£m
(
‹ig_öode
, 
d⁄‹_öode
);

420 
ª∂a˚d_cou¡
 = 
	`pxt4_sw≠_exã¡s
(
h™dÀ
, 
d⁄‹_öode
, 
‹ig_öode
,

421 
‹ig_blk_off£t
, 
d⁄‹_blk_off£t
,

422 
block_Àn_ö_∑ge
, 0, &
îr2
);

423 
	`pxt4_doubÀ_up_wrôe_d©a_£m
(
‹ig_öode
, 
d⁄‹_öode
);

424 i‡(
ª∂a˚d_cou¡
 !
block_Àn_ö_∑ge
) {

425 
	`PXT4_ERROR_INODE_BLOCK
(
‹ig_öode
, (
£˘‹_t
)(
‹ig_blk_off£t
),

428 *
îr
 = -
EIO
;

430 
ª∂a˚d_cou¡
 = 0;

431 
u∆ock_∑ges
;

432 
	}
}

448 
	$mext_check_¨gumíts
(
öode
 *
‹ig_öode
,

449 
öode
 *
d⁄‹_öode
, 
__u64
 
‹ig_°¨t
,

450 
__u64
 
d⁄‹_°¨t
, __u64 *
Àn
)

452 
__u64
 
‹ig_eof
, 
d⁄‹_eof
;

453 
blkbôs
 = 
‹ig_öode
->
i_blkbôs
;

454 
blocksize
 = 1 << 
blkbôs
;

456 
‹ig_eof
 = (
	`i_size_ªad
(
‹ig_öode
Ë+ 
blocksize
 - 1Ë>> 
blkbôs
;

457 
d⁄‹_eof
 = (
	`i_size_ªad
(
d⁄‹_öode
Ë+ 
blocksize
 - 1Ë>> 
blkbôs
;

460 i‡(
d⁄‹_öode
->
i_mode
 & (
S_ISUID
|
S_ISGID
)) {

461 
	`pxt4_debug
("pxt4 moveÉxtent: suid or sgid is set"

463 
‹ig_öode
->
i_öo
, 
d⁄‹_öode
->i_ino);

464  -
EINVAL
;

467 i‡(
	`IS_IMMUTABLE
(
d⁄‹_öode
Ë|| 
	`IS_APPEND
(donor_inode))

468  -
EPERM
;

471 i‡(
	`IS_SWAPFILE
(
‹ig_öode
Ë|| IS_SWAPFILE(
d⁄‹_öode
)) {

472 
	`pxt4_debug
("pxt4 moveÉxtent: Theárgument files should "

474 
‹ig_öode
->
i_öo
, 
d⁄‹_öode
->i_ino);

475  -
EBUSY
;

478 i‡(
	`pxt4_is_quŸa_fûe
(
‹ig_öode
Ë&&Öxt4_is_quŸa_fûe(
d⁄‹_öode
)) {

479 
	`pxt4_debug
("pxt4 moveÉxtent: Theárgument files should "

481 
‹ig_öode
->
i_öo
, 
d⁄‹_öode
->i_ino);

482  -
EBUSY
;

486 i‡(!(
	`pxt4_ã°_öode_Êag
(
‹ig_öode
, 
PXT4_INODE_EXTENTS
))) {

487 
	`pxt4_debug
("pxt4 moveÉxtent: orig file isÇotÉxtents "

488 "ba£d fûê[öo:‹ig %lu]\n", 
‹ig_öode
->
i_öo
);

489  -
EOPNOTSUPP
;

490 } i‡(!(
	`pxt4_ã°_öode_Êag
(
d⁄‹_öode
, 
PXT4_INODE_EXTENTS
))) {

491 
	`pxt4_debug
("pxt4 moveÉxtent: donor file isÇotÉxtents "

492 "ba£d fûê[öo:d⁄‹ %lu]\n", 
d⁄‹_öode
->
i_öo
);

493  -
EOPNOTSUPP
;

496 i‡((!
‹ig_öode
->
i_size
Ë|| (!
d⁄‹_öode
->i_size)) {

497 
	`pxt4_debug
("pxt4 moveÉxtent: File size is 0 byte\n");

498  -
EINVAL
;

502 i‡((
‹ig_°¨t
 & ~(
PAGE_MASK
 >> 
‹ig_öode
->
i_blkbôs
)) !=

503 (
d⁄‹_°¨t
 & ~(
PAGE_MASK
 >> 
‹ig_öode
->
i_blkbôs
))) {

504 
	`pxt4_debug
("pxt4 moveÉxtent: origánd donor's start "

506 
‹ig_öode
->
i_öo
, 
d⁄‹_öode
->i_ino);

507  -
EINVAL
;

510 i‡((
‹ig_°¨t
 >
EXT_MAX_BLOCKS
) ||

511 (
d⁄‹_°¨t
 >
EXT_MAX_BLOCKS
) ||

512 (*
Àn
 > 
EXT_MAX_BLOCKS
) ||

513 (
d⁄‹_°¨t
 + *
Àn
 >
EXT_MAX_BLOCKS
) ||

514 (
‹ig_°¨t
 + *
Àn
 >
EXT_MAX_BLOCKS
)) {

515 
	`pxt4_debug
("pxt4 moveÉxtent: Can't handle over [%u] blocks "

516 "[öo:‹ig %lu, d⁄‹ %lu]\n", 
EXT_MAX_BLOCKS
,

517 
‹ig_öode
->
i_öo
, 
d⁄‹_öode
->i_ino);

518  -
EINVAL
;

520 i‡(
‹ig_eof
 <
‹ig_°¨t
)

521 *
Àn
 = 0;

522 i‡(
‹ig_eof
 < 
‹ig_°¨t
 + *
Àn
 - 1)

523 *
Àn
 = 
‹ig_eof
 - 
‹ig_°¨t
;

524 i‡(
d⁄‹_eof
 <
d⁄‹_°¨t
)

525 *
Àn
 = 0;

526 i‡(
d⁄‹_eof
 < 
d⁄‹_°¨t
 + *
Àn
 - 1)

527 *
Àn
 = 
d⁄‹_eof
 - 
d⁄‹_°¨t
;

528 i‡(!*
Àn
) {

529 
	`pxt4_debug
("pxt4 moveÉxtent:Üen shouldÇot be 0 "

530 "[öo:‹ig %lu, d⁄‹ %lu]\n", 
‹ig_öode
->
i_öo
,

531 
d⁄‹_öode
->
i_öo
);

532  -
EINVAL
;

536 
	}
}

553 
	$pxt4_move_exã¡s
(
fûe
 *
o_fûp
, fûê*
d_fûp
, 
__u64
 
‹ig_blk
,

554 
__u64
 
d⁄‹_blk
, __u64 
Àn
, __u64 *
moved_Àn
)

556 
öode
 *
‹ig_öode
 = 
	`fûe_öode
(
o_fûp
);

557 
öode
 *
d⁄‹_öode
 = 
	`fûe_öode
(
d_fûp
);

558 
pxt4_ext_∑th
 *
∑th
 = 
NULL
;

559 
blocks_≥r_∑ge
 = 
PAGE_SIZE
 >> 
‹ig_öode
->
i_blkbôs
;

560 
pxt4_lblk_t
 
o_íd
, 
o_°¨t
 = 
‹ig_blk
;

561 
pxt4_lblk_t
 
d_°¨t
 = 
d⁄‹_blk
;

562 
ªt
;

564 i‡(
‹ig_öode
->
i_sb
 !
d⁄‹_öode
->i_sb) {

565 
	`pxt4_debug
("pxt4 moveÉxtent: Theárgument files "

567 
‹ig_öode
->
i_öo
, 
d⁄‹_öode
->i_ino);

568  -
EINVAL
;

572 i‡(
‹ig_öode
 =
d⁄‹_öode
) {

573 
	`pxt4_debug
("pxt4 moveÉxtent: Theárgument files shouldÇot "

575 
‹ig_öode
->
i_öo
, 
d⁄‹_öode
->i_ino);

576  -
EINVAL
;

580 i‡(!
	`S_ISREG
(
‹ig_öode
->
i_mode
Ë|| !S_ISREG(
d⁄‹_öode
->i_mode)) {

581 
	`pxt4_debug
("pxt4 moveÉxtent: Theárgument files should be "

583 
‹ig_öode
->
i_öo
, 
d⁄‹_öode
->i_ino);

584  -
EINVAL
;

589 i‡(
	`pxt4_should_jou∫Æ_d©a
(
‹ig_öode
) ||

590 
	`pxt4_should_jou∫Æ_d©a
(
d⁄‹_öode
)) {

591 
	`pxt4_msg
(
‹ig_öode
->
i_sb
, 
KERN_ERR
,

593  -
EOPNOTSUPP
;

596 i‡(
	`IS_ENCRYPTED
(
‹ig_öode
Ë|| IS_ENCRYPTED(
d⁄‹_öode
)) {

597 
	`pxt4_msg
(
‹ig_öode
->
i_sb
, 
KERN_ERR
,

599  -
EOPNOTSUPP
;

603 
	`lock_two_n⁄dúe˘‹õs
(
‹ig_öode
, 
d⁄‹_öode
);

606 
	`öode_dio_waô
(
‹ig_öode
);

607 
	`öode_dio_waô
(
d⁄‹_öode
);

610 
	`pxt4_doubÀ_down_wrôe_d©a_£m
(
‹ig_öode
, 
d⁄‹_öode
);

612 
ªt
 = 
	`mext_check_¨gumíts
(
‹ig_öode
, 
d⁄‹_öode
, 
‹ig_blk
,

613 
d⁄‹_blk
, &
Àn
);

614 i‡(
ªt
)

615 
out
;

616 
o_íd
 = 
o_°¨t
 + 
Àn
;

618 
o_°¨t
 < 
o_íd
) {

619 
pxt4_exã¡
 *
ex
;

620 
pxt4_lblk_t
 
cur_blk
, 
√xt_blk
;

621 
pgoff_t
 
‹ig_∑ge_ödex
, 
d⁄‹_∑ge_ödex
;

622 
off£t_ö_∑ge
;

623 
unwrôãn
, 
cur_Àn
;

625 
ªt
 = 
	`gë_ext_∑th
(
‹ig_öode
, 
o_°¨t
, &
∑th
);

626 i‡(
ªt
)

627 
out
;

628 
ex
 = 
∑th
[∑th->
p_dïth
].
p_ext
;

629 
√xt_blk
 = 
	`pxt4_ext_√xt_Æloˇãd_block
(
∑th
);

630 
cur_blk
 = 
	`À32_to_˝u
(
ex
->
ì_block
);

631 
cur_Àn
 = 
	`pxt4_ext_gë_a˘uÆ_Àn
(
ex
);

633 i‡(
cur_blk
 + 
cur_Àn
 - 1 < 
o_°¨t
) {

634 i‡(
√xt_blk
 =
EXT_MAX_BLOCKS
) {

635 
o_°¨t
 = 
o_íd
;

636 
ªt
 = -
ENODATA
;

637 
out
;

639 
d_°¨t
 +
√xt_blk
 - 
o_°¨t
;

640 
o_°¨t
 = 
√xt_blk
;

643 } i‡(
cur_blk
 > 
o_°¨t
) {

645 
d_°¨t
 +
cur_blk
 - 
o_°¨t
;

646 
o_°¨t
 = 
cur_blk
;

648 i‡(
cur_blk
 >
o_íd
)

649 
out
;

651 
cur_Àn
 +
cur_blk
 - 
o_°¨t
;

653 
unwrôãn
 = 
	`pxt4_ext_is_unwrôãn
(
ex
);

654 i‡(
o_íd
 - 
o_°¨t
 < 
cur_Àn
)

655 
cur_Àn
 = 
o_íd
 - 
o_°¨t
;

657 
‹ig_∑ge_ödex
 = 
o_°¨t
 >> (
PAGE_SHIFT
 -

658 
‹ig_öode
->
i_blkbôs
);

659 
d⁄‹_∑ge_ödex
 = 
d_°¨t
 >> (
PAGE_SHIFT
 -

660 
d⁄‹_öode
->
i_blkbôs
);

661 
off£t_ö_∑ge
 = 
o_°¨t
 % 
blocks_≥r_∑ge
;

662 i‡(
cur_Àn
 > 
blocks_≥r_∑ge
- 
off£t_ö_∑ge
)

663 
cur_Àn
 = 
blocks_≥r_∑ge
 - 
off£t_ö_∑ge
;

671 
	`pxt4_doubÀ_up_wrôe_d©a_£m
(
‹ig_öode
, 
d⁄‹_öode
);

673 
	`move_exã¡_≥r_∑ge
(
o_fûp
, 
d⁄‹_öode
,

674 
‹ig_∑ge_ödex
, 
d⁄‹_∑ge_ödex
,

675 
off£t_ö_∑ge
, 
cur_Àn
,

676 
unwrôãn
, &
ªt
);

677 
	`pxt4_doubÀ_down_wrôe_d©a_£m
(
‹ig_öode
, 
d⁄‹_öode
);

678 i‡(
ªt
 < 0)

680 
o_°¨t
 +
cur_Àn
;

681 
d_°¨t
 +
cur_Àn
;

683 *
moved_Àn
 = 
o_°¨t
 - 
‹ig_blk
;

684 i‡(*
moved_Àn
 > 
Àn
)

685 *
moved_Àn
 = 
Àn
;

687 
out
:

688 i‡(*
moved_Àn
) {

689 
	`pxt4_disˇrd_¥óŒoˇti⁄s
(
‹ig_öode
);

690 
	`pxt4_disˇrd_¥óŒoˇti⁄s
(
d⁄‹_öode
);

693 
	`pxt4_ext_dr›_ªfs
(
∑th
);

694 
	`k‰ì
(
∑th
);

695 
	`pxt4_doubÀ_up_wrôe_d©a_£m
(
‹ig_öode
, 
d⁄‹_öode
);

696 
	`u∆ock_two_n⁄dúe˘‹õs
(
‹ig_öode
, 
d⁄‹_öode
);

698  
ªt
;

699 
	}
}

	@namei.c

28 
	~<löux/fs.h
>

29 
	~<löux/∑gem≠.h
>

30 
	~<löux/time.h
>

31 
	~<löux/f˙é.h
>

32 
	~<löux/°©.h
>

33 
	~<löux/°rög.h
>

34 
	~<löux/quŸa›s.h
>

35 
	~<löux/buf„r_hód.h
>

36 
	~<löux/bio.h
>

37 
	~<löux/ivîsi⁄.h
>

38 
	~<löux/unicode.h
>

39 
	~"pxt4.h
"

40 
	~"pxt4_jbd3.h
"

42 
	~"x©å.h
"

43 
	~"a˛.h
"

45 
	~<åa˚/evíts/pxt4.h
>

49 
	#NAMEI_RA_CHUNKS
 2

	)

50 
	#NAMEI_RA_BLOCKS
 4

	)

51 
	#NAMEI_RA_SIZE
 (
NAMEI_RA_CHUNKS
 * 
NAMEI_RA_BLOCKS
)

	)

53 
buf„r_hód
 *
	$pxt4_≠≥nd
(
h™dÀ_t
 *
h™dÀ
,

54 
öode
 *inode,

55 
pxt4_lblk_t
 *
block
)

57 
buf„r_hód
 *
bh
;

58 
îr
;

60 i‡(
	`u∆ikñy
(
	`PXT4_SB
(
öode
->
i_sb
)->
s_max_dú_size_kb
 &&

61 ((
öode
->
i_size
 >> 10) >=

62 
	`PXT4_SB
(
öode
->
i_sb
)->
s_max_dú_size_kb
)))

63  
	`ERR_PTR
(-
ENOSPC
);

65 *
block
 = 
öode
->
i_size
 >> inode->
i_sb
->
s_blocksize_bôs
;

67 
bh
 = 
	`pxt4_bªad
(
h™dÀ
, 
öode
, *
block
, 
PXT4_GET_BLOCKS_CREATE
);

68 i‡(
	`IS_ERR
(
bh
))

69  
bh
;

70 
öode
->
i_size
 +öode->
i_sb
->
s_blocksize
;

71 
	`PXT4_I
(
öode
)->
i_disksize
 = inode->
i_size
;

72 
	`BUFFER_TRACE
(
bh
, "get_write_access");

73 
îr
 = 
	`pxt4_jou∫Æ_gë_wrôe_ac˚ss
(
h™dÀ
, 
bh
);

74 i‡(
îr
) {

75 
	`bªl£
(
bh
);

76 
	`pxt4_°d_îr‹
(
öode
->
i_sb
, 
îr
);

77  
	`ERR_PTR
(
îr
);

79  
bh
;

80 
	}
}

82 
pxt4_dx_csum_vîify
(
öode
 *inode,

83 
pxt4_dú_íåy
 *
dúít
);

96 
	mEITHER
, 
	mINDEX
, 
	mDIRENT
, 
	mDIRENT_HTREE


97 } 
	tdúblock_ty≥_t
;

99 
	#pxt4_ªad_dúblock
(
öode
, 
block
, 
ty≥
) \

100 
	`__pxt4_ªad_dúblock
((
öode
), (
block
), (
ty≥
), 
__func__
, 
__LINE__
)

	)

102 
buf„r_hód
 *
	$__pxt4_ªad_dúblock
(
öode
 *inode,

103 
pxt4_lblk_t
 
block
,

104 
dúblock_ty≥_t
 
ty≥
,

105 c⁄° *
func
,

106 
löe
)

108 
buf„r_hód
 *
bh
;

109 
pxt4_dú_íåy
 *
dúít
;

110 
is_dx_block
 = 0;

112 
bh
 = 
	`pxt4_bªad
(
NULL
, 
öode
, 
block
, 0);

113 i‡(
	`IS_ERR
(
bh
)) {

114 
	`__pxt4_w¨nög
(
öode
->
i_sb
, 
func
, 
löe
,

117 
öode
->
i_öo
, ()
block
,

118 
cuºít
->
comm
, 
	`PTR_ERR
(
bh
));

120  
bh
;

122 i‡(!
bh
 && (
ty≥
 =
INDEX
 ||Åy≥ =
DIRENT_HTREE
)) {

123 
	`pxt4_îr‹_öode
(
öode
, 
func
, 
löe
, 
block
,

125 (
ty≥
 =
INDEX
) ? "index" : "leaf");

126  
	`ERR_PTR
(-
EFSCORRUPTED
);

128 i‡(!
bh
)

129  
NULL
;

130 
dúít
 = (
pxt4_dú_íåy
 *Ë
bh
->
b_d©a
;

132 i‡(
	`is_dx
(
öode
)) {

133 i‡(
block
 == 0)

134 
is_dx_block
 = 1;

135 i‡(
	`pxt4_ªc_Àn_‰om_disk
(
dúít
->
ªc_Àn
,

136 
öode
->
i_sb
->
s_blocksize
) ==

137 
öode
->
i_sb
->
s_blocksize
)

138 
is_dx_block
 = 1;

140 i‡(!
is_dx_block
 && 
ty≥
 =
INDEX
) {

141 
	`pxt4_îr‹_öode
(
öode
, 
func
, 
löe
, 
block
,

143 
	`bªl£
(
bh
);

144  
	`ERR_PTR
(-
EFSCORRUPTED
);

146 i‡(!
	`pxt4_has_mëad©a_csum
(
öode
->
i_sb
) ||

147 
	`buf„r_vîifõd
(
bh
))

148  
bh
;

155 i‡(
is_dx_block
 && 
ty≥
 =
INDEX
) {

156 i‡(
	`pxt4_dx_csum_vîify
(
öode
, 
dúít
))

157 
	`£t_buf„r_vîifõd
(
bh
);

159 
	`pxt4_îr‹_öode
(
öode
, 
func
, 
löe
, 
block
,

161 
	`bªl£
(
bh
);

162  
	`ERR_PTR
(-
EFSBADCRC
);

165 i‡(!
is_dx_block
) {

166 i‡(
	`pxt4_dúblock_csum_vîify
(
öode
, 
bh
))

167 
	`£t_buf„r_vîifõd
(
bh
);

169 
	`pxt4_îr‹_öode
(
öode
, 
func
, 
löe
, 
block
,

171 
	`bªl£
(
bh
);

172  
	`ERR_PTR
(-
EFSBADCRC
);

175  
bh
;

176 
	}
}

178 #i‚de‡
as£π


179 
	#as£π
(
ã°
Ë
	`J_ASSERT
—e°)

	)

182 #ifde‡
DX_DEBUG


183 
	#dxåa˚
(
comm™d
Ë
	)
command

185 
	#dxåa˚
(
comm™d
)

	)

188 
	sÁke_dúít


190 
__À32
 
	möode
;

191 
__À16
 
	mªc_Àn
;

192 
u8
 
	m«me_Àn
;

193 
u8
 
	mfûe_ty≥
;

196 
	sdx_cou¡limô


198 
__À16
 
	mlimô
;

199 
__À16
 
	mcou¡
;

202 
	sdx_íåy


204 
__À32
 
	mhash
;

205 
__À32
 
	mblock
;

214 
	sdx_roŸ


216 
Áke_dúít
 
	mdŸ
;

217 
	mdŸ_«me
[4];

218 
Áke_dúít
 
	mdŸdŸ
;

219 
	mdŸdŸ_«me
[4];

220 
	sdx_roŸ_öfo


222 
__À32
 
	mª£rved_zîo
;

223 
u8
 
	mhash_vîsi⁄
;

224 
u8
 
	möfo_Àngth
;

225 
u8
 
	mödúe˘_Àvñs
;

226 
u8
 
	munu£d_Êags
;

228 
	möfo
;

229 
dx_íåy
 
	míåõs
[0];

232 
	sdx_node


234 
Áke_dúít
 
	mÁke
;

235 
dx_íåy
 
	míåõs
[0];

239 
	sdx_‰ame


241 
buf„r_hód
 *
	mbh
;

242 
dx_íåy
 *
	míåõs
;

243 
dx_íåy
 *
	m©
;

246 
	sdx_m≠_íåy


248 
u32
 
	mhash
;

249 
u16
 
	moffs
;

250 
u16
 
	msize
;

256 
	sdx_èû
 {

257 
u32
 
	mdt_ª£rved
;

258 
__À32
 
	mdt_checksum
;

261 
ölöe
 
pxt4_lblk_t
 
dx_gë_block
(
dx_íåy
 *
íåy
);

262 
dx_£t_block
(
dx_íåy
 *
íåy
, 
pxt4_lblk_t
 
vÆue
);

263 
ölöe
 
dx_gë_hash
(
dx_íåy
 *
íåy
);

264 
dx_£t_hash
(
dx_íåy
 *
íåy
, 
vÆue
);

265 
dx_gë_cou¡
(
dx_íåy
 *
íåõs
);

266 
dx_gë_limô
(
dx_íåy
 *
íåõs
);

267 
dx_£t_cou¡
(
dx_íåy
 *
íåõs
, 
vÆue
);

268 
dx_£t_limô
(
dx_íåy
 *
íåõs
, 
vÆue
);

269 
dx_roŸ_limô
(
öode
 *
dú
, 
öfosize
);

270 
dx_node_limô
(
öode
 *
dú
);

271 
dx_‰ame
 *
dx_¥obe
(
pxt4_fûíame
 *
‚ame
,

272 
öode
 *
dú
,

273 
dx_hash_öfo
 *
höfo
,

274 
dx_‰ame
 *
‰ame
);

275 
dx_ªÀa£
(
dx_‰ame
 *
‰ames
);

276 
dx_make_m≠
(
öode
 *
dú
, 
pxt4_dú_íåy_2
 *
de
,

277 
blocksize
, 
dx_hash_öfo
 *
höfo
,

278 
dx_m≠_íåy
 
m≠
[]);

279 
dx_s‹t_m≠
(
dx_m≠_íåy
 *
m≠
, 
cou¡
);

280 
pxt4_dú_íåy_2
 *
dx_move_dúíts
(*
‰om
, *
to
,

281 
dx_m≠_íåy
 *
off£ts
, 
cou¡
, 
blocksize
);

282 
pxt4_dú_íåy_2
* 
dx_∑ck_dúíts
(*
ba£
, 
blocksize
);

283 
dx_ö£π_block
(
dx_‰ame
 *
‰ame
,

284 
u32
 
hash
, 
pxt4_lblk_t
 
block
);

285 
pxt4_håì_√xt_block
(
öode
 *
dú
, 
__u32
 
hash
,

286 
dx_‰ame
 *
‰ame
,

287 
dx_‰ame
 *
‰ames
,

288 
__u32
 *
°¨t_hash
);

289 
buf„r_hód
 * 
pxt4_dx_föd_íåy
(
öode
 *
dú
,

290 
pxt4_fûíame
 *
‚ame
,

291 
pxt4_dú_íåy_2
 **
ªs_dú
);

292 
pxt4_dx_add_íåy
(
h™dÀ_t
 *
h™dÀ
, 
pxt4_fûíame
 *
‚ame
,

293 
öode
 *
dú
, inode *inode);

296 
	$pxt4_öôülize_dúít_èû
(
buf„r_hód
 *
bh
,

297 
blocksize
)

299 
pxt4_dú_íåy_èû
 *
t
 = 
	`PXT4_DIRENT_TAIL
(
bh
->
b_d©a
, 
blocksize
);

301 
	`mem£t
(
t
, 0, (
pxt4_dú_íåy_èû
));

302 
t
->
dë_ªc_Àn
 = 
	`pxt4_ªc_Àn_to_disk
(

303 (
pxt4_dú_íåy_èû
), 
blocksize
);

304 
t
->
dë_ª£rved_·
 = 
PXT4_FT_DIR_CSUM
;

305 
	}
}

308 
pxt4_dú_íåy_èû
 *
	$gë_dúít_èû
(
öode
 *inode,

309 
buf„r_hód
 *
bh
)

311 
pxt4_dú_íåy_èû
 *
t
;

313 #ifde‡
PARANOID


314 
pxt4_dú_íåy
 *
d
, *
t›
;

316 
d
 = (
pxt4_dú_íåy
 *)
bh
->
b_d©a
;

317 
t›
 = (
pxt4_dú_íåy
 *)(
bh
->
b_d©a
 +

318 (
	`PXT4_BLOCK_SIZE
(
öode
->
i_sb
) -

319 (
pxt4_dú_íåy_èû
)));

320 
d
 < 
t›
 && d->
ªc_Àn
)

321 
d
 = (
pxt4_dú_íåy
 *)(((*)d) +

322 
	`À16_to_˝u
(
d
->
ªc_Àn
));

324 i‡(
d
 !
t›
)

325  
NULL
;

327 
t
 = (
pxt4_dú_íåy_èû
 *)
d
;

329 
t
 = 
	`PXT4_DIRENT_TAIL
(
bh
->
b_d©a
, 
	`PXT4_BLOCK_SIZE
(
öode
->
i_sb
));

332 i‡(
t
->
dë_ª£rved_zîo1
 ||

333 
	`À16_to_˝u
(
t
->
dë_ªc_Àn
Ë!(
pxt4_dú_íåy_èû
) ||

334 
t
->
dë_ª£rved_zîo2
 ||

335 
t
->
dë_ª£rved_·
 !
PXT4_FT_DIR_CSUM
)

336  
NULL
;

338  
t
;

339 
	}
}

341 
__À32
 
	$pxt4_dúblock_csum
(
öode
 *öode, *
dúít
, 
size
)

343 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
öode
->
i_sb
);

344 
pxt4_öode_öfo
 *
ei
 = 
	`PXT4_I
(
öode
);

345 
__u32
 
csum
;

347 
csum
 = 
	`pxt4_chksum
(
sbi
, 
ei
->
i_csum_£ed
, (
__u8
 *)
dúít
, 
size
);

348  
	`˝u_to_À32
(
csum
);

349 
	}
}

351 
	#w¨n_no_•a˚_f‹_csum
(
öode
) \

352 
	`__w¨n_no_•a˚_f‹_csum
((
öode
), 
__func__
, 
__LINE__
)

	)

354 
	$__w¨n_no_•a˚_f‹_csum
(
öode
 *öode, c⁄° *
func
,

355 
löe
)

357 
	`__pxt4_w¨nög_öode
(
öode
, 
func
, 
löe
,

359 
	}
}

361 
	$pxt4_dúblock_csum_vîify
(
öode
 *öode, 
buf„r_hód
 *
bh
)

363 
pxt4_dú_íåy_èû
 *
t
;

365 i‡(!
	`pxt4_has_mëad©a_csum
(
öode
->
i_sb
))

368 
t
 = 
	`gë_dúít_èû
(
öode
, 
bh
);

369 i‡(!
t
) {

370 
	`w¨n_no_•a˚_f‹_csum
(
öode
);

374 i‡(
t
->
dë_checksum
 !
	`pxt4_dúblock_csum
(
öode
, 
bh
->
b_d©a
,

375 (*)
t
 - 
bh
->
b_d©a
))

379 
	}
}

381 
	$pxt4_dúblock_csum_£t
(
öode
 *inode,

382 
buf„r_hód
 *
bh
)

384 
pxt4_dú_íåy_èû
 *
t
;

386 i‡(!
	`pxt4_has_mëad©a_csum
(
öode
->
i_sb
))

389 
t
 = 
	`gë_dúít_èû
(
öode
, 
bh
);

390 i‡(!
t
) {

391 
	`w¨n_no_•a˚_f‹_csum
(
öode
);

395 
t
->
dë_checksum
 = 
	`pxt4_dúblock_csum
(
öode
, 
bh
->
b_d©a
,

396 (*)
t
 - 
bh
->
b_d©a
);

397 
	}
}

399 
	$pxt4_h™dÀ_dúty_dúblock
(
h™dÀ_t
 *
h™dÀ
,

400 
öode
 *inode,

401 
buf„r_hód
 *
bh
)

403 
	`pxt4_dúblock_csum_£t
(
öode
, 
bh
);

404  
	`pxt4_h™dÀ_dúty_mëad©a
(
h™dÀ
, 
öode
, 
bh
);

405 
	}
}

407 
dx_cou¡limô
 *
	$gë_dx_cou¡limô
(
öode
 *inode,

408 
pxt4_dú_íåy
 *
dúít
,

409 *
off£t
)

411 
pxt4_dú_íåy
 *
dp
;

412 
dx_roŸ_öfo
 *
roŸ
;

413 
cou¡_off£t
;

415 i‡(
	`À16_to_˝u
(
dúít
->
ªc_Àn
Ë=
	`PXT4_BLOCK_SIZE
(
öode
->
i_sb
))

416 
cou¡_off£t
 = 8;

417 i‡(
	`À16_to_˝u
(
dúít
->
ªc_Àn
) == 12) {

418 
dp
 = (
pxt4_dú_íåy
 *)(((*)
dúít
) + 12);

419 i‡(
	`À16_to_˝u
(
dp
->
ªc_Àn
) !=

420 
	`PXT4_BLOCK_SIZE
(
öode
->
i_sb
) - 12)

421  
NULL
;

422 
roŸ
 = (
dx_roŸ_öfo
 *)(((*)
dp
 + 12));

423 i‡(
roŸ
->
ª£rved_zîo
 ||

424 
roŸ
->
öfo_Àngth
 !(
dx_roŸ_öfo
))

425  
NULL
;

426 
cou¡_off£t
 = 32;

428  
NULL
;

430 i‡(
off£t
)

431 *
off£t
 = 
cou¡_off£t
;

432  (
dx_cou¡limô
 *)(((*)
dúít
Ë+ 
cou¡_off£t
);

433 
	}
}

435 
__À32
 
	$pxt4_dx_csum
(
öode
 *öode, 
pxt4_dú_íåy
 *
dúít
,

436 
cou¡_off£t
, 
cou¡
, 
dx_èû
 *
t
)

438 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
öode
->
i_sb
);

439 
pxt4_öode_öfo
 *
ei
 = 
	`PXT4_I
(
öode
);

440 
__u32
 
csum
;

441 
size
;

442 
__u32
 
dummy_csum
 = 0;

443 
off£t
 = 
	`off£tof
(
dx_èû
, 
dt_checksum
);

445 
size
 = 
cou¡_off£t
 + (
cou¡
 * (
dx_íåy
));

446 
csum
 = 
	`pxt4_chksum
(
sbi
, 
ei
->
i_csum_£ed
, (
__u8
 *)
dúít
, 
size
);

447 
csum
 = 
	`pxt4_chksum
(
sbi
, csum, (
__u8
 *)
t
, 
off£t
);

448 
csum
 = 
	`pxt4_chksum
(
sbi
, csum, (
__u8
 *)&
dummy_csum
, (dummy_csum));

450  
	`˝u_to_À32
(
csum
);

451 
	}
}

453 
	$pxt4_dx_csum_vîify
(
öode
 *inode,

454 
pxt4_dú_íåy
 *
dúít
)

456 
dx_cou¡limô
 *
c
;

457 
dx_èû
 *
t
;

458 
cou¡_off£t
, 
limô
, 
cou¡
;

460 i‡(!
	`pxt4_has_mëad©a_csum
(
öode
->
i_sb
))

463 
c
 = 
	`gë_dx_cou¡limô
(
öode
, 
dúít
, &
cou¡_off£t
);

464 i‡(!
c
) {

465 
	`PXT4_ERROR_INODE
(
öode
, "dir seems corrupt? RunÉ2fsck -D.");

468 
limô
 = 
	`À16_to_˝u
(
c
->limit);

469 
cou¡
 = 
	`À16_to_˝u
(
c
->count);

470 i‡(
cou¡_off£t
 + (
limô
 * (
dx_íåy
)) >

471 
	`PXT4_BLOCK_SIZE
(
öode
->
i_sb
Ë- (
dx_èû
)) {

472 
	`w¨n_no_•a˚_f‹_csum
(
öode
);

475 
t
 = (
dx_èû
 *)(((
dx_íåy
 *)
c
Ë+ 
limô
);

477 i‡(
t
->
dt_checksum
 !
	`pxt4_dx_csum
(
öode
, 
dúít
, 
cou¡_off£t
,

478 
cou¡
, 
t
))

481 
	}
}

483 
	$pxt4_dx_csum_£t
(
öode
 *öode, 
pxt4_dú_íåy
 *
dúít
)

485 
dx_cou¡limô
 *
c
;

486 
dx_èû
 *
t
;

487 
cou¡_off£t
, 
limô
, 
cou¡
;

489 i‡(!
	`pxt4_has_mëad©a_csum
(
öode
->
i_sb
))

492 
c
 = 
	`gë_dx_cou¡limô
(
öode
, 
dúít
, &
cou¡_off£t
);

493 i‡(!
c
) {

494 
	`PXT4_ERROR_INODE
(
öode
, "dir seems corrupt? RunÉ2fsck -D.");

497 
limô
 = 
	`À16_to_˝u
(
c
->limit);

498 
cou¡
 = 
	`À16_to_˝u
(
c
->count);

499 i‡(
cou¡_off£t
 + (
limô
 * (
dx_íåy
)) >

500 
	`PXT4_BLOCK_SIZE
(
öode
->
i_sb
Ë- (
dx_èû
)) {

501 
	`w¨n_no_•a˚_f‹_csum
(
öode
);

504 
t
 = (
dx_èû
 *)(((
dx_íåy
 *)
c
Ë+ 
limô
);

506 
t
->
dt_checksum
 = 
	`pxt4_dx_csum
(
öode
, 
dúít
, 
cou¡_off£t
, 
cou¡
,Å);

507 
	}
}

509 
ölöe
 
	$pxt4_h™dÀ_dúty_dx_node
(
h™dÀ_t
 *
h™dÀ
,

510 
öode
 *inode,

511 
buf„r_hód
 *
bh
)

513 
	`pxt4_dx_csum_£t
(
öode
, (
pxt4_dú_íåy
 *)
bh
->
b_d©a
);

514  
	`pxt4_h™dÀ_dúty_mëad©a
(
h™dÀ
, 
öode
, 
bh
);

515 
	}
}

520 
ölöe
 
pxt4_dú_íåy_2
 *

521 
	$pxt4_√xt_íåy
(
pxt4_dú_íåy_2
 *
p
, 
blocksize
)

523  (
pxt4_dú_íåy_2
 *)((*)
p
 +

524 
	`pxt4_ªc_Àn_‰om_disk
(
p
->
ªc_Àn
, 
blocksize
));

525 
	}
}

532 
ölöe
 
pxt4_lblk_t
 
	$dx_gë_block
(
dx_íåy
 *
íåy
)

534  
	`À32_to_˝u
(
íåy
->
block
) & 0x0fffffff;

535 
	}
}

537 
ölöe
 
	$dx_£t_block
(
dx_íåy
 *
íåy
, 
pxt4_lblk_t
 
vÆue
)

539 
íåy
->
block
 = 
	`˝u_to_À32
(
vÆue
);

540 
	}
}

542 
ölöe
 
	$dx_gë_hash
(
dx_íåy
 *
íåy
)

544  
	`À32_to_˝u
(
íåy
->
hash
);

545 
	}
}

547 
ölöe
 
	$dx_£t_hash
(
dx_íåy
 *
íåy
, 
vÆue
)

549 
íåy
->
hash
 = 
	`˝u_to_À32
(
vÆue
);

550 
	}
}

552 
ölöe
 
	$dx_gë_cou¡
(
dx_íåy
 *
íåõs
)

554  
	`À16_to_˝u
(((
dx_cou¡limô
 *Ë
íåõs
)->
cou¡
);

555 
	}
}

557 
ölöe
 
	$dx_gë_limô
(
dx_íåy
 *
íåõs
)

559  
	`À16_to_˝u
(((
dx_cou¡limô
 *Ë
íåõs
)->
limô
);

560 
	}
}

562 
ölöe
 
	$dx_£t_cou¡
(
dx_íåy
 *
íåõs
, 
vÆue
)

564 ((
dx_cou¡limô
 *Ë
íåõs
)->
cou¡
 = 
	`˝u_to_À16
(
vÆue
);

565 
	}
}

567 
ölöe
 
	$dx_£t_limô
(
dx_íåy
 *
íåõs
, 
vÆue
)

569 ((
dx_cou¡limô
 *Ë
íåõs
)->
limô
 = 
	`˝u_to_À16
(
vÆue
);

570 
	}
}

572 
ölöe
 
	$dx_roŸ_limô
(
öode
 *
dú
, 
öfosize
)

574 
íåy_•a˚
 = 
dú
->
i_sb
->
s_blocksize
 - 
	`PXT4_DIR_REC_LEN
(1) -

575 
	`PXT4_DIR_REC_LEN
(2Ë- 
öfosize
;

577 i‡(
	`pxt4_has_mëad©a_csum
(
dú
->
i_sb
))

578 
íåy_•a˚
 -(
dx_èû
);

579  
íåy_•a˚
 / (
dx_íåy
);

580 
	}
}

582 
ölöe
 
	$dx_node_limô
(
öode
 *
dú
)

584 
íåy_•a˚
 = 
dú
->
i_sb
->
s_blocksize
 - 
	`PXT4_DIR_REC_LEN
(0);

586 i‡(
	`pxt4_has_mëad©a_csum
(
dú
->
i_sb
))

587 
íåy_•a˚
 -(
dx_èû
);

588  
íåy_•a˚
 / (
dx_íåy
);

589 
	}
}

594 #ifde‡
DX_DEBUG


595 
	$dx_show_ödex
(* 
œbñ
, 
dx_íåy
 *
íåõs
)

597 
i
, 
n
 = 
	`dx_gë_cou¡
 (
íåõs
);

598 
	`¥ötk
(
KERN_DEBUG
 "%†ödex", 
œbñ
);

599 
i
 = 0; i < 
n
; i++) {

600 
	`¥ötk
(
KERN_CONT
 " %x->%lu",

601 
i
 ? 
	`dx_gë_hash
(
íåõs
 + i) : 0,

602 ()
	`dx_gë_block
(
íåõs
 + 
i
));

604 
	`¥ötk
(
KERN_CONT
 "\n");

605 
	}
}

607 
	s°©s


609 
	m«mes
;

610 
	m•a˚
;

611 
	mbcou¡
;

614 
°©s
 
	$dx_show_Àaf
(
öode
 *
dú
,

615 
dx_hash_öfo
 *
höfo
,

616 
pxt4_dú_íåy_2
 *
de
,

617 
size
, 
show_«mes
)

619 
«mes
 = 0, 
•a˚
 = 0;

620 *
ba£
 = (*Ë
de
;

621 
dx_hash_öfo
 
h
 = *
höfo
;

623 
	`¥ötk
("names: ");

624 (*Ë
de
 < 
ba£
 + 
size
)

626 i‡(
de
->
öode
)

628 i‡(
show_«mes
)

630 #ifde‡
CONFIG_FS_ENCRYPTION


631 
Àn
;

632 *
«me
;

633 
fs¸y±_°r
 
‚ame_¸y±o_°r
 =

634 
	`FSTR_INIT
(
NULL
, 0);

635 
ªs
 = 0;

637 
«me
 = 
de
->name;

638 
Àn
 = 
de
->
«me_Àn
;

639 i‡(
	`IS_ENCRYPTED
(
dú
))

640 
ªs
 = 
	`fs¸y±_gë_í¸y±i⁄_öfo
(
dú
);

641 i‡(
ªs
) {

642 
	`¥ötk
(
KERN_WARNING
 "Error setting up"

643 " f«mê¸y±o: %d\n", 
ªs
);

645 i‡(!
	`fs¸y±_has_í¸y±i⁄_key
(
dú
)) {

647 
	`pxt4fs_dúhash
(
dú
, 
de
->
«me
,

648 
de
->
«me_Àn
, &
h
);

649 
	`¥ötk
("%*.s:(U)%x.%u ", 
Àn
,

650 
«me
, 
h
.
hash
,

651 (Ë((*Ë
de


652 - 
ba£
));

654 
fs¸y±_°r
 
de_«me
 =

655 
	`FSTR_INIT
(
«me
, 
Àn
);

658 
ªs
 = 
	`fs¸y±_‚ame_Æloc_buf„r
(

659 
dú
, 
Àn
,

660 &
‚ame_¸y±o_°r
);

661 i‡(
ªs
)

662 
	`¥ötk
(
KERN_WARNING
 "Error "

666 
ªs
 = 
	`fs¸y±_‚ame_disk_to_u§
(
dú
,

667 0, 0, &
de_«me
,

668 &
‚ame_¸y±o_°r
);

669 i‡(
ªs
) {

670 
	`¥ötk
(
KERN_WARNING
 "Error "

674 
«me
 = "??";

675 
Àn
 = 2;

677 
«me
 = 
‚ame_¸y±o_°r
.name;

678 
Àn
 = 
‚ame_¸y±o_°r
.len;

680 
	`pxt4fs_dúhash
(
dú
, 
de
->
«me
,

681 
de
->
«me_Àn
, &
h
);

682 
	`¥ötk
("%*.s:(E)%x.%u ", 
Àn
, 
«me
,

683 
h
.
hash
, (Ë((*Ë
de


684 - 
ba£
));

685 
	`fs¸y±_‚ame_‰ì_buf„r
(

686 &
‚ame_¸y±o_°r
);

689 
Àn
 = 
de
->
«me_Àn
;

690 *
«me
 = 
de
->name;

691 
	`pxt4fs_dúhash
(
dú
, 
de
->
«me
, de->
«me_Àn
, &
h
);

692 
	`¥ötk
("%*.s:%x.%u ", 
Àn
, 
«me
, 
h
.
hash
,

693 (Ë((*Ë
de
 - 
ba£
));

696 
•a˚
 +
	`PXT4_DIR_REC_LEN
(
de
->
«me_Àn
);

697 
«mes
++;

699 
de
 = 
	`pxt4_√xt_íåy
(de, 
size
);

701 
	`¥ötk
(
KERN_CONT
 "(%i)\n", 
«mes
);

702  (
°©s
Ë{ 
«mes
, 
•a˚
, 1 };

703 
	}
}

705 
°©s
 
	$dx_show_íåõs
(
dx_hash_öfo
 *
höfo
, 
öode
 *
dú
,

706 
dx_íåy
 *
íåõs
, 
Àvñs
)

708 
blocksize
 = 
dú
->
i_sb
->
s_blocksize
;

709 
cou¡
 = 
	`dx_gë_cou¡
(
íåõs
), 
«mes
 = 0, 
•a˚
 = 0, 
i
;

710 
bcou¡
 = 0;

711 
buf„r_hód
 *
bh
;

712 
	`¥ötk
("%òödexed blocks...\n", 
cou¡
);

713 
i
 = 0; i < 
cou¡
; i++, 
íåõs
++)

715 
pxt4_lblk_t
 
block
 = 
	`dx_gë_block
(
íåõs
);

716 
pxt4_lblk_t
 
hash
 = 
i
 ? 
	`dx_gë_hash
(
íåõs
): 0;

717 
u32
 
ønge
 = 
i
 < 
cou¡
 - 1? (
	`dx_gë_hash
(
íåõs
 + 1Ë- 
hash
): ~hash;

718 
°©s
 stats;

719 
	`¥ötk
("%s%3u:%03u hash %8x/%8x ",
Àvñs
?"":" ", 
i
, 
block
, 
hash
, 
ønge
);

720 
bh
 = 
	`pxt4_bªad
(
NULL
,
dú
, 
block
, 0);

721 i‡(!
bh
 || 
	`IS_ERR
(bh))

723 
°©s
 = 
Àvñs
?

724 
	`dx_show_íåõs
(
höfo
, 
dú
, ((
dx_node
 *Ë
bh
->
b_d©a
)->
íåõs
, 
Àvñs
 - 1):

725 
	`dx_show_Àaf
(
dú
, 
höfo
, (
pxt4_dú_íåy_2
 *)

726 
bh
->
b_d©a
, 
blocksize
, 0);

727 
«mes
 +
°©s
.names;

728 
•a˚
 +
°©s
.space;

729 
bcou¡
 +
°©s
.bcount;

730 
	`bªl£
(
bh
);

732 i‡(
bcou¡
)

733 
	`¥ötk
(
KERN_DEBUG
 "%snames %u, fullness %u (%u%%)\n",

734 
Àvñs
 ? "" : " ", 
«mes
, 
•a˚
/
bcou¡
,

735 (
•a˚
/
bcou¡
)*100/
blocksize
);

736  (
°©s
Ë{ 
«mes
, 
•a˚
, 
bcou¡
};

737 
	}
}

749 
dx_‰ame
 *

750 
	$dx_¥obe
(
pxt4_fûíame
 *
‚ame
, 
öode
 *
dú
,

751 
dx_hash_öfo
 *
höfo
, 
dx_‰ame
 *
‰ame_ö
)

753 
cou¡
, 
ödúe˘
;

754 
dx_íåy
 *
©
, *
íåõs
, *
p
, *
q
, *
m
;

755 
dx_roŸ
 *
roŸ
;

756 
dx_‰ame
 *
‰ame
 = 
‰ame_ö
;

757 
dx_‰ame
 *
ªt_îr
 = 
	`ERR_PTR
(
ERR_BAD_DX_DIR
);

758 
u32
 
hash
;

760 
	`mem£t
(
‰ame_ö
, 0, 
PXT4_HTREE_LEVEL
 * (frame_in[0]));

761 
‰ame
->
bh
 = 
	`pxt4_ªad_dúblock
(
dú
, 0, 
INDEX
);

762 i‡(
	`IS_ERR
(
‰ame
->
bh
))

763  (
dx_‰ame
 *Ë
‰ame
->
bh
;

765 
roŸ
 = (
dx_roŸ
 *Ë
‰ame
->
bh
->
b_d©a
;

766 i‡(
roŸ
->
öfo
.
hash_vîsi⁄
 !
DX_HASH_TEA
 &&

767 
roŸ
->
öfo
.
hash_vîsi⁄
 !
DX_HASH_HALF_MD4
 &&

768 
roŸ
->
öfo
.
hash_vîsi⁄
 !
DX_HASH_LEGACY
) {

769 
	`pxt4_w¨nög_öode
(
dú
, "Unrecognised inode hash code %u",

770 
roŸ
->
öfo
.
hash_vîsi⁄
);

771 
Áû
;

773 i‡(
‚ame
)

774 
höfo
 = &
‚ame
->hinfo;

775 
höfo
->
hash_vîsi⁄
 = 
roŸ
->
öfo
.hash_version;

776 i‡(
höfo
->
hash_vîsi⁄
 <
DX_HASH_TEA
)

777 
höfo
->
hash_vîsi⁄
 +
	`PXT4_SB
(
dú
->
i_sb
)->
s_hash_unsig√d
;

778 
höfo
->
£ed
 = 
	`PXT4_SB
(
dú
->
i_sb
)->
s_hash_£ed
;

779 i‡(
‚ame
 && 
	`‚ame_«me
(fname))

780 
	`pxt4fs_dúhash
(
dú
, 
	`‚ame_«me
(
‚ame
), 
	`‚ame_Àn
(‚ame), 
höfo
);

781 
hash
 = 
höfo
->hash;

783 i‡(
roŸ
->
öfo
.
unu£d_Êags
 & 1) {

784 
	`pxt4_w¨nög_öode
(
dú
, "Unimplemented hash flags: %#06x",

785 
roŸ
->
öfo
.
unu£d_Êags
);

786 
Áû
;

789 
ödúe˘
 = 
roŸ
->
öfo
.
ödúe˘_Àvñs
;

790 i‡(
ödúe˘
 >
	`pxt4_dú_håì_Àvñ
(
dú
->
i_sb
)) {

791 
	`pxt4_w¨nög
(
dú
->
i_sb
,

793 "suµ‹ãd vÆue", 
dú
->
i_öo
,

794 
	`pxt4_dú_håì_Àvñ
(
dú
->
i_sb
));

795 i‡(
	`pxt4_dú_håì_Àvñ
(
dú
->
i_sb
Ë< 
PXT4_HTREE_LEVEL
) {

796 
	`pxt4_w¨nög
(
dú
->
i_sb
, "EnableÜarge directory "

799 
Áû
;

802 
íåõs
 = (
dx_íåy
 *)(((*)&
roŸ
->
öfo
) +

803 
roŸ
->
öfo
.
öfo_Àngth
);

805 i‡(
	`dx_gë_limô
(
íåõs
Ë!
	`dx_roŸ_limô
(
dú
,

806 
roŸ
->
öfo
.
öfo_Àngth
)) {

807 
	`pxt4_w¨nög_öode
(
dú
, "dxÉntry:Üimit %u !=ÑootÜimit %u",

808 
	`dx_gë_limô
(
íåõs
),

809 
	`dx_roŸ_limô
(
dú
, 
roŸ
->
öfo
.
öfo_Àngth
));

810 
Áû
;

813 
	`dxåa˚
(
	`¥ötk
("Look u∞%x", 
hash
));

815 
cou¡
 = 
	`dx_gë_cou¡
(
íåõs
);

816 i‡(!
cou¡
 || cou¡ > 
	`dx_gë_limô
(
íåõs
)) {

817 
	`pxt4_w¨nög_öode
(
dú
,

819 
cou¡
, 
	`dx_gë_limô
(
íåõs
));

820 
Áû
;

823 
p
 = 
íåõs
 + 1;

824 
q
 = 
íåõs
 + 
cou¡
 - 1;

825 
p
 <
q
) {

826 
m
 = 
p
 + (
q
 -Ö) / 2;

827 
	`dxåa˚
(
	`¥ötk
(
KERN_CONT
 "."));

828 i‡(
	`dx_gë_hash
(
m
Ë> 
hash
)

829 
q
 = 
m
 - 1;

831 
p
 = 
m
 + 1;

835 
n
 = 
cou¡
 - 1;

836 
©
 = 
íåõs
;

837 
n
--)

839 
	`dxåa˚
(
	`¥ötk
(
KERN_CONT
 ","));

840 i‡(
	`dx_gë_hash
(++
©
Ë> 
hash
)

842 
©
--;

846 
	`as£π
 (
©
 =
p
 - 1);

849 
©
 = 
p
 - 1;

850 
	`dxåa˚
(
	`¥ötk
(
KERN_CONT
 " %x->%u\n",

851 
©
 =
íåõs
 ? 0 : 
	`dx_gë_hash
(at),

852 
	`dx_gë_block
(
©
)));

853 
‰ame
->
íåõs
 =Éntries;

854 
‰ame
->
©
 =át;

855 i‡(!
ödúe˘
--)

856  
‰ame
;

857 
‰ame
++;

858 
‰ame
->
bh
 = 
	`pxt4_ªad_dúblock
(
dú
, 
	`dx_gë_block
(
©
), 
INDEX
);

859 i‡(
	`IS_ERR
(
‰ame
->
bh
)) {

860 
ªt_îr
 = (
dx_‰ame
 *Ë
‰ame
->
bh
;

861 
‰ame
->
bh
 = 
NULL
;

862 
Áû
;

864 
íåõs
 = ((
dx_node
 *Ë
‰ame
->
bh
->
b_d©a
)->entries;

866 i‡(
	`dx_gë_limô
(
íåõs
Ë!
	`dx_node_limô
(
dú
)) {

867 
	`pxt4_w¨nög_öode
(
dú
,

869 
	`dx_gë_limô
(
íåõs
), 
	`dx_node_limô
(
dú
));

870 
Áû
;

873 
Áû
:

874 
‰ame
 >
‰ame_ö
) {

875 
	`bªl£
(
‰ame
->
bh
);

876 
‰ame
--;

879 i‡(
ªt_îr
 =
	`ERR_PTR
(
ERR_BAD_DX_DIR
))

880 
	`pxt4_w¨nög_öode
(
dú
,

882  
ªt_îr
;

883 
	}
}

885 
	$dx_ªÀa£
(
dx_‰ame
 *
‰ames
)

887 
dx_roŸ_öfo
 *
öfo
;

888 
i
;

889 
ödúe˘_Àvñs
;

891 i‡(
‰ames
[0].
bh
 =
NULL
)

894 
öfo
 = &((
dx_roŸ
 *)
‰ames
[0].
bh
->
b_d©a
)->info;

896 
ödúe˘_Àvñs
 = 
öfo
->indirect_levels;

897 
i
 = 0; i <
ödúe˘_Àvñs
; i++) {

898 i‡(
‰ames
[
i
].
bh
 =
NULL
)

900 
	`bªl£
(
‰ames
[
i
].
bh
);

901 
‰ames
[
i
].
bh
 = 
NULL
;

903 
	}
}

922 
	$pxt4_håì_√xt_block
(
öode
 *
dú
, 
__u32
 
hash
,

923 
dx_‰ame
 *
‰ame
,

924 
dx_‰ame
 *
‰ames
,

925 
__u32
 *
°¨t_hash
)

927 
dx_‰ame
 *
p
;

928 
buf„r_hód
 *
bh
;

929 
num_‰ames
 = 0;

930 
__u32
 
bhash
;

932 
p
 = 
‰ame
;

941 i‡(++(
p
->
©
Ë<Ö->
íåõs
 + 
	`dx_gë_cou¡
(p->entries))

943 i‡(
p
 =
‰ames
)

945 
num_‰ames
++;

946 
p
--;

956 
bhash
 = 
	`dx_gë_hash
(
p
->
©
);

957 i‡(
°¨t_hash
)

958 *
°¨t_hash
 = 
bhash
;

959 i‡((
hash
 & 1) == 0) {

960 i‡((
bhash
 & ~1Ë!
hash
)

967 
num_‰ames
--) {

968 
bh
 = 
	`pxt4_ªad_dúblock
(
dú
, 
	`dx_gë_block
(
p
->
©
), 
INDEX
);

969 i‡(
	`IS_ERR
(
bh
))

970  
	`PTR_ERR
(
bh
);

971 
p
++;

972 
	`bªl£
(
p
->
bh
);

973 
p
->
bh
 = bh;

974 
p
->
©
 =Ö->
íåõs
 = ((
dx_node
 *Ë
bh
->
b_d©a
)->entries;

977 
	}
}

985 
	$håì_dúblock_to_åì
(
fûe
 *
dú_fûe
,

986 
öode
 *
dú
, 
pxt4_lblk_t
 
block
,

987 
dx_hash_öfo
 *
höfo
,

988 
__u32
 
°¨t_hash
, __u32 
°¨t_mö‹_hash
)

990 
buf„r_hód
 *
bh
;

991 
pxt4_dú_íåy_2
 *
de
, *
t›
;

992 
îr
 = 0, 
cou¡
 = 0;

993 
fs¸y±_°r
 
‚ame_¸y±o_°r
 = 
	`FSTR_INIT
(
NULL
, 0), 
tmp_°r
;

995 
	`dxåa˚
(
	`¥ötk
(
KERN_INFO
 "In htree dirblock_to_tree: block %lu\n",

996 ()
block
));

997 
bh
 = 
	`pxt4_ªad_dúblock
(
dú
, 
block
, 
DIRENT_HTREE
);

998 i‡(
	`IS_ERR
(
bh
))

999  
	`PTR_ERR
(
bh
);

1001 
de
 = (
pxt4_dú_íåy_2
 *Ë
bh
->
b_d©a
;

1002 
t›
 = (
pxt4_dú_íåy_2
 *Ë((*Ë
de
 +

1003 
dú
->
i_sb
->
s_blocksize
 -

1004 
	`PXT4_DIR_REC_LEN
(0));

1005 #ifde‡
CONFIG_FS_ENCRYPTION


1007 i‡(
	`IS_ENCRYPTED
(
dú
)) {

1008 
îr
 = 
	`fs¸y±_gë_í¸y±i⁄_öfo
(
dú
);

1009 i‡(
îr
 < 0) {

1010 
	`bªl£
(
bh
);

1011  
îr
;

1013 
îr
 = 
	`fs¸y±_‚ame_Æloc_buf„r
(
dú
, 
PXT4_NAME_LEN
,

1014 &
‚ame_¸y±o_°r
);

1015 i‡(
îr
 < 0) {

1016 
	`bªl£
(
bh
);

1017  
îr
;

1021 ; 
de
 < 
t›
; dê
	`pxt4_√xt_íåy
(de, 
dú
->
i_sb
->
s_blocksize
)) {

1022 i‡(
	`pxt4_check_dú_íåy
(
dú
, 
NULL
, 
de
, 
bh
,

1023 
bh
->
b_d©a
, bh->
b_size
,

1024 (
block
<<
	`PXT4_BLOCK_SIZE_BITS
(
dú
->
i_sb
))

1025 + ((*)
de
 - 
bh
->
b_d©a
))) {

1029 
	`pxt4fs_dúhash
(
dú
, 
de
->
«me
, de->
«me_Àn
, 
höfo
);

1030 i‡((
höfo
->
hash
 < 
°¨t_hash
) ||

1031 ((
höfo
->
hash
 =
°¨t_hash
) &&

1032 (
höfo
->
mö‹_hash
 < 
°¨t_mö‹_hash
)))

1034 i‡(
de
->
öode
 == 0)

1036 i‡(!
	`IS_ENCRYPTED
(
dú
)) {

1037 
tmp_°r
.
«me
 = 
de
->name;

1038 
tmp_°r
.
Àn
 = 
de
->
«me_Àn
;

1039 
îr
 = 
	`pxt4_håì_°‹e_dúít
(
dú_fûe
,

1040 
höfo
->
hash
, höfo->
mö‹_hash
, 
de
,

1041 &
tmp_°r
);

1043 
ßve_Àn
 = 
‚ame_¸y±o_°r
.
Àn
;

1044 
fs¸y±_°r
 
de_«me
 = 
	`FSTR_INIT
(
de
->
«me
,

1045 
de
->
«me_Àn
);

1048 
îr
 = 
	`fs¸y±_‚ame_disk_to_u§
(
dú
, 
höfo
->
hash
,

1049 
höfo
->
mö‹_hash
, &
de_«me
,

1050 &
‚ame_¸y±o_°r
);

1051 i‡(
îr
) {

1052 
cou¡
 = 
îr
;

1053 
îrout
;

1055 
îr
 = 
	`pxt4_håì_°‹e_dúít
(
dú_fûe
,

1056 
höfo
->
hash
, höfo->
mö‹_hash
, 
de
,

1057 &
‚ame_¸y±o_°r
);

1058 
‚ame_¸y±o_°r
.
Àn
 = 
ßve_Àn
;

1060 i‡(
îr
 != 0) {

1061 
cou¡
 = 
îr
;

1062 
îrout
;

1064 
cou¡
++;

1066 
îrout
:

1067 
	`bªl£
(
bh
);

1068 #ifde‡
CONFIG_FS_ENCRYPTION


1069 
	`fs¸y±_‚ame_‰ì_buf„r
(&
‚ame_¸y±o_°r
);

1071  
cou¡
;

1072 
	}
}

1083 
	$pxt4_håì_fûl_åì
(
fûe
 *
dú_fûe
, 
__u32
 
°¨t_hash
,

1084 
__u32
 
°¨t_mö‹_hash
, __u32 *
√xt_hash
)

1086 
dx_hash_öfo
 
höfo
;

1087 
pxt4_dú_íåy_2
 *
de
;

1088 
dx_‰ame
 
‰ames
[
PXT4_HTREE_LEVEL
], *
‰ame
;

1089 
öode
 *
dú
;

1090 
pxt4_lblk_t
 
block
;

1091 
cou¡
 = 0;

1092 
ªt
, 
îr
;

1093 
__u32
 
hashvÆ
;

1094 
fs¸y±_°r
 
tmp_°r
;

1096 
	`dxåa˚
(
	`¥ötk
(
KERN_DEBUG
 "In htree_fill_tree, start hash: %x:%x\n",

1097 
°¨t_hash
, 
°¨t_mö‹_hash
));

1098 
dú
 = 
	`fûe_öode
(
dú_fûe
);

1099 i‡(!(
	`pxt4_ã°_öode_Êag
(
dú
, 
PXT4_INODE_INDEX
))) {

1100 
höfo
.
hash_vîsi⁄
 = 
	`PXT4_SB
(
dú
->
i_sb
)->
s_def_hash_vîsi⁄
;

1101 i‡(
höfo
.
hash_vîsi⁄
 <
DX_HASH_TEA
)

1102 
höfo
.
hash_vîsi⁄
 +=

1103 
	`PXT4_SB
(
dú
->
i_sb
)->
s_hash_unsig√d
;

1104 
höfo
.
£ed
 = 
	`PXT4_SB
(
dú
->
i_sb
)->
s_hash_£ed
;

1105 i‡(
	`pxt4_has_ölöe_d©a
(
dú
)) {

1106 
has_ölöe_d©a
 = 1;

1107 
cou¡
 = 
	`pxt4_ölöedú_to_åì
(
dú_fûe
, 
dú
, 0,

1108 &
höfo
, 
°¨t_hash
,

1109 
°¨t_mö‹_hash
,

1110 &
has_ölöe_d©a
);

1111 i‡(
has_ölöe_d©a
) {

1112 *
√xt_hash
 = ~0;

1113  
cou¡
;

1116 
cou¡
 = 
	`håì_dúblock_to_åì
(
dú_fûe
, 
dú
, 0, &
höfo
,

1117 
°¨t_hash
, 
°¨t_mö‹_hash
);

1118 *
√xt_hash
 = ~0;

1119  
cou¡
;

1121 
höfo
.
hash
 = 
°¨t_hash
;

1122 
höfo
.
mö‹_hash
 = 0;

1123 
‰ame
 = 
	`dx_¥obe
(
NULL
, 
dú
, &
höfo
, 
‰ames
);

1124 i‡(
	`IS_ERR
(
‰ame
))

1125  
	`PTR_ERR
(
‰ame
);

1128 i‡(!
°¨t_hash
 && !
°¨t_mö‹_hash
) {

1129 
de
 = (
pxt4_dú_íåy_2
 *Ë
‰ames
[0].
bh
->
b_d©a
;

1130 
tmp_°r
.
«me
 = 
de
->name;

1131 
tmp_°r
.
Àn
 = 
de
->
«me_Àn
;

1132 
îr
 = 
	`pxt4_håì_°‹e_dúít
(
dú_fûe
, 0, 0,

1133 
de
, &
tmp_°r
);

1134 i‡(
îr
 != 0)

1135 
îrout
;

1136 
cou¡
++;

1138 i‡(
°¨t_hash
 < 2 || (°¨t_hash ==2 && 
°¨t_mö‹_hash
==0)) {

1139 
de
 = (
pxt4_dú_íåy_2
 *Ë
‰ames
[0].
bh
->
b_d©a
;

1140 
de
 = 
	`pxt4_√xt_íåy
(de, 
dú
->
i_sb
->
s_blocksize
);

1141 
tmp_°r
.
«me
 = 
de
->name;

1142 
tmp_°r
.
Àn
 = 
de
->
«me_Àn
;

1143 
îr
 = 
	`pxt4_håì_°‹e_dúít
(
dú_fûe
, 2, 0,

1144 
de
, &
tmp_°r
);

1145 i‡(
îr
 != 0)

1146 
îrout
;

1147 
cou¡
++;

1151 i‡(
	`Áèl_sig«l_≥ndög
(
cuºít
)) {

1152 
îr
 = -
ERESTARTSYS
;

1153 
îrout
;

1155 
	`c⁄d_ªsched
();

1156 
block
 = 
	`dx_gë_block
(
‰ame
->
©
);

1157 
ªt
 = 
	`håì_dúblock_to_åì
(
dú_fûe
, 
dú
, 
block
, &
höfo
,

1158 
°¨t_hash
, 
°¨t_mö‹_hash
);

1159 i‡(
ªt
 < 0) {

1160 
îr
 = 
ªt
;

1161 
îrout
;

1163 
cou¡
 +
ªt
;

1164 
hashvÆ
 = ~0;

1165 
ªt
 = 
	`pxt4_håì_√xt_block
(
dú
, 
HASH_NB_ALWAYS
,

1166 
‰ame
, 
‰ames
, &
hashvÆ
);

1167 *
√xt_hash
 = 
hashvÆ
;

1168 i‡(
ªt
 < 0) {

1169 
îr
 = 
ªt
;

1170 
îrout
;

1177 i‡((
ªt
 == 0) ||

1178 (
cou¡
 && ((
hashvÆ
 & 1) == 0)))

1181 
	`dx_ªÀa£
(
‰ames
);

1182 
	`dxåa˚
(
	`¥ötk
(
KERN_DEBUG
 "FillÅree:Ñeturned %dÉntries, "

1183 "√xàhash: %x\n", 
cou¡
, *
√xt_hash
));

1184  
cou¡
;

1185 
îrout
:

1186 
	`dx_ªÀa£
(
‰ames
);

1187  (
îr
);

1188 
	}
}

1190 
ölöe
 
	$£¨ch_dúblock
(
buf„r_hód
 *
bh
,

1191 
öode
 *
dú
,

1192 
pxt4_fûíame
 *
‚ame
,

1193 
off£t
,

1194 
pxt4_dú_íåy_2
 **
ªs_dú
)

1196  
	`pxt4_£¨ch_dú
(
bh
, bh->
b_d©a
, 
dú
->
i_sb
->
s_blocksize
, dir,

1197 
‚ame
, 
off£t
, 
ªs_dú
);

1198 
	}
}

1208 
	$dx_make_m≠
(
öode
 *
dú
, 
pxt4_dú_íåy_2
 *
de
,

1209 
blocksize
, 
dx_hash_öfo
 *
höfo
,

1210 
dx_m≠_íåy
 *
m≠_èû
)

1212 
cou¡
 = 0;

1213 *
ba£
 = (*Ë
de
;

1214 
dx_hash_öfo
 
h
 = *
höfo
;

1216 (*Ë
de
 < 
ba£
 + 
blocksize
) {

1217 i‡(
de
->
«me_Àn
 && de->
öode
) {

1218 
	`pxt4fs_dúhash
(
dú
, 
de
->
«me
, de->
«me_Àn
, &
h
);

1219 
m≠_èû
--;

1220 
m≠_èû
->
hash
 = 
h
.hash;

1221 
m≠_èû
->
offs
 = ((*Ë
de
 - 
ba£
)>>2;

1222 
m≠_èû
->
size
 = 
	`À16_to_˝u
(
de
->
ªc_Àn
);

1223 
cou¡
++;

1224 
	`c⁄d_ªsched
();

1227 
de
 = 
	`pxt4_√xt_íåy
(de, 
blocksize
);

1229  
cou¡
;

1230 
	}
}

1233 
	$dx_s‹t_m≠
 (
dx_m≠_íåy
 *
m≠
, 
cou¡
)

1235 
dx_m≠_íåy
 *
p
, *
q
, *
t›
 = 
m≠
 + 
cou¡
 - 1;

1236 
m‹e
;

1238 
cou¡
 > 2) {

1239 
cou¡
 = count*10/13;

1240 i‡(
cou¡
 - 9 < 2)

1241 
cou¡
 = 11;

1242 
p
 = 
t›
, 
q
 =Ö - 
cou¡
; q >
m≠
;Ö--, q--)

1243 i‡(
p
->
hash
 < 
q
->hash)

1244 
	`sw≠
(*
p
, *
q
);

1248 
m‹e
 = 0;

1249 
q
 = 
t›
;

1250 
q
-- > 
m≠
) {

1251 i‡(
q
[1].
hash
 >= q[0].hash)

1253 
	`sw≠
(*(
q
+1), *q);

1254 
m‹e
 = 1;

1256 } 
m‹e
);

1257 
	}
}

1259 
	$dx_ö£π_block
(
dx_‰ame
 *
‰ame
, 
u32
 
hash
, 
pxt4_lblk_t
 
block
)

1261 
dx_íåy
 *
íåõs
 = 
‰ame
->entries;

1262 
dx_íåy
 *
ﬁd
 = 
‰ame
->
©
, *
√w
 = old + 1;

1263 
cou¡
 = 
	`dx_gë_cou¡
(
íåõs
);

1265 
	`as£π
(
cou¡
 < 
	`dx_gë_limô
(
íåõs
));

1266 
	`as£π
(
ﬁd
 < 
íåõs
 + 
cou¡
);

1267 
	`memmove
(
√w
 + 1,Çew, (*)(
íåõs
 + 
cou¡
) - (*)(new));

1268 
	`dx_£t_hash
(
√w
, 
hash
);

1269 
	`dx_£t_block
(
√w
, 
block
);

1270 
	`dx_£t_cou¡
(
íåõs
, 
cou¡
 + 1);

1271 
	}
}

1273 #ifde‡
CONFIG_UNICODE


1282 
	$pxt4_ci_com∑ª
(c⁄° 
öode
 *
∑ª¡
, c⁄° 
q°r
 *
«me
,

1283 c⁄° 
q°r
 *
íåy
, 
boﬁ
 
quick
)

1285 c⁄° 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
∑ª¡
->
i_sb
);

1286 c⁄° 
unicode_m≠
 *
um
 = 
sbi
->
s_ícodög
;

1287 
ªt
;

1289 i‡(
quick
)

1290 
ªt
 = 
	`utf8_°∫ˇ£cmp_fﬁded
(
um
, 
«me
, 
íåy
);

1292 
ªt
 = 
	`utf8_°∫ˇ£cmp
(
um
, 
«me
, 
íåy
);

1294 i‡(
ªt
 < 0) {

1298 i‡(
	`pxt4_has_°ri˘_mode
(
sbi
))

1299  -
EINVAL
;

1301 i‡(
«me
->
Àn
 !
íåy
->len)

1304  !!
	`memcmp
(
«me
->«me, 
íåy
->«me,Çame->
Àn
);

1307  
ªt
;

1308 
	}
}

1310 
	$pxt4_‚ame_£tup_ci_fûíame
(
öode
 *
dú
, c⁄° 
q°r
 *
öame
,

1311 
fs¸y±_°r
 *
cf_«me
)

1313 
Àn
;

1315 i‡(!
	`IS_CASEFOLDED
(
dú
Ë|| !
	`PXT4_SB
(dú->
i_sb
)->
s_ícodög
) {

1316 
cf_«me
->
«me
 = 
NULL
;

1320 
cf_«me
->
«me
 = 
	`kmÆloc
(
PXT4_NAME_LEN
, 
GFP_NOFS
);

1321 i‡(!
cf_«me
->
«me
)

1324 
Àn
 = 
	`utf8_ˇ£fﬁd
(
	`PXT4_SB
(
dú
->
i_sb
)->
s_ícodög
,

1325 
öame
, 
cf_«me
->
«me
,

1326 
PXT4_NAME_LEN
);

1327 i‡(
Àn
 <= 0) {

1328 
	`k‰ì
(
cf_«me
->
«me
);

1329 
cf_«me
->
«me
 = 
NULL
;

1332 
cf_«me
->
Àn
 = ()Üen;

1334 
	}
}

1342 
ölöe
 
boﬁ
 
	$pxt4_m©ch
(c⁄° 
öode
 *
∑ª¡
,

1343 c⁄° 
pxt4_fûíame
 *
‚ame
,

1344 c⁄° 
pxt4_dú_íåy_2
 *
de
)

1346 
fs¸y±_«me
 
f
;

1347 #ifde‡
CONFIG_UNICODE


1348 c⁄° 
q°r
 
íåy
 = {.
«me
 = 
de
->«me, .
Àn
 = de->
«me_Àn
};

1351 i‡(!
de
->
öode
)

1352  
Ál£
;

1354 
f
.
u§_‚ame
 = 
‚ame
->usr_fname;

1355 
f
.
disk_«me
 = 
‚ame
->disk_name;

1356 #ifde‡
CONFIG_FS_ENCRYPTION


1357 
f
.
¸y±o_buf
 = 
‚ame
->crypto_buf;

1360 #ifde‡
CONFIG_UNICODE


1361 i‡(
	`PXT4_SB
(
∑ª¡
->
i_sb
)->
s_ícodög
 && 
	`IS_CASEFOLDED
(parent)) {

1362 i‡(
‚ame
->
cf_«me
.
«me
) {

1363 
q°r
 
cf
 = {.
«me
 = 
‚ame
->
cf_«me
.name,

1364 .
Àn
 = 
‚ame
->
cf_«me
.len};

1365  !
	`pxt4_ci_com∑ª
(
∑ª¡
, &
cf
, &
íåy
, 
åue
);

1367  !
	`pxt4_ci_com∑ª
(
∑ª¡
, 
‚ame
->
u§_‚ame
, &
íåy
,

1368 
Ál£
);

1372  
	`fs¸y±_m©ch_«me
(&
f
, 
de
->
«me
, de->
«me_Àn
);

1373 
	}
}

1378 
	$pxt4_£¨ch_dú
(
buf„r_hód
 *
bh
, *
£¨ch_buf
, 
buf_size
,

1379 
öode
 *
dú
, 
pxt4_fûíame
 *
‚ame
,

1380 
off£t
, 
pxt4_dú_íåy_2
 **
ªs_dú
)

1382 
pxt4_dú_íåy_2
 * 
de
;

1383 * 
dlimô
;

1384 
de_Àn
;

1386 
de
 = (
pxt4_dú_íåy_2
 *)
£¨ch_buf
;

1387 
dlimô
 = 
£¨ch_buf
 + 
buf_size
;

1388 (*Ë
de
 < 
dlimô
) {

1391 i‡((*Ë
de
 + de->
«me_Àn
 <
dlimô
 &&

1392 
	`pxt4_m©ch
(
dú
, 
‚ame
, 
de
)) {

1395 i‡(
	`pxt4_check_dú_íåy
(
dú
, 
NULL
, 
de
, 
bh
, 
£¨ch_buf
,

1396 
buf_size
, 
off£t
))

1398 *
ªs_dú
 = 
de
;

1402 
de_Àn
 = 
	`pxt4_ªc_Àn_‰om_disk
(
de
->
ªc_Àn
,

1403 
dú
->
i_sb
->
s_blocksize
);

1404 i‡(
de_Àn
 <= 0)

1406 
off£t
 +
de_Àn
;

1407 
de
 = (
pxt4_dú_íåy_2
 *Ë((*Ëdê+ 
de_Àn
);

1410 
	}
}

1412 
	$is_dx_öã∫Æ_node
(
öode
 *
dú
, 
pxt4_lblk_t
 
block
,

1413 
pxt4_dú_íåy
 *
de
)

1415 
su≥r_block
 *
sb
 = 
dú
->
i_sb
;

1417 i‡(!
	`is_dx
(
dú
))

1419 i‡(
block
 == 0)

1421 i‡(
de
->
öode
 == 0 &&

1422 
	`pxt4_ªc_Àn_‰om_disk
(
de
->
ªc_Àn
, 
sb
->
s_blocksize
) ==

1423 
sb
->
s_blocksize
)

1426 
	}
}

1439 
buf„r_hód
 *
	$__pxt4_föd_íåy
(
öode
 *
dú
,

1440 
pxt4_fûíame
 *
‚ame
,

1441 
pxt4_dú_íåy_2
 **
ªs_dú
,

1442 *
ölöed
)

1444 
su≥r_block
 *
sb
;

1445 
buf„r_hód
 *
bh_u£
[
NAMEI_RA_SIZE
];

1446 
buf„r_hód
 *
bh
, *
ªt
 = 
NULL
;

1447 
pxt4_lblk_t
 
°¨t
, 
block
;

1448 c⁄° 
u8
 *
«me
 = 
‚ame
->
u§_‚ame
->name;

1449 
size_t
 
ø_max
 = 0;

1451 
size_t
 
ø_±r
 = 0;

1453 
pxt4_lblk_t
 
nblocks
;

1454 
i
, 
«mñí
, 
ªtvÆ
;

1456 *
ªs_dú
 = 
NULL
;

1457 
sb
 = 
dú
->
i_sb
;

1458 
«mñí
 = 
‚ame
->
u§_‚ame
->
Àn
;

1459 i‡(
«mñí
 > 
PXT4_NAME_LEN
)

1460  
NULL
;

1462 i‡(
	`pxt4_has_ölöe_d©a
(
dú
)) {

1463 
has_ölöe_d©a
 = 1;

1464 
ªt
 = 
	`pxt4_föd_ölöe_íåy
(
dú
, 
‚ame
, 
ªs_dú
,

1465 &
has_ölöe_d©a
);

1466 i‡(
has_ölöe_d©a
) {

1467 i‡(
ölöed
)

1468 *
ölöed
 = 1;

1469 
˛ónup_™d_exô
;

1473 i‡((
«mñí
 <2Ë&& (
«me
[0] == '.') &&

1474 (
«me
[1] == '.' ||Çame[1] == '\0')) {

1479 
block
 = 
°¨t
 = 0;

1480 
nblocks
 = 1;

1481 
ª°¨t
;

1483 i‡(
	`is_dx
(
dú
)) {

1484 
ªt
 = 
	`pxt4_dx_föd_íåy
(
dú
, 
‚ame
, 
ªs_dú
);

1490 i‡(!
	`IS_ERR
(
ªt
Ë|| 
	`PTR_ERR
‘ëË!
ERR_BAD_DX_DIR
)

1491 
˛ónup_™d_exô
;

1492 
	`dxåa˚
(
	`¥ötk
(
KERN_DEBUG
 "pxt4_find_entry: dx failed, "

1494 
ªt
 = 
NULL
;

1496 
nblocks
 = 
dú
->
i_size
 >> 
	`PXT4_BLOCK_SIZE_BITS
(
sb
);

1497 i‡(!
nblocks
) {

1498 
ªt
 = 
NULL
;

1499 
˛ónup_™d_exô
;

1501 
°¨t
 = 
	`PXT4_I
(
dú
)->
i_dú_°¨t_lookup
;

1502 i‡(
°¨t
 >
nblocks
)

1503 
°¨t
 = 0;

1504 
block
 = 
°¨t
;

1505 
ª°¨t
:

1510 
	`c⁄d_ªsched
();

1511 i‡(
ø_±r
 >
ø_max
) {

1513 
ø_±r
 = 0;

1514 i‡(
block
 < 
°¨t
)

1515 
ø_max
 = 
°¨t
 - 
block
;

1517 
ø_max
 = 
nblocks
 - 
block
;

1518 
ø_max
 = 
	`mö
‘a_max, 
	`ARRAY_SIZE
(
bh_u£
));

1519 
ªtvÆ
 = 
	`pxt4_bªad_b©ch
(
dú
, 
block
, 
ø_max
,

1520 
Ál£
 , 
bh_u£
);

1521 i‡(
ªtvÆ
) {

1522 
ªt
 = 
	`ERR_PTR
(
ªtvÆ
);

1523 
ø_max
 = 0;

1524 
˛ónup_™d_exô
;

1527 i‡((
bh
 = 
bh_u£
[
ø_±r
++]Ë=
NULL
)

1528 
√xt
;

1529 
	`waô_⁄_buf„r
(
bh
);

1530 i‡(!
	`buf„r_u±od©e
(
bh
)) {

1531 
	`PXT4_ERROR_INODE
(
dú
, "reading directoryÜblock %lu",

1532 (Ë
block
);

1533 
	`bªl£
(
bh
);

1534 
ªt
 = 
	`ERR_PTR
(-
EIO
);

1535 
˛ónup_™d_exô
;

1537 i‡(!
	`buf„r_vîifõd
(
bh
) &&

1538 !
	`is_dx_öã∫Æ_node
(
dú
, 
block
,

1539 (
pxt4_dú_íåy
 *)
bh
->
b_d©a
) &&

1540 !
	`pxt4_dúblock_csum_vîify
(
dú
, 
bh
)) {

1541 
	`PXT4_ERROR_INODE
(
dú
, "checksumming directory "

1542 "block %lu", ()
block
);

1543 
	`bªl£
(
bh
);

1544 
ªt
 = 
	`ERR_PTR
(-
EFSBADCRC
);

1545 
˛ónup_™d_exô
;

1547 
	`£t_buf„r_vîifõd
(
bh
);

1548 
i
 = 
	`£¨ch_dúblock
(
bh
, 
dú
, 
‚ame
,

1549 
block
 << 
	`PXT4_BLOCK_SIZE_BITS
(
sb
), 
ªs_dú
);

1550 i‡(
i
 == 1) {

1551 
	`PXT4_I
(
dú
)->
i_dú_°¨t_lookup
 = 
block
;

1552 
ªt
 = 
bh
;

1553 
˛ónup_™d_exô
;

1555 
	`bªl£
(
bh
);

1556 i‡(
i
 < 0)

1557 
˛ónup_™d_exô
;

1559 
√xt
:

1560 i‡(++
block
 >
nblocks
)

1561 
block
 = 0;

1562 } 
block
 !
°¨t
);

1568 
block
 = 
nblocks
;

1569 
nblocks
 = 
dú
->
i_size
 >> 
	`PXT4_BLOCK_SIZE_BITS
(
sb
);

1570 i‡(
block
 < 
nblocks
) {

1571 
°¨t
 = 0;

1572 
ª°¨t
;

1575 
˛ónup_™d_exô
:

1577 ; 
ø_±r
 < 
ø_max
;Ña_ptr++)

1578 
	`bªl£
(
bh_u£
[
ø_±r
]);

1579  
ªt
;

1580 
	}
}

1582 
buf„r_hód
 *
	$pxt4_föd_íåy
(
öode
 *
dú
,

1583 c⁄° 
q°r
 *
d_«me
,

1584 
pxt4_dú_íåy_2
 **
ªs_dú
,

1585 *
ölöed
)

1587 
îr
;

1588 
pxt4_fûíame
 
‚ame
;

1589 
buf„r_hód
 *
bh
;

1591 
îr
 = 
	`pxt4_‚ame_£tup_fûíame
(
dú
, 
d_«me
, 1, &
‚ame
);

1592 i‡(
îr
 =-
ENOENT
)

1593  
NULL
;

1594 i‡(
îr
)

1595  
	`ERR_PTR
(
îr
);

1597 
bh
 = 
	`__pxt4_föd_íåy
(
dú
, &
‚ame
, 
ªs_dú
, 
ölöed
);

1599 
	`pxt4_‚ame_‰ì_fûíame
(&
‚ame
);

1600  
bh
;

1601 
	}
}

1603 
buf„r_hód
 *
	$pxt4_lookup_íåy
(
öode
 *
dú
,

1604 
díåy
 *dentry,

1605 
pxt4_dú_íåy_2
 **
ªs_dú
)

1607 
îr
;

1608 
pxt4_fûíame
 
‚ame
;

1609 
buf„r_hód
 *
bh
;

1611 
îr
 = 
	`pxt4_‚ame_¥ï¨e_lookup
(
dú
, 
díåy
, &
‚ame
);

1612 i‡(
îr
 =-
ENOENT
)

1613  
NULL
;

1614 i‡(
îr
)

1615  
	`ERR_PTR
(
îr
);

1617 
bh
 = 
	`__pxt4_föd_íåy
(
dú
, &
‚ame
, 
ªs_dú
, 
NULL
);

1619 
	`pxt4_‚ame_‰ì_fûíame
(&
‚ame
);

1620  
bh
;

1621 
	}
}

1623 
buf„r_hód
 * 
	$pxt4_dx_föd_íåy
(
öode
 *
dú
,

1624 
pxt4_fûíame
 *
‚ame
,

1625 
pxt4_dú_íåy_2
 **
ªs_dú
)

1627 
su≥r_block
 * 
sb
 = 
dú
->
i_sb
;

1628 
dx_‰ame
 
‰ames
[
PXT4_HTREE_LEVEL
], *
‰ame
;

1629 
buf„r_hód
 *
bh
;

1630 
pxt4_lblk_t
 
block
;

1631 
ªtvÆ
;

1633 #ifde‡
CONFIG_FS_ENCRYPTION


1634 *
ªs_dú
 = 
NULL
;

1636 
‰ame
 = 
	`dx_¥obe
(
‚ame
, 
dú
, 
NULL
, 
‰ames
);

1637 i‡(
	`IS_ERR
(
‰ame
))

1638  (
buf„r_hód
 *Ë
‰ame
;

1640 
block
 = 
	`dx_gë_block
(
‰ame
->
©
);

1641 
bh
 = 
	`pxt4_ªad_dúblock
(
dú
, 
block
, 
DIRENT_HTREE
);

1642 i‡(
	`IS_ERR
(
bh
))

1643 
îrout
;

1645 
ªtvÆ
 = 
	`£¨ch_dúblock
(
bh
, 
dú
, 
‚ame
,

1646 
block
 << 
	`PXT4_BLOCK_SIZE_BITS
(
sb
),

1647 
ªs_dú
);

1648 i‡(
ªtvÆ
 == 1)

1649 
suc˚ss
;

1650 
	`bªl£
(
bh
);

1651 i‡(
ªtvÆ
 == -1) {

1652 
bh
 = 
	`ERR_PTR
(
ERR_BAD_DX_DIR
);

1653 
îrout
;

1657 
ªtvÆ
 = 
	`pxt4_håì_√xt_block
(
dú
, 
‚ame
->
höfo
.
hash
, 
‰ame
,

1658 
‰ames
, 
NULL
);

1659 i‡(
ªtvÆ
 < 0) {

1660 
	`pxt4_w¨nög_öode
(
dú
,

1662 
ªtvÆ
);

1663 
bh
 = 
	`ERR_PTR
(
ªtvÆ
);

1664 
îrout
;

1666 } 
ªtvÆ
 == 1);

1668 
bh
 = 
NULL
;

1669 
îrout
:

1670 
	`dxåa˚
(
	`¥ötk
(
KERN_DEBUG
 "%†nŸ found\n", 
‚ame
->
u§_‚ame
->
«me
));

1671 
suc˚ss
:

1672 
	`dx_ªÀa£
(
‰ames
);

1673  
bh
;

1674 
	}
}

1676 
díåy
 *
	$pxt4_lookup
(
öode
 *
dú
, 
díåy
 *díåy, 
Êags
)

1678 
öode
 *inode;

1679 
pxt4_dú_íåy_2
 *
de
;

1680 
buf„r_hód
 *
bh
;

1682 i‡(
díåy
->
d_«me
.
Àn
 > 
PXT4_NAME_LEN
)

1683  
	`ERR_PTR
(-
ENAMETOOLONG
);

1685 
bh
 = 
	`pxt4_lookup_íåy
(
dú
, 
díåy
, &
de
);

1686 i‡(
	`IS_ERR
(
bh
))

1687  
	`ERR_CAST
(
bh
);

1688 
öode
 = 
NULL
;

1689 i‡(
bh
) {

1690 
__u32
 
öo
 = 
	`À32_to_˝u
(
de
->
öode
);

1691 
	`bªl£
(
bh
);

1692 i‡(!
	`pxt4_vÆid_öum
(
dú
->
i_sb
, 
öo
)) {

1693 
	`PXT4_ERROR_INODE
(
dú
, "bad inodênumbî: %u", 
öo
);

1694  
	`ERR_PTR
(-
EFSCORRUPTED
);

1696 i‡(
	`u∆ikñy
(
öo
 =
dú
->
i_öo
)) {

1697 
	`PXT4_ERROR_INODE
(
dú
, "'%pd'ÜinkedÅoÖarent dir",

1698 
díåy
);

1699  
	`ERR_PTR
(-
EFSCORRUPTED
);

1701 
öode
 = 
	`pxt4_igë
(
dú
->
i_sb
, 
öo
, 
PXT4_IGET_NORMAL
);

1702 i‡(
öode
 =
	`ERR_PTR
(-
ESTALE
)) {

1703 
	`PXT4_ERROR_INODE
(
dú
,

1705 
öo
);

1706  
	`ERR_PTR
(-
EFSCORRUPTED
);

1708 i‡(!
	`IS_ERR
(
öode
Ë&& 
	`IS_ENCRYPTED
(
dú
) &&

1709 (
	`S_ISDIR
(
öode
->
i_mode
Ë|| 
	`S_ISLNK
(inode->i_mode)) &&

1710 !
	`fs¸y±_has_≥rmôãd_c⁄ãxt
(
dú
, 
öode
)) {

1711 
	`pxt4_w¨nög
(
öode
->
i_sb
,

1713 
dú
->
i_öo
, 
öode
->i_ino);

1714 
	`ùut
(
öode
);

1715  
	`ERR_PTR
(-
EPERM
);

1719 #ifde‡
CONFIG_UNICODE


1720 i‡(!
öode
 && 
	`IS_CASEFOLDED
(
dú
)) {

1726  
NULL
;

1729  
	`d_•li˚_Æüs
(
öode
, 
díåy
);

1730 
	}
}

1733 
díåy
 *
	$pxt4_gë_∑ª¡
(
díåy
 *
chûd
)

1735 
__u32
 
öo
;

1736 c⁄° 
q°r
 
dŸdŸ
 = 
	`QSTR_INIT
("..", 2);

1737 
pxt4_dú_íåy_2
 * 
de
;

1738 
buf„r_hód
 *
bh
;

1740 
bh
 = 
	`pxt4_föd_íåy
(
	`d_öode
(
chûd
), &
dŸdŸ
, &
de
, 
NULL
);

1741 i‡(
	`IS_ERR
(
bh
))

1742  
	`ERR_CAST
(
bh
);

1743 i‡(!
bh
)

1744  
	`ERR_PTR
(-
ENOENT
);

1745 
öo
 = 
	`À32_to_˝u
(
de
->
öode
);

1746 
	`bªl£
(
bh
);

1748 i‡(!
	`pxt4_vÆid_öum
(
chûd
->
d_sb
, 
öo
)) {

1749 
	`PXT4_ERROR_INODE
(
	`d_öode
(
chûd
),

1750 "badÖ¨íàöodênumbî: %u", 
öo
);

1751  
	`ERR_PTR
(-
EFSCORRUPTED
);

1754  
	`d_obèö_Æüs
(
	`pxt4_igë
(
chûd
->
d_sb
, 
öo
, 
PXT4_IGET_NORMAL
));

1755 
	}
}

1761 
pxt4_dú_íåy_2
 *

1762 
	$dx_move_dúíts
(*
‰om
, *
to
, 
dx_m≠_íåy
 *
m≠
, 
cou¡
,

1763 
blocksize
)

1765 
ªc_Àn
 = 0;

1767 
cou¡
--) {

1768 
pxt4_dú_íåy_2
 *
de
 = (pxt4_dir_entry_2 *)

1769 (
‰om
 + (
m≠
->
offs
<<2));

1770 
ªc_Àn
 = 
	`PXT4_DIR_REC_LEN
(
de
->
«me_Àn
);

1771 
	`mem˝y
 (
to
, 
de
, 
ªc_Àn
);

1772 ((
pxt4_dú_íåy_2
 *Ë
to
)->
ªc_Àn
 =

1773 
	`pxt4_ªc_Àn_to_disk
(
ªc_Àn
, 
blocksize
);

1774 
de
->
öode
 = 0;

1775 
m≠
++;

1776 
to
 +
ªc_Àn
;

1778  (
pxt4_dú_íåy_2
 *Ë(
to
 - 
ªc_Àn
);

1779 
	}
}

1785 
pxt4_dú_íåy_2
* 
	$dx_∑ck_dúíts
(*
ba£
, 
blocksize
)

1787 
pxt4_dú_íåy_2
 *
√xt
, *
to
, *
¥ev
, *
de
 = (pxt4_dú_íåy_2 *Ë
ba£
;

1788 
ªc_Àn
 = 0;

1790 
¥ev
 = 
to
 = 
de
;

1791 (*)
de
 < 
ba£
 + 
blocksize
) {

1792 
√xt
 = 
	`pxt4_√xt_íåy
(
de
, 
blocksize
);

1793 i‡(
de
->
öode
 && de->
«me_Àn
) {

1794 
ªc_Àn
 = 
	`PXT4_DIR_REC_LEN
(
de
->
«me_Àn
);

1795 i‡(
de
 > 
to
)

1796 
	`memmove
(
to
, 
de
, 
ªc_Àn
);

1797 
to
->
ªc_Àn
 = 
	`pxt4_ªc_Àn_to_disk
‘ec_Àn, 
blocksize
);

1798 
¥ev
 = 
to
;

1799 
to
 = (
pxt4_dú_íåy_2
 *Ë(((*ËtoË+ 
ªc_Àn
);

1801 
de
 = 
√xt
;

1803  
¥ev
;

1804 
	}
}

1811 
pxt4_dú_íåy_2
 *
	$do_•lô
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *
dú
,

1812 
buf„r_hód
 **
bh
,
dx_‰ame
 *
‰ame
,

1813 
dx_hash_öfo
 *
höfo
)

1815 
blocksize
 = 
dú
->
i_sb
->
s_blocksize
;

1816 
cou¡
, 
c⁄töued
;

1817 
buf„r_hód
 *
bh2
;

1818 
pxt4_lblk_t
 
√wblock
;

1819 
u32
 
hash2
;

1820 
dx_m≠_íåy
 *
m≠
;

1821 *
d©a1
 = (*
bh
)->
b_d©a
, *
d©a2
;

1822 
•lô
, 
move
, 
size
;

1823 
pxt4_dú_íåy_2
 *
de
 = 
NULL
, *
de2
;

1824 
csum_size
 = 0;

1825 
îr
 = 0, 
i
;

1827 i‡(
	`pxt4_has_mëad©a_csum
(
dú
->
i_sb
))

1828 
csum_size
 = (
pxt4_dú_íåy_èû
);

1830 
bh2
 = 
	`pxt4_≠≥nd
(
h™dÀ
, 
dú
, &
√wblock
);

1831 i‡(
	`IS_ERR
(
bh2
)) {

1832 
	`bªl£
(*
bh
);

1833 *
bh
 = 
NULL
;

1834  (
pxt4_dú_íåy_2
 *Ë
bh2
;

1837 
	`BUFFER_TRACE
(*
bh
, "get_write_access");

1838 
îr
 = 
	`pxt4_jou∫Æ_gë_wrôe_ac˚ss
(
h™dÀ
, *
bh
);

1839 i‡(
îr
)

1840 
jou∫Æ_îr‹
;

1842 
	`BUFFER_TRACE
(
‰ame
->
bh
, "get_write_access");

1843 
îr
 = 
	`pxt4_jou∫Æ_gë_wrôe_ac˚ss
(
h™dÀ
, 
‰ame
->
bh
);

1844 i‡(
îr
)

1845 
jou∫Æ_îr‹
;

1847 
d©a2
 = 
bh2
->
b_d©a
;

1850 
m≠
 = (
dx_m≠_íåy
 *Ë(
d©a2
 + 
blocksize
);

1851 
cou¡
 = 
	`dx_make_m≠
(
dú
, (
pxt4_dú_íåy_2
 *Ë
d©a1
,

1852 
blocksize
, 
höfo
, 
m≠
);

1853 
m≠
 -
cou¡
;

1854 
	`dx_s‹t_m≠
(
m≠
, 
cou¡
);

1856 
size
 = 0;

1857 
move
 = 0;

1858 
i
 = 
cou¡
-1; i >= 0; i--) {

1860 i‡(
size
 + 
m≠
[
i
].size/2 > 
blocksize
/2)

1862 
size
 +
m≠
[
i
].size;

1863 
move
++;

1872 i‡(
i
 > 0)

1873 
•lô
 = 
cou¡
 - 
move
;

1875 
•lô
 = 
cou¡
/2;

1877 
hash2
 = 
m≠
[
•lô
].
hash
;

1878 
c⁄töued
 = 
hash2
 =
m≠
[
•lô
 - 1].
hash
;

1879 
	`dxåa˚
(
	`¥ötk
(
KERN_INFO
 "Split block %luát %x, %i/%i\n",

1880 ()
	`dx_gë_block
(
‰ame
->
©
),

1881 
hash2
, 
•lô
, 
cou¡
-split));

1884 
de2
 = 
	`dx_move_dúíts
(
d©a1
, 
d©a2
, 
m≠
 + 
•lô
, 
cou¡
 - split,

1885 
blocksize
);

1886 
de
 = 
	`dx_∑ck_dúíts
(
d©a1
, 
blocksize
);

1887 
de
->
ªc_Àn
 = 
	`pxt4_ªc_Àn_to_disk
(
d©a1
 + (
blocksize
 - 
csum_size
) -

1888 (*Ë
de
,

1889 
blocksize
);

1890 
de2
->
ªc_Àn
 = 
	`pxt4_ªc_Àn_to_disk
(
d©a2
 + (
blocksize
 - 
csum_size
) -

1891 (*Ë
de2
,

1892 
blocksize
);

1893 i‡(
csum_size
) {

1894 
	`pxt4_öôülize_dúít_èû
(*
bh
, 
blocksize
);

1895 
	`pxt4_öôülize_dúít_èû
(
bh2
, 
blocksize
);

1898 
	`dxåa˚
(
	`dx_show_Àaf
(
dú
, 
höfo
, (
pxt4_dú_íåy_2
 *Ë
d©a1
,

1899 
blocksize
, 1));

1900 
	`dxåa˚
(
	`dx_show_Àaf
(
dú
, 
höfo
, (
pxt4_dú_íåy_2
 *Ë
d©a2
,

1901 
blocksize
, 1));

1904 i‡(
höfo
->
hash
 >
hash2
) {

1905 
	`sw≠
(*
bh
, 
bh2
);

1906 
de
 = 
de2
;

1908 
	`dx_ö£π_block
(
‰ame
, 
hash2
 + 
c⁄töued
, 
√wblock
);

1909 
îr
 = 
	`pxt4_h™dÀ_dúty_dúblock
(
h™dÀ
, 
dú
, 
bh2
);

1910 i‡(
îr
)

1911 
jou∫Æ_îr‹
;

1912 
îr
 = 
	`pxt4_h™dÀ_dúty_dx_node
(
h™dÀ
, 
dú
, 
‰ame
->
bh
);

1913 i‡(
îr
)

1914 
jou∫Æ_îr‹
;

1915 
	`bªl£
(
bh2
);

1916 
	`dxåa˚
(
	`dx_show_ödex
("‰ame", 
‰ame
->
íåõs
));

1917  
de
;

1919 
jou∫Æ_îr‹
:

1920 
	`bªl£
(*
bh
);

1921 
	`bªl£
(
bh2
);

1922 *
bh
 = 
NULL
;

1923 
	`pxt4_°d_îr‹
(
dú
->
i_sb
, 
îr
);

1924  
	`ERR_PTR
(
îr
);

1925 
	}
}

1927 
	$pxt4_föd_de°_de
(
öode
 *
dú
, inode *inode,

1928 
buf„r_hód
 *
bh
,

1929 *
buf
, 
buf_size
,

1930 
pxt4_fûíame
 *
‚ame
,

1931 
pxt4_dú_íåy_2
 **
de°_de
)

1933 
pxt4_dú_íåy_2
 *
de
;

1934 
ª˛í
 = 
	`PXT4_DIR_REC_LEN
(
	`‚ame_Àn
(
‚ame
));

1935 
∆í
, 
æí
;

1936 
off£t
 = 0;

1937 *
t›
;

1939 
de
 = (
pxt4_dú_íåy_2
 *)
buf
;

1940 
t›
 = 
buf
 + 
buf_size
 - 
ª˛í
;

1941 (*Ë
de
 <
t›
) {

1942 i‡(
	`pxt4_check_dú_íåy
(
dú
, 
NULL
, 
de
, 
bh
,

1943 
buf
, 
buf_size
, 
off£t
))

1944  -
EFSCORRUPTED
;

1945 i‡(
	`pxt4_m©ch
(
dú
, 
‚ame
, 
de
))

1946  -
EEXIST
;

1947 
∆í
 = 
	`PXT4_DIR_REC_LEN
(
de
->
«me_Àn
);

1948 
æí
 = 
	`pxt4_ªc_Àn_‰om_disk
(
de
->
ªc_Àn
, 
buf_size
);

1949 i‡((
de
->
öode
 ? 
æí
 - 
∆í
 :ÑÀnË>
ª˛í
)

1951 
de
 = (
pxt4_dú_íåy_2
 *)((*)dê+ 
æí
);

1952 
off£t
 +
æí
;

1954 i‡((*Ë
de
 > 
t›
)

1955  -
ENOSPC
;

1957 *
de°_de
 = 
de
;

1959 
	}
}

1961 
	$pxt4_ö£π_díåy
(
öode
 *inode,

1962 
pxt4_dú_íåy_2
 *
de
,

1963 
buf_size
,

1964 
pxt4_fûíame
 *
‚ame
)

1967 
∆í
, 
æí
;

1969 
∆í
 = 
	`PXT4_DIR_REC_LEN
(
de
->
«me_Àn
);

1970 
æí
 = 
	`pxt4_ªc_Àn_‰om_disk
(
de
->
ªc_Àn
, 
buf_size
);

1971 i‡(
de
->
öode
) {

1972 
pxt4_dú_íåy_2
 *
de1
 =

1973 (
pxt4_dú_íåy_2
 *)((*)
de
 + 
∆í
);

1974 
de1
->
ªc_Àn
 = 
	`pxt4_ªc_Àn_to_disk
(
æí
 - 
∆í
, 
buf_size
);

1975 
de
->
ªc_Àn
 = 
	`pxt4_ªc_Àn_to_disk
(
∆í
, 
buf_size
);

1976 
de
 = 
de1
;

1978 
de
->
fûe_ty≥
 = 
PXT4_FT_UNKNOWN
;

1979 
de
->
öode
 = 
	`˝u_to_À32
(öode->
i_öo
);

1980 
	`pxt4_£t_de_ty≥
(
öode
->
i_sb
, 
de
, inode->
i_mode
);

1981 
de
->
«me_Àn
 = 
	`‚ame_Àn
(
‚ame
);

1982 
	`mem˝y
(
de
->
«me
, 
	`‚ame_«me
(
‚ame
), 
	`‚ame_Àn
(fname));

1983 
	}
}

1993 
	$add_dúít_to_buf
(
h™dÀ_t
 *
h™dÀ
, 
pxt4_fûíame
 *
‚ame
,

1994 
öode
 *
dú
,

1995 
öode
 *öode, 
pxt4_dú_íåy_2
 *
de
,

1996 
buf„r_hód
 *
bh
)

1998 
blocksize
 = 
dú
->
i_sb
->
s_blocksize
;

1999 
csum_size
 = 0;

2000 
îr
;

2002 i‡(
	`pxt4_has_mëad©a_csum
(
öode
->
i_sb
))

2003 
csum_size
 = (
pxt4_dú_íåy_èû
);

2005 i‡(!
de
) {

2006 
îr
 = 
	`pxt4_föd_de°_de
(
dú
, 
öode
, 
bh
, bh->
b_d©a
,

2007 
blocksize
 - 
csum_size
, 
‚ame
, &
de
);

2008 i‡(
îr
)

2009  
îr
;

2011 
	`BUFFER_TRACE
(
bh
, "get_write_access");

2012 
îr
 = 
	`pxt4_jou∫Æ_gë_wrôe_ac˚ss
(
h™dÀ
, 
bh
);

2013 i‡(
îr
) {

2014 
	`pxt4_°d_îr‹
(
dú
->
i_sb
, 
îr
);

2015  
îr
;

2019 
	`pxt4_ö£π_díåy
(
öode
, 
de
, 
blocksize
, 
‚ame
);

2032 
dú
->
i_mtime
 = dú->
i_˘ime
 = 
	`cuºít_time
(dir);

2033 
	`pxt4_upd©e_dx_Êag
(
dú
);

2034 
	`öode_öc_ivîsi⁄
(
dú
);

2035 
	`pxt4_m¨k_öode_dúty
(
h™dÀ
, 
dú
);

2036 
	`BUFFER_TRACE
(
bh
, "callÖxt4_handle_dirty_metadata");

2037 
îr
 = 
	`pxt4_h™dÀ_dúty_dúblock
(
h™dÀ
, 
dú
, 
bh
);

2038 i‡(
îr
)

2039 
	`pxt4_°d_îr‹
(
dú
->
i_sb
, 
îr
);

2041 
	}
}

2047 
	$make_ödexed_dú
(
h™dÀ_t
 *
h™dÀ
, 
pxt4_fûíame
 *
‚ame
,

2048 
öode
 *
dú
,

2049 
öode
 *öode, 
buf„r_hód
 *
bh
)

2051 
buf„r_hód
 *
bh2
;

2052 
dx_roŸ
 *
roŸ
;

2053 
dx_‰ame
 
‰ames
[
PXT4_HTREE_LEVEL
], *
‰ame
;

2054 
dx_íåy
 *
íåõs
;

2055 
pxt4_dú_íåy_2
 *
de
, *
de2
;

2056 *
d©a2
, *
t›
;

2057 
Àn
;

2058 
ªtvÆ
;

2059 
blocksize
;

2060 
pxt4_lblk_t
 
block
;

2061 
Áke_dúít
 *
fde
;

2062 
csum_size
 = 0;

2064 i‡(
	`pxt4_has_mëad©a_csum
(
öode
->
i_sb
))

2065 
csum_size
 = (
pxt4_dú_íåy_èû
);

2067 
blocksize
 = 
dú
->
i_sb
->
s_blocksize
;

2068 
	`dxåa˚
(
	`¥ötk
(
KERN_DEBUG
 "Cª©ög index: inodê%lu\n", 
dú
->
i_öo
));

2069 
	`BUFFER_TRACE
(
bh
, "get_write_access");

2070 
ªtvÆ
 = 
	`pxt4_jou∫Æ_gë_wrôe_ac˚ss
(
h™dÀ
, 
bh
);

2071 i‡(
ªtvÆ
) {

2072 
	`pxt4_°d_îr‹
(
dú
->
i_sb
, 
ªtvÆ
);

2073 
	`bªl£
(
bh
);

2074  
ªtvÆ
;

2076 
roŸ
 = (
dx_roŸ
 *Ë
bh
->
b_d©a
;

2079 
fde
 = &
roŸ
->
dŸdŸ
;

2080 
de
 = (
pxt4_dú_íåy_2
 *)((*)
fde
 +

2081 
	`pxt4_ªc_Àn_‰om_disk
(
fde
->
ªc_Àn
, 
blocksize
));

2082 i‡((*Ë
de
 >(((*Ë
roŸ
Ë+ 
blocksize
)) {

2083 
	`PXT4_ERROR_INODE
(
dú
, "invalidÑec_len for '..'");

2084 
	`bªl£
(
bh
);

2085  -
EFSCORRUPTED
;

2087 
Àn
 = ((*Ë
roŸ
Ë+ (
blocksize
 - 
csum_size
Ë- (*Ë
de
;

2090 
bh2
 = 
	`pxt4_≠≥nd
(
h™dÀ
, 
dú
, &
block
);

2091 i‡(
	`IS_ERR
(
bh2
)) {

2092 
	`bªl£
(
bh
);

2093  
	`PTR_ERR
(
bh2
);

2095 
	`pxt4_£t_öode_Êag
(
dú
, 
PXT4_INODE_INDEX
);

2096 
d©a2
 = 
bh2
->
b_d©a
;

2098 
	`mem˝y
(
d©a2
, 
de
, 
Àn
);

2099 
de
 = (
pxt4_dú_íåy_2
 *Ë
d©a2
;

2100 
t›
 = 
d©a2
 + 
Àn
;

2101 (*)(
de2
 = 
	`pxt4_√xt_íåy
(
de
, 
blocksize
)Ë< 
t›
)

2102 
de
 = 
de2
;

2103 
de
->
ªc_Àn
 = 
	`pxt4_ªc_Àn_to_disk
(
d©a2
 + (
blocksize
 - 
csum_size
) -

2104 (*Ë
de
, 
blocksize
);

2106 i‡(
csum_size
)

2107 
	`pxt4_öôülize_dúít_èû
(
bh2
, 
blocksize
);

2110 
de
 = (
pxt4_dú_íåy_2
 *Ë(&
roŸ
->
dŸdŸ
);

2111 
de
->
ªc_Àn
 = 
	`pxt4_ªc_Àn_to_disk
(
blocksize
 - 
	`PXT4_DIR_REC_LEN
(2),

2112 
blocksize
);

2113 
	`mem£t
 (&
roŸ
->
öfo
, 0, (root->info));

2114 
roŸ
->
öfo
.
öfo_Àngth
 = (root->info);

2115 
roŸ
->
öfo
.
hash_vîsi⁄
 = 
	`PXT4_SB
(
dú
->
i_sb
)->
s_def_hash_vîsi⁄
;

2116 
íåõs
 = 
roŸ
->entries;

2117 
	`dx_£t_block
(
íåõs
, 1);

2118 
	`dx_£t_cou¡
(
íåõs
, 1);

2119 
	`dx_£t_limô
(
íåõs
, 
	`dx_roŸ_limô
(
dú
, (
roŸ
->
öfo
)));

2122 
‚ame
->
höfo
.
hash_vîsi⁄
 = 
roŸ
->
öfo
.hash_version;

2123 i‡(
‚ame
->
höfo
.
hash_vîsi⁄
 <
DX_HASH_TEA
)

2124 
‚ame
->
höfo
.
hash_vîsi⁄
 +
	`PXT4_SB
(
dú
->
i_sb
)->
s_hash_unsig√d
;

2125 
‚ame
->
höfo
.
£ed
 = 
	`PXT4_SB
(
dú
->
i_sb
)->
s_hash_£ed
;

2126 
	`pxt4fs_dúhash
(
dú
, 
	`‚ame_«me
(
‚ame
), 
	`‚ame_Àn
(‚ame), &‚ame->
höfo
);

2128 
	`mem£t
(
‰ames
, 0, (frames));

2129 
‰ame
 = 
‰ames
;

2130 
‰ame
->
íåõs
 =Éntries;

2131 
‰ame
->
©
 = 
íåõs
;

2132 
‰ame
->
bh
 = bh;

2134 
ªtvÆ
 = 
	`pxt4_h™dÀ_dúty_dx_node
(
h™dÀ
, 
dú
, 
‰ame
->
bh
);

2135 i‡(
ªtvÆ
)

2136 
out_‰ames
;

2137 
ªtvÆ
 = 
	`pxt4_h™dÀ_dúty_dúblock
(
h™dÀ
, 
dú
, 
bh2
);

2138 i‡(
ªtvÆ
)

2139 
out_‰ames
;

2141 
de
 = 
	`do_•lô
(
h™dÀ
,
dú
, &
bh2
, 
‰ame
, &
‚ame
->
höfo
);

2142 i‡(
	`IS_ERR
(
de
)) {

2143 
ªtvÆ
 = 
	`PTR_ERR
(
de
);

2144 
out_‰ames
;

2147 
ªtvÆ
 = 
	`add_dúít_to_buf
(
h™dÀ
, 
‚ame
, 
dú
, 
öode
, 
de
, 
bh2
);

2148 
out_‰ames
:

2154 i‡(
ªtvÆ
)

2155 
	`pxt4_m¨k_öode_dúty
(
h™dÀ
, 
dú
);

2156 
	`dx_ªÀa£
(
‰ames
);

2157 
	`bªl£
(
bh2
);

2158  
ªtvÆ
;

2159 
	}
}

2171 
	$pxt4_add_íåy
(
h™dÀ_t
 *
h™dÀ
, 
díåy
 *dentry,

2172 
öode
 *inode)

2174 
öode
 *
dú
 = 
	`d_öode
(
díåy
->
d_∑ª¡
);

2175 
buf„r_hód
 *
bh
 = 
NULL
;

2176 
pxt4_dú_íåy_2
 *
de
;

2177 
su≥r_block
 *
sb
;

2178 
pxt4_sb_öfo
 *
sbi
;

2179 
pxt4_fûíame
 
‚ame
;

2180 
ªtvÆ
;

2181 
dx_ÁŒback
=0;

2182 
blocksize
;

2183 
pxt4_lblk_t
 
block
, 
blocks
;

2184 
csum_size
 = 0;

2186 i‡(
	`pxt4_has_mëad©a_csum
(
öode
->
i_sb
))

2187 
csum_size
 = (
pxt4_dú_íåy_èû
);

2189 
sb
 = 
dú
->
i_sb
;

2190 
sbi
 = 
	`PXT4_SB
(
sb
);

2191 
blocksize
 = 
sb
->
s_blocksize
;

2192 i‡(!
díåy
->
d_«me
.
Àn
)

2193  -
EINVAL
;

2195 i‡(
	`fs¸y±_is_nokey_«me
(
díåy
))

2196  -
ENOKEY
;

2198 #ifde‡
CONFIG_UNICODE


2199 i‡(
	`pxt4_has_°ri˘_mode
(
sbi
Ë&& 
	`IS_CASEFOLDED
(
dú
) &&

2200 
sbi
->
s_ícodög
 && 
	`utf8_vÆid©e
(sbi->s_ícodög, &
díåy
->
d_«me
))

2201  -
EINVAL
;

2204 
ªtvÆ
 = 
	`pxt4_‚ame_£tup_fûíame
(
dú
, &
díåy
->
d_«me
, 0, &
‚ame
);

2205 i‡(
ªtvÆ
)

2206  
ªtvÆ
;

2208 i‡(
	`pxt4_has_ölöe_d©a
(
dú
)) {

2209 
ªtvÆ
 = 
	`pxt4_åy_add_ölöe_íåy
(
h™dÀ
, &
‚ame
, 
dú
, 
öode
);

2210 i‡(
ªtvÆ
 < 0)

2211 
out
;

2212 i‡(
ªtvÆ
 == 1) {

2213 
ªtvÆ
 = 0;

2214 
out
;

2218 i‡(
	`is_dx
(
dú
)) {

2219 
ªtvÆ
 = 
	`pxt4_dx_add_íåy
(
h™dÀ
, &
‚ame
, 
dú
, 
öode
);

2220 i‡(!
ªtvÆ
 || (ªtvÆ !
ERR_BAD_DX_DIR
))

2221 
out
;

2223 i‡(
	`pxt4_has_mëad©a_csum
(
sb
)) {

2224 
	`PXT4_ERROR_INODE
(
dú
,

2226 
ªtvÆ
 = -
EFSCORRUPTED
;

2227 
out
;

2229 
	`pxt4_˛ór_öode_Êag
(
dú
, 
PXT4_INODE_INDEX
);

2230 
dx_ÁŒback
++;

2231 
	`pxt4_m¨k_öode_dúty
(
h™dÀ
, 
dú
);

2233 
blocks
 = 
dú
->
i_size
 >> 
sb
->
s_blocksize_bôs
;

2234 
block
 = 0; block < 
blocks
; block++) {

2235 
bh
 = 
	`pxt4_ªad_dúblock
(
dú
, 
block
, 
DIRENT
);

2236 i‡(
bh
 =
NULL
) {

2237 
bh
 = 
	`pxt4_bªad
(
h™dÀ
, 
dú
, 
block
,

2238 
PXT4_GET_BLOCKS_CREATE
);

2239 
add_to_√w_block
;

2241 i‡(
	`IS_ERR
(
bh
)) {

2242 
ªtvÆ
 = 
	`PTR_ERR
(
bh
);

2243 
bh
 = 
NULL
;

2244 
out
;

2246 
ªtvÆ
 = 
	`add_dúít_to_buf
(
h™dÀ
, &
‚ame
, 
dú
, 
öode
,

2247 
NULL
, 
bh
);

2248 i‡(
ªtvÆ
 !-
ENOSPC
)

2249 
out
;

2251 i‡(
blocks
 =1 && !
dx_ÁŒback
 &&

2252 
	`pxt4_has_„©uª_dú_ödex
(
sb
)) {

2253 
ªtvÆ
 = 
	`make_ödexed_dú
(
h™dÀ
, &
‚ame
, 
dú
,

2254 
öode
, 
bh
);

2255 
bh
 = 
NULL
;

2256 
out
;

2258 
	`bªl£
(
bh
);

2260 
bh
 = 
	`pxt4_≠≥nd
(
h™dÀ
, 
dú
, &
block
);

2261 
add_to_√w_block
:

2262 i‡(
	`IS_ERR
(
bh
)) {

2263 
ªtvÆ
 = 
	`PTR_ERR
(
bh
);

2264 
bh
 = 
NULL
;

2265 
out
;

2267 
de
 = (
pxt4_dú_íåy_2
 *Ë
bh
->
b_d©a
;

2268 
de
->
öode
 = 0;

2269 
de
->
ªc_Àn
 = 
	`pxt4_ªc_Àn_to_disk
(
blocksize
 - 
csum_size
, blocksize);

2271 i‡(
csum_size
)

2272 
	`pxt4_öôülize_dúít_èû
(
bh
, 
blocksize
);

2274 
ªtvÆ
 = 
	`add_dúít_to_buf
(
h™dÀ
, &
‚ame
, 
dú
, 
öode
, 
de
, 
bh
);

2275 
out
:

2276 
	`pxt4_‚ame_‰ì_fûíame
(&
‚ame
);

2277 
	`bªl£
(
bh
);

2278 i‡(
ªtvÆ
 == 0)

2279 
	`pxt4_£t_öode_°©e
(
öode
, 
PXT4_STATE_NEWENTRY
);

2280  
ªtvÆ
;

2281 
	}
}

2286 
	$pxt4_dx_add_íåy
(
h™dÀ_t
 *
h™dÀ
, 
pxt4_fûíame
 *
‚ame
,

2287 
öode
 *
dú
, inode *inode)

2289 
dx_‰ame
 
‰ames
[
PXT4_HTREE_LEVEL
], *
‰ame
;

2290 
dx_íåy
 *
íåõs
, *
©
;

2291 
buf„r_hód
 *
bh
;

2292 
su≥r_block
 *
sb
 = 
dú
->
i_sb
;

2293 
pxt4_dú_íåy_2
 *
de
;

2294 
ª°¨t
;

2295 
îr
;

2297 
agaö
:

2298 
ª°¨t
 = 0;

2299 
‰ame
 = 
	`dx_¥obe
(
‚ame
, 
dú
, 
NULL
, 
‰ames
);

2300 i‡(
	`IS_ERR
(
‰ame
))

2301  
	`PTR_ERR
(
‰ame
);

2302 
íåõs
 = 
‰ame
->entries;

2303 
©
 = 
‰ame
->at;

2304 
bh
 = 
	`pxt4_ªad_dúblock
(
dú
, 
	`dx_gë_block
(
‰ame
->
©
), 
DIRENT_HTREE
);

2305 i‡(
	`IS_ERR
(
bh
)) {

2306 
îr
 = 
	`PTR_ERR
(
bh
);

2307 
bh
 = 
NULL
;

2308 
˛ónup
;

2311 
	`BUFFER_TRACE
(
bh
, "get_write_access");

2312 
îr
 = 
	`pxt4_jou∫Æ_gë_wrôe_ac˚ss
(
h™dÀ
, 
bh
);

2313 i‡(
îr
)

2314 
jou∫Æ_îr‹
;

2316 
îr
 = 
	`add_dúít_to_buf
(
h™dÀ
, 
‚ame
, 
dú
, 
öode
, 
NULL
, 
bh
);

2317 i‡(
îr
 !-
ENOSPC
)

2318 
˛ónup
;

2320 
îr
 = 0;

2322 
	`dxåa˚
(
	`¥ötk
(
KERN_DEBUG
 "using %u of %uÇodeÉntries\n",

2323 
	`dx_gë_cou¡
(
íåõs
), 
	`dx_gë_limô
(entries)));

2325 i‡(
	`dx_gë_cou¡
(
íåõs
Ë=
	`dx_gë_limô
(entries)) {

2326 
pxt4_lblk_t
 
√wblock
;

2327 
Àvñs
 = 
‰ame
 - 
‰ames
 + 1;

2328 
icou¡
;

2329 
add_Àvñ
 = 1;

2330 
dx_íåy
 *
íåõs2
;

2331 
dx_node
 *
node2
;

2332 
buf„r_hód
 *
bh2
;

2334 
‰ame
 > 
‰ames
) {

2335 i‡(
	`dx_gë_cou¡
((
‰ame
 - 1)->
íåõs
) <

2336 
	`dx_gë_limô
((
‰ame
 - 1)->
íåõs
)) {

2337 
add_Àvñ
 = 0;

2340 
‰ame
--;

2341 
©
 = 
‰ame
->at;

2342 
íåõs
 = 
‰ame
->entries;

2343 
ª°¨t
 = 1;

2345 i‡(
add_Àvñ
 && 
Àvñs
 =
	`pxt4_dú_håì_Àvñ
(
sb
)) {

2346 
	`pxt4_w¨nög
(
sb
, "Directory (ino: %lu) index full, "

2348 
dú
->
i_öo
, 
Àvñs
);

2349 i‡(
	`pxt4_dú_håì_Àvñ
(
sb
Ë< 
PXT4_HTREE_LEVEL
) {

2350 
	`pxt4_w¨nög
(
sb
, "Large directory feature is "

2354 
îr
 = -
ENOSPC
;

2355 
˛ónup
;

2357 
icou¡
 = 
	`dx_gë_cou¡
(
íåõs
);

2358 
bh2
 = 
	`pxt4_≠≥nd
(
h™dÀ
, 
dú
, &
√wblock
);

2359 i‡(
	`IS_ERR
(
bh2
)) {

2360 
îr
 = 
	`PTR_ERR
(
bh2
);

2361 
˛ónup
;

2363 
node2
 = (
dx_node
 *)(
bh2
->
b_d©a
);

2364 
íåõs2
 = 
node2
->
íåõs
;

2365 
	`mem£t
(&
node2
->
Áke
, 0, (
Áke_dúít
));

2366 
node2
->
Áke
.
ªc_Àn
 = 
	`pxt4_ªc_Àn_to_disk
(
sb
->
s_blocksize
,

2367 
sb
->
s_blocksize
);

2368 
	`BUFFER_TRACE
(
‰ame
->
bh
, "get_write_access");

2369 
îr
 = 
	`pxt4_jou∫Æ_gë_wrôe_ac˚ss
(
h™dÀ
, 
‰ame
->
bh
);

2370 i‡(
îr
)

2371 
jou∫Æ_îr‹
;

2372 i‡(!
add_Àvñ
) {

2373 
icou¡1
 = 
icou¡
/2, 
icou¡2
 = icount - icount1;

2374 
hash2
 = 
	`dx_gë_hash
(
íåõs
 + 
icou¡1
);

2375 
	`dxåa˚
(
	`¥ötk
(
KERN_DEBUG
 "Split index %i/%i\n",

2376 
icou¡1
, 
icou¡2
));

2378 
	`BUFFER_TRACE
(
‰ame
->
bh
, "get_write_access");

2379 
îr
 = 
	`pxt4_jou∫Æ_gë_wrôe_ac˚ss
(
h™dÀ
,

2380 (
‰ame
 - 1)->
bh
);

2381 i‡(
îr
)

2382 
jou∫Æ_îr‹
;

2384 
	`mem˝y
((*Ë
íåõs2
, (*Ë(
íåõs
 + 
icou¡1
),

2385 
icou¡2
 * (
dx_íåy
));

2386 
	`dx_£t_cou¡
(
íåõs
, 
icou¡1
);

2387 
	`dx_£t_cou¡
(
íåõs2
, 
icou¡2
);

2388 
	`dx_£t_limô
(
íåõs2
, 
	`dx_node_limô
(
dú
));

2391 i‡(
©
 - 
íåõs
 >
icou¡1
) {

2392 
‰ame
->
©
 =áà© - 
íåõs
 - 
icou¡1
 + 
íåõs2
;

2393 
‰ame
->
íåõs
 =É¡rõ†
íåõs2
;

2394 
	`sw≠
(
‰ame
->
bh
, 
bh2
);

2396 
	`dx_ö£π_block
((
‰ame
 - 1), 
hash2
, 
√wblock
);

2397 
	`dxåa˚
(
	`dx_show_ödex
("node", 
‰ame
->
íåõs
));

2398 
	`dxåa˚
(
	`dx_show_ödex
("node",

2399 ((
dx_node
 *Ë
bh2
->
b_d©a
)->
íåõs
));

2400 
îr
 = 
	`pxt4_h™dÀ_dúty_dx_node
(
h™dÀ
, 
dú
, 
bh2
);

2401 i‡(
îr
)

2402 
jou∫Æ_îr‹
;

2403 
	`bªl£
 (
bh2
);

2404 
îr
 = 
	`pxt4_h™dÀ_dúty_dx_node
(
h™dÀ
, 
dú
,

2405 (
‰ame
 - 1)->
bh
);

2406 i‡(
îr
)

2407 
jou∫Æ_îr‹
;

2408 
îr
 = 
	`pxt4_h™dÀ_dúty_dx_node
(
h™dÀ
, 
dú
,

2409 
‰ame
->
bh
);

2410 i‡(
ª°¨t
 || 
îr
)

2411 
jou∫Æ_îr‹
;

2413 
dx_roŸ
 *
dxroŸ
;

2414 
	`mem˝y
((*Ë
íåõs2
, (*Ë
íåõs
,

2415 
icou¡
 * (
dx_íåy
));

2416 
	`dx_£t_limô
(
íåõs2
, 
	`dx_node_limô
(
dú
));

2419 
	`dx_£t_cou¡
(
íåõs
, 1);

2420 
	`dx_£t_block
(
íåõs
 + 0, 
√wblock
);

2421 
dxroŸ
 = (
dx_roŸ
 *)
‰ames
[0].
bh
->
b_d©a
;

2422 
dxroŸ
->
öfo
.
ödúe˘_Àvñs
 += 1;

2423 
	`dxåa˚
(
	`¥ötk
(
KERN_DEBUG


2425 
dxroŸ
->
öfo
.
ödúe˘_Àvñs
));

2426 
îr
 = 
	`pxt4_h™dÀ_dúty_dx_node
(
h™dÀ
, 
dú
, 
‰ame
->
bh
);

2427 i‡(
îr
)

2428 
jou∫Æ_îr‹
;

2429 
îr
 = 
	`pxt4_h™dÀ_dúty_dx_node
(
h™dÀ
, 
dú
, 
bh2
);

2430 
	`bªl£
(
bh2
);

2431 
ª°¨t
 = 1;

2432 
jou∫Æ_îr‹
;

2435 
de
 = 
	`do_•lô
(
h™dÀ
, 
dú
, &
bh
, 
‰ame
, &
‚ame
->
höfo
);

2436 i‡(
	`IS_ERR
(
de
)) {

2437 
îr
 = 
	`PTR_ERR
(
de
);

2438 
˛ónup
;

2440 
îr
 = 
	`add_dúít_to_buf
(
h™dÀ
, 
‚ame
, 
dú
, 
öode
, 
de
, 
bh
);

2441 
˛ónup
;

2443 
jou∫Æ_îr‹
:

2444 
	`pxt4_°d_îr‹
(
dú
->
i_sb
, 
îr
);

2445 
˛ónup
:

2446 
	`bªl£
(
bh
);

2447 
	`dx_ªÀa£
(
‰ames
);

2451 i‡(
ª°¨t
 && 
îr
 == 0)

2452 
agaö
;

2453  
îr
;

2454 
	}
}

2460 
	$pxt4_gíîic_dñëe_íåy
(
h™dÀ_t
 *
h™dÀ
,

2461 
öode
 *
dú
,

2462 
pxt4_dú_íåy_2
 *
de_dñ
,

2463 
buf„r_hód
 *
bh
,

2464 *
íåy_buf
,

2465 
buf_size
,

2466 
csum_size
)

2468 
pxt4_dú_íåy_2
 *
de
, *
pde
;

2469 
blocksize
 = 
dú
->
i_sb
->
s_blocksize
;

2470 
i
;

2472 
i
 = 0;

2473 
pde
 = 
NULL
;

2474 
de
 = (
pxt4_dú_íåy_2
 *)
íåy_buf
;

2475 
i
 < 
buf_size
 - 
csum_size
) {

2476 i‡(
	`pxt4_check_dú_íåy
(
dú
, 
NULL
, 
de
, 
bh
,

2477 
íåy_buf
, 
buf_size
, 
i
))

2478  -
EFSCORRUPTED
;

2479 i‡(
de
 =
de_dñ
) {

2480 i‡(
pde
)

2481 
pde
->
ªc_Àn
 = 
	`pxt4_ªc_Àn_to_disk
(

2482 
	`pxt4_ªc_Àn_‰om_disk
(
pde
->
ªc_Àn
,

2483 
blocksize
) +

2484 
	`pxt4_ªc_Àn_‰om_disk
(
de
->
ªc_Àn
,

2485 
blocksize
),

2486 
blocksize
);

2488 
de
->
öode
 = 0;

2489 
	`öode_öc_ivîsi⁄
(
dú
);

2492 
i
 +
	`pxt4_ªc_Àn_‰om_disk
(
de
->
ªc_Àn
, 
blocksize
);

2493 
pde
 = 
de
;

2494 
de
 = 
	`pxt4_√xt_íåy
(de, 
blocksize
);

2496  -
ENOENT
;

2497 
	}
}

2499 
	$pxt4_dñëe_íåy
(
h™dÀ_t
 *
h™dÀ
,

2500 
öode
 *
dú
,

2501 
pxt4_dú_íåy_2
 *
de_dñ
,

2502 
buf„r_hód
 *
bh
)

2504 
îr
, 
csum_size
 = 0;

2506 i‡(
	`pxt4_has_ölöe_d©a
(
dú
)) {

2507 
has_ölöe_d©a
 = 1;

2508 
îr
 = 
	`pxt4_dñëe_ölöe_íåy
(
h™dÀ
, 
dú
, 
de_dñ
, 
bh
,

2509 &
has_ölöe_d©a
);

2510 i‡(
has_ölöe_d©a
)

2511  
îr
;

2514 i‡(
	`pxt4_has_mëad©a_csum
(
dú
->
i_sb
))

2515 
csum_size
 = (
pxt4_dú_íåy_èû
);

2517 
	`BUFFER_TRACE
(
bh
, "get_write_access");

2518 
îr
 = 
	`pxt4_jou∫Æ_gë_wrôe_ac˚ss
(
h™dÀ
, 
bh
);

2519 i‡(
	`u∆ikñy
(
îr
))

2520 
out
;

2522 
îr
 = 
	`pxt4_gíîic_dñëe_íåy
(
h™dÀ
, 
dú
, 
de_dñ
,

2523 
bh
, bh->
b_d©a
,

2524 
dú
->
i_sb
->
s_blocksize
, 
csum_size
);

2525 i‡(
îr
)

2526 
out
;

2528 
	`BUFFER_TRACE
(
bh
, "callÖxt4_handle_dirty_metadata");

2529 
îr
 = 
	`pxt4_h™dÀ_dúty_dúblock
(
h™dÀ
, 
dú
, 
bh
);

2530 i‡(
	`u∆ikñy
(
îr
))

2531 
out
;

2534 
out
:

2535 i‡(
îr
 !-
ENOENT
)

2536 
	`pxt4_°d_îr‹
(
dú
->
i_sb
, 
îr
);

2537  
îr
;

2538 
	}
}

2551 
	$pxt4_öc_cou¡
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *inode)

2553 
	`öc_∆ök
(
öode
);

2554 i‡(
	`is_dx
(
öode
) &&

2555 (
öode
->
i_∆ök
 > 
PXT4_LINK_MAX
 || inode->i_nlink == 2))

2556 
	`£t_∆ök
(
öode
, 1);

2557 
	}
}

2563 
	$pxt4_dec_cou¡
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *inode)

2565 i‡(!
	`S_ISDIR
(
öode
->
i_mode
Ë|| inode->
i_∆ök
 > 2)

2566 
	`dr›_∆ök
(
öode
);

2567 
	}
}

2570 
	$pxt4_add_n⁄dú
(
h™dÀ_t
 *
h™dÀ
,

2571 
díåy
 *díåy, 
öode
 *inode)

2573 
îr
 = 
	`pxt4_add_íåy
(
h™dÀ
, 
díåy
, 
öode
);

2574 i‡(!
îr
) {

2575 
	`pxt4_m¨k_öode_dúty
(
h™dÀ
, 
öode
);

2576 
	`d_ö°™tüã_√w
(
díåy
, 
öode
);

2579 
	`dr›_∆ök
(
öode
);

2580 
	`u∆ock_√w_öode
(
öode
);

2581 
	`ùut
(
öode
);

2582  
îr
;

2583 
	}
}

2593 
	$pxt4_¸óã
(
öode
 *
dú
, 
díåy
 *díåy, 
umode_t
 
mode
,

2594 
boﬁ
 
ex˛
)

2596 
h™dÀ_t
 *
h™dÀ
;

2597 
öode
 *inode;

2598 
îr
, 
¸edôs
, 
ªåõs
 = 0;

2600 
îr
 = 
	`dquŸ_öôülize
(
dú
);

2601 i‡(
îr
)

2602  
îr
;

2604 
¸edôs
 = (
	`PXT4_DATA_TRANS_BLOCKS
(
dú
->
i_sb
) +

2605 
PXT4_INDEX_EXTRA_TRANS_BLOCKS
 + 3);

2606 
ªåy
:

2607 
öode
 = 
	`pxt4_√w_öode_°¨t_h™dÀ
(
dú
, 
mode
, &
díåy
->
d_«me
, 0,

2608 
NULL
, 
PXT4_HT_DIR
, 
¸edôs
);

2609 
h™dÀ
 = 
	`pxt4_jou∫Æ_cuºít_h™dÀ
();

2610 
îr
 = 
	`PTR_ERR
(
öode
);

2611 i‡(!
	`IS_ERR
(
öode
)) {

2612 
öode
->
i_›
 = &
pxt4_fûe_öode_›î©i⁄s
;

2613 
öode
->
i_f›
 = &
pxt4_fûe_›î©i⁄s
;

2614 
	`pxt4_£t_a›s
(
öode
);

2615 
îr
 = 
	`pxt4_add_n⁄dú
(
h™dÀ
, 
díåy
, 
öode
);

2616 i‡(!
îr
 && 
	`IS_DIRSYNC
(
dú
))

2617 
	`pxt4_h™dÀ_sync
(
h™dÀ
);

2619 i‡(
h™dÀ
)

2620 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

2621 i‡(
îr
 =-
ENOSPC
 && 
	`pxt4_should_ªåy_Æloc
(
dú
->
i_sb
, &
ªåõs
))

2622 
ªåy
;

2623  
îr
;

2624 
	}
}

2626 
	$pxt4_mknod
(
öode
 *
dú
, 
díåy
 *dentry,

2627 
umode_t
 
mode
, 
dev_t
 
rdev
)

2629 
h™dÀ_t
 *
h™dÀ
;

2630 
öode
 *inode;

2631 
îr
, 
¸edôs
, 
ªåõs
 = 0;

2633 
îr
 = 
	`dquŸ_öôülize
(
dú
);

2634 i‡(
îr
)

2635  
îr
;

2637 
¸edôs
 = (
	`PXT4_DATA_TRANS_BLOCKS
(
dú
->
i_sb
) +

2638 
PXT4_INDEX_EXTRA_TRANS_BLOCKS
 + 3);

2639 
ªåy
:

2640 
öode
 = 
	`pxt4_√w_öode_°¨t_h™dÀ
(
dú
, 
mode
, &
díåy
->
d_«me
, 0,

2641 
NULL
, 
PXT4_HT_DIR
, 
¸edôs
);

2642 
h™dÀ
 = 
	`pxt4_jou∫Æ_cuºít_h™dÀ
();

2643 
îr
 = 
	`PTR_ERR
(
öode
);

2644 i‡(!
	`IS_ERR
(
öode
)) {

2645 
	`öô_•ecül_öode
(
öode
, inode->
i_mode
, 
rdev
);

2646 
öode
->
i_›
 = &
pxt4_•ecül_öode_›î©i⁄s
;

2647 
îr
 = 
	`pxt4_add_n⁄dú
(
h™dÀ
, 
díåy
, 
öode
);

2648 i‡(!
îr
 && 
	`IS_DIRSYNC
(
dú
))

2649 
	`pxt4_h™dÀ_sync
(
h™dÀ
);

2651 i‡(
h™dÀ
)

2652 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

2653 i‡(
îr
 =-
ENOSPC
 && 
	`pxt4_should_ªåy_Æloc
(
dú
->
i_sb
, &
ªåõs
))

2654 
ªåy
;

2655  
îr
;

2656 
	}
}

2658 
	$pxt4_tmpfûe
(
öode
 *
dú
, 
díåy
 *díåy, 
umode_t
 
mode
)

2660 
h™dÀ_t
 *
h™dÀ
;

2661 
öode
 *inode;

2662 
îr
, 
ªåõs
 = 0;

2664 
îr
 = 
	`dquŸ_öôülize
(
dú
);

2665 i‡(
îr
)

2666  
îr
;

2668 
ªåy
:

2669 
öode
 = 
	`pxt4_√w_öode_°¨t_h™dÀ
(
dú
, 
mode
,

2670 
NULL
, 0, NULL,

2671 
PXT4_HT_DIR
,

2672 
	`PXT4_MAXQUOTAS_INIT_BLOCKS
(
dú
->
i_sb
) +

2673 4 + 
PXT4_XATTR_TRANS_BLOCKS
);

2674 
h™dÀ
 = 
	`pxt4_jou∫Æ_cuºít_h™dÀ
();

2675 
îr
 = 
	`PTR_ERR
(
öode
);

2676 i‡(!
	`IS_ERR
(
öode
)) {

2677 
öode
->
i_›
 = &
pxt4_fûe_öode_›î©i⁄s
;

2678 
öode
->
i_f›
 = &
pxt4_fûe_›î©i⁄s
;

2679 
	`pxt4_£t_a›s
(
öode
);

2680 
	`d_tmpfûe
(
díåy
, 
öode
);

2681 
îr
 = 
	`pxt4_‹ph™_add
(
h™dÀ
, 
öode
);

2682 i‡(
îr
)

2683 
îr_u∆ock_öode
;

2684 
	`m¨k_öode_dúty
(
öode
);

2685 
	`u∆ock_√w_öode
(
öode
);

2687 i‡(
h™dÀ
)

2688 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

2689 i‡(
îr
 =-
ENOSPC
 && 
	`pxt4_should_ªåy_Æloc
(
dú
->
i_sb
, &
ªåõs
))

2690 
ªåy
;

2691  
îr
;

2692 
îr_u∆ock_öode
:

2693 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

2694 
	`u∆ock_√w_öode
(
öode
);

2695  
îr
;

2696 
	}
}

2698 
pxt4_dú_íåy_2
 *
	$pxt4_öô_dŸ_dŸdŸ
(
öode
 *inode,

2699 
pxt4_dú_íåy_2
 *
de
,

2700 
blocksize
, 
csum_size
,

2701 
∑ª¡_öo
, 
dŸdŸ_ªÆ_Àn
)

2703 
de
->
öode
 = 
	`˝u_to_À32
(öode->
i_öo
);

2704 
de
->
«me_Àn
 = 1;

2705 
de
->
ªc_Àn
 = 
	`pxt4_ªc_Àn_to_disk
(
	`PXT4_DIR_REC_LEN
(de->
«me_Àn
),

2706 
blocksize
);

2707 
	`°r˝y
(
de
->
«me
, ".");

2708 
	`pxt4_£t_de_ty≥
(
öode
->
i_sb
, 
de
, 
S_IFDIR
);

2710 
de
 = 
	`pxt4_√xt_íåy
(de, 
blocksize
);

2711 
de
->
öode
 = 
	`˝u_to_À32
(
∑ª¡_öo
);

2712 
de
->
«me_Àn
 = 2;

2713 i‡(!
dŸdŸ_ªÆ_Àn
)

2714 
de
->
ªc_Àn
 = 
	`pxt4_ªc_Àn_to_disk
(
blocksize
 -

2715 (
csum_size
 + 
	`PXT4_DIR_REC_LEN
(1)),

2716 
blocksize
);

2718 
de
->
ªc_Àn
 = 
	`pxt4_ªc_Àn_to_disk
(

2719 
	`PXT4_DIR_REC_LEN
(
de
->
«me_Àn
), 
blocksize
);

2720 
	`°r˝y
(
de
->
«me
, "..");

2721 
	`pxt4_£t_de_ty≥
(
öode
->
i_sb
, 
de
, 
S_IFDIR
);

2723  
	`pxt4_√xt_íåy
(
de
, 
blocksize
);

2724 
	}
}

2726 
	$pxt4_öô_√w_dú
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *
dú
,

2727 
öode
 *inode)

2729 
buf„r_hód
 *
dú_block
 = 
NULL
;

2730 
pxt4_dú_íåy_2
 *
de
;

2731 
pxt4_lblk_t
 
block
 = 0;

2732 
blocksize
 = 
dú
->
i_sb
->
s_blocksize
;

2733 
csum_size
 = 0;

2734 
îr
;

2736 i‡(
	`pxt4_has_mëad©a_csum
(
dú
->
i_sb
))

2737 
csum_size
 = (
pxt4_dú_íåy_èû
);

2739 i‡(
	`pxt4_ã°_öode_°©e
(
öode
, 
PXT4_STATE_MAY_INLINE_DATA
)) {

2740 
îr
 = 
	`pxt4_åy_¸óã_ölöe_dú
(
h™dÀ
, 
dú
, 
öode
);

2741 i‡(
îr
 < 0 &&Éº !-
ENOSPC
)

2742 
out
;

2743 i‡(!
îr
)

2744 
out
;

2747 
öode
->
i_size
 = 0;

2748 
dú_block
 = 
	`pxt4_≠≥nd
(
h™dÀ
, 
öode
, &
block
);

2749 i‡(
	`IS_ERR
(
dú_block
))

2750  
	`PTR_ERR
(
dú_block
);

2751 
de
 = (
pxt4_dú_íåy_2
 *)
dú_block
->
b_d©a
;

2752 
	`pxt4_öô_dŸ_dŸdŸ
(
öode
, 
de
, 
blocksize
, 
csum_size
, 
dú
->
i_öo
, 0);

2753 
	`£t_∆ök
(
öode
, 2);

2754 i‡(
csum_size
)

2755 
	`pxt4_öôülize_dúít_èû
(
dú_block
, 
blocksize
);

2757 
	`BUFFER_TRACE
(
dú_block
, "callÖxt4_handle_dirty_metadata");

2758 
îr
 = 
	`pxt4_h™dÀ_dúty_dúblock
(
h™dÀ
, 
öode
, 
dú_block
);

2759 i‡(
îr
)

2760 
out
;

2761 
	`£t_buf„r_vîifõd
(
dú_block
);

2762 
out
:

2763 
	`bªl£
(
dú_block
);

2764  
îr
;

2765 
	}
}

2767 
	$pxt4_mkdú
(
öode
 *
dú
, 
díåy
 *díåy, 
umode_t
 
mode
)

2769 
h™dÀ_t
 *
h™dÀ
;

2770 
öode
 *inode;

2771 
îr
, 
¸edôs
, 
ªåõs
 = 0;

2773 i‡(
	`PXT4_DIR_LINK_MAX
(
dú
))

2774  -
EMLINK
;

2776 
îr
 = 
	`dquŸ_öôülize
(
dú
);

2777 i‡(
îr
)

2778  
îr
;

2780 
¸edôs
 = (
	`PXT4_DATA_TRANS_BLOCKS
(
dú
->
i_sb
) +

2781 
PXT4_INDEX_EXTRA_TRANS_BLOCKS
 + 3);

2782 
ªåy
:

2783 
öode
 = 
	`pxt4_√w_öode_°¨t_h™dÀ
(
dú
, 
S_IFDIR
 | 
mode
,

2784 &
díåy
->
d_«me
,

2785 0, 
NULL
, 
PXT4_HT_DIR
, 
¸edôs
);

2786 
h™dÀ
 = 
	`pxt4_jou∫Æ_cuºít_h™dÀ
();

2787 
îr
 = 
	`PTR_ERR
(
öode
);

2788 i‡(
	`IS_ERR
(
öode
))

2789 
out_°›
;

2791 
öode
->
i_›
 = &
pxt4_dú_öode_›î©i⁄s
;

2792 
öode
->
i_f›
 = &
pxt4_dú_›î©i⁄s
;

2793 
îr
 = 
	`pxt4_öô_√w_dú
(
h™dÀ
, 
dú
, 
öode
);

2794 i‡(
îr
)

2795 
out_˛ór_öode
;

2796 
îr
 = 
	`pxt4_m¨k_öode_dúty
(
h™dÀ
, 
öode
);

2797 i‡(!
îr
)

2798 
îr
 = 
	`pxt4_add_íåy
(
h™dÀ
, 
díåy
, 
öode
);

2799 i‡(
îr
) {

2800 
out_˛ór_öode
:

2801 
	`˛ór_∆ök
(
öode
);

2802 
	`u∆ock_√w_öode
(
öode
);

2803 
	`pxt4_m¨k_öode_dúty
(
h™dÀ
, 
öode
);

2804 
	`ùut
(
öode
);

2805 
out_°›
;

2807 
	`pxt4_öc_cou¡
(
h™dÀ
, 
dú
);

2808 
	`pxt4_upd©e_dx_Êag
(
dú
);

2809 
îr
 = 
	`pxt4_m¨k_öode_dúty
(
h™dÀ
, 
dú
);

2810 i‡(
îr
)

2811 
out_˛ór_öode
;

2812 
	`d_ö°™tüã_√w
(
díåy
, 
öode
);

2813 i‡(
	`IS_DIRSYNC
(
dú
))

2814 
	`pxt4_h™dÀ_sync
(
h™dÀ
);

2816 
out_°›
:

2817 i‡(
h™dÀ
)

2818 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

2819 i‡(
îr
 =-
ENOSPC
 && 
	`pxt4_should_ªåy_Æloc
(
dú
->
i_sb
, &
ªåõs
))

2820 
ªåy
;

2821  
îr
;

2822 
	}
}

2827 
boﬁ
 
	$pxt4_em±y_dú
(
öode
 *inode)

2829 
off£t
;

2830 
buf„r_hód
 *
bh
;

2831 
pxt4_dú_íåy_2
 *
de
;

2832 
su≥r_block
 *
sb
;

2834 i‡(
	`pxt4_has_ölöe_d©a
(
öode
)) {

2835 
has_ölöe_d©a
 = 1;

2836 
ªt
;

2838 
ªt
 = 
	`em±y_ölöe_dú
(
öode
, &
has_ölöe_d©a
);

2839 i‡(
has_ölöe_d©a
)

2840  
ªt
;

2843 
sb
 = 
öode
->
i_sb
;

2844 i‡(
öode
->
i_size
 < 
	`PXT4_DIR_REC_LEN
(1) + PXT4_DIR_REC_LEN(2)) {

2845 
	`PXT4_ERROR_INODE
(
öode
, "invalid size");

2846  
åue
;

2851 
bh
 = 
	`pxt4_ªad_dúblock
(
öode
, 0, 
DIRENT_HTREE
);

2852 i‡(
	`IS_ERR
(
bh
))

2853  
åue
;

2855 
de
 = (
pxt4_dú_íåy_2
 *Ë
bh
->
b_d©a
;

2856 i‡(
	`pxt4_check_dú_íåy
(
öode
, 
NULL
, 
de
, 
bh
, bh->
b_d©a
, bh->
b_size
,

2858 
	`À32_to_˝u
(
de
->
öode
Ë!öode->
i_öo
 || 
	`°rcmp
(".", de->
«me
)) {

2859 
	`pxt4_w¨nög_öode
(
öode
, "directory missing '.'");

2860 
	`bªl£
(
bh
);

2861  
åue
;

2863 
off£t
 = 
	`pxt4_ªc_Àn_‰om_disk
(
de
->
ªc_Àn
, 
sb
->
s_blocksize
);

2864 
de
 = 
	`pxt4_√xt_íåy
(de, 
sb
->
s_blocksize
);

2865 i‡(
	`pxt4_check_dú_íåy
(
öode
, 
NULL
, 
de
, 
bh
, bh->
b_d©a
, bh->
b_size
,

2866 
off£t
) ||

2867 
	`À32_to_˝u
(
de
->
öode
Ë=0 || 
	`°rcmp
("..", de->
«me
)) {

2868 
	`pxt4_w¨nög_öode
(
öode
, "directory missing '..'");

2869 
	`bªl£
(
bh
);

2870  
åue
;

2872 
off£t
 +
	`pxt4_ªc_Àn_‰om_disk
(
de
->
ªc_Àn
, 
sb
->
s_blocksize
);

2873 
off£t
 < 
öode
->
i_size
) {

2874 i‡(!(
off£t
 & (
sb
->
s_blocksize
 - 1))) {

2875 
lblock
;

2876 
	`bªl£
(
bh
);

2877 
lblock
 = 
off£t
 >> 
	`PXT4_BLOCK_SIZE_BITS
(
sb
);

2878 
bh
 = 
	`pxt4_ªad_dúblock
(
öode
, 
lblock
, 
EITHER
);

2879 i‡(
bh
 =
NULL
) {

2880 
off£t
 +
sb
->
s_blocksize
;

2883 i‡(
	`IS_ERR
(
bh
))

2884  
åue
;

2886 
de
 = (
pxt4_dú_íåy_2
 *Ë(
bh
->
b_d©a
 +

2887 (
off£t
 & (
sb
->
s_blocksize
 - 1)));

2888 i‡(
	`pxt4_check_dú_íåy
(
öode
, 
NULL
, 
de
, 
bh
,

2889 
bh
->
b_d©a
, bh->
b_size
, 
off£t
)) {

2890 
off£t
 = (off£à| (
sb
->
s_blocksize
 - 1)) + 1;

2893 i‡(
	`À32_to_˝u
(
de
->
öode
)) {

2894 
	`bªl£
(
bh
);

2895  
Ál£
;

2897 
off£t
 +
	`pxt4_ªc_Àn_‰om_disk
(
de
->
ªc_Àn
, 
sb
->
s_blocksize
);

2899 
	`bªl£
(
bh
);

2900  
åue
;

2901 
	}
}

2915 
	$pxt4_‹ph™_add
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *inode)

2917 
su≥r_block
 *
sb
 = 
öode
->
i_sb
;

2918 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
sb
);

2919 
pxt4_ûoc
 
ûoc
;

2920 
îr
 = 0, 
rc
;

2921 
boﬁ
 
dúty
 = 
Ál£
;

2923 i‡(!
sbi
->
s_jou∫Æ
 || 
	`is_bad_öode
(
öode
))

2926 
	`WARN_ON_ONCE
(!(
öode
->
i_°©e
 & (
I_NEW
 | 
I_FREEING
)) &&

2927 !
	`öode_is_locked
(
öode
));

2932 i‡(!
	`li°_em±y
(&
	`PXT4_I
(
öode
)->
i_‹ph™
))

2941 
	`J_ASSERT
((
	`S_ISREG
(
öode
->
i_mode
Ë|| 
	`S_ISDIR
(inode->i_mode) ||

2942 
	`S_ISLNK
(
öode
->
i_mode
)Ë|| inode->
i_∆ök
 == 0);

2944 
	`BUFFER_TRACE
(
sbi
->
s_sbh
, "get_write_access");

2945 
îr
 = 
	`pxt4_jou∫Æ_gë_wrôe_ac˚ss
(
h™dÀ
, 
sbi
->
s_sbh
);

2946 i‡(
îr
)

2947 
out
;

2949 
îr
 = 
	`pxt4_ª£rve_öode_wrôe
(
h™dÀ
, 
öode
, &
ûoc
);

2950 i‡(
îr
)

2951 
out
;

2953 
	`muãx_lock
(&
sbi
->
s_‹ph™_lock
);

2958 i‡(!
	`NEXT_ORPHAN
(
öode
) || NEXT_ORPHAN(inode) >

2959 (
	`À32_to_˝u
(
sbi
->
s_es
->
s_öodes_cou¡
))) {

2961 
	`NEXT_ORPHAN
(
öode
Ë
	`À32_to_˝u
(
sbi
->
s_es
->
s_œ°_‹ph™
);

2962 
sbi
->
s_es
->
s_œ°_‹ph™
 = 
	`˝u_to_À32
(
öode
->
i_öo
);

2963 
dúty
 = 
åue
;

2965 
	`li°_add
(&
	`PXT4_I
(
öode
)->
i_‹ph™
, &
sbi
->
s_‹ph™
);

2966 
	`muãx_u∆ock
(&
sbi
->
s_‹ph™_lock
);

2968 i‡(
dúty
) {

2969 
îr
 = 
	`pxt4_h™dÀ_dúty_su≥r
(
h™dÀ
, 
sb
);

2970 
rc
 = 
	`pxt4_m¨k_ûoc_dúty
(
h™dÀ
, 
öode
, &
ûoc
);

2971 i‡(!
îr
)

2972 
îr
 = 
rc
;

2973 i‡(
îr
) {

2979 
	`muãx_lock
(&
sbi
->
s_‹ph™_lock
);

2980 
	`li°_dñ_öô
(&
	`PXT4_I
(
öode
)->
i_‹ph™
);

2981 
	`muãx_u∆ock
(&
sbi
->
s_‹ph™_lock
);

2984 
	`bªl£
(
ûoc
.
bh
);

2986 
	`jbd_debug
(4, "su≥rblock wû»poöàtÿ%lu\n", 
öode
->
i_öo
);

2987 
	`jbd_debug
(4, "orphan inode %lu willÖointÅo %d\n",

2988 
öode
->
i_öo
, 
	`NEXT_ORPHAN
(inode));

2989 
out
:

2990 
	`pxt4_°d_îr‹
(
sb
, 
îr
);

2991  
îr
;

2992 
	}
}

2998 
	$pxt4_‹ph™_dñ
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *inode)

3000 
li°_hód
 *
¥ev
;

3001 
pxt4_öode_öfo
 *
ei
 = 
	`PXT4_I
(
öode
);

3002 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
öode
->
i_sb
);

3003 
__u32
 
öo_√xt
;

3004 
pxt4_ûoc
 
ûoc
;

3005 
îr
 = 0;

3007 i‡(!
sbi
->
s_jou∫Æ
 && !(sbi->
s_mou¡_°©e
 & 
PXT4_ORPHAN_FS
))

3010 
	`WARN_ON_ONCE
(!(
öode
->
i_°©e
 & (
I_NEW
 | 
I_FREEING
)) &&

3011 !
	`öode_is_locked
(
öode
));

3013 i‡(
	`li°_em±y
(&
ei
->
i_‹ph™
))

3016 i‡(
h™dÀ
) {

3018 
îr
 = 
	`pxt4_ª£rve_öode_wrôe
(
h™dÀ
, 
öode
, &
ûoc
);

3021 
	`muãx_lock
(&
sbi
->
s_‹ph™_lock
);

3022 
	`jbd_debug
(4, "ªmovêöodê%lu from oΩh™Üi°\n", 
öode
->
i_öo
);

3024 
¥ev
 = 
ei
->
i_‹ph™
.prev;

3025 
	`li°_dñ_öô
(&
ei
->
i_‹ph™
);

3031 i‡(!
h™dÀ
 || 
îr
) {

3032 
	`muãx_u∆ock
(&
sbi
->
s_‹ph™_lock
);

3033 
out_îr
;

3036 
öo_√xt
 = 
	`NEXT_ORPHAN
(
öode
);

3037 i‡(
¥ev
 =&
sbi
->
s_‹ph™
) {

3038 
	`jbd_debug
(4, "su≥rblock wû»poöàtÿ%u\n", 
öo_√xt
);

3039 
	`BUFFER_TRACE
(
sbi
->
s_sbh
, "get_write_access");

3040 
îr
 = 
	`pxt4_jou∫Æ_gë_wrôe_ac˚ss
(
h™dÀ
, 
sbi
->
s_sbh
);

3041 i‡(
îr
) {

3042 
	`muãx_u∆ock
(&
sbi
->
s_‹ph™_lock
);

3043 
out_bªl£
;

3045 
sbi
->
s_es
->
s_œ°_‹ph™
 = 
	`˝u_to_À32
(
öo_√xt
);

3046 
	`muãx_u∆ock
(&
sbi
->
s_‹ph™_lock
);

3047 
îr
 = 
	`pxt4_h™dÀ_dúty_su≥r
(
h™dÀ
, 
öode
->
i_sb
);

3049 
pxt4_ûoc
 
ûoc2
;

3050 
öode
 *
i_¥ev
 =

3051 &
	`li°_íåy
(
¥ev
, 
pxt4_öode_öfo
, 
i_‹ph™
)->
vfs_öode
;

3053 
	`jbd_debug
(4, "orphan inode %lu willÖointÅo %u\n",

3054 
i_¥ev
->
i_öo
, 
öo_√xt
);

3055 
îr
 = 
	`pxt4_ª£rve_öode_wrôe
(
h™dÀ
, 
i_¥ev
, &
ûoc2
);

3056 i‡(
îr
) {

3057 
	`muãx_u∆ock
(&
sbi
->
s_‹ph™_lock
);

3058 
out_bªl£
;

3060 
	`NEXT_ORPHAN
(
i_¥ev
Ë
öo_√xt
;

3061 
îr
 = 
	`pxt4_m¨k_ûoc_dúty
(
h™dÀ
, 
i_¥ev
, &
ûoc2
);

3062 
	`muãx_u∆ock
(&
sbi
->
s_‹ph™_lock
);

3064 i‡(
îr
)

3065 
out_bªl£
;

3066 
	`NEXT_ORPHAN
(
öode
) = 0;

3067 
îr
 = 
	`pxt4_m¨k_ûoc_dúty
(
h™dÀ
, 
öode
, &
ûoc
);

3068 
out_îr
:

3069 
	`pxt4_°d_îr‹
(
öode
->
i_sb
, 
îr
);

3070  
îr
;

3072 
out_bªl£
:

3073 
	`bªl£
(
ûoc
.
bh
);

3074 
out_îr
;

3075 
	}
}

3077 
	$pxt4_rmdú
(
öode
 *
dú
, 
díåy
 *dentry)

3079 
ªtvÆ
;

3080 
öode
 *inode;

3081 
buf„r_hód
 *
bh
;

3082 
pxt4_dú_íåy_2
 *
de
;

3083 
h™dÀ_t
 *
h™dÀ
 = 
NULL
;

3085 i‡(
	`u∆ikñy
(
	`pxt4_f‹˚d_shutdown
(
	`PXT4_SB
(
dú
->
i_sb
))))

3086  -
EIO
;

3090 
ªtvÆ
 = 
	`dquŸ_öôülize
(
dú
);

3091 i‡(
ªtvÆ
)

3092  
ªtvÆ
;

3093 
ªtvÆ
 = 
	`dquŸ_öôülize
(
	`d_öode
(
díåy
));

3094 i‡(
ªtvÆ
)

3095  
ªtvÆ
;

3097 
ªtvÆ
 = -
ENOENT
;

3098 
bh
 = 
	`pxt4_föd_íåy
(
dú
, &
díåy
->
d_«me
, &
de
, 
NULL
);

3099 i‡(
	`IS_ERR
(
bh
))

3100  
	`PTR_ERR
(
bh
);

3101 i‡(!
bh
)

3102 
íd_rmdú
;

3104 
öode
 = 
	`d_öode
(
díåy
);

3106 
ªtvÆ
 = -
EFSCORRUPTED
;

3107 i‡(
	`À32_to_˝u
(
de
->
öode
Ë!öode->
i_öo
)

3108 
íd_rmdú
;

3110 
ªtvÆ
 = -
ENOTEMPTY
;

3111 i‡(!
	`pxt4_em±y_dú
(
öode
))

3112 
íd_rmdú
;

3114 
h™dÀ
 = 
	`pxt4_jou∫Æ_°¨t
(
dú
, 
PXT4_HT_DIR
,

3115 
	`PXT4_DATA_TRANS_BLOCKS
(
dú
->
i_sb
));

3116 i‡(
	`IS_ERR
(
h™dÀ
)) {

3117 
ªtvÆ
 = 
	`PTR_ERR
(
h™dÀ
);

3118 
h™dÀ
 = 
NULL
;

3119 
íd_rmdú
;

3122 i‡(
	`IS_DIRSYNC
(
dú
))

3123 
	`pxt4_h™dÀ_sync
(
h™dÀ
);

3125 
ªtvÆ
 = 
	`pxt4_dñëe_íåy
(
h™dÀ
, 
dú
, 
de
, 
bh
);

3126 i‡(
ªtvÆ
)

3127 
íd_rmdú
;

3128 i‡(!
	`PXT4_DIR_LINK_EMPTY
(
öode
))

3129 
	`pxt4_w¨nög_öode
(
öode
,

3131 
díåy
->
d_«me
.
Àn
, díåy->d_«me.
«me
,

3132 
öode
->
i_∆ök
);

3133 
	`öode_öc_ivîsi⁄
(
öode
);

3134 
	`˛ór_∆ök
(
öode
);

3138 
öode
->
i_size
 = 0;

3139 
	`pxt4_‹ph™_add
(
h™dÀ
, 
öode
);

3140 
öode
->
i_˘ime
 = 
dú
->i_˘imêdú->
i_mtime
 = 
	`cuºít_time
(inode);

3141 
	`pxt4_m¨k_öode_dúty
(
h™dÀ
, 
öode
);

3142 
	`pxt4_dec_cou¡
(
h™dÀ
, 
dú
);

3143 
	`pxt4_upd©e_dx_Êag
(
dú
);

3144 
	`pxt4_m¨k_öode_dúty
(
h™dÀ
, 
dú
);

3146 #ifde‡
CONFIG_UNICODE


3153 i‡(
	`IS_CASEFOLDED
(
dú
))

3154 
	`d_övÆid©e
(
díåy
);

3157 
íd_rmdú
:

3158 
	`bªl£
(
bh
);

3159 i‡(
h™dÀ
)

3160 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

3161  
ªtvÆ
;

3162 
	}
}

3164 
	$pxt4_u∆ök
(
öode
 *
dú
, 
díåy
 *dentry)

3166 
ªtvÆ
;

3167 
öode
 *inode;

3168 
buf„r_hód
 *
bh
;

3169 
pxt4_dú_íåy_2
 *
de
;

3170 
h™dÀ_t
 *
h™dÀ
 = 
NULL
;

3172 i‡(
	`u∆ikñy
(
	`pxt4_f‹˚d_shutdown
(
	`PXT4_SB
(
dú
->
i_sb
))))

3173  -
EIO
;

3175 
	`åa˚_pxt4_u∆ök_íãr
(
dú
, 
díåy
);

3178 
ªtvÆ
 = 
	`dquŸ_öôülize
(
dú
);

3179 i‡(
ªtvÆ
)

3180  
ªtvÆ
;

3181 
ªtvÆ
 = 
	`dquŸ_öôülize
(
	`d_öode
(
díåy
));

3182 i‡(
ªtvÆ
)

3183  
ªtvÆ
;

3185 
ªtvÆ
 = -
ENOENT
;

3186 
bh
 = 
	`pxt4_föd_íåy
(
dú
, &
díåy
->
d_«me
, &
de
, 
NULL
);

3187 i‡(
	`IS_ERR
(
bh
))

3188  
	`PTR_ERR
(
bh
);

3189 i‡(!
bh
)

3190 
íd_u∆ök
;

3192 
öode
 = 
	`d_öode
(
díåy
);

3194 
ªtvÆ
 = -
EFSCORRUPTED
;

3195 i‡(
	`À32_to_˝u
(
de
->
öode
Ë!öode->
i_öo
)

3196 
íd_u∆ök
;

3198 
h™dÀ
 = 
	`pxt4_jou∫Æ_°¨t
(
dú
, 
PXT4_HT_DIR
,

3199 
	`PXT4_DATA_TRANS_BLOCKS
(
dú
->
i_sb
));

3200 i‡(
	`IS_ERR
(
h™dÀ
)) {

3201 
ªtvÆ
 = 
	`PTR_ERR
(
h™dÀ
);

3202 
h™dÀ
 = 
NULL
;

3203 
íd_u∆ök
;

3206 i‡(
	`IS_DIRSYNC
(
dú
))

3207 
	`pxt4_h™dÀ_sync
(
h™dÀ
);

3209 
ªtvÆ
 = 
	`pxt4_dñëe_íåy
(
h™dÀ
, 
dú
, 
de
, 
bh
);

3210 i‡(
ªtvÆ
)

3211 
íd_u∆ök
;

3212 
dú
->
i_˘ime
 = dú->
i_mtime
 = 
	`cuºít_time
(dir);

3213 
	`pxt4_upd©e_dx_Êag
(
dú
);

3214 
	`pxt4_m¨k_öode_dúty
(
h™dÀ
, 
dú
);

3215 i‡(
öode
->
i_∆ök
 == 0)

3216 
	`pxt4_w¨nög_öode
(
öode
, "Deleting file '%.*s' withÇoÜinks",

3217 
díåy
->
d_«me
.
Àn
, díåy->d_«me.
«me
);

3219 
	`dr›_∆ök
(
öode
);

3220 i‡(!
öode
->
i_∆ök
)

3221 
	`pxt4_‹ph™_add
(
h™dÀ
, 
öode
);

3222 
öode
->
i_˘ime
 = 
	`cuºít_time
(inode);

3223 
	`pxt4_m¨k_öode_dúty
(
h™dÀ
, 
öode
);

3225 #ifde‡
CONFIG_UNICODE


3232 i‡(
	`IS_CASEFOLDED
(
dú
))

3233 
	`d_övÆid©e
(
díåy
);

3236 
íd_u∆ök
:

3237 
	`bªl£
(
bh
);

3238 i‡(
h™dÀ
)

3239 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

3240 
	`åa˚_pxt4_u∆ök_exô
(
díåy
, 
ªtvÆ
);

3241  
ªtvÆ
;

3242 
	}
}

3244 
	$pxt4_symlök
(
öode
 *
dú
,

3245 
díåy
 *díåy, c⁄° *
sym«me
)

3247 
h™dÀ_t
 *
h™dÀ
;

3248 
öode
 *inode;

3249 
îr
, 
Àn
 = 
	`°æí
(
sym«me
);

3250 
¸edôs
;

3251 
fs¸y±_°r
 
disk_lök
;

3253 i‡(
	`u∆ikñy
(
	`pxt4_f‹˚d_shutdown
(
	`PXT4_SB
(
dú
->
i_sb
))))

3254  -
EIO
;

3256 
îr
 = 
	`fs¸y±_¥ï¨e_symlök
(
dú
, 
sym«me
, 
Àn
, dú->
i_sb
->
s_blocksize
,

3257 &
disk_lök
);

3258 i‡(
îr
)

3259  
îr
;

3261 
îr
 = 
	`dquŸ_öôülize
(
dú
);

3262 i‡(
îr
)

3263  
îr
;

3265 i‡((
disk_lök
.
Àn
 > 
PXT4_N_BLOCKS
 * 4)) {

3272 
¸edôs
 = 4 + 
	`PXT4_MAXQUOTAS_INIT_BLOCKS
(
dú
->
i_sb
) +

3273 
PXT4_XATTR_TRANS_BLOCKS
;

3281 
¸edôs
 = 
	`PXT4_DATA_TRANS_BLOCKS
(
dú
->
i_sb
) +

3282 
PXT4_INDEX_EXTRA_TRANS_BLOCKS
 + 3;

3285 
öode
 = 
	`pxt4_√w_öode_°¨t_h™dÀ
(
dú
, 
S_IFLNK
|
S_IRWXUGO
,

3286 &
díåy
->
d_«me
, 0, 
NULL
,

3287 
PXT4_HT_DIR
, 
¸edôs
);

3288 
h™dÀ
 = 
	`pxt4_jou∫Æ_cuºít_h™dÀ
();

3289 i‡(
	`IS_ERR
(
öode
)) {

3290 i‡(
h™dÀ
)

3291 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

3292  
	`PTR_ERR
(
öode
);

3295 i‡(
	`IS_ENCRYPTED
(
öode
)) {

3296 
îr
 = 
	`fs¸y±_í¸y±_symlök
(
öode
, 
sym«me
, 
Àn
, &
disk_lök
);

3297 i‡(
îr
)

3298 
îr_dr›_öode
;

3299 
öode
->
i_›
 = &
pxt4_í¸y±ed_symlök_öode_›î©i⁄s
;

3302 i‡((
disk_lök
.
Àn
 > 
PXT4_N_BLOCKS
 * 4)) {

3303 i‡(!
	`IS_ENCRYPTED
(
öode
))

3304 
öode
->
i_›
 = &
pxt4_symlök_öode_›î©i⁄s
;

3305 
	`öode_nohighmem
(
öode
);

3306 
	`pxt4_£t_a›s
(
öode
);

3317 
	`dr›_∆ök
(
öode
);

3318 
îr
 = 
	`pxt4_‹ph™_add
(
h™dÀ
, 
öode
);

3319 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

3320 
h™dÀ
 = 
NULL
;

3321 i‡(
îr
)

3322 
îr_dr›_öode
;

3323 
îr
 = 
	`__∑ge_symlök
(
öode
, 
disk_lök
.
«me
, disk_lök.
Àn
, 1);

3324 i‡(
îr
)

3325 
îr_dr›_öode
;

3330 
h™dÀ
 = 
	`pxt4_jou∫Æ_°¨t
(
dú
, 
PXT4_HT_DIR
,

3331 
	`PXT4_DATA_TRANS_BLOCKS
(
dú
->
i_sb
) +

3332 
PXT4_INDEX_EXTRA_TRANS_BLOCKS
 + 1);

3333 i‡(
	`IS_ERR
(
h™dÀ
)) {

3334 
îr
 = 
	`PTR_ERR
(
h™dÀ
);

3335 
h™dÀ
 = 
NULL
;

3336 
îr_dr›_öode
;

3338 
	`£t_∆ök
(
öode
, 1);

3339 
îr
 = 
	`pxt4_‹ph™_dñ
(
h™dÀ
, 
öode
);

3340 i‡(
îr
)

3341 
îr_dr›_öode
;

3344 
	`pxt4_˛ór_öode_Êag
(
öode
, 
PXT4_INODE_EXTENTS
);

3345 i‡(!
	`IS_ENCRYPTED
(
öode
)) {

3346 
öode
->
i_›
 = &
pxt4_Á°_symlök_öode_›î©i⁄s
;

3347 
öode
->
i_lök
 = (*)&
	`PXT4_I
(öode)->
i_d©a
;

3349 
	`mem˝y
((*)&
	`PXT4_I
(
öode
)->
i_d©a
, 
disk_lök
.
«me
,

3350 
disk_lök
.
Àn
);

3351 
öode
->
i_size
 = 
disk_lök
.
Àn
 - 1;

3353 
	`PXT4_I
(
öode
)->
i_disksize
 = inode->
i_size
;

3354 
îr
 = 
	`pxt4_add_n⁄dú
(
h™dÀ
, 
díåy
, 
öode
);

3355 i‡(!
îr
 && 
	`IS_DIRSYNC
(
dú
))

3356 
	`pxt4_h™dÀ_sync
(
h™dÀ
);

3358 i‡(
h™dÀ
)

3359 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

3360 
out_‰ì_í¸y±ed_lök
;

3362 
îr_dr›_öode
:

3363 i‡(
h™dÀ
)

3364 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

3365 
	`˛ór_∆ök
(
öode
);

3366 
	`u∆ock_√w_öode
(
öode
);

3367 
	`ùut
(
öode
);

3368 
out_‰ì_í¸y±ed_lök
:

3369 i‡(
disk_lök
.
«me
 !(*)
sym«me
)

3370 
	`k‰ì
(
disk_lök
.
«me
);

3371  
îr
;

3372 
	}
}

3374 
	$pxt4_lök
(
díåy
 *
ﬁd_díåy
,

3375 
öode
 *
dú
, 
díåy
 *dentry)

3377 
h™dÀ_t
 *
h™dÀ
;

3378 
öode
 *öodê
	`d_öode
(
ﬁd_díåy
);

3379 
îr
, 
ªåõs
 = 0;

3381 i‡(
öode
->
i_∆ök
 >
PXT4_LINK_MAX
)

3382  -
EMLINK
;

3384 
îr
 = 
	`fs¸y±_¥ï¨e_lök
(
ﬁd_díåy
, 
dú
, 
díåy
);

3385 i‡(
îr
)

3386  
îr
;

3388 i‡((
	`pxt4_ã°_öode_Êag
(
dú
, 
PXT4_INODE_PROJINHERIT
)) &&

3389 (!
	`¥ojid_eq
(
	`PXT4_I
(
dú
)->
i_¥ojid
,

3390 
	`PXT4_I
(
ﬁd_díåy
->
d_öode
)->
i_¥ojid
)))

3391  -
EXDEV
;

3393 
îr
 = 
	`dquŸ_öôülize
(
dú
);

3394 i‡(
îr
)

3395  
îr
;

3397 
ªåy
:

3398 
h™dÀ
 = 
	`pxt4_jou∫Æ_°¨t
(
dú
, 
PXT4_HT_DIR
,

3399 (
	`PXT4_DATA_TRANS_BLOCKS
(
dú
->
i_sb
) +

3400 
PXT4_INDEX_EXTRA_TRANS_BLOCKS
) + 1);

3401 i‡(
	`IS_ERR
(
h™dÀ
))

3402  
	`PTR_ERR
(
h™dÀ
);

3404 i‡(
	`IS_DIRSYNC
(
dú
))

3405 
	`pxt4_h™dÀ_sync
(
h™dÀ
);

3407 
öode
->
i_˘ime
 = 
	`cuºít_time
(inode);

3408 
	`pxt4_öc_cou¡
(
h™dÀ
, 
öode
);

3409 
	`ihﬁd
(
öode
);

3411 
îr
 = 
	`pxt4_add_íåy
(
h™dÀ
, 
díåy
, 
öode
);

3412 i‡(!
îr
) {

3413 
	`pxt4_m¨k_öode_dúty
(
h™dÀ
, 
öode
);

3417 i‡(
öode
->
i_∆ök
 == 1)

3418 
	`pxt4_‹ph™_dñ
(
h™dÀ
, 
öode
);

3419 
	`d_ö°™tüã
(
díåy
, 
öode
);

3421 
	`dr›_∆ök
(
öode
);

3422 
	`ùut
(
öode
);

3424 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

3425 i‡(
îr
 =-
ENOSPC
 && 
	`pxt4_should_ªåy_Æloc
(
dú
->
i_sb
, &
ªåõs
))

3426 
ªåy
;

3427  
îr
;

3428 
	}
}

3436 
buf„r_hód
 *
	$pxt4_gë_fú°_dú_block
(
h™dÀ_t
 *
h™dÀ
,

3437 
öode
 *inode,

3438 *
ªtvÆ
,

3439 
pxt4_dú_íåy_2
 **
∑ª¡_de
,

3440 *
ölöed
)

3442 
buf„r_hód
 *
bh
;

3444 i‡(!
	`pxt4_has_ölöe_d©a
(
öode
)) {

3448 
bh
 = 
	`pxt4_ªad_dúblock
(
öode
, 0, 
DIRENT_HTREE
);

3449 i‡(
	`IS_ERR
(
bh
)) {

3450 *
ªtvÆ
 = 
	`PTR_ERR
(
bh
);

3451  
NULL
;

3453 *
∑ª¡_de
 = 
	`pxt4_√xt_íåy
(

3454 (
pxt4_dú_íåy_2
 *)
bh
->
b_d©a
,

3455 
öode
->
i_sb
->
s_blocksize
);

3456  
bh
;

3459 *
ölöed
 = 1;

3460  
	`pxt4_gë_fú°_ölöe_block
(
öode
, 
∑ª¡_de
, 
ªtvÆ
);

3461 
	}
}

3463 
	spxt4_ª«mít
 {

3464 
öode
 *
	mdú
;

3465 
díåy
 *
	mdíåy
;

3466 
öode
 *
	möode
;

3467 
boﬁ
 
	mis_dú
;

3468 
	mdú_∆ök_dñè
;

3471 
buf„r_hód
 *
	mbh
;

3472 
pxt4_dú_íåy_2
 *
	mde
;

3473 
	mölöed
;

3476 
buf„r_hód
 *
	mdú_bh
;

3477 
pxt4_dú_íåy_2
 *
	m∑ª¡_de
;

3478 
	mdú_ölöed
;

3481 
	$pxt4_ª«me_dú_¥ï¨e
(
h™dÀ_t
 *
h™dÀ
, 
pxt4_ª«mít
 *
ít
)

3483 
ªtvÆ
;

3485 
ít
->
dú_bh
 = 
	`pxt4_gë_fú°_dú_block
(
h™dÀ
,É¡->
öode
,

3486 &
ªtvÆ
, &
ít
->
∑ª¡_de
,

3487 &
ít
->
dú_ölöed
);

3488 i‡(!
ít
->
dú_bh
)

3489  
ªtvÆ
;

3490 i‡(
	`À32_to_˝u
(
ít
->
∑ª¡_de
->
öode
Ë!ít->
dú
->
i_öo
)

3491  -
EFSCORRUPTED
;

3492 
	`BUFFER_TRACE
(
ít
->
dú_bh
, "get_write_access");

3493  
	`pxt4_jou∫Æ_gë_wrôe_ac˚ss
(
h™dÀ
, 
ít
->
dú_bh
);

3494 
	}
}

3496 
	$pxt4_ª«me_dú_föish
(
h™dÀ_t
 *
h™dÀ
, 
pxt4_ª«mít
 *
ít
,

3497 
dú_öo
)

3499 
ªtvÆ
;

3501 
ít
->
∑ª¡_de
->
öode
 = 
	`˝u_to_À32
(
dú_öo
);

3502 
	`BUFFER_TRACE
(
ít
->
dú_bh
, "callÖxt4_handle_dirty_metadata");

3503 i‡(!
ít
->
dú_ölöed
) {

3504 i‡(
	`is_dx
(
ít
->
öode
)) {

3505 
ªtvÆ
 = 
	`pxt4_h™dÀ_dúty_dx_node
(
h™dÀ
,

3506 
ít
->
öode
,

3507 
ít
->
dú_bh
);

3509 
ªtvÆ
 = 
	`pxt4_h™dÀ_dúty_dúblock
(
h™dÀ
, 
ít
->
öode
,

3510 
ít
->
dú_bh
);

3513 
ªtvÆ
 = 
	`pxt4_m¨k_öode_dúty
(
h™dÀ
, 
ít
->
öode
);

3515 i‡(
ªtvÆ
) {

3516 
	`pxt4_°d_îr‹
(
ít
->
dú
->
i_sb
, 
ªtvÆ
);

3517  
ªtvÆ
;

3520 
	}
}

3522 
	$pxt4_£ã¡
(
h™dÀ_t
 *
h™dÀ
, 
pxt4_ª«mít
 *
ít
,

3523 
öo
, 
fûe_ty≥
)

3525 
ªtvÆ
;

3527 
	`BUFFER_TRACE
(
ít
->
bh
, "get writeáccess");

3528 
ªtvÆ
 = 
	`pxt4_jou∫Æ_gë_wrôe_ac˚ss
(
h™dÀ
, 
ít
->
bh
);

3529 i‡(
ªtvÆ
)

3530  
ªtvÆ
;

3531 
ít
->
de
->
öode
 = 
	`˝u_to_À32
(
öo
);

3532 i‡(
	`pxt4_has_„©uª_fûëy≥
(
ít
->
dú
->
i_sb
))

3533 
ít
->
de
->
fûe_ty≥
 = file_type;

3534 
	`öode_öc_ivîsi⁄
(
ít
->
dú
);

3535 
ít
->
dú
->
i_˘ime
 =É¡->dú->
i_mtime
 =

3536 
	`cuºít_time
(
ít
->
dú
);

3537 
	`pxt4_m¨k_öode_dúty
(
h™dÀ
, 
ít
->
dú
);

3538 
	`BUFFER_TRACE
(
ít
->
bh
, "callÖxt4_handle_dirty_metadata");

3539 i‡(!
ít
->
ölöed
) {

3540 
ªtvÆ
 = 
	`pxt4_h™dÀ_dúty_dúblock
(
h™dÀ
, 
ít
->
dú
,É¡->
bh
);

3541 i‡(
	`u∆ikñy
(
ªtvÆ
)) {

3542 
	`pxt4_°d_îr‹
(
ít
->
dú
->
i_sb
, 
ªtvÆ
);

3543  
ªtvÆ
;

3548 
	}
}

3550 
	$pxt4_ª£ã¡
(
h™dÀ_t
 *
h™dÀ
, 
pxt4_ª«mít
 *
ít
,

3551 
öo
, 
fûe_ty≥
)

3553 
pxt4_ª«mít
 
ﬁd
 = *
ít
;

3554 
ªtvÆ
 = 0;

3561 
ﬁd
.
bh
 = 
	`pxt4_föd_íåy
(ﬁd.
dú
, &ﬁd.
díåy
->
d_«me
, &ﬁd.
de
, 
NULL
);

3562 i‡(
	`IS_ERR
(
ﬁd
.
bh
))

3563 
ªtvÆ
 = 
	`PTR_ERR
(
ﬁd
.
bh
);

3564 i‡(!
ﬁd
.
bh
)

3565 
ªtvÆ
 = -
ENOENT
;

3566 i‡(
ªtvÆ
) {

3567 
	`pxt4_°d_îr‹
(
ﬁd
.
dú
->
i_sb
, 
ªtvÆ
);

3571 
	`pxt4_£ã¡
(
h™dÀ
, &
ﬁd
, 
öo
, 
fûe_ty≥
);

3572 
	`bªl£
(
ﬁd
.
bh
);

3573 
	}
}

3575 
	$pxt4_föd_dñëe_íåy
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *
dú
,

3576 c⁄° 
q°r
 *
d_«me
)

3578 
ªtvÆ
 = -
ENOENT
;

3579 
buf„r_hód
 *
bh
;

3580 
pxt4_dú_íåy_2
 *
de
;

3582 
bh
 = 
	`pxt4_föd_íåy
(
dú
, 
d_«me
, &
de
, 
NULL
);

3583 i‡(
	`IS_ERR
(
bh
))

3584  
	`PTR_ERR
(
bh
);

3585 i‡(
bh
) {

3586 
ªtvÆ
 = 
	`pxt4_dñëe_íåy
(
h™dÀ
, 
dú
, 
de
, 
bh
);

3587 
	`bªl£
(
bh
);

3589  
ªtvÆ
;

3590 
	}
}

3592 
	$pxt4_ª«me_dñëe
(
h™dÀ_t
 *
h™dÀ
, 
pxt4_ª«mít
 *
ít
,

3593 
f‹˚_ªªad
)

3595 
ªtvÆ
;

3602 i‡(
	`À32_to_˝u
(
ít
->
de
->
öode
Ë!ít->öode->
i_öo
 ||

3603 
ít
->
de
->
«me_Àn
 !ít->
díåy
->
d_«me
.
Àn
 ||

3604 
	`°∫cmp
(
ít
->
de
->
«me
,É¡->
díåy
->
d_«me
.name,

3605 
ít
->
de
->
«me_Àn
) ||

3606 
f‹˚_ªªad
) {

3607 
ªtvÆ
 = 
	`pxt4_föd_dñëe_íåy
(
h™dÀ
, 
ít
->
dú
,

3608 &
ít
->
díåy
->
d_«me
);

3610 
ªtvÆ
 = 
	`pxt4_dñëe_íåy
(
h™dÀ
, 
ít
->
dú
,É¡->
de
,É¡->
bh
);

3611 i‡(
ªtvÆ
 =-
ENOENT
) {

3612 
ªtvÆ
 = 
	`pxt4_föd_dñëe_íåy
(
h™dÀ
, 
ít
->
dú
,

3613 &
ít
->
díåy
->
d_«me
);

3617 i‡(
ªtvÆ
) {

3618 
	`pxt4_w¨nög_öode
(
ít
->
dú
,

3620 
ít
->
dú
->
i_∆ök
, 
ªtvÆ
);

3622 
	}
}

3624 
	$pxt4_upd©e_dú_cou¡
(
h™dÀ_t
 *
h™dÀ
, 
pxt4_ª«mít
 *
ít
)

3626 i‡(
ít
->
dú_∆ök_dñè
) {

3627 i‡(
ít
->
dú_∆ök_dñè
 == -1)

3628 
	`pxt4_dec_cou¡
(
h™dÀ
, 
ít
->
dú
);

3630 
	`pxt4_öc_cou¡
(
h™dÀ
, 
ít
->
dú
);

3631 
	`pxt4_m¨k_öode_dúty
(
h™dÀ
, 
ít
->
dú
);

3633 
	}
}

3635 
öode
 *
	$pxt4_whôeout_f‹_ª«me
(
pxt4_ª«mít
 *
ít
,

3636 
¸edôs
, 
h™dÀ_t
 **
h
)

3638 
öode
 *
wh
;

3639 
h™dÀ_t
 *
h™dÀ
;

3640 
ªåõs
 = 0;

3646 
¸edôs
 +(
	`PXT4_MAXQUOTAS_TRANS_BLOCKS
(
ít
->
dú
->
i_sb
) +

3647 
PXT4_XATTR_TRANS_BLOCKS
 + 4);

3648 
ªåy
:

3649 
wh
 = 
	`pxt4_√w_öode_°¨t_h™dÀ
(
ít
->
dú
, 
S_IFCHR
 | 
WHITEOUT_MODE
,

3650 &
ít
->
díåy
->
d_«me
, 0, 
NULL
,

3651 
PXT4_HT_DIR
, 
¸edôs
);

3653 
h™dÀ
 = 
	`pxt4_jou∫Æ_cuºít_h™dÀ
();

3654 i‡(
	`IS_ERR
(
wh
)) {

3655 i‡(
h™dÀ
)

3656 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

3657 i‡(
	`PTR_ERR
(
wh
Ë=-
ENOSPC
 &&

3658 
	`pxt4_should_ªåy_Æloc
(
ít
->
dú
->
i_sb
, &
ªåõs
))

3659 
ªåy
;

3661 *
h
 = 
h™dÀ
;

3662 
	`öô_•ecül_öode
(
wh
, wh->
i_mode
, 
WHITEOUT_DEV
);

3663 
wh
->
i_›
 = &
pxt4_•ecül_öode_›î©i⁄s
;

3665  
wh
;

3666 
	}
}

3676 
	$pxt4_ª«me
(
öode
 *
ﬁd_dú
, 
díåy
 *
ﬁd_díåy
,

3677 
öode
 *
√w_dú
, 
díåy
 *
√w_díåy
,

3678 
Êags
)

3680 
h™dÀ_t
 *
h™dÀ
 = 
NULL
;

3681 
pxt4_ª«mít
 
ﬁd
 = {

3682 .
dú
 = 
ﬁd_dú
,

3683 .
díåy
 = 
ﬁd_díåy
,

3684 .
öode
 = 
	`d_öode
(
ﬁd_díåy
),

3686 
pxt4_ª«mít
 
√w
 = {

3687 .
dú
 = 
√w_dú
,

3688 .
díåy
 = 
√w_díåy
,

3689 .
öode
 = 
	`d_öode
(
√w_díåy
),

3691 
f‹˚_ªªad
;

3692 
ªtvÆ
;

3693 
öode
 *
whôeout
 = 
NULL
;

3694 
¸edôs
;

3695 
u8
 
ﬁd_fûe_ty≥
;

3697 i‡(
√w
.
öode
 &&Çew.öode->
i_∆ök
 == 0) {

3698 
	`PXT4_ERROR_INODE
(
√w
.
öode
,

3700  -
EFSCORRUPTED
;

3703 i‡((
	`pxt4_ã°_öode_Êag
(
√w_dú
, 
PXT4_INODE_PROJINHERIT
)) &&

3704 (!
	`¥ojid_eq
(
	`PXT4_I
(
√w_dú
)->
i_¥ojid
,

3705 
	`PXT4_I
(
ﬁd_díåy
->
d_öode
)->
i_¥ojid
)))

3706  -
EXDEV
;

3708 
ªtvÆ
 = 
	`dquŸ_öôülize
(
ﬁd
.
dú
);

3709 i‡(
ªtvÆ
)

3710  
ªtvÆ
;

3711 
ªtvÆ
 = 
	`dquŸ_öôülize
(
√w
.
dú
);

3712 i‡(
ªtvÆ
)

3713  
ªtvÆ
;

3717 i‡(
√w
.
öode
) {

3718 
ªtvÆ
 = 
	`dquŸ_öôülize
(
√w
.
öode
);

3719 i‡(
ªtvÆ
)

3720  
ªtvÆ
;

3723 
ﬁd
.
bh
 = 
	`pxt4_föd_íåy
(ﬁd.
dú
, &ﬁd.
díåy
->
d_«me
, &ﬁd.
de
, 
NULL
);

3724 i‡(
	`IS_ERR
(
ﬁd
.
bh
))

3725  
	`PTR_ERR
(
ﬁd
.
bh
);

3732 
ªtvÆ
 = -
ENOENT
;

3733 i‡(!
ﬁd
.
bh
 || 
	`À32_to_˝u
(ﬁd.
de
->
öode
Ë!ﬁd.öode->
i_öo
)

3734 
ªÀa£_bh
;

3736 
√w
.
bh
 = 
	`pxt4_föd_íåy
“ew.
dú
, &√w.
díåy
->
d_«me
,

3737 &
√w
.
de
, &√w.
ölöed
);

3738 i‡(
	`IS_ERR
(
√w
.
bh
)) {

3739 
ªtvÆ
 = 
	`PTR_ERR
(
√w
.
bh
);

3740 
√w
.
bh
 = 
NULL
;

3741 
ªÀa£_bh
;

3743 i‡(
√w
.
bh
) {

3744 i‡(!
√w
.
öode
) {

3745 
	`bªl£
(
√w
.
bh
);

3746 
√w
.
bh
 = 
NULL
;

3749 i‡(
√w
.
öode
 && !
	`ã°_›t
“ew.
dú
->
i_sb
, 
NO_AUTO_DA_ALLOC
))

3750 
	`pxt4_Æloc_da_blocks
(
ﬁd
.
öode
);

3752 
¸edôs
 = (2 * 
	`PXT4_DATA_TRANS_BLOCKS
(
ﬁd
.
dú
->
i_sb
) +

3753 
PXT4_INDEX_EXTRA_TRANS_BLOCKS
 + 2);

3754 i‡(!(
Êags
 & 
RENAME_WHITEOUT
)) {

3755 
h™dÀ
 = 
	`pxt4_jou∫Æ_°¨t
(
ﬁd
.
dú
, 
PXT4_HT_DIR
, 
¸edôs
);

3756 i‡(
	`IS_ERR
(
h™dÀ
)) {

3757 
ªtvÆ
 = 
	`PTR_ERR
(
h™dÀ
);

3758 
ªÀa£_bh
;

3761 
whôeout
 = 
	`pxt4_whôeout_f‹_ª«me
(&
ﬁd
, 
¸edôs
, &
h™dÀ
);

3762 i‡(
	`IS_ERR
(
whôeout
)) {

3763 
ªtvÆ
 = 
	`PTR_ERR
(
whôeout
);

3764 
ªÀa£_bh
;

3768 
ﬁd_fûe_ty≥
 = 
ﬁd
.
de
->
fûe_ty≥
;

3769 i‡(
	`IS_DIRSYNC
(
ﬁd
.
dú
Ë|| IS_DIRSYNC(
√w
.dir))

3770 
	`pxt4_h™dÀ_sync
(
h™dÀ
);

3772 i‡(
	`S_ISDIR
(
ﬁd
.
öode
->
i_mode
)) {

3773 i‡(
√w
.
öode
) {

3774 
ªtvÆ
 = -
ENOTEMPTY
;

3775 i‡(!
	`pxt4_em±y_dú
(
√w
.
öode
))

3776 
íd_ª«me
;

3778 
ªtvÆ
 = -
EMLINK
;

3779 i‡(
√w
.
dú
 !
ﬁd
.dú && 
	`PXT4_DIR_LINK_MAX
(new.dir))

3780 
íd_ª«me
;

3782 
ªtvÆ
 = 
	`pxt4_ª«me_dú_¥ï¨e
(
h™dÀ
, &
ﬁd
);

3783 i‡(
ªtvÆ
)

3784 
íd_ª«me
;

3793 
f‹˚_ªªad
 = (
√w
.
dú
->
i_öo
 =
ﬁd
.dir->i_ino &&

3794 
	`pxt4_ã°_öode_Êag
(
√w
.
dú
, 
PXT4_INODE_INLINE_DATA
));

3796 i‡(
whôeout
) {

3801 
ªtvÆ
 = 
	`pxt4_£ã¡
(
h™dÀ
, &
ﬁd
, 
whôeout
->
i_öo
,

3802 
PXT4_FT_CHRDEV
);

3803 i‡(
ªtvÆ
)

3804 
íd_ª«me
;

3805 
	`pxt4_m¨k_öode_dúty
(
h™dÀ
, 
whôeout
);

3807 i‡(!
√w
.
bh
) {

3808 
ªtvÆ
 = 
	`pxt4_add_íåy
(
h™dÀ
, 
√w
.
díåy
, 
ﬁd
.
öode
);

3809 i‡(
ªtvÆ
)

3810 
íd_ª«me
;

3812 
ªtvÆ
 = 
	`pxt4_£ã¡
(
h™dÀ
, &
√w
,

3813 
ﬁd
.
öode
->
i_öo
, 
ﬁd_fûe_ty≥
);

3814 i‡(
ªtvÆ
)

3815 
íd_ª«me
;

3817 i‡(
f‹˚_ªªad
)

3818 
f‹˚_ªªad
 = !
	`pxt4_ã°_öode_Êag
(
√w
.
dú
,

3819 
PXT4_INODE_INLINE_DATA
);

3825 
ﬁd
.
öode
->
i_˘ime
 = 
	`cuºít_time
(old.inode);

3826 
	`pxt4_m¨k_öode_dúty
(
h™dÀ
, 
ﬁd
.
öode
);

3828 i‡(!
whôeout
) {

3832 
	`pxt4_ª«me_dñëe
(
h™dÀ
, &
ﬁd
, 
f‹˚_ªªad
);

3835 i‡(
√w
.
öode
) {

3836 
	`pxt4_dec_cou¡
(
h™dÀ
, 
√w
.
öode
);

3837 
√w
.
öode
->
i_˘ime
 = 
	`cuºít_time
(new.inode);

3839 
ﬁd
.
dú
->
i_˘ime
 = old.dú->
i_mtime
 = 
	`cuºít_time
(old.dir);

3840 
	`pxt4_upd©e_dx_Êag
(
ﬁd
.
dú
);

3841 i‡(
ﬁd
.
dú_bh
) {

3842 
ªtvÆ
 = 
	`pxt4_ª«me_dú_föish
(
h™dÀ
, &
ﬁd
, 
√w
.
dú
->
i_öo
);

3843 i‡(
ªtvÆ
)

3844 
íd_ª«me
;

3846 
	`pxt4_dec_cou¡
(
h™dÀ
, 
ﬁd
.
dú
);

3847 i‡(
√w
.
öode
) {

3851 
	`˛ór_∆ök
(
√w
.
öode
);

3853 
	`pxt4_öc_cou¡
(
h™dÀ
, 
√w
.
dú
);

3854 
	`pxt4_upd©e_dx_Êag
(
√w
.
dú
);

3855 
	`pxt4_m¨k_öode_dúty
(
h™dÀ
, 
√w
.
dú
);

3858 
	`pxt4_m¨k_öode_dúty
(
h™dÀ
, 
ﬁd
.
dú
);

3859 i‡(
√w
.
öode
) {

3860 
	`pxt4_m¨k_öode_dúty
(
h™dÀ
, 
√w
.
öode
);

3861 i‡(!
√w
.
öode
->
i_∆ök
)

3862 
	`pxt4_‹ph™_add
(
h™dÀ
, 
√w
.
öode
);

3864 
ªtvÆ
 = 0;

3866 
íd_ª«me
:

3867 i‡(
whôeout
) {

3868 i‡(
ªtvÆ
) {

3869 
	`pxt4_ª£ã¡
(
h™dÀ
, &
ﬁd
,

3870 
ﬁd
.
öode
->
i_öo
, 
ﬁd_fûe_ty≥
);

3871 
	`dr›_∆ök
(
whôeout
);

3872 
	`pxt4_‹ph™_add
(
h™dÀ
, 
whôeout
);

3874 
	`u∆ock_√w_öode
(
whôeout
);

3875 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

3876 
	`ùut
(
whôeout
);

3878 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

3880 
ªÀa£_bh
:

3881 
	`bªl£
(
ﬁd
.
dú_bh
);

3882 
	`bªl£
(
ﬁd
.
bh
);

3883 
	`bªl£
(
√w
.
bh
);

3884  
ªtvÆ
;

3885 
	}
}

3887 
	$pxt4_¸oss_ª«me
(
öode
 *
ﬁd_dú
, 
díåy
 *
ﬁd_díåy
,

3888 
öode
 *
√w_dú
, 
díåy
 *
√w_díåy
)

3890 
h™dÀ_t
 *
h™dÀ
 = 
NULL
;

3891 
pxt4_ª«mít
 
ﬁd
 = {

3892 .
dú
 = 
ﬁd_dú
,

3893 .
díåy
 = 
ﬁd_díåy
,

3894 .
öode
 = 
	`d_öode
(
ﬁd_díåy
),

3896 
pxt4_ª«mít
 
√w
 = {

3897 .
dú
 = 
√w_dú
,

3898 .
díåy
 = 
√w_díåy
,

3899 .
öode
 = 
	`d_öode
(
√w_díåy
),

3901 
u8
 
√w_fûe_ty≥
;

3902 
ªtvÆ
;

3903 
time•ec64
 
˘ime
;

3905 i‡((
	`pxt4_ã°_öode_Êag
(
√w_dú
, 
PXT4_INODE_PROJINHERIT
) &&

3906 !
	`¥ojid_eq
(
	`PXT4_I
(
√w_dú
)->
i_¥ojid
,

3907 
	`PXT4_I
(
ﬁd_díåy
->
d_öode
)->
i_¥ojid
)) ||

3908 (
	`pxt4_ã°_öode_Êag
(
ﬁd_dú
, 
PXT4_INODE_PROJINHERIT
) &&

3909 !
	`¥ojid_eq
(
	`PXT4_I
(
ﬁd_dú
)->
i_¥ojid
,

3910 
	`PXT4_I
(
√w_díåy
->
d_öode
)->
i_¥ojid
)))

3911  -
EXDEV
;

3913 
ªtvÆ
 = 
	`dquŸ_öôülize
(
ﬁd
.
dú
);

3914 i‡(
ªtvÆ
)

3915  
ªtvÆ
;

3916 
ªtvÆ
 = 
	`dquŸ_öôülize
(
√w
.
dú
);

3917 i‡(
ªtvÆ
)

3918  
ªtvÆ
;

3920 
ﬁd
.
bh
 = 
	`pxt4_föd_íåy
(ﬁd.
dú
, &ﬁd.
díåy
->
d_«me
,

3921 &
ﬁd
.
de
, &ﬁd.
ölöed
);

3922 i‡(
	`IS_ERR
(
ﬁd
.
bh
))

3923  
	`PTR_ERR
(
ﬁd
.
bh
);

3930 
ªtvÆ
 = -
ENOENT
;

3931 i‡(!
ﬁd
.
bh
 || 
	`À32_to_˝u
(ﬁd.
de
->
öode
Ë!ﬁd.öode->
i_öo
)

3932 
íd_ª«me
;

3934 
√w
.
bh
 = 
	`pxt4_föd_íåy
“ew.
dú
, &√w.
díåy
->
d_«me
,

3935 &
√w
.
de
, &√w.
ölöed
);

3936 i‡(
	`IS_ERR
(
√w
.
bh
)) {

3937 
ªtvÆ
 = 
	`PTR_ERR
(
√w
.
bh
);

3938 
√w
.
bh
 = 
NULL
;

3939 
íd_ª«me
;

3943 i‡(!
√w
.
bh
 || 
	`À32_to_˝u
“ew.
de
->
öode
Ë!√w.öode->
i_öo
)

3944 
íd_ª«me
;

3946 
h™dÀ
 = 
	`pxt4_jou∫Æ_°¨t
(
ﬁd
.
dú
, 
PXT4_HT_DIR
,

3947 (2 * 
	`PXT4_DATA_TRANS_BLOCKS
(
ﬁd
.
dú
->
i_sb
) +

3948 2 * 
PXT4_INDEX_EXTRA_TRANS_BLOCKS
 + 2));

3949 i‡(
	`IS_ERR
(
h™dÀ
)) {

3950 
ªtvÆ
 = 
	`PTR_ERR
(
h™dÀ
);

3951 
h™dÀ
 = 
NULL
;

3952 
íd_ª«me
;

3955 i‡(
	`IS_DIRSYNC
(
ﬁd
.
dú
Ë|| IS_DIRSYNC(
√w
.dir))

3956 
	`pxt4_h™dÀ_sync
(
h™dÀ
);

3958 i‡(
	`S_ISDIR
(
ﬁd
.
öode
->
i_mode
)) {

3959 
ﬁd
.
is_dú
 = 
åue
;

3960 
ªtvÆ
 = 
	`pxt4_ª«me_dú_¥ï¨e
(
h™dÀ
, &
ﬁd
);

3961 i‡(
ªtvÆ
)

3962 
íd_ª«me
;

3964 i‡(
	`S_ISDIR
(
√w
.
öode
->
i_mode
)) {

3965 
√w
.
is_dú
 = 
åue
;

3966 
ªtvÆ
 = 
	`pxt4_ª«me_dú_¥ï¨e
(
h™dÀ
, &
√w
);

3967 i‡(
ªtvÆ
)

3968 
íd_ª«me
;

3975 i‡(
ﬁd
.
dú
 !
√w
.dú && old.
is_dú
 !=Çew.is_dir) {

3976 
ﬁd
.
dú_∆ök_dñè
 = old.
is_dú
 ? -1 : 1;

3977 
√w
.
dú_∆ök_dñè
 = -
ﬁd
.dir_nlink_delta;

3978 
ªtvÆ
 = -
EMLINK
;

3979 i‡((
ﬁd
.
dú_∆ök_dñè
 > 0 && 
	`PXT4_DIR_LINK_MAX
(ﬁd.
dú
)) ||

3980 (
√w
.
dú_∆ök_dñè
 > 0 && 
	`PXT4_DIR_LINK_MAX
“ew.
dú
)))

3981 
íd_ª«me
;

3984 
√w_fûe_ty≥
 = 
√w
.
de
->
fûe_ty≥
;

3985 
ªtvÆ
 = 
	`pxt4_£ã¡
(
h™dÀ
, &
√w
, 
ﬁd
.
öode
->
i_öo
, old.
de
->
fûe_ty≥
);

3986 i‡(
ªtvÆ
)

3987 
íd_ª«me
;

3989 
ªtvÆ
 = 
	`pxt4_£ã¡
(
h™dÀ
, &
ﬁd
, 
√w
.
öode
->
i_öo
, 
√w_fûe_ty≥
);

3990 i‡(
ªtvÆ
)

3991 
íd_ª«me
;

3997 
˘ime
 = 
	`cuºít_time
(
ﬁd
.
öode
);

3998 
ﬁd
.
öode
->
i_˘ime
 = 
˘ime
;

3999 
√w
.
öode
->
i_˘ime
 = 
˘ime
;

4000 
	`pxt4_m¨k_öode_dúty
(
h™dÀ
, 
ﬁd
.
öode
);

4001 
	`pxt4_m¨k_öode_dúty
(
h™dÀ
, 
√w
.
öode
);

4003 i‡(
ﬁd
.
dú_bh
) {

4004 
ªtvÆ
 = 
	`pxt4_ª«me_dú_föish
(
h™dÀ
, &
ﬁd
, 
√w
.
dú
->
i_öo
);

4005 i‡(
ªtvÆ
)

4006 
íd_ª«me
;

4008 i‡(
√w
.
dú_bh
) {

4009 
ªtvÆ
 = 
	`pxt4_ª«me_dú_föish
(
h™dÀ
, &
√w
, 
ﬁd
.
dú
->
i_öo
);

4010 i‡(
ªtvÆ
)

4011 
íd_ª«me
;

4013 
	`pxt4_upd©e_dú_cou¡
(
h™dÀ
, &
ﬁd
);

4014 
	`pxt4_upd©e_dú_cou¡
(
h™dÀ
, &
√w
);

4015 
ªtvÆ
 = 0;

4017 
íd_ª«me
:

4018 
	`bªl£
(
ﬁd
.
dú_bh
);

4019 
	`bªl£
(
√w
.
dú_bh
);

4020 
	`bªl£
(
ﬁd
.
bh
);

4021 
	`bªl£
(
√w
.
bh
);

4022 i‡(
h™dÀ
)

4023 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

4024  
ªtvÆ
;

4025 
	}
}

4027 
	$pxt4_ª«me2
(
öode
 *
ﬁd_dú
, 
díåy
 *
ﬁd_díåy
,

4028 
öode
 *
√w_dú
, 
díåy
 *
√w_díåy
,

4029 
Êags
)

4031 
îr
;

4033 i‡(
	`u∆ikñy
(
	`pxt4_f‹˚d_shutdown
(
	`PXT4_SB
(
ﬁd_dú
->
i_sb
))))

4034  -
EIO
;

4036 i‡(
Êags
 & ~(
RENAME_NOREPLACE
 | 
RENAME_EXCHANGE
 | 
RENAME_WHITEOUT
))

4037  -
EINVAL
;

4039 
îr
 = 
	`fs¸y±_¥ï¨e_ª«me
(
ﬁd_dú
, 
ﬁd_díåy
, 
√w_dú
, 
√w_díåy
,

4040 
Êags
);

4041 i‡(
îr
)

4042  
îr
;

4044 i‡(
Êags
 & 
RENAME_EXCHANGE
) {

4045  
	`pxt4_¸oss_ª«me
(
ﬁd_dú
, 
ﬁd_díåy
,

4046 
√w_dú
, 
√w_díåy
);

4049  
	`pxt4_ª«me
(
ﬁd_dú
, 
ﬁd_díåy
, 
√w_dú
, 
√w_díåy
, 
Êags
);

4050 
	}
}

4055 c⁄° 
öode_›î©i⁄s
 
	gpxt4_dú_öode_›î©i⁄s
 = {

4056 .
¸óã
 = 
pxt4_¸óã
,

4057 .
	glookup
 = 
pxt4_lookup
,

4058 .
	glök
 = 
pxt4_lök
,

4059 .
	gu∆ök
 = 
pxt4_u∆ök
,

4060 .
	gsymlök
 = 
pxt4_symlök
,

4061 .
	gmkdú
 = 
pxt4_mkdú
,

4062 .
	grmdú
 = 
pxt4_rmdú
,

4063 .
	gmknod
 = 
pxt4_mknod
,

4064 .
	gtmpfûe
 = 
pxt4_tmpfûe
,

4065 .
	gª«me
 = 
pxt4_ª«me2
,

4066 .
	g£èâr
 = 
pxt4_£èâr
,

4067 .
	ggë©å
 = 
pxt4_gë©å
,

4068 .
	gli°x©å
 = 
pxt4_li°x©å
,

4069 .
	ggë_a˛
 = 
pxt4_gë_a˛
,

4070 .
	g£t_a˛
 = 
pxt4_£t_a˛
,

4071 .
	gfõm≠
 = 
pxt4_fõm≠
,

4074 c⁄° 
öode_›î©i⁄s
 
	gpxt4_•ecül_öode_›î©i⁄s
 = {

4075 .
£èâr
 = 
pxt4_£èâr
,

4076 .
	ggë©å
 = 
pxt4_gë©å
,

4077 .
	gli°x©å
 = 
pxt4_li°x©å
,

4078 .
	ggë_a˛
 = 
pxt4_gë_a˛
,

4079 .
	g£t_a˛
 = 
pxt4_£t_a˛
,

	@page-io.c

10 
	~<löux/fs.h
>

11 
	~<löux/time.h
>

12 
	~<löux/highuid.h
>

13 
	~<löux/∑gem≠.h
>

14 
	~<löux/quŸa›s.h
>

15 
	~<löux/°rög.h
>

16 
	~<löux/buf„r_hód.h
>

17 
	~<löux/wrôeback.h
>

18 
	~<löux/∑gevec.h
>

19 
	~<löux/m∑ge.h
>

20 
	~<löux/«mei.h
>

21 
	~<löux/uio.h
>

22 
	~<löux/bio.h
>

23 
	~<löux/w‹kqueue.h
>

24 
	~<löux/kî√l.h
>

25 
	~<löux/¶ab.h
>

26 
	~<löux/mm.h
>

27 
	~<löux/backög-dev.h
>

29 
	~"pxt4_jbd3.h
"

30 
	~"x©å.h
"

31 
	~"a˛.h
"

33 
kmem_ˇche
 *
	gio_íd_ˇchï
;

35 
__öô
 
	$pxt4_öô_∑geio
()

37 
io_íd_ˇchï
 = 
	`KMEM_CACHE
(
pxt4_io_íd
, 
SLAB_RECLAIM_ACCOUNT
);

38 i‡(
io_íd_ˇchï
 =
NULL
)

39  -
ENOMEM
;

41 
	}
}

43 
	$pxt4_exô_∑geio
()

45 
	`kmem_ˇche_de°roy
(
io_íd_ˇchï
);

46 
	}
}

55 
	$buf„r_io_îr‹
(
buf„r_hód
 *
bh
)

57 
	`¥ötk_øãlimôed
(
KERN_ERR
 "Buffer I/OÉrror on device %pg,Üogical block %llu\n",

58 
bh
->
b_bdev
,

59 ()
bh
->
b_blockƒ
);

60 
	}
}

62 
	$pxt4_föish_bio
(
bio
 *bio)

64 
bio_vec
 *
bvec
;

65 
bvec_ôî_Æl
 
ôî_Æl
;

67 
	`bio_f‹_óch_£gmít_Æl
(
bvec
, 
bio
, 
ôî_Æl
) {

68 
∑ge
 *∑gê
bvec
->
bv_∑ge
;

69 
∑ge
 *
boun˚_∑ge
 = 
NULL
;

70 
buf„r_hód
 *
bh
, *
hód
;

71 
bio_°¨t
 = 
bvec
->
bv_off£t
;

72 
bio_íd
 = 
bio_°¨t
 + 
bvec
->
bv_Àn
;

73 
undî_io
 = 0;

74 
Êags
;

76 i‡(!
∑ge
)

79 i‡(
	`fs¸y±_is_boun˚_∑ge
(
∑ge
)) {

80 
boun˚_∑ge
 = 
∑ge
;

81 
∑ge
 = 
	`fs¸y±_∑geˇche_∑ge
(
boun˚_∑ge
);

84 i‡(
bio
->
bi_°©us
) {

85 
	`SëPageEº‹
(
∑ge
);

86 
	`m≠pög_£t_îr‹
(
∑ge
->
m≠pög
, -
EIO
);

88 
bh
 = 
hód
 = 
	`∑ge_buf„rs
(
∑ge
);

93 
	`loˇl_úq_ßve
(
Êags
);

94 
	`bô_•ö_lock
(
BH_U±od©e_Lock
, &
hód
->
b_°©e
);

96 i‡(
	`bh_off£t
(
bh
Ë< 
bio_°¨t
 ||

97 
	`bh_off£t
(
bh
Ë+ bh->
b_size
 > 
bio_íd
) {

98 i‡(
	`buf„r_async_wrôe
(
bh
))

99 
undî_io
++;

102 
	`˛ór_buf„r_async_wrôe
(
bh
);

103 i‡(
bio
->
bi_°©us
)

104 
	`buf„r_io_îr‹
(
bh
);

105 } (
bh
 = bh->
b_this_∑ge
Ë!
hód
);

106 
	`bô_•ö_u∆ock
(
BH_U±od©e_Lock
, &
hód
->
b_°©e
);

107 
	`loˇl_úq_ª°‹e
(
Êags
);

108 i‡(!
undî_io
) {

109 
	`fs¸y±_‰ì_boun˚_∑ge
(
boun˚_∑ge
);

110 
	`íd_∑ge_wrôeback
(
∑ge
);

113 
	}
}

115 
	$pxt4_ªÀa£_io_íd
(
pxt4_io_íd_t
 *
io_íd
)

117 
bio
 *bio, *
√xt_bio
;

119 
	`BUG_ON
(!
	`li°_em±y
(&
io_íd
->
li°
));

120 
	`BUG_ON
(
io_íd
->
Êag
 & 
PXT4_IO_END_UNWRITTEN
);

121 
	`WARN_ON
(
io_íd
->
h™dÀ
);

123 
bio
 = 
io_íd
->bio; bio; biÿ
√xt_bio
) {

124 
√xt_bio
 = 
bio
->
bi_¥iv©e
;

125 
	`pxt4_föish_bio
(
bio
);

126 
	`bio_put
(
bio
);

128 
	`kmem_ˇche_‰ì
(
io_íd_ˇchï
, 
io_íd
);

129 
	}
}

139 
	$pxt4_íd_io
(
pxt4_io_íd_t
 *
io
)

141 
öode
 *öodê
io
->inode;

142 
loff_t
 
off£t
 = 
io
->offset;

143 
ssize_t
 
size
 = 
io
->size;

144 
h™dÀ_t
 *
h™dÀ
 = 
io
->handle;

145 
ªt
 = 0;

147 
	`pxt4_debug
("pxt4_end_io_nolock: io 0x%p from inode %lu,list->next 0x%p,"

149 
io
, 
öode
->
i_öo
, io->
li°
.
√xt
, io->li°.
¥ev
);

151 
io
->
h™dÀ
 = 
NULL
;

152 
ªt
 = 
	`pxt4_c⁄vît_unwrôãn_exã¡s
(
h™dÀ
, 
öode
, 
off£t
, 
size
);

153 i‡(
ªt
 < 0 && !
	`pxt4_f‹˚d_shutdown
(
	`PXT4_SB
(
öode
->
i_sb
))) {

154 
	`pxt4_msg
(
öode
->
i_sb
, 
KERN_EMERG
,

158 
öode
->
i_öo
, 
off£t
, 
size
, 
ªt
);

160 
	`pxt4_˛ór_io_unwrôãn_Êag
(
io
);

161 
	`pxt4_ªÀa£_io_íd
(
io
);

162  
ªt
;

163 
	}
}

165 
	$dump_com∂ëed_IO
(
öode
 *öode, 
li°_hód
 *
hód
)

167 #ifdef 
PXT4FS_DEBUG


168 
li°_hód
 *
cur
, *
bef‹e
, *
a·î
;

169 
pxt4_io_íd_t
 *
io
, *
io0
, *
io1
;

171 i‡(
	`li°_em±y
(
hód
))

174 
	`pxt4_debug
("Dum∞öodê%lu com∂ëed iÿli°\n", 
öode
->
i_öo
);

175 
	`li°_f‹_óch_íåy
(
io
, 
hód
, 
li°
) {

176 
cur
 = &
io
->
li°
;

177 
bef‹e
 = 
cur
->
¥ev
;

178 
io0
 = 
	`c⁄èöî_of
(
bef‹e
, 
pxt4_io_íd_t
, 
li°
);

179 
a·î
 = 
cur
->
√xt
;

180 
io1
 = 
	`c⁄èöî_of
(
a·î
, 
pxt4_io_íd_t
, 
li°
);

182 
	`pxt4_debug
("io 0x%p from inode %lu,prev 0x%p,next 0x%p\n",

183 
io
, 
öode
->
i_öo
, 
io0
, 
io1
);

186 
	}
}

189 
	$pxt4_add_com∂ëe_io
(
pxt4_io_íd_t
 *
io_íd
)

191 
pxt4_öode_öfo
 *
ei
 = 
	`PXT4_I
(
io_íd
->
öode
);

192 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
io_íd
->
öode
->
i_sb
);

193 
w‹kqueue_°ru˘
 *
wq
;

194 
Êags
;

197 
	`WARN_ON
(!(
io_íd
->
Êag
 & 
PXT4_IO_END_UNWRITTEN
));

198 
	`WARN_ON
(!
io_íd
->
h™dÀ
 && 
sbi
->
s_jou∫Æ
);

199 
	`•ö_lock_úqßve
(&
ei
->
i_com∂ëed_io_lock
, 
Êags
);

200 
wq
 = 
sbi
->
rsv_c⁄vîsi⁄_wq
;

201 i‡(
	`li°_em±y
(&
ei
->
i_rsv_c⁄vîsi⁄_li°
))

202 
	`queue_w‹k
(
wq
, &
ei
->
i_rsv_c⁄vîsi⁄_w‹k
);

203 
	`li°_add_èû
(&
io_íd
->
li°
, &
ei
->
i_rsv_c⁄vîsi⁄_li°
);

204 
	`•ö_u∆ock_úqª°‹e
(&
ei
->
i_com∂ëed_io_lock
, 
Êags
);

205 
	}
}

207 
	$pxt4_do_Êush_com∂ëed_IO
(
öode
 *inode,

208 
li°_hód
 *
hód
)

210 
pxt4_io_íd_t
 *
io
;

211 
li°_hód
 
unwrôãn
;

212 
Êags
;

213 
pxt4_öode_öfo
 *
ei
 = 
	`PXT4_I
(
öode
);

214 
îr
, 
ªt
 = 0;

216 
	`•ö_lock_úqßve
(&
ei
->
i_com∂ëed_io_lock
, 
Êags
);

217 
	`dump_com∂ëed_IO
(
öode
, 
hód
);

218 
	`li°_ª∂a˚_öô
(
hód
, &
unwrôãn
);

219 
	`•ö_u∆ock_úqª°‹e
(&
ei
->
i_com∂ëed_io_lock
, 
Êags
);

221 !
	`li°_em±y
(&
unwrôãn
)) {

222 
io
 = 
	`li°_íåy
(
unwrôãn
.
√xt
, 
pxt4_io_íd_t
, 
li°
);

223 
	`BUG_ON
(!(
io
->
Êag
 & 
PXT4_IO_END_UNWRITTEN
));

224 
	`li°_dñ_öô
(&
io
->
li°
);

226 
îr
 = 
	`pxt4_íd_io
(
io
);

227 i‡(
	`u∆ikñy
(!
ªt
 && 
îr
))

228 
ªt
 = 
îr
;

230  
ªt
;

231 
	}
}

236 
	$pxt4_íd_io_rsv_w‹k
(
w‹k_°ru˘
 *
w‹k
)

238 
pxt4_öode_öfo
 *
ei
 = 
	`c⁄èöî_of
(
w‹k
, pxt4_inode_info,

239 
i_rsv_c⁄vîsi⁄_w‹k
);

240 
	`pxt4_do_Êush_com∂ëed_IO
(&
ei
->
vfs_öode
, &ei->
i_rsv_c⁄vîsi⁄_li°
);

241 
	}
}

243 
pxt4_io_íd_t
 *
	$pxt4_öô_io_íd
(
öode
 *öode, 
gÂ_t
 
Êags
)

245 
pxt4_io_íd_t
 *
io
 = 
	`kmem_ˇche_zÆloc
(
io_íd_ˇchï
, 
Êags
);

246 i‡(
io
) {

247 
io
->
öode
 = inode;

248 
	`INIT_LIST_HEAD
(&
io
->
li°
);

249 
	`©omic_£t
(&
io
->
cou¡
, 1);

251  
io
;

252 
	}
}

254 
	$pxt4_put_io_íd_de„r
(
pxt4_io_íd_t
 *
io_íd
)

256 i‡(
	`©omic_dec_™d_ã°
(&
io_íd
->
cou¡
)) {

257 i‡(!(
io_íd
->
Êag
 & 
PXT4_IO_END_UNWRITTEN
Ë|| !io_íd->
size
) {

258 
	`pxt4_ªÀa£_io_íd
(
io_íd
);

261 
	`pxt4_add_com∂ëe_io
(
io_íd
);

263 
	}
}

265 
	$pxt4_put_io_íd
(
pxt4_io_íd_t
 *
io_íd
)

267 
îr
 = 0;

269 i‡(
	`©omic_dec_™d_ã°
(&
io_íd
->
cou¡
)) {

270 i‡(
io_íd
->
Êag
 & 
PXT4_IO_END_UNWRITTEN
) {

271 
îr
 = 
	`pxt4_c⁄vît_unwrôãn_exã¡s
(
io_íd
->
h™dÀ
,

272 
io_íd
->
öode
, io_íd->
off£t
,

273 
io_íd
->
size
);

274 
io_íd
->
h™dÀ
 = 
NULL
;

275 
	`pxt4_˛ór_io_unwrôãn_Êag
(
io_íd
);

277 
	`pxt4_ªÀa£_io_íd
(
io_íd
);

279  
îr
;

280 
	}
}

282 
pxt4_io_íd_t
 *
	$pxt4_gë_io_íd
(
pxt4_io_íd_t
 *
io_íd
)

284 
	`©omic_öc
(&
io_íd
->
cou¡
);

285  
io_íd
;

286 
	}
}

289 
	$pxt4_íd_bio
(
bio
 *bio)

291 
pxt4_io_íd_t
 *
io_íd
 = 
bio
->
bi_¥iv©e
;

292 
£˘‹_t
 
bi_£˘‹
 = 
bio
->
bi_ôî
.bi_sector;

293 
b
[
BDEVNAME_SIZE
];

295 i‡(
	`WARN_ONCE
(!
io_íd
, "io_end is NULL: %s: sector %LuÜen %uÉrr %d\n",

296 
	`bio_dev«me
(
bio
, 
b
),

297 (Ë
bio
->
bi_ôî
.
bi_£˘‹
,

298 (Ë
	`bio_£˘‹s
(
bio
),

299 
bio
->
bi_°©us
)) {

300 
	`pxt4_föish_bio
(
bio
);

301 
	`bio_put
(
bio
);

304 
bio
->
bi_íd_io
 = 
NULL
;

306 i‡(
bio
->
bi_°©us
) {

307 
öode
 *öodê
io_íd
->inode;

309 
	`pxt4_w¨nög
(
öode
->
i_sb
, "I/OÉrror %d writingÅo inode %lu "

311 
bio
->
bi_°©us
, 
öode
->
i_öo
,

312 (Ë
io_íd
->
off£t
,

313 (Ë
io_íd
->
size
,

315 
bi_£˘‹
 >> (
öode
->
i_blkbôs
 - 9));

316 
	`m≠pög_£t_îr‹
(
öode
->
i_m≠pög
,

317 
	`blk_°©us_to_î∫o
(
bio
->
bi_°©us
));

320 i‡(
io_íd
->
Êag
 & 
PXT4_IO_END_UNWRITTEN
) {

326 
bio
->
bi_¥iv©e
 = 
	`xchg
(&
io_íd
->bio, bio);

327 
	`pxt4_put_io_íd_de„r
(
io_íd
);

333 
	`pxt4_put_io_íd_de„r
(
io_íd
);

334 
	`pxt4_föish_bio
(
bio
);

335 
	`bio_put
(
bio
);

337 
	}
}

339 
	$pxt4_io_submô
(
pxt4_io_submô
 *
io
)

341 
bio
 *biÿ
io
->
io_bio
;

343 i‡(
bio
) {

344 
io_›_Êags
 = 
io
->
io_wbc
->
sync_mode
 =
WB_SYNC_ALL
 ?

345 
REQ_SYNC
 : 0;

346 
io
->
io_bio
->
bi_wrôe_höt
 = io->
io_íd
->
öode
->
i_wrôe_höt
;

347 
	`bio_£t_›_©ås
(
io
->
io_bio
, 
REQ_OP_WRITE
, 
io_›_Êags
);

348 
	`submô_bio
(
io
->
io_bio
);

350 
io
->
io_bio
 = 
NULL
;

351 
	}
}

353 
	$pxt4_io_submô_öô
(
pxt4_io_submô
 *
io
,

354 
wrôeback_c⁄åﬁ
 *
wbc
)

356 
io
->
io_wbc
 = 
wbc
;

357 
io
->
io_bio
 = 
NULL
;

358 
io
->
io_íd
 = 
NULL
;

359 
	}
}

361 
	$io_submô_öô_bio
(
pxt4_io_submô
 *
io
,

362 
buf„r_hód
 *
bh
)

364 
bio
 *bio;

366 
bio
 = 
	`bio_Æloc
(
GFP_NOIO
, 
BIO_MAX_PAGES
);

367 i‡(!
bio
)

368  -
ENOMEM
;

369 
bio
->
bi_ôî
.
bi_£˘‹
 = 
bh
->
b_blockƒ
 * (bh->
b_size
 >> 9);

370 
	`bio_£t_dev
(
bio
, 
bh
->
b_bdev
);

371 
bio
->
bi_íd_io
 = 
pxt4_íd_bio
;

372 
bio
->
bi_¥iv©e
 = 
	`pxt4_gë_io_íd
(
io
->
io_íd
);

373 
io
->
io_bio
 = 
bio
;

374 
io
->
io_√xt_block
 = 
bh
->
b_blockƒ
;

375 
	`wbc_öô_bio
(
io
->
io_wbc
, 
bio
);

377 
	}
}

379 
	$io_submô_add_bh
(
pxt4_io_submô
 *
io
,

380 
öode
 *inode,

381 
∑ge
 *page,

382 
buf„r_hód
 *
bh
)

384 
ªt
;

386 i‡(
io
->
io_bio
 && 
bh
->
b_blockƒ
 !io->
io_√xt_block
) {

387 
submô_™d_ªåy
:

388 
	`pxt4_io_submô
(
io
);

390 i‡(
io
->
io_bio
 =
NULL
) {

391 
ªt
 = 
	`io_submô_öô_bio
(
io
, 
bh
);

392 i‡(
ªt
)

393  
ªt
;

394 
io
->
io_bio
->
bi_wrôe_höt
 = 
öode
->
i_wrôe_höt
;

396 
ªt
 = 
	`bio_add_∑ge
(
io
->
io_bio
, 
∑ge
, 
bh
->
b_size
, 
	`bh_off£t
(bh));

397 i‡(
ªt
 !
bh
->
b_size
)

398 
submô_™d_ªåy
;

399 
	`wbc_accou¡_cgroup_ow√r
(
io
->
io_wbc
, 
∑ge
, 
bh
->
b_size
);

400 
io
->
io_√xt_block
++;

402 
	}
}

404 
	$pxt4_bio_wrôe_∑ge
(
pxt4_io_submô
 *
io
,

405 
∑ge
 *page,

406 
Àn
,

407 
wrôeback_c⁄åﬁ
 *
wbc
,

408 
boﬁ
 
kìp_towrôe
)

410 
∑ge
 *
boun˚_∑ge
 = 
NULL
;

411 
öode
 *öodê
∑ge
->
m≠pög
->
ho°
;

412 
block_°¨t
;

413 
buf„r_hód
 *
bh
, *
hód
;

414 
ªt
 = 0;

415 
ƒ_submôãd
 = 0;

416 
ƒ_to_submô
 = 0;

418 
	`BUG_ON
(!
	`PageLocked
(
∑ge
));

419 
	`BUG_ON
(
	`PageWrôeback
(
∑ge
));

421 i‡(
kìp_towrôe
)

422 
	`£t_∑ge_wrôeback_kìpwrôe
(
∑ge
);

424 
	`£t_∑ge_wrôeback
(
∑ge
);

425 
	`CÀ¨PageEº‹
(
∑ge
);

436 i‡(
Àn
 < 
PAGE_SIZE
)

437 
	`zîo_u£r_£gmít
(
∑ge
, 
Àn
, 
PAGE_SIZE
);

445 
bh
 = 
hód
 = 
	`∑ge_buf„rs
(
∑ge
);

447 
block_°¨t
 = 
	`bh_off£t
(
bh
);

448 i‡(
block_°¨t
 >
Àn
) {

449 
	`˛ór_buf„r_dúty
(
bh
);

450 
	`£t_buf„r_u±od©e
(
bh
);

453 i‡(!
	`buf„r_dúty
(
bh
Ë|| 
	`buf„r_dñay
(bh) ||

454 !
	`buf„r_m≠≥d
(
bh
Ë|| 
	`buf„r_unwrôãn
(bh)) {

456 i‡(!
	`buf„r_m≠≥d
(
bh
))

457 
	`˛ór_buf„r_dúty
(
bh
);

458 i‡(
io
->
io_bio
)

459 
	`pxt4_io_submô
(
io
);

462 i‡(
	`buf„r_√w
(
bh
))

463 
	`˛ór_buf„r_√w
(
bh
);

464 
	`£t_buf„r_async_wrôe
(
bh
);

465 
ƒ_to_submô
++;

466 } (
bh
 = bh->
b_this_∑ge
Ë!
hód
);

468 
bh
 = 
hód
 = 
	`∑ge_buf„rs
(
∑ge
);

477 i‡(
	`IS_ENCRYPTED
(
öode
Ë&& 
	`S_ISREG
(öode->
i_mode
Ë&& 
ƒ_to_submô
) {

478 
gÂ_t
 
gÂ_Êags
 = 
GFP_NOFS
;

479 
íc_byãs
 = 
	`round_up
(
Àn
, 
	`i_blocksize
(
öode
));

486 i‡(
io
->
io_bio
)

487 
gÂ_Êags
 = 
GFP_NOWAIT
 | 
__GFP_NOWARN
;

488 
ªåy_í¸y±
:

489 
boun˚_∑ge
 = 
	`fs¸y±_í¸y±_∑geˇche_blocks
(
∑ge
, 
íc_byãs
,

490 0, 
gÂ_Êags
);

491 i‡(
	`IS_ERR
(
boun˚_∑ge
)) {

492 
ªt
 = 
	`PTR_ERR
(
boun˚_∑ge
);

493 i‡(
ªt
 =-
ENOMEM
 &&

494 (
io
->
io_bio
 || 
wbc
->
sync_mode
 =
WB_SYNC_ALL
)) {

495 
gÂ_Êags
 = 
GFP_NOFS
;

496 i‡(
io
->
io_bio
)

497 
	`pxt4_io_submô
(
io
);

499 
gÂ_Êags
 |
__GFP_NOFAIL
;

500 
	`c⁄ge°i⁄_waô
(
BLK_RW_ASYNC
, 
HZ
/50);

501 
ªåy_í¸y±
;

503 
boun˚_∑ge
 = 
NULL
;

504 
out
;

510 i‡(!
	`buf„r_async_wrôe
(
bh
))

512 
ªt
 = 
	`io_submô_add_bh
(
io
, 
öode
, 
boun˚_∑ge
 ?: 
∑ge
, 
bh
);

513 i‡(
ªt
) {

521 
ƒ_submôãd
++;

522 
	`˛ór_buf„r_dúty
(
bh
);

523 } (
bh
 = bh->
b_this_∑ge
Ë!
hód
);

526 i‡(
ªt
) {

527 
out
:

528 
	`fs¸y±_‰ì_boun˚_∑ge
(
boun˚_∑ge
);

529 
	`¥ötk_øãlimôed
(
KERN_ERR
 "%s:Ñë = %d\n", 
__func__
, 
ªt
);

530 
	`ªdúty_∑ge_f‹_wrôïage
(
wbc
, 
∑ge
);

532 
	`˛ór_buf„r_async_wrôe
(
bh
);

533 
bh
 = bh->
b_this_∑ge
;

534 } 
bh
 !
hód
);

536 
	`u∆ock_∑ge
(
∑ge
);

538 i‡(!
ƒ_submôãd
)

539 
	`íd_∑ge_wrôeback
(
∑ge
);

540  
ªt
;

541 
	}
}

	@readpage.c

31 
	~<löux/kî√l.h
>

32 
	~<löux/exp‹t.h
>

33 
	~<löux/mm.h
>

34 
	~<löux/kdev_t.h
>

35 
	~<löux/gÂ.h
>

36 
	~<löux/bio.h
>

37 
	~<löux/fs.h
>

38 
	~<löux/buf„r_hód.h
>

39 
	~<löux/blkdev.h
>

40 
	~<löux/highmem.h
>

41 
	~<löux/¥e„tch.h
>

42 
	~<löux/m∑ge.h
>

43 
	~<löux/wrôeback.h
>

44 
	~<löux/backög-dev.h
>

45 
	~<löux/∑gevec.h
>

46 
	~<löux/˛ónˇche.h
>

48 
	~"pxt4.h
"

50 
	#NUM_PREALLOC_POST_READ_CTXS
 128

	)

52 
kmem_ˇche
 *
	gbio_po°_ªad_˘x_ˇche
;

53 
mempoﬁ_t
 *
	gbio_po°_ªad_˘x_poﬁ
;

56 
	ebio_po°_ªad_°ï
 {

57 
	mSTEP_INITIAL
 = 0,

58 
	mSTEP_DECRYPT
,

59 
	mSTEP_VERITY
,

60 
	mSTEP_MAX
,

63 
	sbio_po°_ªad_˘x
 {

64 
bio
 *
	mbio
;

65 
w‹k_°ru˘
 
	mw‹k
;

66 
	mcur_°ï
;

67 
	míabÀd_°ïs
;

70 
	$__ªad_íd_io
(
bio
 *bio)

72 
∑ge
 *page;

73 
bio_vec
 *
bv
;

74 
bvec_ôî_Æl
 
ôî_Æl
;

76 
	`bio_f‹_óch_£gmít_Æl
(
bv
, 
bio
, 
ôî_Æl
) {

77 
∑ge
 = 
bv
->
bv_∑ge
;

80 i‡(
bio
->
bi_°©us
 || 
	`PageEº‹
(
∑ge
)) {

81 
	`CÀ¨PageU±od©e
(
∑ge
);

83 
	`CÀ¨PageEº‹
(
∑ge
);

85 
	`SëPageU±od©e
(
∑ge
);

87 
	`u∆ock_∑ge
(
∑ge
);

89 i‡(
bio
->
bi_¥iv©e
)

90 
	`mempoﬁ_‰ì
(
bio
->
bi_¥iv©e
, 
bio_po°_ªad_˘x_poﬁ
);

91 
	`bio_put
(
bio
);

92 
	}
}

94 
bio_po°_ªad_¥o˚ssög
(
bio_po°_ªad_˘x
 *
˘x
);

96 
	$de¸y±_w‹k
(
w‹k_°ru˘
 *
w‹k
)

98 
bio_po°_ªad_˘x
 *
˘x
 =

99 
	`c⁄èöî_of
(
w‹k
, 
bio_po°_ªad_˘x
, work);

101 
	`fs¸y±_de¸y±_bio
(
˘x
->
bio
);

103 
	`bio_po°_ªad_¥o˚ssög
(
˘x
);

104 
	}
}

106 
	$vîôy_w‹k
(
w‹k_°ru˘
 *
w‹k
)

108 
bio_po°_ªad_˘x
 *
˘x
 =

109 
	`c⁄èöî_of
(
w‹k
, 
bio_po°_ªad_˘x
, work);

110 
bio
 *biÿ
˘x
->bio;

119 
	`BUILD_BUG_ON
(
STEP_VERITY
 + 1 !
STEP_MAX
);

120 
	`mempoﬁ_‰ì
(
˘x
, 
bio_po°_ªad_˘x_poﬁ
);

121 
bio
->
bi_¥iv©e
 = 
NULL
;

123 
	`fsvîôy_vîify_bio
(
bio
);

125 
	`__ªad_íd_io
(
bio
);

126 
	}
}

128 
	$bio_po°_ªad_¥o˚ssög
(
bio_po°_ªad_˘x
 *
˘x
)

135 ++
˘x
->
cur_°ï
) {

136 
STEP_DECRYPT
:

137 i‡(
˘x
->
íabÀd_°ïs
 & (1 << 
STEP_DECRYPT
)) {

138 
	`INIT_WORK
(&
˘x
->
w‹k
, 
de¸y±_w‹k
);

139 
	`fs¸y±_íqueue_de¸y±_w‹k
(&
˘x
->
w‹k
);

142 
˘x
->
cur_°ï
++;

144 
STEP_VERITY
:

145 i‡(
˘x
->
íabÀd_°ïs
 & (1 << 
STEP_VERITY
)) {

146 
	`INIT_WORK
(&
˘x
->
w‹k
, 
vîôy_w‹k
);

147 
	`fsvîôy_íqueue_vîify_w‹k
(&
˘x
->
w‹k
);

150 
˘x
->
cur_°ï
++;

153 
	`__ªad_íd_io
(
˘x
->
bio
);

155 
	}
}

157 
boﬁ
 
	$bio_po°_ªad_ªquúed
(
bio
 *bio)

159  
bio
->
bi_¥iv©e
 && !bio->
bi_°©us
;

160 
	}
}

174 
	$m∑ge_íd_io
(
bio
 *bio)

176 i‡(
	`bio_po°_ªad_ªquúed
(
bio
)) {

177 
bio_po°_ªad_˘x
 *
˘x
 = 
bio
->
bi_¥iv©e
;

179 
˘x
->
cur_°ï
 = 
STEP_INITIAL
;

180 
	`bio_po°_ªad_¥o˚ssög
(
˘x
);

183 
	`__ªad_íd_io
(
bio
);

184 
	}
}

186 
ölöe
 
boﬁ
 
	$pxt4_√ed_vîôy
(c⁄° 
öode
 *öode, 
pgoff_t
 
idx
)

188  
	`fsvîôy_a˘ive
(
öode
) &&

189 
idx
 < 
	`DIV_ROUND_UP
(
öode
->
i_size
, 
PAGE_SIZE
);

190 
	}
}

192 
bio_po°_ªad_˘x
 *
	$gë_bio_po°_ªad_˘x
(
öode
 *inode,

193 
bio
 *bio,

194 
pgoff_t
 
fú°_idx
)

196 
po°_ªad_°ïs
 = 0;

197 
bio_po°_ªad_˘x
 *
˘x
 = 
NULL
;

199 i‡(
	`IS_ENCRYPTED
(
öode
Ë&& 
	`S_ISREG
(öode->
i_mode
))

200 
po°_ªad_°ïs
 |1 << 
STEP_DECRYPT
;

202 i‡(
	`pxt4_√ed_vîôy
(
öode
, 
fú°_idx
))

203 
po°_ªad_°ïs
 |1 << 
STEP_VERITY
;

205 i‡(
po°_ªad_°ïs
) {

206 
˘x
 = 
	`mempoﬁ_Æloc
(
bio_po°_ªad_˘x_poﬁ
, 
GFP_NOFS
);

207 i‡(!
˘x
)

208  
	`ERR_PTR
(-
ENOMEM
);

209 
˘x
->
bio
 = bio;

210 
˘x
->
íabÀd_°ïs
 = 
po°_ªad_°ïs
;

211 
bio
->
bi_¥iv©e
 = 
˘x
;

213  
˘x
;

214 
	}
}

216 
ölöe
 
loff_t
 
	$pxt4_ªad∑ge_limô
(
öode
 *inode)

218 i‡(
	`IS_ENABLED
(
CONFIG_FS_VERITY
) &&

219 (
	`IS_VERITY
(
öode
Ë|| 
	`pxt4_vîôy_ö_¥ogªss
(inode)))

220  
öode
->
i_sb
->
s_maxbyãs
;

222  
	`i_size_ªad
(
öode
);

223 
	}
}

225 
	$pxt4_m∑ge_ªad∑ges
(
addªss_•a˚
 *
m≠pög
,

226 
li°_hód
 *
∑ges
, 
∑ge
 *page,

227 
ƒ_∑ges
, 
boﬁ
 
is_ªadahód
)

229 
bio
 *biÿ
NULL
;

230 
£˘‹_t
 
œ°_block_ö_bio
 = 0;

232 
öode
 *öodê
m≠pög
->
ho°
;

233 c⁄° 
blkbôs
 = 
öode
->
i_blkbôs
;

234 c⁄° 
blocks_≥r_∑ge
 = 
PAGE_SIZE
 >> 
blkbôs
;

235 c⁄° 
blocksize
 = 1 << 
blkbôs
;

236 
£˘‹_t
 
block_ö_fûe
;

237 
£˘‹_t
 
œ°_block
;

238 
£˘‹_t
 
œ°_block_ö_fûe
;

239 
£˘‹_t
 
blocks
[
MAX_BUF_PER_PAGE
];

240 
∑ge_block
;

241 
block_devi˚
 *
bdev
 = 
öode
->
i_sb
->
s_bdev
;

242 
Àngth
;

243 
ªœtive_block
 = 0;

244 
pxt4_m≠_blocks
 
m≠
;

246 
m≠
.
m_pblk
 = 0;

247 
m≠
.
m_lblk
 = 0;

248 
m≠
.
m_Àn
 = 0;

249 
m≠
.
m_Êags
 = 0;

251 ; 
ƒ_∑ges
;Çr_pages--) {

252 
fuŒy_m≠≥d
 = 1;

253 
fú°_hﬁe
 = 
blocks_≥r_∑ge
;

255 i‡(
∑ges
) {

256 
∑ge
 = 
	`Ãu_to_∑ge
(
∑ges
);

258 
	`¥e„tchw
(&
∑ge
->
Êags
);

259 
	`li°_dñ
(&
∑ge
->
Ãu
);

260 i‡(
	`add_to_∑ge_ˇche_Ãu
(
∑ge
, 
m≠pög
,Öage->
ödex
,

261 
	`ªadahód_gÂ_mask
(
m≠pög
)))

262 
√xt_∑ge
;

265 i‡(
	`∑ge_has_buf„rs
(
∑ge
))

266 
c⁄fu£d
;

268 
block_ö_fûe
 = (
£˘‹_t
)
∑ge
->
ödex
 << (
PAGE_SHIFT
 - 
blkbôs
);

269 
œ°_block
 = 
block_ö_fûe
 + 
ƒ_∑ges
 * 
blocks_≥r_∑ge
;

270 
œ°_block_ö_fûe
 = (
	`pxt4_ªad∑ge_limô
(
öode
) +

271 
blocksize
 - 1Ë>> 
blkbôs
;

272 i‡(
œ°_block
 > 
œ°_block_ö_fûe
)

273 
œ°_block
 = 
œ°_block_ö_fûe
;

274 
∑ge_block
 = 0;

279 i‡((
m≠
.
m_Êags
 & 
PXT4_MAP_MAPPED
) &&

280 
block_ö_fûe
 > 
m≠
.
m_lblk
 &&

281 
block_ö_fûe
 < (
m≠
.
m_lblk
 + m≠.
m_Àn
)) {

282 
m≠_off£t
 = 
block_ö_fûe
 - 
m≠
.
m_lblk
;

283 
œ°
 = 
m≠
.
m_Àn
 - 
m≠_off£t
;

285 
ªœtive_block
 = 0; ;Ñelative_block++) {

286 i‡(
ªœtive_block
 =
œ°
) {

288 
m≠
.
m_Êags
 &~
PXT4_MAP_MAPPED
;

291 i‡(
∑ge_block
 =
blocks_≥r_∑ge
)

293 
blocks
[
∑ge_block
] = 
m≠
.
m_pblk
 + 
m≠_off£t
 +

294 
ªœtive_block
;

295 
∑ge_block
++;

296 
block_ö_fûe
++;

304 
∑ge_block
 < 
blocks_≥r_∑ge
) {

305 i‡(
block_ö_fûe
 < 
œ°_block
) {

306 
m≠
.
m_lblk
 = 
block_ö_fûe
;

307 
m≠
.
m_Àn
 = 
œ°_block
 - 
block_ö_fûe
;

309 i‡(
	`pxt4_m≠_blocks
(
NULL
, 
öode
, &
m≠
, 0) < 0) {

310 
£t_îr‹_∑ge
:

311 
	`SëPageEº‹
(
∑ge
);

312 
	`zîo_u£r_£gmít
(
∑ge
, 0,

313 
PAGE_SIZE
);

314 
	`u∆ock_∑ge
(
∑ge
);

315 
√xt_∑ge
;

318 i‡((
m≠
.
m_Êags
 & 
PXT4_MAP_MAPPED
) == 0) {

319 
fuŒy_m≠≥d
 = 0;

320 i‡(
fú°_hﬁe
 =
blocks_≥r_∑ge
)

321 
fú°_hﬁe
 = 
∑ge_block
;

322 
∑ge_block
++;

323 
block_ö_fûe
++;

326 i‡(
fú°_hﬁe
 !
blocks_≥r_∑ge
)

327 
c⁄fu£d
;

330 i‡(
∑ge_block
 && 
blocks
[∑ge_block-1] !
m≠
.
m_pblk
-1)

331 
c⁄fu£d
;

332 
ªœtive_block
 = 0; ;Ñelative_block++) {

333 i‡(
ªœtive_block
 =
m≠
.
m_Àn
) {

335 
m≠
.
m_Êags
 &~
PXT4_MAP_MAPPED
;

337 } i‡(
∑ge_block
 =
blocks_≥r_∑ge
)

339 
blocks
[
∑ge_block
] = 
m≠
.
m_pblk
+
ªœtive_block
;

340 
∑ge_block
++;

341 
block_ö_fûe
++;

344 i‡(
fú°_hﬁe
 !
blocks_≥r_∑ge
) {

345 
	`zîo_u£r_£gmít
(
∑ge
, 
fú°_hﬁe
 << 
blkbôs
,

346 
PAGE_SIZE
);

347 i‡(
fú°_hﬁe
 == 0) {

348 i‡(
	`pxt4_√ed_vîôy
(
öode
, 
∑ge
->
ödex
) &&

349 !
	`fsvîôy_vîify_∑ge
(
∑ge
))

350 
£t_îr‹_∑ge
;

351 
	`SëPageU±od©e
(
∑ge
);

352 
	`u∆ock_∑ge
(
∑ge
);

353 
√xt_∑ge
;

355 } i‡(
fuŒy_m≠≥d
) {

356 
	`SëPageM≠≥dToDisk
(
∑ge
);

358 i‡(
fuŒy_m≠≥d
 && 
blocks_≥r_∑ge
 == 1 &&

359 !
	`PageU±od©e
(
∑ge
Ë&& 
	`˛ónˇche_gë_∑ge
(page) == 0) {

360 
	`SëPageU±od©e
(
∑ge
);

361 
c⁄fu£d
;

368 i‡(
bio
 && (
œ°_block_ö_bio
 !
blocks
[0] - 1)) {

369 
submô_™d_ªÆloc
:

370 
	`submô_bio
(
bio
);

371 
bio
 = 
NULL
;

373 i‡(
bio
 =
NULL
) {

374 
bio_po°_ªad_˘x
 *
˘x
;

376 
bio
 = 
	`bio_Æloc
(
GFP_KERNEL
,

377 
	`mö_t
(, 
ƒ_∑ges
, 
BIO_MAX_PAGES
));

378 i‡(!
bio
)

379 
£t_îr‹_∑ge
;

380 
˘x
 = 
	`gë_bio_po°_ªad_˘x
(
öode
, 
bio
, 
∑ge
->
ödex
);

381 i‡(
	`IS_ERR
(
˘x
)) {

382 
	`bio_put
(
bio
);

383 
bio
 = 
NULL
;

384 
£t_îr‹_∑ge
;

386 
	`bio_£t_dev
(
bio
, 
bdev
);

387 
bio
->
bi_ôî
.
bi_£˘‹
 = 
blocks
[0] << (
blkbôs
 - 9);

388 
bio
->
bi_íd_io
 = 
m∑ge_íd_io
;

389 
bio
->
bi_¥iv©e
 = 
˘x
;

390 
	`bio_£t_›_©ås
(
bio
, 
REQ_OP_READ
,

391 
is_ªadahód
 ? 
REQ_RAHEAD
 : 0);

394 
Àngth
 = 
fú°_hﬁe
 << 
blkbôs
;

395 i‡(
	`bio_add_∑ge
(
bio
, 
∑ge
, 
Àngth
, 0) <Üength)

396 
submô_™d_ªÆloc
;

398 i‡(((
m≠
.
m_Êags
 & 
PXT4_MAP_BOUNDARY
) &&

399 (
ªœtive_block
 =
m≠
.
m_Àn
)) ||

400 (
fú°_hﬁe
 !
blocks_≥r_∑ge
)) {

401 
	`submô_bio
(
bio
);

402 
bio
 = 
NULL
;

404 
œ°_block_ö_bio
 = 
blocks
[
blocks_≥r_∑ge
 - 1];

405 
√xt_∑ge
;

406 
c⁄fu£d
:

407 i‡(
bio
) {

408 
	`submô_bio
(
bio
);

409 
bio
 = 
NULL
;

411 i‡(!
	`PageU±od©e
(
∑ge
))

412 
	`block_ªad_fuŒ_∑ge
(
∑ge
, 
pxt4_gë_block
);

414 
	`u∆ock_∑ge
(
∑ge
);

415 
√xt_∑ge
:

416 i‡(
∑ges
)

417 
	`put_∑ge
(
∑ge
);

419 
	`BUG_ON
(
∑ges
 && !
	`li°_em±y
(pages));

420 i‡(
bio
)

421 
	`submô_bio
(
bio
);

423 
	}
}

425 
__öô
 
	$pxt4_öô_po°_ªad_¥o˚ssög
()

427 
bio_po°_ªad_˘x_ˇche
 =

428 
	`kmem_ˇche_¸óã
("pxt4_bio_post_read_ctx",

429 (
bio_po°_ªad_˘x
), 0, 0, 
NULL
);

430 i‡(!
bio_po°_ªad_˘x_ˇche
)

431 
Áû
;

432 
bio_po°_ªad_˘x_poﬁ
 =

433 
	`mempoﬁ_¸óã_¶ab_poﬁ
(
NUM_PREALLOC_POST_READ_CTXS
,

434 
bio_po°_ªad_˘x_ˇche
);

435 i‡(!
bio_po°_ªad_˘x_poﬁ
)

436 
Áû_‰ì_ˇche
;

439 
Áû_‰ì_ˇche
:

440 
	`kmem_ˇche_de°roy
(
bio_po°_ªad_˘x_ˇche
);

441 
Áû
:

442  -
ENOMEM
;

443 
	}
}

445 
	$pxt4_exô_po°_ªad_¥o˚ssög
()

447 
	`mempoﬁ_de°roy
(
bio_po°_ªad_˘x_poﬁ
);

448 
	`kmem_ˇche_de°roy
(
bio_po°_ªad_˘x_ˇche
);

449 
	}
}

	@resize.c

13 
	#PXT4FS_DEBUG


	)

15 
	~<löux/î∫o.h
>

16 
	~<löux/¶ab.h
>

18 
	~"pxt4_jbd3.h
"

20 
	spxt4_rcu_±r
 {

21 
rcu_hód
 
	mrcu
;

22 *
	m±r
;

25 
	$pxt4_rcu_±r_ˇŒback
(
rcu_hód
 *
hód
)

27 
pxt4_rcu_±r
 *
±r
;

29 
±r
 = 
	`c⁄èöî_of
(
hód
, 
pxt4_rcu_±r
, 
rcu
);

30 
	`kv‰ì
(
±r
->ptr);

31 
	`k‰ì
(
±r
);

32 
	}
}

34 
	$pxt4_kv‰ì_¨øy_rcu
(*
to_‰ì
)

36 
pxt4_rcu_±r
 *
±r
 = 
	`kzÆloc
((*±r), 
GFP_KERNEL
);

38 i‡(
±r
) {

39 
±r
->±∏
to_‰ì
;

40 
	`ˇŒ_rcu
(&
±r
->
rcu
, 
pxt4_rcu_±r_ˇŒback
);

43 
	`synchr⁄ize_rcu
();

44 
	`kv‰ì
(
to_‰ì
);

45 
	}
}

47 
	$pxt4_ªsize_begö
(
su≥r_block
 *
sb
)

49 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
sb
);

50 
ªt
 = 0;

52 i‡(!
	`ˇ∑bÀ
(
CAP_SYS_RESOURCE
))

53  -
EPERM
;

60 i‡(
	`PXT4_B2C
(
sbi
, sbi->
s_sbh
->
b_blockƒ
) !=

61 
	`À32_to_˝u
(
	`PXT4_SB
(
sb
)->
s_es
->
s_fú°_d©a_block
)) {

62 
	`pxt4_w¨nög
(
sb
, "won'tÑesize using backup superblockát %llu",

63 ()
	`PXT4_SB
(
sb
)->
s_sbh
->
b_blockƒ
);

64  -
EPERM
;

71 i‡(
	`PXT4_SB
(
sb
)->
s_mou¡_°©e
 & 
PXT4_ERROR_FS
) {

72 
	`pxt4_w¨nög
(
sb
, "ThereáreÉrrors inÅhe filesystem, "

74  -
EPERM
;

77 i‡(
	`ã°_™d_£t_bô_lock
(
PXT4_FLAGS_RESIZING
,

78 &
	`PXT4_SB
(
sb
)->
s_pxt4_Êags
))

79 
ªt
 = -
EBUSY
;

81  
ªt
;

82 
	}
}

84 
	$pxt4_ªsize_íd
(
su≥r_block
 *
sb
)

86 
	`˛ór_bô_u∆ock
(
PXT4_FLAGS_RESIZING
, &
	`PXT4_SB
(
sb
)->
s_pxt4_Êags
);

87 
	`smp_mb__a·î_©omic
();

88 
	}
}

90 
pxt4_group_t
 
	$pxt4_mëa_bg_fú°_group
(
su≥r_block
 *
sb
,

91 
pxt4_group_t
 
group
) {

92  (
group
 >> 
	`PXT4_DESC_PER_BLOCK_BITS
(
sb
)) <<

93 
	`PXT4_DESC_PER_BLOCK_BITS
(
sb
);

94 
	}
}

96 
pxt4_fsblk_t
 
	$pxt4_mëa_bg_fú°_block_no
(
su≥r_block
 *
sb
,

97 
pxt4_group_t
 
group
) {

98 
group
 = 
	`pxt4_mëa_bg_fú°_group
(
sb
, group);

99  
	`pxt4_group_fú°_block_no
(
sb
, 
group
);

100 
	}
}

102 
pxt4_gΩblk_t
 
	$pxt4_group_ovîhód_blocks
(
su≥r_block
 *
sb
,

103 
pxt4_group_t
 
group
) {

104 
pxt4_gΩblk_t
 
ovîhód
;

105 
ovîhód
 = 
	`pxt4_bg_num_gdb
(
sb
, 
group
);

106 i‡(
	`pxt4_bg_has_su≥r
(
sb
, 
group
))

107 
ovîhód
 += 1 +

108 
	`À16_to_˝u
(
	`PXT4_SB
(
sb
)->
s_es
->
s_ª£rved_gdt_blocks
);

109  
ovîhód
;

110 
	}
}

112 
	#outside
(
b
, 
fú°
, 
œ°
Ë((bË< (fú°Ë|| (bË>÷a°))

	)

113 
	#öside
(
b
, 
fú°
, 
œ°
Ë((bË>(fú°Ë&& (bË< (œ°))

	)

115 
	$vîify_group_öput
(
su≥r_block
 *
sb
,

116 
pxt4_√w_group_d©a
 *
öput
)

118 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
sb
);

119 
pxt4_su≥r_block
 *
es
 = 
sbi
->
s_es
;

120 
pxt4_fsblk_t
 
°¨t
 = 
	`pxt4_blocks_cou¡
(
es
);

121 
pxt4_fsblk_t
 
íd
 = 
°¨t
 + 
öput
->
blocks_cou¡
;

122 
pxt4_group_t
 
group
 = 
öput
->group;

123 
pxt4_fsblk_t
 
ôíd
 = 
öput
->
öode_èbÀ
 + 
sbi
->
s_ôb_≥r_group
;

124 
ovîhód
;

125 
pxt4_fsblk_t
 
më´nd
;

126 
buf„r_hód
 *
bh
 = 
NULL
;

127 
pxt4_gΩblk_t
 
‰ì_blocks_cou¡
, 
off£t
;

128 
îr
 = -
EINVAL
;

130 i‡(
group
 !
sbi
->
s_groups_cou¡
) {

131 
	`pxt4_w¨nög
(
sb
, "Cannotáddát group %u (only %u groups)",

132 
öput
->
group
, 
sbi
->
s_groups_cou¡
);

133  -
EINVAL
;

136 
ovîhód
 = 
	`pxt4_group_ovîhód_blocks
(
sb
, 
group
);

137 
më´nd
 = 
°¨t
 + 
ovîhód
;

138 
öput
->
‰ì_˛u°îs_cou¡
 = 
‰ì_blocks_cou¡
 =

139 
öput
->
blocks_cou¡
 - 2 - 
ovîhód
 - 
sbi
->
s_ôb_≥r_group
;

141 i‡(
	`ã°_›t
(
sb
, 
DEBUG
))

142 
	`¥ötk
(
KERN_DEBUG
 "PXT4-fs:ádding %s group %u: %u blocks "

144 
	`pxt4_bg_has_su≥r
(
sb
, 
öput
->
group
) ? "normal" :

145 "no-su≥r", 
öput
->
group
, i≈ut->
blocks_cou¡
,

146 
‰ì_blocks_cou¡
, 
öput
->
ª£rved_blocks
);

148 
	`pxt4_gë_group_no_™d_off£t
(
sb
, 
°¨t
, 
NULL
, &
off£t
);

149 i‡(
off£t
 != 0)

150 
	`pxt4_w¨nög
(
sb
, "Last groupÇot full");

151 i‡(
öput
->
ª£rved_blocks
 > i≈ut->
blocks_cou¡
 / 5)

152 
	`pxt4_w¨nög
(
sb
, "Reserved blocksÅoo high (%u)",

153 
öput
->
ª£rved_blocks
);

154 i‡(
‰ì_blocks_cou¡
 < 0)

155 
	`pxt4_w¨nög
(
sb
, "Bad blocks count %u",

156 
öput
->
blocks_cou¡
);

157 i‡(
	`IS_ERR
(
bh
 = 
	`pxt4_sb_bªad
(
sb
, 
íd
 - 1, 0))) {

158 
îr
 = 
	`PTR_ERR
(
bh
);

159 
bh
 = 
NULL
;

160 
	`pxt4_w¨nög
(
sb
, "CannotÑeadÜast block (%llu)",

161 
íd
 - 1);

162 } i‡(
	`outside
(
öput
->
block_bôm≠
, 
°¨t
, 
íd
))

163 
	`pxt4_w¨nög
(
sb
, "Block bitmapÇot in group (block %llu)",

164 ()
öput
->
block_bôm≠
);

165 i‡(
	`outside
(
öput
->
öode_bôm≠
, 
°¨t
, 
íd
))

166 
	`pxt4_w¨nög
(
sb
, "Inode bitmapÇot in group (block %llu)",

167 ()
öput
->
öode_bôm≠
);

168 i‡(
	`outside
(
öput
->
öode_èbÀ
, 
°¨t
, 
íd
) ||

169 
	`outside
(
ôíd
 - 1, 
°¨t
, 
íd
))

170 
	`pxt4_w¨nög
(
sb
, "InodeÅableÇot in group (blocks %llu-%llu)",

171 ()
öput
->
öode_èbÀ
, 
ôíd
 - 1);

172 i‡(
öput
->
öode_bôm≠
 =öput->
block_bôm≠
)

173 
	`pxt4_w¨nög
(
sb
, "Block bitmap sameás inode bitmap (%llu)",

174 ()
öput
->
block_bôm≠
);

175 i‡(
	`öside
(
öput
->
block_bôm≠
, i≈ut->
öode_èbÀ
, 
ôíd
))

176 
	`pxt4_w¨nög
(
sb
, "Block bitmap (%llu) in inodeÅable "

178 ()
öput
->
block_bôm≠
,

179 ()
öput
->
öode_èbÀ
, 
ôíd
 - 1);

180 i‡(
	`öside
(
öput
->
öode_bôm≠
, i≈ut->
öode_èbÀ
, 
ôíd
))

181 
	`pxt4_w¨nög
(
sb
, "Inode bitmap (%llu) in inodeÅable "

183 ()
öput
->
öode_bôm≠
,

184 ()
öput
->
öode_èbÀ
, 
ôíd
 - 1);

185 i‡(
	`öside
(
öput
->
block_bôm≠
, 
°¨t
, 
më´nd
))

186 
	`pxt4_w¨nög
(
sb
, "Block bitmap (%llu) in GDTÅable (%llu-%llu)",

187 ()
öput
->
block_bôm≠
,

188 
°¨t
, 
më´nd
 - 1);

189 i‡(
	`öside
(
öput
->
öode_bôm≠
, 
°¨t
, 
më´nd
))

190 
	`pxt4_w¨nög
(
sb
, "Inode bitmap (%llu) in GDTÅable (%llu-%llu)",

191 ()
öput
->
öode_bôm≠
,

192 
°¨t
, 
më´nd
 - 1);

193 i‡(
	`öside
(
öput
->
öode_èbÀ
, 
°¨t
, 
më´nd
) ||

194 
	`öside
(
ôíd
 - 1, 
°¨t
, 
më´nd
))

195 
	`pxt4_w¨nög
(
sb
, "InodeÅable (%llu-%llu) overlaps GDTÅable "

197 ()
öput
->
öode_èbÀ
,

198 
ôíd
 - 1, 
°¨t
, 
më´nd
 - 1);

200 
îr
 = 0;

201 
	`bªl£
(
bh
);

203  
îr
;

204 
	}
}

210 
	spxt4_√w_Êex_group_d©a
 {

211 
pxt4_√w_group_d©a
 *
	mgroups
;

213 
__u16
 *
	mbg_Êags
;

215 
pxt4_group_t
 
	mcou¡
;

225 
pxt4_√w_Êex_group_d©a
 *
	$Æloc_Êex_gd
(
Êexbg_size
)

227 
pxt4_√w_Êex_group_d©a
 *
Êex_gd
;

229 
Êex_gd
 = 
	`kmÆloc
((*Êex_gd), 
GFP_NOFS
);

230 i‡(
Êex_gd
 =
NULL
)

231 
out3
;

233 i‡(
Êexbg_size
 >
UINT_MAX
 / (
pxt4_√w_group_d©a
))

234 
out2
;

235 
Êex_gd
->
cou¡
 = 
Êexbg_size
;

237 
Êex_gd
->
groups
 = 
	`kmÆloc_¨øy
(
Êexbg_size
,

238 (
pxt4_√w_group_d©a
),

239 
GFP_NOFS
);

240 i‡(
Êex_gd
->
groups
 =
NULL
)

241 
out2
;

243 
Êex_gd
->
bg_Êags
 = 
	`kmÆloc_¨øy
(
Êexbg_size
, (
__u16
),

244 
GFP_NOFS
);

245 i‡(
Êex_gd
->
bg_Êags
 =
NULL
)

246 
out1
;

248  
Êex_gd
;

250 
out1
:

251 
	`k‰ì
(
Êex_gd
->
groups
);

252 
out2
:

253 
	`k‰ì
(
Êex_gd
);

254 
out3
:

255  
NULL
;

256 
	}
}

258 
	$‰ì_Êex_gd
(
pxt4_√w_Êex_group_d©a
 *
Êex_gd
)

260 
	`k‰ì
(
Êex_gd
->
bg_Êags
);

261 
	`k‰ì
(
Êex_gd
->
groups
);

262 
	`k‰ì
(
Êex_gd
);

263 
	}
}

278 
	$pxt4_Æloc_group_èbÀs
(
su≥r_block
 *
sb
,

279 
pxt4_√w_Êex_group_d©a
 *
Êex_gd
,

280 
Êexbg_size
)

282 
pxt4_√w_group_d©a
 *
group_d©a
 = 
Êex_gd
->
groups
;

283 
pxt4_fsblk_t
 
°¨t_blk
;

284 
pxt4_fsblk_t
 
œ°_blk
;

285 
pxt4_group_t
 
§c_group
;

286 
pxt4_group_t
 
bb_ödex
 = 0;

287 
pxt4_group_t
 
ib_ödex
 = 0;

288 
pxt4_group_t
 
ô_ödex
 = 0;

289 
pxt4_group_t
 
group
;

290 
pxt4_group_t
 
œ°_group
;

291 
ovîhód
;

292 
__u16
 
unöô_mask
 = (
Êexbg_size
 > 1Ë? ~
PXT4_BG_BLOCK_UNINIT
 : ~0;

293 
i
;

295 
	`BUG_ON
(
Êex_gd
->
cou¡
 =0 || 
group_d©a
 =
NULL
);

297 
§c_group
 = 
group_d©a
[0].
group
;

298 
œ°_group
 = 
§c_group
 + 
Êex_gd
->
cou¡
 - 1;

300 
	`BUG_ON
((
Êexbg_size
 > 1Ë&& ((
§c_group
 & ~(flexbg_size - 1)) !=

301 (
œ°_group
 & ~(
Êexbg_size
 - 1))));

302 
√xt_group
:

303 
group
 = 
group_d©a
[0].group;

304 i‡(
§c_group
 >
group_d©a
[0].
group
 + 
Êex_gd
->
cou¡
)

305  -
ENOSPC
;

306 
°¨t_blk
 = 
	`pxt4_group_fú°_block_no
(
sb
, 
§c_group
);

307 
œ°_blk
 = 
°¨t_blk
 + 
group_d©a
[
§c_group
 - 
group
].
blocks_cou¡
;

309 
ovîhód
 = 
	`pxt4_group_ovîhód_blocks
(
sb
, 
§c_group
);

311 
°¨t_blk
 +
ovîhód
;

314 
§c_group
++;

315 ; 
§c_group
 <
œ°_group
; src_group++) {

316 
ovîhód
 = 
	`pxt4_group_ovîhód_blocks
(
sb
, 
§c_group
);

317 i‡(
ovîhód
 == 0)

318 
œ°_blk
 +
group_d©a
[
§c_group
 - 
group
].
blocks_cou¡
;

324 ; 
bb_ödex
 < 
Êex_gd
->
cou¡
; bb_index++) {

325 i‡(
°¨t_blk
 >
œ°_blk
)

326 
√xt_group
;

327 
group_d©a
[
bb_ödex
].
block_bôm≠
 = 
°¨t_blk
++;

328 
group
 = 
	`pxt4_gë_group_numbî
(
sb
, 
°¨t_blk
 - 1);

329 
group
 -
group_d©a
[0].group;

330 
group_d©a
[
group
].
md©a_blocks
++;

331 
Êex_gd
->
bg_Êags
[
group
] &
unöô_mask
;

335 ; 
ib_ödex
 < 
Êex_gd
->
cou¡
; ib_index++) {

336 i‡(
°¨t_blk
 >
œ°_blk
)

337 
√xt_group
;

338 
group_d©a
[
ib_ödex
].
öode_bôm≠
 = 
°¨t_blk
++;

339 
group
 = 
	`pxt4_gë_group_numbî
(
sb
, 
°¨t_blk
 - 1);

340 
group
 -
group_d©a
[0].group;

341 
group_d©a
[
group
].
md©a_blocks
++;

342 
Êex_gd
->
bg_Êags
[
group
] &
unöô_mask
;

346 ; 
ô_ödex
 < 
Êex_gd
->
cou¡
; it_index++) {

347 
ôb
 = 
	`PXT4_SB
(
sb
)->
s_ôb_≥r_group
;

348 
pxt4_fsblk_t
 
√xt_group_°¨t
;

350 i‡(
°¨t_blk
 + 
ôb
 > 
œ°_blk
)

351 
√xt_group
;

352 
group_d©a
[
ô_ödex
].
öode_èbÀ
 = 
°¨t_blk
;

353 
group
 = 
	`pxt4_gë_group_numbî
(
sb
, 
°¨t_blk
);

354 
√xt_group_°¨t
 = 
	`pxt4_group_fú°_block_no
(
sb
, 
group
 + 1);

355 
group
 -
group_d©a
[0].group;

357 i‡(
°¨t_blk
 + 
ôb
 > 
√xt_group_°¨t
) {

358 
Êex_gd
->
bg_Êags
[
group
 + 1] &
unöô_mask
;

359 
ovîhód
 = 
°¨t_blk
 + 
ôb
 - 
√xt_group_°¨t
;

360 
group_d©a
[
group
 + 1].
md©a_blocks
 +
ovîhód
;

361 
ôb
 -
ovîhód
;

364 
group_d©a
[
group
].
md©a_blocks
 +
ôb
;

365 
Êex_gd
->
bg_Êags
[
group
] &
unöô_mask
;

366 
°¨t_blk
 +
	`PXT4_SB
(
sb
)->
s_ôb_≥r_group
;

370 
i
 = 0; i < 
Êex_gd
->
cou¡
; i++) {

371 
group_d©a
[
i
].
‰ì_˛u°îs_cou¡
 -=

372 
	`PXT4_NUM_B2C
(
	`PXT4_SB
(
sb
),

373 
group_d©a
[
i
].
md©a_blocks
);

376 i‡(
	`ã°_›t
(
sb
, 
DEBUG
)) {

377 
i
;

378 
group
 = 
group_d©a
[0].group;

380 
	`¥ötk
(
KERN_DEBUG
 "PXT4-fs:áddingá flex group with "

381 "%d groups, fÀxbg sizêi†%d:\n", 
Êex_gd
->
cou¡
,

382 
Êexbg_size
);

384 
i
 = 0; i < 
Êex_gd
->
cou¡
; i++) {

385 
	`pxt4_debug
(

387 
	`pxt4_bg_has_su≥r
(
sb
, 
group
 + 
i
) ? "normal" :

388 "no-su≥r", 
group
 + 
i
,

389 
group_d©a
[
i
].
blocks_cou¡
,

390 
group_d©a
[
i
].
‰ì_˛u°îs_cou¡
,

391 
group_d©a
[
i
].
md©a_blocks
);

395 
	}
}

397 
buf„r_hód
 *
	$b˛ón
(
h™dÀ_t
 *
h™dÀ
, 
su≥r_block
 *
sb
,

398 
pxt4_fsblk_t
 
blk
)

400 
buf„r_hód
 *
bh
;

401 
îr
;

403 
bh
 = 
	`sb_gëblk
(
sb
, 
blk
);

404 i‡(
	`u∆ikñy
(!
bh
))

405  
	`ERR_PTR
(-
ENOMEM
);

406 
	`BUFFER_TRACE
(
bh
, "get_write_access");

407 i‡((
îr
 = 
	`pxt4_jou∫Æ_gë_wrôe_ac˚ss
(
h™dÀ
, 
bh
))) {

408 
	`bªl£
(
bh
);

409 
bh
 = 
	`ERR_PTR
(
îr
);

411 
	`mem£t
(
bh
->
b_d©a
, 0, 
sb
->
s_blocksize
);

412 
	`£t_buf„r_u±od©e
(
bh
);

415  
bh
;

416 
	}
}

423 
	$exãnd_‹_ª°¨t_å™ß˘i⁄
(
h™dÀ_t
 *
h™dÀ
, 
thªsh
)

425 
îr
;

427 i‡(
	`pxt4_h™dÀ_has_íough_¸edôs
(
h™dÀ
, 
thªsh
))

430 
îr
 = 
	`pxt4_jou∫Æ_exãnd
(
h™dÀ
, 
PXT4_MAX_TRANS_DATA
);

431 i‡(
îr
 < 0)

432  
îr
;

433 i‡(
îr
) {

434 
îr
 = 
	`pxt4_jou∫Æ_ª°¨t
(
h™dÀ
, 
PXT4_MAX_TRANS_DATA
);

435 i‡(
îr
)

436  
îr
;

440 
	}
}

451 
	$£t_Êexbg_block_bôm≠
(
su≥r_block
 *
sb
, 
h™dÀ_t
 *
h™dÀ
,

452 
pxt4_√w_Êex_group_d©a
 *
Êex_gd
,

453 
pxt4_fsblk_t
 
fú°_˛u°î
,Öxt4_fsblk_à
œ°_˛u°î
)

455 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
sb
);

456 
pxt4_group_t
 
cou¡
 = 
œ°_˛u°î
 - 
fú°_˛u°î
 + 1;

457 
pxt4_group_t
 
cou¡2
;

459 
	`pxt4_debug
("m¨k clu°î†[%Œu-%Œu] u£d\n", 
fú°_˛u°î
,

460 
œ°_˛u°î
);

461 
cou¡2
 = 
cou¡
; count > 0;

462 
cou¡
 -
cou¡2
, 
fú°_˛u°î
 += count2) {

463 
pxt4_fsblk_t
 
°¨t
;

464 
buf„r_hód
 *
bh
;

465 
pxt4_group_t
 
group
;

466 
îr
;

468 
group
 = 
	`pxt4_gë_group_numbî
(
sb
, 
	`PXT4_C2B
(
sbi
, 
fú°_˛u°î
));

469 
°¨t
 = 
	`PXT4_B2C
(
sbi
, 
	`pxt4_group_fú°_block_no
(
sb
, 
group
));

470 
group
 -
Êex_gd
->
groups
[0].group;

472 
cou¡2
 = 
	`PXT4_CLUSTERS_PER_GROUP
(
sb
Ë- (
fú°_˛u°î
 - 
°¨t
);

473 i‡(
cou¡2
 > 
cou¡
)

474 
cou¡2
 = 
cou¡
;

476 i‡(
Êex_gd
->
bg_Êags
[
group
] & 
PXT4_BG_BLOCK_UNINIT
) {

477 
	`BUG_ON
(
Êex_gd
->
cou¡
 > 1);

481 
îr
 = 
	`exãnd_‹_ª°¨t_å™ß˘i⁄
(
h™dÀ
, 1);

482 i‡(
îr
)

483  
îr
;

485 
bh
 = 
	`sb_gëblk
(
sb
, 
Êex_gd
->
groups
[
group
].
block_bôm≠
);

486 i‡(
	`u∆ikñy
(!
bh
))

487  -
ENOMEM
;

489 
	`BUFFER_TRACE
(
bh
, "get_write_access");

490 
îr
 = 
	`pxt4_jou∫Æ_gë_wrôe_ac˚ss
(
h™dÀ
, 
bh
);

491 i‡(
îr
) {

492 
	`bªl£
(
bh
);

493  
îr
;

495 
	`pxt4_debug
("mark block bitmap %#04llx (+%llu/%u)\n",

496 
fú°_˛u°î
, fú°_˛u°î - 
°¨t
, 
cou¡2
);

497 
	`pxt4_£t_bôs
(
bh
->
b_d©a
, 
fú°_˛u°î
 - 
°¨t
, 
cou¡2
);

499 
îr
 = 
	`pxt4_h™dÀ_dúty_mëad©a
(
h™dÀ
, 
NULL
, 
bh
);

500 
	`bªl£
(
bh
);

501 i‡(
	`u∆ikñy
(
îr
))

502  
îr
;

506 
	}
}

522 
	$£tup_√w_Êex_group_blocks
(
su≥r_block
 *
sb
,

523 
pxt4_√w_Êex_group_d©a
 *
Êex_gd
)

525 
group_èbÀ_cou¡
[] = {1, 1, 
	`PXT4_SB
(
sb
)->
s_ôb_≥r_group
};

526 
pxt4_fsblk_t
 
°¨t
;

527 
pxt4_fsblk_t
 
block
;

528 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
sb
);

529 
pxt4_su≥r_block
 *
es
 = 
sbi
->
s_es
;

530 
pxt4_√w_group_d©a
 *
group_d©a
 = 
Êex_gd
->
groups
;

531 
__u16
 *
bg_Êags
 = 
Êex_gd
->bg_flags;

532 
h™dÀ_t
 *
h™dÀ
;

533 
pxt4_group_t
 
group
, 
cou¡
;

534 
buf„r_hód
 *
bh
 = 
NULL
;

535 
ª£rved_gdb
, 
i
, 
j
, 
îr
 = 0, 
îr2
;

536 
mëa_bg
;

538 
	`BUG_ON
(!
Êex_gd
->
cou¡
 || !
group_d©a
 ||

539 
group_d©a
[0].
group
 !
sbi
->
s_groups_cou¡
);

541 
ª£rved_gdb
 = 
	`À16_to_˝u
(
es
->
s_ª£rved_gdt_blocks
);

542 
mëa_bg
 = 
	`pxt4_has_„©uª_mëa_bg
(
sb
);

545 
h™dÀ
 = 
	`pxt4_jou∫Æ_°¨t_sb
(
sb
, 
PXT4_HT_RESIZE
, 
PXT4_MAX_TRANS_DATA
);

546 i‡(
	`IS_ERR
(
h™dÀ
))

547  
	`PTR_ERR
(
h™dÀ
);

549 
group
 = 
group_d©a
[0].group;

550 
i
 = 0; i < 
Êex_gd
->
cou¡
; i++, 
group
++) {

551 
gdblocks
;

552 
pxt4_gΩblk_t
 
ovîhód
;

554 
gdblocks
 = 
	`pxt4_bg_num_gdb
(
sb
, 
group
);

555 
°¨t
 = 
	`pxt4_group_fú°_block_no
(
sb
, 
group
);

557 i‡(
mëa_bg
 =0 && !
	`pxt4_bg_has_su≥r
(
sb
, 
group
))

558 
h™dÀ_ôb
;

560 i‡(
mëa_bg
 == 1) {

561 
pxt4_group_t
 
fú°_group
;

562 
fú°_group
 = 
	`pxt4_mëa_bg_fú°_group
(
sb
, 
group
);

563 i‡(
fú°_group
 !
group
 + 1 &&

564 
fú°_group
 !
group
 + 
	`PXT4_DESC_PER_BLOCK
(
sb
) - 1)

565 
h™dÀ_ôb
;

568 
block
 = 
°¨t
 + 
	`pxt4_bg_has_su≥r
(
sb
, 
group
);

570 
j
 = 0; j < 
gdblocks
; j++, 
block
++) {

571 
buf„r_hód
 *
gdb
;

573 
	`pxt4_debug
("upd©êbacku∞grou∞%#04Œx\n", 
block
);

574 
îr
 = 
	`exãnd_‹_ª°¨t_å™ß˘i⁄
(
h™dÀ
, 1);

575 i‡(
îr
)

576 
out
;

578 
gdb
 = 
	`sb_gëblk
(
sb
, 
block
);

579 i‡(
	`u∆ikñy
(!
gdb
)) {

580 
îr
 = -
ENOMEM
;

581 
out
;

584 
	`BUFFER_TRACE
(
gdb
, "get_write_access");

585 
îr
 = 
	`pxt4_jou∫Æ_gë_wrôe_ac˚ss
(
h™dÀ
, 
gdb
);

586 i‡(
îr
) {

587 
	`bªl£
(
gdb
);

588 
out
;

590 
	`mem˝y
(
gdb
->
b_d©a
, 
	`sbi_¨øy_rcu_dîef
(
sbi
,

591 
s_group_desc
, 
j
)->
b_d©a
, 
gdb
->
b_size
);

592 
	`£t_buf„r_u±od©e
(
gdb
);

594 
îr
 = 
	`pxt4_h™dÀ_dúty_mëad©a
(
h™dÀ
, 
NULL
, 
gdb
);

595 i‡(
	`u∆ikñy
(
îr
)) {

596 
	`bªl£
(
gdb
);

597 
out
;

599 
	`bªl£
(
gdb
);

605 i‡(
	`pxt4_bg_has_su≥r
(
sb
, 
group
)) {

606 
îr
 = 
	`sb_issue_zîoout
(
sb
, 
gdblocks
 + 
°¨t
 + 1,

607 
ª£rved_gdb
, 
GFP_NOFS
);

608 i‡(
îr
)

609 
out
;

612 
h™dÀ_ôb
:

614 i‡(!(
bg_Êags
[
i
] & 
PXT4_BG_INODE_ZEROED
))

615 
h™dÀ_bb
;

618 
block
 = 
group_d©a
[
i
].
öode_èbÀ
;

619 
	`pxt4_debug
("clear inodeÅable blocks %#04llx -> %#04lx\n",

620 
block
, 
sbi
->
s_ôb_≥r_group
);

621 
îr
 = 
	`sb_issue_zîoout
(
sb
, 
block
, 
sbi
->
s_ôb_≥r_group
,

622 
GFP_NOFS
);

623 i‡(
îr
)

624 
out
;

626 
h™dÀ_bb
:

627 i‡(
bg_Êags
[
i
] & 
PXT4_BG_BLOCK_UNINIT
)

628 
h™dÀ_ib
;

631 
block
 = 
group_d©a
[
i
].
block_bôm≠
;

632 
îr
 = 
	`exãnd_‹_ª°¨t_å™ß˘i⁄
(
h™dÀ
, 1);

633 i‡(
îr
)

634 
out
;

636 
bh
 = 
	`b˛ón
(
h™dÀ
, 
sb
, 
block
);

637 i‡(
	`IS_ERR
(
bh
)) {

638 
îr
 = 
	`PTR_ERR
(
bh
);

639 
out
;

641 
ovîhód
 = 
	`pxt4_group_ovîhód_blocks
(
sb
, 
group
);

642 i‡(
ovîhód
 != 0) {

643 
	`pxt4_debug
("mark backup superblock %#04llx (+0)\n",

644 
°¨t
);

645 
	`pxt4_£t_bôs
(
bh
->
b_d©a
, 0,

646 
	`PXT4_NUM_B2C
(
sbi
, 
ovîhód
));

648 
	`pxt4_m¨k_bôm≠_íd
(
	`PXT4_B2C
(
sbi
, 
group_d©a
[
i
].
blocks_cou¡
),

649 
sb
->
s_blocksize
 * 8, 
bh
->
b_d©a
);

650 
îr
 = 
	`pxt4_h™dÀ_dúty_mëad©a
(
h™dÀ
, 
NULL
, 
bh
);

651 
	`bªl£
(
bh
);

652 i‡(
îr
)

653 
out
;

655 
h™dÀ_ib
:

656 i‡(
bg_Êags
[
i
] & 
PXT4_BG_INODE_UNINIT
)

660 
block
 = 
group_d©a
[
i
].
öode_bôm≠
;

661 
îr
 = 
	`exãnd_‹_ª°¨t_å™ß˘i⁄
(
h™dÀ
, 1);

662 i‡(
îr
)

663 
out
;

665 
bh
 = 
	`b˛ón
(
h™dÀ
, 
sb
, 
block
);

666 i‡(
	`IS_ERR
(
bh
)) {

667 
îr
 = 
	`PTR_ERR
(
bh
);

668 
out
;

671 
	`pxt4_m¨k_bôm≠_íd
(
	`PXT4_INODES_PER_GROUP
(
sb
),

672 
sb
->
s_blocksize
 * 8, 
bh
->
b_d©a
);

673 
îr
 = 
	`pxt4_h™dÀ_dúty_mëad©a
(
h™dÀ
, 
NULL
, 
bh
);

674 
	`bªl£
(
bh
);

675 i‡(
îr
)

676 
out
;

680 
j
 = 0; j < 
GROUP_TABLE_COUNT
; j++) {

681 
cou¡
 = 
group_èbÀ_cou¡
[
j
];

682 
°¨t
 = (&
group_d©a
[0].
block_bôm≠
)[
j
];

683 
block
 = 
°¨t
;

684 
i
 = 1; i < 
Êex_gd
->
cou¡
; i++) {

685 
block
 +
group_èbÀ_cou¡
[
j
];

686 i‡(
block
 =(&
group_d©a
[
i
].
block_bôm≠
)[
j
]) {

687 
cou¡
 +
group_èbÀ_cou¡
[
j
];

690 
îr
 = 
	`£t_Êexbg_block_bôm≠
(
sb
, 
h™dÀ
,

691 
Êex_gd
,

692 
	`PXT4_B2C
(
sbi
, 
°¨t
),

693 
	`PXT4_B2C
(
sbi
,

694 
°¨t
 + 
cou¡


696 i‡(
îr
)

697 
out
;

698 
cou¡
 = 
group_èbÀ_cou¡
[
j
];

699 
°¨t
 = (&
group_d©a
[
i
].
block_bôm≠
)[
j
];

700 
block
 = 
°¨t
;

703 i‡(
cou¡
) {

704 
îr
 = 
	`£t_Êexbg_block_bôm≠
(
sb
, 
h™dÀ
,

705 
Êex_gd
,

706 
	`PXT4_B2C
(
sbi
, 
°¨t
),

707 
	`PXT4_B2C
(
sbi
,

708 
°¨t
 + 
cou¡


710 i‡(
îr
)

711 
out
;

715 
out
:

716 
îr2
 = 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

717 i‡(
îr2
 && !
îr
)

718 
îr
 = 
îr2
;

720  
îr
;

721 
	}
}

730 
	$pxt4_li°_backups
(
su≥r_block
 *
sb
, *
thªe
,

731 *
five
, *
£ví
)

733 *
mö
 = 
thªe
;

734 
mu…
 = 3;

735 
ªt
;

737 i‡(!
	`pxt4_has_„©uª_•¨£_su≥r
(
sb
)) {

738 
ªt
 = *
mö
;

739 *
mö
 += 1;

740  
ªt
;

743 i‡(*
five
 < *
mö
) {

744 
mö
 = 
five
;

745 
mu…
 = 5;

747 i‡(*
£ví
 < *
mö
) {

748 
mö
 = 
£ví
;

749 
mu…
 = 7;

752 
ªt
 = *
mö
;

753 *
mö
 *
mu…
;

755  
ªt
;

756 
	}
}

763 
	$vîify_ª£rved_gdb
(
su≥r_block
 *
sb
,

764 
pxt4_group_t
 
íd
,

765 
buf„r_hód
 *
¥im¨y
)

767 c⁄° 
pxt4_fsblk_t
 
blk
 = 
¥im¨y
->
b_blockƒ
;

768 
thªe
 = 1;

769 
five
 = 5;

770 
£ví
 = 7;

771 
gΩ
;

772 
__À32
 *
p
 = (__À32 *)
¥im¨y
->
b_d©a
;

773 
gdbackups
 = 0;

775 (
gΩ
 = 
	`pxt4_li°_backups
(
sb
, &
thªe
, &
five
, &
£ví
)Ë< 
íd
) {

776 i‡(
	`À32_to_˝u
(*
p
++) !=

777 
gΩ
 * 
	`PXT4_BLOCKS_PER_GROUP
(
sb
Ë+ 
blk
){

778 
	`pxt4_w¨nög
(
sb
, "reserved GDT %llu"

780 
blk
, 
gΩ
,

781 
gΩ
 *

782 (
pxt4_fsblk_t
)
	`PXT4_BLOCKS_PER_GROUP
(
sb
) +

783 
blk
);

784  -
EINVAL
;

786 i‡(++
gdbackups
 > 
	`PXT4_ADDR_PER_BLOCK
(
sb
))

787  -
EFBIG
;

790  
gdbackups
;

791 
	}
}

806 
	$add_√w_gdb
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *inode,

807 
pxt4_group_t
 
group
)

809 
su≥r_block
 *
sb
 = 
öode
->
i_sb
;

810 
pxt4_su≥r_block
 *
es
 = 
	`PXT4_SB
(
sb
)->
s_es
;

811 
gdb_num
 = 
group
 / 
	`PXT4_DESC_PER_BLOCK
(
sb
);

812 
pxt4_fsblk_t
 
gdblock
 = 
	`PXT4_SB
(
sb
)->
s_sbh
->
b_blockƒ
 + 1 + 
gdb_num
;

813 
buf„r_hód
 **
o_group_desc
, **
n_group_desc
 = 
NULL
;

814 
buf„r_hód
 *
död
 = 
NULL
;

815 
buf„r_hód
 *
gdb_bh
 = 
NULL
;

816 
gdbackups
;

817 
pxt4_ûoc
 
ûoc
 = { .
bh
 = 
NULL
 };

818 
__À32
 *
d©a
;

819 
îr
;

821 i‡(
	`ã°_›t
(
sb
, 
DEBUG
))

822 
	`¥ötk
(
KERN_DEBUG


824 
gdb_num
);

826 
gdb_bh
 = 
	`pxt4_sb_bªad
(
sb
, 
gdblock
, 0);

827 i‡(
	`IS_ERR
(
gdb_bh
))

828  
	`PTR_ERR
(
gdb_bh
);

830 
gdbackups
 = 
	`vîify_ª£rved_gdb
(
sb
, 
group
, 
gdb_bh
);

831 i‡(
gdbackups
 < 0) {

832 
îr
 = 
gdbackups
;

833 
îrout
;

836 
d©a
 = 
	`PXT4_I
(
öode
)->
i_d©a
 + 
PXT4_DIND_BLOCK
;

837 
död
 = 
	`pxt4_sb_bªad
(
sb
, 
	`À32_to_˝u
(*
d©a
), 0);

838 i‡(
	`IS_ERR
(
död
)) {

839 
îr
 = 
	`PTR_ERR
(
död
);

840 
död
 = 
NULL
;

841 
îrout
;

844 
d©a
 = (
__À32
 *)
död
->
b_d©a
;

845 i‡(
	`À32_to_˝u
(
d©a
[
gdb_num
 % 
	`PXT4_ADDR_PER_BLOCK
(
sb
)]Ë!
gdblock
) {

846 
	`pxt4_w¨nög
(
sb
, "new group %u GDT block %lluÇotÑeserved",

847 
group
, 
gdblock
);

848 
îr
 = -
EINVAL
;

849 
îrout
;

852 
	`BUFFER_TRACE
(
	`PXT4_SB
(
sb
)->
s_sbh
, "get_write_access");

853 
îr
 = 
	`pxt4_jou∫Æ_gë_wrôe_ac˚ss
(
h™dÀ
, 
	`PXT4_SB
(
sb
)->
s_sbh
);

854 i‡(
	`u∆ikñy
(
îr
))

855 
îrout
;

857 
	`BUFFER_TRACE
(
gdb_bh
, "get_write_access");

858 
îr
 = 
	`pxt4_jou∫Æ_gë_wrôe_ac˚ss
(
h™dÀ
, 
gdb_bh
);

859 i‡(
	`u∆ikñy
(
îr
))

860 
îrout
;

862 
	`BUFFER_TRACE
(
död
, "get_write_access");

863 
îr
 = 
	`pxt4_jou∫Æ_gë_wrôe_ac˚ss
(
h™dÀ
, 
död
);

864 i‡(
	`u∆ikñy
(
îr
)) {

865 
	`pxt4_°d_îr‹
(
sb
, 
îr
);

866 
îrout
;

870 
îr
 = 
	`pxt4_ª£rve_öode_wrôe
(
h™dÀ
, 
öode
, &
ûoc
);

871 i‡(
	`u∆ikñy
(
îr
))

872 
îrout
;

874 
n_group_desc
 = 
	`pxt4_kvmÆloc
((
gdb_num
 + 1) *

875 (
buf„r_hód
 *),

876 
GFP_NOFS
);

877 i‡(!
n_group_desc
) {

878 
îr
 = -
ENOMEM
;

879 
	`pxt4_w¨nög
(
sb
, "notÉnough memory for %lu groups",

880 
gdb_num
 + 1);

881 
îrout
;

893 
d©a
[
gdb_num
 % 
	`PXT4_ADDR_PER_BLOCK
(
sb
)] = 0;

894 
îr
 = 
	`pxt4_h™dÀ_dúty_mëad©a
(
h™dÀ
, 
NULL
, 
död
);

895 i‡(
	`u∆ikñy
(
îr
)) {

896 
	`pxt4_°d_îr‹
(
sb
, 
îr
);

897 
îrout
;

899 
öode
->
i_blocks
 -(
gdbackups
 + 1Ë* 
sb
->
s_blocksize
 >>

900 (9 - 
	`PXT4_SB
(
sb
)->
s_˛u°î_bôs
);

901 
	`pxt4_m¨k_ûoc_dúty
(
h™dÀ
, 
öode
, &
ûoc
);

902 
	`mem£t
(
gdb_bh
->
b_d©a
, 0, 
sb
->
s_blocksize
);

903 
îr
 = 
	`pxt4_h™dÀ_dúty_mëad©a
(
h™dÀ
, 
NULL
, 
gdb_bh
);

904 i‡(
	`u∆ikñy
(
îr
)) {

905 
	`pxt4_°d_îr‹
(
sb
, 
îr
);

906 
ûoc
.
bh
 = 
NULL
;

907 
îrout
;

909 
	`bªl£
(
död
);

911 
	`rcu_ªad_lock
();

912 
o_group_desc
 = 
	`rcu_dîe„ªn˚
(
	`PXT4_SB
(
sb
)->
s_group_desc
);

913 
	`mem˝y
(
n_group_desc
, 
o_group_desc
,

914 
	`PXT4_SB
(
sb
)->
s_gdb_cou¡
 * (
buf„r_hód
 *));

915 
	`rcu_ªad_u∆ock
();

916 
n_group_desc
[
gdb_num
] = 
gdb_bh
;

917 
	`rcu_assign_poöãr
(
	`PXT4_SB
(
sb
)->
s_group_desc
, 
n_group_desc
);

918 
	`PXT4_SB
(
sb
)->
s_gdb_cou¡
++;

919 
	`pxt4_kv‰ì_¨øy_rcu
(
o_group_desc
);

921 
	`À16_add_˝u
(&
es
->
s_ª£rved_gdt_blocks
, -1);

922 
îr
 = 
	`pxt4_h™dÀ_dúty_su≥r
(
h™dÀ
, 
sb
);

923 i‡(
îr
)

924 
	`pxt4_°d_îr‹
(
sb
, 
îr
);

925  
îr
;

926 
îrout
:

927 
	`kv‰ì
(
n_group_desc
);

928 
	`bªl£
(
ûoc
.
bh
);

929 
	`bªl£
(
död
);

930 
	`bªl£
(
gdb_bh
);

932 
	`pxt4_debug
("Àavög wôhÉº‹ %d\n", 
îr
);

933  
îr
;

934 
	}
}

939 
	$add_√w_gdb_mëa_bg
(
su≥r_block
 *
sb
,

940 
h™dÀ_t
 *
h™dÀ
, 
pxt4_group_t
 
group
) {

941 
pxt4_fsblk_t
 
gdblock
;

942 
buf„r_hód
 *
gdb_bh
;

943 
buf„r_hód
 **
o_group_desc
, **
n_group_desc
;

944 
gdb_num
 = 
group
 / 
	`PXT4_DESC_PER_BLOCK
(
sb
);

945 
îr
;

947 
gdblock
 = 
	`pxt4_mëa_bg_fú°_block_no
(
sb
, 
group
) +

948 
	`pxt4_bg_has_su≥r
(
sb
, 
group
);

949 
gdb_bh
 = 
	`pxt4_sb_bªad
(
sb
, 
gdblock
, 0);

950 i‡(
	`IS_ERR
(
gdb_bh
))

951  
	`PTR_ERR
(
gdb_bh
);

952 
n_group_desc
 = 
	`pxt4_kvmÆloc
((
gdb_num
 + 1) *

953 (
buf„r_hód
 *),

954 
GFP_NOFS
);

955 i‡(!
n_group_desc
) {

956 
	`bªl£
(
gdb_bh
);

957 
îr
 = -
ENOMEM
;

958 
	`pxt4_w¨nög
(
sb
, "notÉnough memory for %lu groups",

959 
gdb_num
 + 1);

960  
îr
;

963 
	`rcu_ªad_lock
();

964 
o_group_desc
 = 
	`rcu_dîe„ªn˚
(
	`PXT4_SB
(
sb
)->
s_group_desc
);

965 
	`mem˝y
(
n_group_desc
, 
o_group_desc
,

966 
	`PXT4_SB
(
sb
)->
s_gdb_cou¡
 * (
buf„r_hód
 *));

967 
	`rcu_ªad_u∆ock
();

968 
n_group_desc
[
gdb_num
] = 
gdb_bh
;

970 
	`BUFFER_TRACE
(
gdb_bh
, "get_write_access");

971 
îr
 = 
	`pxt4_jou∫Æ_gë_wrôe_ac˚ss
(
h™dÀ
, 
gdb_bh
);

972 i‡(
îr
) {

973 
	`kv‰ì
(
n_group_desc
);

974 
	`bªl£
(
gdb_bh
);

975  
îr
;

978 
	`rcu_assign_poöãr
(
	`PXT4_SB
(
sb
)->
s_group_desc
, 
n_group_desc
);

979 
	`PXT4_SB
(
sb
)->
s_gdb_cou¡
++;

980 
	`pxt4_kv‰ì_¨øy_rcu
(
o_group_desc
);

981  
îr
;

982 
	}
}

997 
	$ª£rve_backup_gdb
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *inode,

998 
pxt4_group_t
 
group
)

1000 
su≥r_block
 *
sb
 = 
öode
->
i_sb
;

1001 
ª£rved_gdb
 =
	`À16_to_˝u
(
	`PXT4_SB
(
sb
)->
s_es
->
s_ª£rved_gdt_blocks
);

1002 
˛u°î_bôs
 = 
	`PXT4_SB
(
sb
)->
s_˛u°î_bôs
;

1003 
buf„r_hód
 **
¥im¨y
;

1004 
buf„r_hód
 *
död
;

1005 
pxt4_ûoc
 
ûoc
;

1006 
pxt4_fsblk_t
 
blk
;

1007 
__À32
 *
d©a
, *
íd
;

1008 
gdbackups
 = 0;

1009 
ªs
, 
i
;

1010 
îr
;

1012 
¥im¨y
 = 
	`kmÆloc_¨øy
(
ª£rved_gdb
, (*¥im¨y), 
GFP_NOFS
);

1013 i‡(!
¥im¨y
)

1014  -
ENOMEM
;

1016 
d©a
 = 
	`PXT4_I
(
öode
)->
i_d©a
 + 
PXT4_DIND_BLOCK
;

1017 
död
 = 
	`pxt4_sb_bªad
(
sb
, 
	`À32_to_˝u
(*
d©a
), 0);

1018 i‡(
	`IS_ERR
(
död
)) {

1019 
îr
 = 
	`PTR_ERR
(
död
);

1020 
död
 = 
NULL
;

1021 
exô_‰ì
;

1024 
blk
 = 
	`PXT4_SB
(
sb
)->
s_sbh
->
b_blockƒ
 + 1 + PXT4_SB(sb)->
s_gdb_cou¡
;

1025 
d©a
 = (
__À32
 *)
död
->
b_d©a
 + (
	`PXT4_SB
(
sb
)->
s_gdb_cou¡
 %

1026 
	`PXT4_ADDR_PER_BLOCK
(
sb
));

1027 
íd
 = (
__À32
 *)
död
->
b_d©a
 + 
	`PXT4_ADDR_PER_BLOCK
(
sb
);

1030 
ªs
 = 0;Ñe†< 
ª£rved_gdb
;Ñes++, 
blk
++) {

1031 i‡(
	`À32_to_˝u
(*
d©a
Ë!
blk
) {

1032 
	`pxt4_w¨nög
(
sb
, "reserved block %llu"

1034 
blk
,

1035 ()(
d©a
 - (
__À32
 *)
död
->
b_d©a
));

1036 
îr
 = -
EINVAL
;

1037 
exô_bh
;

1039 
¥im¨y
[
ªs
] = 
	`pxt4_sb_bªad
(
sb
, 
blk
, 0);

1040 i‡(
	`IS_ERR
(
¥im¨y
[
ªs
])) {

1041 
îr
 = 
	`PTR_ERR
(
¥im¨y
[
ªs
]);

1042 
¥im¨y
[
ªs
] = 
NULL
;

1043 
exô_bh
;

1045 
gdbackups
 = 
	`vîify_ª£rved_gdb
(
sb
, 
group
, 
¥im¨y
[
ªs
]);

1046 i‡(
gdbackups
 < 0) {

1047 
	`bªl£
(
¥im¨y
[
ªs
]);

1048 
îr
 = 
gdbackups
;

1049 
exô_bh
;

1051 i‡(++
d©a
 >
íd
)

1052 
d©a
 = (
__À32
 *)
död
->
b_d©a
;

1055 
i
 = 0; i < 
ª£rved_gdb
; i++) {

1056 
	`BUFFER_TRACE
(
¥im¨y
[
i
], "get_write_access");

1057 i‡((
îr
 = 
	`pxt4_jou∫Æ_gë_wrôe_ac˚ss
(
h™dÀ
, 
¥im¨y
[
i
])))

1058 
exô_bh
;

1061 i‡((
îr
 = 
	`pxt4_ª£rve_öode_wrôe
(
h™dÀ
, 
öode
, &
ûoc
)))

1062 
exô_bh
;

1068 
blk
 = 
group
 * 
	`PXT4_BLOCKS_PER_GROUP
(
sb
);

1069 
i
 = 0; i < 
ª£rved_gdb
; i++) {

1070 
îr2
;

1071 
d©a
 = (
__À32
 *)
¥im¨y
[
i
]->
b_d©a
;

1075 
d©a
[
gdbackups
] = 
	`˝u_to_À32
(
blk
 + 
¥im¨y
[
i
]->
b_blockƒ
);

1076 
îr2
 = 
	`pxt4_h™dÀ_dúty_mëad©a
(
h™dÀ
, 
NULL
, 
¥im¨y
[
i
]);

1077 i‡(!
îr
)

1078 
îr
 = 
îr2
;

1081 
öode
->
i_blocks
 +
ª£rved_gdb
 * 
sb
->
s_blocksize
 >> (9 - 
˛u°î_bôs
);

1082 
	`pxt4_m¨k_ûoc_dúty
(
h™dÀ
, 
öode
, &
ûoc
);

1084 
exô_bh
:

1085 --
ªs
 >= 0)

1086 
	`bªl£
(
¥im¨y
[
ªs
]);

1087 
	`bªl£
(
död
);

1089 
exô_‰ì
:

1090 
	`k‰ì
(
¥im¨y
);

1092  
îr
;

1093 
	}
}

1111 
	$upd©e_backups
(
su≥r_block
 *
sb
, 
£˘‹_t
 
blk_off
, *
d©a
,

1112 
size
, 
mëa_bg
)

1114 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
sb
);

1115 
pxt4_group_t
 
œ°
;

1116 c⁄° 
bpg
 = 
	`PXT4_BLOCKS_PER_GROUP
(
sb
);

1117 
thªe
 = 1;

1118 
five
 = 5;

1119 
£ví
 = 7;

1120 
pxt4_group_t
 
group
 = 0;

1121 
ª°
 = 
sb
->
s_blocksize
 - 
size
;

1122 
h™dÀ_t
 *
h™dÀ
;

1123 
îr
 = 0, 
îr2
;

1125 
h™dÀ
 = 
	`pxt4_jou∫Æ_°¨t_sb
(
sb
, 
PXT4_HT_RESIZE
, 
PXT4_MAX_TRANS_DATA
);

1126 i‡(
	`IS_ERR
(
h™dÀ
)) {

1127 
group
 = 1;

1128 
îr
 = 
	`PTR_ERR
(
h™dÀ
);

1129 
exô_îr
;

1132 i‡(
mëa_bg
 == 0) {

1133 
group
 = 
	`pxt4_li°_backups
(
sb
, &
thªe
, &
five
, &
£ví
);

1134 
œ°
 = 
sbi
->
s_groups_cou¡
;

1136 
group
 = 
	`pxt4_gë_group_numbî
(
sb
, 
blk_off
) + 1;

1137 
œ°
 = (
pxt4_group_t
)(
group
 + 
	`PXT4_DESC_PER_BLOCK
(
sb
) - 2);

1140 
group
 < 
sbi
->
s_groups_cou¡
) {

1141 
buf„r_hód
 *
bh
;

1142 
pxt4_fsblk_t
 
backup_block
;

1145 i‡(
	`pxt4_h™dÀ_vÆid
(
h™dÀ
) &&

1146 
h™dÀ
->
h_buf„r_¸edôs
 == 0 &&

1147 
	`pxt4_jou∫Æ_exãnd
(
h™dÀ
, 
PXT4_MAX_TRANS_DATA
) &&

1148 (
îr
 = 
	`pxt4_jou∫Æ_ª°¨t
(
h™dÀ
, 
PXT4_MAX_TRANS_DATA
)))

1151 i‡(
mëa_bg
 == 0)

1152 
backup_block
 = ((
pxt4_fsblk_t
)
group
Ë* 
bpg
 + 
blk_off
;

1154 
backup_block
 = (
	`pxt4_group_fú°_block_no
(
sb
, 
group
) +

1155 
	`pxt4_bg_has_su≥r
(
sb
, 
group
));

1157 
bh
 = 
	`sb_gëblk
(
sb
, 
backup_block
);

1158 i‡(
	`u∆ikñy
(!
bh
)) {

1159 
îr
 = -
ENOMEM
;

1162 
	`pxt4_debug
("update metadata backup %llu(+%llu)\n",

1163 
backup_block
, backup_block -

1164 
	`pxt4_group_fú°_block_no
(
sb
, 
group
));

1165 
	`BUFFER_TRACE
(
bh
, "get_write_access");

1166 i‡((
îr
 = 
	`pxt4_jou∫Æ_gë_wrôe_ac˚ss
(
h™dÀ
, 
bh
))) {

1167 
	`bªl£
(
bh
);

1170 
	`lock_buf„r
(
bh
);

1171 
	`mem˝y
(
bh
->
b_d©a
, 
d©a
, 
size
);

1172 i‡(
ª°
)

1173 
	`mem£t
(
bh
->
b_d©a
 + 
size
, 0, 
ª°
);

1174 
	`£t_buf„r_u±od©e
(
bh
);

1175 
	`u∆ock_buf„r
(
bh
);

1176 
îr
 = 
	`pxt4_h™dÀ_dúty_mëad©a
(
h™dÀ
, 
NULL
, 
bh
);

1177 i‡(
	`u∆ikñy
(
îr
))

1178 
	`pxt4_°d_îr‹
(
sb
, 
îr
);

1179 
	`bªl£
(
bh
);

1181 i‡(
mëa_bg
 == 0)

1182 
group
 = 
	`pxt4_li°_backups
(
sb
, &
thªe
, &
five
, &
£ví
);

1183 i‡(
group
 =
œ°
)

1186 
group
 = 
œ°
;

1188 i‡((
îr2
 = 
	`pxt4_jou∫Æ_°›
(
h™dÀ
)Ë&& !
îr
)

1189 
îr
 = 
îr2
;

1201 
exô_îr
:

1202 i‡(
îr
) {

1203 
	`pxt4_w¨nög
(
sb
, "can't update backup for group %u (err %d), "

1204 "f‹cög fsck o¿√xàªboŸ", 
group
, 
îr
);

1205 
sbi
->
s_mou¡_°©e
 &~
PXT4_VALID_FS
;

1206 
sbi
->
s_es
->
s_°©e
 &
	`˝u_to_À16
(~
PXT4_VALID_FS
);

1207 
	`m¨k_buf„r_dúty
(
sbi
->
s_sbh
);

1209 
	}
}

1221 
	$pxt4_add_√w_descs
(
h™dÀ_t
 *
h™dÀ
, 
su≥r_block
 *
sb
,

1222 
pxt4_group_t
 
group
, 
öode
 *
ªsize_öode
,

1223 
pxt4_group_t
 
cou¡
)

1225 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
sb
);

1226 
pxt4_su≥r_block
 *
es
 = 
sbi
->
s_es
;

1227 
buf„r_hód
 *
gdb_bh
;

1228 
i
, 
gdb_off
, 
gdb_num
, 
îr
 = 0;

1229 
mëa_bg
;

1231 
mëa_bg
 = 
	`pxt4_has_„©uª_mëa_bg
(
sb
);

1232 
i
 = 0; i < 
cou¡
; i++, 
group
++) {

1233 
ª£rved_gdb
 = 
	`pxt4_bg_has_su≥r
(
sb
, 
group
) ?

1234 
	`À16_to_˝u
(
es
->
s_ª£rved_gdt_blocks
) : 0;

1236 
gdb_off
 = 
group
 % 
	`PXT4_DESC_PER_BLOCK
(
sb
);

1237 
gdb_num
 = 
group
 / 
	`PXT4_DESC_PER_BLOCK
(
sb
);

1245 i‡(
gdb_off
) {

1246 
gdb_bh
 = 
	`sbi_¨øy_rcu_dîef
(
sbi
, 
s_group_desc
,

1247 
gdb_num
);

1248 
	`BUFFER_TRACE
(
gdb_bh
, "get_write_access");

1249 
îr
 = 
	`pxt4_jou∫Æ_gë_wrôe_ac˚ss
(
h™dÀ
, 
gdb_bh
);

1251 i‡(!
îr
 && 
ª£rved_gdb
 && 
	`pxt4_bg_num_gdb
(
sb
, 
group
))

1252 
îr
 = 
	`ª£rve_backup_gdb
(
h™dÀ
, 
ªsize_öode
, 
group
);

1253 } i‡(
mëa_bg
 != 0) {

1254 
îr
 = 
	`add_√w_gdb_mëa_bg
(
sb
, 
h™dÀ
, 
group
);

1256 
îr
 = 
	`add_√w_gdb
(
h™dÀ
, 
ªsize_öode
, 
group
);

1258 i‡(
îr
)

1261  
îr
;

1262 
	}
}

1264 
buf„r_hód
 *
	$pxt4_gë_bôm≠
(
su≥r_block
 *
sb
, 
__u64
 
block
)

1266 
buf„r_hód
 *
bh
 = 
	`sb_gëblk
(
sb
, 
block
);

1267 i‡(
	`u∆ikñy
(!
bh
))

1268  
NULL
;

1269 i‡(!
	`bh_u±od©e_‹_lock
(
bh
)) {

1270 i‡(
	`bh_submô_ªad
(
bh
) < 0) {

1271 
	`bªl£
(
bh
);

1272  
NULL
;

1276  
bh
;

1277 
	}
}

1279 
	$pxt4_£t_bôm≠_checksums
(
su≥r_block
 *
sb
,

1280 
pxt4_group_t
 
group
,

1281 
pxt4_group_desc
 *
gdp
,

1282 
pxt4_√w_group_d©a
 *
group_d©a
)

1284 
buf„r_hód
 *
bh
;

1286 i‡(!
	`pxt4_has_mëad©a_csum
(
sb
))

1289 
bh
 = 
	`pxt4_gë_bôm≠
(
sb
, 
group_d©a
->
öode_bôm≠
);

1290 i‡(!
bh
)

1291  -
EIO
;

1292 
	`pxt4_öode_bôm≠_csum_£t
(
sb
, 
group
, 
gdp
, 
bh
,

1293 
	`PXT4_INODES_PER_GROUP
(
sb
) / 8);

1294 
	`bªl£
(
bh
);

1296 
bh
 = 
	`pxt4_gë_bôm≠
(
sb
, 
group_d©a
->
block_bôm≠
);

1297 i‡(!
bh
)

1298  -
EIO
;

1299 
	`pxt4_block_bôm≠_csum_£t
(
sb
, 
group
, 
gdp
, 
bh
);

1300 
	`bªl£
(
bh
);

1303 
	}
}

1308 
	$pxt4_£tup_√w_descs
(
h™dÀ_t
 *
h™dÀ
, 
su≥r_block
 *
sb
,

1309 
pxt4_√w_Êex_group_d©a
 *
Êex_gd
)

1311 
pxt4_√w_group_d©a
 *
group_d©a
 = 
Êex_gd
->
groups
;

1312 
pxt4_group_desc
 *
gdp
;

1313 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
sb
);

1314 
buf„r_hód
 *
gdb_bh
;

1315 
pxt4_group_t
 
group
;

1316 
__u16
 *
bg_Êags
 = 
Êex_gd
->bg_flags;

1317 
i
, 
gdb_off
, 
gdb_num
, 
îr
 = 0;

1320 
i
 = 0; i < 
Êex_gd
->
cou¡
; i++, 
group_d©a
++, 
bg_Êags
++) {

1321 
group
 = 
group_d©a
->group;

1323 
gdb_off
 = 
group
 % 
	`PXT4_DESC_PER_BLOCK
(
sb
);

1324 
gdb_num
 = 
group
 / 
	`PXT4_DESC_PER_BLOCK
(
sb
);

1329 
gdb_bh
 = 
	`sbi_¨øy_rcu_dîef
(
sbi
, 
s_group_desc
, 
gdb_num
);

1331 
gdp
 = (
pxt4_group_desc
 *)(
gdb_bh
->
b_d©a
 +

1332 
gdb_off
 * 
	`PXT4_DESC_SIZE
(
sb
));

1334 
	`mem£t
(
gdp
, 0, 
	`PXT4_DESC_SIZE
(
sb
));

1335 
	`pxt4_block_bôm≠_£t
(
sb
, 
gdp
, 
group_d©a
->
block_bôm≠
);

1336 
	`pxt4_öode_bôm≠_£t
(
sb
, 
gdp
, 
group_d©a
->
öode_bôm≠
);

1337 
îr
 = 
	`pxt4_£t_bôm≠_checksums
(
sb
, 
group
, 
gdp
, 
group_d©a
);

1338 i‡(
îr
) {

1339 
	`pxt4_°d_îr‹
(
sb
, 
îr
);

1343 
	`pxt4_öode_èbÀ_£t
(
sb
, 
gdp
, 
group_d©a
->
öode_èbÀ
);

1344 
	`pxt4_‰ì_group_˛u°îs_£t
(
sb
, 
gdp
,

1345 
group_d©a
->
‰ì_˛u°îs_cou¡
);

1346 
	`pxt4_‰ì_öodes_£t
(
sb
, 
gdp
, 
	`PXT4_INODES_PER_GROUP
(sb));

1347 i‡(
	`pxt4_has_group_desc_csum
(
sb
))

1348 
	`pxt4_ôabÀ_unu£d_£t
(
sb
, 
gdp
,

1349 
	`PXT4_INODES_PER_GROUP
(
sb
));

1350 
gdp
->
bg_Êags
 = 
	`˝u_to_À16
(*bg_flags);

1351 
	`pxt4_group_desc_csum_£t
(
sb
, 
group
, 
gdp
);

1353 
îr
 = 
	`pxt4_h™dÀ_dúty_mëad©a
(
h™dÀ
, 
NULL
, 
gdb_bh
);

1354 i‡(
	`u∆ikñy
(
îr
)) {

1355 
	`pxt4_°d_îr‹
(
sb
, 
îr
);

1363 
îr
 = 
	`pxt4_mb_add_groupöfo
(
sb
, 
group
, 
gdp
);

1364 i‡(
îr
)

1367  
îr
;

1368 
	}
}

1377 
	$pxt4_upd©e_su≥r
(
su≥r_block
 *
sb
,

1378 
pxt4_√w_Êex_group_d©a
 *
Êex_gd
)

1380 
pxt4_fsblk_t
 
blocks_cou¡
 = 0;

1381 
pxt4_fsblk_t
 
‰ì_blocks
 = 0;

1382 
pxt4_fsblk_t
 
ª£rved_blocks
 = 0;

1383 
pxt4_√w_group_d©a
 *
group_d©a
 = 
Êex_gd
->
groups
;

1384 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
sb
);

1385 
pxt4_su≥r_block
 *
es
 = 
sbi
->
s_es
;

1386 
i
;

1388 
	`BUG_ON
(
Êex_gd
->
cou¡
 =0 || 
group_d©a
 =
NULL
);

1399 
i
 = 0; i < 
Êex_gd
->
cou¡
; i++) {

1400 
blocks_cou¡
 +
group_d©a
[
i
].blocks_count;

1401 
‰ì_blocks
 +
	`PXT4_C2B
(
sbi
, 
group_d©a
[
i
].
‰ì_˛u°îs_cou¡
);

1404 
ª£rved_blocks
 = 
	`pxt4_r_blocks_cou¡
(
es
) * 100;

1405 
ª£rved_blocks
 = 
	`div64_u64
‘e£rved_blocks, 
	`pxt4_blocks_cou¡
(
es
));

1406 
ª£rved_blocks
 *
blocks_cou¡
;

1407 
	`do_div
(
ª£rved_blocks
, 100);

1409 
	`pxt4_blocks_cou¡_£t
(
es
, 
	`pxt4_blocks_cou¡
”sË+ 
blocks_cou¡
);

1410 
	`pxt4_‰ì_blocks_cou¡_£t
(
es
, 
	`pxt4_‰ì_blocks_cou¡
”sË+ 
‰ì_blocks
);

1411 
	`À32_add_˝u
(&
es
->
s_öodes_cou¡
, 
	`PXT4_INODES_PER_GROUP
(
sb
) *

1412 
Êex_gd
->
cou¡
);

1413 
	`À32_add_˝u
(&
es
->
s_‰ì_öodes_cou¡
, 
	`PXT4_INODES_PER_GROUP
(
sb
) *

1414 
Êex_gd
->
cou¡
);

1416 
	`pxt4_debug
("‰ì block†cou¡ %Œu", 
	`pxt4_‰ì_blocks_cou¡
(
es
));

1435 
	`smp_wmb
();

1438 
sbi
->
s_groups_cou¡
 +
Êex_gd
->
cou¡
;

1439 
sbi
->
s_blockfûe_groups
 = 
	`mö_t
(
pxt4_group_t
, sbi->
s_groups_cou¡
,

1440 (
PXT4_MAX_BLOCK_FILE_PHYS
 / 
	`PXT4_BLOCKS_PER_GROUP
(
sb
)));

1444 
	`pxt4_r_blocks_cou¡_£t
(
es
, 
	`pxt4_r_blocks_cou¡
(es) +

1445 
ª£rved_blocks
);

1448 
	`≥r˝u_cou¡î_add
(&
sbi
->
s_‰ì˛u°îs_cou¡î
,

1449 
	`PXT4_NUM_B2C
(
sbi
, 
‰ì_blocks
));

1450 
	`≥r˝u_cou¡î_add
(&
sbi
->
s_‰ìöodes_cou¡î
,

1451 
	`PXT4_INODES_PER_GROUP
(
sb
Ë* 
Êex_gd
->
cou¡
);

1453 
	`pxt4_debug
("free blocks count %llu",

1454 
	`≥r˝u_cou¡î_ªad
(&
sbi
->
s_‰ì˛u°îs_cou¡î
));

1455 i‡(
	`pxt4_has_„©uª_Êex_bg
(
sb
Ë&& 
sbi
->
s_log_groups_≥r_Êex
) {

1456 
pxt4_group_t
 
Êex_group
;

1457 
Êex_groups
 *
fg
;

1459 
Êex_group
 = 
	`pxt4_Êex_group
(
sbi
, 
group_d©a
[0].
group
);

1460 
fg
 = 
	`sbi_¨øy_rcu_dîef
(
sbi
, 
s_Êex_groups
, 
Êex_group
);

1461 
	`©omic64_add
(
	`PXT4_NUM_B2C
(
sbi
, 
‰ì_blocks
),

1462 &
fg
->
‰ì_˛u°îs
);

1463 
	`©omic_add
(
	`PXT4_INODES_PER_GROUP
(
sb
Ë* 
Êex_gd
->
cou¡
,

1464 &
fg
->
‰ì_öodes
);

1470 
	`pxt4_ˇlcuœã_ovîhód
(
sb
);

1472 i‡(
	`ã°_›t
(
sb
, 
DEBUG
))

1473 
	`¥ötk
(
KERN_DEBUG
 "PXT4-fs:ádded group %u:"

1474 "%Œu blocks(%Œu fªê%ŒuÑe£rved)\n", 
Êex_gd
->
cou¡
,

1475 
blocks_cou¡
, 
‰ì_blocks
, 
ª£rved_blocks
);

1476 
	}
}

1482 
	$pxt4_Êex_group_add
(
su≥r_block
 *
sb
,

1483 
öode
 *
ªsize_öode
,

1484 
pxt4_√w_Êex_group_d©a
 *
Êex_gd
)

1486 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
sb
);

1487 
pxt4_su≥r_block
 *
es
 = 
sbi
->
s_es
;

1488 
pxt4_fsblk_t
 
o_blocks_cou¡
;

1489 
pxt4_gΩblk_t
 
œ°
;

1490 
pxt4_group_t
 
group
;

1491 
h™dÀ_t
 *
h™dÀ
;

1492 
ª£rved_gdb
;

1493 
îr
 = 0, 
îr2
 = 0, 
¸edô
;

1495 
	`BUG_ON
(!
Êex_gd
->
cou¡
 || !Êex_gd->
groups
 || !Êex_gd->
bg_Êags
);

1497 
ª£rved_gdb
 = 
	`À16_to_˝u
(
es
->
s_ª£rved_gdt_blocks
);

1498 
o_blocks_cou¡
 = 
	`pxt4_blocks_cou¡
(
es
);

1499 
	`pxt4_gë_group_no_™d_off£t
(
sb
, 
o_blocks_cou¡
, &
group
, &
œ°
);

1500 
	`BUG_ON
(
œ°
);

1502 
îr
 = 
	`£tup_√w_Êex_group_blocks
(
sb
, 
Êex_gd
);

1503 i‡(
îr
)

1504 
exô
;

1512 
¸edô
 = 3;

1514 
¸edô
 +1 + 
	`DIV_ROUND_UP
(
Êex_gd
->
cou¡
, 
	`PXT4_DESC_PER_BLOCK
(
sb
));

1515 
¸edô
 +
ª£rved_gdb
;

1516 
h™dÀ
 = 
	`pxt4_jou∫Æ_°¨t_sb
(
sb
, 
PXT4_HT_RESIZE
, 
¸edô
);

1517 i‡(
	`IS_ERR
(
h™dÀ
)) {

1518 
îr
 = 
	`PTR_ERR
(
h™dÀ
);

1519 
exô
;

1522 
	`BUFFER_TRACE
(
sbi
->
s_sbh
, "get_write_access");

1523 
îr
 = 
	`pxt4_jou∫Æ_gë_wrôe_ac˚ss
(
h™dÀ
, 
sbi
->
s_sbh
);

1524 i‡(
îr
)

1525 
exô_jou∫Æ
;

1527 
group
 = 
Êex_gd
->
groups
[0].group;

1528 
	`BUG_ON
(
group
 !
sbi
->
s_groups_cou¡
);

1529 
îr
 = 
	`pxt4_add_√w_descs
(
h™dÀ
, 
sb
, 
group
,

1530 
ªsize_öode
, 
Êex_gd
->
cou¡
);

1531 i‡(
îr
)

1532 
exô_jou∫Æ
;

1534 
îr
 = 
	`pxt4_£tup_√w_descs
(
h™dÀ
, 
sb
, 
Êex_gd
);

1535 i‡(
îr
)

1536 
exô_jou∫Æ
;

1538 
	`pxt4_upd©e_su≥r
(
sb
, 
Êex_gd
);

1540 
îr
 = 
	`pxt4_h™dÀ_dúty_su≥r
(
h™dÀ
, 
sb
);

1542 
exô_jou∫Æ
:

1543 
îr2
 = 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

1544 i‡(!
îr
)

1545 
îr
 = 
îr2
;

1547 i‡(!
îr
) {

1548 
gdb_num
 = 
group
 / 
	`PXT4_DESC_PER_BLOCK
(
sb
);

1549 
gdb_num_íd
 = ((
group
 + 
Êex_gd
->
cou¡
 - 1) /

1550 
	`PXT4_DESC_PER_BLOCK
(
sb
));

1551 
mëa_bg
 = 
	`pxt4_has_„©uª_mëa_bg
(
sb
);

1552 
£˘‹_t
 
ﬁd_gdb
 = 0;

1554 
	`upd©e_backups
(
sb
, 
sbi
->
s_sbh
->
b_blockƒ
, (*)
es
,

1555 (
pxt4_su≥r_block
), 0);

1556 ; 
gdb_num
 <
gdb_num_íd
; gdb_num++) {

1557 
buf„r_hód
 *
gdb_bh
;

1559 
gdb_bh
 = 
	`sbi_¨øy_rcu_dîef
(
sbi
, 
s_group_desc
,

1560 
gdb_num
);

1561 i‡(
ﬁd_gdb
 =
gdb_bh
->
b_blockƒ
)

1563 
	`upd©e_backups
(
sb
, 
gdb_bh
->
b_blockƒ
, gdb_bh->
b_d©a
,

1564 
gdb_bh
->
b_size
, 
mëa_bg
);

1565 
ﬁd_gdb
 = 
gdb_bh
->
b_blockƒ
;

1568 
exô
:

1569  
îr
;

1570 
	}
}

1572 
	$pxt4_£tup_√xt_Êex_gd
(
su≥r_block
 *
sb
,

1573 
pxt4_√w_Êex_group_d©a
 *
Êex_gd
,

1574 
pxt4_fsblk_t
 
n_blocks_cou¡
,

1575 
Êexbg_size
)

1577 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
sb
);

1578 
pxt4_su≥r_block
 *
es
 = 
sbi
->
s_es
;

1579 
pxt4_√w_group_d©a
 *
group_d©a
 = 
Êex_gd
->
groups
;

1580 
pxt4_fsblk_t
 
o_blocks_cou¡
;

1581 
pxt4_group_t
 
n_group
;

1582 
pxt4_group_t
 
group
;

1583 
pxt4_group_t
 
œ°_group
;

1584 
pxt4_gΩblk_t
 
œ°
;

1585 
pxt4_gΩblk_t
 
˛u°îs_≥r_group
;

1586 
i
;

1588 
˛u°îs_≥r_group
 = 
	`PXT4_CLUSTERS_PER_GROUP
(
sb
);

1590 
o_blocks_cou¡
 = 
	`pxt4_blocks_cou¡
(
es
);

1592 i‡(
o_blocks_cou¡
 =
n_blocks_cou¡
)

1595 
	`pxt4_gë_group_no_™d_off£t
(
sb
, 
o_blocks_cou¡
, &
group
, &
œ°
);

1596 
	`BUG_ON
(
œ°
);

1597 
	`pxt4_gë_group_no_™d_off£t
(
sb
, 
n_blocks_cou¡
 - 1, &
n_group
, &
œ°
);

1599 
œ°_group
 = 
group
 | (
Êexbg_size
 - 1);

1600 i‡(
œ°_group
 > 
n_group
)

1601 
œ°_group
 = 
n_group
;

1603 
Êex_gd
->
cou¡
 = 
œ°_group
 - 
group
 + 1;

1605 
i
 = 0; i < 
Êex_gd
->
cou¡
; i++) {

1606 
ovîhód
;

1608 
group_d©a
[
i
].
group
 = group + i;

1609 
group_d©a
[
i
].
blocks_cou¡
 = 
	`PXT4_BLOCKS_PER_GROUP
(
sb
);

1610 
ovîhód
 = 
	`pxt4_group_ovîhód_blocks
(
sb
, 
group
 + 
i
);

1611 
group_d©a
[
i
].
md©a_blocks
 = 
ovîhód
;

1612 
group_d©a
[
i
].
‰ì_˛u°îs_cou¡
 = 
	`PXT4_CLUSTERS_PER_GROUP
(
sb
);

1613 i‡(
	`pxt4_has_group_desc_csum
(
sb
)) {

1614 
Êex_gd
->
bg_Êags
[
i
] = 
PXT4_BG_BLOCK_UNINIT
 |

1615 
PXT4_BG_INODE_UNINIT
;

1616 i‡(!
	`ã°_›t
(
sb
, 
INIT_INODE_TABLE
))

1617 
Êex_gd
->
bg_Êags
[
i
] |
PXT4_BG_INODE_ZEROED
;

1619 
Êex_gd
->
bg_Êags
[
i
] = 
PXT4_BG_INODE_ZEROED
;

1622 i‡(
œ°_group
 =
n_group
 && 
	`pxt4_has_group_desc_csum
(
sb
))

1624 
Êex_gd
->
bg_Êags
[
i
 - 1] &~
PXT4_BG_BLOCK_UNINIT
;

1626 i‡((
œ°_group
 =
n_group
Ë&& (
œ°
 !
˛u°îs_≥r_group
 - 1)) {

1627 
group_d©a
[
i
 - 1].
blocks_cou¡
 = 
	`PXT4_C2B
(
sbi
, 
œ°
 + 1);

1628 
group_d©a
[
i
 - 1].
‰ì_˛u°îs_cou¡
 -
˛u°îs_≥r_group
 -

1629 
œ°
 - 1;

1633 
	}
}

1648 
	$pxt4_group_add
(
su≥r_block
 *
sb
, 
pxt4_√w_group_d©a
 *
öput
)

1650 
pxt4_√w_Êex_group_d©a
 
Êex_gd
;

1651 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
sb
);

1652 
pxt4_su≥r_block
 *
es
 = 
sbi
->
s_es
;

1653 
ª£rved_gdb
 = 
	`pxt4_bg_has_su≥r
(
sb
, 
öput
->
group
) ?

1654 
	`À16_to_˝u
(
es
->
s_ª£rved_gdt_blocks
) : 0;

1655 
öode
 *öodê
NULL
;

1656 
gdb_off
;

1657 
îr
;

1658 
__u16
 
bg_Êags
 = 0;

1660 
gdb_off
 = 
öput
->
group
 % 
	`PXT4_DESC_PER_BLOCK
(
sb
);

1662 i‡(
gdb_off
 =0 && !
	`pxt4_has_„©uª_•¨£_su≥r
(
sb
)) {

1663 
	`pxt4_w¨nög
(
sb
, "Can'tÑesizeÇon-sparse filesystem further");

1664  -
EPERM
;

1667 i‡(
	`pxt4_blocks_cou¡
(
es
Ë+ 
öput
->
blocks_cou¡
 <

1668 
	`pxt4_blocks_cou¡
(
es
)) {

1669 
	`pxt4_w¨nög
(
sb
, "blocks_count overflow");

1670  -
EINVAL
;

1673 i‡(
	`À32_to_˝u
(
es
->
s_öodes_cou¡
Ë+ 
	`PXT4_INODES_PER_GROUP
(
sb
) <

1674 
	`À32_to_˝u
(
es
->
s_öodes_cou¡
)) {

1675 
	`pxt4_w¨nög
(
sb
, "inodes_count overflow");

1676  -
EINVAL
;

1679 i‡(
ª£rved_gdb
 || 
gdb_off
 == 0) {

1680 i‡(!
	`pxt4_has_„©uª_ªsize_öode
(
sb
) ||

1681 !
	`À16_to_˝u
(
es
->
s_ª£rved_gdt_blocks
)) {

1682 
	`pxt4_w¨nög
(
sb
,

1684  -
EPERM
;

1686 
öode
 = 
	`pxt4_igë
(
sb
, 
PXT4_RESIZE_INO
, 
PXT4_IGET_SPECIAL
);

1687 i‡(
	`IS_ERR
(
öode
)) {

1688 
	`pxt4_w¨nög
(
sb
, "Error openingÑesize inode");

1689  
	`PTR_ERR
(
öode
);

1694 
îr
 = 
	`vîify_group_öput
(
sb
, 
öput
);

1695 i‡(
îr
)

1696 
out
;

1698 
îr
 = 
	`pxt4_Æloc_Êex_bg_¨øy
(
sb
, 
öput
->
group
 + 1);

1699 i‡(
îr
)

1700 
out
;

1702 
îr
 = 
	`pxt4_mb_Æloc_groupöfo
(
sb
, 
öput
->
group
 + 1);

1703 i‡(
îr
)

1704 
out
;

1706 
Êex_gd
.
cou¡
 = 1;

1707 
Êex_gd
.
groups
 = 
öput
;

1708 
Êex_gd
.
bg_Êags
 = &bg_flags;

1709 
îr
 = 
	`pxt4_Êex_group_add
(
sb
, 
öode
, &
Êex_gd
);

1710 
out
:

1711 
	`ùut
(
öode
);

1712  
îr
;

1713 
	}
}

1718 
	$pxt4_group_exãnd_no_check
(
su≥r_block
 *
sb
,

1719 
pxt4_fsblk_t
 
o_blocks_cou¡
, 
pxt4_gΩblk_t
 
add
)

1721 
pxt4_su≥r_block
 *
es
 = 
	`PXT4_SB
(
sb
)->
s_es
;

1722 
h™dÀ_t
 *
h™dÀ
;

1723 
îr
 = 0, 
îr2
;

1728 
h™dÀ
 = 
	`pxt4_jou∫Æ_°¨t_sb
(
sb
, 
PXT4_HT_RESIZE
, 3);

1729 i‡(
	`IS_ERR
(
h™dÀ
)) {

1730 
îr
 = 
	`PTR_ERR
(
h™dÀ
);

1731 
	`pxt4_w¨nög
(
sb
, "îr‹ %d o¿jou∫Æ sèπ", 
îr
);

1732  
îr
;

1735 
	`BUFFER_TRACE
(
	`PXT4_SB
(
sb
)->
s_sbh
, "get_write_access");

1736 
îr
 = 
	`pxt4_jou∫Æ_gë_wrôe_ac˚ss
(
h™dÀ
, 
	`PXT4_SB
(
sb
)->
s_sbh
);

1737 i‡(
îr
) {

1738 
	`pxt4_w¨nög
(
sb
, "îr‹ %d o¿jou∫Æ wrôêac˚ss", 
îr
);

1739 
îrout
;

1742 
	`pxt4_blocks_cou¡_£t
(
es
, 
o_blocks_cou¡
 + 
add
);

1743 
	`pxt4_‰ì_blocks_cou¡_£t
(
es
, 
	`pxt4_‰ì_blocks_cou¡
”sË+ 
add
);

1744 
	`pxt4_debug
("‰ìög block†%ŒuÅhrough %Œu\n", 
o_blocks_cou¡
,

1745 
o_blocks_cou¡
 + 
add
);

1747 
îr
 = 
	`pxt4_group_add_blocks
(
h™dÀ
, 
sb
, 
o_blocks_cou¡
, 
add
);

1748 i‡(
îr
)

1749 
îrout
;

1750 
	`pxt4_h™dÀ_dúty_su≥r
(
h™dÀ
, 
sb
);

1751 
	`pxt4_debug
("‰ìd block†%ŒuÅhrough %Œu\n", 
o_blocks_cou¡
,

1752 
o_blocks_cou¡
 + 
add
);

1753 
îrout
:

1754 
îr2
 = 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

1755 i‡(
îr2
 && !
îr
)

1756 
îr
 = 
îr2
;

1758 i‡(!
îr
) {

1759 i‡(
	`ã°_›t
(
sb
, 
DEBUG
))

1760 
	`¥ötk
(
KERN_DEBUG
 "PXT4-fs:Éxtended groupÅo %llu "

1761 "blocks\n", 
	`pxt4_blocks_cou¡
(
es
));

1762 
	`upd©e_backups
(
sb
, 
	`PXT4_SB
(sb)->
s_sbh
->
b_blockƒ
,

1763 (*)
es
, (
pxt4_su≥r_block
), 0);

1765  
îr
;

1766 
	}
}

1778 
	$pxt4_group_exãnd
(
su≥r_block
 *
sb
, 
pxt4_su≥r_block
 *
es
,

1779 
pxt4_fsblk_t
 
n_blocks_cou¡
)

1781 
pxt4_fsblk_t
 
o_blocks_cou¡
;

1782 
pxt4_gΩblk_t
 
œ°
;

1783 
pxt4_gΩblk_t
 
add
;

1784 
buf„r_hód
 *
bh
;

1785 
îr
;

1786 
pxt4_group_t
 
group
;

1788 
o_blocks_cou¡
 = 
	`pxt4_blocks_cou¡
(
es
);

1790 i‡(
	`ã°_›t
(
sb
, 
DEBUG
))

1791 
	`pxt4_msg
(
sb
, 
KERN_DEBUG
,

1793 
o_blocks_cou¡
, 
n_blocks_cou¡
);

1795 i‡(
n_blocks_cou¡
 =0 ||Ç_blocks_cou¡ =
o_blocks_cou¡
)

1798 i‡(
n_blocks_cou¡
 > (
£˘‹_t
)(~0ULLË>> (
sb
->
s_blocksize_bôs
 - 9)) {

1799 
	`pxt4_msg
(
sb
, 
KERN_ERR
,

1801 
n_blocks_cou¡
);

1802  -
EINVAL
;

1805 i‡(
n_blocks_cou¡
 < 
o_blocks_cou¡
) {

1806 
	`pxt4_w¨nög
(
sb
, "can't shrink FS -Ñesizeáborted");

1807  -
EINVAL
;

1811 
	`pxt4_gë_group_no_™d_off£t
(
sb
, 
o_blocks_cou¡
, &
group
, &
œ°
);

1813 i‡(
œ°
 == 0) {

1814 
	`pxt4_w¨nög
(
sb
, "needÅo useÖxt2onlineÅoÑesize further");

1815  -
EPERM
;

1818 
add
 = 
	`PXT4_BLOCKS_PER_GROUP
(
sb
Ë- 
œ°
;

1820 i‡(
o_blocks_cou¡
 + 
add
 < o_blocks_count) {

1821 
	`pxt4_w¨nög
(
sb
, "blocks_count overflow");

1822  -
EINVAL
;

1825 i‡(
o_blocks_cou¡
 + 
add
 > 
n_blocks_cou¡
)

1826 
add
 = 
n_blocks_cou¡
 - 
o_blocks_cou¡
;

1828 i‡(
o_blocks_cou¡
 + 
add
 < 
n_blocks_cou¡
)

1829 
	`pxt4_w¨nög
(
sb
, "will only finish group (%llu blocks, %uÇew)",

1830 
o_blocks_cou¡
 + 
add
,ádd);

1833 
bh
 = 
	`sb_bªad
(
sb
, 
o_blocks_cou¡
 + 
add
 - 1);

1834 i‡(!
bh
) {

1835 
	`pxt4_w¨nög
(
sb
, "can'tÑeadÜast block,Ñesizeáborted");

1836  -
ENOSPC
;

1838 
	`bªl£
(
bh
);

1840 
îr
 = 
	`pxt4_group_exãnd_no_check
(
sb
, 
o_blocks_cou¡
, 
add
);

1841  
îr
;

1842 
	}
}

1845 
	$num_desc_blocks
(
su≥r_block
 *
sb
, 
pxt4_group_t
 
groups
)

1847  (
groups
 + 
	`PXT4_DESC_PER_BLOCK
(
sb
) - 1) / PXT4_DESC_PER_BLOCK(sb);

1848 
	}
}

1855 
	$pxt4_c⁄vît_mëa_bg
(
su≥r_block
 *
sb
, 
öode
 *inode)

1857 
h™dÀ_t
 *
h™dÀ
;

1858 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
sb
);

1859 
pxt4_su≥r_block
 *
es
 = 
sbi
->
s_es
;

1860 
pxt4_öode_öfo
 *
ei
 = 
	`PXT4_I
(
öode
);

1861 
pxt4_fsblk_t
 
ƒ
;

1862 
i
, 
ªt
, 
îr
 = 0;

1863 
¸edôs
 = 1;

1865 
	`pxt4_msg
(
sb
, 
KERN_INFO
, "Converting file systemÅo meta_bg");

1866 i‡(
öode
) {

1867 i‡(
es
->
s_ª£rved_gdt_blocks
) {

1868 
	`pxt4_îr‹
(
sb
, "UnexpectedÇon-zero "

1870  -
EPERM
;

1874 i‡(
öode
->
i_blocks
 !1 << (öode->
i_blkbôs
 -

1875 (9 - 
sbi
->
s_˛u°î_bôs
)))

1876 
övÆid_ªsize_öode
;

1877 
i
 = 0; i < 
PXT4_N_BLOCKS
; i++) {

1878 i‡(
i
 =
PXT4_DIND_BLOCK
) {

1879 i‡(
ei
->
i_d©a
[
i
])

1882 
övÆid_ªsize_öode
;

1884 i‡(
ei
->
i_d©a
[
i
])

1885 
övÆid_ªsize_öode
;

1887 
¸edôs
 += 3;

1890 
h™dÀ
 = 
	`pxt4_jou∫Æ_°¨t_sb
(
sb
, 
PXT4_HT_RESIZE
, 
¸edôs
);

1891 i‡(
	`IS_ERR
(
h™dÀ
))

1892  
	`PTR_ERR
(
h™dÀ
);

1894 
	`BUFFER_TRACE
(
sbi
->
s_sbh
, "get_write_access");

1895 
îr
 = 
	`pxt4_jou∫Æ_gë_wrôe_ac˚ss
(
h™dÀ
, 
sbi
->
s_sbh
);

1896 i‡(
îr
)

1897 
îrout
;

1899 
	`pxt4_˛ór_„©uª_ªsize_öode
(
sb
);

1900 
	`pxt4_£t_„©uª_mëa_bg
(
sb
);

1901 
sbi
->
s_es
->
s_fú°_mëa_bg
 =

1902 
	`˝u_to_À32
(
	`num_desc_blocks
(
sb
, 
sbi
->
s_groups_cou¡
));

1904 
îr
 = 
	`pxt4_h™dÀ_dúty_su≥r
(
h™dÀ
, 
sb
);

1905 i‡(
îr
) {

1906 
	`pxt4_°d_îr‹
(
sb
, 
îr
);

1907 
îrout
;

1910 i‡(
öode
) {

1911 
ƒ
 = 
	`À32_to_˝u
(
ei
->
i_d©a
[
PXT4_DIND_BLOCK
]);

1912 
	`pxt4_‰ì_blocks
(
h™dÀ
, 
öode
, 
NULL
, 
ƒ
, 1,

1913 
PXT4_FREE_BLOCKS_METADATA
 |

1914 
PXT4_FREE_BLOCKS_FORGET
);

1915 
ei
->
i_d©a
[
PXT4_DIND_BLOCK
] = 0;

1916 
öode
->
i_blocks
 = 0;

1918 
îr
 = 
	`pxt4_m¨k_öode_dúty
(
h™dÀ
, 
öode
);

1919 i‡(
îr
)

1920 
	`pxt4_°d_îr‹
(
sb
, 
îr
);

1923 
îrout
:

1924 
ªt
 = 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

1925 i‡(!
îr
)

1926 
îr
 = 
ªt
;

1927  
ªt
;

1929 
övÆid_ªsize_öode
:

1930 
	`pxt4_îr‹
(
sb
, "corrupted/inconsistentÑesize inode");

1931  -
EINVAL
;

1932 
	}
}

1940 
	$pxt4_ªsize_fs
(
su≥r_block
 *
sb
, 
pxt4_fsblk_t
 
n_blocks_cou¡
)

1942 
pxt4_√w_Êex_group_d©a
 *
Êex_gd
 = 
NULL
;

1943 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
sb
);

1944 
pxt4_su≥r_block
 *
es
 = 
sbi
->
s_es
;

1945 
buf„r_hód
 *
bh
;

1946 
öode
 *
ªsize_öode
 = 
NULL
;

1947 
pxt4_gΩblk_t
 
add
, 
off£t
;

1948 
n_desc_blocks
;

1949 
o_desc_blocks
;

1950 
pxt4_group_t
 
o_group
;

1951 
pxt4_group_t
 
n_group
;

1952 
pxt4_fsblk_t
 
o_blocks_cou¡
;

1953 
pxt4_fsblk_t
 
n_blocks_cou¡_ªåy
 = 0;

1954 
œ°_upd©e_time
 = 0;

1955 
îr
 = 0, 
Êexbg_size
 = 1 << 
sbi
->
s_log_groups_≥r_Êex
;

1956 
mëa_bg
;

1959 
bh
 = 
	`sb_bªad
(
sb
, 
n_blocks_cou¡
 - 1);

1960 i‡(!
bh
) {

1961 
	`pxt4_w¨nög
(
sb
, "can'tÑeadÜast block,Ñesizeáborted");

1962  -
ENOSPC
;

1964 
	`bªl£
(
bh
);

1966 
ªåy
:

1967 
o_blocks_cou¡
 = 
	`pxt4_blocks_cou¡
(
es
);

1969 
	`pxt4_msg
(
sb
, 
KERN_INFO
, "resizing filesystem from %llu "

1970 "tÿ%Œu blocks", 
o_blocks_cou¡
, 
n_blocks_cou¡
);

1972 i‡(
n_blocks_cou¡
 < 
o_blocks_cou¡
) {

1974 
	`pxt4_w¨nög
(
sb
, "can't shrink FS -Ñesizeáborted");

1975  -
EINVAL
;

1978 i‡(
n_blocks_cou¡
 =
o_blocks_cou¡
)

1982 
n_group
 = 
	`pxt4_gë_group_numbî
(
sb
, 
n_blocks_cou¡
 - 1);

1983 i‡(
n_group
 >(0xFFFFFFFFUL / 
	`PXT4_INODES_PER_GROUP
(
sb
))) {

1984 
	`pxt4_w¨nög
(
sb
, "resize would cause inodes_count overflow");

1985  -
EINVAL
;

1987 
	`pxt4_gë_group_no_™d_off£t
(
sb
, 
o_blocks_cou¡
 - 1, &
o_group
, &
off£t
);

1989 
n_desc_blocks
 = 
	`num_desc_blocks
(
sb
, 
n_group
 + 1);

1990 
o_desc_blocks
 = 
	`num_desc_blocks
(
sb
, 
sbi
->
s_groups_cou¡
);

1992 
mëa_bg
 = 
	`pxt4_has_„©uª_mëa_bg
(
sb
);

1994 i‡(
	`pxt4_has_„©uª_ªsize_öode
(
sb
)) {

1995 i‡(
mëa_bg
) {

1996 
	`pxt4_îr‹
(
sb
, "resize_inodeánd meta_bgÉnabled "

1998  -
EINVAL
;

2000 i‡(
n_desc_blocks
 > 
o_desc_blocks
 +

2001 
	`À16_to_˝u
(
es
->
s_ª£rved_gdt_blocks
)) {

2002 
n_blocks_cou¡_ªåy
 = 
n_blocks_cou¡
;

2003 
n_desc_blocks
 = 
o_desc_blocks
 +

2004 
	`À16_to_˝u
(
es
->
s_ª£rved_gdt_blocks
);

2005 
n_group
 = 
n_desc_blocks
 * 
	`PXT4_DESC_PER_BLOCK
(
sb
);

2006 
n_blocks_cou¡
 = (
pxt4_fsblk_t
)
n_group
 *

2007 
	`PXT4_BLOCKS_PER_GROUP
(
sb
) +

2008 
	`À32_to_˝u
(
es
->
s_fú°_d©a_block
);

2009 
n_group
--;

2012 i‡(!
ªsize_öode
)

2013 
ªsize_öode
 = 
	`pxt4_igë
(
sb
, 
PXT4_RESIZE_INO
,

2014 
PXT4_IGET_SPECIAL
);

2015 i‡(
	`IS_ERR
(
ªsize_öode
)) {

2016 
	`pxt4_w¨nög
(
sb
, "Error openingÑesize inode");

2017  
	`PTR_ERR
(
ªsize_öode
);

2021 i‡((!
ªsize_öode
 && !
mëa_bg
Ë|| 
n_blocks_cou¡
 =
o_blocks_cou¡
) {

2022 
îr
 = 
	`pxt4_c⁄vît_mëa_bg
(
sb
, 
ªsize_öode
);

2023 i‡(
îr
)

2024 
out
;

2025 i‡(
ªsize_öode
) {

2026 
	`ùut
(
ªsize_öode
);

2027 
ªsize_öode
 = 
NULL
;

2029 i‡(
n_blocks_cou¡_ªåy
) {

2030 
n_blocks_cou¡
 = 
n_blocks_cou¡_ªåy
;

2031 
n_blocks_cou¡_ªåy
 = 0;

2032 
ªåy
;

2043 i‡((
	`pxt4_group_fú°_block_no
(
sb
, 
n_group
) +

2044 
	`pxt4_group_ovîhód_blocks
(
sb
, 
n_group
) + 2 +

2045 
sbi
->
s_ôb_≥r_group
 + sbi->
s_˛u°î_øtio
Ë>
n_blocks_cou¡
) {

2046 
n_blocks_cou¡
 = 
	`pxt4_group_fú°_block_no
(
sb
, 
n_group
);

2047 
n_group
--;

2048 
n_blocks_cou¡_ªåy
 = 0;

2049 i‡(
ªsize_öode
) {

2050 
	`ùut
(
ªsize_öode
);

2051 
ªsize_öode
 = 
NULL
;

2053 
ªåy
;

2057 i‡(
n_group
 =
o_group
)

2058 
add
 = 
n_blocks_cou¡
 - 
o_blocks_cou¡
;

2060 
add
 = 
	`PXT4_C2B
(
sbi
, 
	`PXT4_CLUSTERS_PER_GROUP
(
sb
Ë- (
off£t
 + 1));

2061 i‡(
add
 > 0) {

2062 
îr
 = 
	`pxt4_group_exãnd_no_check
(
sb
, 
o_blocks_cou¡
, 
add
);

2063 i‡(
îr
)

2064 
out
;

2067 i‡(
	`pxt4_blocks_cou¡
(
es
Ë=
n_blocks_cou¡
)

2068 
out
;

2070 
îr
 = 
	`pxt4_Æloc_Êex_bg_¨øy
(
sb
, 
n_group
 + 1);

2071 i‡(
îr
)

2072 
out
;

2074 
îr
 = 
	`pxt4_mb_Æloc_groupöfo
(
sb
, 
n_group
 + 1);

2075 i‡(
îr
)

2076 
out
;

2078 
Êex_gd
 = 
	`Æloc_Êex_gd
(
Êexbg_size
);

2079 i‡(
Êex_gd
 =
NULL
) {

2080 
îr
 = -
ENOMEM
;

2081 
out
;

2087 
	`pxt4_£tup_√xt_Êex_gd
(
sb
, 
Êex_gd
, 
n_blocks_cou¡
,

2088 
Êexbg_size
)) {

2089 i‡(
jiffõs
 - 
œ°_upd©e_time
 > 
HZ
 * 10) {

2090 i‡(
œ°_upd©e_time
)

2091 
	`pxt4_msg
(
sb
, 
KERN_INFO
,

2093 
	`pxt4_blocks_cou¡
(
es
));

2094 
œ°_upd©e_time
 = 
jiffõs
;

2096 i‡(
	`pxt4_Æloc_group_èbÀs
(
sb
, 
Êex_gd
, 
Êexbg_size
) != 0)

2098 
îr
 = 
	`pxt4_Êex_group_add
(
sb
, 
ªsize_öode
, 
Êex_gd
);

2099 i‡(
	`u∆ikñy
(
îr
))

2103 i‡(!
îr
 && 
n_blocks_cou¡_ªåy
) {

2104 
n_blocks_cou¡
 = 
n_blocks_cou¡_ªåy
;

2105 
n_blocks_cou¡_ªåy
 = 0;

2106 
	`‰ì_Êex_gd
(
Êex_gd
);

2107 
Êex_gd
 = 
NULL
;

2108 i‡(
ªsize_öode
) {

2109 
	`ùut
(
ªsize_öode
);

2110 
ªsize_öode
 = 
NULL
;

2112 
ªåy
;

2115 
out
:

2116 i‡(
Êex_gd
)

2117 
	`‰ì_Êex_gd
(
Êex_gd
);

2118 i‡(
ªsize_öode
 !
NULL
)

2119 
	`ùut
(
ªsize_öode
);

2120 i‡(
îr
)

2121 
	`pxt4_w¨nög
(
sb
, "error (%d) occurred during "

2122 "fûêsy°emÑesize", 
îr
);

2123 
	`pxt4_msg
(
sb
, 
KERN_INFO
, "resized filesystemÅo %llu",

2124 
	`pxt4_blocks_cou¡
(
es
));

2125  
îr
;

2126 
	}
}

	@super.c

20 
	~<löux/moduÀ.h
>

21 
	~<löux/°rög.h
>

22 
	~<löux/fs.h
>

23 
	~<löux/time.h
>

24 
	~<löux/vmÆloc.h
>

25 
	~<löux/¶ab.h
>

26 
	~<löux/öô.h
>

27 
	~<löux/blkdev.h
>

28 
	~<löux/backög-dev.h
>

29 
	~<löux/∑r£r.h
>

30 
	~<löux/buf„r_hód.h
>

31 
	~<löux/exp‹tfs.h
>

32 
	~<löux/vfs.h
>

33 
	~<löux/øndom.h
>

34 
	~<löux/mou¡.h
>

35 
	~<löux/«mei.h
>

36 
	~<löux/quŸa›s.h
>

37 
	~<löux/£q_fûe.h
>

38 
	~<löux/˘y≥.h
>

39 
	~<löux/log2.h
>

40 
	~<löux/¸c16.h
>

41 
	~<löux/dax.h
>

42 
	~<löux/˛ónˇche.h
>

43 
	~<löux/uac˚ss.h
>

44 
	~<löux/ivîsi⁄.h
>

45 
	~<löux/unicode.h
>

47 
	~<löux/kthªad.h
>

48 
	~<löux/‰ìzî.h
>

50 
	~"pxt4.h
"

51 
	~"pxt4_exã¡s.h
"

52 
	~"pxt4_jbd3.h
"

53 
	~"x©å.h
"

54 
	~"a˛.h
"

55 
	~"mbÆloc.h
"

56 
	~"fsm≠.h
"

58 
	#CREATE_TRACE_POINTS


	)

59 
	~<åa˚/evíts/pxt4.h
>

61 
pxt4_œzy_öô
 *
	gpxt4_li_öfo
;

62 
muãx
 
	gpxt4_li_mtx
;

63 
øãlimô_°©e
 
	gpxt4_mou¡_msg_øãlimô
;

65 
pxt4_lﬂd_jou∫Æ
(
su≥r_block
 *, 
pxt4_su≥r_block
 *,

66 
jou∫Æ_devnum
);

67 
pxt4_show_›ti⁄s
(
£q_fûe
 *
£q
, 
díåy
 *
roŸ
);

68 
pxt4_commô_su≥r
(
su≥r_block
 *
sb
, 
sync
);

69 
pxt4_m¨k_ªcovîy_com∂ëe
(
su≥r_block
 *
sb
,

70 
pxt4_su≥r_block
 *
es
);

71 
pxt4_˛ór_jou∫Æ_îr
(
su≥r_block
 *
sb
,

72 
pxt4_su≥r_block
 *
es
);

73 
pxt4_sync_fs
(
su≥r_block
 *
sb
, 
waô
);

74 
pxt4_ªmou¡
(
su≥r_block
 *
sb
, *
Êags
, *
d©a
);

75 
pxt4_°©fs
(
díåy
 *díåy, 
k°©fs
 *
buf
);

76 
pxt4_un‰ìze
(
su≥r_block
 *
sb
);

77 
pxt4_‰ìze
(
su≥r_block
 *
sb
);

78 
díåy
 *
pxt4_mou¡
(
fûe_sy°em_ty≥
 *
fs_ty≥
, 
Êags
,

79 c⁄° *
dev_«me
, *
d©a
);

80 
ölöe
 
pxt2_„©uª_£t_ok
(
su≥r_block
 *
sb
);

81 
ölöe
 
ext3_„©uª_£t_ok
(
su≥r_block
 *
sb
);

82 
pxt4_„©uª_£t_ok
(
su≥r_block
 *
sb
, 
ªad⁄ly
);

83 
pxt4_de°roy_œzyöô_thªad
();

84 
pxt4_uƒegi°î_li_ªque°
(
su≥r_block
 *
sb
);

85 
pxt4_˛ór_ªque°_li°
();

86 
öode
 *
pxt4_gë_jou∫Æ_öode
(
su≥r_block
 *
sb
,

87 
jou∫Æ_öum
);

117 #i‡!
deföed
(
CONFIG_EXT2_FS
Ë&& !deföed(
CONFIG_EXT2_FS_MODULE
Ë&& deföed(
CONFIG_PXT4_USE_FOR_EXT2
)

118 
fûe_sy°em_ty≥
 
	gpxt2_fs_ty≥
 = {

119 .
ow√r
 = 
THIS_MODULE
,

120 .
	g«me
 = "pxt2",

121 .
	gmou¡
 = 
pxt4_mou¡
,

122 .
	gkûl_sb
 = 
kûl_block_su≥r
,

123 .
	gfs_Êags
 = 
FS_REQUIRES_DEV
,

125 
MODULE_ALIAS_FS
("pxt2");

126 
MODULE_ALIAS
("pxt2");

127 
	#IS_EXT2_SB
(
sb
Ë((sb)->
s_bdev
->
bd_hﬁdî
 =&
pxt2_fs_ty≥
)

	)

129 
	#IS_EXT2_SB
(
sb
Ë(0)

	)

133 
fûe_sy°em_ty≥
 
	gext3_fs_ty≥
 = {

134 .
ow√r
 = 
THIS_MODULE
,

135 .
	g«me
 = "ext3",

136 .
	gmou¡
 = 
pxt4_mou¡
,

137 .
	gkûl_sb
 = 
kûl_block_su≥r
,

138 .
	gfs_Êags
 = 
FS_REQUIRES_DEV
,

140 
MODULE_ALIAS_FS
("ext3");

141 
MODULE_ALIAS
("ext3");

142 
	#IS_EXT3_SB
(
sb
Ë((sb)->
s_bdev
->
bd_hﬁdî
 =&
ext3_fs_ty≥
)

	)

150 
buf„r_hód
 *

151 
	$pxt4_sb_bªad
(
su≥r_block
 *
sb
, 
£˘‹_t
 
block
, 
›_Êags
)

153 
buf„r_hód
 *
bh
 = 
	`sb_gëblk
(
sb
, 
block
);

155 i‡(
bh
 =
NULL
)

156  
	`ERR_PTR
(-
ENOMEM
);

157 i‡(
	`buf„r_u±od©e
(
bh
))

158  
bh
;

159 
	`Œ_rw_block
(
REQ_OP_READ
, 
REQ_META
 | 
›_Êags
, 1, &
bh
);

160 
	`waô_⁄_buf„r
(
bh
);

161 i‡(
	`buf„r_u±od©e
(
bh
))

162  
bh
;

163 
	`put_bh
(
bh
);

164  
	`ERR_PTR
(-
EIO
);

165 
	}
}

167 
	$pxt4_vîify_csum_ty≥
(
su≥r_block
 *
sb
,

168 
pxt4_su≥r_block
 *
es
)

170 i‡(!
	`pxt4_has_„©uª_mëad©a_csum
(
sb
))

173  
es
->
s_checksum_ty≥
 =
PXT4_CRC32C_CHKSUM
;

174 
	}
}

176 
__À32
 
	$pxt4_su≥rblock_csum
(
su≥r_block
 *
sb
,

177 
pxt4_su≥r_block
 *
es
)

179 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
sb
);

180 
off£t
 = 
	`off£tof
(
pxt4_su≥r_block
, 
s_checksum
);

181 
__u32
 
csum
;

183 
csum
 = 
	`pxt4_chksum
(
sbi
, ~0, (*)
es
, 
off£t
);

185  
	`˝u_to_À32
(
csum
);

186 
	}
}

188 
	$pxt4_su≥rblock_csum_vîify
(
su≥r_block
 *
sb
,

189 
pxt4_su≥r_block
 *
es
)

191 i‡(!
	`pxt4_has_mëad©a_csum
(
sb
))

194  
es
->
s_checksum
 =
	`pxt4_su≥rblock_csum
(
sb
,És);

195 
	}
}

197 
	$pxt4_su≥rblock_csum_£t
(
su≥r_block
 *
sb
)

199 
pxt4_su≥r_block
 *
es
 = 
	`PXT4_SB
(
sb
)->
s_es
;

201 i‡(!
	`pxt4_has_mëad©a_csum
(
sb
))

204 
es
->
s_checksum
 = 
	`pxt4_su≥rblock_csum
(
sb
,És);

205 
	}
}

207 *
	$pxt4_kvmÆloc
(
size_t
 
size
, 
gÂ_t
 
Êags
)

209 *
ªt
;

211 
ªt
 = 
	`kmÆloc
(
size
, 
Êags
 | 
__GFP_NOWARN
);

212 i‡(!
ªt
)

213 
ªt
 = 
	`__vmÆloc
(
size
, 
Êags
, 
PAGE_KERNEL
);

214  
ªt
;

215 
	}
}

217 *
	$pxt4_kvzÆloc
(
size_t
 
size
, 
gÂ_t
 
Êags
)

219 *
ªt
;

221 
ªt
 = 
	`kzÆloc
(
size
, 
Êags
 | 
__GFP_NOWARN
);

222 i‡(!
ªt
)

223 
ªt
 = 
	`__vmÆloc
(
size
, 
Êags
 | 
__GFP_ZERO
, 
PAGE_KERNEL
);

224  
ªt
;

225 
	}
}

227 
pxt4_fsblk_t
 
	$pxt4_block_bôm≠
(
su≥r_block
 *
sb
,

228 
pxt4_group_desc
 *
bg
)

230  
	`À32_to_˝u
(
bg
->
bg_block_bôm≠_lo
) |

231 (
	`PXT4_DESC_SIZE
(
sb
Ë>
PXT4_MIN_DESC_SIZE_64BIT
 ?

232 (
pxt4_fsblk_t
)
	`À32_to_˝u
(
bg
->
bg_block_bôm≠_hi
) << 32 : 0);

233 
	}
}

235 
pxt4_fsblk_t
 
	$pxt4_öode_bôm≠
(
su≥r_block
 *
sb
,

236 
pxt4_group_desc
 *
bg
)

238  
	`À32_to_˝u
(
bg
->
bg_öode_bôm≠_lo
) |

239 (
	`PXT4_DESC_SIZE
(
sb
Ë>
PXT4_MIN_DESC_SIZE_64BIT
 ?

240 (
pxt4_fsblk_t
)
	`À32_to_˝u
(
bg
->
bg_öode_bôm≠_hi
) << 32 : 0);

241 
	}
}

243 
pxt4_fsblk_t
 
	$pxt4_öode_èbÀ
(
su≥r_block
 *
sb
,

244 
pxt4_group_desc
 *
bg
)

246  
	`À32_to_˝u
(
bg
->
bg_öode_èbÀ_lo
) |

247 (
	`PXT4_DESC_SIZE
(
sb
Ë>
PXT4_MIN_DESC_SIZE_64BIT
 ?

248 (
pxt4_fsblk_t
)
	`À32_to_˝u
(
bg
->
bg_öode_èbÀ_hi
) << 32 : 0);

249 
	}
}

251 
__u32
 
	$pxt4_‰ì_group_˛u°îs
(
su≥r_block
 *
sb
,

252 
pxt4_group_desc
 *
bg
)

254  
	`À16_to_˝u
(
bg
->
bg_‰ì_blocks_cou¡_lo
) |

255 (
	`PXT4_DESC_SIZE
(
sb
Ë>
PXT4_MIN_DESC_SIZE_64BIT
 ?

256 (
__u32
)
	`À16_to_˝u
(
bg
->
bg_‰ì_blocks_cou¡_hi
) << 16 : 0);

257 
	}
}

259 
__u32
 
	$pxt4_‰ì_öodes_cou¡
(
su≥r_block
 *
sb
,

260 
pxt4_group_desc
 *
bg
)

262  
	`À16_to_˝u
(
bg
->
bg_‰ì_öodes_cou¡_lo
) |

263 (
	`PXT4_DESC_SIZE
(
sb
Ë>
PXT4_MIN_DESC_SIZE_64BIT
 ?

264 (
__u32
)
	`À16_to_˝u
(
bg
->
bg_‰ì_öodes_cou¡_hi
) << 16 : 0);

265 
	}
}

267 
__u32
 
	$pxt4_u£d_dús_cou¡
(
su≥r_block
 *
sb
,

268 
pxt4_group_desc
 *
bg
)

270  
	`À16_to_˝u
(
bg
->
bg_u£d_dús_cou¡_lo
) |

271 (
	`PXT4_DESC_SIZE
(
sb
Ë>
PXT4_MIN_DESC_SIZE_64BIT
 ?

272 (
__u32
)
	`À16_to_˝u
(
bg
->
bg_u£d_dús_cou¡_hi
) << 16 : 0);

273 
	}
}

275 
__u32
 
	$pxt4_ôabÀ_unu£d_cou¡
(
su≥r_block
 *
sb
,

276 
pxt4_group_desc
 *
bg
)

278  
	`À16_to_˝u
(
bg
->
bg_ôabÀ_unu£d_lo
) |

279 (
	`PXT4_DESC_SIZE
(
sb
Ë>
PXT4_MIN_DESC_SIZE_64BIT
 ?

280 (
__u32
)
	`À16_to_˝u
(
bg
->
bg_ôabÀ_unu£d_hi
) << 16 : 0);

281 
	}
}

283 
	$pxt4_block_bôm≠_£t
(
su≥r_block
 *
sb
,

284 
pxt4_group_desc
 *
bg
, 
pxt4_fsblk_t
 
blk
)

286 
bg
->
bg_block_bôm≠_lo
 = 
	`˝u_to_À32
((
u32
)
blk
);

287 i‡(
	`PXT4_DESC_SIZE
(
sb
Ë>
PXT4_MIN_DESC_SIZE_64BIT
)

288 
bg
->
bg_block_bôm≠_hi
 = 
	`˝u_to_À32
(
blk
 >> 32);

289 
	}
}

291 
	$pxt4_öode_bôm≠_£t
(
su≥r_block
 *
sb
,

292 
pxt4_group_desc
 *
bg
, 
pxt4_fsblk_t
 
blk
)

294 
bg
->
bg_öode_bôm≠_lo
 = 
	`˝u_to_À32
((
u32
)
blk
);

295 i‡(
	`PXT4_DESC_SIZE
(
sb
Ë>
PXT4_MIN_DESC_SIZE_64BIT
)

296 
bg
->
bg_öode_bôm≠_hi
 = 
	`˝u_to_À32
(
blk
 >> 32);

297 
	}
}

299 
	$pxt4_öode_èbÀ_£t
(
su≥r_block
 *
sb
,

300 
pxt4_group_desc
 *
bg
, 
pxt4_fsblk_t
 
blk
)

302 
bg
->
bg_öode_èbÀ_lo
 = 
	`˝u_to_À32
((
u32
)
blk
);

303 i‡(
	`PXT4_DESC_SIZE
(
sb
Ë>
PXT4_MIN_DESC_SIZE_64BIT
)

304 
bg
->
bg_öode_èbÀ_hi
 = 
	`˝u_to_À32
(
blk
 >> 32);

305 
	}
}

307 
	$pxt4_‰ì_group_˛u°îs_£t
(
su≥r_block
 *
sb
,

308 
pxt4_group_desc
 *
bg
, 
__u32
 
cou¡
)

310 
bg
->
bg_‰ì_blocks_cou¡_lo
 = 
	`˝u_to_À16
((
__u16
)
cou¡
);

311 i‡(
	`PXT4_DESC_SIZE
(
sb
Ë>
PXT4_MIN_DESC_SIZE_64BIT
)

312 
bg
->
bg_‰ì_blocks_cou¡_hi
 = 
	`˝u_to_À16
(
cou¡
 >> 16);

313 
	}
}

315 
	$pxt4_‰ì_öodes_£t
(
su≥r_block
 *
sb
,

316 
pxt4_group_desc
 *
bg
, 
__u32
 
cou¡
)

318 
bg
->
bg_‰ì_öodes_cou¡_lo
 = 
	`˝u_to_À16
((
__u16
)
cou¡
);

319 i‡(
	`PXT4_DESC_SIZE
(
sb
Ë>
PXT4_MIN_DESC_SIZE_64BIT
)

320 
bg
->
bg_‰ì_öodes_cou¡_hi
 = 
	`˝u_to_À16
(
cou¡
 >> 16);

321 
	}
}

323 
	$pxt4_u£d_dús_£t
(
su≥r_block
 *
sb
,

324 
pxt4_group_desc
 *
bg
, 
__u32
 
cou¡
)

326 
bg
->
bg_u£d_dús_cou¡_lo
 = 
	`˝u_to_À16
((
__u16
)
cou¡
);

327 i‡(
	`PXT4_DESC_SIZE
(
sb
Ë>
PXT4_MIN_DESC_SIZE_64BIT
)

328 
bg
->
bg_u£d_dús_cou¡_hi
 = 
	`˝u_to_À16
(
cou¡
 >> 16);

329 
	}
}

331 
	$pxt4_ôabÀ_unu£d_£t
(
su≥r_block
 *
sb
,

332 
pxt4_group_desc
 *
bg
, 
__u32
 
cou¡
)

334 
bg
->
bg_ôabÀ_unu£d_lo
 = 
	`˝u_to_À16
((
__u16
)
cou¡
);

335 i‡(
	`PXT4_DESC_SIZE
(
sb
Ë>
PXT4_MIN_DESC_SIZE_64BIT
)

336 
bg
->
bg_ôabÀ_unu£d_hi
 = 
	`˝u_to_À16
(
cou¡
 >> 16);

337 
	}
}

339 
	$__pxt4_upd©e_t°amp
(
__À32
 *
lo
, 
__u8
 *
hi
)

341 
time64_t
 
now
 = 
	`ktime_gë_ªÆ_£c⁄ds
();

343 
now
 = 
	`˛amp_vÆ
(now, 0, (1ull << 40) - 1);

345 *
lo
 = 
	`˝u_to_À32
(
	`lowî_32_bôs
(
now
));

346 *
hi
 = 
	`uµî_32_bôs
(
now
);

347 
	}
}

349 
time64_t
 
	$__pxt4_gë_t°amp
(
__À32
 *
lo
, 
__u8
 *
hi
)

351  ((
time64_t
)(*
hi
Ë<< 32Ë+ 
	`À32_to_˝u
(*
lo
);

352 
	}
}

353 
	#pxt4_upd©e_t°amp
(
es
, 
t°amp
) \

354 
	`__pxt4_upd©e_t°amp
(&(
es
)->
t°amp
, &”s)->t°am∞## 
_hi
)

	)

355 
	#pxt4_gë_t°amp
(
es
, 
t°amp
) \

356 
	`__pxt4_gë_t°amp
(&(
es
)->
t°amp
, &”s)->t°am∞## 
_hi
)

	)

358 
	$__ßve_îr‹_öfo
(
su≥r_block
 *
sb
, c⁄° *
func
,

359 
löe
)

361 
pxt4_su≥r_block
 *
es
 = 
	`PXT4_SB
(
sb
)->
s_es
;

363 
	`PXT4_SB
(
sb
)->
s_mou¡_°©e
 |
PXT4_ERROR_FS
;

364 i‡(
	`bdev_ªad_⁄ly
(
sb
->
s_bdev
))

366 
es
->
s_°©e
 |
	`˝u_to_À16
(
PXT4_ERROR_FS
);

367 
	`pxt4_upd©e_t°amp
(
es
, 
s_œ°_îr‹_time
);

368 
	`°∫˝y
(
es
->
s_œ°_îr‹_func
, 
func
, (es->s_last_error_func));

369 
es
->
s_œ°_îr‹_löe
 = 
	`˝u_to_À32
(
löe
);

370 i‡(!
es
->
s_fú°_îr‹_time
) {

371 
es
->
s_fú°_îr‹_time
 =És->
s_œ°_îr‹_time
;

372 
es
->
s_fú°_îr‹_time_hi
 =És->
s_œ°_îr‹_time_hi
;

373 
	`°∫˝y
(
es
->
s_fú°_îr‹_func
, 
func
,

374 (
es
->
s_fú°_îr‹_func
));

375 
es
->
s_fú°_îr‹_löe
 = 
	`˝u_to_À32
(
löe
);

376 
es
->
s_fú°_îr‹_öo
 =És->
s_œ°_îr‹_öo
;

377 
es
->
s_fú°_îr‹_block
 =És->
s_œ°_îr‹_block
;

383 i‡(!
es
->
s_îr‹_cou¡
)

384 
	`mod_timî
(&
	`PXT4_SB
(
sb
)->
s_îr_ªp‹t
, 
jiffõs
 + 24*60*60*
HZ
);

385 
	`À32_add_˝u
(&
es
->
s_îr‹_cou¡
, 1);

386 
	}
}

388 
	$ßve_îr‹_öfo
(
su≥r_block
 *
sb
, c⁄° *
func
,

389 
löe
)

391 
	`__ßve_îr‹_öfo
(
sb
, 
func
, 
löe
);

392 i‡(!
	`bdev_ªad_⁄ly
(
sb
->
s_bdev
))

393 
	`pxt4_commô_su≥r
(
sb
, 1);

394 
	}
}

404 
	$block_devi˚_eje˘ed
(
su≥r_block
 *
sb
)

406 
öode
 *
bd_öode
 = 
sb
->
s_bdev
->bd_inode;

407 
backög_dev_öfo
 *
bdi
 = 
	`öode_to_bdi
(
bd_öode
);

409  
bdi
->
dev
 =
NULL
;

410 
	}
}

412 
	$pxt4_jou∫Æ_commô_ˇŒback
(
jou∫Æ_t
 *
jou∫Æ
, 
å™ß˘i⁄_t
 *
txn
)

414 
su≥r_block
 *
sb
 = 
jou∫Æ
->
j_¥iv©e
;

415 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
sb
);

416 
îr‹
 = 
	`is_jou∫Æ_ab‹ãd
(
jou∫Æ
);

417 
pxt4_jou∫Æ_cb_íåy
 *
j˚
;

419 
	`BUG_ON
(
txn
->
t_°©e
 =
T_FINISHED
);

421 
	`pxt4_¥o˚ss_‰ìd_d©a
(
sb
, 
txn
->
t_tid
);

423 
	`•ö_lock
(&
sbi
->
s_md_lock
);

424 !
	`li°_em±y
(&
txn
->
t_¥iv©e_li°
)) {

425 
j˚
 = 
	`li°_íåy
(
txn
->
t_¥iv©e_li°
.
√xt
,

426 
pxt4_jou∫Æ_cb_íåy
, 
j˚_li°
);

427 
	`li°_dñ_öô
(&
j˚
->
j˚_li°
);

428 
	`•ö_u∆ock
(&
sbi
->
s_md_lock
);

429 
j˚
->
	`j˚_func
(
sb
, j˚, 
îr‹
);

430 
	`•ö_lock
(&
sbi
->
s_md_lock
);

432 
	`•ö_u∆ock
(&
sbi
->
s_md_lock
);

433 
	}
}

435 
boﬁ
 
	$sy°em_goög_down
()

437  
sy°em_°©e
 =
SYSTEM_HALT
 || sy°em_°©ê=
SYSTEM_POWER_OFF


438 || 
sy°em_°©e
 =
SYSTEM_RESTART
;

439 
	}
}

456 
	$pxt4_h™dÀ_îr‹
(
su≥r_block
 *
sb
)

458 
jou∫Æ_t
 *
jou∫Æ
 = 
	`PXT4_SB
(
sb
)->
s_jou∫Æ
;

460 i‡(
	`ã°_›t
(
sb
, 
WARN_ON_ERROR
))

461 
	`WARN_ON_ONCE
(1);

463 i‡(
	`sb_rd⁄ly
(
sb
Ë|| 
	`ã°_›t
(sb, 
ERRORS_CONT
))

466 
	`PXT4_SB
(
sb
)->
s_mou¡_Êags
 |
PXT4_MF_FS_ABORTED
;

467 i‡(
jou∫Æ
)

468 
	`jbd3_jou∫Æ_ab‹t
(
jou∫Æ
, -
EIO
);

474 i‡(
	`ã°_›t
(
sb
, 
ERRORS_RO
Ë|| 
	`sy°em_goög_down
()) {

475 
	`pxt4_msg
(
sb
, 
KERN_CRIT
, "Remounting filesystemÑead-only");

480 
	`smp_wmb
();

481 
sb
->
s_Êags
 |
SB_RDONLY
;

482 } i‡(
	`ã°_›t
(
sb
, 
ERRORS_PANIC
)) {

483 i‡(
	`PXT4_SB
(
sb
)->
s_jou∫Æ
 &&

484 !(
	`PXT4_SB
(
sb
)->
s_jou∫Æ
->
j_Êags
 & 
JBD3_REC_ERR
))

486 
	`∑nic
("PXT4-fs (device %s):Öanic forcedáfterÉrror\n",

487 
sb
->
s_id
);

489 
	}
}

491 
	#pxt4_îr‹_øãlimô
(
sb
) \

492 
	`___øãlimô
(&(
	`PXT4_SB
(
sb
)->
s_îr_øãlimô_°©e
), \

493 "PXT4-f†îr‹")

	)

495 
	$__pxt4_îr‹
(
su≥r_block
 *
sb
, c⁄° *
fun˘i⁄
,

496 
löe
, c⁄° *
fmt
, ...)

498 
va_f‹m©
 
vaf
;

499 
va_li°
 
¨gs
;

501 i‡(
	`u∆ikñy
(
	`pxt4_f‹˚d_shutdown
(
	`PXT4_SB
(
sb
))))

504 
	`åa˚_pxt4_îr‹
(
sb
, 
fun˘i⁄
, 
löe
);

505 i‡(
	`pxt4_îr‹_øãlimô
(
sb
)) {

506 
	`va_°¨t
(
¨gs
, 
fmt
);

507 
vaf
.
fmt
 = fmt;

508 
vaf
.
va
 = &
¨gs
;

509 
	`¥ötk
(
KERN_CRIT


511 
sb
->
s_id
, 
fun˘i⁄
, 
löe
, 
cuºít
->
comm
, &
vaf
);

512 
	`va_íd
(
¨gs
);

514 
	`ßve_îr‹_öfo
(
sb
, 
fun˘i⁄
, 
löe
);

515 
	`pxt4_h™dÀ_îr‹
(
sb
);

516 
	}
}

518 
	$__pxt4_îr‹_öode
(
öode
 *öode, c⁄° *
fun˘i⁄
,

519 
löe
, 
pxt4_fsblk_t
 
block
,

520 c⁄° *
fmt
, ...)

522 
va_li°
 
¨gs
;

523 
va_f‹m©
 
vaf
;

524 
pxt4_su≥r_block
 *
es
 = 
	`PXT4_SB
(
öode
->
i_sb
)->
s_es
;

526 i‡(
	`u∆ikñy
(
	`pxt4_f‹˚d_shutdown
(
	`PXT4_SB
(
öode
->
i_sb
))))

529 
	`åa˚_pxt4_îr‹
(
öode
->
i_sb
, 
fun˘i⁄
, 
löe
);

530 
es
->
s_œ°_îr‹_öo
 = 
	`˝u_to_À32
(
öode
->
i_öo
);

531 
es
->
s_œ°_îr‹_block
 = 
	`˝u_to_À64
(
block
);

532 i‡(
	`pxt4_îr‹_øãlimô
(
öode
->
i_sb
)) {

533 
	`va_°¨t
(
¨gs
, 
fmt
);

534 
vaf
.
fmt
 = fmt;

535 
vaf
.
va
 = &
¨gs
;

536 i‡(
block
)

537 
	`¥ötk
(
KERN_CRIT
 "PXT4-fsÉrror (device %s): %s:%d: "

539 
öode
->
i_sb
->
s_id
, 
fun˘i⁄
, 
löe
, inode->
i_öo
,

540 
block
, 
cuºít
->
comm
, &
vaf
);

542 
	`¥ötk
(
KERN_CRIT
 "PXT4-fsÉrror (device %s): %s:%d: "

544 
öode
->
i_sb
->
s_id
, 
fun˘i⁄
, 
löe
, inode->
i_öo
,

545 
cuºít
->
comm
, &
vaf
);

546 
	`va_íd
(
¨gs
);

548 
	`ßve_îr‹_öfo
(
öode
->
i_sb
, 
fun˘i⁄
, 
löe
);

549 
	`pxt4_h™dÀ_îr‹
(
öode
->
i_sb
);

550 
	}
}

552 
	$__pxt4_îr‹_fûe
(
fûe
 *fûe, c⁄° *
fun˘i⁄
,

553 
löe
, 
pxt4_fsblk_t
 
block
,

554 c⁄° *
fmt
, ...)

556 
va_li°
 
¨gs
;

557 
va_f‹m©
 
vaf
;

558 
pxt4_su≥r_block
 *
es
;

559 
öode
 *öodê
	`fûe_öode
(
fûe
);

560 
∑th«me
[80], *
∑th
;

562 i‡(
	`u∆ikñy
(
	`pxt4_f‹˚d_shutdown
(
	`PXT4_SB
(
öode
->
i_sb
))))

565 
	`åa˚_pxt4_îr‹
(
öode
->
i_sb
, 
fun˘i⁄
, 
löe
);

566 
es
 = 
	`PXT4_SB
(
öode
->
i_sb
)->
s_es
;

567 
es
->
s_œ°_îr‹_öo
 = 
	`˝u_to_À32
(
öode
->
i_öo
);

568 i‡(
	`pxt4_îr‹_øãlimô
(
öode
->
i_sb
)) {

569 
∑th
 = 
	`fûe_∑th
(
fûe
, 
∑th«me
, (pathname));

570 i‡(
	`IS_ERR
(
∑th
))

571 
∑th
 = "(unknown)";

572 
	`va_°¨t
(
¨gs
, 
fmt
);

573 
vaf
.
fmt
 = fmt;

574 
vaf
.
va
 = &
¨gs
;

575 i‡(
block
)

576 
	`¥ötk
(
KERN_CRIT


579 
öode
->
i_sb
->
s_id
, 
fun˘i⁄
, 
löe
, inode->
i_öo
,

580 
block
, 
cuºít
->
comm
, 
∑th
, &
vaf
);

582 
	`¥ötk
(
KERN_CRIT


585 
öode
->
i_sb
->
s_id
, 
fun˘i⁄
, 
löe
, inode->
i_öo
,

586 
cuºít
->
comm
, 
∑th
, &
vaf
);

587 
	`va_íd
(
¨gs
);

589 
	`ßve_îr‹_öfo
(
öode
->
i_sb
, 
fun˘i⁄
, 
löe
);

590 
	`pxt4_h™dÀ_îr‹
(
öode
->
i_sb
);

591 
	}
}

593 c⁄° *
	$pxt4_decode_îr‹
(
su≥r_block
 *
sb
, 
î∫o
,

594 
nbuf
[16])

596 *
îr°r
 = 
NULL
;

598 
î∫o
) {

599 -
EFSCORRUPTED
:

600 
îr°r
 = "Corrupt filesystem";

602 -
EFSBADCRC
:

603 
îr°r
 = "Filesystem failed CRC";

605 -
EIO
:

606 
îr°r
 = "IO failure";

608 -
ENOMEM
:

609 
îr°r
 = "Out of memory";

611 -
EROFS
:

612 i‡(!
sb
 || (
	`PXT4_SB
(sb)->
s_jou∫Æ
 &&

613 
	`PXT4_SB
(
sb
)->
s_jou∫Æ
->
j_Êags
 & 
JBD3_ABORT
))

614 
îr°r
 = "Journal hasáborted";

616 
îr°r
 = "Readonly filesystem";

622 i‡(
nbuf
) {

624 i‡(
	`¢¥ötf
(
nbuf
, 16, "îr‹ %d", -
î∫o
) >= 0)

625 
îr°r
 = 
nbuf
;

630  
îr°r
;

631 
	}
}

636 
	$__pxt4_°d_îr‹
(
su≥r_block
 *
sb
, c⁄° *
fun˘i⁄
,

637 
löe
, 
î∫o
)

639 
nbuf
[16];

640 c⁄° *
îr°r
;

642 i‡(
	`u∆ikñy
(
	`pxt4_f‹˚d_shutdown
(
	`PXT4_SB
(
sb
))))

648 i‡(
î∫o
 =-
EROFS
 && 
	`jou∫Æ_cuºít_h™dÀ
(Ë=
NULL
 && 
	`sb_rd⁄ly
(
sb
))

651 i‡(
	`pxt4_îr‹_øãlimô
(
sb
)) {

652 
îr°r
 = 
	`pxt4_decode_îr‹
(
sb
, 
î∫o
, 
nbuf
);

653 
	`¥ötk
(
KERN_CRIT
 "PXT4-fsÉrror (device %s) in %s:%d: %s\n",

654 
sb
->
s_id
, 
fun˘i⁄
, 
löe
, 
îr°r
);

657 
	`ßve_îr‹_öfo
(
sb
, 
fun˘i⁄
, 
löe
);

658 
	`pxt4_h™dÀ_îr‹
(
sb
);

659 
	}
}

671 
	$__pxt4_ab‹t
(
su≥r_block
 *
sb
, c⁄° *
fun˘i⁄
,

672 
löe
, c⁄° *
fmt
, ...)

674 
va_f‹m©
 
vaf
;

675 
va_li°
 
¨gs
;

677 i‡(
	`u∆ikñy
(
	`pxt4_f‹˚d_shutdown
(
	`PXT4_SB
(
sb
))))

680 
	`ßve_îr‹_öfo
(
sb
, 
fun˘i⁄
, 
löe
);

681 
	`va_°¨t
(
¨gs
, 
fmt
);

682 
vaf
.
fmt
 = fmt;

683 
vaf
.
va
 = &
¨gs
;

684 
	`¥ötk
(
KERN_CRIT
 "PXT4-fsÉrror (device %s): %s:%d: %pV\n",

685 
sb
->
s_id
, 
fun˘i⁄
, 
löe
, &
vaf
);

686 
	`va_íd
(
¨gs
);

688 i‡(
	`sb_rd⁄ly
(
sb
) == 0) {

689 
	`pxt4_msg
(
sb
, 
KERN_CRIT
, "Remounting filesystemÑead-only");

690 
	`PXT4_SB
(
sb
)->
s_mou¡_Êags
 |
PXT4_MF_FS_ABORTED
;

695 
	`smp_wmb
();

696 
sb
->
s_Êags
 |
SB_RDONLY
;

697 i‡(
	`PXT4_SB
(
sb
)->
s_jou∫Æ
)

698 
	`jbd3_jou∫Æ_ab‹t
(
	`PXT4_SB
(
sb
)->
s_jou∫Æ
, -
EIO
);

699 
	`ßve_îr‹_öfo
(
sb
, 
fun˘i⁄
, 
löe
);

701 i‡(
	`ã°_›t
(
sb
, 
ERRORS_PANIC
Ë&& !
	`sy°em_goög_down
()) {

702 i‡(
	`PXT4_SB
(
sb
)->
s_jou∫Æ
 &&

703 !(
	`PXT4_SB
(
sb
)->
s_jou∫Æ
->
j_Êags
 & 
JBD3_REC_ERR
))

705 
	`∑nic
("PXT4-fsÖanic fromÖreviousÉrror\n");

707 
	}
}

709 
	$__pxt4_msg
(
su≥r_block
 *
sb
,

710 c⁄° *
¥efix
, c⁄° *
fmt
, ...)

712 
va_f‹m©
 
vaf
;

713 
va_li°
 
¨gs
;

715 i‡(!
	`___øãlimô
(&(
	`PXT4_SB
(
sb
)->
s_msg_øãlimô_°©e
), "PXT4-fs"))

718 
	`va_°¨t
(
¨gs
, 
fmt
);

719 
vaf
.
fmt
 = fmt;

720 
vaf
.
va
 = &
¨gs
;

721 
	`¥ötk
("%sPXT4-f†(%s): %pV\n", 
¥efix
, 
sb
->
s_id
, &
vaf
);

722 
	`va_íd
(
¨gs
);

723 
	}
}

725 
	#pxt4_w¨nög_øãlimô
(
sb
) \

726 
	`___øãlimô
(&(
	`PXT4_SB
(
sb
)->
s_w¨nög_øãlimô_°©e
), \

727 "PXT4-f†w¨nög")

	)

729 
	$__pxt4_w¨nög
(
su≥r_block
 *
sb
, c⁄° *
fun˘i⁄
,

730 
löe
, c⁄° *
fmt
, ...)

732 
va_f‹m©
 
vaf
;

733 
va_li°
 
¨gs
;

735 i‡(!
	`pxt4_w¨nög_øãlimô
(
sb
))

738 
	`va_°¨t
(
¨gs
, 
fmt
);

739 
vaf
.
fmt
 = fmt;

740 
vaf
.
va
 = &
¨gs
;

741 
	`¥ötk
(
KERN_WARNING
 "PXT4-fs warning (device %s): %s:%d: %pV\n",

742 
sb
->
s_id
, 
fun˘i⁄
, 
löe
, &
vaf
);

743 
	`va_íd
(
¨gs
);

744 
	}
}

746 
	$__pxt4_w¨nög_öode
(c⁄° 
öode
 *öode, c⁄° *
fun˘i⁄
,

747 
löe
, c⁄° *
fmt
, ...)

749 
va_f‹m©
 
vaf
;

750 
va_li°
 
¨gs
;

752 i‡(!
	`pxt4_w¨nög_øãlimô
(
öode
->
i_sb
))

755 
	`va_°¨t
(
¨gs
, 
fmt
);

756 
vaf
.
fmt
 = fmt;

757 
vaf
.
va
 = &
¨gs
;

758 
	`¥ötk
(
KERN_WARNING
 "PXT4-fs warning (device %s): %s:%d: "

759 "öodê#%lu: comm %s: %pV\n", 
öode
->
i_sb
->
s_id
,

760 
fun˘i⁄
, 
löe
, 
öode
->
i_öo
, 
cuºít
->
comm
, &
vaf
);

761 
	`va_íd
(
¨gs
);

762 
	}
}

764 
	$__pxt4_gΩ_locked_îr‹
(c⁄° *
fun˘i⁄
, 
löe
,

765 
su≥r_block
 *
sb
, 
pxt4_group_t
 
gΩ
,

766 
öo
, 
pxt4_fsblk_t
 
block
,

767 c⁄° *
fmt
, ...)

768 
	$__ªÀa£s
(
bôlock
)

769 
	$__acquúes
(
bôlock
)

771 
va_f‹m©
 
vaf
;

772 
va_li°
 
¨gs
;

773 
pxt4_su≥r_block
 *
es
 = 
	`PXT4_SB
(
sb
)->
s_es
;

775 i‡(
	`u∆ikñy
(
	`pxt4_f‹˚d_shutdown
(
	`PXT4_SB
(
sb
))))

778 
	`åa˚_pxt4_îr‹
(
sb
, 
fun˘i⁄
, 
löe
);

779 
es
->
s_œ°_îr‹_öo
 = 
	`˝u_to_À32
(
öo
);

780 
es
->
s_œ°_îr‹_block
 = 
	`˝u_to_À64
(
block
);

781 
	`__ßve_îr‹_öfo
(
sb
, 
fun˘i⁄
, 
löe
);

783 i‡(
	`pxt4_îr‹_øãlimô
(
sb
)) {

784 
	`va_°¨t
(
¨gs
, 
fmt
);

785 
vaf
.
fmt
 = fmt;

786 
vaf
.
va
 = &
¨gs
;

787 
	`¥ötk
(
KERN_CRIT
 "PXT4-fsÉrror (device %s): %s:%d: group %u, ",

788 
sb
->
s_id
, 
fun˘i⁄
, 
löe
, 
gΩ
);

789 i‡(
öo
)

790 
	`¥ötk
(
KERN_CONT
 "öodê%lu: ", 
öo
);

791 i‡(
block
)

792 
	`¥ötk
(
KERN_CONT
 "block %llu:",

793 (Ë
block
);

794 
	`¥ötk
(
KERN_CONT
 "%pV\n", &
vaf
);

795 
	`va_íd
(
¨gs
);

798 i‡(
	`ã°_›t
(
sb
, 
WARN_ON_ERROR
))

799 
	`WARN_ON_ONCE
(1);

801 i‡(
	`ã°_›t
(
sb
, 
ERRORS_CONT
)) {

802 
	`pxt4_commô_su≥r
(
sb
, 0);

806 
	`pxt4_u∆ock_group
(
sb
, 
gΩ
);

807 
	`pxt4_commô_su≥r
(
sb
, 1);

808 
	`pxt4_h™dÀ_îr‹
(
sb
);

820 
	`pxt4_lock_group
(
sb
, 
gΩ
);

822 
	}
}

824 
	$pxt4_m¨k_group_bôm≠_c‹ru±ed
(
su≥r_block
 *
sb
,

825 
pxt4_group_t
 
group
,

826 
Êags
)

828 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
sb
);

829 
pxt4_group_öfo
 *
gΩ
 = 
	`pxt4_gë_group_öfo
(
sb
, 
group
);

830 
pxt4_group_desc
 *
gdp
 = 
	`pxt4_gë_group_desc
(
sb
, 
group
, 
NULL
);

831 
ªt
;

833 i‡(
Êags
 & 
PXT4_GROUP_INFO_BBITMAP_CORRUPT
) {

834 
ªt
 = 
	`pxt4_ã°_™d_£t_bô
(
PXT4_GROUP_INFO_BBITMAP_CORRUPT_BIT
,

835 &
gΩ
->
bb_°©e
);

836 i‡(!
ªt
)

837 
	`≥r˝u_cou¡î_sub
(&
sbi
->
s_‰ì˛u°îs_cou¡î
,

838 
gΩ
->
bb_‰ì
);

841 i‡(
Êags
 & 
PXT4_GROUP_INFO_IBITMAP_CORRUPT
) {

842 
ªt
 = 
	`pxt4_ã°_™d_£t_bô
(
PXT4_GROUP_INFO_IBITMAP_CORRUPT_BIT
,

843 &
gΩ
->
bb_°©e
);

844 i‡(!
ªt
 && 
gdp
) {

845 
cou¡
;

847 
cou¡
 = 
	`pxt4_‰ì_öodes_cou¡
(
sb
, 
gdp
);

848 
	`≥r˝u_cou¡î_sub
(&
sbi
->
s_‰ìöodes_cou¡î
,

849 
cou¡
);

852 
	}
}

854 
	$pxt4_upd©e_dy«mic_ªv
(
su≥r_block
 *
sb
)

856 
pxt4_su≥r_block
 *
es
 = 
	`PXT4_SB
(
sb
)->
s_es
;

858 i‡(
	`À32_to_˝u
(
es
->
s_ªv_Àvñ
Ë> 
PXT4_GOOD_OLD_REV
)

861 
	`pxt4_w¨nög
(
sb
,

864 
PXT4_DYNAMIC_REV
);

866 
es
->
s_fú°_öo
 = 
	`˝u_to_À32
(
PXT4_GOOD_OLD_FIRST_INO
);

867 
es
->
s_öode_size
 = 
	`˝u_to_À16
(
PXT4_GOOD_OLD_INODE_SIZE
);

868 
es
->
s_ªv_Àvñ
 = 
	`˝u_to_À32
(
PXT4_DYNAMIC_REV
);

877 
	}
}

882 
block_devi˚
 *
	$pxt4_blkdev_gë
(
dev_t
 
dev
, 
su≥r_block
 *
sb
)

884 
block_devi˚
 *
bdev
;

885 
b
[
BDEVNAME_SIZE
];

887 
bdev
 = 
	`blkdev_gë_by_dev
(
dev
, 
FMODE_READ
|
FMODE_WRITE
|
FMODE_EXCL
, 
sb
);

888 i‡(
	`IS_ERR
(
bdev
))

889 
Áû
;

890  
bdev
;

892 
Áû
:

893 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "failedÅo open journal device %s: %ld",

894 
	`__bdev«me
(
dev
, 
b
), 
	`PTR_ERR
(
bdev
));

895  
NULL
;

896 
	}
}

901 
	$pxt4_blkdev_put
(
block_devi˚
 *
bdev
)

903 
	`blkdev_put
(
bdev
, 
FMODE_READ
|
FMODE_WRITE
|
FMODE_EXCL
);

904 
	}
}

906 
	$pxt4_blkdev_ªmove
(
pxt4_sb_öfo
 *
sbi
)

908 
block_devi˚
 *
bdev
;

909 
bdev
 = 
sbi
->
jou∫Æ_bdev
;

910 i‡(
bdev
) {

911 
	`pxt4_blkdev_put
(
bdev
);

912 
sbi
->
jou∫Æ_bdev
 = 
NULL
;

914 
	}
}

916 
ölöe
 
öode
 *
	$‹ph™_li°_íåy
(
li°_hód
 *
l
)

918  &
	`li°_íåy
(
l
, 
pxt4_öode_öfo
, 
i_‹ph™
)->
vfs_öode
;

919 
	}
}

921 
	$dump_‹ph™_li°
(
su≥r_block
 *
sb
, 
pxt4_sb_öfo
 *
sbi
)

923 
li°_hód
 *
l
;

925 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "sb orphan head is %d",

926 
	`À32_to_˝u
(
sbi
->
s_es
->
s_œ°_‹ph™
));

928 
	`¥ötk
(
KERN_ERR
 "sb_info orphanÜist:\n");

929 
	`li°_f‹_óch
(
l
, &
sbi
->
s_‹ph™
) {

930 
öode
 *öodê
	`‹ph™_li°_íåy
(
l
);

931 
	`¥ötk
(
KERN_ERR
 " "

933 
öode
->
i_sb
->
s_id
, inode->
i_öo
, inode,

934 
öode
->
i_mode
, inode->
i_∆ök
,

935 
	`NEXT_ORPHAN
(
öode
));

937 
	}
}

939 #ifde‡
CONFIG_QUOTA


940 
pxt4_quŸa_off
(
su≥r_block
 *
sb
, 
ty≥
);

942 
ölöe
 
	$pxt4_quŸa_off_umou¡
(
su≥r_block
 *
sb
)

944 
ty≥
;

947 
ty≥
 = 0;Åy≥ < 
PXT4_MAXQUOTAS
;Åype++)

948 
	`pxt4_quŸa_off
(
sb
, 
ty≥
);

949 
	}
}

955 
ölöe
 *
	$gë_qf_«me
(
su≥r_block
 *
sb
,

956 
pxt4_sb_öfo
 *
sbi
,

957 
ty≥
)

959  
	`rcu_dîe„ªn˚_¥Ÿe˘ed
(
sbi
->
s_qf_«mes
[
ty≥
],

960 
	`lockdï_is_hñd
(&
sb
->
s_umou¡
));

961 
	}
}

963 
ölöe
 
	$pxt4_quŸa_off_umou¡
(
su≥r_block
 *
sb
)

965 
	}
}

968 
	$pxt4_put_su≥r
(
su≥r_block
 *
sb
)

970 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
sb
);

971 
pxt4_su≥r_block
 *
es
 = 
sbi
->
s_es
;

972 
buf„r_hód
 **
group_desc
;

973 
Êex_groups
 **flex_groups;

974 
ab‹ãd
 = 0;

975 
i
, 
îr
;

977 
	`pxt4_uƒegi°î_li_ªque°
(
sb
);

978 
	`pxt4_quŸa_off_umou¡
(
sb
);

980 
	`de°roy_w‹kqueue
(
sbi
->
rsv_c⁄vîsi⁄_wq
);

982 i‡(
sbi
->
s_jou∫Æ
) {

983 
ab‹ãd
 = 
	`is_jou∫Æ_ab‹ãd
(
sbi
->
s_jou∫Æ
);

984 
îr
 = 
	`jbd3_jou∫Æ_de°roy
(
sbi
->
s_jou∫Æ
);

985 
sbi
->
s_jou∫Æ
 = 
NULL
;

986 i‡((
îr
 < 0Ë&& !
ab‹ãd
)

987 
	`pxt4_ab‹t
(
sb
, "Couldn't clean upÅhe journal");

990 
	`pxt4_uƒegi°î_sysfs
(
sb
);

991 
	`pxt4_es_uƒegi°î_shrökî
(
sbi
);

992 
	`dñ_timî_sync
(&
sbi
->
s_îr_ªp‹t
);

993 
	`pxt4_ªÀa£_sy°em_z⁄e
(
sb
);

994 
	`pxt4_mb_ªÀa£
(
sb
);

995 
	`pxt4_ext_ªÀa£
(
sb
);

997 i‡(!
	`sb_rd⁄ly
(
sb
Ë&& !
ab‹ãd
) {

998 
	`pxt4_˛ór_„©uª_jou∫Æ_√eds_ªcovîy
(
sb
);

999 
es
->
s_°©e
 = 
	`˝u_to_À16
(
sbi
->
s_mou¡_°©e
);

1001 i‡(!
	`sb_rd⁄ly
(
sb
))

1002 
	`pxt4_commô_su≥r
(
sb
, 1);

1004 
	`rcu_ªad_lock
();

1005 
group_desc
 = 
	`rcu_dîe„ªn˚
(
sbi
->
s_group_desc
);

1006 
i
 = 0; i < 
sbi
->
s_gdb_cou¡
; i++)

1007 
	`bªl£
(
group_desc
[
i
]);

1008 
	`kv‰ì
(
group_desc
);

1009 
Êex_groups
 = 
	`rcu_dîe„ªn˚
(
sbi
->
s_Êex_groups
);

1010 i‡(
Êex_groups
) {

1011 
i
 = 0; i < 
sbi
->
s_Êex_groups_Æloˇãd
; i++)

1012 
	`kv‰ì
(
Êex_groups
[
i
]);

1013 
	`kv‰ì
(
Êex_groups
);

1015 
	`rcu_ªad_u∆ock
();

1016 
	`≥r˝u_cou¡î_de°roy
(&
sbi
->
s_‰ì˛u°îs_cou¡î
);

1017 
	`≥r˝u_cou¡î_de°roy
(&
sbi
->
s_‰ìöodes_cou¡î
);

1018 
	`≥r˝u_cou¡î_de°roy
(&
sbi
->
s_dús_cou¡î
);

1019 
	`≥r˝u_cou¡î_de°roy
(&
sbi
->
s_dúty˛u°îs_cou¡î
);

1020 
	`≥r˝u_cou¡î_de°roy
(&
sbi
->
s_§a_ex˚eded_ªåy_limô
);

1021 
	`≥r˝u_‰ì_rw£m
(&
sbi
->
s_wrôïages_rw£m
);

1022 #ifde‡
CONFIG_QUOTA


1023 
i
 = 0; i < 
PXT4_MAXQUOTAS
; i++)

1024 
	`k‰ì
(
	`gë_qf_«me
(
sb
, 
sbi
, 
i
));

1031 i‡(!
	`li°_em±y
(&
sbi
->
s_‹ph™
))

1032 
	`dump_‹ph™_li°
(
sb
, 
sbi
);

1033 
	`J_ASSERT
(
	`li°_em±y
(&
sbi
->
s_‹ph™
));

1035 
	`sync_blockdev
(
sb
->
s_bdev
);

1036 
	`övÆid©e_bdev
(
sb
->
s_bdev
);

1037 i‡(
sbi
->
jou∫Æ_bdev
 && sbi->jou∫Æ_bdev !
sb
->
s_bdev
) {

1043 
	`sync_blockdev
(
sbi
->
jou∫Æ_bdev
);

1044 
	`övÆid©e_bdev
(
sbi
->
jou∫Æ_bdev
);

1045 
	`pxt4_blkdev_ªmove
(
sbi
);

1048 
	`pxt4_x©å_de°roy_ˇche
(
sbi
->
s_ó_öode_ˇche
);

1049 
sbi
->
s_ó_öode_ˇche
 = 
NULL
;

1051 
	`pxt4_x©å_de°roy_ˇche
(
sbi
->
s_ó_block_ˇche
);

1052 
sbi
->
s_ó_block_ˇche
 = 
NULL
;

1054 i‡(
sbi
->
s_mmp_tsk
)

1055 
	`kthªad_°›
(
sbi
->
s_mmp_tsk
);

1056 
	`bªl£
(
sbi
->
s_sbh
);

1057 
sb
->
s_fs_öfo
 = 
NULL
;

1062 
	`kobje˘_put
(&
sbi
->
s_kobj
);

1063 
	`waô_f‹_com∂ëi⁄
(&
sbi
->
s_kobj_uƒegi°î
);

1064 i‡(
sbi
->
s_chksum_drivî
)

1065 
	`¸y±o_‰ì_shash
(
sbi
->
s_chksum_drivî
);

1066 
	`k‰ì
(
sbi
->
s_blockgroup_lock
);

1067 
	`fs_put_dax
(
sbi
->
s_daxdev
);

1068 #ifde‡
CONFIG_UNICODE


1069 
	`utf8_u∆ﬂd
(
sbi
->
s_ícodög
);

1071 
	`k‰ì
(
sbi
);

1072 
	}
}

1074 
kmem_ˇche
 *
	gpxt4_öode_ˇchï
;

1079 
öode
 *
	$pxt4_Æloc_öode
(
su≥r_block
 *
sb
)

1081 
pxt4_öode_öfo
 *
ei
;

1083 
ei
 = 
	`kmem_ˇche_Æloc
(
pxt4_öode_ˇchï
, 
GFP_NOFS
);

1084 i‡(!
ei
)

1085  
NULL
;

1087 
	`öode_£t_ivîsi⁄
(&
ei
->
vfs_öode
, 1);

1088 
	`•ö_lock_öô
(&
ei
->
i_øw_lock
);

1089 
	`INIT_LIST_HEAD
(&
ei
->
i_¥óŒoc_li°
);

1090 
	`•ö_lock_öô
(&
ei
->
i_¥óŒoc_lock
);

1091 
	`pxt4_es_öô_åì
(&
ei
->
i_es_åì
);

1092 
	`rwlock_öô
(&
ei
->
i_es_lock
);

1093 
	`INIT_LIST_HEAD
(&
ei
->
i_es_li°
);

1094 
ei
->
i_es_Æl_ƒ
 = 0;

1095 
ei
->
i_es_shk_ƒ
 = 0;

1096 
ei
->
i_es_shrök_lblk
 = 0;

1097 
ei
->
i_ª£rved_d©a_blocks
 = 0;

1098 
ei
->
i_da_mëad©a_ˇlc_Àn
 = 0;

1099 
ei
->
i_da_mëad©a_ˇlc_œ°_lblock
 = 0;

1100 
	`•ö_lock_öô
(&(
ei
->
i_block_ª£rv©i⁄_lock
));

1101 
	`pxt4_öô_≥ndög_åì
(&
ei
->
i_≥ndög_åì
);

1102 #ifde‡
CONFIG_QUOTA


1103 
ei
->
i_ª£rved_quŸa
 = 0;

1104 
	`mem£t
(&
ei
->
i_dquŸ
, 0, (ei->i_dquot));

1106 
ei
->
jöode
 = 
NULL
;

1107 
	`INIT_LIST_HEAD
(&
ei
->
i_rsv_c⁄vîsi⁄_li°
);

1108 
	`•ö_lock_öô
(&
ei
->
i_com∂ëed_io_lock
);

1109 
ei
->
i_sync_tid
 = 0;

1110 
ei
->
i_d©async_tid
 = 0;

1111 
	`©omic_£t
(&
ei
->
i_unwrôãn
, 0);

1112 
	`INIT_WORK
(&
ei
->
i_rsv_c⁄vîsi⁄_w‹k
, 
pxt4_íd_io_rsv_w‹k
);

1113  &
ei
->
vfs_öode
;

1114 
	}
}

1116 
	$pxt4_dr›_öode
(
öode
 *inode)

1118 
dr›
 = 
	`gíîic_dr›_öode
(
öode
);

1120 i‡(!
dr›
)

1121 
dr›
 = 
	`fs¸y±_dr›_öode
(
öode
);

1123 
	`åa˚_pxt4_dr›_öode
(
öode
, 
dr›
);

1124  
dr›
;

1125 
	}
}

1127 
	$pxt4_‰ì_ö_c‹e_öode
(
öode
 *inode)

1129 
	`fs¸y±_‰ì_öode
(
öode
);

1130 
	`kmem_ˇche_‰ì
(
pxt4_öode_ˇchï
, 
	`PXT4_I
(
öode
));

1131 
	}
}

1133 
	$pxt4_de°roy_öode
(
öode
 *inode)

1135 i‡(!
	`li°_em±y
(&(
	`PXT4_I
(
öode
)->
i_‹ph™
))) {

1136 
	`pxt4_msg
(
öode
->
i_sb
, 
KERN_ERR
,

1138 
öode
->
i_öo
, 
	`PXT4_I
(inode));

1139 
	`¥öt_hex_dump
(
KERN_INFO
, "", 
DUMP_PREFIX_ADDRESS
, 16, 4,

1140 
	`PXT4_I
(
öode
), (
pxt4_öode_öfo
),

1141 
åue
);

1142 
	`dump_°ack
();

1144 
	}
}

1146 
	$öô_⁄˚
(*
foo
)

1148 
pxt4_öode_öfo
 *
ei
 = (pxt4_öode_öfÿ*Ë
foo
;

1150 
	`INIT_LIST_HEAD
(&
ei
->
i_‹ph™
);

1151 
	`öô_rw£m
(&
ei
->
x©å_£m
);

1152 
	`öô_rw£m
(&
ei
->
i_d©a_£m
);

1153 
	`öô_rw£m
(&
ei
->
i_mm≠_£m
);

1154 
	`öode_öô_⁄˚
(&
ei
->
vfs_öode
);

1155 
	}
}

1157 
__öô
 
	$öô_öodeˇche
()

1159 
pxt4_öode_ˇchï
 = 
	`kmem_ˇche_¸óã_u£rc›y
("pxt4_inode_cache",

1160 (
pxt4_öode_öfo
), 0,

1161 (
SLAB_RECLAIM_ACCOUNT
|
SLAB_MEM_SPREAD
|

1162 
SLAB_ACCOUNT
),

1163 
	`off£tof
(
pxt4_öode_öfo
, 
i_d©a
),

1164 
	`sizeof_fõld
(
pxt4_öode_öfo
, 
i_d©a
),

1165 
öô_⁄˚
);

1166 i‡(
pxt4_öode_ˇchï
 =
NULL
)

1167  -
ENOMEM
;

1169 
	}
}

1171 
	$de°roy_öodeˇche
()

1177 
	`rcu_b¨rõr
();

1178 
	`kmem_ˇche_de°roy
(
pxt4_öode_ˇchï
);

1179 
	}
}

1181 
	$pxt4_˛ór_öode
(
öode
 *inode)

1183 
	`övÆid©e_öode_buf„rs
(
öode
);

1184 
	`˛ór_öode
(
öode
);

1185 
	`pxt4_disˇrd_¥óŒoˇti⁄s
(
öode
);

1186 
	`pxt4_es_ªmove_exã¡
(
öode
, 0, 
EXT_MAX_BLOCKS
);

1187 
	`dquŸ_dr›
(
öode
);

1188 i‡(
	`PXT4_I
(
öode
)->
jöode
) {

1189 
	`jbd3_jou∫Æ_ªÀa£_jbd_öode
(
	`PXT4_JOURNAL
(
öode
),

1190 
	`PXT4_I
(
öode
)->
jöode
);

1191 
	`jbd3_‰ì_öode
(
	`PXT4_I
(
öode
)->
jöode
);

1192 
	`PXT4_I
(
öode
)->
jöode
 = 
NULL
;

1194 
	`fs¸y±_put_í¸y±i⁄_öfo
(
öode
);

1195 
	`fsvîôy_˛ónup_öode
(
öode
);

1196 
	}
}

1198 
öode
 *
	$pxt4_nfs_gë_öode
(
su≥r_block
 *
sb
,

1199 
u64
 
öo
, 
u32
 
gíî©i⁄
)

1201 
öode
 *inode;

1207 
öode
 = 
	`pxt4_igë
(
sb
, 
öo
, 
PXT4_IGET_HANDLE
);

1208 i‡(
	`IS_ERR
(
öode
))

1209  
	`ERR_CAST
(
öode
);

1210 i‡(
gíî©i⁄
 && 
öode
->
i_gíî©i⁄
 != generation) {

1211 
	`ùut
(
öode
);

1212  
	`ERR_PTR
(-
ESTALE
);

1215  
öode
;

1216 
	}
}

1218 
díåy
 *
	$pxt4_fh_to_díåy
(
su≥r_block
 *
sb
, 
fid
 *fid,

1219 
fh_Àn
, 
fh_ty≥
)

1221  
	`gíîic_fh_to_díåy
(
sb
, 
fid
, 
fh_Àn
, 
fh_ty≥
,

1222 
pxt4_nfs_gë_öode
);

1223 
	}
}

1225 
díåy
 *
	$pxt4_fh_to_∑ª¡
(
su≥r_block
 *
sb
, 
fid
 *fid,

1226 
fh_Àn
, 
fh_ty≥
)

1228  
	`gíîic_fh_to_∑ª¡
(
sb
, 
fid
, 
fh_Àn
, 
fh_ty≥
,

1229 
pxt4_nfs_gë_öode
);

1230 
	}
}

1232 
	$pxt4_nfs_commô_mëad©a
(
öode
 *inode)

1234 
wrôeback_c⁄åﬁ
 
wbc
 = {

1235 .
sync_mode
 = 
WB_SYNC_ALL


1238 
	`åa˚_pxt4_nfs_commô_mëad©a
(
öode
);

1239  
	`pxt4_wrôe_öode
(
öode
, &
wbc
);

1240 
	}
}

1248 
	$bdev_åy_to_‰ì_∑ge
(
su≥r_block
 *
sb
, 
∑ge
 *page,

1249 
gÂ_t
 
waô
)

1251 
jou∫Æ_t
 *
jou∫Æ
 = 
	`PXT4_SB
(
sb
)->
s_jou∫Æ
;

1253 
	`WARN_ON
(
	`PageChecked
(
∑ge
));

1254 i‡(!
	`∑ge_has_buf„rs
(
∑ge
))

1256 i‡(
jou∫Æ
)

1257  
	`jbd3_jou∫Æ_åy_to_‰ì_buf„rs
(
jou∫Æ
, 
∑ge
,

1258 
waô
 & ~
__GFP_DIRECT_RECLAIM
);

1259  
	`åy_to_‰ì_buf„rs
(
∑ge
);

1260 
	}
}

1262 #ifde‡
CONFIG_FS_ENCRYPTION


1263 
	$pxt4_gë_c⁄ãxt
(
öode
 *öode, *
˘x
, 
size_t
 
Àn
)

1265  
	`pxt4_x©å_gë
(
öode
, 
PXT4_XATTR_INDEX_ENCRYPTION
,

1266 
PXT4_XATTR_NAME_ENCRYPTION_CONTEXT
, 
˘x
, 
Àn
);

1267 
	}
}

1269 
	$pxt4_£t_c⁄ãxt
(
öode
 *öode, c⁄° *
˘x
, 
size_t
 
Àn
,

1270 *
fs_d©a
)

1272 
h™dÀ_t
 *
h™dÀ
 = 
fs_d©a
;

1273 
ªs
, 
ªs2
, 
¸edôs
, 
ªåõs
 = 0;

1281 i‡(
öode
->
i_öo
 =
PXT4_ROOT_INO
)

1282  -
EPERM
;

1284 i‡(
	`WARN_ON_ONCE
(
	`IS_DAX
(
öode
Ë&& 
	`i_size_ªad
(inode)))

1285  -
EINVAL
;

1287 
ªs
 = 
	`pxt4_c⁄vît_ölöe_d©a
(
öode
);

1288 i‡(
ªs
)

1289  
ªs
;

1299 i‡(
h™dÀ
) {

1300 
ªs
 = 
	`pxt4_x©å_£t_h™dÀ
(
h™dÀ
, 
öode
,

1301 
PXT4_XATTR_INDEX_ENCRYPTION
,

1302 
PXT4_XATTR_NAME_ENCRYPTION_CONTEXT
,

1303 
˘x
, 
Àn
, 0);

1304 i‡(!
ªs
) {

1305 
	`pxt4_£t_öode_Êag
(
öode
, 
PXT4_INODE_ENCRYPT
);

1306 
	`pxt4_˛ór_öode_°©e
(
öode
,

1307 
PXT4_STATE_MAY_INLINE_DATA
);

1312 
	`pxt4_£t_öode_Êags
(
öode
);

1314  
ªs
;

1317 
ªs
 = 
	`dquŸ_öôülize
(
öode
);

1318 i‡(
ªs
)

1319  
ªs
;

1320 
ªåy
:

1321 
ªs
 = 
	`pxt4_x©å_£t_¸edôs
(
öode
, 
Àn
, 
Ál£
 ,

1322 &
¸edôs
);

1323 i‡(
ªs
)

1324  
ªs
;

1326 
h™dÀ
 = 
	`pxt4_jou∫Æ_°¨t
(
öode
, 
PXT4_HT_MISC
, 
¸edôs
);

1327 i‡(
	`IS_ERR
(
h™dÀ
))

1328  
	`PTR_ERR
(
h™dÀ
);

1330 
ªs
 = 
	`pxt4_x©å_£t_h™dÀ
(
h™dÀ
, 
öode
, 
PXT4_XATTR_INDEX_ENCRYPTION
,

1331 
PXT4_XATTR_NAME_ENCRYPTION_CONTEXT
,

1332 
˘x
, 
Àn
, 0);

1333 i‡(!
ªs
) {

1334 
	`pxt4_£t_öode_Êag
(
öode
, 
PXT4_INODE_ENCRYPT
);

1339 
	`pxt4_£t_öode_Êags
(
öode
);

1340 
ªs
 = 
	`pxt4_m¨k_öode_dúty
(
h™dÀ
, 
öode
);

1341 i‡(
ªs
)

1342 
	`PXT4_ERROR_INODE
(
öode
, "FailedÅo mark inode dirty");

1344 
ªs2
 = 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

1346 i‡(
ªs
 =-
ENOSPC
 && 
	`pxt4_should_ªåy_Æloc
(
öode
->
i_sb
, &
ªåõs
))

1347 
ªåy
;

1348 i‡(!
ªs
)

1349 
ªs
 = 
ªs2
;

1350  
ªs
;

1351 
	}
}

1353 
boﬁ
 
	$pxt4_dummy_c⁄ãxt
(
öode
 *inode)

1355  
	`DUMMY_ENCRYPTION_ENABLED
(
	`PXT4_SB
(
öode
->
i_sb
));

1356 
	}
}

1358 c⁄° 
fs¸y±_›î©i⁄s
 
	gpxt4_¸y±›s
 = {

1359 .
key_¥efix
 = "pxt4:",

1360 .
	ggë_c⁄ãxt
 = 
pxt4_gë_c⁄ãxt
,

1361 .
	g£t_c⁄ãxt
 = 
pxt4_£t_c⁄ãxt
,

1362 .
	gdummy_c⁄ãxt
 = 
pxt4_dummy_c⁄ãxt
,

1363 .
	gem±y_dú
 = 
pxt4_em±y_dú
,

1364 .
	gmax_«mñí
 = 
PXT4_NAME_LEN
,

1368 #ifde‡
CONFIG_QUOTA


1369 c⁄° * c⁄° 
	gquŸ©y≥s
[] = 
INITQFNAMES
;

1370 
	#QTYPE2NAME
(
t
Ë(
quŸ©y≥s
[t])

	)

1372 
pxt4_wrôe_dquŸ
(
dquŸ
 *dquot);

1373 
pxt4_acquúe_dquŸ
(
dquŸ
 *dquot);

1374 
pxt4_ªÀa£_dquŸ
(
dquŸ
 *dquot);

1375 
pxt4_m¨k_dquŸ_dúty
(
dquŸ
 *dquot);

1376 
pxt4_wrôe_öfo
(
su≥r_block
 *
sb
, 
ty≥
);

1377 
pxt4_quŸa_⁄
(
su≥r_block
 *
sb
, 
ty≥
, 
f‹m©_id
,

1378 c⁄° 
∑th
 *path);

1379 
pxt4_quŸa_⁄_mou¡
(
su≥r_block
 *
sb
, 
ty≥
);

1380 
ssize_t
 
pxt4_quŸa_ªad
(
su≥r_block
 *
sb
, 
ty≥
, *
d©a
,

1381 
size_t
 
Àn
, 
loff_t
 
off
);

1382 
ssize_t
 
pxt4_quŸa_wrôe
(
su≥r_block
 *
sb
, 
ty≥
,

1383 c⁄° *
d©a
, 
size_t
 
Àn
, 
loff_t
 
off
);

1384 
pxt4_quŸa_íabÀ
(
su≥r_block
 *
sb
, 
ty≥
, 
f‹m©_id
,

1385 
Êags
);

1386 
pxt4_íabÀ_quŸas
(
su≥r_block
 *
sb
);

1387 
pxt4_gë_√xt_id
(
su≥r_block
 *
sb
, 
kqid
 *
qid
);

1389 
dquŸ
 **
	$pxt4_gë_dquŸs
(
öode
 *inode)

1391  
	`PXT4_I
(
öode
)->
i_dquŸ
;

1392 
	}
}

1394 c⁄° 
dquŸ_›î©i⁄s
 
	gpxt4_quŸa_›î©i⁄s
 = {

1395 .
gë_ª£rved_•a˚
 = 
pxt4_gë_ª£rved_•a˚
,

1396 .
	gwrôe_dquŸ
 = 
pxt4_wrôe_dquŸ
,

1397 .
	gacquúe_dquŸ
 = 
pxt4_acquúe_dquŸ
,

1398 .
	gªÀa£_dquŸ
 = 
pxt4_ªÀa£_dquŸ
,

1399 .
	gm¨k_dúty
 = 
pxt4_m¨k_dquŸ_dúty
,

1400 .
	gwrôe_öfo
 = 
pxt4_wrôe_öfo
,

1401 .
	gÆloc_dquŸ
 = 
dquŸ_Æloc
,

1402 .
	gde°roy_dquŸ
 = 
dquŸ_de°roy
,

1403 .
	ggë_¥ojid
 = 
pxt4_gë_¥ojid
,

1404 .
	ggë_öode_ußge
 = 
pxt4_gë_öode_ußge
,

1405 .
	ggë_√xt_id
 = 
pxt4_gë_√xt_id
,

1408 c⁄° 
quŸa˘l_›s
 
	gpxt4_q˘l_›î©i⁄s
 = {

1409 .
quŸa_⁄
 = 
pxt4_quŸa_⁄
,

1410 .
	gquŸa_off
 = 
pxt4_quŸa_off
,

1411 .
	gquŸa_sync
 = 
dquŸ_quŸa_sync
,

1412 .
	ggë_°©e
 = 
dquŸ_gë_°©e
,

1413 .
	g£t_öfo
 = 
dquŸ_£t_dqöfo
,

1414 .
	ggë_dqblk
 = 
dquŸ_gë_dqblk
,

1415 .
	g£t_dqblk
 = 
dquŸ_£t_dqblk
,

1416 .
	ggë_√xtdqblk
 = 
dquŸ_gë_√xt_dqblk
,

1420 c⁄° 
su≥r_›î©i⁄s
 
	gpxt4_s›s
 = {

1421 .
Æloc_öode
 = 
pxt4_Æloc_öode
,

1422 .
	g‰ì_öode
 = 
pxt4_‰ì_ö_c‹e_öode
,

1423 .
	gde°roy_öode
 = 
pxt4_de°roy_öode
,

1424 .
	gwrôe_öode
 = 
pxt4_wrôe_öode
,

1425 .
	gdúty_öode
 = 
pxt4_dúty_öode
,

1426 .
	gdr›_öode
 = 
pxt4_dr›_öode
,

1427 .
	gevi˘_öode
 = 
pxt4_evi˘_öode
,

1428 .
	gput_su≥r
 = 
pxt4_put_su≥r
,

1429 .
	gsync_fs
 = 
pxt4_sync_fs
,

1430 .
	g‰ìze_fs
 = 
pxt4_‰ìze
,

1431 .
	gun‰ìze_fs
 = 
pxt4_un‰ìze
,

1432 .
	g°©fs
 = 
pxt4_°©fs
,

1433 .
	gªmou¡_fs
 = 
pxt4_ªmou¡
,

1434 .
	gshow_›ti⁄s
 = 
pxt4_show_›ti⁄s
,

1435 #ifde‡
CONFIG_QUOTA


1436 .
	gquŸa_ªad
 = 
pxt4_quŸa_ªad
,

1437 .
	gquŸa_wrôe
 = 
pxt4_quŸa_wrôe
,

1438 .
	ggë_dquŸs
 = 
pxt4_gë_dquŸs
,

1440 .
	gbdev_åy_to_‰ì_∑ge
 = 
bdev_åy_to_‰ì_∑ge
,

1443 c⁄° 
exp‹t_›î©i⁄s
 
	gpxt4_exp‹t_›s
 = {

1444 .
fh_to_díåy
 = 
pxt4_fh_to_díåy
,

1445 .
	gfh_to_∑ª¡
 = 
pxt4_fh_to_∑ª¡
,

1446 .
	ggë_∑ª¡
 = 
pxt4_gë_∑ª¡
,

1447 .
	gcommô_mëad©a
 = 
pxt4_nfs_commô_mëad©a
,

1451 
	mO±_bsd_df
, 
	mO±_möix_df
, 
	mO±_gΩid
, 
	mO±_nogΩid
,

1452 
	mO±_ªsgid
, 
	mO±_ªsuid
, 
	mO±_sb
, 
	mO±_îr_c⁄t
, 
	mO±_îr_∑nic
, 
	mO±_îr_ro
,

1453 
	mO±_nouid32
, 
	mO±_debug
, 
	mO±_ªmoved
,

1454 
	mO±_u£r_x©å
, 
	mO±_nou£r_x©å
, 
	mO±_a˛
, 
	mO±_nﬂ˛
,

1455 
	mO±_auto_da_Æloc
, 
	mO±_nﬂuto_da_Æloc
, 
	mO±_nﬁﬂd
,

1456 
	mO±_commô
, 
	mO±_mö_b©ch_time
, 
	mO±_max_b©ch_time
, 
	mO±_jou∫Æ_dev
,

1457 
	mO±_jou∫Æ_∑th
, 
	mO±_jou∫Æ_checksum
, 
	mO±_jou∫Æ_async_commô
,

1458 
	mO±_ab‹t
, 
	mO±_d©a_jou∫Æ
, 
	mO±_d©a_‹dîed
, 
	mO±_d©a_wrôeback
,

1459 
	mO±_d©a_îr_ab‹t
, 
	mO±_d©a_îr_ign‹e
, 
	mO±_ã°_dummy_í¸y±i⁄
,

1460 
	mO±_u§jquŸa
, 
	mO±_gΩjquŸa
, 
	mO±_offu§jquŸa
, 
	mO±_offgΩjquŸa
,

1461 
	mO±_jqfmt_vfsﬁd
, 
	mO±_jqfmt_vfsv0
, 
	mO±_jqfmt_vfsv1
, 
	mO±_quŸa
,

1462 
	mO±_noquŸa
, 
	mO±_b¨rõr
, 
	mO±_nob¨rõr
, 
	mO±_îr
,

1463 
	mO±_u§quŸa
, 
	mO±_gΩquŸa
, 
	mO±_¥jquŸa
, 
	mO±_i_vîsi⁄
, 
	mO±_dax
,

1464 
	mO±_°rùe
, 
	mO±_dñÆloc
, 
	mO±_nodñÆloc
, 
	mO±_w¨n_⁄_îr‹
,

1465 
	mO±_now¨n_⁄_îr‹
, 
	mO±_mblk_io_submô
,

1466 
	mO±_œzytime
, 
	mO±_nﬁazytime
, 
	mO±_debug_w™t_exåa_isize
,

1467 
	mO±_nomblk_io_submô
, 
	mO±_block_vÆidôy
, 
	mO±_noblock_vÆidôy
,

1468 
	mO±_öode_ªadahód_blks
, 
	mO±_jou∫Æ_i›rio
,

1469 
	mO±_di‹ód_nﬁock
, 
	mO±_di‹ód_lock
,

1470 
	mO±_disˇrd
, 
	mO±_nodisˇrd
, 
	mO±_öô_ôabÀ
, 
	mO±_noöô_ôabÀ
,

1471 
	mO±_max_dú_size_kb
, 
	mO±_nojou∫Æ_checksum
, 
	mO±_nombˇche
,

1474 c⁄° 
m©ch_èbÀ_t
 
	gtokís
 = {

1475 {
O±_bsd_df
, "bsddf"},

1476 {
O±_möix_df
, "minixdf"},

1477 {
O±_gΩid
, "grpid"},

1478 {
O±_gΩid
, "bsdgroups"},

1479 {
O±_nogΩid
, "nogrpid"},

1480 {
O±_nogΩid
, "sysvgroups"},

1481 {
O±_ªsgid
, "resgid=%u"},

1482 {
O±_ªsuid
, "resuid=%u"},

1483 {
O±_sb
, "sb=%u"},

1484 {
O±_îr_c⁄t
, "errors=continue"},

1485 {
O±_îr_∑nic
, "errors=panic"},

1486 {
O±_îr_ro
, "errors=remount-ro"},

1487 {
O±_nouid32
, "nouid32"},

1488 {
O±_debug
, "debug"},

1489 {
O±_ªmoved
, "oldalloc"},

1490 {
O±_ªmoved
, "orlov"},

1491 {
O±_u£r_x©å
, "user_xattr"},

1492 {
O±_nou£r_x©å
, "nouser_xattr"},

1493 {
O±_a˛
, "acl"},

1494 {
O±_nﬂ˛
, "noacl"},

1495 {
O±_nﬁﬂd
, "norecovery"},

1496 {
O±_nﬁﬂd
, "noload"},

1497 {
O±_ªmoved
, "nobh"},

1498 {
O±_ªmoved
, "bh"},

1499 {
O±_commô
, "commit=%u"},

1500 {
O±_mö_b©ch_time
, "min_batch_time=%u"},

1501 {
O±_max_b©ch_time
, "max_batch_time=%u"},

1502 {
O±_jou∫Æ_dev
, "journal_dev=%u"},

1503 {
O±_jou∫Æ_∑th
, "journal_path=%s"},

1504 {
O±_jou∫Æ_checksum
, "journal_checksum"},

1505 {
O±_nojou∫Æ_checksum
, "nojournal_checksum"},

1506 {
O±_jou∫Æ_async_commô
, "journal_async_commit"},

1507 {
O±_ab‹t
, "abort"},

1508 {
O±_d©a_jou∫Æ
, "data=journal"},

1509 {
O±_d©a_‹dîed
, "data=ordered"},

1510 {
O±_d©a_wrôeback
, "data=writeback"},

1511 {
O±_d©a_îr_ab‹t
, "data_err=abort"},

1512 {
O±_d©a_îr_ign‹e
, "data_err=ignore"},

1513 {
O±_offu§jquŸa
, "usrjquota="},

1514 {
O±_u§jquŸa
, "usrjquota=%s"},

1515 {
O±_offgΩjquŸa
, "grpjquota="},

1516 {
O±_gΩjquŸa
, "grpjquota=%s"},

1517 {
O±_jqfmt_vfsﬁd
, "jqfmt=vfsold"},

1518 {
O±_jqfmt_vfsv0
, "jqfmt=vfsv0"},

1519 {
O±_jqfmt_vfsv1
, "jqfmt=vfsv1"},

1520 {
O±_gΩquŸa
, "grpquota"},

1521 {
O±_noquŸa
, "noquota"},

1522 {
O±_quŸa
, "quota"},

1523 {
O±_u§quŸa
, "usrquota"},

1524 {
O±_¥jquŸa
, "prjquota"},

1525 {
O±_b¨rõr
, "barrier=%u"},

1526 {
O±_b¨rõr
, "barrier"},

1527 {
O±_nob¨rõr
, "nobarrier"},

1528 {
O±_i_vîsi⁄
, "i_version"},

1529 {
O±_dax
, "dax"},

1530 {
O±_°rùe
, "stripe=%u"},

1531 {
O±_dñÆloc
, "delalloc"},

1532 {
O±_w¨n_⁄_îr‹
, "warn_on_error"},

1533 {
O±_now¨n_⁄_îr‹
, "nowarn_on_error"},

1534 {
O±_œzytime
, "lazytime"},

1535 {
O±_nﬁazytime
, "nolazytime"},

1536 {
O±_debug_w™t_exåa_isize
, "debug_want_extra_isize=%u"},

1537 {
O±_nodñÆloc
, "nodelalloc"},

1538 {
O±_ªmoved
, "mblk_io_submit"},

1539 {
O±_ªmoved
, "nomblk_io_submit"},

1540 {
O±_block_vÆidôy
, "block_validity"},

1541 {
O±_noblock_vÆidôy
, "noblock_validity"},

1542 {
O±_öode_ªadahód_blks
, "inode_readahead_blks=%u"},

1543 {
O±_jou∫Æ_i›rio
, "journal_ioprio=%u"},

1544 {
O±_auto_da_Æloc
, "auto_da_alloc=%u"},

1545 {
O±_auto_da_Æloc
, "auto_da_alloc"},

1546 {
O±_nﬂuto_da_Æloc
, "noauto_da_alloc"},

1547 {
O±_di‹ód_nﬁock
, "dioread_nolock"},

1548 {
O±_di‹ód_lock
, "dioread_lock"},

1549 {
O±_disˇrd
, "discard"},

1550 {
O±_nodisˇrd
, "nodiscard"},

1551 {
O±_öô_ôabÀ
, "init_itable=%u"},

1552 {
O±_öô_ôabÀ
, "init_itable"},

1553 {
O±_noöô_ôabÀ
, "noinit_itable"},

1554 {
O±_max_dú_size_kb
, "max_dir_size_kb=%u"},

1555 {
O±_ã°_dummy_í¸y±i⁄
, "test_dummy_encryption"},

1556 {
O±_nombˇche
, "nombcache"},

1557 {
O±_nombˇche
, "no_mbcache"},

1558 {
O±_ªmoved
, "check=none"},

1559 {
O±_ªmoved
, "nocheck"},

1560 {
O±_ªmoved
, "reservation"},

1561 {
O±_ªmoved
, "noreservation"},

1562 {
O±_ªmoved
, "journal=%u"},

1563 {
O±_îr
, 
NULL
},

1566 
pxt4_fsblk_t
 
	$gë_sb_block
(**
d©a
)

1568 
pxt4_fsblk_t
 
sb_block
;

1569 *
›ti⁄s
 = (*Ë*
d©a
;

1571 i‡(!
›ti⁄s
 || 
	`°∫cmp
(options, "sb=", 3) != 0)

1574 
›ti⁄s
 += 3;

1576 
sb_block
 = 
	`sim∂e_°πoul
(
›ti⁄s
, &options, 0);

1577 i‡(*
›ti⁄s
 && *options != ',') {

1578 
	`¥ötk
(
KERN_ERR
 "PXT4-fs: Invalid sb specification: %s\n",

1579 (*Ë*
d©a
);

1582 i‡(*
›ti⁄s
 == ',')

1583 
›ti⁄s
++;

1584 *
d©a
 = (*Ë
›ti⁄s
;

1586  
sb_block
;

1587 
	}
}

1589 
	#DEFAULT_JOURNAL_IOPRIO
 (
	`IOPRIO_PRIO_VALUE
(
IOPRIO_CLASS_BE
, 3))

	)

1590 c⁄° 
	gdïªˇãd_msg
[] =

1594 #ifde‡
CONFIG_QUOTA


1595 
	$£t_qf_«me
(
su≥r_block
 *
sb
, 
qty≥
, 
sub°rög_t
 *
¨gs
)

1597 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
sb
);

1598 *
q«me
, *
ﬁd_q«me
 = 
	`gë_qf_«me
(
sb
, 
sbi
, 
qty≥
);

1599 
ªt
 = -1;

1601 i‡(
	`sb_™y_quŸa_lﬂded
(
sb
Ë&& !
ﬁd_q«me
) {

1602 
	`pxt4_msg
(
sb
, 
KERN_ERR
,

1607 i‡(
	`pxt4_has_„©uª_quŸa
(
sb
)) {

1608 
	`pxt4_msg
(
sb
, 
KERN_INFO
, "Journaled quota options "

1612 
q«me
 = 
	`m©ch_°rdup
(
¨gs
);

1613 i‡(!
q«me
) {

1614 
	`pxt4_msg
(
sb
, 
KERN_ERR
,

1618 i‡(
ﬁd_q«me
) {

1619 i‡(
	`°rcmp
(
ﬁd_q«me
, 
q«me
) == 0)

1620 
ªt
 = 1;

1622 
	`pxt4_msg
(
sb
, 
KERN_ERR
,

1624 
	`QTYPE2NAME
(
qty≥
));

1625 
îrout
;

1627 i‡(
	`°rchr
(
q«me
, '/')) {

1628 
	`pxt4_msg
(
sb
, 
KERN_ERR
,

1630 
îrout
;

1632 
	`rcu_assign_poöãr
(
sbi
->
s_qf_«mes
[
qty≥
], 
q«me
);

1633 
	`£t_›t
(
sb
, 
QUOTA
);

1635 
îrout
:

1636 
	`k‰ì
(
q«me
);

1637  
ªt
;

1638 
	}
}

1640 
	$˛ór_qf_«me
(
su≥r_block
 *
sb
, 
qty≥
)

1643 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
sb
);

1644 *
ﬁd_q«me
 = 
	`gë_qf_«me
(
sb
, 
sbi
, 
qty≥
);

1646 i‡(
	`sb_™y_quŸa_lﬂded
(
sb
Ë&& 
ﬁd_q«me
) {

1647 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "Cannot change journaled quota options"

1651 
	`rcu_assign_poöãr
(
sbi
->
s_qf_«mes
[
qty≥
], 
NULL
);

1652 
	`synchr⁄ize_rcu
();

1653 
	`k‰ì
(
ﬁd_q«me
);

1655 
	}
}

1658 
	#MOPT_SET
 0x0001

	)

1659 
	#MOPT_CLEAR
 0x0002

	)

1660 
	#MOPT_NOSUPPORT
 0x0004

	)

1661 
	#MOPT_EXPLICIT
 0x0008

	)

1662 
	#MOPT_CLEAR_ERR
 0x0010

	)

1663 
	#MOPT_GTE0
 0x0020

	)

1664 #ifde‡
CONFIG_QUOTA


1665 
	#MOPT_Q
 0

	)

1666 
	#MOPT_QFMT
 0x0040

	)

1668 
	#MOPT_Q
 
MOPT_NOSUPPORT


	)

1669 
	#MOPT_QFMT
 
MOPT_NOSUPPORT


	)

1671 
	#MOPT_DATAJ
 0x0080

	)

1672 
	#MOPT_NO_EXT2
 0x0100

	)

1673 
	#MOPT_NO_EXT3
 0x0200

	)

1674 
	#MOPT_PXT4_ONLY
 (
MOPT_NO_EXT2
 | 
MOPT_NO_EXT3
)

	)

1675 
	#MOPT_STRING
 0x0400

	)

1677 c⁄° 
	smou¡_›ts
 {

1678 
	mtokí
;

1679 
	mmou¡_›t
;

1680 
	mÊags
;

1681 } 
	gpxt4_mou¡_›ts
[] = {

1682 {
O±_möix_df
, 
PXT4_MOUNT_MINIX_DF
, 
MOPT_SET
},

1683 {
O±_bsd_df
, 
PXT4_MOUNT_MINIX_DF
, 
MOPT_CLEAR
},

1684 {
O±_gΩid
, 
PXT4_MOUNT_GRPID
, 
MOPT_SET
},

1685 {
O±_nogΩid
, 
PXT4_MOUNT_GRPID
, 
MOPT_CLEAR
},

1686 {
O±_block_vÆidôy
, 
PXT4_MOUNT_BLOCK_VALIDITY
, 
MOPT_SET
},

1687 {
O±_noblock_vÆidôy
, 
PXT4_MOUNT_BLOCK_VALIDITY
, 
MOPT_CLEAR
},

1688 {
O±_di‹ód_nﬁock
, 
PXT4_MOUNT_DIOREAD_NOLOCK
,

1689 
MOPT_PXT4_ONLY
 | 
MOPT_SET
},

1690 {
O±_di‹ód_lock
, 
PXT4_MOUNT_DIOREAD_NOLOCK
,

1691 
MOPT_PXT4_ONLY
 | 
MOPT_CLEAR
},

1692 {
O±_disˇrd
, 
PXT4_MOUNT_DISCARD
, 
MOPT_SET
},

1693 {
O±_nodisˇrd
, 
PXT4_MOUNT_DISCARD
, 
MOPT_CLEAR
},

1694 {
O±_dñÆloc
, 
PXT4_MOUNT_DELALLOC
,

1695 
MOPT_PXT4_ONLY
 | 
MOPT_SET
 | 
MOPT_EXPLICIT
},

1696 {
O±_nodñÆloc
, 
PXT4_MOUNT_DELALLOC
,

1697 
MOPT_PXT4_ONLY
 | 
MOPT_CLEAR
},

1698 {
O±_w¨n_⁄_îr‹
, 
PXT4_MOUNT_WARN_ON_ERROR
, 
MOPT_SET
},

1699 {
O±_now¨n_⁄_îr‹
, 
PXT4_MOUNT_WARN_ON_ERROR
, 
MOPT_CLEAR
},

1700 {
O±_nojou∫Æ_checksum
, 
PXT4_MOUNT_JOURNAL_CHECKSUM
,

1701 
MOPT_PXT4_ONLY
 | 
MOPT_CLEAR
},

1702 {
O±_jou∫Æ_checksum
, 
PXT4_MOUNT_JOURNAL_CHECKSUM
,

1703 
MOPT_PXT4_ONLY
 | 
MOPT_SET
 | 
MOPT_EXPLICIT
},

1704 {
O±_jou∫Æ_async_commô
, (
PXT4_MOUNT_JOURNAL_ASYNC_COMMIT
 |

1705 
PXT4_MOUNT_JOURNAL_CHECKSUM
),

1706 
MOPT_PXT4_ONLY
 | 
MOPT_SET
 | 
MOPT_EXPLICIT
},

1707 {
O±_nﬁﬂd
, 
PXT4_MOUNT_NOLOAD
, 
MOPT_NO_EXT2
 | 
MOPT_SET
},

1708 {
O±_îr_∑nic
, 
PXT4_MOUNT_ERRORS_PANIC
, 
MOPT_SET
 | 
MOPT_CLEAR_ERR
},

1709 {
O±_îr_ro
, 
PXT4_MOUNT_ERRORS_RO
, 
MOPT_SET
 | 
MOPT_CLEAR_ERR
},

1710 {
O±_îr_c⁄t
, 
PXT4_MOUNT_ERRORS_CONT
, 
MOPT_SET
 | 
MOPT_CLEAR_ERR
},

1711 {
O±_d©a_îr_ab‹t
, 
PXT4_MOUNT_DATA_ERR_ABORT
,

1712 
MOPT_NO_EXT2
},

1713 {
O±_d©a_îr_ign‹e
, 
PXT4_MOUNT_DATA_ERR_ABORT
,

1714 
MOPT_NO_EXT2
},

1715 {
O±_b¨rõr
, 
PXT4_MOUNT_BARRIER
, 
MOPT_SET
},

1716 {
O±_nob¨rõr
, 
PXT4_MOUNT_BARRIER
, 
MOPT_CLEAR
},

1717 {
O±_nﬂuto_da_Æloc
, 
PXT4_MOUNT_NO_AUTO_DA_ALLOC
, 
MOPT_SET
},

1718 {
O±_auto_da_Æloc
, 
PXT4_MOUNT_NO_AUTO_DA_ALLOC
, 
MOPT_CLEAR
},

1719 {
O±_noöô_ôabÀ
, 
PXT4_MOUNT_INIT_INODE_TABLE
, 
MOPT_CLEAR
},

1720 {
O±_commô
, 0, 
MOPT_GTE0
},

1721 {
O±_max_b©ch_time
, 0, 
MOPT_GTE0
},

1722 {
O±_mö_b©ch_time
, 0, 
MOPT_GTE0
},

1723 {
O±_öode_ªadahód_blks
, 0, 
MOPT_GTE0
},

1724 {
O±_öô_ôabÀ
, 0, 
MOPT_GTE0
},

1725 {
O±_dax
, 
PXT4_MOUNT_DAX
, 
MOPT_SET
},

1726 {
O±_°rùe
, 0, 
MOPT_GTE0
},

1727 {
O±_ªsuid
, 0, 
MOPT_GTE0
},

1728 {
O±_ªsgid
, 0, 
MOPT_GTE0
},

1729 {
O±_jou∫Æ_dev
, 0, 
MOPT_NO_EXT2
 | 
MOPT_GTE0
},

1730 {
O±_jou∫Æ_∑th
, 0, 
MOPT_NO_EXT2
 | 
MOPT_STRING
},

1731 {
O±_jou∫Æ_i›rio
, 0, 
MOPT_NO_EXT2
 | 
MOPT_GTE0
},

1732 {
O±_d©a_jou∫Æ
, 
PXT4_MOUNT_JOURNAL_DATA
, 
MOPT_NO_EXT2
 | 
MOPT_DATAJ
},

1733 {
O±_d©a_‹dîed
, 
PXT4_MOUNT_ORDERED_DATA
, 
MOPT_NO_EXT2
 | 
MOPT_DATAJ
},

1734 {
O±_d©a_wrôeback
, 
PXT4_MOUNT_WRITEBACK_DATA
,

1735 
MOPT_NO_EXT2
 | 
MOPT_DATAJ
},

1736 {
O±_u£r_x©å
, 
PXT4_MOUNT_XATTR_USER
, 
MOPT_SET
},

1737 {
O±_nou£r_x©å
, 
PXT4_MOUNT_XATTR_USER
, 
MOPT_CLEAR
},

1738 #ifde‡
CONFIG_PXT4_FS_POSIX_ACL


1739 {
O±_a˛
, 
PXT4_MOUNT_POSIX_ACL
, 
MOPT_SET
},

1740 {
O±_nﬂ˛
, 
PXT4_MOUNT_POSIX_ACL
, 
MOPT_CLEAR
},

1742 {
O±_a˛
, 0, 
MOPT_NOSUPPORT
},

1743 {
O±_nﬂ˛
, 0, 
MOPT_NOSUPPORT
},

1745 {
O±_nouid32
, 
PXT4_MOUNT_NO_UID32
, 
MOPT_SET
},

1746 {
O±_debug
, 
PXT4_MOUNT_DEBUG
, 
MOPT_SET
},

1747 {
O±_debug_w™t_exåa_isize
, 0, 
MOPT_GTE0
},

1748 {
O±_quŸa
, 
PXT4_MOUNT_QUOTA
 | 
PXT4_MOUNT_USRQUOTA
, 
MOPT_SET
 | 
MOPT_Q
},

1749 {
O±_u§quŸa
, 
PXT4_MOUNT_QUOTA
 | 
PXT4_MOUNT_USRQUOTA
,

1750 
MOPT_SET
 | 
MOPT_Q
},

1751 {
O±_gΩquŸa
, 
PXT4_MOUNT_QUOTA
 | 
PXT4_MOUNT_GRPQUOTA
,

1752 
MOPT_SET
 | 
MOPT_Q
},

1753 {
O±_¥jquŸa
, 
PXT4_MOUNT_QUOTA
 | 
PXT4_MOUNT_PRJQUOTA
,

1754 
MOPT_SET
 | 
MOPT_Q
},

1755 {
O±_noquŸa
, (
PXT4_MOUNT_QUOTA
 | 
PXT4_MOUNT_USRQUOTA
 |

1756 
PXT4_MOUNT_GRPQUOTA
 | 
PXT4_MOUNT_PRJQUOTA
),

1757 
MOPT_CLEAR
 | 
MOPT_Q
},

1758 {
O±_u§jquŸa
, 0, 
MOPT_Q
 | 
MOPT_STRING
},

1759 {
O±_gΩjquŸa
, 0, 
MOPT_Q
 | 
MOPT_STRING
},

1760 {
O±_offu§jquŸa
, 0, 
MOPT_Q
},

1761 {
O±_offgΩjquŸa
, 0, 
MOPT_Q
},

1762 {
O±_jqfmt_vfsﬁd
, 
QFMT_VFS_OLD
, 
MOPT_QFMT
},

1763 {
O±_jqfmt_vfsv0
, 
QFMT_VFS_V0
, 
MOPT_QFMT
},

1764 {
O±_jqfmt_vfsv1
, 
QFMT_VFS_V1
, 
MOPT_QFMT
},

1765 {
O±_max_dú_size_kb
, 0, 
MOPT_GTE0
},

1766 {
O±_ã°_dummy_í¸y±i⁄
, 0, 
MOPT_GTE0
},

1767 {
O±_nombˇche
, 
PXT4_MOUNT_NO_MBCACHE
, 
MOPT_SET
},

1768 {
O±_îr
, 0, 0}

1771 #ifde‡
CONFIG_UNICODE


1772 c⁄° 
	spxt4_sb_ícodögs
 {

1773 
__u16
 
	mmagic
;

1774 *
	m«me
;

1775 *
	mvîsi⁄
;

1776 } 
	gpxt4_sb_ícodög_m≠
[] = {

1777 {
PXT4_ENC_UTF8_12_1
, "utf8", "12.1.0"},

1780 
	$pxt4_sb_ªad_ícodög
(c⁄° 
pxt4_su≥r_block
 *
es
,

1781 c⁄° 
pxt4_sb_ícodögs
 **
ícodög
,

1782 
__u16
 *
Êags
)

1784 
__u16
 
magic
 = 
	`À16_to_˝u
(
es
->
s_ícodög
);

1785 
i
;

1787 
i
 = 0; i < 
	`ARRAY_SIZE
(
pxt4_sb_ícodög_m≠
); i++)

1788 i‡(
magic
 =
pxt4_sb_ícodög_m≠
[
i
].magic)

1791 i‡(
i
 >
	`ARRAY_SIZE
(
pxt4_sb_ícodög_m≠
))

1792  -
EINVAL
;

1794 *
ícodög
 = &
pxt4_sb_ícodög_m≠
[
i
];

1795 *
Êags
 = 
	`À16_to_˝u
(
es
->
s_ícodög_Êags
);

1798 
	}
}

1801 
	$h™dÀ_mou¡_›t
(
su≥r_block
 *
sb
, *
›t
, 
tokí
,

1802 
sub°rög_t
 *
¨gs
, *
jou∫Æ_devnum
,

1803 *
jou∫Æ_i›rio
, 
is_ªmou¡
)

1805 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
sb
);

1806 c⁄° 
mou¡_›ts
 *
m
;

1807 
kuid_t
 
uid
;

1808 
kgid_t
 
gid
;

1809 
¨g
 = 0;

1811 #ifde‡
CONFIG_QUOTA


1812 i‡(
tokí
 =
O±_u§jquŸa
)

1813  
	`£t_qf_«me
(
sb
, 
USRQUOTA
, &
¨gs
[0]);

1814 i‡(
tokí
 =
O±_gΩjquŸa
)

1815  
	`£t_qf_«me
(
sb
, 
GRPQUOTA
, &
¨gs
[0]);

1816 i‡(
tokí
 =
O±_offu§jquŸa
)

1817  
	`˛ór_qf_«me
(
sb
, 
USRQUOTA
);

1818 i‡(
tokí
 =
O±_offgΩjquŸa
)

1819  
	`˛ór_qf_«me
(
sb
, 
GRPQUOTA
);

1821 
tokí
) {

1822 
O±_nﬂ˛
:

1823 
O±_nou£r_x©å
:

1824 
	`pxt4_msg
(
sb
, 
KERN_WARNING
, 
dïªˇãd_msg
, 
›t
, "3.5");

1826 
O±_sb
:

1828 
O±_ªmoved
:

1829 
	`pxt4_msg
(
sb
, 
KERN_WARNING
, "Ign‹ögÑemoved %†›ti⁄", 
›t
);

1831 
O±_ab‹t
:

1832 
sbi
->
s_mou¡_Êags
 |
PXT4_MF_FS_ABORTED
;

1834 
O±_i_vîsi⁄
:

1835 
sb
->
s_Êags
 |
SB_I_VERSION
;

1837 
O±_œzytime
:

1838 
sb
->
s_Êags
 |
SB_LAZYTIME
;

1840 
O±_nﬁazytime
:

1841 
sb
->
s_Êags
 &~
SB_LAZYTIME
;

1845 
m
 = 
pxt4_mou¡_›ts
; m->
tokí
 !
O±_îr
; m++)

1846 i‡(
tokí
 =
m
->token)

1849 i‡(
m
->
tokí
 =
O±_îr
) {

1850 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "Unrecognized mount option \"%s\" "

1851 "‹ missög vÆue", 
›t
);

1855 i‡((
m
->
Êags
 & 
MOPT_NO_EXT2
Ë&& 
	`IS_EXT2_SB
(
sb
)) {

1856 
	`pxt4_msg
(
sb
, 
KERN_ERR
,

1857 "Mou¡ o±i⁄ \"%s\" incom∑tibÀ wôhÖxt2", 
›t
);

1860 i‡((
m
->
Êags
 & 
MOPT_NO_EXT3
Ë&& 
	`IS_EXT3_SB
(
sb
)) {

1861 
	`pxt4_msg
(
sb
, 
KERN_ERR
,

1862 "Mou¡ o±i⁄ \"%s\" incom∑tibÀ wôhÉxt3", 
›t
);

1866 i‡(
¨gs
->
‰om
 && !(
m
->
Êags
 & 
MOPT_STRING
Ë&& 
	`m©ch_öt
◊rgs, &
¨g
))

1868 i‡(
¨gs
->
‰om
 && (
m
->
Êags
 & 
MOPT_GTE0
Ë&& (
¨g
 < 0))

1870 i‡(
m
->
Êags
 & 
MOPT_EXPLICIT
) {

1871 i‡(
m
->
mou¡_›t
 & 
PXT4_MOUNT_DELALLOC
) {

1872 
	`£t_›t2
(
sb
, 
EXPLICIT_DELALLOC
);

1873 } i‡(
m
->
mou¡_›t
 & 
PXT4_MOUNT_JOURNAL_CHECKSUM
) {

1874 
	`£t_›t2
(
sb
, 
EXPLICIT_JOURNAL_CHECKSUM
);

1878 i‡(
m
->
Êags
 & 
MOPT_CLEAR_ERR
)

1879 
	`˛ór_›t
(
sb
, 
ERRORS_MASK
);

1880 i‡(
tokí
 =
O±_noquŸa
 && 
	`sb_™y_quŸa_lﬂded
(
sb
)) {

1881 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "Cannot change quota "

1886 i‡(
m
->
Êags
 & 
MOPT_NOSUPPORT
) {

1887 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "%†›ti⁄ÇŸ suµ‹ãd", 
›t
);

1888 } i‡(
tokí
 =
O±_commô
) {

1889 i‡(
¨g
 == 0)

1890 
¨g
 = 
JBD3_DEFAULT_MAX_COMMIT_AGE
;

1891 i‡(
¨g
 > 
INT_MAX
 / 
HZ
) {

1892 
	`pxt4_msg
(
sb
, 
KERN_ERR
,

1895 
¨g
, 
INT_MAX
 / 
HZ
);

1898 
sbi
->
s_commô_öãrvÆ
 = 
HZ
 * 
¨g
;

1899 } i‡(
tokí
 =
O±_debug_w™t_exåa_isize
) {

1900 i‡((
¨g
 & 1) ||

1901 (
¨g
 < 4) ||

1902 (
¨g
 > (
sbi
->
s_öode_size
 - 
PXT4_GOOD_OLD_INODE_SIZE
))) {

1903 
	`pxt4_msg
(
sb
, 
KERN_ERR
,

1904 "InvÆid w™t_exåa_isizê%d", 
¨g
);

1907 
sbi
->
s_w™t_exåa_isize
 = 
¨g
;

1908 } i‡(
tokí
 =
O±_max_b©ch_time
) {

1909 
sbi
->
s_max_b©ch_time
 = 
¨g
;

1910 } i‡(
tokí
 =
O±_mö_b©ch_time
) {

1911 
sbi
->
s_mö_b©ch_time
 = 
¨g
;

1912 } i‡(
tokí
 =
O±_öode_ªadahód_blks
) {

1913 i‡(
¨g
 && (¨g > (1 << 30Ë|| !
	`is_powî_of_2
(arg))) {

1914 
	`pxt4_msg
(
sb
, 
KERN_ERR
,

1919 
sbi
->
s_öode_ªadahód_blks
 = 
¨g
;

1920 } i‡(
tokí
 =
O±_öô_ôabÀ
) {

1921 
	`£t_›t
(
sb
, 
INIT_INODE_TABLE
);

1922 i‡(!
¨gs
->
‰om
)

1923 
¨g
 = 
PXT4_DEF_LI_WAIT_MULT
;

1924 
sbi
->
s_li_waô_mu…
 = 
¨g
;

1925 } i‡(
tokí
 =
O±_max_dú_size_kb
) {

1926 
sbi
->
s_max_dú_size_kb
 = 
¨g
;

1927 } i‡(
tokí
 =
O±_°rùe
) {

1928 
sbi
->
s_°rùe
 = 
¨g
;

1929 } i‡(
tokí
 =
O±_ªsuid
) {

1930 
uid
 = 
	`make_kuid
(
	`cuºít_u£r_ns
(), 
¨g
);

1931 i‡(!
	`uid_vÆid
(
uid
)) {

1932 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "InvÆid uid vÆuê%d", 
¨g
);

1935 
sbi
->
s_ªsuid
 = 
uid
;

1936 } i‡(
tokí
 =
O±_ªsgid
) {

1937 
gid
 = 
	`make_kgid
(
	`cuºít_u£r_ns
(), 
¨g
);

1938 i‡(!
	`gid_vÆid
(
gid
)) {

1939 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "InvÆid gid vÆuê%d", 
¨g
);

1942 
sbi
->
s_ªsgid
 = 
gid
;

1943 } i‡(
tokí
 =
O±_jou∫Æ_dev
) {

1944 i‡(
is_ªmou¡
) {

1945 
	`pxt4_msg
(
sb
, 
KERN_ERR
,

1949 *
jou∫Æ_devnum
 = 
¨g
;

1950 } i‡(
tokí
 =
O±_jou∫Æ_∑th
) {

1951 *
jou∫Æ_∑th
;

1952 
öode
 *
jou∫Æ_öode
;

1953 
∑th
Öath;

1954 
îr‹
;

1956 i‡(
is_ªmou¡
) {

1957 
	`pxt4_msg
(
sb
, 
KERN_ERR
,

1961 
jou∫Æ_∑th
 = 
	`m©ch_°rdup
(&
¨gs
[0]);

1962 i‡(!
jou∫Æ_∑th
) {

1963 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "error: couldÇot dup "

1968 
îr‹
 = 
	`kîn_∑th
(
jou∫Æ_∑th
, 
LOOKUP_FOLLOW
, &
∑th
);

1969 i‡(
îr‹
) {

1970 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "error: couldÇot find "

1971 "jou∫Æ devi˚Ö©h:Éº‹ %d", 
îr‹
);

1972 
	`k‰ì
(
jou∫Æ_∑th
);

1976 
jou∫Æ_öode
 = 
	`d_öode
(
∑th
.
díåy
);

1977 i‡(!
	`S_ISBLK
(
jou∫Æ_öode
->
i_mode
)) {

1978 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "error: journalÖath %s "

1979 "i†nŸá block devi˚", 
jou∫Æ_∑th
);

1980 
	`∑th_put
(&
∑th
);

1981 
	`k‰ì
(
jou∫Æ_∑th
);

1985 *
jou∫Æ_devnum
 = 
	`√w_ícode_dev
(
jou∫Æ_öode
->
i_rdev
);

1986 
	`∑th_put
(&
∑th
);

1987 
	`k‰ì
(
jou∫Æ_∑th
);

1988 } i‡(
tokí
 =
O±_jou∫Æ_i›rio
) {

1989 i‡(
¨g
 > 7) {

1990 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "Invalid journal IOÖriority"

1994 *
jou∫Æ_i›rio
 =

1995 
	`IOPRIO_PRIO_VALUE
(
IOPRIO_CLASS_BE
, 
¨g
);

1996 } i‡(
tokí
 =
O±_ã°_dummy_í¸y±i⁄
) {

1997 #ifde‡
CONFIG_FS_ENCRYPTION


1998 
sbi
->
s_mou¡_Êags
 |
PXT4_MF_TEST_DUMMY_ENCRYPTION
;

1999 
	`pxt4_msg
(
sb
, 
KERN_WARNING
,

2002 
	`pxt4_msg
(
sb
, 
KERN_WARNING
,

2005 } i‡(
m
->
Êags
 & 
MOPT_DATAJ
) {

2006 i‡(
is_ªmou¡
) {

2007 i‡(!
sbi
->
s_jou∫Æ
)

2008 
	`pxt4_msg
(
sb
, 
KERN_WARNING
, "Remounting file system withÇo journal so ignoring journalled data option");

2009 i‡(
	`ã°_›t
(
sb
, 
DATA_FLAGS
Ë!
m
->
mou¡_›t
) {

2010 
	`pxt4_msg
(
sb
, 
KERN_ERR
,

2015 
	`˛ór_›t
(
sb
, 
DATA_FLAGS
);

2016 
sbi
->
s_mou¡_›t
 |
m
->
mou¡_›t
;

2018 #ifde‡
CONFIG_QUOTA


2019 } i‡(
m
->
Êags
 & 
MOPT_QFMT
) {

2020 i‡(
	`sb_™y_quŸa_lﬂded
(
sb
) &&

2021 
sbi
->
s_jquŸa_fmt
 !
m
->
mou¡_›t
) {

2022 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "Cannot change journaled "

2026 i‡(
	`pxt4_has_„©uª_quŸa
(
sb
)) {

2027 
	`pxt4_msg
(
sb
, 
KERN_INFO
,

2032 
sbi
->
s_jquŸa_fmt
 = 
m
->
mou¡_›t
;

2034 } i‡(
tokí
 =
O±_dax
) {

2035 #ifde‡
CONFIG_FS_DAX


2036 i‡(
is_ªmou¡
 && 
	`ã°_›t
(
sb
, 
DAX
)) {

2037 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "can't mount with "

2041 i‡(
is_ªmou¡
 && !(
sbi
->
s_mou¡_›t
 & 
PXT4_MOUNT_DAX
)) {

2042 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "can't change "

2046 
	`pxt4_msg
(
sb
, 
KERN_WARNING
,

2048 
sbi
->
s_mou¡_›t
 |
m
->
mou¡_›t
;

2050 
	`pxt4_msg
(
sb
, 
KERN_INFO
, "dax optionÇot supported");

2053 } i‡(
tokí
 =
O±_d©a_îr_ab‹t
) {

2054 
sbi
->
s_mou¡_›t
 |
m
->
mou¡_›t
;

2055 } i‡(
tokí
 =
O±_d©a_îr_ign‹e
) {

2056 
sbi
->
s_mou¡_›t
 &~
m
->
mou¡_›t
;

2058 i‡(!
¨gs
->
‰om
)

2059 
¨g
 = 1;

2060 i‡(
m
->
Êags
 & 
MOPT_CLEAR
)

2061 
¨g
 = !arg;

2062 i‡(
	`u∆ikñy
(!(
m
->
Êags
 & 
MOPT_SET
))) {

2063 
	`pxt4_msg
(
sb
, 
KERN_WARNING
,

2064 "buggy h™dlög o‡›ti⁄ %s", 
›t
);

2065 
	`WARN_ON
(1);

2068 i‡(
¨g
 != 0)

2069 
sbi
->
s_mou¡_›t
 |
m
->
mou¡_›t
;

2071 
sbi
->
s_mou¡_›t
 &~
m
->
mou¡_›t
;

2074 
	}
}

2076 
	$∑r£_›ti⁄s
(*
›ti⁄s
, 
su≥r_block
 *
sb
,

2077 *
jou∫Æ_devnum
,

2078 *
jou∫Æ_i›rio
,

2079 
is_ªmou¡
)

2081 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
sb
);

2082 *
p
, 
__maybe_unu£d
 *
u§_qf_«me
, __maybe_unu£d *
gΩ_qf_«me
;

2083 
sub°rög_t
 
¨gs
[
MAX_OPT_ARGS
];

2084 
tokí
;

2086 i‡(!
›ti⁄s
)

2089 (
p
 = 
	`°r£p
(&
›ti⁄s
, ",")Ë!
NULL
) {

2090 i‡(!*
p
)

2096 
¨gs
[0].
to
 =árgs[0].
‰om
 = 
NULL
;

2097 
tokí
 = 
	`m©ch_tokí
(
p
, 
tokís
, 
¨gs
);

2098 i‡(
	`h™dÀ_mou¡_›t
(
sb
, 
p
, 
tokí
, 
¨gs
, 
jou∫Æ_devnum
,

2099 
jou∫Æ_i›rio
, 
is_ªmou¡
) < 0)

2102 #ifde‡
CONFIG_QUOTA


2108 i‡(
	`ã°_›t
(
sb
, 
PRJQUOTA
Ë&& !
	`pxt4_has_„©uª_¥oje˘
(sb)) {

2109 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "Project quota featureÇotÉnabled. "

2113 
u§_qf_«me
 = 
	`gë_qf_«me
(
sb
, 
sbi
, 
USRQUOTA
);

2114 
gΩ_qf_«me
 = 
	`gë_qf_«me
(
sb
, 
sbi
, 
GRPQUOTA
);

2115 i‡(
u§_qf_«me
 || 
gΩ_qf_«me
) {

2116 i‡(
	`ã°_›t
(
sb
, 
USRQUOTA
Ë&& 
u§_qf_«me
)

2117 
	`˛ór_›t
(
sb
, 
USRQUOTA
);

2119 i‡(
	`ã°_›t
(
sb
, 
GRPQUOTA
Ë&& 
gΩ_qf_«me
)

2120 
	`˛ór_›t
(
sb
, 
GRPQUOTA
);

2122 i‡(
	`ã°_›t
(
sb
, 
GRPQUOTA
Ë||Åe°_›t(sb, 
USRQUOTA
)) {

2123 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "oldándÇew quota "

2128 i‡(!
sbi
->
s_jquŸa_fmt
) {

2129 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "journaled quota format "

2135 i‡(
	`ã°_›t
(
sb
, 
DIOREAD_NOLOCK
)) {

2136 
blocksize
 =

2137 
BLOCK_SIZE
 << 
	`À32_to_˝u
(
sbi
->
s_es
->
s_log_block_size
);

2139 i‡(
blocksize
 < 
PAGE_SIZE
) {

2140 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "can't mount with "

2146 
	}
}

2148 
ölöe
 
	$pxt4_show_quŸa_›ti⁄s
(
£q_fûe
 *
£q
,

2149 
su≥r_block
 *
sb
)

2151 #i‡
	`deföed
(
CONFIG_QUOTA
)

2152 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
sb
);

2153 *
u§_qf_«me
, *
gΩ_qf_«me
;

2155 i‡(
sbi
->
s_jquŸa_fmt
) {

2156 *
fmäame
 = "";

2158 
sbi
->
s_jquŸa_fmt
) {

2159 
QFMT_VFS_OLD
:

2160 
fmäame
 = "vfsold";

2162 
QFMT_VFS_V0
:

2163 
fmäame
 = "vfsv0";

2165 
QFMT_VFS_V1
:

2166 
fmäame
 = "vfsv1";

2169 
	`£q_¥ötf
(
£q
, ",jqfmt=%s", 
fmäame
);

2172 
	`rcu_ªad_lock
();

2173 
u§_qf_«me
 = 
	`rcu_dîe„ªn˚
(
sbi
->
s_qf_«mes
[
USRQUOTA
]);

2174 
gΩ_qf_«me
 = 
	`rcu_dîe„ªn˚
(
sbi
->
s_qf_«mes
[
GRPQUOTA
]);

2175 i‡(
u§_qf_«me
)

2176 
	`£q_show_›ti⁄
(
£q
, "u§jquŸa", 
u§_qf_«me
);

2177 i‡(
gΩ_qf_«me
)

2178 
	`£q_show_›ti⁄
(
£q
, "gΩjquŸa", 
gΩ_qf_«me
);

2179 
	`rcu_ªad_u∆ock
();

2181 
	}
}

2183 c⁄° *
	$tokí2°r
(
tokí
)

2185 c⁄° 
m©ch_tokí
 *
t
;

2187 
t
 = 
tokís
;Å->
tokí
 !
O±_îr
;Å++)

2188 i‡(
t
->
tokí
 =tokí && !
	`°rchr
—->
∑âîn
, '='))

2190  
t
->
∑âîn
;

2191 
	}
}

2198 
	$_pxt4_show_›ti⁄s
(
£q_fûe
 *
£q
, 
su≥r_block
 *
sb
,

2199 
nodefs
)

2201 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
sb
);

2202 
pxt4_su≥r_block
 *
es
 = 
sbi
->
s_es
;

2203 
def_îr‹s
, 
def_mou¡_›t
 = 
sbi
->
s_def_mou¡_›t
;

2204 c⁄° 
mou¡_›ts
 *
m
;

2205 
£p
 = 
nodefs
 ? '\n' : ',';

2207 
	#SEQ_OPTS_PUTS
(
°r
Ë
	`£q_¥ötf
(
£q
, "%c" så, 
£p
)

	)

2208 
	#SEQ_OPTS_PRINT
(
°r
, 
¨g
Ë
	`£q_¥ötf
(
£q
, "%c" så, 
£p
,árg)

	)

2210 i‡(
sbi
->
s_sb_block
 != 1)

2211 
	`SEQ_OPTS_PRINT
("sb=%Œu", 
sbi
->
s_sb_block
);

2213 
m
 = 
pxt4_mou¡_›ts
; m->
tokí
 !
O±_îr
; m++) {

2214 
w™t_£t
 = 
m
->
Êags
 & 
MOPT_SET
;

2215 i‡(((
m
->
Êags
 & (
MOPT_SET
|
MOPT_CLEAR
)) == 0) ||

2216 (
m
->
Êags
 & 
MOPT_CLEAR_ERR
))

2218 i‡(!
nodefs
 && !(
m
->
mou¡_›t
 & (
sbi
->
s_mou¡_›t
 ^ 
def_mou¡_›t
)))

2220 i‡((
w™t_£t
 &&

2221 (
sbi
->
s_mou¡_›t
 & 
m
->
mou¡_›t
) != m->mount_opt) ||

2222 (!
w™t_£t
 && (
sbi
->
s_mou¡_›t
 & 
m
->
mou¡_›t
)))

2224 
	`SEQ_OPTS_PRINT
("%s", 
	`tokí2°r
(
m
->
tokí
));

2227 i‡(
nodefs
 || !
	`uid_eq
(
sbi
->
s_ªsuid
, 
	`make_kuid
(&
öô_u£r_ns
, 
PXT4_DEF_RESUID
)) ||

2228 
	`À16_to_˝u
(
es
->
s_def_ªsuid
Ë!
PXT4_DEF_RESUID
)

2229 
	`SEQ_OPTS_PRINT
("resuid=%u",

2230 
	`‰om_kuid_munged
(&
öô_u£r_ns
, 
sbi
->
s_ªsuid
));

2231 i‡(
nodefs
 || !
	`gid_eq
(
sbi
->
s_ªsgid
, 
	`make_kgid
(&
öô_u£r_ns
, 
PXT4_DEF_RESGID
)) ||

2232 
	`À16_to_˝u
(
es
->
s_def_ªsgid
Ë!
PXT4_DEF_RESGID
)

2233 
	`SEQ_OPTS_PRINT
("resgid=%u",

2234 
	`‰om_kgid_munged
(&
öô_u£r_ns
, 
sbi
->
s_ªsgid
));

2235 
def_îr‹s
 = 
nodefs
 ? -1 : 
	`À16_to_˝u
(
es
->
s_îr‹s
);

2236 i‡(
	`ã°_›t
(
sb
, 
ERRORS_RO
Ë&& 
def_îr‹s
 !
PXT4_ERRORS_RO
)

2237 
	`SEQ_OPTS_PUTS
("errors=remount-ro");

2238 i‡(
	`ã°_›t
(
sb
, 
ERRORS_CONT
Ë&& 
def_îr‹s
 !
PXT4_ERRORS_CONTINUE
)

2239 
	`SEQ_OPTS_PUTS
("errors=continue");

2240 i‡(
	`ã°_›t
(
sb
, 
ERRORS_PANIC
Ë&& 
def_îr‹s
 !
PXT4_ERRORS_PANIC
)

2241 
	`SEQ_OPTS_PUTS
("errors=panic");

2242 i‡(
nodefs
 || 
sbi
->
s_commô_öãrvÆ
 !
JBD3_DEFAULT_MAX_COMMIT_AGE
*
HZ
)

2243 
	`SEQ_OPTS_PRINT
("commô=%lu", 
sbi
->
s_commô_öãrvÆ
 / 
HZ
);

2244 i‡(
nodefs
 || 
sbi
->
s_mö_b©ch_time
 !
PXT4_DEF_MIN_BATCH_TIME
)

2245 
	`SEQ_OPTS_PRINT
("mö_b©ch_time=%u", 
sbi
->
s_mö_b©ch_time
);

2246 i‡(
nodefs
 || 
sbi
->
s_max_b©ch_time
 !
PXT4_DEF_MAX_BATCH_TIME
)

2247 
	`SEQ_OPTS_PRINT
("max_b©ch_time=%u", 
sbi
->
s_max_b©ch_time
);

2248 i‡(
sb
->
s_Êags
 & 
SB_I_VERSION
)

2249 
	`SEQ_OPTS_PUTS
("i_version");

2250 i‡(
nodefs
 || 
sbi
->
s_°rùe
)

2251 
	`SEQ_OPTS_PRINT
("°rùe=%lu", 
sbi
->
s_°rùe
);

2252 i‡(
nodefs
 || 
PXT4_MOUNT_DATA_FLAGS
 &

2253 (
sbi
->
s_mou¡_›t
 ^ 
def_mou¡_›t
)) {

2254 i‡(
	`ã°_›t
(
sb
, 
DATA_FLAGS
Ë=
PXT4_MOUNT_JOURNAL_DATA
)

2255 
	`SEQ_OPTS_PUTS
("data=journal");

2256 i‡(
	`ã°_›t
(
sb
, 
DATA_FLAGS
Ë=
PXT4_MOUNT_ORDERED_DATA
)

2257 
	`SEQ_OPTS_PUTS
("data=ordered");

2258 i‡(
	`ã°_›t
(
sb
, 
DATA_FLAGS
Ë=
PXT4_MOUNT_WRITEBACK_DATA
)

2259 
	`SEQ_OPTS_PUTS
("data=writeback");

2261 i‡(
nodefs
 ||

2262 
sbi
->
s_öode_ªadahód_blks
 !
PXT4_DEF_INODE_READAHEAD_BLKS
)

2263 
	`SEQ_OPTS_PRINT
("inode_readahead_blks=%u",

2264 
sbi
->
s_öode_ªadahód_blks
);

2266 i‡(
	`ã°_›t
(
sb
, 
INIT_INODE_TABLE
Ë&& (
nodefs
 ||

2267 (
sbi
->
s_li_waô_mu…
 !
PXT4_DEF_LI_WAIT_MULT
)))

2268 
	`SEQ_OPTS_PRINT
("öô_ôabÀ=%u", 
sbi
->
s_li_waô_mu…
);

2269 i‡(
nodefs
 || 
sbi
->
s_max_dú_size_kb
)

2270 
	`SEQ_OPTS_PRINT
("max_dú_size_kb=%u", 
sbi
->
s_max_dú_size_kb
);

2271 i‡(
	`ã°_›t
(
sb
, 
DATA_ERR_ABORT
))

2272 
	`SEQ_OPTS_PUTS
("data_err=abort");

2273 i‡(
	`DUMMY_ENCRYPTION_ENABLED
(
sbi
))

2274 
	`SEQ_OPTS_PUTS
("test_dummy_encryption");

2276 
	`pxt4_show_quŸa_›ti⁄s
(
£q
, 
sb
);

2278 
	}
}

2280 
	$pxt4_show_›ti⁄s
(
£q_fûe
 *
£q
, 
díåy
 *
roŸ
)

2282  
	`_pxt4_show_›ti⁄s
(
£q
, 
roŸ
->
d_sb
, 0);

2283 
	}
}

2285 
	$pxt4_£q_›ti⁄s_show
(
£q_fûe
 *
£q
, *
off£t
)

2287 
su≥r_block
 *
sb
 = 
£q
->
¥iv©e
;

2288 
rc
;

2290 
	`£q_puts
(
£q
, 
	`sb_rd⁄ly
(
sb
) ? "ro" : "rw");

2291 
rc
 = 
	`_pxt4_show_›ti⁄s
(
£q
, 
sb
, 1);

2292 
	`£q_puts
(
£q
, "\n");

2293  
rc
;

2294 
	}
}

2296 
	$pxt4_£tup_su≥r
(
su≥r_block
 *
sb
, 
pxt4_su≥r_block
 *
es
,

2297 
ªad_⁄ly
)

2299 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
sb
);

2300 
îr
 = 0;

2302 i‡(
	`À32_to_˝u
(
es
->
s_ªv_Àvñ
Ë> 
PXT4_MAX_SUPP_REV
) {

2303 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "revisionÜevelÅoo high, "

2305 
îr
 = -
EROFS
;

2306 
d⁄e
;

2308 i‡(
ªad_⁄ly
)

2309 
d⁄e
;

2310 i‡(!(
sbi
->
s_mou¡_°©e
 & 
PXT4_VALID_FS
))

2311 
	`pxt4_msg
(
sb
, 
KERN_WARNING
, "warning: mounting unchecked fs, "

2313 i‡(
sbi
->
s_mou¡_°©e
 & 
PXT4_ERROR_FS
)

2314 
	`pxt4_msg
(
sb
, 
KERN_WARNING
,

2317 i‡((
__s16
Ë
	`À16_to_˝u
(
es
->
s_max_m¡_cou¡
) > 0 &&

2318 
	`À16_to_˝u
(
es
->
s_m¡_cou¡
) >=

2319 (Ë(
__s16
Ë
	`À16_to_˝u
(
es
->
s_max_m¡_cou¡
))

2320 
	`pxt4_msg
(
sb
, 
KERN_WARNING
,

2323 i‡(
	`À32_to_˝u
(
es
->
s_checköãrvÆ
) &&

2324 (
	`pxt4_gë_t°amp
(
es
, 
s_œ°check
) +

2325 
	`À32_to_˝u
(
es
->
s_checköãrvÆ
Ë<
	`ktime_gë_ªÆ_£c⁄ds
()))

2326 
	`pxt4_msg
(
sb
, 
KERN_WARNING
,

2329 i‡(!
sbi
->
s_jou∫Æ
)

2330 
es
->
s_°©e
 &
	`˝u_to_À16
(~
PXT4_VALID_FS
);

2331 i‡(!(
__s16
Ë
	`À16_to_˝u
(
es
->
s_max_m¡_cou¡
))

2332 
es
->
s_max_m¡_cou¡
 = 
	`˝u_to_À16
(
PXT4_DFL_MAX_MNT_COUNT
);

2333 
	`À16_add_˝u
(&
es
->
s_m¡_cou¡
, 1);

2334 
	`pxt4_upd©e_t°amp
(
es
, 
s_mtime
);

2335 i‡(
sbi
->
s_jou∫Æ
)

2336 
	`pxt4_£t_„©uª_jou∫Æ_√eds_ªcovîy
(
sb
);

2338 
îr
 = 
	`pxt4_commô_su≥r
(
sb
, 1);

2339 
d⁄e
:

2340 i‡(
	`ã°_›t
(
sb
, 
DEBUG
))

2341 
	`¥ötk
(
KERN_INFO
 "[PXT4 FS bs=%lu, gc=%u, "

2343 
sb
->
s_blocksize
,

2344 
sbi
->
s_groups_cou¡
,

2345 
	`PXT4_BLOCKS_PER_GROUP
(
sb
),

2346 
	`PXT4_INODES_PER_GROUP
(
sb
),

2347 
sbi
->
s_mou¡_›t
, sbi->
s_mou¡_›t2
);

2349 
	`˛ónˇche_öô_fs
(
sb
);

2350  
îr
;

2351 
	}
}

2353 
	$pxt4_Æloc_Êex_bg_¨øy
(
su≥r_block
 *
sb
, 
pxt4_group_t
 
ngroup
)

2355 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
sb
);

2356 
Êex_groups
 **
ﬁd_groups
, **
√w_groups
;

2357 
size
, 
i
, 
j
;

2359 i‡(!
sbi
->
s_log_groups_≥r_Êex
)

2362 
size
 = 
	`pxt4_Êex_group
(
sbi
, 
ngroup
 - 1) + 1;

2363 i‡(
size
 <
sbi
->
s_Êex_groups_Æloˇãd
)

2366 
√w_groups
 = 
	`kvzÆloc
(
	`roundup_pow_of_two
(
size
 *

2367 (*
sbi
->
s_Êex_groups
)), 
GFP_KERNEL
);

2368 i‡(!
√w_groups
) {

2369 
	`pxt4_msg
(
sb
, 
KERN_ERR
,

2370 "nŸÉnough mem‹y f‹ %d fÀx grou∞poöãrs", 
size
);

2371  -
ENOMEM
;

2373 
i
 = 
sbi
->
s_Êex_groups_Æloˇãd
; i < 
size
; i++) {

2374 
√w_groups
[
i
] = 
	`kvzÆloc
(
	`roundup_pow_of_two
(

2375 (
Êex_groups
)),

2376 
GFP_KERNEL
);

2377 i‡(!
√w_groups
[
i
]) {

2378 
j
 = 
sbi
->
s_Êex_groups_Æloˇãd
; j < 
i
; j++)

2379 
	`kv‰ì
(
√w_groups
[
j
]);

2380 
	`kv‰ì
(
√w_groups
);

2381 
	`pxt4_msg
(
sb
, 
KERN_ERR
,

2382 "nŸÉnough mem‹y f‹ %d fÀx groups", 
size
);

2383  -
ENOMEM
;

2386 
	`rcu_ªad_lock
();

2387 
ﬁd_groups
 = 
	`rcu_dîe„ªn˚
(
sbi
->
s_Êex_groups
);

2388 i‡(
ﬁd_groups
)

2389 
	`mem˝y
(
√w_groups
, 
ﬁd_groups
,

2390 (
sbi
->
s_Êex_groups_Æloˇãd
 *

2391 (
Êex_groups
 *)));

2392 
	`rcu_ªad_u∆ock
();

2393 
	`rcu_assign_poöãr
(
sbi
->
s_Êex_groups
, 
√w_groups
);

2394 
sbi
->
s_Êex_groups_Æloˇãd
 = 
size
;

2395 i‡(
ﬁd_groups
)

2396 
	`pxt4_kv‰ì_¨øy_rcu
(
ﬁd_groups
);

2398 
	}
}

2400 
	$pxt4_fûl_Êex_öfo
(
su≥r_block
 *
sb
)

2402 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
sb
);

2403 
pxt4_group_desc
 *
gdp
 = 
NULL
;

2404 
Êex_groups
 *
fg
;

2405 
pxt4_group_t
 
Êex_group
;

2406 
i
, 
îr
;

2408 
sbi
->
s_log_groups_≥r_Êex
 = sbi->
s_es
->s_log_groups_per_flex;

2409 i‡(
sbi
->
s_log_groups_≥r_Êex
 < 1 || sbi->s_log_groups_per_flex > 31) {

2410 
sbi
->
s_log_groups_≥r_Êex
 = 0;

2414 
îr
 = 
	`pxt4_Æloc_Êex_bg_¨øy
(
sb
, 
sbi
->
s_groups_cou¡
);

2415 i‡(
îr
)

2416 
Áûed
;

2418 
i
 = 0; i < 
sbi
->
s_groups_cou¡
; i++) {

2419 
gdp
 = 
	`pxt4_gë_group_desc
(
sb
, 
i
, 
NULL
);

2421 
Êex_group
 = 
	`pxt4_Êex_group
(
sbi
, 
i
);

2422 
fg
 = 
	`sbi_¨øy_rcu_dîef
(
sbi
, 
s_Êex_groups
, 
Êex_group
);

2423 
	`©omic_add
(
	`pxt4_‰ì_öodes_cou¡
(
sb
, 
gdp
), &
fg
->
‰ì_öodes
);

2424 
	`©omic64_add
(
	`pxt4_‰ì_group_˛u°îs
(
sb
, 
gdp
),

2425 &
fg
->
‰ì_˛u°îs
);

2426 
	`©omic_add
(
	`pxt4_u£d_dús_cou¡
(
sb
, 
gdp
), &
fg
->
u£d_dús
);

2430 
Áûed
:

2432 
	}
}

2434 
__À16
 
	$pxt4_group_desc_csum
(
su≥r_block
 *
sb
, 
__u32
 
block_group
,

2435 
pxt4_group_desc
 *
gdp
)

2437 
off£t
 = 
	`off£tof
(
pxt4_group_desc
, 
bg_checksum
);

2438 
__u16
 
¸c
 = 0;

2439 
__À32
 
À_group
 = 
	`˝u_to_À32
(
block_group
);

2440 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
sb
);

2442 i‡(
	`pxt4_has_mëad©a_csum
(
sbi
->
s_sb
)) {

2444 
__u32
 
csum32
;

2445 
__u16
 
dummy_csum
 = 0;

2447 
csum32
 = 
	`pxt4_chksum
(
sbi
, sbi->
s_csum_£ed
, (
__u8
 *)&
À_group
,

2448 (
À_group
));

2449 
csum32
 = 
	`pxt4_chksum
(
sbi
, csum32, (
__u8
 *)
gdp
, 
off£t
);

2450 
csum32
 = 
	`pxt4_chksum
(
sbi
, csum32, (
__u8
 *)&
dummy_csum
,

2451 (
dummy_csum
));

2452 
off£t
 +(
dummy_csum
);

2453 i‡(
off£t
 < 
sbi
->
s_desc_size
)

2454 
csum32
 = 
	`pxt4_chksum
(
sbi
, csum32, (
__u8
 *)
gdp
 + 
off£t
,

2455 
sbi
->
s_desc_size
 - 
off£t
);

2457 
¸c
 = 
csum32
 & 0xFFFF;

2458 
out
;

2462 i‡(!
	`pxt4_has_„©uª_gdt_csum
(
sb
))

2465 
¸c
 = 
	`¸c16
(~0, 
sbi
->
s_es
->
s_uuid
, (sbi->s_es->s_uuid));

2466 
¸c
 = 
	`¸c16
(¸c, (
__u8
 *)&
À_group
, (le_group));

2467 
¸c
 = 
	`¸c16
(¸c, (
__u8
 *)
gdp
, 
off£t
);

2468 
off£t
 +(
gdp
->
bg_checksum
);

2470 i‡(
	`pxt4_has_„©uª_64bô
(
sb
) &&

2471 
off£t
 < 
	`À16_to_˝u
(
sbi
->
s_es
->
s_desc_size
))

2472 
¸c
 = 
	`¸c16
(¸c, (
__u8
 *)
gdp
 + 
off£t
,

2473 
	`À16_to_˝u
(
sbi
->
s_es
->
s_desc_size
) -

2474 
off£t
);

2476 
out
:

2477  
	`˝u_to_À16
(
¸c
);

2478 
	}
}

2480 
	$pxt4_group_desc_csum_vîify
(
su≥r_block
 *
sb
, 
__u32
 
block_group
,

2481 
pxt4_group_desc
 *
gdp
)

2483 i‡(
	`pxt4_has_group_desc_csum
(
sb
) &&

2484 (
gdp
->
bg_checksum
 !
	`pxt4_group_desc_csum
(
sb
, 
block_group
, gdp)))

2488 
	}
}

2490 
	$pxt4_group_desc_csum_£t
(
su≥r_block
 *
sb
, 
__u32
 
block_group
,

2491 
pxt4_group_desc
 *
gdp
)

2493 i‡(!
	`pxt4_has_group_desc_csum
(
sb
))

2495 
gdp
->
bg_checksum
 = 
	`pxt4_group_desc_csum
(
sb
, 
block_group
, gdp);

2496 
	}
}

2499 
	$pxt4_check_des¸ùt‹s
(
su≥r_block
 *
sb
,

2500 
pxt4_fsblk_t
 
sb_block
,

2501 
pxt4_group_t
 *
fú°_nŸ_zî€d
)

2503 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
sb
);

2504 
pxt4_fsblk_t
 
fú°_block
 = 
	`À32_to_˝u
(
sbi
->
s_es
->
s_fú°_d©a_block
);

2505 
pxt4_fsblk_t
 
œ°_block
;

2506 
pxt4_fsblk_t
 
œ°_bg_block
 = 
sb_block
 + 
	`pxt4_bg_num_gdb
(
sb
, 0);

2507 
pxt4_fsblk_t
 
block_bôm≠
;

2508 
pxt4_fsblk_t
 
öode_bôm≠
;

2509 
pxt4_fsblk_t
 
öode_èbÀ
;

2510 
Êexbg_Êag
 = 0;

2511 
pxt4_group_t
 
i
, 
gΩ
 = 
sbi
->
s_groups_cou¡
;

2513 i‡(
	`pxt4_has_„©uª_Êex_bg
(
sb
))

2514 
Êexbg_Êag
 = 1;

2516 
	`pxt4_debug
("Checking group descriptors");

2518 
i
 = 0; i < 
sbi
->
s_groups_cou¡
; i++) {

2519 
pxt4_group_desc
 *
gdp
 = 
	`pxt4_gë_group_desc
(
sb
, 
i
, 
NULL
);

2521 i‡(
i
 =
sbi
->
s_groups_cou¡
 - 1 || 
Êexbg_Êag
)

2522 
œ°_block
 = 
	`pxt4_blocks_cou¡
(
sbi
->
s_es
) - 1;

2524 
œ°_block
 = 
fú°_block
 +

2525 (
	`PXT4_BLOCKS_PER_GROUP
(
sb
) - 1);

2527 i‡((
gΩ
 =
sbi
->
s_groups_cou¡
) &&

2528 !(
gdp
->
bg_Êags
 & 
	`˝u_to_À16
(
PXT4_BG_INODE_ZEROED
)))

2529 
gΩ
 = 
i
;

2531 
block_bôm≠
 = 
	`pxt4_block_bôm≠
(
sb
, 
gdp
);

2532 i‡(
block_bôm≠
 =
sb_block
) {

2533 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "pxt4_check_descriptors: "

2535 "su≥rblock", 
i
);

2536 i‡(!
	`sb_rd⁄ly
(
sb
))

2539 i‡(
block_bôm≠
 >
sb_block
 + 1 &&

2540 
block_bôm≠
 <
œ°_bg_block
) {

2541 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "pxt4_check_descriptors: "

2543 "block grou∞des¸ùt‹s", 
i
);

2544 i‡(!
	`sb_rd⁄ly
(
sb
))

2547 i‡(
block_bôm≠
 < 
fú°_block
 || block_bôm≠ > 
œ°_block
) {

2548 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "pxt4_check_descriptors: "

2550 "(block %Œu)!", 
i
, 
block_bôm≠
);

2553 
öode_bôm≠
 = 
	`pxt4_öode_bôm≠
(
sb
, 
gdp
);

2554 i‡(
öode_bôm≠
 =
sb_block
) {

2555 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "pxt4_check_descriptors: "

2557 "su≥rblock", 
i
);

2558 i‡(!
	`sb_rd⁄ly
(
sb
))

2561 i‡(
öode_bôm≠
 >
sb_block
 + 1 &&

2562 
öode_bôm≠
 <
œ°_bg_block
) {

2563 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "pxt4_check_descriptors: "

2565 "block grou∞des¸ùt‹s", 
i
);

2566 i‡(!
	`sb_rd⁄ly
(
sb
))

2569 i‡(
öode_bôm≠
 < 
fú°_block
 || inode_bôm≠ > 
œ°_block
) {

2570 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "pxt4_check_descriptors: "

2572 "(block %Œu)!", 
i
, 
öode_bôm≠
);

2575 
öode_èbÀ
 = 
	`pxt4_öode_èbÀ
(
sb
, 
gdp
);

2576 i‡(
öode_èbÀ
 =
sb_block
) {

2577 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "pxt4_check_descriptors: "

2579 "su≥rblock", 
i
);

2580 i‡(!
	`sb_rd⁄ly
(
sb
))

2583 i‡(
öode_èbÀ
 >
sb_block
 + 1 &&

2584 
öode_èbÀ
 <
œ°_bg_block
) {

2585 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "pxt4_check_descriptors: "

2587 "block grou∞des¸ùt‹s", 
i
);

2588 i‡(!
	`sb_rd⁄ly
(
sb
))

2591 i‡(
öode_èbÀ
 < 
fú°_block
 ||

2592 
öode_èbÀ
 + 
sbi
->
s_ôb_≥r_group
 - 1 > 
œ°_block
) {

2593 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "pxt4_check_descriptors: "

2595 "(block %Œu)!", 
i
, 
öode_èbÀ
);

2598 
	`pxt4_lock_group
(
sb
, 
i
);

2599 i‡(!
	`pxt4_group_desc_csum_vîify
(
sb
, 
i
, 
gdp
)) {

2600 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "pxt4_check_descriptors: "

2602 
i
, 
	`À16_to_˝u
(
	`pxt4_group_desc_csum
(
sb
, i,

2603 
gdp
)), 
	`À16_to_˝u
(gdp->
bg_checksum
));

2604 i‡(!
	`sb_rd⁄ly
(
sb
)) {

2605 
	`pxt4_u∆ock_group
(
sb
, 
i
);

2609 
	`pxt4_u∆ock_group
(
sb
, 
i
);

2610 i‡(!
Êexbg_Êag
)

2611 
fú°_block
 +
	`PXT4_BLOCKS_PER_GROUP
(
sb
);

2613 i‡(
NULL
 !
fú°_nŸ_zî€d
)

2614 *
fú°_nŸ_zî€d
 = 
gΩ
;

2616 
	}
}

2635 
	$pxt4_‹ph™_˛ónup
(
su≥r_block
 *
sb
,

2636 
pxt4_su≥r_block
 *
es
)

2638 
s_Êags
 = 
sb
->s_flags;

2639 
ªt
, 
ƒ_‹ph™s
 = 0, 
ƒ_åunˇãs
 = 0;

2640 #ifde‡
CONFIG_QUOTA


2641 
quŸa_upd©e
 = 0;

2642 
i
;

2644 i‡(!
es
->
s_œ°_‹ph™
) {

2645 
	`jbd_debug
(4, "no orphan inodesÅo clean up\n");

2649 i‡(
	`bdev_ªad_⁄ly
(
sb
->
s_bdev
)) {

2650 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "writeáccess "

2656 i‡(!
	`pxt4_„©uª_£t_ok
(
sb
, 0)) {

2657 
	`pxt4_msg
(
sb
, 
KERN_INFO
, "Skipping orphan cleanup dueÅo "

2662 i‡(
	`PXT4_SB
(
sb
)->
s_mou¡_°©e
 & 
PXT4_ERROR_FS
) {

2664 i‡(
es
->
s_œ°_‹ph™
 && !(
s_Êags
 & 
SB_RDONLY
)) {

2665 
	`pxt4_msg
(
sb
, 
KERN_INFO
, "Errors on filesystem, "

2667 
es
->
s_œ°_‹ph™
 = 0;

2669 
	`jbd_debug
(1, "Skipping orphanÑecovery on fs withÉrrors.\n");

2673 i‡(
s_Êags
 & 
SB_RDONLY
) {

2674 
	`pxt4_msg
(
sb
, 
KERN_INFO
, "orphan cleanup onÑeadonly fs");

2675 
sb
->
s_Êags
 &~
SB_RDONLY
;

2677 #ifde‡
CONFIG_QUOTA


2682 i‡(
	`pxt4_has_„©uª_quŸa
(
sb
Ë&& (
s_Êags
 & 
SB_RDONLY
)) {

2683 
ªt
 = 
	`pxt4_íabÀ_quŸas
(
sb
);

2685 i‡(!
ªt
)

2686 
quŸa_upd©e
 = 1;

2688 
	`pxt4_msg
(
sb
, 
KERN_ERR
,

2689 "C™nŸÅu∫ o¿quŸas:Éº‹ %d", 
ªt
);

2693 
i
 = 0; i < 
PXT4_MAXQUOTAS
; i++) {

2694 i‡(
	`PXT4_SB
(
sb
)->
s_qf_«mes
[
i
]) {

2695 
ªt
 = 
	`pxt4_quŸa_⁄_mou¡
(
sb
, 
i
);

2697 i‡(!
ªt
)

2698 
quŸa_upd©e
 = 1;

2700 
	`pxt4_msg
(
sb
, 
KERN_ERR
,

2702 "quŸa:Åy≥ %d:Éº‹ %d", 
i
, 
ªt
);

2707 
es
->
s_œ°_‹ph™
) {

2708 
öode
 *inode;

2714 i‡(
	`PXT4_SB
(
sb
)->
s_mou¡_°©e
 & 
PXT4_ERROR_FS
) {

2715 
	`jbd_debug
(1, "Skipping orphanÑecovery on fs withÉrrors.\n");

2716 
es
->
s_œ°_‹ph™
 = 0;

2720 
öode
 = 
	`pxt4_‹ph™_gë
(
sb
, 
	`À32_to_˝u
(
es
->
s_œ°_‹ph™
));

2721 i‡(
	`IS_ERR
(
öode
)) {

2722 
es
->
s_œ°_‹ph™
 = 0;

2726 
	`li°_add
(&
	`PXT4_I
(
öode
)->
i_‹ph™
, &
	`PXT4_SB
(
sb
)->
s_‹ph™
);

2727 
	`dquŸ_öôülize
(
öode
);

2728 i‡(
öode
->
i_∆ök
) {

2729 i‡(
	`ã°_›t
(
sb
, 
DEBUG
))

2730 
	`pxt4_msg
(
sb
, 
KERN_DEBUG
,

2732 
__func__
, 
öode
->
i_öo
, inode->
i_size
);

2733 
	`jbd_debug
(2, "truncating inode %luÅo %lld bytes\n",

2734 
öode
->
i_öo
, inode->
i_size
);

2735 
	`öode_lock
(
öode
);

2736 
	`åunˇã_öode_∑ges
(
öode
->
i_m≠pög
, inode->
i_size
);

2737 
ªt
 = 
	`pxt4_åunˇã
(
öode
);

2738 i‡(
ªt
) {

2744 
	`pxt4_‹ph™_dñ
(
NULL
, 
öode
);

2745 
	`pxt4_°d_îr‹
(
öode
->
i_sb
, 
ªt
);

2747 
	`öode_u∆ock
(
öode
);

2748 
ƒ_åunˇãs
++;

2750 i‡(
	`ã°_›t
(
sb
, 
DEBUG
))

2751 
	`pxt4_msg
(
sb
, 
KERN_DEBUG
,

2753 
__func__
, 
öode
->
i_öo
);

2754 
	`jbd_debug
(2, "deleting unreferenced inode %lu\n",

2755 
öode
->
i_öo
);

2756 
ƒ_‹ph™s
++;

2758 
	`ùut
(
öode
);

2761 
	#PLURAL
(
x
Ë(x), ((xË=1Ë? "" : "s"

	)

2763 i‡(
ƒ_‹ph™s
)

2764 
	`pxt4_msg
(
sb
, 
KERN_INFO
, "%d orphan inode%s deleted",

2765 
	`PLURAL
(
ƒ_‹ph™s
));

2766 i‡(
ƒ_åunˇãs
)

2767 
	`pxt4_msg
(
sb
, 
KERN_INFO
, "%dÅruncate%s cleaned up",

2768 
	`PLURAL
(
ƒ_åunˇãs
));

2769 #ifde‡
CONFIG_QUOTA


2771 i‡(
quŸa_upd©e
) {

2772 
i
 = 0; i < 
PXT4_MAXQUOTAS
; i++) {

2773 i‡(
	`sb_dq›t
(
sb
)->
fûes
[
i
])

2774 
	`dquŸ_quŸa_off
(
sb
, 
i
);

2778 
sb
->
s_Êags
 = s_flags;

2779 
	}
}

2796 
loff_t
 
	$pxt4_max_size
(
blkbôs
, 
has_huge_fûes
)

2798 
loff_t
 
ªs
;

2799 
loff_t
 
uµî_limô
 = 
MAX_LFS_FILESIZE
;

2801 
	`BUILD_BUG_ON
((
blk˙t_t
Ë< (
u64
));

2803 i‡(!
has_huge_fûes
) {

2804 
uµî_limô
 = (1LL << 32) - 1;

2807 
uµî_limô
 >>(
blkbôs
 - 9);

2808 
uµî_limô
 <<
blkbôs
;

2816 
ªs
 = (1LL << 32) - 1;

2817 
ªs
 <<
blkbôs
;

2820 i‡(
ªs
 > 
uµî_limô
)

2821 
ªs
 = 
uµî_limô
;

2823  
ªs
;

2824 
	}
}

2831 
loff_t
 
	$pxt4_max_bôm≠_size
(
bôs
, 
has_huge_fûes
)

2833 
loff_t
 
ªs
 = 
PXT4_NDIR_BLOCKS
;

2834 
mëa_blocks
;

2835 
loff_t
 
uµî_limô
;

2844 i‡(!
has_huge_fûes
) {

2850 
uµî_limô
 = (1LL << 32) - 1;

2853 
uµî_limô
 >>(
bôs
 - 9);

2862 
uµî_limô
 = (1LL << 48) - 1;

2867 
mëa_blocks
 = 1;

2869 
mëa_blocks
 +1 + (1LL << (
bôs
-2));

2871 
mëa_blocks
 +1 + (1LL << (
bôs
-2)) + (1LL << (2*(bits-2)));

2873 
uµî_limô
 -
mëa_blocks
;

2874 
uµî_limô
 <<
bôs
;

2876 
ªs
 +1LL << (
bôs
-2);

2877 
ªs
 +1LL << (2*(
bôs
-2));

2878 
ªs
 +1LL << (3*(
bôs
-2));

2879 
ªs
 <<
bôs
;

2880 i‡(
ªs
 > 
uµî_limô
)

2881 
ªs
 = 
uµî_limô
;

2883 i‡(
ªs
 > 
MAX_LFS_FILESIZE
)

2884 
ªs
 = 
MAX_LFS_FILESIZE
;

2886  
ªs
;

2887 
	}
}

2889 
pxt4_fsblk_t
 
	$des¸ùt‹_loc
(
su≥r_block
 *
sb
,

2890 
pxt4_fsblk_t
 
logiˇl_sb_block
, 
ƒ
)

2892 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
sb
);

2893 
pxt4_group_t
 
bg
, 
fú°_mëa_bg
;

2894 
has_su≥r
 = 0;

2896 
fú°_mëa_bg
 = 
	`À32_to_˝u
(
sbi
->
s_es
->
s_fú°_mëa_bg
);

2898 i‡(!
	`pxt4_has_„©uª_mëa_bg
(
sb
Ë|| 
ƒ
 < 
fú°_mëa_bg
)

2899  
logiˇl_sb_block
 + 
ƒ
 + 1;

2900 
bg
 = 
sbi
->
s_desc_≥r_block
 * 
ƒ
;

2901 i‡(
	`pxt4_bg_has_su≥r
(
sb
, 
bg
))

2902 
has_su≥r
 = 1;

2910 i‡(
sb
->
s_blocksize
 =1024 && 
ƒ
 == 0 &&

2911 
	`À32_to_˝u
(
sbi
->
s_es
->
s_fú°_d©a_block
) == 0)

2912 
has_su≥r
++;

2914  (
has_su≥r
 + 
	`pxt4_group_fú°_block_no
(
sb
, 
bg
));

2915 
	}
}

2928 
	$pxt4_gë_°rùe_size
(
pxt4_sb_öfo
 *
sbi
)

2930 
°ride
 = 
	`À16_to_˝u
(
sbi
->
s_es
->
s_øid_°ride
);

2931 
°rùe_width
 =

2932 
	`À32_to_˝u
(
sbi
->
s_es
->
s_øid_°rùe_width
);

2933 
ªt
;

2935 i‡(
sbi
->
s_°rùe
 && sbi->s_°rùê<sbi->
s_blocks_≥r_group
)

2936 
ªt
 = 
sbi
->
s_°rùe
;

2937 i‡(
°rùe_width
 && såùe_width <
sbi
->
s_blocks_≥r_group
)

2938 
ªt
 = 
°rùe_width
;

2939 i‡(
°ride
 && såidê<
sbi
->
s_blocks_≥r_group
)

2940 
ªt
 = 
°ride
;

2942 
ªt
 = 0;

2948 i‡(
ªt
 <= 1)

2949 
ªt
 = 0;

2951  
ªt
;

2952 
	}
}

2960 
	$pxt4_„©uª_£t_ok
(
su≥r_block
 *
sb
, 
ªad⁄ly
)

2962 i‡(
	`pxt4_has_unknown_pxt4_öcom∑t_„©uªs
(
sb
)) {

2963 
	`pxt4_msg
(
sb
, 
KERN_ERR
,

2966 (
	`À32_to_˝u
(
	`PXT4_SB
(
sb
)->
s_es
->
s_„©uª_öcom∑t
) &

2967 ~
PXT4_FEATURE_INCOMPAT_SUPP
));

2971 #i‚de‡
CONFIG_UNICODE


2972 i‡(
	`pxt4_has_„©uª_ˇ£fﬁd
(
sb
)) {

2973 
	`pxt4_msg
(
sb
, 
KERN_ERR
,

2980 i‡(
ªad⁄ly
)

2983 i‡(
	`pxt4_has_„©uª_ªad⁄ly
(
sb
)) {

2984 
	`pxt4_msg
(
sb
, 
KERN_INFO
, "filesystem isÑead-only");

2985 
sb
->
s_Êags
 |
SB_RDONLY
;

2990 i‡(
	`pxt4_has_unknown_pxt4_ro_com∑t_„©uªs
(
sb
)) {

2991 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "couldn't mount RDWR because of "

2993 (
	`À32_to_˝u
(
	`PXT4_SB
(
sb
)->
s_es
->
s_„©uª_ro_com∑t
) &

2994 ~
PXT4_FEATURE_RO_COMPAT_SUPP
));

2997 i‡(
	`pxt4_has_„©uª_bigÆloc
(
sb
Ë&& !
	`pxt4_has_„©uª_exã¡s
(sb)) {

2998 
	`pxt4_msg
(
sb
, 
KERN_ERR
,

3004 #i‡!
	`IS_ENABLED
(
CONFIG_QUOTA
Ë|| !IS_ENABLED(
CONFIG_QFMT_V2
)

3005 i‡(!
ªad⁄ly
 && (
	`pxt4_has_„©uª_quŸa
(
sb
) ||

3006 
	`pxt4_has_„©uª_¥oje˘
(
sb
))) {

3007 
	`pxt4_msg
(
sb
, 
KERN_ERR
,

3013 
	}
}

3019 
	$¥öt_daûy_îr‹_öfo
(
timî_li°
 *
t
)

3021 
pxt4_sb_öfo
 *
sbi
 = 
	`‰om_timî
(sbi, 
t
, 
s_îr_ªp‹t
);

3022 
su≥r_block
 *
sb
 = 
sbi
->
s_sb
;

3023 
pxt4_su≥r_block
 *
es
 = 
sbi
->
s_es
;

3025 i‡(
es
->
s_îr‹_cou¡
)

3027 
	`pxt4_msg
(
sb
, 
KERN_NOTICE
, "error count sinceÜast fsck: %u",

3028 
	`À32_to_˝u
(
es
->
s_îr‹_cou¡
));

3029 i‡(
es
->
s_fú°_îr‹_time
) {

3030 
	`¥ötk
(
KERN_NOTICE
 "PXT4-fs (%s): initialÉrrorátÅime %llu: %.*s:%d",

3031 
sb
->
s_id
,

3032 
	`pxt4_gë_t°amp
(
es
, 
s_fú°_îr‹_time
),

3033 (Ë(
es
->
s_fú°_îr‹_func
),

3034 
es
->
s_fú°_îr‹_func
,

3035 
	`À32_to_˝u
(
es
->
s_fú°_îr‹_löe
));

3036 i‡(
es
->
s_fú°_îr‹_öo
)

3037 
	`¥ötk
(
KERN_CONT
 ": inode %u",

3038 
	`À32_to_˝u
(
es
->
s_fú°_îr‹_öo
));

3039 i‡(
es
->
s_fú°_îr‹_block
)

3040 
	`¥ötk
(
KERN_CONT
 ": block %llu", ()

3041 
	`À64_to_˝u
(
es
->
s_fú°_îr‹_block
));

3042 
	`¥ötk
(
KERN_CONT
 "\n");

3044 i‡(
es
->
s_œ°_îr‹_time
) {

3045 
	`¥ötk
(
KERN_NOTICE
 "PXT4-fs (%s):ÜastÉrrorátÅime %llu: %.*s:%d",

3046 
sb
->
s_id
,

3047 
	`pxt4_gë_t°amp
(
es
, 
s_œ°_îr‹_time
),

3048 (Ë(
es
->
s_œ°_îr‹_func
),

3049 
es
->
s_œ°_îr‹_func
,

3050 
	`À32_to_˝u
(
es
->
s_œ°_îr‹_löe
));

3051 i‡(
es
->
s_œ°_îr‹_öo
)

3052 
	`¥ötk
(
KERN_CONT
 ": inode %u",

3053 
	`À32_to_˝u
(
es
->
s_œ°_îr‹_öo
));

3054 i‡(
es
->
s_œ°_îr‹_block
)

3055 
	`¥ötk
(
KERN_CONT
 ": block %llu", ()

3056 
	`À64_to_˝u
(
es
->
s_œ°_îr‹_block
));

3057 
	`¥ötk
(
KERN_CONT
 "\n");

3059 
	`mod_timî
(&
sbi
->
s_îr_ªp‹t
, 
jiffõs
 + 24*60*60*
HZ
);

3060 
	}
}

3063 
	$pxt4_run_li_ªque°
(
pxt4_li_ªque°
 *
ñr
)

3065 
pxt4_group_desc
 *
gdp
 = 
NULL
;

3066 
pxt4_group_t
 
group
, 
ngroups
;

3067 
su≥r_block
 *
sb
;

3068 
timeout
 = 0;

3069 
ªt
 = 0;

3071 
sb
 = 
ñr
->
Ã_su≥r
;

3072 
ngroups
 = 
	`PXT4_SB
(
sb
)->
s_groups_cou¡
;

3074 
group
 = 
ñr
->
Ã_√xt_group
; grou∞< 
ngroups
; group++) {

3075 
gdp
 = 
	`pxt4_gë_group_desc
(
sb
, 
group
, 
NULL
);

3076 i‡(!
gdp
) {

3077 
ªt
 = 1;

3081 i‡(!(
gdp
->
bg_Êags
 & 
	`˝u_to_À16
(
PXT4_BG_INODE_ZEROED
)))

3085 i‡(
group
 >
ngroups
)

3086 
ªt
 = 1;

3088 i‡(!
ªt
) {

3089 
timeout
 = 
jiffõs
;

3090 
ªt
 = 
	`pxt4_öô_öode_èbÀ
(
sb
, 
group
,

3091 
ñr
->
Ã_timeout
 ? 0 : 1);

3092 i‡(
ñr
->
Ã_timeout
 == 0) {

3093 
timeout
 = (
jiffõs
 -Åimeout) *

3094 
ñr
->
Ã_sbi
->
s_li_waô_mu…
;

3095 
ñr
->
Ã_timeout
 = 
timeout
;

3097 
ñr
->
Ã_√xt_sched
 = 
jiffõs
 +ÉÃ->
Ã_timeout
;

3098 
ñr
->
Ã_√xt_group
 = 
group
 + 1;

3100  
ªt
;

3101 
	}
}

3107 
	$pxt4_ªmove_li_ªque°
(
pxt4_li_ªque°
 *
ñr
)

3109 
pxt4_sb_öfo
 *
sbi
;

3111 i‡(!
ñr
)

3114 
sbi
 = 
ñr
->
Ã_sbi
;

3116 
	`li°_dñ
(&
ñr
->
Ã_ªque°
);

3117 
sbi
->
s_li_ªque°
 = 
NULL
;

3118 
	`k‰ì
(
ñr
);

3119 
	}
}

3121 
	$pxt4_uƒegi°î_li_ªque°
(
su≥r_block
 *
sb
)

3123 
	`muãx_lock
(&
pxt4_li_mtx
);

3124 i‡(!
pxt4_li_öfo
) {

3125 
	`muãx_u∆ock
(&
pxt4_li_mtx
);

3129 
	`muãx_lock
(&
pxt4_li_öfo
->
li_li°_mtx
);

3130 
	`pxt4_ªmove_li_ªque°
(
	`PXT4_SB
(
sb
)->
s_li_ªque°
);

3131 
	`muãx_u∆ock
(&
pxt4_li_öfo
->
li_li°_mtx
);

3132 
	`muãx_u∆ock
(&
pxt4_li_mtx
);

3133 
	}
}

3135 
èsk_°ru˘
 *
	gpxt4_œzyöô_èsk
;

3146 
	$pxt4_œzyöô_thªad
(*
¨g
)

3148 
pxt4_œzy_öô
 *
ñi
 = (pxt4_œzy_öô *)
¨g
;

3149 
li°_hód
 *
pos
, *
n
;

3150 
pxt4_li_ªque°
 *
ñr
;

3151 
√xt_wakeup
, 
cur
;

3153 
	`BUG_ON
(
NULL
 =
ñi
);

3155 
c⁄t_thªad
:

3156 
åue
) {

3157 
√xt_wakeup
 = 
MAX_JIFFY_OFFSET
;

3159 
	`muãx_lock
(&
ñi
->
li_li°_mtx
);

3160 i‡(
	`li°_em±y
(&
ñi
->
li_ªque°_li°
)) {

3161 
	`muãx_u∆ock
(&
ñi
->
li_li°_mtx
);

3162 
exô_thªad
;

3164 
	`li°_f‹_óch_ß„
(
pos
, 
n
, &
ñi
->
li_ªque°_li°
) {

3165 
îr
 = 0;

3166 
¥ogªss
 = 0;

3167 
ñr
 = 
	`li°_íåy
(
pos
, 
pxt4_li_ªque°
,

3168 
Ã_ªque°
);

3170 i‡(
	`time_bef‹e
(
jiffõs
, 
ñr
->
Ã_√xt_sched
)) {

3171 i‡(
	`time_bef‹e
(
ñr
->
Ã_√xt_sched
, 
√xt_wakeup
))

3172 
√xt_wakeup
 = 
ñr
->
Ã_√xt_sched
;

3175 i‡(
	`down_ªad_åylock
(&
ñr
->
Ã_su≥r
->
s_umou¡
)) {

3176 i‡(
	`sb_°¨t_wrôe_åylock
(
ñr
->
Ã_su≥r
)) {

3177 
¥ogªss
 = 1;

3183 
	`muãx_u∆ock
(&
ñi
->
li_li°_mtx
);

3184 
îr
 = 
	`pxt4_run_li_ªque°
(
ñr
);

3185 
	`sb_íd_wrôe
(
ñr
->
Ã_su≥r
);

3186 
	`muãx_lock
(&
ñi
->
li_li°_mtx
);

3187 
n
 = 
pos
->
√xt
;

3189 
	`up_ªad
((&
ñr
->
Ã_su≥r
->
s_umou¡
));

3192 i‡(
îr
) {

3193 
	`pxt4_ªmove_li_ªque°
(
ñr
);

3196 i‡(!
¥ogªss
) {

3197 
ñr
->
Ã_√xt_sched
 = 
jiffõs
 +

3198 (
	`¥™dom_u32
()

3199 % (
PXT4_DEF_LI_MAX_START_DELAY
 * 
HZ
));

3201 i‡(
	`time_bef‹e
(
ñr
->
Ã_√xt_sched
, 
√xt_wakeup
))

3202 
√xt_wakeup
 = 
ñr
->
Ã_√xt_sched
;

3204 
	`muãx_u∆ock
(&
ñi
->
li_li°_mtx
);

3206 
	`åy_to_‰ìze
();

3208 
cur
 = 
jiffõs
;

3209 i‡((
	`time_a·î_eq
(
cur
, 
√xt_wakeup
)) ||

3210 (
MAX_JIFFY_OFFSET
 =
√xt_wakeup
)) {

3211 
	`c⁄d_ªsched
();

3215 
	`scheduÀ_timeout_öãºu±ibÀ
(
√xt_wakeup
 - 
cur
);

3217 i‡(
	`kthªad_should_°›
()) {

3218 
	`pxt4_˛ór_ªque°_li°
();

3219 
exô_thªad
;

3223 
exô_thªad
:

3232 
	`muãx_lock
(&
pxt4_li_mtx
);

3233 
	`muãx_lock
(&
ñi
->
li_li°_mtx
);

3234 i‡(!
	`li°_em±y
(&
ñi
->
li_ªque°_li°
)) {

3235 
	`muãx_u∆ock
(&
ñi
->
li_li°_mtx
);

3236 
	`muãx_u∆ock
(&
pxt4_li_mtx
);

3237 
c⁄t_thªad
;

3239 
	`muãx_u∆ock
(&
ñi
->
li_li°_mtx
);

3240 
	`k‰ì
(
pxt4_li_öfo
);

3241 
pxt4_li_öfo
 = 
NULL
;

3242 
	`muãx_u∆ock
(&
pxt4_li_mtx
);

3245 
	}
}

3247 
	$pxt4_˛ór_ªque°_li°
()

3249 
li°_hód
 *
pos
, *
n
;

3250 
pxt4_li_ªque°
 *
ñr
;

3252 
	`muãx_lock
(&
pxt4_li_öfo
->
li_li°_mtx
);

3253 
	`li°_f‹_óch_ß„
(
pos
, 
n
, &
pxt4_li_öfo
->
li_ªque°_li°
) {

3254 
ñr
 = 
	`li°_íåy
(
pos
, 
pxt4_li_ªque°
,

3255 
Ã_ªque°
);

3256 
	`pxt4_ªmove_li_ªque°
(
ñr
);

3258 
	`muãx_u∆ock
(&
pxt4_li_öfo
->
li_li°_mtx
);

3259 
	}
}

3261 
	$pxt4_run_œzyöô_thªad
()

3263 
pxt4_œzyöô_èsk
 = 
	`kthªad_run
(
pxt4_œzyöô_thªad
,

3264 
pxt4_li_öfo
, "pxt4lazyinit");

3265 i‡(
	`IS_ERR
(
pxt4_œzyöô_èsk
)) {

3266 
îr
 = 
	`PTR_ERR
(
pxt4_œzyöô_èsk
);

3267 
	`pxt4_˛ór_ªque°_li°
();

3268 
	`k‰ì
(
pxt4_li_öfo
);

3269 
pxt4_li_öfo
 = 
NULL
;

3270 
	`¥ötk
(
KERN_CRIT
 "PXT4-fs:Érror %d creating inodeÅable "

3272 
îr
);

3273  
îr
;

3275 
pxt4_li_öfo
->
li_°©e
 |
PXT4_LAZYINIT_RUNNING
;

3277 
	}
}

3285 
pxt4_group_t
 
	$pxt4_has_unöô_ôabÀ
(
su≥r_block
 *
sb
)

3287 
pxt4_group_t
 
group
, 
ngroups
 = 
	`PXT4_SB
(
sb
)->
s_groups_cou¡
;

3288 
pxt4_group_desc
 *
gdp
 = 
NULL
;

3290 i‡(!
	`pxt4_has_group_desc_csum
(
sb
))

3291  
ngroups
;

3293 
group
 = 0; grou∞< 
ngroups
; group++) {

3294 
gdp
 = 
	`pxt4_gë_group_desc
(
sb
, 
group
, 
NULL
);

3295 i‡(!
gdp
)

3298 i‡(!(
gdp
->
bg_Êags
 & 
	`˝u_to_À16
(
PXT4_BG_INODE_ZEROED
)))

3302  
group
;

3303 
	}
}

3305 
	$pxt4_li_öfo_√w
()

3307 
pxt4_œzy_öô
 *
ñi
 = 
NULL
;

3309 
ñi
 = 
	`kzÆloc
((*ñi), 
GFP_KERNEL
);

3310 i‡(!
ñi
)

3311  -
ENOMEM
;

3313 
	`INIT_LIST_HEAD
(&
ñi
->
li_ªque°_li°
);

3314 
	`muãx_öô
(&
ñi
->
li_li°_mtx
);

3316 
ñi
->
li_°©e
 |
PXT4_LAZYINIT_QUIT
;

3318 
pxt4_li_öfo
 = 
ñi
;

3321 
	}
}

3323 
pxt4_li_ªque°
 *
	$pxt4_li_ªque°_√w
(
su≥r_block
 *
sb
,

3324 
pxt4_group_t
 
°¨t
)

3326 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
sb
);

3327 
pxt4_li_ªque°
 *
ñr
;

3329 
ñr
 = 
	`kzÆloc
((*ñr), 
GFP_KERNEL
);

3330 i‡(!
ñr
)

3331  
NULL
;

3333 
ñr
->
Ã_su≥r
 = 
sb
;

3334 
ñr
->
Ã_sbi
 = 
sbi
;

3335 
ñr
->
Ã_√xt_group
 = 
°¨t
;

3342 
ñr
->
Ã_√xt_sched
 = 
jiffõs
 + (
	`¥™dom_u32
() %

3343 (
PXT4_DEF_LI_MAX_START_DELAY
 * 
HZ
));

3344  
ñr
;

3345 
	}
}

3347 
	$pxt4_ªgi°î_li_ªque°
(
su≥r_block
 *
sb
,

3348 
pxt4_group_t
 
fú°_nŸ_zî€d
)

3350 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
sb
);

3351 
pxt4_li_ªque°
 *
ñr
 = 
NULL
;

3352 
pxt4_group_t
 
ngroups
 = 
sbi
->
s_groups_cou¡
;

3353 
ªt
 = 0;

3355 
	`muãx_lock
(&
pxt4_li_mtx
);

3356 i‡(
sbi
->
s_li_ªque°
 !
NULL
) {

3361 
sbi
->
s_li_ªque°
->
Ã_timeout
 = 0;

3362 
out
;

3365 i‡(
fú°_nŸ_zî€d
 =
ngroups
 || 
	`sb_rd⁄ly
(
sb
) ||

3366 !
	`ã°_›t
(
sb
, 
INIT_INODE_TABLE
))

3367 
out
;

3369 
ñr
 = 
	`pxt4_li_ªque°_√w
(
sb
, 
fú°_nŸ_zî€d
);

3370 i‡(!
ñr
) {

3371 
ªt
 = -
ENOMEM
;

3372 
out
;

3375 i‡(
NULL
 =
pxt4_li_öfo
) {

3376 
ªt
 = 
	`pxt4_li_öfo_√w
();

3377 i‡(
ªt
)

3378 
out
;

3381 
	`muãx_lock
(&
pxt4_li_öfo
->
li_li°_mtx
);

3382 
	`li°_add
(&
ñr
->
Ã_ªque°
, &
pxt4_li_öfo
->
li_ªque°_li°
);

3383 
	`muãx_u∆ock
(&
pxt4_li_öfo
->
li_li°_mtx
);

3385 
sbi
->
s_li_ªque°
 = 
ñr
;

3391 
ñr
 = 
NULL
;

3393 i‡(!(
pxt4_li_öfo
->
li_°©e
 & 
PXT4_LAZYINIT_RUNNING
)) {

3394 
ªt
 = 
	`pxt4_run_œzyöô_thªad
();

3395 i‡(
ªt
)

3396 
out
;

3398 
out
:

3399 
	`muãx_u∆ock
(&
pxt4_li_mtx
);

3400 i‡(
ªt
)

3401 
	`k‰ì
(
ñr
);

3402  
ªt
;

3403 
	}
}

3409 
	$pxt4_de°roy_œzyöô_thªad
()

3415 i‡(!
pxt4_li_öfo
 || !
pxt4_œzyöô_èsk
)

3418 
	`kthªad_°›
(
pxt4_œzyöô_èsk
);

3419 
	}
}

3421 
	$£t_jou∫Æ_csum_„©uª_£t
(
su≥r_block
 *
sb
)

3423 
ªt
 = 1;

3424 
com∑t
, 
öcom∑t
;

3425 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
sb
);

3427 i‡(
	`pxt4_has_mëad©a_csum
(
sb
)) {

3429 
com∑t
 = 0;

3430 
öcom∑t
 = 
JBD3_FEATURE_INCOMPAT_CSUM_V3
;

3433 
com∑t
 = 
JBD3_FEATURE_COMPAT_CHECKSUM
;

3434 
öcom∑t
 = 0;

3437 
	`jbd3_jou∫Æ_˛ór_„©uªs
(
sbi
->
s_jou∫Æ
,

3438 
JBD3_FEATURE_COMPAT_CHECKSUM
, 0,

3439 
JBD3_FEATURE_INCOMPAT_CSUM_V3
 |

3440 
JBD3_FEATURE_INCOMPAT_CSUM_V2
);

3441 i‡(
	`ã°_›t
(
sb
, 
JOURNAL_ASYNC_COMMIT
)) {

3442 
ªt
 = 
	`jbd3_jou∫Æ_£t_„©uªs
(
sbi
->
s_jou∫Æ
,

3443 
com∑t
, 0,

3444 
JBD3_FEATURE_INCOMPAT_ASYNC_COMMIT
 |

3445 
öcom∑t
);

3446 } i‡(
	`ã°_›t
(
sb
, 
JOURNAL_CHECKSUM
)) {

3447 
ªt
 = 
	`jbd3_jou∫Æ_£t_„©uªs
(
sbi
->
s_jou∫Æ
,

3448 
com∑t
, 0,

3449 
öcom∑t
);

3450 
	`jbd3_jou∫Æ_˛ór_„©uªs
(
sbi
->
s_jou∫Æ
, 0, 0,

3451 
JBD3_FEATURE_INCOMPAT_ASYNC_COMMIT
);

3453 
	`jbd3_jou∫Æ_˛ór_„©uªs
(
sbi
->
s_jou∫Æ
, 0, 0,

3454 
JBD3_FEATURE_INCOMPAT_ASYNC_COMMIT
);

3457  
ªt
;

3458 
	}
}

3475 
	$cou¡_ovîhód
(
su≥r_block
 *
sb
, 
pxt4_group_t
 
gΩ
,

3476 *
buf
)

3478 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
sb
);

3479 
pxt4_group_desc
 *
gdp
;

3480 
pxt4_fsblk_t
 
fú°_block
, 
œ°_block
, 
b
;

3481 
pxt4_group_t
 
i
, 
ngroups
 = 
	`pxt4_gë_groups_cou¡
(
sb
);

3482 
s
, 
j
, 
cou¡
 = 0;

3484 i‡(!
	`pxt4_has_„©uª_bigÆloc
(
sb
))

3485  (
	`pxt4_bg_has_su≥r
(
sb
, 
gΩ
Ë+ 
	`pxt4_bg_num_gdb
(sb, grp) +

3486 
sbi
->
s_ôb_≥r_group
 + 2);

3488 
fú°_block
 = 
	`À32_to_˝u
(
sbi
->
s_es
->
s_fú°_d©a_block
) +

3489 (
gΩ
 * 
	`PXT4_BLOCKS_PER_GROUP
(
sb
));

3490 
œ°_block
 = 
fú°_block
 + 
	`PXT4_BLOCKS_PER_GROUP
(
sb
) - 1;

3491 
i
 = 0; i < 
ngroups
; i++) {

3492 
gdp
 = 
	`pxt4_gë_group_desc
(
sb
, 
i
, 
NULL
);

3493 
b
 = 
	`pxt4_block_bôm≠
(
sb
, 
gdp
);

3494 i‡(
b
 >
fú°_block
 && b <
œ°_block
) {

3495 
	`pxt4_£t_bô
(
	`PXT4_B2C
(
sbi
, 
b
 - 
fú°_block
), 
buf
);

3496 
cou¡
++;

3498 
b
 = 
	`pxt4_öode_bôm≠
(
sb
, 
gdp
);

3499 i‡(
b
 >
fú°_block
 && b <
œ°_block
) {

3500 
	`pxt4_£t_bô
(
	`PXT4_B2C
(
sbi
, 
b
 - 
fú°_block
), 
buf
);

3501 
cou¡
++;

3503 
b
 = 
	`pxt4_öode_èbÀ
(
sb
, 
gdp
);

3504 i‡(
b
 >
fú°_block
 && b + 
sbi
->
s_ôb_≥r_group
 <
œ°_block
)

3505 
j
 = 0; j < 
sbi
->
s_ôb_≥r_group
; j++, 
b
++) {

3506 
c
 = 
	`PXT4_B2C
(
sbi
, 
b
 - 
fú°_block
);

3507 
	`pxt4_£t_bô
(
c
, 
buf
);

3508 
cou¡
++;

3510 i‡(
i
 !
gΩ
)

3512 
s
 = 0;

3513 i‡(
	`pxt4_bg_has_su≥r
(
sb
, 
gΩ
)) {

3514 
	`pxt4_£t_bô
(
s
++, 
buf
);

3515 
cou¡
++;

3517 
j
 = 
	`pxt4_bg_num_gdb
(
sb
, 
gΩ
);

3518 i‡(
s
 + 
j
 > 
	`PXT4_BLOCKS_PER_GROUP
(
sb
)) {

3519 
	`pxt4_îr‹
(
sb
, "InvalidÇumber of block group "

3520 "des¸ùt‹ blocks: %d", 
j
);

3521 
j
 = 
	`PXT4_BLOCKS_PER_GROUP
(
sb
Ë- 
s
;

3523 
cou¡
 +
j
;

3524 ; 
j
 > 0; j--)

3525 
	`pxt4_£t_bô
(
	`PXT4_B2C
(
sbi
, 
s
++), 
buf
);

3527 i‡(!
cou¡
)

3529  
	`PXT4_CLUSTERS_PER_GROUP
(
sb
) -

3530 
	`pxt4_cou¡_‰ì
(
buf
, 
	`PXT4_CLUSTERS_PER_GROUP
(
sb
) / 8);

3531 
	}
}

3536 
	$pxt4_ˇlcuœã_ovîhód
(
su≥r_block
 *
sb
)

3538 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
sb
);

3539 
pxt4_su≥r_block
 *
es
 = 
sbi
->
s_es
;

3540 
öode
 *
j_öode
;

3541 
j_blocks
, 
j_öum
 = 
	`À32_to_˝u
(
es
->
s_jou∫Æ_öum
);

3542 
pxt4_group_t
 
i
, 
ngroups
 = 
	`pxt4_gë_groups_cou¡
(
sb
);

3543 
pxt4_fsblk_t
 
ovîhód
 = 0;

3544 *
buf
 = (*Ë
	`gë_zî€d_∑ge
(
GFP_NOFS
);

3546 i‡(!
buf
)

3547  -
ENOMEM
;

3558 
ovîhód
 = 
	`PXT4_B2C
(
sbi
, 
	`À32_to_˝u
(
es
->
s_fú°_d©a_block
));

3563 
i
 = 0; i < 
ngroups
; i++) {

3564 
blks
;

3566 
blks
 = 
	`cou¡_ovîhód
(
sb
, 
i
, 
buf
);

3567 
ovîhód
 +
blks
;

3568 i‡(
blks
)

3569 
	`mem£t
(
buf
, 0, 
PAGE_SIZE
);

3570 
	`c⁄d_ªsched
();

3577 i‡(
sbi
->
s_jou∫Æ
 && !sbi->
jou∫Æ_bdev
)

3578 
ovîhód
 +
	`PXT4_NUM_B2C
(
sbi
, sbi->
s_jou∫Æ
->
j_maxÀn
);

3579 i‡(
	`pxt4_has_„©uª_jou∫Æ
(
sb
Ë&& !
sbi
->
s_jou∫Æ
 && 
j_öum
) {

3581 
j_öode
 = 
	`pxt4_gë_jou∫Æ_öode
(
sb
, 
j_öum
);

3582 i‡(
j_öode
) {

3583 
j_blocks
 = 
j_öode
->
i_size
 >> 
sb
->
s_blocksize_bôs
;

3584 
ovîhód
 +
	`PXT4_NUM_B2C
(
sbi
, 
j_blocks
);

3585 
	`ùut
(
j_öode
);

3587 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "can't get journal size");

3590 
sbi
->
s_ovîhód
 = 
ovîhód
;

3591 
	`smp_wmb
();

3592 
	`‰ì_∑ge
((Ë
buf
);

3594 
	}
}

3596 
	$pxt4_£t_ªsv_˛u°îs
(
su≥r_block
 *
sb
)

3598 
pxt4_fsblk_t
 
ªsv_˛u°îs
;

3599 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
sb
);

3607 i‡(!
	`pxt4_has_„©uª_exã¡s
(
sb
))

3617 
ªsv_˛u°îs
 = (
	`pxt4_blocks_cou¡
(
sbi
->
s_es
) >>

3618 
sbi
->
s_˛u°î_bôs
);

3620 
	`do_div
(
ªsv_˛u°îs
, 50);

3621 
ªsv_˛u°îs
 = 
	`mö_t
(
pxt4_fsblk_t
,Ñesv_clusters, 4096);

3623 
	`©omic64_£t
(&
sbi
->
s_ªsv_˛u°îs
, 
ªsv_˛u°îs
);

3624 
	}
}

3626 
	$pxt4_fûl_su≥r
(
su≥r_block
 *
sb
, *
d©a
, 
sûít
)

3628 
dax_devi˚
 *
dax_dev
 = 
	`fs_dax_gë_by_bdev
(
sb
->
s_bdev
);

3629 *
‹ig_d©a
 = 
	`k°rdup
(
d©a
, 
GFP_KERNEL
);

3630 
buf„r_hód
 *
bh
, **
group_desc
;

3631 
pxt4_su≥r_block
 *
es
 = 
NULL
;

3632 
pxt4_sb_öfo
 *
sbi
 = 
	`kzÆloc
((*sbi), 
GFP_KERNEL
);

3633 
Êex_groups
 **flex_groups;

3634 
pxt4_fsblk_t
 
block
;

3635 
pxt4_fsblk_t
 
sb_block
 = 
	`gë_sb_block
(&
d©a
);

3636 
pxt4_fsblk_t
 
logiˇl_sb_block
;

3637 
off£t
 = 0;

3638 
jou∫Æ_devnum
 = 0;

3639 
def_mou¡_›ts
;

3640 
öode
 *
roŸ
;

3641 c⁄° *
des¸
;

3642 
ªt
 = -
ENOMEM
;

3643 
blocksize
, 
˛u°îsize
;

3644 
db_cou¡
;

3645 
i
;

3646 
√eds_ªcovîy
, 
has_huge_fûes
, 
has_bigÆloc
;

3647 
__u64
 
blocks_cou¡
;

3648 
îr
 = 0;

3649 
jou∫Æ_i›rio
 = 
DEFAULT_JOURNAL_IOPRIO
;

3650 
pxt4_group_t
 
fú°_nŸ_zî€d
;

3652 i‡((
d©a
 && !
‹ig_d©a
Ë|| !
sbi
)

3653 
out_‰ì_ba£
;

3655 
sbi
->
s_daxdev
 = 
dax_dev
;

3656 
sbi
->
s_blockgroup_lock
 =

3657 
	`kzÆloc
((
blockgroup_lock
), 
GFP_KERNEL
);

3658 i‡(!
sbi
->
s_blockgroup_lock
)

3659 
out_‰ì_ba£
;

3661 
sb
->
s_fs_öfo
 = 
sbi
;

3662 
sbi
->
s_sb
 = 
sb
;

3663 
sbi
->
s_öode_ªadahód_blks
 = 
PXT4_DEF_INODE_READAHEAD_BLKS
;

3664 
sbi
->
s_sb_block
 = 
sb_block
;

3665 i‡(
sb
->
s_bdev
->
bd_∑π
)

3666 
sbi
->
s_£˘‹s_wrôãn_°¨t
 =

3667 
	`∑π_°©_ªad
(
sb
->
s_bdev
->
bd_∑π
, 
£˘‹s
[
STAT_WRITE
]);

3670 
	`°ºïœ˚
(
sb
->
s_id
, '/', '!');

3673 
ªt
 = -
EINVAL
;

3674 
blocksize
 = 
	`sb_mö_blocksize
(
sb
, 
PXT4_MIN_BLOCK_SIZE
);

3675 i‡(!
blocksize
) {

3676 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "unableÅo set blocksize");

3677 
out_Áû
;

3684 i‡(
blocksize
 !
PXT4_MIN_BLOCK_SIZE
) {

3685 
logiˇl_sb_block
 = 
sb_block
 * 
PXT4_MIN_BLOCK_SIZE
;

3686 
off£t
 = 
	`do_div
(
logiˇl_sb_block
, 
blocksize
);

3688 
logiˇl_sb_block
 = 
sb_block
;

3691 i‡(!(
bh
 = 
	`sb_bªad_unmovabÀ
(
sb
, 
logiˇl_sb_block
))) {

3692 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "unableÅoÑead superblock");

3693 
out_Áû
;

3699 
es
 = (
pxt4_su≥r_block
 *Ë(
bh
->
b_d©a
 + 
off£t
);

3700 
sbi
->
s_es
 = 
es
;

3701 
sb
->
s_magic
 = 
	`À16_to_˝u
(
es
->s_magic);

3702 i‡(
sb
->
s_magic
 !
PXT4_SUPER_MAGIC
)

3703 
ˇ¡föd_pxt4
;

3704 
sbi
->
s_kbyãs_wrôãn
 = 
	`À64_to_˝u
(
es
->s_kbytes_written);

3707 i‡(
	`pxt4_has_„©uª_mëad©a_csum
(
sb
) &&

3708 
	`pxt4_has_„©uª_gdt_csum
(
sb
))

3709 
	`pxt4_w¨nög
(
sb
, "metadata_csumánd uninit_bgáre "

3713 i‡(!
	`pxt4_vîify_csum_ty≥
(
sb
, 
es
)) {

3714 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "VFS: FoundÖxt4 filesystem with "

3716 
sûít
 = 1;

3717 
ˇ¡föd_pxt4
;

3721 
sbi
->
s_chksum_drivî
 = 
	`¸y±o_Æloc_shash
("crc32c", 0, 0);

3722 i‡(
	`IS_ERR
(
sbi
->
s_chksum_drivî
)) {

3723 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "CannotÜoad crc32c driver.");

3724 
ªt
 = 
	`PTR_ERR
(
sbi
->
s_chksum_drivî
);

3725 
sbi
->
s_chksum_drivî
 = 
NULL
;

3726 
Áûed_mou¡
;

3730 i‡(!
	`pxt4_su≥rblock_csum_vîify
(
sb
, 
es
)) {

3731 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "VFS: FoundÖxt4 filesystem with "

3733 
sûít
 = 1;

3734 
ªt
 = -
EFSBADCRC
;

3735 
ˇ¡föd_pxt4
;

3739 i‡(
	`pxt4_has_„©uª_csum_£ed
(
sb
))

3740 
sbi
->
s_csum_£ed
 = 
	`À32_to_˝u
(
es
->
s_checksum_£ed
);

3741 i‡(
	`pxt4_has_mëad©a_csum
(
sb
Ë|| 
	`pxt4_has_„©uª_ó_öode
(sb))

3742 
sbi
->
s_csum_£ed
 = 
	`pxt4_chksum
(sbi, ~0, 
es
->
s_uuid
,

3743 (
es
->
s_uuid
));

3746 
def_mou¡_›ts
 = 
	`À32_to_˝u
(
es
->
s_deÁu…_mou¡_›ts
);

3747 
	`£t_›t
(
sb
, 
INIT_INODE_TABLE
);

3748 i‡(
def_mou¡_›ts
 & 
PXT4_DEFM_DEBUG
)

3749 
	`£t_›t
(
sb
, 
DEBUG
);

3750 i‡(
def_mou¡_›ts
 & 
PXT4_DEFM_BSDGROUPS
)

3751 
	`£t_›t
(
sb
, 
GRPID
);

3752 i‡(
def_mou¡_›ts
 & 
PXT4_DEFM_UID16
)

3753 
	`£t_›t
(
sb
, 
NO_UID32
);

3755 
	`£t_›t
(
sb
, 
XATTR_USER
);

3756 #ifde‡
CONFIG_PXT4_FS_POSIX_ACL


3757 
	`£t_›t
(
sb
, 
POSIX_ACL
);

3760 i‡(
	`pxt4_has_mëad©a_csum
(
sb
))

3761 
	`£t_›t
(
sb
, 
JOURNAL_CHECKSUM
);

3763 i‡((
def_mou¡_›ts
 & 
PXT4_DEFM_JMODE
Ë=
PXT4_DEFM_JMODE_DATA
)

3764 
	`£t_›t
(
sb
, 
JOURNAL_DATA
);

3765 i‡((
def_mou¡_›ts
 & 
PXT4_DEFM_JMODE
Ë=
PXT4_DEFM_JMODE_ORDERED
)

3766 
	`£t_›t
(
sb
, 
ORDERED_DATA
);

3767 i‡((
def_mou¡_›ts
 & 
PXT4_DEFM_JMODE
Ë=
PXT4_DEFM_JMODE_WBACK
)

3768 
	`£t_›t
(
sb
, 
WRITEBACK_DATA
);

3770 i‡(
	`À16_to_˝u
(
sbi
->
s_es
->
s_îr‹s
Ë=
PXT4_ERRORS_PANIC
)

3771 
	`£t_›t
(
sb
, 
ERRORS_PANIC
);

3772 i‡(
	`À16_to_˝u
(
sbi
->
s_es
->
s_îr‹s
Ë=
PXT4_ERRORS_CONTINUE
)

3773 
	`£t_›t
(
sb
, 
ERRORS_CONT
);

3775 
	`£t_›t
(
sb
, 
ERRORS_RO
);

3777 
	`£t_›t
(
sb
, 
BLOCK_VALIDITY
);

3778 i‡(
def_mou¡_›ts
 & 
PXT4_DEFM_DISCARD
)

3779 
	`£t_›t
(
sb
, 
DISCARD
);

3781 
sbi
->
s_ªsuid
 = 
	`make_kuid
(&
öô_u£r_ns
, 
	`À16_to_˝u
(
es
->
s_def_ªsuid
));

3782 
sbi
->
s_ªsgid
 = 
	`make_kgid
(&
öô_u£r_ns
, 
	`À16_to_˝u
(
es
->
s_def_ªsgid
));

3783 
sbi
->
s_commô_öãrvÆ
 = 
JBD3_DEFAULT_MAX_COMMIT_AGE
 * 
HZ
;

3784 
sbi
->
s_mö_b©ch_time
 = 
PXT4_DEF_MIN_BATCH_TIME
;

3785 
sbi
->
s_max_b©ch_time
 = 
PXT4_DEF_MAX_BATCH_TIME
;

3787 i‡((
def_mou¡_›ts
 & 
PXT4_DEFM_NOBARRIER
) == 0)

3788 
	`£t_›t
(
sb
, 
BARRIER
);

3794 i‡(!
	`IS_EXT3_SB
(
sb
Ë&& !
	`IS_EXT2_SB
(sb) &&

3795 ((
def_mou¡_›ts
 & 
PXT4_DEFM_NODELALLOC
) == 0))

3796 
	`£t_›t
(
sb
, 
DELALLOC
);

3802 
sbi
->
s_li_waô_mu…
 = 
PXT4_DEF_LI_WAIT_MULT
;

3804 
blocksize
 = 
BLOCK_SIZE
 << 
	`À32_to_˝u
(
es
->
s_log_block_size
);

3805 i‡(
blocksize
 < 
PXT4_MIN_BLOCK_SIZE
 ||

3806 
blocksize
 > 
PXT4_MAX_BLOCK_SIZE
) {

3807 
	`pxt4_msg
(
sb
, 
KERN_ERR
,

3809 
blocksize
, 
	`À32_to_˝u
(
es
->
s_log_block_size
));

3810 
Áûed_mou¡
;

3813 i‡(
	`À32_to_˝u
(
es
->
s_ªv_Àvñ
Ë=
PXT4_GOOD_OLD_REV
) {

3814 
sbi
->
s_öode_size
 = 
PXT4_GOOD_OLD_INODE_SIZE
;

3815 
sbi
->
s_fú°_öo
 = 
PXT4_GOOD_OLD_FIRST_INO
;

3817 
sbi
->
s_öode_size
 = 
	`À16_to_˝u
(
es
->s_inode_size);

3818 
sbi
->
s_fú°_öo
 = 
	`À32_to_˝u
(
es
->s_first_ino);

3819 i‡(
sbi
->
s_fú°_öo
 < 
PXT4_GOOD_OLD_FIRST_INO
) {

3820 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "invalid first ino: %u",

3821 
sbi
->
s_fú°_öo
);

3822 
Áûed_mou¡
;

3824 i‡((
sbi
->
s_öode_size
 < 
PXT4_GOOD_OLD_INODE_SIZE
) ||

3825 (!
	`is_powî_of_2
(
sbi
->
s_öode_size
)) ||

3826 (
sbi
->
s_öode_size
 > 
blocksize
)) {

3827 
	`pxt4_msg
(
sb
, 
KERN_ERR
,

3829 
sbi
->
s_öode_size
);

3830 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "blocksize: %d", 
blocksize
);

3831 
Áûed_mou¡
;

3839 i‡(
sbi
->
s_öode_size
 >
	`off£tof
(
pxt4_öode
, 
i_©ime_exåa
) +

3840 (((
pxt4_öode
 *)0)->
i_©ime_exåa
)) {

3841 
sb
->
s_time_gøn
 = 1;

3842 
sb
->
s_time_max
 = 
PXT4_EXTRA_TIMESTAMP_MAX
;

3844 
sb
->
s_time_gøn
 = 
NSEC_PER_SEC
;

3845 
sb
->
s_time_max
 = 
PXT4_NON_EXTRA_TIMESTAMP_MAX
;

3847 
sb
->
s_time_mö
 = 
PXT4_TIMESTAMP_MIN
;

3849 i‡(
sbi
->
s_öode_size
 > 
PXT4_GOOD_OLD_INODE_SIZE
) {

3850 
sbi
->
s_w™t_exåa_isize
 = (
pxt4_öode
) -

3851 
PXT4_GOOD_OLD_INODE_SIZE
;

3852 i‡(
	`pxt4_has_„©uª_exåa_isize
(
sb
)) {

3853 
v
, 
max
 = (
sbi
->
s_öode_size
 -

3854 
PXT4_GOOD_OLD_INODE_SIZE
);

3856 
v
 = 
	`À16_to_˝u
(
es
->
s_w™t_exåa_isize
);

3857 i‡(
v
 > 
max
) {

3858 
	`pxt4_msg
(
sb
, 
KERN_ERR
,

3859 "bad s_w™t_exåa_isize: %d", 
v
);

3860 
Áûed_mou¡
;

3862 i‡(
sbi
->
s_w™t_exåa_isize
 < 
v
)

3863 
sbi
->
s_w™t_exåa_isize
 = 
v
;

3865 
v
 = 
	`À16_to_˝u
(
es
->
s_mö_exåa_isize
);

3866 i‡(
v
 > 
max
) {

3867 
	`pxt4_msg
(
sb
, 
KERN_ERR
,

3868 "bad s_mö_exåa_isize: %d", 
v
);

3869 
Áûed_mou¡
;

3871 i‡(
sbi
->
s_w™t_exåa_isize
 < 
v
)

3872 
sbi
->
s_w™t_exåa_isize
 = 
v
;

3876 i‡(
sbi
->
s_es
->
s_mou¡_›ts
[0]) {

3877 *
s_mou¡_›ts
 = 
	`k°∫dup
(
sbi
->
s_es
->s_mount_opts,

3878 (
sbi
->
s_es
->
s_mou¡_›ts
),

3879 
GFP_KERNEL
);

3880 i‡(!
s_mou¡_›ts
)

3881 
Áûed_mou¡
;

3882 i‡(!
	`∑r£_›ti⁄s
(
s_mou¡_›ts
, 
sb
, &
jou∫Æ_devnum
,

3883 &
jou∫Æ_i›rio
, 0)) {

3884 
	`pxt4_msg
(
sb
, 
KERN_WARNING
,

3886 
s_mou¡_›ts
);

3888 
	`k‰ì
(
s_mou¡_›ts
);

3890 
sbi
->
s_def_mou¡_›t
 = sbi->
s_mou¡_›t
;

3891 i‡(!
	`∑r£_›ti⁄s
((*Ë
d©a
, 
sb
, &
jou∫Æ_devnum
,

3892 &
jou∫Æ_i›rio
, 0))

3893 
Áûed_mou¡
;

3895 #ifde‡
CONFIG_UNICODE


3896 i‡(
	`pxt4_has_„©uª_ˇ£fﬁd
(
sb
Ë&& !
sbi
->
s_ícodög
) {

3897 c⁄° 
pxt4_sb_ícodögs
 *
ícodög_öfo
;

3898 
unicode_m≠
 *
ícodög
;

3899 
__u16
 
ícodög_Êags
;

3901 i‡(
	`pxt4_has_„©uª_í¸y±
(
sb
)) {

3902 
	`pxt4_msg
(
sb
, 
KERN_ERR
,

3904 
Áûed_mou¡
;

3907 i‡(
	`pxt4_sb_ªad_ícodög
(
es
, &
ícodög_öfo
,

3908 &
ícodög_Êags
)) {

3909 
	`pxt4_msg
(
sb
, 
KERN_ERR
,

3911 
Áûed_mou¡
;

3914 
ícodög
 = 
	`utf8_lﬂd
(
ícodög_öfo
->
vîsi⁄
);

3915 i‡(
	`IS_ERR
(
ícodög
)) {

3916 
	`pxt4_msg
(
sb
, 
KERN_ERR
,

3919 
ícodög_öfo
->
«me
,Éncodög_öfo->
vîsi⁄
,

3920 
ícodög_Êags
);

3921 
Áûed_mou¡
;

3923 
	`pxt4_msg
(
sb
, 
KERN_INFO
,"UsingÉncoding defined by superblock: "

3924 "%s-%†wôh fœg†0x%hx", 
ícodög_öfo
->
«me
,

3925 
ícodög_öfo
->
vîsi⁄
?:"\b", 
ícodög_Êags
);

3927 
sbi
->
s_ícodög
 = 
ícodög
;

3928 
sbi
->
s_ícodög_Êags
 = 
ícodög_Êags
;

3932 i‡(
	`ã°_›t
(
sb
, 
DATA_FLAGS
Ë=
PXT4_MOUNT_JOURNAL_DATA
) {

3933 
	`¥ötk_⁄˚
(
KERN_WARNING
 "PXT4-fs: Warning: mounting "

3936 i‡(
	`ã°_›t2
(
sb
, 
EXPLICIT_DELALLOC
)) {

3937 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "can't mount with "

3939 
Áûed_mou¡
;

3941 i‡(
	`ã°_›t
(
sb
, 
DIOREAD_NOLOCK
)) {

3942 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "can't mount with "

3944 
Áûed_mou¡
;

3946 i‡(
	`ã°_›t
(
sb
, 
DAX
)) {

3947 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "can't mount with "

3949 
Áûed_mou¡
;

3951 i‡(
	`pxt4_has_„©uª_í¸y±
(
sb
)) {

3952 
	`pxt4_msg
(
sb
, 
KERN_WARNING
,

3956 i‡(
	`ã°_›t
(
sb
, 
DELALLOC
))

3957 
	`˛ór_›t
(
sb
, 
DELALLOC
);

3959 
sb
->
s_iÊags
 |
SB_I_CGROUPWB
;

3962 
sb
->
s_Êags
 = (sb->s_Êag†& ~
SB_POSIXACL
) |

3963 (
	`ã°_›t
(
sb
, 
POSIX_ACL
Ë? 
SB_POSIXACL
 : 0);

3965 i‡(
	`À32_to_˝u
(
es
->
s_ªv_Àvñ
Ë=
PXT4_GOOD_OLD_REV
 &&

3966 (
	`pxt4_has_com∑t_„©uªs
(
sb
) ||

3967 
	`pxt4_has_ro_com∑t_„©uªs
(
sb
) ||

3968 
	`pxt4_has_öcom∑t_„©uªs
(
sb
)))

3969 
	`pxt4_msg
(
sb
, 
KERN_WARNING
,

3973 i‡(
es
->
s_¸ót‹_os
 =
	`˝u_to_À32
(
PXT4_OS_HURD
)) {

3974 
	`£t_›t2
(
sb
, 
HURD_COMPAT
);

3975 i‡(
	`pxt4_has_„©uª_64bô
(
sb
)) {

3976 
	`pxt4_msg
(
sb
, 
KERN_ERR
,

3978 
Áûed_mou¡
;

3985 i‡(
	`pxt4_has_„©uª_ó_öode
(
sb
)) {

3986 
	`pxt4_msg
(
sb
, 
KERN_ERR
,

3988 
Áûed_mou¡
;

3992 i‡(
	`IS_EXT2_SB
(
sb
)) {

3993 i‡(
	`pxt2_„©uª_£t_ok
(
sb
))

3994 
	`pxt4_msg
(
sb
, 
KERN_INFO
, "mountingÖxt2 file system "

4001 i‡(
sûít
 && 
	`pxt4_„©uª_£t_ok
(
sb
, 
	`sb_rd⁄ly
(sb)))

4002 
Áûed_mou¡
;

4003 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "couldn't mountásÖxt2 due "

4005 
Áûed_mou¡
;

4009 i‡(
	`IS_EXT3_SB
(
sb
)) {

4010 i‡(
	`ext3_„©uª_£t_ok
(
sb
))

4011 
	`pxt4_msg
(
sb
, 
KERN_INFO
, "mountingÉxt3 file system "

4018 i‡(
sûít
 && 
	`pxt4_„©uª_£t_ok
(
sb
, 
	`sb_rd⁄ly
(sb)))

4019 
Áûed_mou¡
;

4020 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "couldn't mountásÉxt3 due "

4022 
Áûed_mou¡
;

4031 i‡(!
	`pxt4_„©uª_£t_ok
(
sb
, (
	`sb_rd⁄ly
(sb))))

4032 
Áûed_mou¡
;

4034 i‡(
	`À32_to_˝u
(
es
->
s_log_block_size
) >

4035 (
PXT4_MAX_BLOCK_LOG_SIZE
 - 
PXT4_MIN_BLOCK_LOG_SIZE
)) {

4036 
	`pxt4_msg
(
sb
, 
KERN_ERR
,

4038 
	`À32_to_˝u
(
es
->
s_log_block_size
));

4039 
Áûed_mou¡
;

4041 i‡(
	`À32_to_˝u
(
es
->
s_log_˛u°î_size
) >

4042 (
PXT4_MAX_CLUSTER_LOG_SIZE
 - 
PXT4_MIN_BLOCK_LOG_SIZE
)) {

4043 
	`pxt4_msg
(
sb
, 
KERN_ERR
,

4045 
	`À32_to_˝u
(
es
->
s_log_˛u°î_size
));

4046 
Áûed_mou¡
;

4049 i‡(
	`À16_to_˝u
(
sbi
->
s_es
->
s_ª£rved_gdt_blocks
Ë> (
blocksize
 / 4)) {

4050 
	`pxt4_msg
(
sb
, 
KERN_ERR
,

4052 
	`À16_to_˝u
(
sbi
->
s_es
->
s_ª£rved_gdt_blocks
));

4053 
Áûed_mou¡
;

4056 i‡(
sbi
->
s_mou¡_›t
 & 
PXT4_MOUNT_DAX
) {

4057 i‡(
	`pxt4_has_„©uª_ölöe_d©a
(
sb
)) {

4058 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "Cannot use DAX oná filesystem"

4060 
Áûed_mou¡
;

4062 i‡(!
	`bdev_dax_suµ‹ãd
(
sb
->
s_bdev
, 
blocksize
)) {

4063 
	`pxt4_msg
(
sb
, 
KERN_ERR
,

4065 
Áûed_mou¡
;

4069 i‡(
	`pxt4_has_„©uª_í¸y±
(
sb
Ë&& 
es
->
s_í¸y±i⁄_Àvñ
) {

4070 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "UnsupportedÉncryptionÜevel %d",

4071 
es
->
s_í¸y±i⁄_Àvñ
);

4072 
Áûed_mou¡
;

4075 i‡(
sb
->
s_blocksize
 !
blocksize
) {

4077 i‡(!
	`sb_£t_blocksize
(
sb
, 
blocksize
)) {

4078 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "bad block size %d",

4079 
blocksize
);

4080 
Áûed_mou¡
;

4083 
	`bªl£
(
bh
);

4084 
logiˇl_sb_block
 = 
sb_block
 * 
PXT4_MIN_BLOCK_SIZE
;

4085 
off£t
 = 
	`do_div
(
logiˇl_sb_block
, 
blocksize
);

4086 
bh
 = 
	`sb_bªad_unmovabÀ
(
sb
, 
logiˇl_sb_block
);

4087 i‡(!
bh
) {

4088 
	`pxt4_msg
(
sb
, 
KERN_ERR
,

4090 
Áûed_mou¡
;

4092 
es
 = (
pxt4_su≥r_block
 *)(
bh
->
b_d©a
 + 
off£t
);

4093 
sbi
->
s_es
 = 
es
;

4094 i‡(
es
->
s_magic
 !
	`˝u_to_À16
(
PXT4_SUPER_MAGIC
)) {

4095 
	`pxt4_msg
(
sb
, 
KERN_ERR
,

4097 
Áûed_mou¡
;

4101 
has_huge_fûes
 = 
	`pxt4_has_„©uª_huge_fûe
(
sb
);

4102 
sbi
->
s_bôm≠_maxbyãs
 = 
	`pxt4_max_bôm≠_size
(
sb
->
s_blocksize_bôs
,

4103 
has_huge_fûes
);

4104 
sb
->
s_maxbyãs
 = 
	`pxt4_max_size
(sb->
s_blocksize_bôs
, 
has_huge_fûes
);

4106 
sbi
->
s_desc_size
 = 
	`À16_to_˝u
(
es
->s_desc_size);

4107 i‡(
	`pxt4_has_„©uª_64bô
(
sb
)) {

4108 i‡(
sbi
->
s_desc_size
 < 
PXT4_MIN_DESC_SIZE_64BIT
 ||

4109 
sbi
->
s_desc_size
 > 
PXT4_MAX_DESC_SIZE
 ||

4110 !
	`is_powî_of_2
(
sbi
->
s_desc_size
)) {

4111 
	`pxt4_msg
(
sb
, 
KERN_ERR
,

4113 
sbi
->
s_desc_size
);

4114 
Áûed_mou¡
;

4117 
sbi
->
s_desc_size
 = 
PXT4_MIN_DESC_SIZE
;

4119 
sbi
->
s_blocks_≥r_group
 = 
	`À32_to_˝u
(
es
->s_blocks_per_group);

4120 
sbi
->
s_öodes_≥r_group
 = 
	`À32_to_˝u
(
es
->s_inodes_per_group);

4122 
sbi
->
s_öodes_≥r_block
 = 
blocksize
 / 
	`PXT4_INODE_SIZE
(
sb
);

4123 i‡(
sbi
->
s_öodes_≥r_block
 == 0)

4124 
ˇ¡föd_pxt4
;

4125 i‡(
sbi
->
s_öodes_≥r_group
 < sbi->
s_öodes_≥r_block
 ||

4126 
sbi
->
s_öodes_≥r_group
 > 
blocksize
 * 8) {

4127 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "invalid inodesÖer group: %lu\n",

4128 
sbi
->
s_öodes_≥r_group
);

4129 
Áûed_mou¡
;

4131 
sbi
->
s_ôb_≥r_group
 = sbi->
s_öodes_≥r_group
 /

4132 
sbi
->
s_öodes_≥r_block
;

4133 
sbi
->
s_desc_≥r_block
 = 
blocksize
 / 
	`PXT4_DESC_SIZE
(
sb
);

4134 
sbi
->
s_sbh
 = 
bh
;

4135 
sbi
->
s_mou¡_°©e
 = 
	`À16_to_˝u
(
es
->
s_°©e
);

4136 
sbi
->
s_addr_≥r_block_bôs
 = 
	`ûog2
(
	`PXT4_ADDR_PER_BLOCK
(
sb
));

4137 
sbi
->
s_desc_≥r_block_bôs
 = 
	`ûog2
(
	`PXT4_DESC_PER_BLOCK
(
sb
));

4139 
i
 = 0; i < 4; i++)

4140 
sbi
->
s_hash_£ed
[
i
] = 
	`À32_to_˝u
(
es
->s_hash_seed[i]);

4141 
sbi
->
s_def_hash_vîsi⁄
 = 
es
->s_def_hash_version;

4142 i‡(
	`pxt4_has_„©uª_dú_ödex
(
sb
)) {

4143 
i
 = 
	`À32_to_˝u
(
es
->
s_Êags
);

4144 i‡(
i
 & 
EXT2_FLAGS_UNSIGNED_HASH
)

4145 
sbi
->
s_hash_unsig√d
 = 3;

4146 i‡((
i
 & 
EXT2_FLAGS_SIGNED_HASH
) == 0) {

4147 #ifde‡
__CHAR_UNSIGNED__


4148 i‡(!
	`sb_rd⁄ly
(
sb
))

4149 
es
->
s_Êags
 |=

4150 
	`˝u_to_À32
(
EXT2_FLAGS_UNSIGNED_HASH
);

4151 
sbi
->
s_hash_unsig√d
 = 3;

4153 i‡(!
	`sb_rd⁄ly
(
sb
))

4154 
es
->
s_Êags
 |=

4155 
	`˝u_to_À32
(
EXT2_FLAGS_SIGNED_HASH
);

4161 
˛u°îsize
 = 
BLOCK_SIZE
 << 
	`À32_to_˝u
(
es
->
s_log_˛u°î_size
);

4162 
has_bigÆloc
 = 
	`pxt4_has_„©uª_bigÆloc
(
sb
);

4163 i‡(
has_bigÆloc
) {

4164 i‡(
˛u°îsize
 < 
blocksize
) {

4165 
	`pxt4_msg
(
sb
, 
KERN_ERR
,

4167 "block sizê(%d)", 
˛u°îsize
, 
blocksize
);

4168 
Áûed_mou¡
;

4170 
sbi
->
s_˛u°î_bôs
 = 
	`À32_to_˝u
(
es
->
s_log_˛u°î_size
) -

4171 
	`À32_to_˝u
(
es
->
s_log_block_size
);

4172 
sbi
->
s_˛u°îs_≥r_group
 =

4173 
	`À32_to_˝u
(
es
->
s_˛u°îs_≥r_group
);

4174 i‡(
sbi
->
s_˛u°îs_≥r_group
 > 
blocksize
 * 8) {

4175 
	`pxt4_msg
(
sb
, 
KERN_ERR
,

4177 
sbi
->
s_˛u°îs_≥r_group
);

4178 
Áûed_mou¡
;

4180 i‡(
sbi
->
s_blocks_≥r_group
 !=

4181 (
sbi
->
s_˛u°îs_≥r_group
 * (
˛u°îsize
 / 
blocksize
))) {

4182 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "blocksÖer group (%lu)ánd "

4184 
sbi
->
s_blocks_≥r_group
,

4185 
sbi
->
s_˛u°îs_≥r_group
);

4186 
Áûed_mou¡
;

4189 i‡(
˛u°îsize
 !
blocksize
) {

4190 
	`pxt4_msg
(
sb
, 
KERN_ERR
,

4192 "block sizê(%d)", 
˛u°îsize
, 
blocksize
);

4193 
Áûed_mou¡
;

4195 i‡(
sbi
->
s_blocks_≥r_group
 > 
blocksize
 * 8) {

4196 
	`pxt4_msg
(
sb
, 
KERN_ERR
,

4198 
sbi
->
s_blocks_≥r_group
);

4199 
Áûed_mou¡
;

4201 
sbi
->
s_˛u°îs_≥r_group
 = sbi->
s_blocks_≥r_group
;

4202 
sbi
->
s_˛u°î_bôs
 = 0;

4204 
sbi
->
s_˛u°î_øtio
 = 
˛u°îsize
 / 
blocksize
;

4207 i‡(
sbi
->
s_blocks_≥r_group
 =
˛u°îsize
 << 3)

4208 
	`£t_›t2
(
sb
, 
STD_GROUP_SIZE
);

4214 
îr
 = 
	`gíîic_check_addªsßbÀ
(
sb
->
s_blocksize_bôs
,

4215 
	`pxt4_blocks_cou¡
(
es
));

4216 i‡(
îr
) {

4217 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "filesystem"

4219 
Áûed_mou¡
;

4222 i‡(
	`PXT4_BLOCKS_PER_GROUP
(
sb
) == 0)

4223 
ˇ¡föd_pxt4
;

4226 
blocks_cou¡
 = 
sb
->
s_bdev
->
bd_öode
->
i_size
 >> sb->
s_blocksize_bôs
;

4227 i‡(
blocks_cou¡
 && 
	`pxt4_blocks_cou¡
(
es
) > blocks_count) {

4228 
	`pxt4_msg
(
sb
, 
KERN_WARNING
, "bad geometry: block count %llu "

4230 
	`pxt4_blocks_cou¡
(
es
), 
blocks_cou¡
);

4231 
Áûed_mou¡
;

4238 i‡(
	`À32_to_˝u
(
es
->
s_fú°_d©a_block
Ë>
	`pxt4_blocks_cou¡
(es)) {

4239 
	`pxt4_msg
(
sb
, 
KERN_WARNING
, "bad geometry: first data "

4241 
	`À32_to_˝u
(
es
->
s_fú°_d©a_block
),

4242 
	`pxt4_blocks_cou¡
(
es
));

4243 
Áûed_mou¡
;

4245 i‡((
es
->
s_fú°_d©a_block
 =0Ë&& (es->
s_log_block_size
 == 0) &&

4246 (
sbi
->
s_˛u°î_øtio
 == 1)) {

4247 
	`pxt4_msg
(
sb
, 
KERN_WARNING
, "bad geometry: first data "

4249 
Áûed_mou¡
;

4252 
blocks_cou¡
 = (
	`pxt4_blocks_cou¡
(
es
) -

4253 
	`À32_to_˝u
(
es
->
s_fú°_d©a_block
) +

4254 
	`PXT4_BLOCKS_PER_GROUP
(
sb
) - 1);

4255 
	`do_div
(
blocks_cou¡
, 
	`PXT4_BLOCKS_PER_GROUP
(
sb
));

4256 i‡(
blocks_cou¡
 > ((
uöt64_t
)1<<32Ë- 
	`PXT4_DESC_PER_BLOCK
(
sb
)) {

4257 
	`pxt4_msg
(
sb
, 
KERN_WARNING
, "groups countÅooÜarge: %llu "

4259 "block†≥∏grou∞%lu)", 
blocks_cou¡
,

4260 
	`pxt4_blocks_cou¡
(
es
),

4261 
	`À32_to_˝u
(
es
->
s_fú°_d©a_block
),

4262 
	`PXT4_BLOCKS_PER_GROUP
(
sb
));

4263 
Áûed_mou¡
;

4265 
sbi
->
s_groups_cou¡
 = 
blocks_cou¡
;

4266 
sbi
->
s_blockfûe_groups
 = 
	`mö_t
(
pxt4_group_t
, sbi->
s_groups_cou¡
,

4267 (
PXT4_MAX_BLOCK_FILE_PHYS
 / 
	`PXT4_BLOCKS_PER_GROUP
(
sb
)));

4268 i‡(((
u64
)
sbi
->
s_groups_cou¡
 * sbi->
s_öodes_≥r_group
) !=

4269 
	`À32_to_˝u
(
es
->
s_öodes_cou¡
)) {

4270 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "inodes countÇot valid: %u vs %llu",

4271 
	`À32_to_˝u
(
es
->
s_öodes_cou¡
),

4272 ((
u64
)
sbi
->
s_groups_cou¡
 * sbi->
s_öodes_≥r_group
));

4273 
ªt
 = -
EINVAL
;

4274 
Áûed_mou¡
;

4276 
db_cou¡
 = (
sbi
->
s_groups_cou¡
 + 
	`PXT4_DESC_PER_BLOCK
(
sb
) - 1) /

4277 
	`PXT4_DESC_PER_BLOCK
(
sb
);

4278 i‡(
	`pxt4_has_„©uª_mëa_bg
(
sb
)) {

4279 i‡(
	`À32_to_˝u
(
es
->
s_fú°_mëa_bg
Ë> 
db_cou¡
) {

4280 
	`pxt4_msg
(
sb
, 
KERN_WARNING
,

4283 
	`À32_to_˝u
(
es
->
s_fú°_mëa_bg
), 
db_cou¡
);

4284 
Áûed_mou¡
;

4287 
	`rcu_assign_poöãr
(
sbi
->
s_group_desc
,

4288 
	`kvmÆloc_¨øy
(
db_cou¡
,

4289 (
buf„r_hód
 *),

4290 
GFP_KERNEL
));

4291 i‡(
sbi
->
s_group_desc
 =
NULL
) {

4292 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "notÉnough memory");

4293 
ªt
 = -
ENOMEM
;

4294 
Áûed_mou¡
;

4297 
	`bgl_lock_öô
(
sbi
->
s_blockgroup_lock
);

4300 
i
 = 0; i < 
db_cou¡
; i++) {

4301 
block
 = 
	`des¸ùt‹_loc
(
sb
, 
logiˇl_sb_block
, 
i
);

4302 
	`sb_bªadahód_unmovabÀ
(
sb
, 
block
);

4305 
i
 = 0; i < 
db_cou¡
; i++) {

4306 
buf„r_hód
 *
bh
;

4308 
block
 = 
	`des¸ùt‹_loc
(
sb
, 
logiˇl_sb_block
, 
i
);

4309 
bh
 = 
	`sb_bªad_unmovabÀ
(
sb
, 
block
);

4310 i‡(!
bh
) {

4311 
	`pxt4_msg
(
sb
, 
KERN_ERR
,

4312 "ˇn'àªad grou∞des¸ùt‹ %d", 
i
);

4313 
db_cou¡
 = 
i
;

4314 
Áûed_mou¡2
;

4316 
	`rcu_ªad_lock
();

4317 
	`rcu_dîe„ªn˚
(
sbi
->
s_group_desc
)[
i
] = 
bh
;

4318 
	`rcu_ªad_u∆ock
();

4320 
sbi
->
s_gdb_cou¡
 = 
db_cou¡
;

4321 i‡(!
	`pxt4_check_des¸ùt‹s
(
sb
, 
logiˇl_sb_block
, &
fú°_nŸ_zî€d
)) {

4322 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "group descriptors corrupted!");

4323 
ªt
 = -
EFSCORRUPTED
;

4324 
Áûed_mou¡2
;

4327 
	`timî_£tup
(&
sbi
->
s_îr_ªp‹t
, 
¥öt_daûy_îr‹_öfo
, 0);

4330 i‡(
	`pxt4_es_ªgi°î_shrökî
(
sbi
))

4331 
Áûed_mou¡3
;

4333 
sbi
->
s_°rùe
 = 
	`pxt4_gë_°rùe_size
(sbi);

4334 
sbi
->
s_exã¡_max_zîoout_kb
 = 32;

4339 
sb
->
s_›
 = &
pxt4_s›s
;

4340 
sb
->
s_exp‹t_›
 = &
pxt4_exp‹t_›s
;

4341 
sb
->
s_x©å
 = 
pxt4_x©å_h™dÀrs
;

4342 #ifde‡
CONFIG_FS_ENCRYPTION


4343 
sb
->
s_c›
 = &
pxt4_¸y±›s
;

4345 #ifde‡
CONFIG_FS_VERITY


4346 
sb
->
s_v›
 = &
pxt4_vîôy›s
;

4348 #ifde‡
CONFIG_QUOTA


4349 
sb
->
dq_›
 = &
pxt4_quŸa_›î©i⁄s
;

4350 i‡(
	`pxt4_has_„©uª_quŸa
(
sb
))

4351 
sb
->
s_qc›
 = &
dquŸ_quŸa˘l_sysfûe_›s
;

4353 
sb
->
s_qc›
 = &
pxt4_q˘l_›î©i⁄s
;

4354 
sb
->
s_quŸa_ty≥s
 = 
QTYPE_MASK_USR
 | 
QTYPE_MASK_GRP
 | 
QTYPE_MASK_PRJ
;

4356 
	`mem˝y
(&
sb
->
s_uuid
, 
es
->s_uuid, (es->s_uuid));

4358 
	`INIT_LIST_HEAD
(&
sbi
->
s_‹ph™
);

4359 
	`muãx_öô
(&
sbi
->
s_‹ph™_lock
);

4361 
sb
->
s_roŸ
 = 
NULL
;

4363 
√eds_ªcovîy
 = (
es
->
s_œ°_‹ph™
 != 0 ||

4364 
	`pxt4_has_„©uª_jou∫Æ_√eds_ªcovîy
(
sb
));

4366 i‡(
	`pxt4_has_„©uª_mmp
(
sb
Ë&& !
	`sb_rd⁄ly
(sb))

4367 i‡(
	`pxt4_mu…i_mou¡_¥Ÿe˘
(
sb
, 
	`À64_to_˝u
(
es
->
s_mmp_block
)))

4368 
Áûed_mou¡3a
;

4374 i‡(!
	`ã°_›t
(
sb
, 
NOLOAD
Ë&& 
	`pxt4_has_„©uª_jou∫Æ
(sb)) {

4375 
îr
 = 
	`pxt4_lﬂd_jou∫Æ
(
sb
, 
es
, 
jou∫Æ_devnum
);

4376 i‡(
îr
)

4377 
Áûed_mou¡3a
;

4378 } i‡(
	`ã°_›t
(
sb
, 
NOLOAD
Ë&& !
	`sb_rd⁄ly
(sb) &&

4379 
	`pxt4_has_„©uª_jou∫Æ_√eds_ªcovîy
(
sb
)) {

4380 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "required journalÑecovery "

4382 
Áûed_mou¡_wq
;

4385 i‡(
	`ã°_›t2
(
sb
, 
EXPLICIT_JOURNAL_CHECKSUM
)) {

4386 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "can't mount with "

4388 
Áûed_mou¡_wq
;

4390 i‡(
	`ã°_›t
(
sb
, 
JOURNAL_ASYNC_COMMIT
)) {

4391 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "can't mount with "

4393 
Áûed_mou¡_wq
;

4395 i‡(
sbi
->
s_commô_öãrvÆ
 !
JBD3_DEFAULT_MAX_COMMIT_AGE
*
HZ
) {

4396 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "can't mount with "

4398 
sbi
->
s_commô_öãrvÆ
 / 
HZ
);

4399 
Áûed_mou¡_wq
;

4401 i‡(
PXT4_MOUNT_DATA_FLAGS
 &

4402 (
sbi
->
s_mou¡_›t
 ^ sbi->
s_def_mou¡_›t
)) {

4403 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "can't mount with "

4405 
Áûed_mou¡_wq
;

4407 
sbi
->
s_def_mou¡_›t
 &~
PXT4_MOUNT_JOURNAL_CHECKSUM
;

4408 
	`˛ór_›t
(
sb
, 
JOURNAL_CHECKSUM
);

4409 
	`˛ór_›t
(
sb
, 
DATA_FLAGS
);

4410 
sbi
->
s_jou∫Æ
 = 
NULL
;

4411 
√eds_ªcovîy
 = 0;

4412 
no_jou∫Æ
;

4415 i‡(
	`pxt4_has_„©uª_64bô
(
sb
) &&

4416 !
	`jbd3_jou∫Æ_£t_„©uªs
(
	`PXT4_SB
(
sb
)->
s_jou∫Æ
, 0, 0,

4417 
JBD3_FEATURE_INCOMPAT_64BIT
)) {

4418 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "FailedÅo set 64-bit journal feature");

4419 
Áûed_mou¡_wq
;

4422 i‡(!
	`£t_jou∫Æ_csum_„©uª_£t
(
sb
)) {

4423 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "FailedÅo set journal checksum "

4425 
Áûed_mou¡_wq
;

4430 
	`ã°_›t
(
sb
, 
DATA_FLAGS
)) {

4436 i‡(
jbd3_jou∫Æ_check_avaûabÀ_„©uªs


4437 (
sbi
->
s_jou∫Æ
, 0, 0, 
JBD3_FEATURE_INCOMPAT_REVOKE
)) {

4438 
	`£t_›t
(
sb
, 
ORDERED_DATA
);

4439 
sbi
->
s_def_mou¡_›t
 |
PXT4_MOUNT_ORDERED_DATA
;

4441 
	`£t_›t
(
sb
, 
JOURNAL_DATA
);

4442 
sbi
->
s_def_mou¡_›t
 |
PXT4_MOUNT_JOURNAL_DATA
;

4446 
PXT4_MOUNT_ORDERED_DATA
:

4447 
PXT4_MOUNT_WRITEBACK_DATA
:

4448 i‡(!
jbd3_jou∫Æ_check_avaûabÀ_„©uªs


4449 (
sbi
->
s_jou∫Æ
, 0, 0, 
JBD3_FEATURE_INCOMPAT_REVOKE
)) {

4450 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "Journal doesÇot support "

4452 
Áûed_mou¡_wq
;

4458 i‡(
	`ã°_›t
(
sb
, 
DATA_FLAGS
Ë=
PXT4_MOUNT_ORDERED_DATA
 &&

4459 
	`ã°_›t
(
sb
, 
JOURNAL_ASYNC_COMMIT
)) {

4460 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "can't mount with "

4462 
Áûed_mou¡_wq
;

4465 
	`£t_èsk_i›rio
(
sbi
->
s_jou∫Æ
->
j_èsk
, 
jou∫Æ_i›rio
);

4467 
sbi
->
s_jou∫Æ
->
j_commô_ˇŒback
 = 
pxt4_jou∫Æ_commô_ˇŒback
;

4469 
no_jou∫Æ
:

4470 i‡(!
	`ã°_›t
(
sb
, 
NO_MBCACHE
)) {

4471 
sbi
->
s_ó_block_ˇche
 = 
	`pxt4_x©å_¸óã_ˇche
();

4472 i‡(!
sbi
->
s_ó_block_ˇche
) {

4473 
	`pxt4_msg
(
sb
, 
KERN_ERR
,

4475 
Áûed_mou¡_wq
;

4478 i‡(
	`pxt4_has_„©uª_ó_öode
(
sb
)) {

4479 
sbi
->
s_ó_öode_ˇche
 = 
	`pxt4_x©å_¸óã_ˇche
();

4480 i‡(!
sbi
->
s_ó_öode_ˇche
) {

4481 
	`pxt4_msg
(
sb
, 
KERN_ERR
,

4483 
Áûed_mou¡_wq
;

4488 i‡((
	`DUMMY_ENCRYPTION_ENABLED
(
sbi
Ë|| 
	`pxt4_has_„©uª_í¸y±
(
sb
)) &&

4489 (
blocksize
 !
PAGE_SIZE
)) {

4490 
	`pxt4_msg
(
sb
, 
KERN_ERR
,

4492 
Áûed_mou¡_wq
;

4495 i‡(
	`pxt4_has_„©uª_vîôy
(
sb
Ë&& 
blocksize
 !
PAGE_SIZE
) {

4496 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "Unsupported blocksize for fs-verity");

4497 
Áûed_mou¡_wq
;

4500 i‡(
	`DUMMY_ENCRYPTION_ENABLED
(
sbi
Ë&& !
	`sb_rd⁄ly
(
sb
) &&

4501 !
	`pxt4_has_„©uª_í¸y±
(
sb
)) {

4502 
	`pxt4_£t_„©uª_í¸y±
(
sb
);

4503 
	`pxt4_commô_su≥r
(
sb
, 1);

4510 i‡(
es
->
s_ovîhód_˛u°îs
)

4511 
sbi
->
s_ovîhód
 = 
	`À32_to_˝u
(
es
->
s_ovîhód_˛u°îs
);

4513 
îr
 = 
	`pxt4_ˇlcuœã_ovîhód
(
sb
);

4514 i‡(
îr
)

4515 
Áûed_mou¡_wq
;

4522 
	`PXT4_SB
(
sb
)->
rsv_c⁄vîsi⁄_wq
 =

4523 
	`Æloc_w‹kqueue
("pxt4-rsv-c⁄vîsi⁄", 
WQ_MEM_RECLAIM
 | 
WQ_UNBOUND
, 1);

4524 i‡(!
	`PXT4_SB
(
sb
)->
rsv_c⁄vîsi⁄_wq
) {

4525 
	`¥ötk
(
KERN_ERR
 "PXT4-fs: failedÅo create workqueue\n");

4526 
ªt
 = -
ENOMEM
;

4527 
Áûed_mou¡4
;

4535 
roŸ
 = 
	`pxt4_igë
(
sb
, 
PXT4_ROOT_INO
, 
PXT4_IGET_SPECIAL
);

4536 i‡(
	`IS_ERR
(
roŸ
)) {

4537 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "getÑoot inode failed");

4538 
ªt
 = 
	`PTR_ERR
(
roŸ
);

4539 
roŸ
 = 
NULL
;

4540 
Áûed_mou¡4
;

4542 i‡(!
	`S_ISDIR
(
roŸ
->
i_mode
Ë|| !roŸ->
i_blocks
 || !roŸ->
i_size
) {

4543 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "corruptÑoot inode,ÑunÉ2fsck");

4544 
	`ùut
(
roŸ
);

4545 
Áûed_mou¡4
;

4548 #ifde‡
CONFIG_UNICODE


4549 i‡(
sbi
->
s_ícodög
)

4550 
sb
->
s_d_›
 = &
pxt4_díåy_›s
;

4553 
sb
->
s_roŸ
 = 
	`d_make_roŸ
(
roŸ
);

4554 i‡(!
sb
->
s_roŸ
) {

4555 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "getÑoot dentry failed");

4556 
ªt
 = -
ENOMEM
;

4557 
Áûed_mou¡4
;

4560 
ªt
 = 
	`pxt4_£tup_su≥r
(
sb
, 
es
, 
	`sb_rd⁄ly
(sb));

4561 i‡(
ªt
 =-
EROFS
) {

4562 
sb
->
s_Êags
 |
SB_RDONLY
;

4563 
ªt
 = 0;

4564 } i‡(
ªt
)

4565 
Áûed_mou¡4a
;

4567 
	`pxt4_£t_ªsv_˛u°îs
(
sb
);

4569 i‡(
	`ã°_›t
(
sb
, 
BLOCK_VALIDITY
)) {

4570 
îr
 = 
	`pxt4_£tup_sy°em_z⁄e
(
sb
);

4571 i‡(
îr
) {

4572 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "failedÅo initialize system "

4573 "z⁄ê(%d)", 
îr
);

4574 
Áûed_mou¡4a
;

4578 
	`pxt4_ext_öô
(
sb
);

4579 
îr
 = 
	`pxt4_mb_öô
(
sb
);

4580 i‡(
îr
) {

4581 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "failedÅo initialize mballoc (%d)",

4582 
îr
);

4583 
Áûed_mou¡5
;

4586 
block
 = 
	`pxt4_cou¡_‰ì_˛u°îs
(
sb
);

4587 
	`pxt4_‰ì_blocks_cou¡_£t
(
sbi
->
s_es
,

4588 
	`PXT4_C2B
(
sbi
, 
block
));

4589 
	`pxt4_su≥rblock_csum_£t
(
sb
);

4590 
îr
 = 
	`≥r˝u_cou¡î_öô
(&
sbi
->
s_‰ì˛u°îs_cou¡î
, 
block
,

4591 
GFP_KERNEL
);

4592 i‡(!
îr
) {

4593 
‰ìi
 = 
	`pxt4_cou¡_‰ì_öodes
(
sb
);

4594 
sbi
->
s_es
->
s_‰ì_öodes_cou¡
 = 
	`˝u_to_À32
(
‰ìi
);

4595 
	`pxt4_su≥rblock_csum_£t
(
sb
);

4596 
îr
 = 
	`≥r˝u_cou¡î_öô
(&
sbi
->
s_‰ìöodes_cou¡î
, 
‰ìi
,

4597 
GFP_KERNEL
);

4599 i‡(!
îr
)

4600 
îr
 = 
	`≥r˝u_cou¡î_öô
(&
sbi
->
s_dús_cou¡î
,

4601 
	`pxt4_cou¡_dús
(
sb
), 
GFP_KERNEL
);

4602 i‡(!
îr
)

4603 
îr
 = 
	`≥r˝u_cou¡î_öô
(&
sbi
->
s_dúty˛u°îs_cou¡î
, 0,

4604 
GFP_KERNEL
);

4605 i‡(!
îr
)

4606 
îr
 = 
	`≥r˝u_cou¡î_öô
(&
sbi
->
s_§a_ex˚eded_ªåy_limô
, 0,

4607 
GFP_KERNEL
);

4608 i‡(!
îr
)

4609 
îr
 = 
	`≥r˝u_öô_rw£m
(&
sbi
->
s_wrôïages_rw£m
);

4611 i‡(
îr
) {

4612 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "insufficient memory");

4613 
Áûed_mou¡6
;

4616 i‡(
	`pxt4_has_„©uª_Êex_bg
(
sb
))

4617 i‡(!
	`pxt4_fûl_Êex_öfo
(
sb
)) {

4618 
	`pxt4_msg
(
sb
, 
KERN_ERR
,

4621 
ªt
 = -
ENOMEM
;

4622 
Áûed_mou¡6
;

4625 
îr
 = 
	`pxt4_ªgi°î_li_ªque°
(
sb
, 
fú°_nŸ_zî€d
);

4626 i‡(
îr
)

4627 
Áûed_mou¡6
;

4629 
îr
 = 
	`pxt4_ªgi°î_sysfs
(
sb
);

4630 i‡(
îr
)

4631 
Áûed_mou¡7
;

4633 #ifde‡
CONFIG_QUOTA


4635 i‡(
	`pxt4_has_„©uª_quŸa
(
sb
Ë&& !
	`sb_rd⁄ly
(sb)) {

4636 
îr
 = 
	`pxt4_íabÀ_quŸas
(
sb
);

4637 i‡(
îr
)

4638 
Áûed_mou¡8
;

4642 
	`PXT4_SB
(
sb
)->
s_mou¡_°©e
 |
PXT4_ORPHAN_FS
;

4643 
	`pxt4_‹ph™_˛ónup
(
sb
, 
es
);

4644 
	`PXT4_SB
(
sb
)->
s_mou¡_°©e
 &~
PXT4_ORPHAN_FS
;

4645 i‡(
√eds_ªcovîy
) {

4646 
	`pxt4_msg
(
sb
, 
KERN_INFO
, "recovery complete");

4647 
îr
 = 
	`pxt4_m¨k_ªcovîy_com∂ëe
(
sb
, 
es
);

4648 i‡(
îr
)

4649 
Áûed_mou¡8
;

4651 i‡(
	`PXT4_SB
(
sb
)->
s_jou∫Æ
) {

4652 i‡(
	`ã°_›t
(
sb
, 
DATA_FLAGS
Ë=
PXT4_MOUNT_JOURNAL_DATA
)

4653 
des¸
 = " journalled data mode";

4654 i‡(
	`ã°_›t
(
sb
, 
DATA_FLAGS
Ë=
PXT4_MOUNT_ORDERED_DATA
)

4655 
des¸
 = " ordered data mode";

4657 
des¸
 = " writeback data mode";

4659 
des¸
 = "out journal";

4661 i‡(
	`ã°_›t
(
sb
, 
DISCARD
)) {

4662 
ªque°_queue
 *
q
 = 
	`bdev_gë_queue
(
sb
->
s_bdev
);

4663 i‡(!
	`blk_queue_disˇrd
(
q
))

4664 
	`pxt4_msg
(
sb
, 
KERN_WARNING
,

4669 i‡(
	`___øãlimô
(&
pxt4_mou¡_msg_øãlimô
, "PXT4-fs mount"))

4670 
	`pxt4_msg
(
sb
, 
KERN_INFO
, "mounted filesystem with%s. "

4671 "O±s: %.*s%s%s", 
des¸
,

4672 (Ë(
sbi
->
s_es
->
s_mou¡_›ts
),

4673 
sbi
->
s_es
->
s_mou¡_›ts
,

4674 *
sbi
->
s_es
->
s_mou¡_›ts
 ? "; " : "", 
‹ig_d©a
);

4676 i‡(
es
->
s_îr‹_cou¡
)

4677 
	`mod_timî
(&
sbi
->
s_îr_ªp‹t
, 
jiffõs
 + 300*
HZ
);

4680 
	`øãlimô_°©e_öô
(&
sbi
->
s_îr_øãlimô_°©e
, 5 * 
HZ
, 10);

4681 
	`øãlimô_°©e_öô
(&
sbi
->
s_w¨nög_øãlimô_°©e
, 5 * 
HZ
, 10);

4682 
	`øãlimô_°©e_öô
(&
sbi
->
s_msg_øãlimô_°©e
, 5 * 
HZ
, 10);

4684 
	`k‰ì
(
‹ig_d©a
);

4687 
ˇ¡föd_pxt4
:

4688 i‡(!
sûít
)

4689 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "VFS: Can't findÖxt4 filesystem");

4690 
Áûed_mou¡
;

4692 
Áûed_mou¡8
:

4693 
	`pxt4_uƒegi°î_sysfs
(
sb
);

4694 
	`kobje˘_put
(&
sbi
->
s_kobj
);

4695 
Áûed_mou¡7
:

4696 
	`pxt4_uƒegi°î_li_ªque°
(
sb
);

4697 
Áûed_mou¡6
:

4698 
	`pxt4_mb_ªÀa£
(
sb
);

4699 
	`rcu_ªad_lock
();

4700 
Êex_groups
 = 
	`rcu_dîe„ªn˚
(
sbi
->
s_Êex_groups
);

4701 i‡(
Êex_groups
) {

4702 
i
 = 0; i < 
sbi
->
s_Êex_groups_Æloˇãd
; i++)

4703 
	`kv‰ì
(
Êex_groups
[
i
]);

4704 
	`kv‰ì
(
Êex_groups
);

4706 
	`rcu_ªad_u∆ock
();

4707 
	`≥r˝u_cou¡î_de°roy
(&
sbi
->
s_‰ì˛u°îs_cou¡î
);

4708 
	`≥r˝u_cou¡î_de°roy
(&
sbi
->
s_‰ìöodes_cou¡î
);

4709 
	`≥r˝u_cou¡î_de°roy
(&
sbi
->
s_dús_cou¡î
);

4710 
	`≥r˝u_cou¡î_de°roy
(&
sbi
->
s_dúty˛u°îs_cou¡î
);

4711 
	`≥r˝u_cou¡î_de°roy
(&
sbi
->
s_§a_ex˚eded_ªåy_limô
);

4712 
	`≥r˝u_‰ì_rw£m
(&
sbi
->
s_wrôïages_rw£m
);

4713 
Áûed_mou¡5
:

4714 
	`pxt4_ext_ªÀa£
(
sb
);

4715 
	`pxt4_ªÀa£_sy°em_z⁄e
(
sb
);

4716 
Áûed_mou¡4a
:

4717 
	`dput
(
sb
->
s_roŸ
);

4718 
sb
->
s_roŸ
 = 
NULL
;

4719 
Áûed_mou¡4
:

4720 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "mount failed");

4721 i‡(
	`PXT4_SB
(
sb
)->
rsv_c⁄vîsi⁄_wq
)

4722 
	`de°roy_w‹kqueue
(
	`PXT4_SB
(
sb
)->
rsv_c⁄vîsi⁄_wq
);

4723 
Áûed_mou¡_wq
:

4724 
	`pxt4_x©å_de°roy_ˇche
(
sbi
->
s_ó_öode_ˇche
);

4725 
sbi
->
s_ó_öode_ˇche
 = 
NULL
;

4727 
	`pxt4_x©å_de°roy_ˇche
(
sbi
->
s_ó_block_ˇche
);

4728 
sbi
->
s_ó_block_ˇche
 = 
NULL
;

4730 i‡(
sbi
->
s_jou∫Æ
) {

4731 
	`jbd3_jou∫Æ_de°roy
(
sbi
->
s_jou∫Æ
);

4732 
sbi
->
s_jou∫Æ
 = 
NULL
;

4734 
Áûed_mou¡3a
:

4735 
	`pxt4_es_uƒegi°î_shrökî
(
sbi
);

4736 
Áûed_mou¡3
:

4737 
	`dñ_timî_sync
(&
sbi
->
s_îr_ªp‹t
);

4738 i‡(
sbi
->
s_mmp_tsk
)

4739 
	`kthªad_°›
(
sbi
->
s_mmp_tsk
);

4740 
Áûed_mou¡2
:

4741 
	`rcu_ªad_lock
();

4742 
group_desc
 = 
	`rcu_dîe„ªn˚
(
sbi
->
s_group_desc
);

4743 
i
 = 0; i < 
db_cou¡
; i++)

4744 
	`bªl£
(
group_desc
[
i
]);

4745 
	`kv‰ì
(
group_desc
);

4746 
	`rcu_ªad_u∆ock
();

4747 
Áûed_mou¡
:

4748 i‡(
sbi
->
s_chksum_drivî
)

4749 
	`¸y±o_‰ì_shash
(
sbi
->
s_chksum_drivî
);

4751 #ifde‡
CONFIG_UNICODE


4752 
	`utf8_u∆ﬂd
(
sbi
->
s_ícodög
);

4755 #ifde‡
CONFIG_QUOTA


4756 
i
 = 0; i < 
PXT4_MAXQUOTAS
; i++)

4757 
	`k‰ì
(
	`gë_qf_«me
(
sb
, 
sbi
, 
i
));

4759 
	`pxt4_blkdev_ªmove
(
sbi
);

4760 
	`bªl£
(
bh
);

4761 
out_Áû
:

4762 
sb
->
s_fs_öfo
 = 
NULL
;

4763 
	`k‰ì
(
sbi
->
s_blockgroup_lock
);

4764 
out_‰ì_ba£
:

4765 
	`k‰ì
(
sbi
);

4766 
	`k‰ì
(
‹ig_d©a
);

4767 
	`fs_put_dax
(
dax_dev
);

4768  
îr
 ?Éº : 
ªt
;

4769 
	}
}

4776 
	$pxt4_öô_jou∫Æ_∑øms
(
su≥r_block
 *
sb
, 
jou∫Æ_t
 *
jou∫Æ
)

4778 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
sb
);

4780 
jou∫Æ
->
j_commô_öãrvÆ
 = 
sbi
->
s_commô_öãrvÆ
;

4781 
jou∫Æ
->
j_mö_b©ch_time
 = 
sbi
->
s_mö_b©ch_time
;

4782 
jou∫Æ
->
j_max_b©ch_time
 = 
sbi
->
s_max_b©ch_time
;

4784 
	`wrôe_lock
(&
jou∫Æ
->
j_°©e_lock
);

4785 i‡(
	`ã°_›t
(
sb
, 
BARRIER
))

4786 
jou∫Æ
->
j_Êags
 |
JBD3_BARRIER
;

4788 
jou∫Æ
->
j_Êags
 &~
JBD3_BARRIER
;

4789 i‡(
	`ã°_›t
(
sb
, 
DATA_ERR_ABORT
))

4790 
jou∫Æ
->
j_Êags
 |
JBD3_ABORT_ON_SYNCDATA_ERR
;

4792 
jou∫Æ
->
j_Êags
 &~
JBD3_ABORT_ON_SYNCDATA_ERR
;

4793 
	`wrôe_u∆ock
(&
jou∫Æ
->
j_°©e_lock
);

4794 
	}
}

4796 
öode
 *
	$pxt4_gë_jou∫Æ_öode
(
su≥r_block
 *
sb
,

4797 
jou∫Æ_öum
)

4799 
öode
 *
jou∫Æ_öode
;

4806 
jou∫Æ_öode
 = 
	`pxt4_igë
(
sb
, 
jou∫Æ_öum
, 
PXT4_IGET_SPECIAL
);

4807 i‡(
	`IS_ERR
(
jou∫Æ_öode
)) {

4808 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "no journal found");

4809  
NULL
;

4811 i‡(!
jou∫Æ_öode
->
i_∆ök
) {

4812 
	`make_bad_öode
(
jou∫Æ_öode
);

4813 
	`ùut
(
jou∫Æ_öode
);

4814 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "journal inode is deleted");

4815  
NULL
;

4818 
	`jbd_debug
(2, "Journal inode foundát %p: %lld bytes\n",

4819 
jou∫Æ_öode
, jou∫Æ_öode->
i_size
);

4820 i‡(!
	`S_ISREG
(
jou∫Æ_öode
->
i_mode
)) {

4821 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "invalid journal inode");

4822 
	`ùut
(
jou∫Æ_öode
);

4823  
NULL
;

4825  
jou∫Æ_öode
;

4826 
	}
}

4828 
jou∫Æ_t
 *
	$pxt4_gë_jou∫Æ
(
su≥r_block
 *
sb
,

4829 
jou∫Æ_öum
)

4831 
öode
 *
jou∫Æ_öode
;

4832 
jou∫Æ_t
 *
jou∫Æ
;

4834 i‡(
	`WARN_ON_ONCE
(!
	`pxt4_has_„©uª_jou∫Æ
(
sb
)))

4835  
NULL
;

4837 
jou∫Æ_öode
 = 
	`pxt4_gë_jou∫Æ_öode
(
sb
, 
jou∫Æ_öum
);

4838 i‡(!
jou∫Æ_öode
)

4839  
NULL
;

4841 
jou∫Æ
 = 
	`jbd3_jou∫Æ_öô_öode
(
jou∫Æ_öode
);

4842 i‡(!
jou∫Æ
) {

4843 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "CouldÇotÜoad journal inode");

4844 
	`ùut
(
jou∫Æ_öode
);

4845  
NULL
;

4847 
jou∫Æ
->
j_¥iv©e
 = 
sb
;

4848 
	`pxt4_öô_jou∫Æ_∑øms
(
sb
, 
jou∫Æ
);

4849  
jou∫Æ
;

4850 
	}
}

4852 
jou∫Æ_t
 *
	$pxt4_gë_dev_jou∫Æ
(
su≥r_block
 *
sb
,

4853 
dev_t
 
j_dev
)

4855 
buf„r_hód
 *
bh
;

4856 
jou∫Æ_t
 *
jou∫Æ
;

4857 
pxt4_fsblk_t
 
°¨t
;

4858 
pxt4_fsblk_t
 
Àn
;

4859 
hblock
, 
blocksize
;

4860 
pxt4_fsblk_t
 
sb_block
;

4861 
off£t
;

4862 
pxt4_su≥r_block
 *
es
;

4863 
block_devi˚
 *
bdev
;

4865 i‡(
	`WARN_ON_ONCE
(!
	`pxt4_has_„©uª_jou∫Æ
(
sb
)))

4866  
NULL
;

4868 
bdev
 = 
	`pxt4_blkdev_gë
(
j_dev
, 
sb
);

4869 i‡(
bdev
 =
NULL
)

4870  
NULL
;

4872 
blocksize
 = 
sb
->
s_blocksize
;

4873 
hblock
 = 
	`bdev_logiˇl_block_size
(
bdev
);

4874 i‡(
blocksize
 < 
hblock
) {

4875 
	`pxt4_msg
(
sb
, 
KERN_ERR
,

4877 
out_bdev
;

4880 
sb_block
 = 
PXT4_MIN_BLOCK_SIZE
 / 
blocksize
;

4881 
off£t
 = 
PXT4_MIN_BLOCK_SIZE
 % 
blocksize
;

4882 
	`£t_blocksize
(
bdev
, 
blocksize
);

4883 i‡(!(
bh
 = 
	`__bªad
(
bdev
, 
sb_block
, 
blocksize
))) {

4884 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "couldn'tÑead superblock of "

4886 
out_bdev
;

4889 
es
 = (
pxt4_su≥r_block
 *Ë(
bh
->
b_d©a
 + 
off£t
);

4890 i‡((
	`À16_to_˝u
(
es
->
s_magic
Ë!
PXT4_SUPER_MAGIC
) ||

4891 !(
	`À32_to_˝u
(
es
->
s_„©uª_öcom∑t
) &

4892 
PXT4_FEATURE_INCOMPAT_JOURNAL_DEV
)) {

4893 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "external journal has "

4895 
	`bªl£
(
bh
);

4896 
out_bdev
;

4899 i‡((
	`À32_to_˝u
(
es
->
s_„©uª_ro_com∑t
) &

4900 
PXT4_FEATURE_RO_COMPAT_METADATA_CSUM
) &&

4901 
es
->
s_checksum
 !
	`pxt4_su≥rblock_csum
(
sb
,És)) {

4902 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "external journal has "

4904 
	`bªl£
(
bh
);

4905 
out_bdev
;

4908 i‡(
	`memcmp
(
	`PXT4_SB
(
sb
)->
s_es
->
s_jou∫Æ_uuid
, 
es
->
s_uuid
, 16)) {

4909 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "journal UUID doesÇot match");

4910 
	`bªl£
(
bh
);

4911 
out_bdev
;

4914 
Àn
 = 
	`pxt4_blocks_cou¡
(
es
);

4915 
°¨t
 = 
sb_block
 + 1;

4916 
	`bªl£
(
bh
);

4918 
jou∫Æ
 = 
	`jbd3_jou∫Æ_öô_dev
(
bdev
, 
sb
->
s_bdev
,

4919 
°¨t
, 
Àn
, 
blocksize
);

4920 i‡(!
jou∫Æ
) {

4921 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "failedÅo create device journal");

4922 
out_bdev
;

4924 
jou∫Æ
->
j_¥iv©e
 = 
sb
;

4925 
	`Œ_rw_block
(
REQ_OP_READ
, 
REQ_META
 | 
REQ_PRIO
, 1, &
jou∫Æ
->
j_sb_buf„r
);

4926 
	`waô_⁄_buf„r
(
jou∫Æ
->
j_sb_buf„r
);

4927 i‡(!
	`buf„r_u±od©e
(
jou∫Æ
->
j_sb_buf„r
)) {

4928 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "I/OÉrror on journal device");

4929 
out_jou∫Æ
;

4931 i‡(
	`be32_to_˝u
(
jou∫Æ
->
j_su≥rblock
->
s_ƒ_u£rs
) != 1) {

4932 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "External journal has moreÅhan one "

4934 
	`be32_to_˝u
(
jou∫Æ
->
j_su≥rblock
->
s_ƒ_u£rs
));

4935 
out_jou∫Æ
;

4937 
	`PXT4_SB
(
sb
)->
jou∫Æ_bdev
 = 
bdev
;

4938 
	`pxt4_öô_jou∫Æ_∑øms
(
sb
, 
jou∫Æ
);

4939  
jou∫Æ
;

4941 
out_jou∫Æ
:

4942 
	`jbd3_jou∫Æ_de°roy
(
jou∫Æ
);

4943 
out_bdev
:

4944 
	`pxt4_blkdev_put
(
bdev
);

4945  
NULL
;

4946 
	}
}

4948 
	$pxt4_lﬂd_jou∫Æ
(
su≥r_block
 *
sb
,

4949 
pxt4_su≥r_block
 *
es
,

4950 
jou∫Æ_devnum
)

4952 
jou∫Æ_t
 *
jou∫Æ
;

4953 
jou∫Æ_öum
 = 
	`À32_to_˝u
(
es
->
s_jou∫Æ_öum
);

4954 
dev_t
 
jou∫Æ_dev
;

4955 
îr
 = 0;

4956 
ªÆly_ªad_⁄ly
;

4957 
jou∫Æ_dev_ro
;

4959 i‡(
	`WARN_ON_ONCE
(!
	`pxt4_has_„©uª_jou∫Æ
(
sb
)))

4960  -
EFSCORRUPTED
;

4962 i‡(
jou∫Æ_devnum
 &&

4963 
jou∫Æ_devnum
 !
	`À32_to_˝u
(
es
->
s_jou∫Æ_dev
)) {

4964 
	`pxt4_msg
(
sb
, 
KERN_INFO
, "external journal device major/minor "

4966 
jou∫Æ_dev
 = 
	`√w_decode_dev
(
jou∫Æ_devnum
);

4968 
jou∫Æ_dev
 = 
	`√w_decode_dev
(
	`À32_to_˝u
(
es
->
s_jou∫Æ_dev
));

4970 i‡(
jou∫Æ_öum
 && 
jou∫Æ_dev
) {

4971 
	`pxt4_msg
(
sb
, 
KERN_ERR
,

4973  -
EINVAL
;

4976 i‡(
jou∫Æ_öum
) {

4977 
jou∫Æ
 = 
	`pxt4_gë_jou∫Æ
(
sb
, 
jou∫Æ_öum
);

4978 i‡(!
jou∫Æ
)

4979  -
EINVAL
;

4981 
jou∫Æ
 = 
	`pxt4_gë_dev_jou∫Æ
(
sb
, 
jou∫Æ_dev
);

4982 i‡(!
jou∫Æ
)

4983  -
EINVAL
;

4986 
jou∫Æ_dev_ro
 = 
	`bdev_ªad_⁄ly
(
jou∫Æ
->
j_dev
);

4987 
ªÆly_ªad_⁄ly
 = 
	`bdev_ªad_⁄ly
(
sb
->
s_bdev
Ë| 
jou∫Æ_dev_ro
;

4989 i‡(
jou∫Æ_dev_ro
 && !
	`sb_rd⁄ly
(
sb
)) {

4990 
	`pxt4_msg
(
sb
, 
KERN_ERR
,

4992 
îr
 = -
EROFS
;

4993 
îr_out
;

5001 i‡(
	`pxt4_has_„©uª_jou∫Æ_√eds_ªcovîy
(
sb
)) {

5002 i‡(
	`sb_rd⁄ly
(
sb
)) {

5003 
	`pxt4_msg
(
sb
, 
KERN_INFO
, "INFO:Ñecovery "

5005 i‡(
ªÆly_ªad_⁄ly
) {

5006 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "writeáccess "

5009 
îr
 = -
EROFS
;

5010 
îr_out
;

5012 
	`pxt4_msg
(
sb
, 
KERN_INFO
, "writeáccess will "

5017 i‡(!(
jou∫Æ
->
j_Êags
 & 
JBD3_BARRIER
))

5018 
	`pxt4_msg
(
sb
, 
KERN_INFO
, "barriers disabled");

5020 i‡(!
	`pxt4_has_„©uª_jou∫Æ_√eds_ªcovîy
(
sb
))

5021 
îr
 = 
	`jbd3_jou∫Æ_wùe
(
jou∫Æ
, !
ªÆly_ªad_⁄ly
);

5022 i‡(!
îr
) {

5023 *
ßve
 = 
	`kmÆloc
(
PXT4_S_ERR_LEN
, 
GFP_KERNEL
);

5024 i‡(
ßve
)

5025 
	`mem˝y
(
ßve
, ((*Ë
es
) +

5026 
PXT4_S_ERR_START
, 
PXT4_S_ERR_LEN
);

5027 
îr
 = 
	`jbd3_jou∫Æ_lﬂd
(
jou∫Æ
);

5028 i‡(
ßve
)

5029 
	`mem˝y
(((*Ë
es
Ë+ 
PXT4_S_ERR_START
,

5030 
ßve
, 
PXT4_S_ERR_LEN
);

5031 
	`k‰ì
(
ßve
);

5034 i‡(
îr
) {

5035 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "errorÜoading journal");

5036 
îr_out
;

5039 
	`PXT4_SB
(
sb
)->
s_jou∫Æ
 = 
jou∫Æ
;

5040 
îr
 = 
	`pxt4_˛ór_jou∫Æ_îr
(
sb
, 
es
);

5041 i‡(
îr
) {

5042 
	`PXT4_SB
(
sb
)->
s_jou∫Æ
 = 
NULL
;

5043 
	`jbd3_jou∫Æ_de°roy
(
jou∫Æ
);

5044  
îr
;

5047 i‡(!
ªÆly_ªad_⁄ly
 && 
jou∫Æ_devnum
 &&

5048 
jou∫Æ_devnum
 !
	`À32_to_˝u
(
es
->
s_jou∫Æ_dev
)) {

5049 
es
->
s_jou∫Æ_dev
 = 
	`˝u_to_À32
(
jou∫Æ_devnum
);

5052 
	`pxt4_commô_su≥r
(
sb
, 1);

5057 
îr_out
:

5058 
	`jbd3_jou∫Æ_de°roy
(
jou∫Æ
);

5059  
îr
;

5060 
	}
}

5062 
	$pxt4_commô_su≥r
(
su≥r_block
 *
sb
, 
sync
)

5064 
pxt4_su≥r_block
 *
es
 = 
	`PXT4_SB
(
sb
)->
s_es
;

5065 
buf„r_hód
 *
sbh
 = 
	`PXT4_SB
(
sb
)->
s_sbh
;

5066 
îr‹
 = 0;

5068 i‡(!
sbh
)

5069  -
EINVAL
;

5070 i‡(
	`block_devi˚_eje˘ed
(
sb
))

5071  -
ENODEV
;

5083 i‡(!(
sb
->
s_Êags
 & 
SB_RDONLY
))

5084 
	`pxt4_upd©e_t°amp
(
es
, 
s_wtime
);

5085 i‡(
sb
->
s_bdev
->
bd_∑π
)

5086 
es
->
s_kbyãs_wrôãn
 =

5087 
	`˝u_to_À64
(
	`PXT4_SB
(
sb
)->
s_kbyãs_wrôãn
 +

5088 ((
	`∑π_°©_ªad
(
sb
->
s_bdev
->
bd_∑π
,

5089 
£˘‹s
[
STAT_WRITE
]) -

5090 
	`PXT4_SB
(
sb
)->
s_£˘‹s_wrôãn_°¨t
) >> 1));

5092 
es
->
s_kbyãs_wrôãn
 =

5093 
	`˝u_to_À64
(
	`PXT4_SB
(
sb
)->
s_kbyãs_wrôãn
);

5094 i‡(
	`≥r˝u_cou¡î_öôülized
(&
	`PXT4_SB
(
sb
)->
s_‰ì˛u°îs_cou¡î
))

5095 
	`pxt4_‰ì_blocks_cou¡_£t
(
es
,

5096 
	`PXT4_C2B
(
	`PXT4_SB
(
sb
), 
	`≥r˝u_cou¡î_sum_posôive
(

5097 &
	`PXT4_SB
(
sb
)->
s_‰ì˛u°îs_cou¡î
)));

5098 i‡(
	`≥r˝u_cou¡î_öôülized
(&
	`PXT4_SB
(
sb
)->
s_‰ìöodes_cou¡î
))

5099 
es
->
s_‰ì_öodes_cou¡
 =

5100 
	`˝u_to_À32
(
	`≥r˝u_cou¡î_sum_posôive
(

5101 &
	`PXT4_SB
(
sb
)->
s_‰ìöodes_cou¡î
));

5102 
	`BUFFER_TRACE
(
sbh
, "marking dirty");

5103 
	`pxt4_su≥rblock_csum_£t
(
sb
);

5104 i‡(
sync
)

5105 
	`lock_buf„r
(
sbh
);

5106 i‡(
	`buf„r_wrôe_io_îr‹
(
sbh
Ë|| !
	`buf„r_u±od©e
(sbh)) {

5115 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "previous I/OÉrrorÅo "

5117 
	`˛ór_buf„r_wrôe_io_îr‹
(
sbh
);

5118 
	`£t_buf„r_u±od©e
(
sbh
);

5120 
	`m¨k_buf„r_dúty
(
sbh
);

5121 i‡(
sync
) {

5122 
	`u∆ock_buf„r
(
sbh
);

5123 
îr‹
 = 
	`__sync_dúty_buf„r
(
sbh
,

5124 
REQ_SYNC
 | (
	`ã°_›t
(
sb
, 
BARRIER
Ë? 
REQ_FUA
 : 0));

5125 i‡(
	`buf„r_wrôe_io_îr‹
(
sbh
)) {

5126 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "I/OÉrror while writing "

5128 
	`˛ór_buf„r_wrôe_io_îr‹
(
sbh
);

5129 
	`£t_buf„r_u±od©e
(
sbh
);

5132  
îr‹
;

5133 
	}
}

5140 
	$pxt4_m¨k_ªcovîy_com∂ëe
(
su≥r_block
 *
sb
,

5141 
pxt4_su≥r_block
 *
es
)

5143 
îr
;

5144 
jou∫Æ_t
 *
jou∫Æ
 = 
	`PXT4_SB
(
sb
)->
s_jou∫Æ
;

5146 i‡(!
	`pxt4_has_„©uª_jou∫Æ
(
sb
)) {

5147 i‡(
jou∫Æ
 !
NULL
) {

5148 
	`pxt4_îr‹
(
sb
, "Journal gotÑemoved whileÅhe fs was "

5150  -
EFSCORRUPTED
;

5154 
	`jbd3_jou∫Æ_lock_upd©es
(
jou∫Æ
);

5155 
îr
 = 
	`jbd3_jou∫Æ_Êush
(
jou∫Æ
);

5156 i‡(
îr
 < 0)

5157 
out
;

5159 i‡(
	`pxt4_has_„©uª_jou∫Æ_√eds_ªcovîy
(
sb
Ë&& 
	`sb_rd⁄ly
(sb)) {

5160 
	`pxt4_˛ór_„©uª_jou∫Æ_√eds_ªcovîy
(
sb
);

5161 
	`pxt4_commô_su≥r
(
sb
, 1);

5163 
out
:

5164 
	`jbd3_jou∫Æ_u∆ock_upd©es
(
jou∫Æ
);

5165  
îr
;

5166 
	}
}

5173 
	$pxt4_˛ór_jou∫Æ_îr
(
su≥r_block
 *
sb
,

5174 
pxt4_su≥r_block
 *
es
)

5176 
jou∫Æ_t
 *
jou∫Æ
;

5177 
j_î∫o
;

5178 c⁄° *
îr°r
;

5180 i‡(!
	`pxt4_has_„©uª_jou∫Æ
(
sb
)) {

5181 
	`pxt4_îr‹
(
sb
, "Journal gotÑemoved whileÅhe fs was mounted!");

5182  -
EFSCORRUPTED
;

5185 
jou∫Æ
 = 
	`PXT4_SB
(
sb
)->
s_jou∫Æ
;

5192 
j_î∫o
 = 
	`jbd3_jou∫Æ_î∫o
(
jou∫Æ
);

5193 i‡(
j_î∫o
) {

5194 
nbuf
[16];

5196 
îr°r
 = 
	`pxt4_decode_îr‹
(
sb
, 
j_î∫o
, 
nbuf
);

5197 
	`pxt4_w¨nög
(
sb
, "FilesystemÉrrorÑecorded "

5198 "‰omÖªviou†mou¡: %s", 
îr°r
);

5199 
	`pxt4_w¨nög
(
sb
, "Marking fs inÇeed of filesystem check.");

5201 
	`PXT4_SB
(
sb
)->
s_mou¡_°©e
 |
PXT4_ERROR_FS
;

5202 
es
->
s_°©e
 |
	`˝u_to_À16
(
PXT4_ERROR_FS
);

5203 
	`pxt4_commô_su≥r
(
sb
, 1);

5205 
	`jbd3_jou∫Æ_˛ór_îr
(
jou∫Æ
);

5206 
	`jbd3_jou∫Æ_upd©e_sb_î∫o
(
jou∫Æ
);

5209 
	}
}

5215 
	$pxt4_f‹˚_commô
(
su≥r_block
 *
sb
)

5217 
jou∫Æ_t
 *
jou∫Æ
;

5219 i‡(
	`sb_rd⁄ly
(
sb
))

5222 
jou∫Æ
 = 
	`PXT4_SB
(
sb
)->
s_jou∫Æ
;

5223  
	`pxt4_jou∫Æ_f‹˚_commô
(
jou∫Æ
);

5224 
	}
}

5226 
	$pxt4_sync_fs
(
su≥r_block
 *
sb
, 
waô
)

5228 
ªt
 = 0;

5229 
tid_t
 
èrgë
;

5230 
boﬁ
 
√eds_b¨rõr
 = 
Ál£
;

5231 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
sb
);

5233 i‡(
	`u∆ikñy
(
	`pxt4_f‹˚d_shutdown
(
sbi
)))

5236 
	`åa˚_pxt4_sync_fs
(
sb
, 
waô
);

5237 
	`Êush_w‹kqueue
(
sbi
->
rsv_c⁄vîsi⁄_wq
);

5242 
	`dquŸ_wrôeback_dquŸs
(
sb
, -1);

5248 i‡(
sbi
->
s_jou∫Æ
) {

5249 
èrgë
 = 
	`jbd3_gë_œã°_å™ß˘i⁄
(
sbi
->
s_jou∫Æ
);

5250 i‡(
waô
 && 
sbi
->
s_jou∫Æ
->
j_Êags
 & 
JBD3_BARRIER
 &&

5251 !
	`jbd3_å™s_wûl_£nd_d©a_b¨rõr
(
sbi
->
s_jou∫Æ
, 
èrgë
))

5252 
√eds_b¨rõr
 = 
åue
;

5254 i‡(
	`jbd3_jou∫Æ_°¨t_commô
(
sbi
->
s_jou∫Æ
, &
èrgë
)) {

5255 i‡(
waô
)

5256 
ªt
 = 
	`jbd3_log_waô_commô
(
sbi
->
s_jou∫Æ
,

5257 
èrgë
);

5259 } i‡(
waô
 && 
	`ã°_›t
(
sb
, 
BARRIER
))

5260 
√eds_b¨rõr
 = 
åue
;

5261 i‡(
√eds_b¨rõr
) {

5262 
îr
;

5263 
îr
 = 
	`blkdev_issue_Êush
(
sb
->
s_bdev
, 
GFP_KERNEL
, 
NULL
);

5264 i‡(!
ªt
)

5265 
ªt
 = 
îr
;

5268  
ªt
;

5269 
	}
}

5279 
	$pxt4_‰ìze
(
su≥r_block
 *
sb
)

5281 
îr‹
 = 0;

5282 
jou∫Æ_t
 *
jou∫Æ
;

5284 i‡(
	`sb_rd⁄ly
(
sb
))

5287 
jou∫Æ
 = 
	`PXT4_SB
(
sb
)->
s_jou∫Æ
;

5289 i‡(
jou∫Æ
) {

5291 
	`jbd3_jou∫Æ_lock_upd©es
(
jou∫Æ
);

5297 
îr‹
 = 
	`jbd3_jou∫Æ_Êush
(
jou∫Æ
);

5298 i‡(
îr‹
 < 0)

5299 
out
;

5302 
	`pxt4_˛ór_„©uª_jou∫Æ_√eds_ªcovîy
(
sb
);

5305 
îr‹
 = 
	`pxt4_commô_su≥r
(
sb
, 1);

5306 
out
:

5307 i‡(
jou∫Æ
)

5309 
	`jbd3_jou∫Æ_u∆ock_upd©es
(
jou∫Æ
);

5310  
îr‹
;

5311 
	}
}

5317 
	$pxt4_un‰ìze
(
su≥r_block
 *
sb
)

5319 i‡(
	`sb_rd⁄ly
(
sb
Ë|| 
	`pxt4_f‹˚d_shutdown
(
	`PXT4_SB
(sb)))

5322 i‡(
	`PXT4_SB
(
sb
)->
s_jou∫Æ
) {

5324 
	`pxt4_£t_„©uª_jou∫Æ_√eds_ªcovîy
(
sb
);

5327 
	`pxt4_commô_su≥r
(
sb
, 1);

5329 
	}
}

5334 
	spxt4_mou¡_›ti⁄s
 {

5335 
	ms_mou¡_›t
;

5336 
	ms_mou¡_›t2
;

5337 
kuid_t
 
	ms_ªsuid
;

5338 
kgid_t
 
	ms_ªsgid
;

5339 
	ms_commô_öãrvÆ
;

5340 
u32
 
	ms_mö_b©ch_time
, 
	ms_max_b©ch_time
;

5341 #ifde‡
CONFIG_QUOTA


5342 
	ms_jquŸa_fmt
;

5343 *
	ms_qf_«mes
[
PXT4_MAXQUOTAS
];

5347 
	$pxt4_ªmou¡
(
su≥r_block
 *
sb
, *
Êags
, *
d©a
)

5349 
pxt4_su≥r_block
 *
es
;

5350 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
sb
);

5351 
ﬁd_sb_Êags
, 
vfs_Êags
;

5352 
pxt4_mou¡_›ti⁄s
 
ﬁd_›ts
;

5353 
íabÀ_quŸa
 = 0;

5354 
pxt4_group_t
 
g
;

5355 
jou∫Æ_i›rio
 = 
DEFAULT_JOURNAL_IOPRIO
;

5356 
îr
 = 0;

5357 #ifde‡
CONFIG_QUOTA


5358 
i
, 
j
;

5359 *
to_‰ì
[
PXT4_MAXQUOTAS
];

5361 *
‹ig_d©a
 = 
	`k°rdup
(
d©a
, 
GFP_KERNEL
);

5363 i‡(
d©a
 && !
‹ig_d©a
)

5364  -
ENOMEM
;

5367 
ﬁd_sb_Êags
 = 
sb
->
s_Êags
;

5368 
ﬁd_›ts
.
s_mou¡_›t
 = 
sbi
->s_mount_opt;

5369 
ﬁd_›ts
.
s_mou¡_›t2
 = 
sbi
->s_mount_opt2;

5370 
ﬁd_›ts
.
s_ªsuid
 = 
sbi
->s_resuid;

5371 
ﬁd_›ts
.
s_ªsgid
 = 
sbi
->s_resgid;

5372 
ﬁd_›ts
.
s_commô_öãrvÆ
 = 
sbi
->s_commit_interval;

5373 
ﬁd_›ts
.
s_mö_b©ch_time
 = 
sbi
->s_min_batch_time;

5374 
ﬁd_›ts
.
s_max_b©ch_time
 = 
sbi
->s_max_batch_time;

5375 #ifde‡
CONFIG_QUOTA


5376 
ﬁd_›ts
.
s_jquŸa_fmt
 = 
sbi
->s_jquota_fmt;

5377 
i
 = 0; i < 
PXT4_MAXQUOTAS
; i++)

5378 i‡(
sbi
->
s_qf_«mes
[
i
]) {

5379 *
qf_«me
 = 
	`gë_qf_«me
(
sb
, 
sbi
, 
i
);

5381 
ﬁd_›ts
.
s_qf_«mes
[
i
] = 
	`k°rdup
(
qf_«me
, 
GFP_KERNEL
);

5382 i‡(!
ﬁd_›ts
.
s_qf_«mes
[
i
]) {

5383 
j
 = 0; j < 
i
; j++)

5384 
	`k‰ì
(
ﬁd_›ts
.
s_qf_«mes
[
j
]);

5385 
	`k‰ì
(
‹ig_d©a
);

5386  -
ENOMEM
;

5389 
ﬁd_›ts
.
s_qf_«mes
[
i
] = 
NULL
;

5391 i‡(
sbi
->
s_jou∫Æ
 && sbi->s_jou∫Æ->
j_èsk
->
io_c⁄ãxt
)

5392 
jou∫Æ_i›rio
 = 
sbi
->
s_jou∫Æ
->
j_èsk
->
io_c⁄ãxt
->
i›rio
;

5399 
vfs_Êags
 = 
SB_LAZYTIME
 | 
SB_I_VERSION
;

5400 
sb
->
s_Êags
 = (sb->s_Êag†& ~
vfs_Êags
Ë| (*
Êags
 & vfs_flags);

5402 i‡(!
	`∑r£_›ti⁄s
(
d©a
, 
sb
, 
NULL
, &
jou∫Æ_i›rio
, 1)) {

5403 
îr
 = -
EINVAL
;

5404 
ª°‹e_›ts
;

5407 i‡((
ﬁd_›ts
.
s_mou¡_›t
 & 
PXT4_MOUNT_JOURNAL_CHECKSUM
) ^

5408 
	`ã°_›t
(
sb
, 
JOURNAL_CHECKSUM
)) {

5409 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "changing journal_checksum "

5411 
sbi
->
s_mou¡_›t
 ^
PXT4_MOUNT_JOURNAL_CHECKSUM
;

5414 i‡(
	`ã°_›t
(
sb
, 
DATA_FLAGS
Ë=
PXT4_MOUNT_JOURNAL_DATA
) {

5415 i‡(
	`ã°_›t2
(
sb
, 
EXPLICIT_DELALLOC
)) {

5416 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "can't mount with "

5418 
îr
 = -
EINVAL
;

5419 
ª°‹e_›ts
;

5421 i‡(
	`ã°_›t
(
sb
, 
DIOREAD_NOLOCK
)) {

5422 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "can't mount with "

5424 
îr
 = -
EINVAL
;

5425 
ª°‹e_›ts
;

5427 } i‡(
	`ã°_›t
(
sb
, 
DATA_FLAGS
Ë=
PXT4_MOUNT_ORDERED_DATA
) {

5428 i‡(
	`ã°_›t
(
sb
, 
JOURNAL_ASYNC_COMMIT
)) {

5429 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "can't mount with "

5431 
îr
 = -
EINVAL
;

5432 
ª°‹e_›ts
;

5436 i‡((
sbi
->
s_mou¡_›t
 ^ 
ﬁd_›ts
.s_mou¡_›tË& 
PXT4_MOUNT_NO_MBCACHE
) {

5437 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "can'tÉnableÇombcache duringÑemount");

5438 
îr
 = -
EINVAL
;

5439 
ª°‹e_›ts
;

5442 i‡(
sbi
->
s_mou¡_Êags
 & 
PXT4_MF_FS_ABORTED
)

5443 
	`pxt4_ab‹t
(
sb
, "Abort forced by user");

5445 
sb
->
s_Êags
 = (sb->s_Êag†& ~
SB_POSIXACL
) |

5446 (
	`ã°_›t
(
sb
, 
POSIX_ACL
Ë? 
SB_POSIXACL
 : 0);

5448 
es
 = 
sbi
->
s_es
;

5450 i‡(
sbi
->
s_jou∫Æ
) {

5451 
	`pxt4_öô_jou∫Æ_∑øms
(
sb
, 
sbi
->
s_jou∫Æ
);

5452 
	`£t_èsk_i›rio
(
sbi
->
s_jou∫Æ
->
j_èsk
, 
jou∫Æ_i›rio
);

5455 i‡((
boﬁ
)(*
Êags
 & 
SB_RDONLY
Ë!
	`sb_rd⁄ly
(
sb
)) {

5456 i‡(
sbi
->
s_mou¡_Êags
 & 
PXT4_MF_FS_ABORTED
) {

5457 
îr
 = -
EROFS
;

5458 
ª°‹e_›ts
;

5461 i‡(*
Êags
 & 
SB_RDONLY
) {

5462 
îr
 = 
	`sync_fûesy°em
(
sb
);

5463 i‡(
îr
 < 0)

5464 
ª°‹e_›ts
;

5465 
îr
 = 
	`dquŸ_su•íd
(
sb
, -1);

5466 i‡(
îr
 < 0)

5467 
ª°‹e_›ts
;

5473 
sb
->
s_Êags
 |
SB_RDONLY
;

5480 i‡(!(
es
->
s_°©e
 & 
	`˝u_to_À16
(
PXT4_VALID_FS
)) &&

5481 (
sbi
->
s_mou¡_°©e
 & 
PXT4_VALID_FS
))

5482 
es
->
s_°©e
 = 
	`˝u_to_À16
(
sbi
->
s_mou¡_°©e
);

5484 i‡(
sbi
->
s_jou∫Æ
) {

5489 
	`pxt4_m¨k_ªcovîy_com∂ëe
(
sb
, 
es
);

5491 i‡(
sbi
->
s_mmp_tsk
)

5492 
	`kthªad_°›
(
sbi
->
s_mmp_tsk
);

5495 i‡(
	`pxt4_has_„©uª_ªad⁄ly
(
sb
) ||

5496 !
	`pxt4_„©uª_£t_ok
(
sb
, 0)) {

5497 
îr
 = -
EROFS
;

5498 
ª°‹e_›ts
;

5504 
g
 = 0; g < 
sbi
->
s_groups_cou¡
; g++) {

5505 
pxt4_group_desc
 *
gdp
 =

5506 
	`pxt4_gë_group_desc
(
sb
, 
g
, 
NULL
);

5508 i‡(!
	`pxt4_group_desc_csum_vîify
(
sb
, 
g
, 
gdp
)) {

5509 
	`pxt4_msg
(
sb
, 
KERN_ERR
,

5511 
g
, 
	`À16_to_˝u
(
	`pxt4_group_desc_csum
(
sb
, g, 
gdp
)),

5512 
	`À16_to_˝u
(
gdp
->
bg_checksum
));

5513 
îr
 = -
EFSBADCRC
;

5514 
ª°‹e_›ts
;

5523 i‡(
es
->
s_œ°_‹ph™
) {

5524 
	`pxt4_msg
(
sb
, 
KERN_WARNING
, "Couldn't "

5528 
îr
 = -
EINVAL
;

5529 
ª°‹e_›ts
;

5538 i‡(
sbi
->
s_jou∫Æ
) {

5539 
îr
 = 
	`pxt4_˛ór_jou∫Æ_îr
(
sb
, 
es
);

5540 i‡(
îr
)

5541 
ª°‹e_›ts
;

5543 
sbi
->
s_mou¡_°©e
 = 
	`À16_to_˝u
(
es
->
s_°©e
);

5545 
îr
 = 
	`pxt4_£tup_su≥r
(
sb
, 
es
, 0);

5546 i‡(
îr
)

5547 
ª°‹e_›ts
;

5549 
sb
->
s_Êags
 &~
SB_RDONLY
;

5550 i‡(
	`pxt4_has_„©uª_mmp
(
sb
))

5551 i‡(
	`pxt4_mu…i_mou¡_¥Ÿe˘
(
sb
,

5552 
	`À64_to_˝u
(
es
->
s_mmp_block
))) {

5553 
îr
 = -
EROFS
;

5554 
ª°‹e_›ts
;

5556 
íabÀ_quŸa
 = 1;

5564 i‡(
	`sb_rd⁄ly
(
sb
Ë|| !
	`ã°_›t
(sb, 
INIT_INODE_TABLE
))

5565 
	`pxt4_uƒegi°î_li_ªque°
(
sb
);

5567 
pxt4_group_t
 
fú°_nŸ_zî€d
;

5568 
fú°_nŸ_zî€d
 = 
	`pxt4_has_unöô_ôabÀ
(
sb
);

5569 
	`pxt4_ªgi°î_li_ªque°
(
sb
, 
fú°_nŸ_zî€d
);

5577 i‡(
	`ã°_›t
(
sb
, 
BLOCK_VALIDITY
Ë&& !
sbi
->
sy°em_blks
) {

5578 
îr
 = 
	`pxt4_£tup_sy°em_z⁄e
(
sb
);

5579 i‡(
îr
)

5580 
ª°‹e_›ts
;

5583 i‡(
sbi
->
s_jou∫Æ
 =
NULL
 && !(
ﬁd_sb_Êags
 & 
SB_RDONLY
)) {

5584 
îr
 = 
	`pxt4_commô_su≥r
(
sb
, 1);

5585 i‡(
îr
)

5586 
ª°‹e_›ts
;

5589 #ifde‡
CONFIG_QUOTA


5591 
i
 = 0; i < 
PXT4_MAXQUOTAS
; i++)

5592 
	`k‰ì
(
ﬁd_›ts
.
s_qf_«mes
[
i
]);

5593 i‡(
íabÀ_quŸa
) {

5594 i‡(
	`sb_™y_quŸa_su•íded
(
sb
))

5595 
	`dquŸ_ªsume
(
sb
, -1);

5596 i‡(
	`pxt4_has_„©uª_quŸa
(
sb
)) {

5597 
îr
 = 
	`pxt4_íabÀ_quŸas
(
sb
);

5598 i‡(
îr
)

5599 
ª°‹e_›ts
;

5603 i‡(!
	`ã°_›t
(
sb
, 
BLOCK_VALIDITY
Ë&& 
sbi
->
sy°em_blks
)

5604 
	`pxt4_ªÀa£_sy°em_z⁄e
(
sb
);

5611 *
Êags
 = (*Êag†& ~
vfs_Êags
Ë| (
sb
->
s_Êags
 & vfs_flags);

5613 
	`pxt4_msg
(
sb
, 
KERN_INFO
, "ª-mou¡ed. O±s: %s", 
‹ig_d©a
);

5614 
	`k‰ì
(
‹ig_d©a
);

5617 
ª°‹e_›ts
:

5618 
sb
->
s_Êags
 = 
ﬁd_sb_Êags
;

5619 
sbi
->
s_mou¡_›t
 = 
ﬁd_›ts
.s_mount_opt;

5620 
sbi
->
s_mou¡_›t2
 = 
ﬁd_›ts
.s_mount_opt2;

5621 
sbi
->
s_ªsuid
 = 
ﬁd_›ts
.s_resuid;

5622 
sbi
->
s_ªsgid
 = 
ﬁd_›ts
.s_resgid;

5623 
sbi
->
s_commô_öãrvÆ
 = 
ﬁd_›ts
.s_commit_interval;

5624 
sbi
->
s_mö_b©ch_time
 = 
ﬁd_›ts
.s_min_batch_time;

5625 
sbi
->
s_max_b©ch_time
 = 
ﬁd_›ts
.s_max_batch_time;

5626 i‡(!
	`ã°_›t
(
sb
, 
BLOCK_VALIDITY
Ë&& 
sbi
->
sy°em_blks
)

5627 
	`pxt4_ªÀa£_sy°em_z⁄e
(
sb
);

5628 #ifde‡
CONFIG_QUOTA


5629 
sbi
->
s_jquŸa_fmt
 = 
ﬁd_›ts
.s_jquota_fmt;

5630 
i
 = 0; i < 
PXT4_MAXQUOTAS
; i++) {

5631 
to_‰ì
[
i
] = 
	`gë_qf_«me
(
sb
, 
sbi
, i);

5632 
	`rcu_assign_poöãr
(
sbi
->
s_qf_«mes
[
i
], 
ﬁd_›ts
.s_qf_names[i]);

5634 
	`synchr⁄ize_rcu
();

5635 
i
 = 0; i < 
PXT4_MAXQUOTAS
; i++)

5636 
	`k‰ì
(
to_‰ì
[
i
]);

5638 
	`k‰ì
(
‹ig_d©a
);

5639  
îr
;

5640 
	}
}

5642 #ifde‡
CONFIG_QUOTA


5643 
	$pxt4_°©fs_¥oje˘
(
su≥r_block
 *
sb
,

5644 
k¥ojid_t
 
¥ojid
, 
k°©fs
 *
buf
)

5646 
kqid
 
qid
;

5647 
dquŸ
 *dquot;

5648 
u64
 
limô
;

5649 
u64
 
curblock
;

5651 
qid
 = 
	`make_kqid_¥ojid
(
¥ojid
);

5652 
dquŸ
 = 
	`dqgë
(
sb
, 
qid
);

5653 i‡(
	`IS_ERR
(
dquŸ
))

5654  
	`PTR_ERR
(
dquŸ
);

5655 
	`•ö_lock
(&
dquŸ
->
dq_dqb_lock
);

5657 
limô
 = 0;

5658 i‡(
dquŸ
->
dq_dqb
.
dqb_bso·limô
 &&

5659 (!
limô
 || 
dquŸ
->
dq_dqb
.
dqb_bso·limô
 <Üimit))

5660 
limô
 = 
dquŸ
->
dq_dqb
.
dqb_bso·limô
;

5661 i‡(
dquŸ
->
dq_dqb
.
dqb_bh¨dlimô
 &&

5662 (!
limô
 || 
dquŸ
->
dq_dqb
.
dqb_bh¨dlimô
 <Üimit))

5663 
limô
 = 
dquŸ
->
dq_dqb
.
dqb_bh¨dlimô
;

5664 
limô
 >>
sb
->
s_blocksize_bôs
;

5666 i‡(
limô
 && 
buf
->
f_blocks
 >Üimit) {

5667 
curblock
 = (
dquŸ
->
dq_dqb
.
dqb_cur•a˚
 +

5668 
dquŸ
->
dq_dqb
.
dqb_rsv•a˚
Ë>> 
sb
->
s_blocksize_bôs
;

5669 
buf
->
f_blocks
 = 
limô
;

5670 
buf
->
f_b‰ì
 = buf->
f_bavaû
 =

5671 (
buf
->
f_blocks
 > 
curblock
) ?

5672 (
buf
->
f_blocks
 - 
curblock
) : 0;

5675 
limô
 = 0;

5676 i‡(
dquŸ
->
dq_dqb
.
dqb_iso·limô
 &&

5677 (!
limô
 || 
dquŸ
->
dq_dqb
.
dqb_iso·limô
 <Üimit))

5678 
limô
 = 
dquŸ
->
dq_dqb
.
dqb_iso·limô
;

5679 i‡(
dquŸ
->
dq_dqb
.
dqb_ih¨dlimô
 &&

5680 (!
limô
 || 
dquŸ
->
dq_dqb
.
dqb_ih¨dlimô
 <Üimit))

5681 
limô
 = 
dquŸ
->
dq_dqb
.
dqb_ih¨dlimô
;

5683 i‡(
limô
 && 
buf
->
f_fûes
 >Üimit) {

5684 
buf
->
f_fûes
 = 
limô
;

5685 
buf
->
f_f‰ì
 =

5686 (
buf
->
f_fûes
 > 
dquŸ
->
dq_dqb
.
dqb_curöodes
) ?

5687 (
buf
->
f_fûes
 - 
dquŸ
->
dq_dqb
.
dqb_curöodes
) : 0;

5690 
	`•ö_u∆ock
(&
dquŸ
->
dq_dqb_lock
);

5691 
	`dqput
(
dquŸ
);

5693 
	}
}

5696 
	$pxt4_°©fs
(
díåy
 *díåy, 
k°©fs
 *
buf
)

5698 
su≥r_block
 *
sb
 = 
díåy
->
d_sb
;

5699 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
sb
);

5700 
pxt4_su≥r_block
 *
es
 = 
sbi
->
s_es
;

5701 
pxt4_fsblk_t
 
ovîhód
 = 0, 
ªsv_blocks
;

5702 
u64
 
fsid
;

5703 
s64
 
b‰ì
;

5704 
ªsv_blocks
 = 
	`PXT4_C2B
(
sbi
, 
	`©omic64_ªad
(&sbi->
s_ªsv_˛u°îs
));

5706 i‡(!
	`ã°_›t
(
sb
, 
MINIX_DF
))

5707 
ovîhód
 = 
sbi
->
s_ovîhód
;

5709 
buf
->
f_ty≥
 = 
PXT4_SUPER_MAGIC
;

5710 
buf
->
f_bsize
 = 
sb
->
s_blocksize
;

5711 
buf
->
f_blocks
 = 
	`pxt4_blocks_cou¡
(
es
Ë- 
	`PXT4_C2B
(
sbi
, 
ovîhód
);

5712 
b‰ì
 = 
	`≥r˝u_cou¡î_sum_posôive
(&
sbi
->
s_‰ì˛u°îs_cou¡î
) -

5713 
	`≥r˝u_cou¡î_sum_posôive
(&
sbi
->
s_dúty˛u°îs_cou¡î
);

5715 
buf
->
f_b‰ì
 = 
	`PXT4_C2B
(
sbi
, 
	`max_t
(
s64
, 
b‰ì
, 0));

5716 
buf
->
f_bavaû
 = buf->
f_b‰ì
 -

5717 (
	`pxt4_r_blocks_cou¡
(
es
Ë+ 
ªsv_blocks
);

5718 i‡(
buf
->
f_b‰ì
 < (
	`pxt4_r_blocks_cou¡
(
es
Ë+ 
ªsv_blocks
))

5719 
buf
->
f_bavaû
 = 0;

5720 
buf
->
f_fûes
 = 
	`À32_to_˝u
(
es
->
s_öodes_cou¡
);

5721 
buf
->
f_f‰ì
 = 
	`≥r˝u_cou¡î_sum_posôive
(&
sbi
->
s_‰ìöodes_cou¡î
);

5722 
buf
->
f_«mñí
 = 
PXT4_NAME_LEN
;

5723 
fsid
 = 
	`À64_to_˝up
((*)
es
->
s_uuid
) ^

5724 
	`À64_to_˝up
((*)
es
->
s_uuid
 + (
u64
));

5725 
buf
->
f_fsid
.
vÆ
[0] = 
fsid
 & 0xFFFFFFFFUL;

5726 
buf
->
f_fsid
.
vÆ
[1] = (
fsid
 >> 32) & 0xFFFFFFFFUL;

5728 #ifde‡
CONFIG_QUOTA


5729 i‡(
	`pxt4_ã°_öode_Êag
(
díåy
->
d_öode
, 
PXT4_INODE_PROJINHERIT
) &&

5730 
	`sb_has_quŸa_limôs_íabÀd
(
sb
, 
PRJQUOTA
))

5731 
	`pxt4_°©fs_¥oje˘
(
sb
, 
	`PXT4_I
(
díåy
->
d_öode
)->
i_¥ojid
, 
buf
);

5734 
	}
}

5737 #ifde‡
CONFIG_QUOTA


5743 
ölöe
 
öode
 *
	$dquŸ_to_öode
(
dquŸ
 *dquot)

5745  
	`sb_dq›t
(
dquŸ
->
dq_sb
)->
fûes
[dquŸ->
dq_id
.
ty≥
];

5746 
	}
}

5748 
	$pxt4_wrôe_dquŸ
(
dquŸ
 *dquot)

5750 
ªt
, 
îr
;

5751 
h™dÀ_t
 *
h™dÀ
;

5752 
öode
 *inode;

5754 
öode
 = 
	`dquŸ_to_öode
(
dquŸ
);

5755 
h™dÀ
 = 
	`pxt4_jou∫Æ_°¨t
(
öode
, 
PXT4_HT_QUOTA
,

5756 
	`PXT4_QUOTA_TRANS_BLOCKS
(
dquŸ
->
dq_sb
));

5757 i‡(
	`IS_ERR
(
h™dÀ
))

5758  
	`PTR_ERR
(
h™dÀ
);

5759 
ªt
 = 
	`dquŸ_commô
(
dquŸ
);

5760 
îr
 = 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

5761 i‡(!
ªt
)

5762 
ªt
 = 
îr
;

5763  
ªt
;

5764 
	}
}

5766 
	$pxt4_acquúe_dquŸ
(
dquŸ
 *dquot)

5768 
ªt
, 
îr
;

5769 
h™dÀ_t
 *
h™dÀ
;

5771 
h™dÀ
 = 
	`pxt4_jou∫Æ_°¨t
(
	`dquŸ_to_öode
(
dquŸ
), 
PXT4_HT_QUOTA
,

5772 
	`PXT4_QUOTA_INIT_BLOCKS
(
dquŸ
->
dq_sb
));

5773 i‡(
	`IS_ERR
(
h™dÀ
))

5774  
	`PTR_ERR
(
h™dÀ
);

5775 
ªt
 = 
	`dquŸ_acquúe
(
dquŸ
);

5776 
îr
 = 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

5777 i‡(!
ªt
)

5778 
ªt
 = 
îr
;

5779  
ªt
;

5780 
	}
}

5782 
	$pxt4_ªÀa£_dquŸ
(
dquŸ
 *dquot)

5784 
ªt
, 
îr
;

5785 
h™dÀ_t
 *
h™dÀ
;

5787 
h™dÀ
 = 
	`pxt4_jou∫Æ_°¨t
(
	`dquŸ_to_öode
(
dquŸ
), 
PXT4_HT_QUOTA
,

5788 
	`PXT4_QUOTA_DEL_BLOCKS
(
dquŸ
->
dq_sb
));

5789 i‡(
	`IS_ERR
(
h™dÀ
)) {

5791 
	`dquŸ_ªÀa£
(
dquŸ
);

5792  
	`PTR_ERR
(
h™dÀ
);

5794 
ªt
 = 
	`dquŸ_ªÀa£
(
dquŸ
);

5795 
îr
 = 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

5796 i‡(!
ªt
)

5797 
ªt
 = 
îr
;

5798  
ªt
;

5799 
	}
}

5801 
	$pxt4_m¨k_dquŸ_dúty
(
dquŸ
 *dquot)

5803 
su≥r_block
 *
sb
 = 
dquŸ
->
dq_sb
;

5804 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
sb
);

5807 i‡(
	`pxt4_has_„©uª_quŸa
(
sb
) ||

5808 
sbi
->
s_qf_«mes
[
USRQUOTA
] || sbi->s_qf_«mes[
GRPQUOTA
]) {

5809 
	`dquŸ_m¨k_dquŸ_dúty
(
dquŸ
);

5810  
	`pxt4_wrôe_dquŸ
(
dquŸ
);

5812  
	`dquŸ_m¨k_dquŸ_dúty
(
dquŸ
);

5814 
	}
}

5816 
	$pxt4_wrôe_öfo
(
su≥r_block
 *
sb
, 
ty≥
)

5818 
ªt
, 
îr
;

5819 
h™dÀ_t
 *
h™dÀ
;

5822 
h™dÀ
 = 
	`pxt4_jou∫Æ_°¨t
(
	`d_öode
(
sb
->
s_roŸ
), 
PXT4_HT_QUOTA
, 2);

5823 i‡(
	`IS_ERR
(
h™dÀ
))

5824  
	`PTR_ERR
(
h™dÀ
);

5825 
ªt
 = 
	`dquŸ_commô_öfo
(
sb
, 
ty≥
);

5826 
îr
 = 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

5827 i‡(!
ªt
)

5828 
ªt
 = 
îr
;

5829  
ªt
;

5830 
	}
}

5836 
	$pxt4_quŸa_⁄_mou¡
(
su≥r_block
 *
sb
, 
ty≥
)

5838  
	`dquŸ_quŸa_⁄_mou¡
(
sb
, 
	`gë_qf_«me
(sb, 
	`PXT4_SB
(sb), 
ty≥
),

5839 
	`PXT4_SB
(
sb
)->
s_jquŸa_fmt
, 
ty≥
);

5840 
	}
}

5842 
	$lockdï_£t_quŸa_öode
(
öode
 *öode, 
sub˛ass
)

5844 
pxt4_öode_öfo
 *
ei
 = 
	`PXT4_I
(
öode
);

5852 (Ë
ei
;

5853 
	`lockdï_£t_sub˛ass
(&
ei
->
i_d©a_£m
, 
sub˛ass
);

5854 
	}
}

5859 
	$pxt4_quŸa_⁄
(
su≥r_block
 *
sb
, 
ty≥
, 
f‹m©_id
,

5860 c⁄° 
∑th
 *path)

5862 
îr
;

5864 i‡(!
	`ã°_›t
(
sb
, 
QUOTA
))

5865  -
EINVAL
;

5868 i‡(
∑th
->
díåy
->
d_sb
 !
sb
)

5869  -
EXDEV
;

5872 i‡(
	`IS_NOQUOTA
(
	`d_öode
(
∑th
->
díåy
)))

5873  -
EBUSY
;

5876 i‡(
	`PXT4_SB
(
sb
)->
s_qf_«mes
[
ty≥
]) {

5878 i‡(
∑th
->
díåy
->
d_∑ª¡
 !
sb
->
s_roŸ
)

5879 
	`pxt4_msg
(
sb
, 
KERN_WARNING
,

5882 
	`sb_dq›t
(
sb
)->
Êags
 |
DQUOT_NOLIST_DIRTY
;

5888 
	`sb_dq›t
(
sb
)->
Êags
 &~
DQUOT_NOLIST_DIRTY
;

5895 i‡(
	`PXT4_SB
(
sb
)->
s_jou∫Æ
 &&

5896 
	`pxt4_should_jou∫Æ_d©a
(
	`d_öode
(
∑th
->
díåy
))) {

5901 
	`jbd3_jou∫Æ_lock_upd©es
(
	`PXT4_SB
(
sb
)->
s_jou∫Æ
);

5902 
îr
 = 
	`jbd3_jou∫Æ_Êush
(
	`PXT4_SB
(
sb
)->
s_jou∫Æ
);

5903 
	`jbd3_jou∫Æ_u∆ock_upd©es
(
	`PXT4_SB
(
sb
)->
s_jou∫Æ
);

5904 i‡(
îr
)

5905  
îr
;

5908 
	`lockdï_£t_quŸa_öode
(
∑th
->
díåy
->
d_öode
, 
I_DATA_SEM_QUOTA
);

5909 
îr
 = 
	`dquŸ_quŸa_⁄
(
sb
, 
ty≥
, 
f‹m©_id
, 
∑th
);

5910 i‡(
îr
) {

5911 
	`lockdï_£t_quŸa_öode
(
∑th
->
díåy
->
d_öode
,

5912 
I_DATA_SEM_NORMAL
);

5914 
öode
 *öodê
	`d_öode
(
∑th
->
díåy
);

5915 
h™dÀ_t
 *
h™dÀ
;

5922 
	`öode_lock
(
öode
);

5923 
h™dÀ
 = 
	`pxt4_jou∫Æ_°¨t
(
öode
, 
PXT4_HT_QUOTA
, 1);

5924 i‡(
	`IS_ERR
(
h™dÀ
))

5925 
u∆ock_öode
;

5926 
	`PXT4_I
(
öode
)->
i_Êags
 |
PXT4_NOATIME_FL
 | 
PXT4_IMMUTABLE_FL
;

5927 
	`öode_£t_Êags
(
öode
, 
S_NOATIME
 | 
S_IMMUTABLE
,

5928 
S_NOATIME
 | 
S_IMMUTABLE
);

5929 
	`pxt4_m¨k_öode_dúty
(
h™dÀ
, 
öode
);

5930 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

5931 
u∆ock_öode
:

5932 
	`öode_u∆ock
(
öode
);

5934  
îr
;

5935 
	}
}

5937 
	$pxt4_quŸa_íabÀ
(
su≥r_block
 *
sb
, 
ty≥
, 
f‹m©_id
,

5938 
Êags
)

5940 
îr
;

5941 
öode
 *
qf_öode
;

5942 
qf_öums
[
PXT4_MAXQUOTAS
] = {

5943 
	`À32_to_˝u
(
	`PXT4_SB
(
sb
)->
s_es
->
s_u§_quŸa_öum
),

5944 
	`À32_to_˝u
(
	`PXT4_SB
(
sb
)->
s_es
->
s_gΩ_quŸa_öum
),

5945 
	`À32_to_˝u
(
	`PXT4_SB
(
sb
)->
s_es
->
s_¥j_quŸa_öum
)

5948 
	`BUG_ON
(!
	`pxt4_has_„©uª_quŸa
(
sb
));

5950 i‡(!
qf_öums
[
ty≥
])

5951  -
EPERM
;

5953 
qf_öode
 = 
	`pxt4_igë
(
sb
, 
qf_öums
[
ty≥
], 
PXT4_IGET_SPECIAL
);

5954 i‡(
	`IS_ERR
(
qf_öode
)) {

5955 
	`pxt4_îr‹
(
sb
, "Bad quŸ®öodê# %lu", 
qf_öums
[
ty≥
]);

5956  
	`PTR_ERR
(
qf_öode
);

5960 
qf_öode
->
i_Êags
 |
S_NOQUOTA
;

5961 
	`lockdï_£t_quŸa_öode
(
qf_öode
, 
I_DATA_SEM_QUOTA
);

5962 
îr
 = 
	`dquŸ_íabÀ
(
qf_öode
, 
ty≥
, 
f‹m©_id
, 
Êags
);

5963 i‡(
îr
)

5964 
	`lockdï_£t_quŸa_öode
(
qf_öode
, 
I_DATA_SEM_NORMAL
);

5965 
	`ùut
(
qf_öode
);

5967  
îr
;

5968 
	}
}

5971 
	$pxt4_íabÀ_quŸas
(
su≥r_block
 *
sb
)

5973 
ty≥
, 
îr
 = 0;

5974 
qf_öums
[
PXT4_MAXQUOTAS
] = {

5975 
	`À32_to_˝u
(
	`PXT4_SB
(
sb
)->
s_es
->
s_u§_quŸa_öum
),

5976 
	`À32_to_˝u
(
	`PXT4_SB
(
sb
)->
s_es
->
s_gΩ_quŸa_öum
),

5977 
	`À32_to_˝u
(
	`PXT4_SB
(
sb
)->
s_es
->
s_¥j_quŸa_öum
)

5979 
boﬁ
 
quŸa_m›t
[
PXT4_MAXQUOTAS
] = {

5980 
	`ã°_›t
(
sb
, 
USRQUOTA
),

5981 
	`ã°_›t
(
sb
, 
GRPQUOTA
),

5982 
	`ã°_›t
(
sb
, 
PRJQUOTA
),

5985 
	`sb_dq›t
(
sb
)->
Êags
 |
DQUOT_QUOTA_SYS_FILE
 | 
DQUOT_NOLIST_DIRTY
;

5986 
ty≥
 = 0;Åy≥ < 
PXT4_MAXQUOTAS
;Åype++) {

5987 i‡(
qf_öums
[
ty≥
]) {

5988 
îr
 = 
	`pxt4_quŸa_íabÀ
(
sb
, 
ty≥
, 
QFMT_VFS_V1
,

5989 
DQUOT_USAGE_ENABLED
 |

5990 (
quŸa_m›t
[
ty≥
] ? 
DQUOT_LIMITS_ENABLED
 : 0));

5991 i‡(
îr
) {

5992 
	`pxt4_w¨nög
(
sb
,

5995 "e2fsckÅÿfix.", 
ty≥
, 
îr
);

5996 
ty≥
--;Åype >= 0;Åype--)

5997 
	`dquŸ_quŸa_off
(
sb
, 
ty≥
);

5999  
îr
;

6004 
	}
}

6006 
	$pxt4_quŸa_off
(
su≥r_block
 *
sb
, 
ty≥
)

6008 
öode
 *öodê
	`sb_dq›t
(
sb
)->
fûes
[
ty≥
];

6009 
h™dÀ_t
 *
h™dÀ
;

6010 
îr
;

6014 i‡(
	`ã°_›t
(
sb
, 
DELALLOC
))

6015 
	`sync_fûesy°em
(
sb
);

6017 i‡(!
öode
 || !
	`igøb
(inode))

6018 
out
;

6020 
îr
 = 
	`dquŸ_quŸa_off
(
sb
, 
ty≥
);

6021 i‡(
îr
 || 
	`pxt4_has_„©uª_quŸa
(
sb
))

6022 
out_put
;

6024 
	`öode_lock
(
öode
);

6030 
h™dÀ
 = 
	`pxt4_jou∫Æ_°¨t
(
öode
, 
PXT4_HT_QUOTA
, 1);

6031 i‡(
	`IS_ERR
(
h™dÀ
))

6032 
out_u∆ock
;

6033 
	`PXT4_I
(
öode
)->
i_Êags
 &~(
PXT4_NOATIME_FL
 | 
PXT4_IMMUTABLE_FL
);

6034 
	`öode_£t_Êags
(
öode
, 0, 
S_NOATIME
 | 
S_IMMUTABLE
);

6035 
öode
->
i_mtime
 = inode->
i_˘ime
 = 
	`cuºít_time
(inode);

6036 
	`pxt4_m¨k_öode_dúty
(
h™dÀ
, 
öode
);

6037 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

6038 
out_u∆ock
:

6039 
	`öode_u∆ock
(
öode
);

6040 
out_put
:

6041 
	`lockdï_£t_quŸa_öode
(
öode
, 
I_DATA_SEM_NORMAL
);

6042 
	`ùut
(
öode
);

6043  
îr
;

6044 
out
:

6045  
	`dquŸ_quŸa_off
(
sb
, 
ty≥
);

6046 
	}
}

6052 
ssize_t
 
	$pxt4_quŸa_ªad
(
su≥r_block
 *
sb
, 
ty≥
, *
d©a
,

6053 
size_t
 
Àn
, 
loff_t
 
off
)

6055 
öode
 *öodê
	`sb_dq›t
(
sb
)->
fûes
[
ty≥
];

6056 
pxt4_lblk_t
 
blk
 = 
off
 >> 
	`PXT4_BLOCK_SIZE_BITS
(
sb
);

6057 
off£t
 = 
off
 & (
sb
->
s_blocksize
 - 1);

6058 
toc›y
;

6059 
size_t
 
t‹ód
;

6060 
buf„r_hód
 *
bh
;

6061 
loff_t
 
i_size
 = 
	`i_size_ªad
(
öode
);

6063 i‡(
off
 > 
i_size
)

6065 i‡(
off
+
Àn
 > 
i_size
)

6066 
Àn
 = 
i_size
-
off
;

6067 
t‹ód
 = 
Àn
;

6068 
t‹ód
 > 0) {

6069 
toc›y
 = 
sb
->
s_blocksize
 - 
off£t
 < 
t‹ód
 ?

6070 
sb
->
s_blocksize
 - 
off£t
 : 
t‹ód
;

6071 
bh
 = 
	`pxt4_bªad
(
NULL
, 
öode
, 
blk
, 0);

6072 i‡(
	`IS_ERR
(
bh
))

6073  
	`PTR_ERR
(
bh
);

6074 i‡(!
bh
)

6075 
	`mem£t
(
d©a
, 0, 
toc›y
);

6077 
	`mem˝y
(
d©a
, 
bh
->
b_d©a
+
off£t
, 
toc›y
);

6078 
	`bªl£
(
bh
);

6079 
off£t
 = 0;

6080 
t‹ód
 -
toc›y
;

6081 
d©a
 +
toc›y
;

6082 
blk
++;

6084  
Àn
;

6085 
	}
}

6089 
ssize_t
 
	$pxt4_quŸa_wrôe
(
su≥r_block
 *
sb
, 
ty≥
,

6090 c⁄° *
d©a
, 
size_t
 
Àn
, 
loff_t
 
off
)

6092 
öode
 *öodê
	`sb_dq›t
(
sb
)->
fûes
[
ty≥
];

6093 
pxt4_lblk_t
 
blk
 = 
off
 >> 
	`PXT4_BLOCK_SIZE_BITS
(
sb
);

6094 
îr
, 
off£t
 = 
off
 & (
sb
->
s_blocksize
 - 1);

6095 
ªåõs
 = 0;

6096 
buf„r_hód
 *
bh
;

6097 
h™dÀ_t
 *
h™dÀ
 = 
	`jou∫Æ_cuºít_h™dÀ
();

6099 i‡(
	`PXT4_SB
(
sb
)->
s_jou∫Æ
 && !
h™dÀ
) {

6100 
	`pxt4_msg
(
sb
, 
KERN_WARNING
, "Quota write (off=%llu,Üen=%llu)"

6102 ()
off
, ()
Àn
);

6103  -
EIO
;

6109 i‡(
sb
->
s_blocksize
 - 
off£t
 < 
Àn
) {

6110 
	`pxt4_msg
(
sb
, 
KERN_WARNING
, "Quota write (off=%llu,Üen=%llu)"

6112 ()
off
, ()
Àn
);

6113  -
EIO
;

6117 
bh
 = 
	`pxt4_bªad
(
h™dÀ
, 
öode
, 
blk
,

6118 
PXT4_GET_BLOCKS_CREATE
 |

6119 
PXT4_GET_BLOCKS_METADATA_NOFAIL
);

6120 } 
	`IS_ERR
(
bh
Ë&& (
	`PTR_ERR
(bhË=-
ENOSPC
) &&

6121 
	`pxt4_should_ªåy_Æloc
(
öode
->
i_sb
, &
ªåõs
));

6122 i‡(
	`IS_ERR
(
bh
))

6123  
	`PTR_ERR
(
bh
);

6124 i‡(!
bh
)

6125 
out
;

6126 
	`BUFFER_TRACE
(
bh
, "get writeáccess");

6127 
îr
 = 
	`pxt4_jou∫Æ_gë_wrôe_ac˚ss
(
h™dÀ
, 
bh
);

6128 i‡(
îr
) {

6129 
	`bªl£
(
bh
);

6130  
îr
;

6132 
	`lock_buf„r
(
bh
);

6133 
	`mem˝y
(
bh
->
b_d©a
+
off£t
, 
d©a
, 
Àn
);

6134 
	`Êush_dˇche_∑ge
(
bh
->
b_∑ge
);

6135 
	`u∆ock_buf„r
(
bh
);

6136 
îr
 = 
	`pxt4_h™dÀ_dúty_mëad©a
(
h™dÀ
, 
NULL
, 
bh
);

6137 
	`bªl£
(
bh
);

6138 
out
:

6139 i‡(
öode
->
i_size
 < 
off
 + 
Àn
) {

6140 
	`i_size_wrôe
(
öode
, 
off
 + 
Àn
);

6141 
	`PXT4_I
(
öode
)->
i_disksize
 = inode->
i_size
;

6142 
	`pxt4_m¨k_öode_dúty
(
h™dÀ
, 
öode
);

6144  
Àn
;

6145 
	}
}

6147 
	$pxt4_gë_√xt_id
(
su≥r_block
 *
sb
, 
kqid
 *
qid
)

6149 c⁄° 
quŸa_f‹m©_›s
 *
›s
;

6151 i‡(!
	`sb_has_quŸa_lﬂded
(
sb
, 
qid
->
ty≥
))

6152  -
ESRCH
;

6153 
›s
 = 
	`sb_dq›t
(
sb
)->›s[
qid
->
ty≥
];

6154 i‡(!
›s
 || !›s->
gë_√xt_id
)

6155  -
ENOSYS
;

6156  
	`dquŸ_gë_√xt_id
(
sb
, 
qid
);

6157 
	}
}

6160 
díåy
 *
	$pxt4_mou¡
(
fûe_sy°em_ty≥
 *
fs_ty≥
, 
Êags
,

6161 c⁄° *
dev_«me
, *
d©a
)

6163  
	`mou¡_bdev
(
fs_ty≥
, 
Êags
, 
dev_«me
, 
d©a
, 
pxt4_fûl_su≥r
);

6164 
	}
}

6166 #i‡!
deföed
(
CONFIG_EXT2_FS
Ë&& !deföed(
CONFIG_EXT2_FS_MODULE
Ë&& deföed(
CONFIG_PXT4_USE_FOR_EXT2
)

6167 
ölöe
 
	$ªgi°î_as_pxt2
()

6169 
îr
 = 
	`ªgi°î_fûesy°em
(&
pxt2_fs_ty≥
);

6170 i‡(
îr
)

6171 
	`¥ötk
(
KERN_WARNING


6172 "PXT4-fs: U«bÀÅÿªgi°îá†pxt2 (%d)\n", 
îr
);

6173 
	}
}

6175 
ölöe
 
	$uƒegi°î_as_pxt2
()

6177 
	`uƒegi°î_fûesy°em
(&
pxt2_fs_ty≥
);

6178 
	}
}

6180 
ölöe
 
	$pxt2_„©uª_£t_ok
(
su≥r_block
 *
sb
)

6182 i‡(
	`pxt4_has_unknown_pxt2_öcom∑t_„©uªs
(
sb
))

6184 i‡(
	`sb_rd⁄ly
(
sb
))

6186 i‡(
	`pxt4_has_unknown_pxt2_ro_com∑t_„©uªs
(
sb
))

6189 
	}
}

6191 
ölöe
 
	$ªgi°î_as_pxt2
(Ë{ 
	}
}

6192 
ölöe
 
	$uƒegi°î_as_pxt2
(Ë{ 
	}
}

6193 
ölöe
 
	$pxt2_„©uª_£t_ok
(
su≥r_block
 *
sb
Ë{  0; 
	}
}

6196 
ölöe
 
	$ªgi°î_as_ext3
()

6198 
îr
 = 
	`ªgi°î_fûesy°em
(&
ext3_fs_ty≥
);

6199 i‡(
îr
)

6200 
	`¥ötk
(
KERN_WARNING


6201 "PXT4-fs: U«bÀÅÿªgi°îá†ext3 (%d)\n", 
îr
);

6202 
	}
}

6204 
ölöe
 
	$uƒegi°î_as_ext3
()

6206 
	`uƒegi°î_fûesy°em
(&
ext3_fs_ty≥
);

6207 
	}
}

6209 
ölöe
 
	$ext3_„©uª_£t_ok
(
su≥r_block
 *
sb
)

6211 i‡(
	`pxt4_has_unknown_ext3_öcom∑t_„©uªs
(
sb
))

6213 i‡(!
	`pxt4_has_„©uª_jou∫Æ
(
sb
))

6215 i‡(
	`sb_rd⁄ly
(
sb
))

6217 i‡(
	`pxt4_has_unknown_ext3_ro_com∑t_„©uªs
(
sb
))

6220 
	}
}

6222 
fûe_sy°em_ty≥
 
	gpxt4_fs_ty≥
 = {

6223 .
ow√r
 = 
THIS_MODULE
,

6224 .
	g«me
 = "pxt4",

6225 .
	gmou¡
 = 
pxt4_mou¡
,

6226 .
	gkûl_sb
 = 
kûl_block_su≥r
,

6227 .
	gfs_Êags
 = 
FS_REQUIRES_DEV
,

6229 
MODULE_ALIAS_FS
("pxt4");

6232 
waô_queue_hód_t
 
	gpxt4__i€nd_wq
[
PXT4_WQ_HASH_SZ
];

6234 
__öô
 
	$pxt4_öô_fs
()

6236 
i
, 
îr
;

6238 
	`øãlimô_°©e_öô
(&
pxt4_mou¡_msg_øãlimô
, 30 * 
HZ
, 64);

6239 
pxt4_li_öfo
 = 
NULL
;

6240 
	`muãx_öô
(&
pxt4_li_mtx
);

6243 
	`pxt4_check_Êag_vÆues
();

6245 
i
 = 0; i < 
PXT4_WQ_HASH_SZ
; i++)

6246 
	`öô_waôqueue_hód
(&
pxt4__i€nd_wq
[
i
]);

6248 
îr
 = 
	`pxt4_öô_es
();

6249 i‡(
îr
)

6250  
îr
;

6252 
îr
 = 
	`pxt4_öô_≥ndög
();

6253 i‡(
îr
)

6254 
out7
;

6256 
îr
 = 
	`pxt4_öô_po°_ªad_¥o˚ssög
();

6257 i‡(
îr
)

6258 
out6
;

6260 
îr
 = 
	`pxt4_öô_∑geio
();

6261 i‡(
îr
)

6262 
out5
;

6264 
îr
 = 
	`pxt4_öô_sy°em_z⁄e
();

6265 i‡(
îr
)

6266 
out4
;

6268 
îr
 = 
	`pxt4_öô_sysfs
();

6269 i‡(
îr
)

6270 
out3
;

6272 
îr
 = 
	`pxt4_öô_mbÆloc
();

6273 i‡(
îr
)

6274 
out2
;

6275 
îr
 = 
	`öô_öodeˇche
();

6276 i‡(
îr
)

6277 
out1
;

6278 
	`ªgi°î_as_ext3
();

6279 
	`ªgi°î_as_pxt2
();

6280 
îr
 = 
	`ªgi°î_fûesy°em
(&
pxt4_fs_ty≥
);

6281 i‡(
îr
)

6282 
out
;

6285 
out
:

6286 
	`uƒegi°î_as_pxt2
();

6287 
	`uƒegi°î_as_ext3
();

6288 
	`de°roy_öodeˇche
();

6289 
out1
:

6290 
	`pxt4_exô_mbÆloc
();

6291 
out2
:

6292 
	`pxt4_exô_sysfs
();

6293 
out3
:

6294 
	`pxt4_exô_sy°em_z⁄e
();

6295 
out4
:

6296 
	`pxt4_exô_∑geio
();

6297 
out5
:

6298 
	`pxt4_exô_po°_ªad_¥o˚ssög
();

6299 
out6
:

6300 
	`pxt4_exô_≥ndög
();

6301 
out7
:

6302 
	`pxt4_exô_es
();

6304  
îr
;

6305 
	}
}

6307 
__exô
 
	$pxt4_exô_fs
()

6309 
	`pxt4_de°roy_œzyöô_thªad
();

6310 
	`uƒegi°î_as_pxt2
();

6311 
	`uƒegi°î_as_ext3
();

6312 
	`uƒegi°î_fûesy°em
(&
pxt4_fs_ty≥
);

6313 
	`de°roy_öodeˇche
();

6314 
	`pxt4_exô_mbÆloc
();

6315 
	`pxt4_exô_sysfs
();

6316 
	`pxt4_exô_sy°em_z⁄e
();

6317 
	`pxt4_exô_∑geio
();

6318 
	`pxt4_exô_po°_ªad_¥o˚ssög
();

6319 
	`pxt4_exô_es
();

6320 
	`pxt4_exô_≥ndög
();

6321 
	}
}

6323 
MODULE_AUTHOR
("Remy Card, Stephen Tweedie, Andrew Morton, Andreas Dilger, Theodore Ts'oánd others");

6324 
MODULE_DESCRIPTION
("Fourth Extended Filesystem");

6325 
MODULE_LICENSE
("GPL");

6326 
MODULE_SOFTDEP
("pre: crc32c");

6327 
	$moduÀ_öô
(
pxt4_öô_fs
)

6328 
	`moduÀ_exô
(
pxt4_exô_fs
)

	@symlink.c

21 
	~<löux/fs.h
>

22 
	~<löux/«mei.h
>

23 
	~"pxt4.h
"

24 
	~"x©å.h
"

26 c⁄° *
	$pxt4_í¸y±ed_gë_lök
(
díåy
 *dentry,

27 
öode
 *inode,

28 
dñayed_ˇŒ
 *
d⁄e
)

30 
∑ge
 *
˝age
 = 
NULL
;

31 c⁄° *
ˇddr
;

32 
max_size
;

33 c⁄° *
∑ddr
;

35 i‡(!
díåy
)

36  
	`ERR_PTR
(-
ECHILD
);

38 i‡(
	`pxt4_öode_is_Á°_symlök
(
öode
)) {

39 
ˇddr
 = 
	`PXT4_I
(
öode
)->
i_d©a
;

40 
max_size
 = (
	`PXT4_I
(
öode
)->
i_d©a
);

42 
˝age
 = 
	`ªad_m≠pög_∑ge
(
öode
->
i_m≠pög
, 0, 
NULL
);

43 i‡(
	`IS_ERR
(
˝age
))

44  
	`ERR_CAST
(
˝age
);

45 
ˇddr
 = 
	`∑ge_addªss
(
˝age
);

46 
max_size
 = 
öode
->
i_sb
->
s_blocksize
;

49 
∑ddr
 = 
	`fs¸y±_gë_symlök
(
öode
, 
ˇddr
, 
max_size
, 
d⁄e
);

50 i‡(
˝age
)

51 
	`put_∑ge
(
˝age
);

52  
∑ddr
;

53 
	}
}

55 
	$pxt4_í¸y±ed_symlök_gë©å
(c⁄° 
∑th
 *path,

56 
k°©
 *
°©
, 
u32
 
ªque°_mask
,

57 
quîy_Êags
)

59 
	`pxt4_gë©å
(
∑th
, 
°©
, 
ªque°_mask
, 
quîy_Êags
);

61  
	`fs¸y±_symlök_gë©å
(
∑th
, 
°©
);

62 
	}
}

64 c⁄° 
öode_›î©i⁄s
 
	gpxt4_í¸y±ed_symlök_öode_›î©i⁄s
 = {

65 .
gë_lök
 = 
pxt4_í¸y±ed_gë_lök
,

66 .
	g£èâr
 = 
pxt4_£èâr
,

67 .
	ggë©å
 = 
pxt4_í¸y±ed_symlök_gë©å
,

68 .
	gli°x©å
 = 
pxt4_li°x©å
,

71 c⁄° 
öode_›î©i⁄s
 
	gpxt4_symlök_öode_›î©i⁄s
 = {

72 .
gë_lök
 = 
∑ge_gë_lök
,

73 .
	g£èâr
 = 
pxt4_£èâr
,

74 .
	ggë©å
 = 
pxt4_gë©å
,

75 .
	gli°x©å
 = 
pxt4_li°x©å
,

78 c⁄° 
öode_›î©i⁄s
 
	gpxt4_Á°_symlök_öode_›î©i⁄s
 = {

79 .
gë_lök
 = 
sim∂e_gë_lök
,

80 .
	g£èâr
 = 
pxt4_£èâr
,

81 .
	ggë©å
 = 
pxt4_gë©å
,

82 .
	gli°x©å
 = 
pxt4_li°x©å
,

	@sysfs.c

11 
	~<löux/time.h
>

12 
	~<löux/fs.h
>

13 
	~<löux/£q_fûe.h
>

14 
	~<löux/¶ab.h
>

15 
	~<löux/¥oc_fs.h
>

17 
	~"pxt4.h
"

18 
	~"pxt4_jbd3.h
"

21 
	m©å_no›
,

22 
	m©å_dñayed_Æloˇti⁄_blocks
,

23 
	m©å_£ssi⁄_wrôe_kbyãs
,

24 
	m©å_li„time_wrôe_kbyãs
,

25 
	m©å_ª£rved_˛u°îs
,

26 
	m©å_§a_ex˚eded_ªåy_limô
,

27 
	m©å_öode_ªadahód
,

28 
	m©å_åiggî_ã°_îr‹
,

29 
	m©å_fú°_îr‹_time
,

30 
	m©å_œ°_îr‹_time
,

31 
	m©å_„©uª
,

32 
	m©å_poöãr_ui
,

33 
	m©å_poöãr_©omic
,

34 
	m©å_jou∫Æ_èsk
,

35 } 
	t©å_id_t
;

38 
	m±r_ex∂icô
,

39 
	m±r_pxt4_sb_öfo_off£t
,

40 
	m±r_pxt4_su≥r_block_off£t
,

41 } 
	t©å_±r_t
;

43 c⁄° 
	g¥oc_dú«me
[] = "fs/pxt4";

44 
¥oc_dú_íåy
 *
	gpxt4_¥oc_roŸ
;

46 
	spxt4_©å
 {

47 
©åibuã
 
	m©å
;

48 
	m©å_id
;

49 
	m©å_±r
;

51 
	moff£t
;

52 *
	mex∂icô_±r
;

53 } 
	mu
;

56 
ssize_t
 
	$£ssi⁄_wrôe_kbyãs_show
(
pxt4_sb_öfo
 *
sbi
, *
buf
)

58 
su≥r_block
 *
sb
 = 
sbi
->
s_buddy_ˇche
->
i_sb
;

60 i‡(!
sb
->
s_bdev
->
bd_∑π
)

61  
	`¢¥ötf
(
buf
, 
PAGE_SIZE
, "0\n");

62  
	`¢¥ötf
(
buf
, 
PAGE_SIZE
, "%lu\n",

63 (
	`∑π_°©_ªad
(
sb
->
s_bdev
->
bd_∑π
,

64 
£˘‹s
[
STAT_WRITE
]) -

65 
sbi
->
s_£˘‹s_wrôãn_°¨t
) >> 1);

66 
	}
}

68 
ssize_t
 
	$li„time_wrôe_kbyãs_show
(
pxt4_sb_öfo
 *
sbi
, *
buf
)

70 
su≥r_block
 *
sb
 = 
sbi
->
s_buddy_ˇche
->
i_sb
;

72 i‡(!
sb
->
s_bdev
->
bd_∑π
)

73  
	`¢¥ötf
(
buf
, 
PAGE_SIZE
, "0\n");

74  
	`¢¥ötf
(
buf
, 
PAGE_SIZE
, "%llu\n",

75 ()(
sbi
->
s_kbyãs_wrôãn
 +

76 ((
	`∑π_°©_ªad
(
sb
->
s_bdev
->
bd_∑π
,

77 
£˘‹s
[
STAT_WRITE
]) -

78 
	`PXT4_SB
(
sb
)->
s_£˘‹s_wrôãn_°¨t
) >> 1)));

79 
	}
}

81 
ssize_t
 
	$öode_ªadahód_blks_°‹e
(
pxt4_sb_öfo
 *
sbi
,

82 c⁄° *
buf
, 
size_t
 
cou¡
)

84 
t
;

85 
ªt
;

87 
ªt
 = 
	`k°πoul
(
	`skù_•a˚s
(
buf
), 0, &
t
);

88 i‡(
ªt
)

89  
ªt
;

91 i‡(
t
 && (!
	`is_powî_of_2
(t) ||Å > 0x40000000))

92  -
EINVAL
;

94 
sbi
->
s_öode_ªadahód_blks
 = 
t
;

95  
cou¡
;

96 
	}
}

98 
ssize_t
 
	$ª£rved_˛u°îs_°‹e
(
pxt4_sb_öfo
 *
sbi
,

99 c⁄° *
buf
, 
size_t
 
cou¡
)

101 
vÆ
;

102 
pxt4_fsblk_t
 
˛u°îs
 = (
	`pxt4_blocks_cou¡
(
sbi
->
s_es
) >>

103 
sbi
->
s_˛u°î_bôs
);

104 
ªt
;

106 
ªt
 = 
	`k°πouŒ
(
	`skù_•a˚s
(
buf
), 0, &
vÆ
);

107 i‡(
ªt
 || 
vÆ
 >
˛u°îs
)

108  -
EINVAL
;

110 
	`©omic64_£t
(&
sbi
->
s_ªsv_˛u°îs
, 
vÆ
);

111  
cou¡
;

112 
	}
}

114 
ssize_t
 
	$åiggî_ã°_îr‹
(
pxt4_sb_öfo
 *
sbi
,

115 c⁄° *
buf
, 
size_t
 
cou¡
)

117 
Àn
 = 
cou¡
;

119 i‡(!
	`ˇ∑bÀ
(
CAP_SYS_ADMIN
))

120  -
EPERM
;

122 i‡(
Àn
 && 
buf
[len-1] == '\n')

123 
Àn
--;

125 i‡(
Àn
)

126 
	`pxt4_îr‹
(
sbi
->
s_sb
, "%.*s", 
Àn
, 
buf
);

127  
cou¡
;

128 
	}
}

130 
ssize_t
 
	$jou∫Æ_èsk_show
(
pxt4_sb_öfo
 *
sbi
, *
buf
)

132 i‡(!
sbi
->
s_jou∫Æ
)

133  
	`¢¥ötf
(
buf
, 
PAGE_SIZE
, "<none>\n");

134  
	`¢¥ötf
(
buf
, 
PAGE_SIZE
, "%d\n",

135 
	`èsk_pid_vƒ
(
sbi
->
s_jou∫Æ
->
j_èsk
));

136 
	}
}

138 
	#PXT4_ATTR
(
_«me
,
_mode
,
_id
) \

139 
pxt4_©å
 
pxt4_©å_
##
_«me
 = { \

140 .
©å
 = {.
«me
 = 
	`__°rögify
(
_«me
), .
mode
 = 
_mode
 }, \

141 .
©å_id
 = 
©å_
##
_id
, \

142 }

	)

144 
	#PXT4_ATTR_FUNC
(
_«me
,
_mode
Ë
	`PXT4_ATTR
(_«me,_mode,_«me)

	)

146 
	#PXT4_ATTR_FEATURE
(
_«me
Ë
	`PXT4_ATTR
(_«me, 0444, 
„©uª
)

	)

148 
	#PXT4_ATTR_OFFSET
(
_«me
,
_mode
,
_id
,
_°ru˘
,
_ñ«me
) \

149 
pxt4_©å
 
pxt4_©å_
##
_«me
 = { \

150 .
©å
 = {.
«me
 = 
	`__°rögify
(
_«me
), .
mode
 = 
_mode
 }, \

151 .
©å_id
 = 
©å_
##
_id
, \

152 .
©å_±r
 = 
±r_
##
_°ru˘
##
_off£t
, \

153 .
u
 = { \

154 .
off£t
 = 
	`off£tof
(
_°ru˘
, 
_ñ«me
),\

156 }

	)

158 
	#PXT4_RO_ATTR_ES_UI
(
_«me
,
_ñ«me
) \

159 
	`PXT4_ATTR_OFFSET
(
_«me
, 0444, 
poöãr_ui
, 
pxt4_su≥r_block
, 
_ñ«me
)

	)

161 
	#PXT4_RW_ATTR_SBI_UI
(
_«me
,
_ñ«me
) \

162 
	`PXT4_ATTR_OFFSET
(
_«me
, 0644, 
poöãr_ui
, 
pxt4_sb_öfo
, 
_ñ«me
)

	)

164 
	#PXT4_ATTR_PTR
(
_«me
,
_mode
,
_id
,
_±r
) \

165 
pxt4_©å
 
pxt4_©å_
##
_«me
 = { \

166 .
©å
 = {.
«me
 = 
	`__°rögify
(
_«me
), .
mode
 = 
_mode
 }, \

167 .
©å_id
 = 
©å_
##
_id
, \

168 .
©å_±r
 = 
±r_ex∂icô
, \

169 .
u
 = { \

170 .
ex∂icô_±r
 = 
_±r
, \

172 }

	)

174 
	#ATTR_LIST
(
«me
Ë&
pxt4_©å_
##«me.
©å


	)

176 
PXT4_ATTR_FUNC
(
dñayed_Æloˇti⁄_blocks
, 0444);

177 
PXT4_ATTR_FUNC
(
£ssi⁄_wrôe_kbyãs
, 0444);

178 
PXT4_ATTR_FUNC
(
li„time_wrôe_kbyãs
, 0444);

179 
PXT4_ATTR_FUNC
(
ª£rved_˛u°îs
, 0644);

180 
PXT4_ATTR_FUNC
(
§a_ex˚eded_ªåy_limô
, 0444);

182 
PXT4_ATTR_OFFSET
(
öode_ªadahód_blks
, 0644, 
öode_ªadahód
,

183 
pxt4_sb_öfo
, 
s_öode_ªadahód_blks
);

184 
PXT4_RW_ATTR_SBI_UI
(
öode_gﬂl
, 
s_öode_gﬂl
);

185 
PXT4_RW_ATTR_SBI_UI
(
mb_°©s
, 
s_mb_°©s
);

186 
PXT4_RW_ATTR_SBI_UI
(
mb_max_to_sˇn
, 
s_mb_max_to_sˇn
);

187 
PXT4_RW_ATTR_SBI_UI
(
mb_mö_to_sˇn
, 
s_mb_mö_to_sˇn
);

188 
PXT4_RW_ATTR_SBI_UI
(
mb_‹dî2_ªq
, 
s_mb_‹dî2_ªqs
);

189 
PXT4_RW_ATTR_SBI_UI
(
mb_°ªam_ªq
, 
s_mb_°ªam_ªque°
);

190 
PXT4_RW_ATTR_SBI_UI
(
mb_group_¥óŒoc
, 
s_mb_group_¥óŒoc
);

191 
PXT4_RW_ATTR_SBI_UI
(
exã¡_max_zîoout_kb
, 
s_exã¡_max_zîoout_kb
);

192 
PXT4_ATTR
(
åiggî_fs_îr‹
, 0200, 
åiggî_ã°_îr‹
);

193 
PXT4_RW_ATTR_SBI_UI
(
îr_øãlimô_öãrvÆ_ms
, 
s_îr_øãlimô_°©e
.
öãrvÆ
);

194 
PXT4_RW_ATTR_SBI_UI
(
îr_øãlimô_bur°
, 
s_îr_øãlimô_°©e
.
bur°
);

195 
PXT4_RW_ATTR_SBI_UI
(
w¨nög_øãlimô_öãrvÆ_ms
, 
s_w¨nög_øãlimô_°©e
.
öãrvÆ
);

196 
PXT4_RW_ATTR_SBI_UI
(
w¨nög_øãlimô_bur°
, 
s_w¨nög_øãlimô_°©e
.
bur°
);

197 
PXT4_RW_ATTR_SBI_UI
(
msg_øãlimô_öãrvÆ_ms
, 
s_msg_øãlimô_°©e
.
öãrvÆ
);

198 
PXT4_RW_ATTR_SBI_UI
(
msg_øãlimô_bur°
, 
s_msg_øãlimô_°©e
.
bur°
);

199 
PXT4_RO_ATTR_ES_UI
(
îr‹s_cou¡
, 
s_îr‹_cou¡
);

200 
PXT4_ATTR
(
fú°_îr‹_time
, 0444, first_error_time);

201 
PXT4_ATTR
(
œ°_îr‹_time
, 0444,Üast_error_time);

202 
PXT4_ATTR
(
jou∫Æ_èsk
, 0444, journal_task);

204 
	gﬁd_bump_vÆ
 = 128;

205 
PXT4_ATTR_PTR
(
max_wrôeback_mb_bump
, 0444, 
poöãr_ui
, &
ﬁd_bump_vÆ
);

207 
©åibuã
 *
	gpxt4_©ås
[] = {

208 
ATTR_LIST
(
dñayed_Æloˇti⁄_blocks
),

209 
ATTR_LIST
(
£ssi⁄_wrôe_kbyãs
),

210 
ATTR_LIST
(
li„time_wrôe_kbyãs
),

211 
ATTR_LIST
(
ª£rved_˛u°îs
),

212 
ATTR_LIST
(
§a_ex˚eded_ªåy_limô
),

213 
ATTR_LIST
(
öode_ªadahód_blks
),

214 
ATTR_LIST
(
öode_gﬂl
),

215 
ATTR_LIST
(
mb_°©s
),

216 
ATTR_LIST
(
mb_max_to_sˇn
),

217 
ATTR_LIST
(
mb_mö_to_sˇn
),

218 
ATTR_LIST
(
mb_‹dî2_ªq
),

219 
ATTR_LIST
(
mb_°ªam_ªq
),

220 
ATTR_LIST
(
mb_group_¥óŒoc
),

221 
ATTR_LIST
(
max_wrôeback_mb_bump
),

222 
ATTR_LIST
(
exã¡_max_zîoout_kb
),

223 
ATTR_LIST
(
åiggî_fs_îr‹
),

224 
ATTR_LIST
(
îr_øãlimô_öãrvÆ_ms
),

225 
ATTR_LIST
(
îr_øãlimô_bur°
),

226 
ATTR_LIST
(
w¨nög_øãlimô_öãrvÆ_ms
),

227 
ATTR_LIST
(
w¨nög_øãlimô_bur°
),

228 
ATTR_LIST
(
msg_øãlimô_öãrvÆ_ms
),

229 
ATTR_LIST
(
msg_øãlimô_bur°
),

230 
ATTR_LIST
(
îr‹s_cou¡
),

231 
ATTR_LIST
(
fú°_îr‹_time
),

232 
ATTR_LIST
(
œ°_îr‹_time
),

233 
ATTR_LIST
(
jou∫Æ_èsk
),

234 
NULL
,

236 
ATTRIBUTE_GROUPS
(
pxt4
);

239 
PXT4_ATTR_FEATURE
(
œzy_ôabÀ_öô
);

240 
PXT4_ATTR_FEATURE
(
b©ched_disˇrd
);

241 
PXT4_ATTR_FEATURE
(
mëa_bg_ªsize
);

242 #ifde‡
CONFIG_FS_ENCRYPTION


243 
PXT4_ATTR_FEATURE
(
í¸y±i⁄
);

245 #ifde‡
CONFIG_UNICODE


246 
PXT4_ATTR_FEATURE
(
ˇ£fﬁd
);

248 #ifde‡
CONFIG_FS_VERITY


249 
PXT4_ATTR_FEATURE
(
vîôy
);

251 
PXT4_ATTR_FEATURE
(
mëad©a_csum_£ed
);

253 
©åibuã
 *
	gpxt4_„©_©ås
[] = {

254 
ATTR_LIST
(
œzy_ôabÀ_öô
),

255 
ATTR_LIST
(
b©ched_disˇrd
),

256 
ATTR_LIST
(
mëa_bg_ªsize
),

257 #ifde‡
CONFIG_FS_ENCRYPTION


258 
ATTR_LIST
(
í¸y±i⁄
),

260 #ifde‡
CONFIG_UNICODE


261 
ATTR_LIST
(
ˇ£fﬁd
),

263 #ifde‡
CONFIG_FS_VERITY


264 
ATTR_LIST
(
vîôy
),

266 
ATTR_LIST
(
mëad©a_csum_£ed
),

267 
NULL
,

269 
ATTRIBUTE_GROUPS
(
pxt4_„©
);

271 *
	$ˇlc_±r
(
pxt4_©å
 *
a
, 
pxt4_sb_öfo
 *
sbi
)

273 
a
->
©å_±r
) {

274 
±r_ex∂icô
:

275  
a
->
u
.
ex∂icô_±r
;

276 
±r_pxt4_sb_öfo_off£t
:

277  (*Ë(((*Ë
sbi
Ë+ 
a
->
u
.
off£t
);

278 
±r_pxt4_su≥r_block_off£t
:

279  (*Ë(((*Ë
sbi
->
s_es
Ë+ 
a
->
u
.
off£t
);

281  
NULL
;

282 
	}
}

284 
ssize_t
 
	$__¥öt_t°amp
(*
buf
, 
__À32
 
lo
, 
__u8
 
hi
)

286  
	`¢¥ötf
(
buf
, 
PAGE_SIZE
, "%lld",

287 ((
time64_t
)
hi
 << 32Ë+ 
	`À32_to_˝u
(
lo
));

288 
	}
}

290 
	#¥öt_t°amp
(
buf
, 
es
, 
t°amp
) \

291 
	`__¥öt_t°amp
(
buf
, (
es
)->
t°amp
, (es)->t°am∞## 
_hi
)

	)

293 
ssize_t
 
	$pxt4_©å_show
(
kobje˘
 *
kobj
,

294 
©åibuã
 *
©å
, *
buf
)

296 
pxt4_sb_öfo
 *
sbi
 = 
	`c⁄èöî_of
(
kobj
, pxt4_sb_info,

297 
s_kobj
);

298 
pxt4_©å
 *
a
 = 
	`c⁄èöî_of
(
©å
, pxt4_attr,áttr);

299 *
±r
 = 
	`ˇlc_±r
(
a
, 
sbi
);

301 
a
->
©å_id
) {

302 
©å_dñayed_Æloˇti⁄_blocks
:

303  
	`¢¥ötf
(
buf
, 
PAGE_SIZE
, "%llu\n",

304 (
s64
Ë
	`PXT4_C2B
(
sbi
,

305 
	`≥r˝u_cou¡î_sum
(&
sbi
->
s_dúty˛u°îs_cou¡î
)));

306 
©å_£ssi⁄_wrôe_kbyãs
:

307  
	`£ssi⁄_wrôe_kbyãs_show
(
sbi
, 
buf
);

308 
©å_li„time_wrôe_kbyãs
:

309  
	`li„time_wrôe_kbyãs_show
(
sbi
, 
buf
);

310 
©å_ª£rved_˛u°îs
:

311  
	`¢¥ötf
(
buf
, 
PAGE_SIZE
, "%llu\n",

313 
	`©omic64_ªad
(&
sbi
->
s_ªsv_˛u°îs
));

314 
©å_§a_ex˚eded_ªåy_limô
:

315  
	`¢¥ötf
(
buf
, 
PAGE_SIZE
, "%llu\n",

317 
	`≥r˝u_cou¡î_sum
(&
sbi
->
s_§a_ex˚eded_ªåy_limô
));

318 
©å_öode_ªadahód
:

319 
©å_poöãr_ui
:

320 i‡(!
±r
)

322 i‡(
a
->
©å_±r
 =
±r_pxt4_su≥r_block_off£t
)

323  
	`¢¥ötf
(
buf
, 
PAGE_SIZE
, "%u\n",

324 
	`À32_to_˝up
(
±r
));

326  
	`¢¥ötf
(
buf
, 
PAGE_SIZE
, "%u\n",

327 *((*Ë
±r
));

328 
©å_poöãr_©omic
:

329 i‡(!
±r
)

331  
	`¢¥ötf
(
buf
, 
PAGE_SIZE
, "%d\n",

332 
	`©omic_ªad
((
©omic_t
 *Ë
±r
));

333 
©å_„©uª
:

334  
	`¢¥ötf
(
buf
, 
PAGE_SIZE
, "supported\n");

335 
©å_fú°_îr‹_time
:

336  
	`¥öt_t°amp
(
buf
, 
sbi
->
s_es
, 
s_fú°_îr‹_time
);

337 
©å_œ°_îr‹_time
:

338  
	`¥öt_t°amp
(
buf
, 
sbi
->
s_es
, 
s_œ°_îr‹_time
);

339 
©å_jou∫Æ_èsk
:

340  
	`jou∫Æ_èsk_show
(
sbi
, 
buf
);

344 
	}
}

346 
ssize_t
 
	$pxt4_©å_°‹e
(
kobje˘
 *
kobj
,

347 
©åibuã
 *
©å
,

348 c⁄° *
buf
, 
size_t
 
Àn
)

350 
pxt4_sb_öfo
 *
sbi
 = 
	`c⁄èöî_of
(
kobj
, pxt4_sb_info,

351 
s_kobj
);

352 
pxt4_©å
 *
a
 = 
	`c⁄èöî_of
(
©å
, pxt4_attr,áttr);

353 *
±r
 = 
	`ˇlc_±r
(
a
, 
sbi
);

354 
t
;

355 
ªt
;

357 
a
->
©å_id
) {

358 
©å_ª£rved_˛u°îs
:

359  
	`ª£rved_˛u°îs_°‹e
(
sbi
, 
buf
, 
Àn
);

360 
©å_poöãr_ui
:

361 i‡(!
±r
)

363 
ªt
 = 
	`k°πoul
(
	`skù_•a˚s
(
buf
), 0, &
t
);

364 i‡(
ªt
)

365  
ªt
;

366 i‡(
a
->
©å_±r
 =
±r_pxt4_su≥r_block_off£t
)

367 *((
__À32
 *Ë
±r
Ë
	`˝u_to_À32
(
t
);

369 *((*Ë
±r
Ë
t
;

370  
Àn
;

371 
©å_öode_ªadahód
:

372  
	`öode_ªadahód_blks_°‹e
(
sbi
, 
buf
, 
Àn
);

373 
©å_åiggî_ã°_îr‹
:

374  
	`åiggî_ã°_îr‹
(
sbi
, 
buf
, 
Àn
);

377 
	}
}

379 
	$pxt4_sb_ªÀa£
(
kobje˘
 *
kobj
)

381 
pxt4_sb_öfo
 *
sbi
 = 
	`c⁄èöî_of
(
kobj
, pxt4_sb_info,

382 
s_kobj
);

383 
	`com∂ëe
(&
sbi
->
s_kobj_uƒegi°î
);

384 
	}
}

386 c⁄° 
sysfs_›s
 
	gpxt4_©å_›s
 = {

387 .
show
 = 
pxt4_©å_show
,

388 .
	g°‹e
 = 
pxt4_©å_°‹e
,

391 
kobj_ty≥
 
	gpxt4_sb_kty≥
 = {

392 .
deÁu…_groups
 = 
pxt4_groups
,

393 .
	gsysfs_›s
 = &
pxt4_©å_›s
,

394 .
	gªÀa£
 = 
pxt4_sb_ªÀa£
,

397 
kobj_ty≥
 
	gpxt4_„©_kty≥
 = {

398 .
deÁu…_groups
 = 
pxt4_„©_groups
,

399 .
	gsysfs_›s
 = &
pxt4_©å_›s
,

400 .
	gªÀa£
 = ((*)(
kobje˘
 *))
k‰ì
,

403 
kobje˘
 *
	gpxt4_roŸ
;

405 
kobje˘
 *
	gpxt4_„©
;

407 
	$pxt4_ªgi°î_sysfs
(
su≥r_block
 *
sb
)

409 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
sb
);

410 
îr
;

412 
	`öô_com∂ëi⁄
(&
sbi
->
s_kobj_uƒegi°î
);

413 
îr
 = 
	`kobje˘_öô_™d_add
(&
sbi
->
s_kobj
, &
pxt4_sb_kty≥
, 
pxt4_roŸ
,

414 "%s", 
sb
->
s_id
);

415 i‡(
îr
) {

416 
	`kobje˘_put
(&
sbi
->
s_kobj
);

417 
	`waô_f‹_com∂ëi⁄
(&
sbi
->
s_kobj_uƒegi°î
);

418  
îr
;

421 i‡(
pxt4_¥oc_roŸ
)

422 
sbi
->
s_¥oc
 = 
	`¥oc_mkdú
(
sb
->
s_id
, 
pxt4_¥oc_roŸ
);

423 i‡(
sbi
->
s_¥oc
) {

424 
	`¥oc_¸óã_sögÀ_d©a
("›ti⁄s", 
S_IRUGO
, 
sbi
->
s_¥oc
,

425 
pxt4_£q_›ti⁄s_show
, 
sb
);

426 
	`¥oc_¸óã_sögÀ_d©a
("es_shrökî_öfo", 
S_IRUGO
,

427 
sbi
->
s_¥oc
, 
pxt4_£q_es_shrökî_öfo_show
,

428 
sb
);

429 
	`¥oc_¸óã_£q_d©a
("mb_groups", 
S_IRUGO
, 
sbi
->
s_¥oc
,

430 &
pxt4_mb_£q_groups_›s
, 
sb
);

433 
	}
}

435 
	$pxt4_uƒegi°î_sysfs
(
su≥r_block
 *
sb
)

437 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
sb
);

439 i‡(
sbi
->
s_¥oc
)

440 
	`ªmove_¥oc_subåì
(
sb
->
s_id
, 
pxt4_¥oc_roŸ
);

441 
	`kobje˘_dñ
(&
sbi
->
s_kobj
);

442 
	}
}

444 
__öô
 
	$pxt4_öô_sysfs
()

446 
ªt
;

448 
pxt4_roŸ
 = 
	`kobje˘_¸óã_™d_add
("pxt4", 
fs_kobj
);

449 i‡(!
pxt4_roŸ
)

450  -
ENOMEM
;

452 
pxt4_„©
 = 
	`kzÆloc
((*pxt4_„©), 
GFP_KERNEL
);

453 i‡(!
pxt4_„©
) {

454 
ªt
 = -
ENOMEM
;

455 
roŸ_îr
;

458 
ªt
 = 
	`kobje˘_öô_™d_add
(
pxt4_„©
, &
pxt4_„©_kty≥
,

459 
pxt4_roŸ
, "features");

460 i‡(
ªt
)

461 
„©_îr
;

463 
pxt4_¥oc_roŸ
 = 
	`¥oc_mkdú
(
¥oc_dú«me
, 
NULL
);

464  
ªt
;

466 
„©_îr
:

467 
	`kobje˘_put
(
pxt4_„©
);

468 
pxt4_„©
 = 
NULL
;

469 
roŸ_îr
:

470 
	`kobje˘_put
(
pxt4_roŸ
);

471 
pxt4_roŸ
 = 
NULL
;

472  
ªt
;

473 
	}
}

475 
	$pxt4_exô_sysfs
()

477 
	`kobje˘_put
(
pxt4_„©
);

478 
pxt4_„©
 = 
NULL
;

479 
	`kobje˘_put
(
pxt4_roŸ
);

480 
pxt4_roŸ
 = 
NULL
;

481 
	`ªmove_¥oc_íåy
(
¥oc_dú«me
, 
NULL
);

482 
pxt4_¥oc_roŸ
 = 
NULL
;

483 
	}
}

	@truncate.h

12 
ölöe
 
	$pxt4_åunˇã_Áûed_wrôe
(
öode
 *inode)

18 
	`down_wrôe
(&
	`PXT4_I
(
öode
)->
i_mm≠_£m
);

19 
	`åunˇã_öode_∑ges
(
öode
->
i_m≠pög
, inode->
i_size
);

20 
	`pxt4_åunˇã
(
öode
);

21 
	`up_wrôe
(&
	`PXT4_I
(
öode
)->
i_mm≠_£m
);

22 
	}
}

28 
ölöe
 
	$pxt4_blocks_f‹_åunˇã
(
öode
 *inode)

30 
pxt4_lblk_t
 
√eded
;

32 
√eded
 = 
öode
->
i_blocks
 >> (öode->
i_sb
->
s_blocksize_bôs
 - 9);

40 i‡(
√eded
 < 2)

41 
√eded
 = 2;

45 i‡(
√eded
 > 
PXT4_MAX_TRANS_DATA
)

46 
√eded
 = 
PXT4_MAX_TRANS_DATA
;

48  
	`PXT4_DATA_TRANS_BLOCKS
(
öode
->
i_sb
Ë+ 
√eded
;

49 
	}
}

	@verity.c

26 
	~<löux/quŸa›s.h
>

28 
	~"pxt4.h
"

29 
	~"pxt4_exã¡s.h
"

30 
	~"pxt4_jbd3.h
"

32 
ölöe
 
loff_t
 
	$pxt4_vîôy_mëad©a_pos
(c⁄° 
öode
 *inode)

34  
	`round_up
(
öode
->
i_size
, 65536);

35 
	}
}

41 
	$∑geˇche_ªad
(
öode
 *öode, *
buf
, 
size_t
 
cou¡
,

42 
loff_t
 
pos
)

44 
cou¡
) {

45 
size_t
 
n
 = 
	`mö_t
(size_t, 
cou¡
,

46 
PAGE_SIZE
 - 
	`off£t_ö_∑ge
(
pos
));

47 
∑ge
 *page;

48 *
addr
;

50 
∑ge
 = 
	`ªad_m≠pög_∑ge
(
öode
->
i_m≠pög
, 
pos
 >> 
PAGE_SHIFT
,

51 
NULL
);

52 i‡(
	`IS_ERR
(
∑ge
))

53  
	`PTR_ERR
(
∑ge
);

55 
addr
 = 
	`km≠_©omic
(
∑ge
);

56 
	`mem˝y
(
buf
, 
addr
 + 
	`off£t_ö_∑ge
(
pos
), 
n
);

57 
	`kunm≠_©omic
(
addr
);

59 
	`put_∑ge
(
∑ge
);

61 
buf
 +
n
;

62 
pos
 +
n
;

63 
cou¡
 -
n
;

66 
	}
}

72 
	$∑geˇche_wrôe
(
öode
 *öode, c⁄° *
buf
, 
size_t
 
cou¡
,

73 
loff_t
 
pos
)

75 i‡(
pos
 + 
cou¡
 > 
öode
->
i_sb
->
s_maxbyãs
)

76  -
EFBIG
;

78 
cou¡
) {

79 
size_t
 
n
 = 
	`mö_t
(size_t, 
cou¡
,

80 
PAGE_SIZE
 - 
	`off£t_ö_∑ge
(
pos
));

81 
∑ge
 *page;

82 *
fsd©a
;

83 *
addr
;

84 
ªs
;

86 
ªs
 = 
	`∑geˇche_wrôe_begö
(
NULL
, 
öode
->
i_m≠pög
, 
pos
, 
n
, 0,

87 &
∑ge
, &
fsd©a
);

88 i‡(
ªs
)

89  
ªs
;

91 
addr
 = 
	`km≠_©omic
(
∑ge
);

92 
	`mem˝y
(
addr
 + 
	`off£t_ö_∑ge
(
pos
), 
buf
, 
n
);

93 
	`kunm≠_©omic
(
addr
);

95 
ªs
 = 
	`∑geˇche_wrôe_íd
(
NULL
, 
öode
->
i_m≠pög
, 
pos
, 
n
,Ç,

96 
∑ge
, 
fsd©a
);

97 i‡(
ªs
 < 0)

98  
ªs
;

99 i‡(
ªs
 !
n
)

100  -
EIO
;

102 
buf
 +
n
;

103 
pos
 +
n
;

104 
cou¡
 -
n
;

107 
	}
}

109 
	$pxt4_begö_íabÀ_vîôy
(
fûe
 *
fûp
)

111 
öode
 *öodê
	`fûe_öode
(
fûp
);

112 c⁄° 
¸edôs
 = 2;

113 
h™dÀ_t
 *
h™dÀ
;

114 
îr
;

116 i‡(
	`pxt4_vîôy_ö_¥ogªss
(
öode
))

117  -
EBUSY
;

125 
îr
 = 
	`pxt4_öode_©èch_jöode
(
öode
);

126 i‡(
îr
)

127  
îr
;

129 
îr
 = 
	`dquŸ_öôülize
(
öode
);

130 i‡(
îr
)

131  
îr
;

133 
îr
 = 
	`pxt4_c⁄vît_ölöe_d©a
(
öode
);

134 i‡(
îr
)

135  
îr
;

137 i‡(!
	`pxt4_ã°_öode_Êag
(
öode
, 
PXT4_INODE_EXTENTS
)) {

138 
	`pxt4_w¨nög_öode
(
öode
,

140  -
EOPNOTSUPP
;

147 
îr
 = 
	`pxt4_åunˇã
(
öode
);

148 i‡(
îr
)

149  
îr
;

151 
h™dÀ
 = 
	`pxt4_jou∫Æ_°¨t
(
öode
, 
PXT4_HT_INODE
, 
¸edôs
);

152 i‡(
	`IS_ERR
(
h™dÀ
))

153  
	`PTR_ERR
(
h™dÀ
);

155 
îr
 = 
	`pxt4_‹ph™_add
(
h™dÀ
, 
öode
);

156 i‡(
îr
 == 0)

157 
	`pxt4_£t_öode_°©e
(
öode
, 
PXT4_STATE_VERITY_IN_PROGRESS
);

159 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

160  
îr
;

161 
	}
}

175 
	$pxt4_wrôe_vîôy_des¸ùt‹
(
öode
 *öode, c⁄° *
desc
,

176 
size_t
 
desc_size
, 
u64
 
mîkÀ_åì_size
)

178 c⁄° 
u64
 
desc_pos
 = 
	`round_up
(
	`pxt4_vîôy_mëad©a_pos
(
öode
) +

179 
mîkÀ_åì_size
, 
	`i_blocksize
(
öode
));

180 c⁄° 
u64
 
desc_íd
 = 
desc_pos
 + 
desc_size
;

181 c⁄° 
__À32
 
desc_size_disk
 = 
	`˝u_to_À32
(
desc_size
);

182 c⁄° 
u64
 
desc_size_pos
 = 
	`round_up
(
desc_íd
 + (
desc_size_disk
),

183 
	`i_blocksize
(
öode
)) -

184 (
desc_size_disk
);

185 
îr
;

187 
îr
 = 
	`∑geˇche_wrôe
(
öode
, 
desc
, 
desc_size
, 
desc_pos
);

188 i‡(
îr
)

189  
îr
;

191  
	`∑geˇche_wrôe
(
öode
, &
desc_size_disk
, (desc_size_disk),

192 
desc_size_pos
);

193 
	}
}

195 
	$pxt4_íd_íabÀ_vîôy
(
fûe
 *
fûp
, c⁄° *
desc
,

196 
size_t
 
desc_size
, 
u64
 
mîkÀ_åì_size
)

198 
öode
 *öodê
	`fûe_öode
(
fûp
);

199 c⁄° 
¸edôs
 = 2;

200 
h™dÀ_t
 *
h™dÀ
;

201 
pxt4_ûoc
 
ûoc
;

202 
îr
 = 0;

208 i‡(
desc
 =
NULL
)

209 
˛ónup
;

212 
îr
 = 
	`pxt4_wrôe_vîôy_des¸ùt‹
(
öode
, 
desc
, 
desc_size
,

213 
mîkÀ_åì_size
);

214 i‡(
îr
)

215 
˛ónup
;

223 
îr
 = 
	`fûem≠_wrôe_™d_waô
(
öode
->
i_m≠pög
);

224 i‡(
îr
)

225 
˛ónup
;

232 
h™dÀ
 = 
	`pxt4_jou∫Æ_°¨t
(
öode
, 
PXT4_HT_INODE
, 
¸edôs
);

233 i‡(
	`IS_ERR
(
h™dÀ
)) {

234 
îr
 = 
	`PTR_ERR
(
h™dÀ
);

235 
˛ónup
;

238 
îr
 = 
	`pxt4_‹ph™_dñ
(
h™dÀ
, 
öode
);

239 i‡(
îr
)

240 
°›_™d_˛ónup
;

242 
îr
 = 
	`pxt4_ª£rve_öode_wrôe
(
h™dÀ
, 
öode
, &
ûoc
);

243 i‡(
îr
)

244 
°›_™d_˛ónup
;

246 
	`pxt4_£t_öode_Êag
(
öode
, 
PXT4_INODE_VERITY
);

247 
	`pxt4_£t_öode_Êags
(
öode
);

248 
îr
 = 
	`pxt4_m¨k_ûoc_dúty
(
h™dÀ
, 
öode
, &
ûoc
);

249 i‡(
îr
)

250 
°›_™d_˛ónup
;

252 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

254 
	`pxt4_˛ór_öode_°©e
(
öode
, 
PXT4_STATE_VERITY_IN_PROGRESS
);

257 
°›_™d_˛ónup
:

258 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

259 
˛ónup
:

266 
	`åunˇã_öode_∑ges
(
öode
->
i_m≠pög
, inode->
i_size
);

267 
	`pxt4_åunˇã
(
öode
);

268 
	`pxt4_‹ph™_dñ
(
NULL
, 
öode
);

269 
	`pxt4_˛ór_öode_°©e
(
öode
, 
PXT4_STATE_VERITY_IN_PROGRESS
);

270  
îr
;

271 
	}
}

273 
	$pxt4_gë_vîôy_des¸ùt‹_loˇti⁄
(
öode
 *inode,

274 
size_t
 *
desc_size_ªt
,

275 
u64
 *
desc_pos_ªt
)

277 
pxt4_ext_∑th
 *
∑th
;

278 
pxt4_exã¡
 *
œ°_exã¡
;

279 
u32
 
íd_lblk
;

280 
u64
 
desc_size_pos
;

281 
__À32
 
desc_size_disk
;

282 
u32
 
desc_size
;

283 
u64
 
desc_pos
;

284 
îr
;

291 i‡(!
	`pxt4_ã°_öode_Êag
(
öode
, 
PXT4_INODE_EXTENTS
)) {

292 
	`PXT4_ERROR_INODE
(
öode
, "verity file doesn't useÉxtents");

293  -
EFSCORRUPTED
;

296 
∑th
 = 
	`pxt4_föd_exã¡
(
öode
, 
EXT_MAX_BLOCKS
 - 1, 
NULL
, 0);

297 i‡(
	`IS_ERR
(
∑th
))

298  
	`PTR_ERR
(
∑th
);

300 
œ°_exã¡
 = 
∑th
[∑th->
p_dïth
].
p_ext
;

301 i‡(!
œ°_exã¡
) {

302 
	`PXT4_ERROR_INODE
(
öode
, "verity file hasÇoÉxtents");

303 
	`pxt4_ext_dr›_ªfs
(
∑th
);

304 
	`k‰ì
(
∑th
);

305  -
EFSCORRUPTED
;

308 
íd_lblk
 = 
	`À32_to_˝u
(
œ°_exã¡
->
ì_block
) +

309 
	`pxt4_ext_gë_a˘uÆ_Àn
(
œ°_exã¡
);

310 
desc_size_pos
 = (
u64
)
íd_lblk
 << 
öode
->
i_blkbôs
;

311 
	`pxt4_ext_dr›_ªfs
(
∑th
);

312 
	`k‰ì
(
∑th
);

314 i‡(
desc_size_pos
 < (
desc_size_disk
))

315 
bad
;

316 
desc_size_pos
 -(
desc_size_disk
);

318 
îr
 = 
	`∑geˇche_ªad
(
öode
, &
desc_size_disk
, (desc_size_disk),

319 
desc_size_pos
);

320 i‡(
îr
)

321  
îr
;

322 
desc_size
 = 
	`À32_to_˝u
(
desc_size_disk
);

329 i‡(
desc_size
 > 
INT_MAX
 || desc_sizê> 
desc_size_pos
)

330 
bad
;

332 
desc_pos
 = 
	`round_down
(
desc_size_pos
 - 
desc_size
, 
	`i_blocksize
(
öode
));

333 i‡(
desc_pos
 < 
	`pxt4_vîôy_mëad©a_pos
(
öode
))

334 
bad
;

336 *
desc_size_ªt
 = 
desc_size
;

337 *
desc_pos_ªt
 = 
desc_pos
;

340 
bad
:

341 
	`PXT4_ERROR_INODE
(
öode
, "verity file corrupted; can't find descriptor");

342  -
EFSCORRUPTED
;

343 
	}
}

345 
	$pxt4_gë_vîôy_des¸ùt‹
(
öode
 *öode, *
buf
,

346 
size_t
 
buf_size
)

348 
size_t
 
desc_size
 = 0;

349 
u64
 
desc_pos
 = 0;

350 
îr
;

352 
îr
 = 
	`pxt4_gë_vîôy_des¸ùt‹_loˇti⁄
(
öode
, &
desc_size
, &
desc_pos
);

353 i‡(
îr
)

354  
îr
;

356 i‡(
buf_size
) {

357 i‡(
desc_size
 > 
buf_size
)

358  -
ERANGE
;

359 
îr
 = 
	`∑geˇche_ªad
(
öode
, 
buf
, 
desc_size
, 
desc_pos
);

360 i‡(
îr
)

361  
îr
;

363  
desc_size
;

364 
	}
}

366 
∑ge
 *
	$pxt4_ªad_mîkÀ_åì_∑ge
(
öode
 *inode,

367 
pgoff_t
 
ödex
)

369 
ödex
 +
	`pxt4_vîôy_mëad©a_pos
(
öode
Ë>> 
PAGE_SHIFT
;

371  
	`ªad_m≠pög_∑ge
(
öode
->
i_m≠pög
, 
ödex
, 
NULL
);

372 
	}
}

374 
	$pxt4_wrôe_mîkÀ_åì_block
(
öode
 *öode, c⁄° *
buf
,

375 
u64
 
ödex
, 
log_blocksize
)

377 
loff_t
 
pos
 = 
	`pxt4_vîôy_mëad©a_pos
(
öode
Ë+ (
ödex
 << 
log_blocksize
);

379  
	`∑geˇche_wrôe
(
öode
, 
buf
, 1 << 
log_blocksize
, 
pos
);

380 
	}
}

382 c⁄° 
fsvîôy_›î©i⁄s
 
	gpxt4_vîôy›s
 = {

383 .
begö_íabÀ_vîôy
 = 
pxt4_begö_íabÀ_vîôy
,

384 .
	gíd_íabÀ_vîôy
 = 
pxt4_íd_íabÀ_vîôy
,

385 .
	ggë_vîôy_des¸ùt‹
 = 
pxt4_gë_vîôy_des¸ùt‹
,

386 .
	gªad_mîkÀ_åì_∑ge
 = 
pxt4_ªad_mîkÀ_åì_∑ge
,

387 .
	gwrôe_mîkÀ_åì_block
 = 
pxt4_wrôe_mîkÀ_åì_block
,

	@xattr.c

54 
	~<löux/öô.h
>

55 
	~<löux/fs.h
>

56 
	~<löux/¶ab.h
>

57 
	~<löux/mbˇche.h
>

58 
	~<löux/quŸa›s.h
>

59 
	~<löux/ivîsi⁄.h
>

60 
	~"pxt4_jbd3.h
"

61 
	~"pxt4.h
"

62 
	~"x©å.h
"

63 
	~"a˛.h
"

65 #ifde‡
PXT4_XATTR_DEBUG


66 
	#ó_idebug
(
öode
, 
fmt
, ...) \

67 
	`¥ötk
(
KERN_DEBUG
 "öodê%s:%lu: " 
fmt
 "\n", \

68 
öode
->
i_sb
->
s_id
, inode->
i_öo
, ##
__VA_ARGS__
)

	)

69 
	#ó_bdebug
(
bh
, 
fmt
, ...) \

70 
	`¥ötk
(
KERN_DEBUG
 "block %pg:%lu: " 
fmt
 "\n", \

71 
bh
->
b_bdev
, ()bh->
b_blockƒ
, ##
__VA_ARGS__
)

	)

73 
	#ó_idebug
(
öode
, 
fmt
, ...Ë
	`no_¥ötk
(fmt, ##
__VA_ARGS__
)

	)

74 
	#ó_bdebug
(
bh
, 
fmt
, ...Ë
	`no_¥ötk
(fmt, ##
__VA_ARGS__
)

	)

77 
pxt4_x©å_block_ˇche_ö£π
(
mb_ˇche
 *,

78 
buf„r_hód
 *);

79 
buf„r_hód
 *

80 
pxt4_x©å_block_ˇche_föd
(
öode
 *, 
pxt4_x©å_hódî
 *,

81 
mb_ˇche_íåy
 **);

82 
__À32
 
pxt4_x©å_hash_íåy
(*
«me
, 
size_t
 
«me_Àn
, __À32 *
vÆue
,

83 
size_t
 
vÆue_cou¡
);

84 
pxt4_x©å_ªhash
(
pxt4_x©å_hódî
 *);

86 c⁄° 
x©å_h™dÀr
 * c⁄° 
	gpxt4_x©å_h™dÀr_m≠
[] = {

87 [
PXT4_XATTR_INDEX_USER
] = &
pxt4_x©å_u£r_h™dÀr
,

88 #ifde‡
CONFIG_PXT4_FS_POSIX_ACL


89 [
PXT4_XATTR_INDEX_POSIX_ACL_ACCESS
] = &
posix_a˛_ac˚ss_x©å_h™dÀr
,

90 [
PXT4_XATTR_INDEX_POSIX_ACL_DEFAULT
] = &
posix_a˛_deÁu…_x©å_h™dÀr
,

92 [
PXT4_XATTR_INDEX_TRUSTED
] = &
pxt4_x©å_åu°ed_h™dÀr
,

93 #ifde‡
CONFIG_PXT4_FS_SECURITY


94 [
PXT4_XATTR_INDEX_SECURITY
] = &
pxt4_x©å_£curôy_h™dÀr
,

98 c⁄° 
x©å_h™dÀr
 *
	gpxt4_x©å_h™dÀrs
[] = {

99 &
pxt4_x©å_u£r_h™dÀr
,

100 &
pxt4_x©å_åu°ed_h™dÀr
,

101 #ifde‡
CONFIG_PXT4_FS_POSIX_ACL


102 &
posix_a˛_ac˚ss_x©å_h™dÀr
,

103 &
posix_a˛_deÁu…_x©å_h™dÀr
,

105 #ifde‡
CONFIG_PXT4_FS_SECURITY


106 &
pxt4_x©å_£curôy_h™dÀr
,

108 
NULL


111 
	#EA_BLOCK_CACHE
(
öode
Ë(((
pxt4_sb_öfo
 *) \

112 
öode
->
i_sb
->
s_fs_öfo
)->
s_ó_block_ˇche
)

	)

114 
	#EA_INODE_CACHE
(
öode
Ë(((
pxt4_sb_öfo
 *) \

115 
öode
->
i_sb
->
s_fs_öfo
)->
s_ó_öode_ˇche
)

	)

118 
pxt4_ex∑nd_öode_¨øy
(
pxt4_x©å_öode_¨øy
 **
ó_öode_¨øy
,

119 
öode
 *inode);

121 #ifde‡
CONFIG_LOCKDEP


122 
	$pxt4_x©å_öode_£t_˛ass
(
öode
 *
ó_öode
)

124 
	`lockdï_£t_sub˛ass
(&
ó_öode
->
i_rw£m
, 1);

125 
	}
}

128 
__À32
 
	$pxt4_x©å_block_csum
(
öode
 *inode,

129 
£˘‹_t
 
block_ƒ
,

130 
pxt4_x©å_hódî
 *
hdr
)

132 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
öode
->
i_sb
);

133 
__u32
 
csum
;

134 
__À64
 
dsk_block_ƒ
 = 
	`˝u_to_À64
(
block_ƒ
);

135 
__u32
 
dummy_csum
 = 0;

136 
off£t
 = 
	`off£tof
(
pxt4_x©å_hódî
, 
h_checksum
);

138 
csum
 = 
	`pxt4_chksum
(
sbi
, sbi->
s_csum_£ed
, (
__u8
 *)&
dsk_block_ƒ
,

139 (
dsk_block_ƒ
));

140 
csum
 = 
	`pxt4_chksum
(
sbi
, csum, (
__u8
 *)
hdr
, 
off£t
);

141 
csum
 = 
	`pxt4_chksum
(
sbi
, csum, (
__u8
 *)&
dummy_csum
, (dummy_csum));

142 
off£t
 +(
dummy_csum
);

143 
csum
 = 
	`pxt4_chksum
(
sbi
, csum, (
__u8
 *)
hdr
 + 
off£t
,

144 
	`PXT4_BLOCK_SIZE
(
öode
->
i_sb
Ë- 
off£t
);

146  
	`˝u_to_À32
(
csum
);

147 
	}
}

149 
	$pxt4_x©å_block_csum_vîify
(
öode
 *inode,

150 
buf„r_hód
 *
bh
)

152 
pxt4_x©å_hódî
 *
hdr
 = 
	`BHDR
(
bh
);

153 
ªt
 = 1;

155 i‡(
	`pxt4_has_mëad©a_csum
(
öode
->
i_sb
)) {

156 
	`lock_buf„r
(
bh
);

157 
ªt
 = (
hdr
->
h_checksum
 =
	`pxt4_x©å_block_csum
(
öode
,

158 
bh
->
b_blockƒ
, 
hdr
));

159 
	`u∆ock_buf„r
(
bh
);

161  
ªt
;

162 
	}
}

164 
	$pxt4_x©å_block_csum_£t
(
öode
 *inode,

165 
buf„r_hód
 *
bh
)

167 i‡(
	`pxt4_has_mëad©a_csum
(
öode
->
i_sb
))

168 
	`BHDR
(
bh
)->
h_checksum
 = 
	`pxt4_x©å_block_csum
(
öode
,

169 
bh
->
b_blockƒ
, 
	`BHDR
(bh));

170 
	}
}

172 
ölöe
 c⁄° 
x©å_h™dÀr
 *

173 
	$pxt4_x©å_h™dÀr
(
«me_ödex
)

175 c⁄° 
x©å_h™dÀr
 *
h™dÀr
 = 
NULL
;

177 i‡(
«me_ödex
 > 0 &&Çame_ödex < 
	`ARRAY_SIZE
(
pxt4_x©å_h™dÀr_m≠
))

178 
h™dÀr
 = 
pxt4_x©å_h™dÀr_m≠
[
«me_ödex
];

179  
h™dÀr
;

180 
	}
}

183 
	$pxt4_x©å_check_íåõs
(
pxt4_x©å_íåy
 *
íåy
, *
íd
,

184 *
vÆue_°¨t
)

186 
pxt4_x©å_íåy
 *
e
 = 
íåy
;

189 !
	`IS_LAST_ENTRY
(
e
)) {

190 
pxt4_x©å_íåy
 *
√xt
 = 
	`PXT4_XATTR_NEXT
(
e
);

191 i‡((*)
√xt
 >
íd
)

192  -
EFSCORRUPTED
;

193 i‡(
	`°∫Àn
(
e
->
e_«me
,É->
e_«me_Àn
) !=É->e_name_len)

194  -
EFSCORRUPTED
;

195 
e
 = 
√xt
;

199 !
	`IS_LAST_ENTRY
(
íåy
)) {

200 
u32
 
size
 = 
	`À32_to_˝u
(
íåy
->
e_vÆue_size
);

202 i‡(
size
 > 
PXT4_XATTR_SIZE_MAX
)

203  -
EFSCORRUPTED
;

205 i‡(
size
 !0 && 
íåy
->
e_vÆue_öum
 == 0) {

206 
u16
 
offs
 = 
	`À16_to_˝u
(
íåy
->
e_vÆue_offs
);

207 *
vÆue
;

215 i‡(
offs
 > 
íd
 - 
vÆue_°¨t
)

216  -
EFSCORRUPTED
;

217 
vÆue
 = 
vÆue_°¨t
 + 
offs
;

218 i‡(
vÆue
 < (*)
e
 + (
u32
) ||

219 
size
 > 
íd
 - 
vÆue
 ||

220 
	`PXT4_XATTR_SIZE
(
size
Ë> 
íd
 - 
vÆue
)

221  -
EFSCORRUPTED
;

223 
íåy
 = 
	`PXT4_XATTR_NEXT
(entry);

227 
	}
}

229 
ölöe
 

230 
	$__pxt4_x©å_check_block
(
öode
 *öode, 
buf„r_hód
 *
bh
,

231 c⁄° *
fun˘i⁄
, 
löe
)

233 
îr‹
 = -
EFSCORRUPTED
;

235 i‡(
	`BHDR
(
bh
)->
h_magic
 !
	`˝u_to_À32
(
PXT4_XATTR_MAGIC
) ||

236 
	`BHDR
(
bh
)->
h_blocks
 !
	`˝u_to_À32
(1))

237 
îrout
;

238 i‡(
	`buf„r_vîifõd
(
bh
))

241 
îr‹
 = -
EFSBADCRC
;

242 i‡(!
	`pxt4_x©å_block_csum_vîify
(
öode
, 
bh
))

243 
îrout
;

244 
îr‹
 = 
	`pxt4_x©å_check_íåõs
(
	`BFIRST
(
bh
), bh->
b_d©a
 + bh->
b_size
,

245 
bh
->
b_d©a
);

246 
îrout
:

247 i‡(
îr‹
)

248 
	`__pxt4_îr‹_öode
(
öode
, 
fun˘i⁄
, 
löe
, 0,

250 (Ë
bh
->
b_blockƒ
);

252 
	`£t_buf„r_vîifõd
(
bh
);

253  
îr‹
;

254 
	}
}

256 
	#pxt4_x©å_check_block
(
öode
, 
bh
) \

257 
	`__pxt4_x©å_check_block
((
öode
), (
bh
), 
__func__
, 
__LINE__
)

	)

261 
	$__x©å_check_öode
(
öode
 *öode, 
pxt4_x©å_ibody_hódî
 *
hódî
,

262 *
íd
, c⁄° *
fun˘i⁄
, 
löe
)

264 
îr‹
 = -
EFSCORRUPTED
;

266 i‡(
íd
 - (*)
hódî
 < (*hódîË+ (
u32
) ||

267 (
hódî
->
h_magic
 !
	`˝u_to_À32
(
PXT4_XATTR_MAGIC
)))

268 
îrout
;

269 
îr‹
 = 
	`pxt4_x©å_check_íåõs
(
	`IFIRST
(
hódî
), 
íd
, IFIRST(header));

270 
îrout
:

271 i‡(
îr‹
)

272 
	`__pxt4_îr‹_öode
(
öode
, 
fun˘i⁄
, 
löe
, 0,

274  
îr‹
;

275 
	}
}

277 
	#x©å_check_öode
(
öode
, 
hódî
, 
íd
) \

278 
	`__x©å_check_öode
((
öode
), (
hódî
), (
íd
), 
__func__
, 
__LINE__
)

	)

281 
	$x©å_föd_íåy
(
öode
 *öode, 
pxt4_x©å_íåy
 **
≥¡ry
,

282 *
íd
, 
«me_ödex
, c⁄° *
«me
, 
s‹ãd
)

284 
pxt4_x©å_íåy
 *
íåy
, *
√xt
;

285 
size_t
 
«me_Àn
;

286 
cmp
 = 1;

288 i‡(
«me
 =
NULL
)

289  -
EINVAL
;

290 
«me_Àn
 = 
	`°æí
(
«me
);

291 
íåy
 = *
≥¡ry
; !
	`IS_LAST_ENTRY
”¡ry);É¡ry = 
√xt
) {

292 
√xt
 = 
	`PXT4_XATTR_NEXT
(
íåy
);

293 i‡((*Ë
√xt
 >
íd
) {

294 
	`PXT4_ERROR_INODE
(
öode
, "corrupted xattrÉntries");

295  -
EFSCORRUPTED
;

297 
cmp
 = 
«me_ödex
 - 
íåy
->
e_«me_ödex
;

298 i‡(!
cmp
)

299 
cmp
 = 
«me_Àn
 - 
íåy
->
e_«me_Àn
;

300 i‡(!
cmp
)

301 
cmp
 = 
	`memcmp
(
«me
, 
íåy
->
e_«me
, 
«me_Àn
);

302 i‡(
cmp
 <0 && (
s‹ãd
 || cmp == 0))

305 *
≥¡ry
 = 
íåy
;

306  
cmp
 ? -
ENODATA
 : 0;

307 
	}
}

309 
u32


310 
	$pxt4_x©å_öode_hash
(
pxt4_sb_öfo
 *
sbi
, c⁄° *
buf„r
, 
size_t
 
size
)

312  
	`pxt4_chksum
(
sbi
, sbi->
s_csum_£ed
, 
buf„r
, 
size
);

313 
	}
}

315 
u64
 
	$pxt4_x©å_öode_gë_ªf
(
öode
 *
ó_öode
)

317  ((
u64
)
ó_öode
->
i_˘ime
.
tv_£c
 << 32) |

318 (
u32
Ë
	`öode_≥ek_ivîsi⁄_øw
(
ó_öode
);

319 
	}
}

321 
	$pxt4_x©å_öode_£t_ªf
(
öode
 *
ó_öode
, 
u64
 
ªf_cou¡
)

323 
ó_öode
->
i_˘ime
.
tv_£c
 = (
u32
)(
ªf_cou¡
 >> 32);

324 
	`öode_£t_ivîsi⁄_øw
(
ó_öode
, 
ªf_cou¡
 & 0xffffffff);

325 
	}
}

327 
u32
 
	$pxt4_x©å_öode_gë_hash
(
öode
 *
ó_öode
)

329  (
u32
)
ó_öode
->
i_©ime
.
tv_£c
;

330 
	}
}

332 
	$pxt4_x©å_öode_£t_hash
(
öode
 *
ó_öode
, 
u32
 
hash
)

334 
ó_öode
->
i_©ime
.
tv_£c
 = 
hash
;

335 
	}
}

340 
	$pxt4_x©å_öode_ªad
(
öode
 *
ó_öode
, *
buf
, 
size_t
 
size
)

342 
blocksize
 = 1 << 
ó_öode
->
i_blkbôs
;

343 
bh_cou¡
 = (
size
 + 
blocksize
 - 1Ë>> 
ó_öode
->
i_blkbôs
;

344 
èû_size
 = (
size
 % 
blocksize
) ?: blocksize;

345 
buf„r_hód
 *
bhs_ölöe
[8];

346 
buf„r_hód
 **
bhs
 = 
bhs_ölöe
;

347 
i
, 
ªt
;

349 i‡(
bh_cou¡
 > 
	`ARRAY_SIZE
(
bhs_ölöe
)) {

350 
bhs
 = 
	`kmÆloc_¨øy
(
bh_cou¡
, (*bhs), 
GFP_NOFS
);

351 i‡(!
bhs
)

352  -
ENOMEM
;

355 
ªt
 = 
	`pxt4_bªad_b©ch
(
ó_öode
, 0 , 
bh_cou¡
,

356 
åue
 , 
bhs
);

357 i‡(
ªt
)

358 
‰ì_bhs
;

360 
i
 = 0; i < 
bh_cou¡
; i++) {

362 i‡(!
bhs
[
i
]) {

363 
ªt
 = -
EFSCORRUPTED
;

364 
put_bhs
;

366 
	`mem˝y
((*)
buf
 + 
blocksize
 * 
i
, 
bhs
[i]->
b_d©a
,

367 
i
 < 
bh_cou¡
 - 1 ? 
blocksize
 : 
èû_size
);

369 
ªt
 = 0;

370 
put_bhs
:

371 
i
 = 0; i < 
bh_cou¡
; i++)

372 
	`bªl£
(
bhs
[
i
]);

373 
‰ì_bhs
:

374 i‡(
bhs
 !
bhs_ölöe
)

375 
	`k‰ì
(
bhs
);

376  
ªt
;

377 
	}
}

379 
	#PXT4_XATTR_INODE_GET_PARENT
(
öode
Ë((
__u32
)(öode)->
i_mtime
.
tv_£c
)

	)

381 
	$pxt4_x©å_öode_igë
(
öode
 *
∑ª¡
, 
ó_öo
,

382 
u32
 
ó_öode_hash
, 
öode
 **
ó_öode
)

384 
öode
 *inode;

385 
îr
;

387 
öode
 = 
	`pxt4_igë
(
∑ª¡
->
i_sb
, 
ó_öo
, 
PXT4_IGET_NORMAL
);

388 i‡(
	`IS_ERR
(
öode
)) {

389 
îr
 = 
	`PTR_ERR
(
öode
);

390 
	`pxt4_îr‹
(
∑ª¡
->
i_sb
,

391 "îr‹ whûêªadög EA inodê%luÉº=%d", 
ó_öo
,

392 
îr
);

393  
îr
;

396 i‡(
	`is_bad_öode
(
öode
)) {

397 
	`pxt4_îr‹
(
∑ª¡
->
i_sb
,

399 
ó_öo
);

400 
îr
 = -
EIO
;

401 
îr‹
;

404 i‡(!(
	`PXT4_I
(
öode
)->
i_Êags
 & 
PXT4_EA_INODE_FL
)) {

405 
	`pxt4_îr‹
(
∑ª¡
->
i_sb
,

407 
ó_öo
);

408 
îr
 = -
EINVAL
;

409 
îr‹
;

412 
	`pxt4_x©å_öode_£t_˛ass
(
öode
);

419 i‡(
ó_öode_hash
 !
	`pxt4_x©å_öode_gë_hash
(
öode
) &&

420 
	`PXT4_XATTR_INODE_GET_PARENT
(
öode
Ë=
∑ª¡
->
i_öo
 &&

421 
öode
->
i_gíî©i⁄
 =
∑ª¡
->i_generation) {

422 
	`pxt4_£t_öode_°©e
(
öode
, 
PXT4_STATE_LUSTRE_EA_INODE
);

423 
	`pxt4_x©å_öode_£t_ªf
(
öode
, 1);

425 
	`öode_lock
(
öode
);

426 
öode
->
i_Êags
 |
S_NOQUOTA
;

427 
	`öode_u∆ock
(
öode
);

430 *
ó_öode
 = 
öode
;

432 
îr‹
:

433 
	`ùut
(
öode
);

434  
îr
;

435 
	}
}

438 
	$pxt4_x©å_öode_vîify_hashes
(
öode
 *
ó_öode
,

439 
pxt4_x©å_íåy
 *
íåy
, *
buf„r
,

440 
size_t
 
size
)

442 
u32
 
hash
;

445 
hash
 = 
	`pxt4_x©å_öode_hash
(
	`PXT4_SB
(
ó_öode
->
i_sb
), 
buf„r
, 
size
);

446 i‡(
hash
 !
	`pxt4_x©å_öode_gë_hash
(
ó_öode
))

447  -
EFSCORRUPTED
;

449 i‡(
íåy
) {

450 
__À32
 
e_hash
, 
tmp_d©a
;

453 
tmp_d©a
 = 
	`˝u_to_À32
(
hash
);

454 
e_hash
 = 
	`pxt4_x©å_hash_íåy
(
íåy
->
e_«me
,É¡ry->
e_«me_Àn
,

455 &
tmp_d©a
, 1);

456 i‡(
e_hash
 !
íåy
->e_hash)

457  -
EFSCORRUPTED
;

460 
	}
}

466 
	$pxt4_x©å_öode_gë
(
öode
 *öode, 
pxt4_x©å_íåy
 *
íåy
,

467 *
buf„r
, 
size_t
 
size
)

469 
mb_ˇche
 *
ó_öode_ˇche
 = 
	`EA_INODE_CACHE
(
öode
);

470 
öode
 *
ó_öode
;

471 
îr
;

473 
îr
 = 
	`pxt4_x©å_öode_igë
(
öode
, 
	`À32_to_˝u
(
íåy
->
e_vÆue_öum
),

474 
	`À32_to_˝u
(
íåy
->
e_hash
), &
ó_öode
);

475 i‡(
îr
) {

476 
ó_öode
 = 
NULL
;

477 
out
;

480 i‡(
	`i_size_ªad
(
ó_öode
Ë!
size
) {

481 
	`pxt4_w¨nög_öode
(
ó_öode
,

483 
	`i_size_ªad
(
ó_öode
), 
size
);

484 
îr
 = -
EFSCORRUPTED
;

485 
out
;

488 
îr
 = 
	`pxt4_x©å_öode_ªad
(
ó_öode
, 
buf„r
, 
size
);

489 i‡(
îr
)

490 
out
;

492 i‡(!
	`pxt4_ã°_öode_°©e
(
ó_öode
, 
PXT4_STATE_LUSTRE_EA_INODE
)) {

493 
îr
 = 
	`pxt4_x©å_öode_vîify_hashes
(
ó_öode
, 
íåy
, 
buf„r
,

494 
size
);

495 i‡(
îr
) {

496 
	`pxt4_w¨nög_öode
(
ó_öode
,

498 
out
;

501 i‡(
ó_öode_ˇche
)

502 
	`mb_ˇche_íåy_¸óã
(
ó_öode_ˇche
, 
GFP_NOFS
,

503 
	`pxt4_x©å_öode_gë_hash
(
ó_öode
),

504 
ó_öode
->
i_öo
, 
åue
 );

506 
out
:

507 
	`ùut
(
ó_öode
);

508  
îr
;

509 
	}
}

512 
	$pxt4_x©å_block_gë
(
öode
 *öode, 
«me_ödex
, c⁄° *
«me
,

513 *
buf„r
, 
size_t
 
buf„r_size
)

515 
buf„r_hód
 *
bh
 = 
NULL
;

516 
pxt4_x©å_íåy
 *
íåy
;

517 
size_t
 
size
;

518 *
íd
;

519 
îr‹
;

520 
mb_ˇche
 *
ó_block_ˇche
 = 
	`EA_BLOCK_CACHE
(
öode
);

522 
	`ó_idebug
(
öode
, "name=%d.%s, buffer=%p, buffer_size=%ld",

523 
«me_ödex
, 
«me
, 
buf„r
, ()
buf„r_size
);

525 i‡(!
	`PXT4_I
(
öode
)->
i_fûe_a˛
)

526  -
ENODATA
;

527 
	`ó_idebug
(
öode
, "reading block %llu",

528 ()
	`PXT4_I
(
öode
)->
i_fûe_a˛
);

529 
bh
 = 
	`pxt4_sb_bªad
(
öode
->
i_sb
, 
	`PXT4_I
(öode)->
i_fûe_a˛
, 
REQ_PRIO
);

530 i‡(
	`IS_ERR
(
bh
))

531  
	`PTR_ERR
(
bh
);

532 
	`ó_bdebug
(
bh
, "b_count=%d,Ñefcount=%d",

533 
	`©omic_ªad
(&(
bh
->
b_cou¡
)), 
	`À32_to_˝u
(
	`BHDR
(bh)->
h_ªfcou¡
));

534 
îr‹
 = 
	`pxt4_x©å_check_block
(
öode
, 
bh
);

535 i‡(
îr‹
)

536 
˛ónup
;

537 
	`pxt4_x©å_block_ˇche_ö£π
(
ó_block_ˇche
, 
bh
);

538 
íåy
 = 
	`BFIRST
(
bh
);

539 
íd
 = 
bh
->
b_d©a
 + bh->
b_size
;

540 
îr‹
 = 
	`x©å_föd_íåy
(
öode
, &
íåy
, 
íd
, 
«me_ödex
, 
«me
, 1);

541 i‡(
îr‹
)

542 
˛ónup
;

543 
size
 = 
	`À32_to_˝u
(
íåy
->
e_vÆue_size
);

544 
îr‹
 = -
ERANGE
;

545 i‡(
	`u∆ikñy
(
size
 > 
PXT4_XATTR_SIZE_MAX
))

546 
˛ónup
;

547 i‡(
buf„r
) {

548 i‡(
size
 > 
buf„r_size
)

549 
˛ónup
;

550 i‡(
íåy
->
e_vÆue_öum
) {

551 
îr‹
 = 
	`pxt4_x©å_öode_gë
(
öode
, 
íåy
, 
buf„r
,

552 
size
);

553 i‡(
îr‹
)

554 
˛ónup
;

556 
u16
 
off£t
 = 
	`À16_to_˝u
(
íåy
->
e_vÆue_offs
);

557 *
p
 = 
bh
->
b_d©a
 + 
off£t
;

559 i‡(
	`u∆ikñy
(
p
 + 
size
 > 
íd
))

560 
˛ónup
;

561 
	`mem˝y
(
buf„r
, 
p
, 
size
);

564 
îr‹
 = 
size
;

566 
˛ónup
:

567 
	`bªl£
(
bh
);

568  
îr‹
;

569 
	}
}

572 
	$pxt4_x©å_ibody_gë
(
öode
 *öode, 
«me_ödex
, c⁄° *
«me
,

573 *
buf„r
, 
size_t
 
buf„r_size
)

575 
pxt4_x©å_ibody_hódî
 *
hódî
;

576 
pxt4_x©å_íåy
 *
íåy
;

577 
pxt4_öode
 *
øw_öode
;

578 
pxt4_ûoc
 
ûoc
;

579 
size_t
 
size
;

580 *
íd
;

581 
îr‹
;

583 i‡(!
	`pxt4_ã°_öode_°©e
(
öode
, 
PXT4_STATE_XATTR
))

584  -
ENODATA
;

585 
îr‹
 = 
	`pxt4_gë_öode_loc
(
öode
, &
ûoc
);

586 i‡(
îr‹
)

587  
îr‹
;

588 
øw_öode
 = 
	`pxt4_øw_öode
(&
ûoc
);

589 
hódî
 = 
	`IHDR
(
öode
, 
øw_öode
);

590 
íd
 = (*)
øw_öode
 + 
	`PXT4_SB
(
öode
->
i_sb
)->
s_öode_size
;

591 
îr‹
 = 
	`x©å_check_öode
(
öode
, 
hódî
, 
íd
);

592 i‡(
îr‹
)

593 
˛ónup
;

594 
íåy
 = 
	`IFIRST
(
hódî
);

595 
îr‹
 = 
	`x©å_föd_íåy
(
öode
, &
íåy
, 
íd
, 
«me_ödex
, 
«me
, 0);

596 i‡(
îr‹
)

597 
˛ónup
;

598 
size
 = 
	`À32_to_˝u
(
íåy
->
e_vÆue_size
);

599 
îr‹
 = -
ERANGE
;

600 i‡(
	`u∆ikñy
(
size
 > 
PXT4_XATTR_SIZE_MAX
))

601 
˛ónup
;

602 i‡(
buf„r
) {

603 i‡(
size
 > 
buf„r_size
)

604 
˛ónup
;

605 i‡(
íåy
->
e_vÆue_öum
) {

606 
îr‹
 = 
	`pxt4_x©å_öode_gë
(
öode
, 
íåy
, 
buf„r
,

607 
size
);

608 i‡(
îr‹
)

609 
˛ónup
;

611 
u16
 
off£t
 = 
	`À16_to_˝u
(
íåy
->
e_vÆue_offs
);

612 *
p
 = (*)
	`IFIRST
(
hódî
Ë+ 
off£t
;

614 i‡(
	`u∆ikñy
(
p
 + 
size
 > 
íd
))

615 
˛ónup
;

616 
	`mem˝y
(
buf„r
, 
p
, 
size
);

619 
îr‹
 = 
size
;

621 
˛ónup
:

622 
	`bªl£
(
ûoc
.
bh
);

623  
îr‹
;

624 
	}
}

637 
	$pxt4_x©å_gë
(
öode
 *öode, 
«me_ödex
, c⁄° *
«me
,

638 *
buf„r
, 
size_t
 
buf„r_size
)

640 
îr‹
;

642 i‡(
	`u∆ikñy
(
	`pxt4_f‹˚d_shutdown
(
	`PXT4_SB
(
öode
->
i_sb
))))

643  -
EIO
;

645 i‡(
	`°æí
(
«me
) > 255)

646  -
ERANGE
;

648 
	`down_ªad
(&
	`PXT4_I
(
öode
)->
x©å_£m
);

649 
îr‹
 = 
	`pxt4_x©å_ibody_gë
(
öode
, 
«me_ödex
, 
«me
, 
buf„r
,

650 
buf„r_size
);

651 i‡(
îr‹
 =-
ENODATA
)

652 
îr‹
 = 
	`pxt4_x©å_block_gë
(
öode
, 
«me_ödex
, 
«me
, 
buf„r
,

653 
buf„r_size
);

654 
	`up_ªad
(&
	`PXT4_I
(
öode
)->
x©å_£m
);

655  
îr‹
;

656 
	}
}

659 
	$pxt4_x©å_li°_íåõs
(
díåy
 *díåy, 
pxt4_x©å_íåy
 *
íåy
,

660 *
buf„r
, 
size_t
 
buf„r_size
)

662 
size_t
 
ª°
 = 
buf„r_size
;

664 ; !
	`IS_LAST_ENTRY
(
íåy
);É¡ry = 
	`PXT4_XATTR_NEXT
(entry)) {

665 c⁄° 
x©å_h™dÀr
 *
h™dÀr
 =

666 
	`pxt4_x©å_h™dÀr
(
íåy
->
e_«me_ödex
);

668 i‡(
h™dÀr
 && (!h™dÀr->
li°
 || h™dÀr->
	`li°
(
díåy
))) {

669 c⁄° *
¥efix
 = 
h™dÀr
->¥efix ?: h™dÀr->
«me
;

670 
size_t
 
¥efix_Àn
 = 
	`°æí
(
¥efix
);

671 
size_t
 
size
 = 
¥efix_Àn
 + 
íåy
->
e_«me_Àn
 + 1;

673 i‡(
buf„r
) {

674 i‡(
size
 > 
ª°
)

675  -
ERANGE
;

676 
	`mem˝y
(
buf„r
, 
¥efix
, 
¥efix_Àn
);

677 
buf„r
 +
¥efix_Àn
;

678 
	`mem˝y
(
buf„r
, 
íåy
->
e_«me
,É¡ry->
e_«me_Àn
);

679 
buf„r
 +
íåy
->
e_«me_Àn
;

680 *
buf„r
++ = 0;

682 
ª°
 -
size
;

685  
buf„r_size
 - 
ª°
;

686 
	}
}

689 
	$pxt4_x©å_block_li°
(
díåy
 *díåy, *
buf„r
, 
size_t
 
buf„r_size
)

691 
öode
 *öodê
	`d_öode
(
díåy
);

692 
buf„r_hód
 *
bh
 = 
NULL
;

693 
îr‹
;

695 
	`ó_idebug
(
öode
, "buffer=%p, buffer_size=%ld",

696 
buf„r
, ()
buf„r_size
);

698 i‡(!
	`PXT4_I
(
öode
)->
i_fûe_a˛
)

700 
	`ó_idebug
(
öode
, "reading block %llu",

701 ()
	`PXT4_I
(
öode
)->
i_fûe_a˛
);

702 
bh
 = 
	`pxt4_sb_bªad
(
öode
->
i_sb
, 
	`PXT4_I
(öode)->
i_fûe_a˛
, 
REQ_PRIO
);

703 i‡(
	`IS_ERR
(
bh
))

704  
	`PTR_ERR
(
bh
);

705 
	`ó_bdebug
(
bh
, "b_count=%d,Ñefcount=%d",

706 
	`©omic_ªad
(&(
bh
->
b_cou¡
)), 
	`À32_to_˝u
(
	`BHDR
(bh)->
h_ªfcou¡
));

707 
îr‹
 = 
	`pxt4_x©å_check_block
(
öode
, 
bh
);

708 i‡(
îr‹
)

709 
˛ónup
;

710 
	`pxt4_x©å_block_ˇche_ö£π
(
	`EA_BLOCK_CACHE
(
öode
), 
bh
);

711 
îr‹
 = 
	`pxt4_x©å_li°_íåõs
(
díåy
, 
	`BFIRST
(
bh
), 
buf„r
,

712 
buf„r_size
);

713 
˛ónup
:

714 
	`bªl£
(
bh
);

715  
îr‹
;

716 
	}
}

719 
	$pxt4_x©å_ibody_li°
(
díåy
 *díåy, *
buf„r
, 
size_t
 
buf„r_size
)

721 
öode
 *öodê
	`d_öode
(
díåy
);

722 
pxt4_x©å_ibody_hódî
 *
hódî
;

723 
pxt4_öode
 *
øw_öode
;

724 
pxt4_ûoc
 
ûoc
;

725 *
íd
;

726 
îr‹
;

728 i‡(!
	`pxt4_ã°_öode_°©e
(
öode
, 
PXT4_STATE_XATTR
))

730 
îr‹
 = 
	`pxt4_gë_öode_loc
(
öode
, &
ûoc
);

731 i‡(
îr‹
)

732  
îr‹
;

733 
øw_öode
 = 
	`pxt4_øw_öode
(&
ûoc
);

734 
hódî
 = 
	`IHDR
(
öode
, 
øw_öode
);

735 
íd
 = (*)
øw_öode
 + 
	`PXT4_SB
(
öode
->
i_sb
)->
s_öode_size
;

736 
îr‹
 = 
	`x©å_check_öode
(
öode
, 
hódî
, 
íd
);

737 i‡(
îr‹
)

738 
˛ónup
;

739 
îr‹
 = 
	`pxt4_x©å_li°_íåõs
(
díåy
, 
	`IFIRST
(
hódî
),

740 
buf„r
, 
buf„r_size
);

742 
˛ónup
:

743 
	`bªl£
(
ûoc
.
bh
);

744  
îr‹
;

745 
	}
}

759 
ssize_t


760 
	$pxt4_li°x©å
(
díåy
 *díåy, *
buf„r
, 
size_t
 
buf„r_size
)

762 
ªt
, 
ªt2
;

764 
	`down_ªad
(&
	`PXT4_I
(
	`d_öode
(
díåy
))->
x©å_£m
);

765 
ªt
 = 
ªt2
 = 
	`pxt4_x©å_ibody_li°
(
díåy
, 
buf„r
, 
buf„r_size
);

766 i‡(
ªt
 < 0)

767 
îrout
;

768 i‡(
buf„r
) {

769 
buf„r
 +
ªt
;

770 
buf„r_size
 -
ªt
;

772 
ªt
 = 
	`pxt4_x©å_block_li°
(
díåy
, 
buf„r
, 
buf„r_size
);

773 i‡(
ªt
 < 0)

774 
îrout
;

775 
ªt
 +
ªt2
;

776 
îrout
:

777 
	`up_ªad
(&
	`PXT4_I
(
	`d_öode
(
díåy
))->
x©å_£m
);

778  
ªt
;

779 
	}
}

785 
	$pxt4_x©å_upd©e_su≥r_block
(
h™dÀ_t
 *
h™dÀ
,

786 
su≥r_block
 *
sb
)

788 i‡(
	`pxt4_has_„©uª_x©å
(
sb
))

791 
	`BUFFER_TRACE
(
	`PXT4_SB
(
sb
)->
s_sbh
, "get_write_access");

792 i‡(
	`pxt4_jou∫Æ_gë_wrôe_ac˚ss
(
h™dÀ
, 
	`PXT4_SB
(
sb
)->
s_sbh
) == 0) {

793 
	`pxt4_£t_„©uª_x©å
(
sb
);

794 
	`pxt4_h™dÀ_dúty_su≥r
(
h™dÀ
, 
sb
);

796 
	}
}

798 
	$pxt4_gë_öode_ußge
(
öode
 *öode, 
qsize_t
 *
ußge
)

800 
pxt4_ûoc
 
ûoc
 = { .
bh
 = 
NULL
 };

801 
buf„r_hód
 *
bh
 = 
NULL
;

802 
pxt4_öode
 *
øw_öode
;

803 
pxt4_x©å_ibody_hódî
 *
hódî
;

804 
pxt4_x©å_íåy
 *
íåy
;

805 
qsize_t
 
ó_öode_ªfs
 = 0;

806 *
íd
;

807 
ªt
;

809 
	`lockdï_as£π_hñd_ªad
(&
	`PXT4_I
(
öode
)->
x©å_£m
);

811 i‡(
	`pxt4_ã°_öode_°©e
(
öode
, 
PXT4_STATE_XATTR
)) {

812 
ªt
 = 
	`pxt4_gë_öode_loc
(
öode
, &
ûoc
);

813 i‡(
ªt
)

814 
out
;

815 
øw_öode
 = 
	`pxt4_øw_öode
(&
ûoc
);

816 
hódî
 = 
	`IHDR
(
öode
, 
øw_öode
);

817 
íd
 = (*)
øw_öode
 + 
	`PXT4_SB
(
öode
->
i_sb
)->
s_öode_size
;

818 
ªt
 = 
	`x©å_check_öode
(
öode
, 
hódî
, 
íd
);

819 i‡(
ªt
)

820 
out
;

822 
íåy
 = 
	`IFIRST
(
hódî
); !
	`IS_LAST_ENTRY
(entry);

823 
íåy
 = 
	`PXT4_XATTR_NEXT
(entry))

824 i‡(
íåy
->
e_vÆue_öum
)

825 
ó_öode_ªfs
++;

828 i‡(
	`PXT4_I
(
öode
)->
i_fûe_a˛
) {

829 
bh
 = 
	`pxt4_sb_bªad
(
öode
->
i_sb
, 
	`PXT4_I
(öode)->
i_fûe_a˛
, 
REQ_PRIO
);

830 i‡(
	`IS_ERR
(
bh
)) {

831 
ªt
 = 
	`PTR_ERR
(
bh
);

832 
bh
 = 
NULL
;

833 
out
;

836 
ªt
 = 
	`pxt4_x©å_check_block
(
öode
, 
bh
);

837 i‡(
ªt
)

838 
out
;

840 
íåy
 = 
	`BFIRST
(
bh
); !
	`IS_LAST_ENTRY
(entry);

841 
íåy
 = 
	`PXT4_XATTR_NEXT
(entry))

842 i‡(
íåy
->
e_vÆue_öum
)

843 
ó_öode_ªfs
++;

845 *
ußge
 = 
ó_öode_ªfs
 + 1;

846 
ªt
 = 0;

847 
out
:

848 
	`bªl£
(
ûoc
.
bh
);

849 
	`bªl£
(
bh
);

850  
ªt
;

851 
	}
}

853 
ölöe
 
size_t
 
	$round_up_˛u°î
(
öode
 *öode, 
size_t
 
Àngth
)

855 
su≥r_block
 *
sb
 = 
öode
->
i_sb
;

856 
size_t
 
˛u°î_size
 = 1 << (
	`PXT4_SB
(
sb
)->
s_˛u°î_bôs
 +

857 
öode
->
i_blkbôs
);

858 
size_t
 
mask
 = ~(
˛u°î_size
 - 1);

860  (
Àngth
 + 
˛u°î_size
 - 1Ë& 
mask
;

861 
	}
}

863 
	$pxt4_x©å_öode_Æloc_quŸa
(
öode
 *öode, 
size_t
 
Àn
)

865 
îr
;

867 
îr
 = 
	`dquŸ_Æloc_öode
(
öode
);

868 i‡(
îr
)

869  
îr
;

870 
îr
 = 
	`dquŸ_Æloc_•a˚_nodúty
(
öode
, 
	`round_up_˛u°î
(öode, 
Àn
));

871 i‡(
îr
)

872 
	`dquŸ_‰ì_öode
(
öode
);

873  
îr
;

874 
	}
}

876 
	$pxt4_x©å_öode_‰ì_quŸa
(
öode
 *
∑ª¡
,

877 
öode
 *
ó_öode
,

878 
size_t
 
Àn
)

880 i‡(
ó_öode
 &&

881 
	`pxt4_ã°_öode_°©e
(
ó_öode
, 
PXT4_STATE_LUSTRE_EA_INODE
))

883 
	`dquŸ_‰ì_•a˚_nodúty
(
∑ª¡
, 
	`round_up_˛u°î
’¨ít, 
Àn
));

884 
	`dquŸ_‰ì_öode
(
∑ª¡
);

885 
	}
}

887 
	$__pxt4_x©å_£t_¸edôs
(
su≥r_block
 *
sb
, 
öode
 *inode,

888 
buf„r_hód
 *
block_bh
, 
size_t
 
vÆue_Àn
,

889 
boﬁ
 
is_¸óã
)

891 
¸edôs
;

892 
blocks
;

907 
¸edôs
 = 7;

910 
¸edôs
 +
	`PXT4_MAXQUOTAS_TRANS_BLOCKS
(
sb
);

916 i‡(
öode
 && 
	`pxt4_has_ölöe_d©a
(inode))

917 
¸edôs
 +
	`pxt4_wrôïage_å™s_blocks
(
öode
) + 1;

920 i‡(!
	`pxt4_has_„©uª_ó_öode
(
sb
))

921  
¸edôs
;

924 
¸edôs
 += 4;

927 
blocks
 = (
vÆue_Àn
 + 
sb
->
s_blocksize
 - 1Ë>> sb->
s_blocksize_bôs
;

930 
blocks
 += 1;

933 
¸edôs
 +
blocks
 * 2;

936 
¸edôs
 +
blocks
;

938 i‡(!
is_¸óã
) {

942 
¸edôs
 += 4;

945 
blocks
 = 
XATTR_SIZE_MAX
 >> 
sb
->
s_blocksize_bôs
;

950 
blocks
 += 1;

953 
¸edôs
 +
blocks
 * 2;

959 i‡(
block_bh
) {

960 
pxt4_x©å_íåy
 *
íåy
 = 
	`BFIRST
(
block_bh
);

962 ; !
	`IS_LAST_ENTRY
(
íåy
);É¡ry = 
	`PXT4_XATTR_NEXT
(entry))

963 i‡(
íåy
->
e_vÆue_öum
)

965 
¸edôs
 += 1;

967  
¸edôs
;

968 
	}
}

970 
	$pxt4_x©å_ísuª_¸edôs
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *inode,

971 
¸edôs
, 
buf„r_hód
 *
bh
,

972 
boﬁ
 
dúty
, boﬁ 
block_csum
)

974 
îr‹
;

976 i‡(!
	`pxt4_h™dÀ_vÆid
(
h™dÀ
))

979 i‡(
h™dÀ
->
h_buf„r_¸edôs
 >
¸edôs
)

982 
îr‹
 = 
	`pxt4_jou∫Æ_exãnd
(
h™dÀ
, 
¸edôs
 - h™dÀ->
h_buf„r_¸edôs
);

983 i‡(!
îr‹
)

985 i‡(
îr‹
 < 0) {

986 
	`pxt4_w¨nög
(
öode
->
i_sb
, "Exãnd jou∫Æ (îr‹ %d)", 
îr‹
);

987  
îr‹
;

990 i‡(
bh
 && 
dúty
) {

991 i‡(
block_csum
)

992 
	`pxt4_x©å_block_csum_£t
(
öode
, 
bh
);

993 
îr‹
 = 
	`pxt4_h™dÀ_dúty_mëad©a
(
h™dÀ
, 
NULL
, 
bh
);

994 i‡(
îr‹
) {

995 
	`pxt4_w¨nög
(
öode
->
i_sb
, "Handle metadata (error %d)",

996 
îr‹
);

997  
îr‹
;

1001 
îr‹
 = 
	`pxt4_jou∫Æ_ª°¨t
(
h™dÀ
, 
¸edôs
);

1002 i‡(
îr‹
) {

1003 
	`pxt4_w¨nög
(
öode
->
i_sb
, "Re°¨àjou∫Æ (îr‹ %d)", 
îr‹
);

1004  
îr‹
;

1007 i‡(
bh
) {

1008 
îr‹
 = 
	`pxt4_jou∫Æ_gë_wrôe_ac˚ss
(
h™dÀ
, 
bh
);

1009 i‡(
îr‹
) {

1010 
	`pxt4_w¨nög
(
öode
->
i_sb
,

1012 
îr‹
);

1013  
îr‹
;

1017 
	}
}

1019 
	$pxt4_x©å_öode_upd©e_ªf
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *
ó_öode
,

1020 
ªf_ch™ge
)

1022 
mb_ˇche
 *
ó_öode_ˇche
 = 
	`EA_INODE_CACHE
(
ó_öode
);

1023 
pxt4_ûoc
 
ûoc
;

1024 
s64
 
ªf_cou¡
;

1025 
u32
 
hash
;

1026 
ªt
;

1028 
	`öode_lock
(
ó_öode
);

1030 
ªt
 = 
	`pxt4_ª£rve_öode_wrôe
(
h™dÀ
, 
ó_öode
, &
ûoc
);

1031 i‡(
ªt
)

1032 
out
;

1034 
ªf_cou¡
 = 
	`pxt4_x©å_öode_gë_ªf
(
ó_öode
);

1035 
ªf_cou¡
 +
ªf_ch™ge
;

1036 
	`pxt4_x©å_öode_£t_ªf
(
ó_öode
, 
ªf_cou¡
);

1038 i‡(
ªf_ch™ge
 > 0) {

1039 
	`WARN_ONCE
(
ªf_cou¡
 <= 0, "EA inode %luÑef_count=%lld",

1040 
ó_öode
->
i_öo
, 
ªf_cou¡
);

1042 i‡(
ªf_cou¡
 == 1) {

1043 
	`WARN_ONCE
(
ó_öode
->
i_∆ök
, "EA inode %lu i_nlink=%u",

1044 
ó_öode
->
i_öo
,Éa_öode->
i_∆ök
);

1046 
	`£t_∆ök
(
ó_öode
, 1);

1047 
	`pxt4_‹ph™_dñ
(
h™dÀ
, 
ó_öode
);

1049 i‡(
ó_öode_ˇche
) {

1050 
hash
 = 
	`pxt4_x©å_öode_gë_hash
(
ó_öode
);

1051 
	`mb_ˇche_íåy_¸óã
(
ó_öode_ˇche
,

1052 
GFP_NOFS
, 
hash
,

1053 
ó_öode
->
i_öo
,

1054 
åue
 );

1058 
	`WARN_ONCE
(
ªf_cou¡
 < 0, "EA inode %luÑef_count=%lld",

1059 
ó_öode
->
i_öo
, 
ªf_cou¡
);

1061 i‡(
ªf_cou¡
 == 0) {

1062 
	`WARN_ONCE
(
ó_öode
->
i_∆ök
 != 1,

1064 
ó_öode
->
i_öo
,Éa_öode->
i_∆ök
);

1066 
	`˛ór_∆ök
(
ó_öode
);

1067 
	`pxt4_‹ph™_add
(
h™dÀ
, 
ó_öode
);

1069 i‡(
ó_öode_ˇche
) {

1070 
hash
 = 
	`pxt4_x©å_öode_gë_hash
(
ó_öode
);

1071 
	`mb_ˇche_íåy_dñëe
(
ó_öode_ˇche
, 
hash
,

1072 
ó_öode
->
i_öo
);

1077 
ªt
 = 
	`pxt4_m¨k_ûoc_dúty
(
h™dÀ
, 
ó_öode
, &
ûoc
);

1078 i‡(
ªt
)

1079 
	`pxt4_w¨nög_öode
(
ó_öode
,

1080 "pxt4_m¨k_ûoc_dúty(ËÁûedÑë=%d", 
ªt
);

1081 
out
:

1082 
	`öode_u∆ock
(
ó_öode
);

1083  
ªt
;

1084 
	}
}

1086 
	$pxt4_x©å_öode_öc_ªf
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *
ó_öode
)

1088  
	`pxt4_x©å_öode_upd©e_ªf
(
h™dÀ
, 
ó_öode
, 1);

1089 
	}
}

1091 
	$pxt4_x©å_öode_dec_ªf
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *
ó_öode
)

1093  
	`pxt4_x©å_öode_upd©e_ªf
(
h™dÀ
, 
ó_öode
, -1);

1094 
	}
}

1096 
	$pxt4_x©å_öode_öc_ªf_Æl
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *
∑ª¡
,

1097 
pxt4_x©å_íåy
 *
fú°
)

1099 
öode
 *
ó_öode
;

1100 
pxt4_x©å_íåy
 *
íåy
;

1101 
pxt4_x©å_íåy
 *
Áûed_íåy
;

1102 
ó_öo
;

1103 
îr
, 
ßved_îr
;

1105 
íåy
 = 
fú°
; !
	`IS_LAST_ENTRY
(entry);

1106 
íåy
 = 
	`PXT4_XATTR_NEXT
(entry)) {

1107 i‡(!
íåy
->
e_vÆue_öum
)

1109 
ó_öo
 = 
	`À32_to_˝u
(
íåy
->
e_vÆue_öum
);

1110 
îr
 = 
	`pxt4_x©å_öode_igë
(
∑ª¡
, 
ó_öo
,

1111 
	`À32_to_˝u
(
íåy
->
e_hash
),

1112 &
ó_öode
);

1113 i‡(
îr
)

1114 
˛ónup
;

1115 
îr
 = 
	`pxt4_x©å_öode_öc_ªf
(
h™dÀ
, 
ó_öode
);

1116 i‡(
îr
) {

1117 
	`pxt4_w¨nög_öode
(
ó_öode
, "ö¯ª‡îr‹ %d", 
îr
);

1118 
	`ùut
(
ó_öode
);

1119 
˛ónup
;

1121 
	`ùut
(
ó_öode
);

1125 
˛ónup
:

1126 
ßved_îr
 = 
îr
;

1127 
Áûed_íåy
 = 
íåy
;

1129 
íåy
 = 
fú°
;É¡ry !
Áûed_íåy
;

1130 
íåy
 = 
	`PXT4_XATTR_NEXT
(entry)) {

1131 i‡(!
íåy
->
e_vÆue_öum
)

1133 
ó_öo
 = 
	`À32_to_˝u
(
íåy
->
e_vÆue_öum
);

1134 
îr
 = 
	`pxt4_x©å_öode_igë
(
∑ª¡
, 
ó_öo
,

1135 
	`À32_to_˝u
(
íåy
->
e_hash
),

1136 &
ó_öode
);

1137 i‡(
îr
) {

1138 
	`pxt4_w¨nög
(
∑ª¡
->
i_sb
,

1139 "˛ónu∞ó_öÿ%u igëÉº‹ %d", 
ó_öo
,

1140 
îr
);

1143 
îr
 = 
	`pxt4_x©å_öode_dec_ªf
(
h™dÀ
, 
ó_öode
);

1144 i‡(
îr
)

1145 
	`pxt4_w¨nög_öode
(
ó_öode
, "cleanup decÑefÉrror %d",

1146 
îr
);

1147 
	`ùut
(
ó_öode
);

1149  
ßved_îr
;

1150 
	}
}

1153 
	$pxt4_x©å_öode_dec_ªf_Æl
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *
∑ª¡
,

1154 
buf„r_hód
 *
bh
,

1155 
pxt4_x©å_íåy
 *
fú°
, 
boﬁ
 
block_csum
,

1156 
pxt4_x©å_öode_¨øy
 **
ó_öode_¨øy
,

1157 
exåa_¸edôs
, 
boﬁ
 
skù_quŸa
)

1159 
öode
 *
ó_öode
;

1160 
pxt4_x©å_íåy
 *
íåy
;

1161 
boﬁ
 
dúty
 = 
Ál£
;

1162 
ó_öo
;

1163 
îr
;

1164 
¸edôs
;

1167 
¸edôs
 = 2 + 
exåa_¸edôs
;

1169 
íåy
 = 
fú°
; !
	`IS_LAST_ENTRY
(entry);

1170 
íåy
 = 
	`PXT4_XATTR_NEXT
(entry)) {

1171 i‡(!
íåy
->
e_vÆue_öum
)

1173 
ó_öo
 = 
	`À32_to_˝u
(
íåy
->
e_vÆue_öum
);

1174 
îr
 = 
	`pxt4_x©å_öode_igë
(
∑ª¡
, 
ó_öo
,

1175 
	`À32_to_˝u
(
íåy
->
e_hash
),

1176 &
ó_öode
);

1177 i‡(
îr
)

1180 
îr
 = 
	`pxt4_ex∑nd_öode_¨øy
(
ó_öode_¨øy
, 
ó_öode
);

1181 i‡(
îr
) {

1182 
	`pxt4_w¨nög_öode
(
ó_öode
,

1183 "Ex∑nd inodê¨øyÉº=%d", 
îr
);

1184 
	`ùut
(
ó_öode
);

1188 
îr
 = 
	`pxt4_x©å_ísuª_¸edôs
(
h™dÀ
, 
∑ª¡
, 
¸edôs
, 
bh
,

1189 
dúty
, 
block_csum
);

1190 i‡(
îr
) {

1191 
	`pxt4_w¨nög_öode
(
ó_öode
, "Ensure creditsÉrr=%d",

1192 
îr
);

1196 
îr
 = 
	`pxt4_x©å_öode_dec_ªf
(
h™dÀ
, 
ó_öode
);

1197 i‡(
îr
) {

1198 
	`pxt4_w¨nög_öode
(
ó_öode
, "ea_inode decÑefÉrr=%d",

1199 
îr
);

1203 i‡(!
skù_quŸa
)

1204 
	`pxt4_x©å_öode_‰ì_quŸa
(
∑ª¡
, 
ó_öode
,

1205 
	`À32_to_˝u
(
íåy
->
e_vÆue_size
));

1213 
íåy
->
e_vÆue_öum
 = 0;

1214 
íåy
->
e_vÆue_size
 = 0;

1216 
dúty
 = 
åue
;

1219 i‡(
dúty
) {

1226 
îr
 = 
	`pxt4_h™dÀ_dúty_mëad©a
(
h™dÀ
, 
NULL
, 
bh
);

1227 i‡(
îr
)

1228 
	`pxt4_w¨nög_öode
(
∑ª¡
,

1229 "h™dÀ dúty mëad©®îr=%d", 
îr
);

1231 
	}
}

1238 
	$pxt4_x©å_ªÀa£_block
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *inode,

1239 
buf„r_hód
 *
bh
,

1240 
pxt4_x©å_öode_¨øy
 **
ó_öode_¨øy
,

1241 
exåa_¸edôs
)

1243 
mb_ˇche
 *
ó_block_ˇche
 = 
	`EA_BLOCK_CACHE
(
öode
);

1244 
u32
 
hash
, 
ªf
;

1245 
îr‹
 = 0;

1247 
	`BUFFER_TRACE
(
bh
, "get_write_access");

1248 
îr‹
 = 
	`pxt4_jou∫Æ_gë_wrôe_ac˚ss
(
h™dÀ
, 
bh
);

1249 i‡(
îr‹
)

1250 
out
;

1252 
	`lock_buf„r
(
bh
);

1253 
hash
 = 
	`À32_to_˝u
(
	`BHDR
(
bh
)->
h_hash
);

1254 
ªf
 = 
	`À32_to_˝u
(
	`BHDR
(
bh
)->
h_ªfcou¡
);

1255 i‡(
ªf
 == 1) {

1256 
	`ó_bdebug
(
bh
, "refcountÇow=0; freeing");

1261 i‡(
ó_block_ˇche
)

1262 
	`mb_ˇche_íåy_dñëe
(
ó_block_ˇche
, 
hash
,

1263 
bh
->
b_blockƒ
);

1264 
	`gë_bh
(
bh
);

1265 
	`u∆ock_buf„r
(
bh
);

1267 i‡(
	`pxt4_has_„©uª_ó_öode
(
öode
->
i_sb
))

1268 
	`pxt4_x©å_öode_dec_ªf_Æl
(
h™dÀ
, 
öode
, 
bh
,

1269 
	`BFIRST
(
bh
),

1270 
åue
 ,

1271 
ó_öode_¨øy
,

1272 
exåa_¸edôs
,

1273 
åue
 );

1274 
	`pxt4_‰ì_blocks
(
h™dÀ
, 
öode
, 
bh
, 0, 1,

1275 
PXT4_FREE_BLOCKS_METADATA
 |

1276 
PXT4_FREE_BLOCKS_FORGET
);

1278 
ªf
--;

1279 
	`BHDR
(
bh
)->
h_ªfcou¡
 = 
	`˝u_to_À32
(
ªf
);

1280 i‡(
ªf
 =
PXT4_XATTR_REFCOUNT_MAX
 - 1) {

1281 
mb_ˇche_íåy
 *
˚
;

1283 i‡(
ó_block_ˇche
) {

1284 
˚
 = 
	`mb_ˇche_íåy_gë
(
ó_block_ˇche
, 
hash
,

1285 
bh
->
b_blockƒ
);

1286 i‡(
˚
) {

1287 
˚
->
e_ªußbÀ
 = 1;

1288 
	`mb_ˇche_íåy_put
(
ó_block_ˇche
, 
˚
);

1293 
	`pxt4_x©å_block_csum_£t
(
öode
, 
bh
);

1304 i‡(
	`pxt4_h™dÀ_vÆid
(
h™dÀ
))

1305 
îr‹
 = 
	`pxt4_h™dÀ_dúty_mëad©a
(
h™dÀ
, 
öode
, 
bh
);

1306 
	`u∆ock_buf„r
(
bh
);

1307 i‡(!
	`pxt4_h™dÀ_vÆid
(
h™dÀ
))

1308 
îr‹
 = 
	`pxt4_h™dÀ_dúty_mëad©a
(
h™dÀ
, 
öode
, 
bh
);

1309 i‡(
	`IS_SYNC
(
öode
))

1310 
	`pxt4_h™dÀ_sync
(
h™dÀ
);

1311 
	`dquŸ_‰ì_block
(
öode
, 
	`PXT4_C2B
(
	`PXT4_SB
(öode->
i_sb
), 1));

1312 
	`ó_bdebug
(
bh
, "refcountÇow=%d;Ñeleasing",

1313 
	`À32_to_˝u
(
	`BHDR
(
bh
)->
h_ªfcou¡
));

1315 
out
:

1316 
	`pxt4_°d_îr‹
(
öode
->
i_sb
, 
îr‹
);

1318 
	}
}

1324 
size_t
 
	$pxt4_x©å_‰ì_•a˚
(
pxt4_x©å_íåy
 *
œ°
,

1325 
size_t
 *
mö_offs
, *
ba£
, *
tŸÆ
)

1327 ; !
	`IS_LAST_ENTRY
(
œ°
);Üa° = 
	`PXT4_XATTR_NEXT
(last)) {

1328 i‡(!
œ°
->
e_vÆue_öum
 &&Üa°->
e_vÆue_size
) {

1329 
size_t
 
offs
 = 
	`À16_to_˝u
(
œ°
->
e_vÆue_offs
);

1330 i‡(
offs
 < *
mö_offs
)

1331 *
mö_offs
 = 
offs
;

1333 i‡(
tŸÆ
)

1334 *
tŸÆ
 +
	`PXT4_XATTR_LEN
(
œ°
->
e_«me_Àn
);

1336  (*
mö_offs
 - ((*)
œ°
 - 
ba£
Ë- (
__u32
));

1337 
	}
}

1342 
	$pxt4_x©å_öode_wrôe
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *
ó_öode
,

1343 c⁄° *
buf
, 
bufsize
)

1345 
buf„r_hód
 *
bh
 = 
NULL
;

1346 
block
 = 0;

1347 
blocksize
 = 
ó_öode
->
i_sb
->
s_blocksize
;

1348 
max_blocks
 = (
bufsize
 + 
blocksize
 - 1Ë>> 
ó_öode
->
i_blkbôs
;

1349 
csize
, 
wsize
 = 0;

1350 
ªt
 = 0;

1351 
ªåõs
 = 0;

1353 
ªåy
:

1354 
ªt
 >0 &&Ñë < 
max_blocks
) {

1355 
pxt4_m≠_blocks
 
m≠
;

1356 
m≠
.
m_lblk
 = 
block
 +
ªt
;

1357 
m≠
.
m_Àn
 = 
max_blocks
 -
ªt
;

1359 
ªt
 = 
	`pxt4_m≠_blocks
(
h™dÀ
, 
ó_öode
, &
m≠
,

1360 
PXT4_GET_BLOCKS_CREATE
);

1361 i‡(
ªt
 <= 0) {

1362 
	`pxt4_m¨k_öode_dúty
(
h™dÀ
, 
ó_öode
);

1363 i‡(
ªt
 =-
ENOSPC
 &&

1364 
	`pxt4_should_ªåy_Æloc
(
ó_öode
->
i_sb
, &
ªåõs
)) {

1365 
ªt
 = 0;

1366 
ªåy
;

1372 i‡(
ªt
 < 0)

1373  
ªt
;

1375 
block
 = 0;

1376 
wsize
 < 
bufsize
) {

1377 i‡(
bh
 !
NULL
)

1378 
	`bªl£
(
bh
);

1379 
csize
 = (
bufsize
 - 
wsize
Ë> 
blocksize
 ? blocksize :

1380 
bufsize
 - 
wsize
;

1381 
bh
 = 
	`pxt4_gëblk
(
h™dÀ
, 
ó_öode
, 
block
, 0);

1382 i‡(
	`IS_ERR
(
bh
))

1383  
	`PTR_ERR
(
bh
);

1384 i‡(!
bh
) {

1385 
	`WARN_ON_ONCE
(1);

1386 
	`PXT4_ERROR_INODE
(
ó_öode
,

1388  -
EFSCORRUPTED
;

1390 
ªt
 = 
	`pxt4_jou∫Æ_gë_wrôe_ac˚ss
(
h™dÀ
, 
bh
);

1391 i‡(
ªt
)

1392 
out
;

1394 
	`mem˝y
(
bh
->
b_d©a
, 
buf
, 
csize
);

1395 
	`£t_buf„r_u±od©e
(
bh
);

1396 
	`pxt4_h™dÀ_dúty_mëad©a
(
h™dÀ
, 
ó_öode
, 
bh
);

1398 
buf
 +
csize
;

1399 
wsize
 +
csize
;

1400 
block
 += 1;

1403 
	`öode_lock
(
ó_öode
);

1404 
	`i_size_wrôe
(
ó_öode
, 
wsize
);

1405 
	`pxt4_upd©e_i_disksize
(
ó_öode
, 
wsize
);

1406 
	`öode_u∆ock
(
ó_öode
);

1408 
	`pxt4_m¨k_öode_dúty
(
h™dÀ
, 
ó_öode
);

1410 
out
:

1411 
	`bªl£
(
bh
);

1413  
ªt
;

1414 
	}
}

1419 
öode
 *
	$pxt4_x©å_öode_¸óã
(
h™dÀ_t
 *
h™dÀ
,

1420 
öode
 *öode, 
u32
 
hash
)

1422 
öode
 *
ó_öode
 = 
NULL
;

1423 
uid_t
 
ow√r
[2] = { 
	`i_uid_ªad
(
öode
), 
	`i_gid_ªad
(inode) };

1424 
îr
;

1430 
ó_öode
 = 
	`pxt4_√w_öode
(
h™dÀ
, 
öode
->
i_sb
->
s_roŸ
->
d_öode
,

1431 
S_IFREG
 | 0600, 
NULL
, 
öode
->
i_öo
 + 1, 
ow√r
,

1432 
PXT4_EA_INODE_FL
);

1433 i‡(!
	`IS_ERR
(
ó_öode
)) {

1434 
ó_öode
->
i_›
 = &
pxt4_fûe_öode_›î©i⁄s
;

1435 
ó_öode
->
i_f›
 = &
pxt4_fûe_›î©i⁄s
;

1436 
	`pxt4_£t_a›s
(
ó_öode
);

1437 
	`pxt4_x©å_öode_£t_˛ass
(
ó_öode
);

1438 
	`u∆ock_√w_öode
(
ó_öode
);

1439 
	`pxt4_x©å_öode_£t_ªf
(
ó_öode
, 1);

1440 
	`pxt4_x©å_öode_£t_hash
(
ó_öode
, 
hash
);

1441 
îr
 = 
	`pxt4_m¨k_öode_dúty
(
h™dÀ
, 
ó_öode
);

1442 i‡(!
îr
)

1443 
îr
 = 
	`pxt4_öode_©èch_jöode
(
ó_öode
);

1444 i‡(
îr
) {

1445 
	`ùut
(
ó_öode
);

1446  
	`ERR_PTR
(
îr
);

1453 
	`dquŸ_‰ì_öode
(
ó_öode
);

1454 
	`dquŸ_dr›
(
ó_öode
);

1455 
	`öode_lock
(
ó_öode
);

1456 
ó_öode
->
i_Êags
 |
S_NOQUOTA
;

1457 
	`öode_u∆ock
(
ó_öode
);

1460  
ó_öode
;

1461 
	}
}

1463 
öode
 *

1464 
	$pxt4_x©å_öode_ˇche_föd
(
öode
 *öode, c⁄° *
vÆue
,

1465 
size_t
 
vÆue_Àn
, 
u32
 
hash
)

1467 
öode
 *
ó_öode
;

1468 
mb_ˇche_íåy
 *
˚
;

1469 
mb_ˇche
 *
ó_öode_ˇche
 = 
	`EA_INODE_CACHE
(
öode
);

1470 *
ó_d©a
;

1472 i‡(!
ó_öode_ˇche
)

1473  
NULL
;

1475 
˚
 = 
	`mb_ˇche_íåy_föd_fú°
(
ó_öode_ˇche
, 
hash
);

1476 i‡(!
˚
)

1477  
NULL
;

1479 
	`WARN_ON_ONCE
(
	`pxt4_h™dÀ_vÆid
(
	`jou∫Æ_cuºít_h™dÀ
()) &&

1480 !(
cuºít
->
Êags
 & 
PF_MEMALLOC_NOFS
));

1482 
ó_d©a
 = 
	`pxt4_kvmÆloc
(
vÆue_Àn
, 
GFP_NOFS
);

1483 i‡(!
ó_d©a
) {

1484 
	`mb_ˇche_íåy_put
(
ó_öode_ˇche
, 
˚
);

1485  
NULL
;

1488 
˚
) {

1489 
ó_öode
 = 
	`pxt4_igë
(
öode
->
i_sb
, 
˚
->
e_vÆue
,

1490 
PXT4_IGET_NORMAL
);

1491 i‡(!
	`IS_ERR
(
ó_öode
) &&

1492 !
	`is_bad_öode
(
ó_öode
) &&

1493 (
	`PXT4_I
(
ó_öode
)->
i_Êags
 & 
PXT4_EA_INODE_FL
) &&

1494 
	`i_size_ªad
(
ó_öode
Ë=
vÆue_Àn
 &&

1495 !
	`pxt4_x©å_öode_ªad
(
ó_öode
, 
ó_d©a
, 
vÆue_Àn
) &&

1496 !
	`pxt4_x©å_öode_vîify_hashes
(
ó_öode
, 
NULL
, 
ó_d©a
,

1497 
vÆue_Àn
) &&

1498 !
	`memcmp
(
vÆue
, 
ó_d©a
, 
vÆue_Àn
)) {

1499 
	`mb_ˇche_íåy_touch
(
ó_öode_ˇche
, 
˚
);

1500 
	`mb_ˇche_íåy_put
(
ó_öode_ˇche
, 
˚
);

1501 
	`kv‰ì
(
ó_d©a
);

1502  
ó_öode
;

1505 i‡(!
	`IS_ERR
(
ó_öode
))

1506 
	`ùut
(
ó_öode
);

1507 
˚
 = 
	`mb_ˇche_íåy_föd_√xt
(
ó_öode_ˇche
, ce);

1509 
	`kv‰ì
(
ó_d©a
);

1510  
NULL
;

1511 
	}
}

1516 
	$pxt4_x©å_öode_lookup_¸óã
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *inode,

1517 c⁄° *
vÆue
, 
size_t
 
vÆue_Àn
,

1518 
öode
 **
ªt_öode
)

1520 
öode
 *
ó_öode
;

1521 
u32
 
hash
;

1522 
îr
;

1524 
hash
 = 
	`pxt4_x©å_öode_hash
(
	`PXT4_SB
(
öode
->
i_sb
), 
vÆue
, 
vÆue_Àn
);

1525 
ó_öode
 = 
	`pxt4_x©å_öode_ˇche_föd
(
öode
, 
vÆue
, 
vÆue_Àn
, 
hash
);

1526 i‡(
ó_öode
) {

1527 
îr
 = 
	`pxt4_x©å_öode_öc_ªf
(
h™dÀ
, 
ó_öode
);

1528 i‡(
îr
) {

1529 
	`ùut
(
ó_öode
);

1530  
îr
;

1533 *
ªt_öode
 = 
ó_öode
;

1538 
ó_öode
 = 
	`pxt4_x©å_öode_¸óã
(
h™dÀ
, 
öode
, 
hash
);

1539 i‡(
	`IS_ERR
(
ó_öode
))

1540  
	`PTR_ERR
(
ó_öode
);

1542 
îr
 = 
	`pxt4_x©å_öode_wrôe
(
h™dÀ
, 
ó_öode
, 
vÆue
, 
vÆue_Àn
);

1543 i‡(
îr
) {

1544 
	`pxt4_x©å_öode_dec_ªf
(
h™dÀ
, 
ó_öode
);

1545 
	`ùut
(
ó_öode
);

1546  
îr
;

1549 i‡(
	`EA_INODE_CACHE
(
öode
))

1550 
	`mb_ˇche_íåy_¸óã
(
	`EA_INODE_CACHE
(
öode
), 
GFP_NOFS
, 
hash
,

1551 
ó_öode
->
i_öo
, 
åue
 );

1553 *
ªt_öode
 = 
ó_öode
;

1555 
	}
}

1561 
	#PXT4_XATTR_BLOCK_RESERVE
(
öode
Ë
	`mö
(
	`i_blocksize
(öode)/8, 1024U)

	)

1563 
	$pxt4_x©å_£t_íåy
(
pxt4_x©å_öfo
 *
i
,

1564 
pxt4_x©å_£¨ch
 *
s
,

1565 
h™dÀ_t
 *
h™dÀ
, 
öode
 *inode,

1566 
boﬁ
 
is_block
)

1568 
pxt4_x©å_íåy
 *
œ°
, *
√xt
;

1569 
pxt4_x©å_íåy
 *
hîe
 = 
s
->here;

1570 
size_t
 
mö_offs
 = 
s
->
íd
 - s->
ba£
, 
«me_Àn
 = 
	`°æí
(
i
->
«me
);

1571 
ö_öode
 = 
i
->in_inode;

1572 
öode
 *
ﬁd_ó_öode
 = 
NULL
;

1573 
öode
 *
√w_ó_öode
 = 
NULL
;

1574 
size_t
 
ﬁd_size
, 
√w_size
;

1575 
ªt
;

1578 
ﬁd_size
 = (!
s
->
nŸ_found
 && !
hîe
->
e_vÆue_öum
) ?

1579 
	`PXT4_XATTR_SIZE
(
	`À32_to_˝u
(
hîe
->
e_vÆue_size
)) : 0;

1580 
√w_size
 = (
i
->
vÆue
 && !
ö_öode
Ë? 
	`PXT4_XATTR_SIZE
(i->
vÆue_Àn
) : 0;

1586 i‡(
√w_size
 &&Çew_sizê=
ﬁd_size
) {

1587 
size_t
 
offs
 = 
	`À16_to_˝u
(
hîe
->
e_vÆue_offs
);

1588 *
vÆ
 = 
s
->
ba£
 + 
offs
;

1590 
hîe
->
e_vÆue_size
 = 
	`˝u_to_À32
(
i
->
vÆue_Àn
);

1591 i‡(
i
->
vÆue
 =
PXT4_ZERO_XATTR_VALUE
) {

1592 
	`mem£t
(
vÆ
, 0, 
√w_size
);

1594 
	`mem˝y
(
vÆ
, 
i
->
vÆue
, i->
vÆue_Àn
);

1596 
	`mem£t
(
vÆ
 + 
i
->
vÆue_Àn
, 0, 
√w_size
 - i->value_len);

1598 
upd©e_hash
;

1602 
œ°
 = 
s
->
fú°
;

1603 ; !
	`IS_LAST_ENTRY
(
œ°
);Üa° = 
√xt
) {

1604 
√xt
 = 
	`PXT4_XATTR_NEXT
(
œ°
);

1605 i‡((*)
√xt
 >
s
->
íd
) {

1606 
	`PXT4_ERROR_INODE
(
öode
, "corrupted xattrÉntries");

1607 
ªt
 = -
EFSCORRUPTED
;

1608 
out
;

1610 i‡(!
œ°
->
e_vÆue_öum
 &&Üa°->
e_vÆue_size
) {

1611 
size_t
 
offs
 = 
	`À16_to_˝u
(
œ°
->
e_vÆue_offs
);

1612 i‡(
offs
 < 
mö_offs
)

1613 
mö_offs
 = 
offs
;

1618 i‡(
i
->
vÆue
) {

1619 
size_t
 
‰ì
;

1621 
‰ì
 = 
mö_offs
 - ((*)
œ°
 - 
s
->
ba£
Ë- (
__u32
);

1622 i‡(!
s
->
nŸ_found
)

1623 
‰ì
 +
	`PXT4_XATTR_LEN
(
«me_Àn
Ë+ 
ﬁd_size
;

1625 i‡(
‰ì
 < 
	`PXT4_XATTR_LEN
(
«me_Àn
Ë+ 
√w_size
) {

1626 
ªt
 = -
ENOSPC
;

1627 
out
;

1636 i‡(
	`pxt4_has_„©uª_ó_öode
(
öode
->
i_sb
) &&

1637 
√w_size
 && 
is_block
 &&

1638 (
mö_offs
 + 
ﬁd_size
 - 
√w_size
) <

1639 
	`PXT4_XATTR_BLOCK_RESERVE
(
öode
)) {

1640 
ªt
 = -
ENOSPC
;

1641 
out
;

1649 i‡(!
s
->
nŸ_found
 && 
hîe
->
e_vÆue_öum
) {

1650 
ªt
 = 
	`pxt4_x©å_öode_igë
(
öode
,

1651 
	`À32_to_˝u
(
hîe
->
e_vÆue_öum
),

1652 
	`À32_to_˝u
(
hîe
->
e_hash
),

1653 &
ﬁd_ó_öode
);

1654 i‡(
ªt
) {

1655 
ﬁd_ó_öode
 = 
NULL
;

1656 
out
;

1659 i‡(
i
->
vÆue
 && 
ö_öode
) {

1660 
	`WARN_ON_ONCE
(!
i
->
vÆue_Àn
);

1662 
ªt
 = 
	`pxt4_x©å_öode_Æloc_quŸa
(
öode
, 
i
->
vÆue_Àn
);

1663 i‡(
ªt
)

1664 
out
;

1666 
ªt
 = 
	`pxt4_x©å_öode_lookup_¸óã
(
h™dÀ
, 
öode
, 
i
->
vÆue
,

1667 
i
->
vÆue_Àn
,

1668 &
√w_ó_öode
);

1669 i‡(
ªt
) {

1670 
√w_ó_öode
 = 
NULL
;

1671 
	`pxt4_x©å_öode_‰ì_quŸa
(
öode
, 
NULL
, 
i
->
vÆue_Àn
);

1672 
out
;

1676 i‡(
ﬁd_ó_öode
) {

1678 
ªt
 = 
	`pxt4_x©å_öode_dec_ªf
(
h™dÀ
, 
ﬁd_ó_öode
);

1679 i‡(
ªt
) {

1681 i‡(
√w_ó_öode
) {

1682 
îr
;

1684 
îr
 = 
	`pxt4_x©å_öode_dec_ªf
(
h™dÀ
,

1685 
√w_ó_öode
);

1686 i‡(
îr
)

1687 
	`pxt4_w¨nög_öode
(
√w_ó_öode
,

1689 
îr
);

1690 
	`pxt4_x©å_öode_‰ì_quŸa
(
öode
, 
√w_ó_öode
,

1691 
i
->
vÆue_Àn
);

1693 
out
;

1696 
	`pxt4_x©å_öode_‰ì_quŸa
(
öode
, 
ﬁd_ó_öode
,

1697 
	`À32_to_˝u
(
hîe
->
e_vÆue_size
));

1702 i‡(!
s
->
nŸ_found
 && 
hîe
->
e_vÆue_size
 && !hîe->
e_vÆue_öum
) {

1704 *
fú°_vÆ
 = 
s
->
ba£
 + 
mö_offs
;

1705 
size_t
 
offs
 = 
	`À16_to_˝u
(
hîe
->
e_vÆue_offs
);

1706 *
vÆ
 = 
s
->
ba£
 + 
offs
;

1708 
	`memmove
(
fú°_vÆ
 + 
ﬁd_size
, fú°_vÆ, 
vÆ
 - first_val);

1709 
	`mem£t
(
fú°_vÆ
, 0, 
ﬁd_size
);

1710 
mö_offs
 +
ﬁd_size
;

1713 
œ°
 = 
s
->
fú°
;

1714 !
	`IS_LAST_ENTRY
(
œ°
)) {

1715 
size_t
 
o
 = 
	`À16_to_˝u
(
œ°
->
e_vÆue_offs
);

1717 i‡(!
œ°
->
e_vÆue_öum
 &&

1718 
œ°
->
e_vÆue_size
 && 
o
 < 
offs
)

1719 
œ°
->
e_vÆue_offs
 = 
	`˝u_to_À16
(
o
 + 
ﬁd_size
);

1720 
œ°
 = 
	`PXT4_XATTR_NEXT
(last);

1724 i‡(!
i
->
vÆue
) {

1726 
size_t
 
size
 = 
	`PXT4_XATTR_LEN
(
«me_Àn
);

1728 
œ°
 = 
	`ENTRY
((*Óa° - 
size
);

1729 
	`memmove
(
hîe
, (*)hîê+ 
size
,

1730 (*)
œ°
 - (*)
hîe
 + (
__u32
));

1731 
	`mem£t
(
œ°
, 0, 
size
);

1732 } i‡(
s
->
nŸ_found
) {

1734 
size_t
 
size
 = 
	`PXT4_XATTR_LEN
(
«me_Àn
);

1735 
size_t
 
ª°
 = (*)
œ°
 - (*)
hîe
 + (
__u32
);

1737 
	`memmove
((*)
hîe
 + 
size
, hîe, 
ª°
);

1738 
	`mem£t
(
hîe
, 0, 
size
);

1739 
hîe
->
e_«me_ödex
 = 
i
->
«me_ödex
;

1740 
hîe
->
e_«me_Àn
 = 
«me_Àn
;

1741 
	`mem˝y
(
hîe
->
e_«me
, 
i
->
«me
, 
«me_Àn
);

1744 
hîe
->
e_vÆue_öum
 = 0;

1745 
hîe
->
e_vÆue_offs
 = 0;

1746 
hîe
->
e_vÆue_size
 = 0;

1749 i‡(
i
->
vÆue
) {

1751 i‡(
ö_öode
) {

1752 
hîe
->
e_vÆue_öum
 = 
	`˝u_to_À32
(
√w_ó_öode
->
i_öo
);

1753 } i‡(
i
->
vÆue_Àn
) {

1754 *
vÆ
 = 
s
->
ba£
 + 
mö_offs
 - 
√w_size
;

1756 
hîe
->
e_vÆue_offs
 = 
	`˝u_to_À16
(
mö_offs
 - 
√w_size
);

1757 i‡(
i
->
vÆue
 =
PXT4_ZERO_XATTR_VALUE
) {

1758 
	`mem£t
(
vÆ
, 0, 
√w_size
);

1760 
	`mem˝y
(
vÆ
, 
i
->
vÆue
, i->
vÆue_Àn
);

1762 
	`mem£t
(
vÆ
 + 
i
->
vÆue_Àn
, 0,

1763 
√w_size
 - 
i
->
vÆue_Àn
);

1766 
hîe
->
e_vÆue_size
 = 
	`˝u_to_À32
(
i
->
vÆue_Àn
);

1769 
upd©e_hash
:

1770 i‡(
i
->
vÆue
) {

1771 
__À32
 
hash
 = 0;

1774 i‡(
ö_öode
) {

1775 
__À32
 
¸c32c_hash
;

1782 
¸c32c_hash
 = 
	`˝u_to_À32
(

1783 
	`pxt4_x©å_öode_gë_hash
(
√w_ó_öode
));

1784 
hash
 = 
	`pxt4_x©å_hash_íåy
(
hîe
->
e_«me
,

1785 
hîe
->
e_«me_Àn
,

1786 &
¸c32c_hash
, 1);

1787 } i‡(
is_block
) {

1788 
__À32
 *
vÆue
 = 
s
->
ba£
 + 
	`À16_to_˝u
(

1789 
hîe
->
e_vÆue_offs
);

1791 
hash
 = 
	`pxt4_x©å_hash_íåy
(
hîe
->
e_«me
,

1792 
hîe
->
e_«me_Àn
, 
vÆue
,

1793 
√w_size
 >> 2);

1795 
hîe
->
e_hash
 = 
hash
;

1798 i‡(
is_block
)

1799 
	`pxt4_x©å_ªhash
((
pxt4_x©å_hódî
 *)
s
->
ba£
);

1801 
ªt
 = 0;

1802 
out
:

1803 
	`ùut
(
ﬁd_ó_öode
);

1804 
	`ùut
(
√w_ó_öode
);

1805  
ªt
;

1806 
	}
}

1808 
	spxt4_x©å_block_föd
 {

1809 
pxt4_x©å_£¨ch
 
	ms
;

1810 
buf„r_hód
 *
	mbh
;

1814 
	$pxt4_x©å_block_föd
(
öode
 *öode, 
pxt4_x©å_öfo
 *
i
,

1815 
pxt4_x©å_block_föd
 *
bs
)

1817 
su≥r_block
 *
sb
 = 
öode
->
i_sb
;

1818 
îr‹
;

1820 
	`ó_idebug
(
öode
, "name=%d.%s, value=%p, value_len=%ld",

1821 
i
->
«me_ödex
, i->
«me
, i->
vÆue
, ()i->
vÆue_Àn
);

1823 i‡(
	`PXT4_I
(
öode
)->
i_fûe_a˛
) {

1825 
bs
->
bh
 = 
	`pxt4_sb_bªad
(
sb
, 
	`PXT4_I
(
öode
)->
i_fûe_a˛
, 
REQ_PRIO
);

1826 i‡(
	`IS_ERR
(
bs
->
bh
)) {

1827 
îr‹
 = 
	`PTR_ERR
(
bs
->
bh
);

1828 
bs
->
bh
 = 
NULL
;

1829  
îr‹
;

1831 
	`ó_bdebug
(
bs
->
bh
, "b_count=%d,Ñefcount=%d",

1832 
	`©omic_ªad
(&(
bs
->
bh
->
b_cou¡
)),

1833 
	`À32_to_˝u
(
	`BHDR
(
bs
->
bh
)->
h_ªfcou¡
));

1834 
îr‹
 = 
	`pxt4_x©å_check_block
(
öode
, 
bs
->
bh
);

1835 i‡(
îr‹
)

1836  
îr‹
;

1838 
bs
->
s
.
ba£
 = 
	`BHDR
(bs->
bh
);

1839 
bs
->
s
.
fú°
 = 
	`BFIRST
(bs->
bh
);

1840 
bs
->
s
.
íd
 = bs->
bh
->
b_d©a
 + bs->bh->
b_size
;

1841 
bs
->
s
.
hîe
 = bs->s.
fú°
;

1842 
îr‹
 = 
	`x©å_föd_íåy
(
öode
, &
bs
->
s
.
hîe
, bs->s.
íd
,

1843 
i
->
«me_ödex
, i->
«me
, 1);

1844 i‡(
îr‹
 &&Éº‹ !-
ENODATA
)

1845  
îr‹
;

1846 
bs
->
s
.
nŸ_found
 = 
îr‹
;

1849 
	}
}

1852 
	$pxt4_x©å_block_£t
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *inode,

1853 
pxt4_x©å_öfo
 *
i
,

1854 
pxt4_x©å_block_föd
 *
bs
)

1856 
su≥r_block
 *
sb
 = 
öode
->
i_sb
;

1857 
buf„r_hód
 *
√w_bh
 = 
NULL
;

1858 
pxt4_x©å_£¨ch
 
s_c›y
 = 
bs
->
s
;

1859 
pxt4_x©å_£¨ch
 *
s
 = &
s_c›y
;

1860 
mb_ˇche_íåy
 *
˚
 = 
NULL
;

1861 
îr‹
 = 0;

1862 
mb_ˇche
 *
ó_block_ˇche
 = 
	`EA_BLOCK_CACHE
(
öode
);

1863 
öode
 *
ó_öode
 = 
NULL
, *
tmp_öode
;

1864 
size_t
 
ﬁd_ó_öode_quŸa
 = 0;

1865 
ó_öo
;

1868 
	#hódî
(
x
Ë((
pxt4_x©å_hódî
 *)(x))

	)

1870 i‡(
s
->
ba£
) {

1871 
	`BUFFER_TRACE
(
bs
->
bh
, "get_write_access");

1872 
îr‹
 = 
	`pxt4_jou∫Æ_gë_wrôe_ac˚ss
(
h™dÀ
, 
bs
->
bh
);

1873 i‡(
îr‹
)

1874 
˛ónup
;

1875 
	`lock_buf„r
(
bs
->
bh
);

1877 i‡(
	`hódî
(
s
->
ba£
)->
h_ªfcou¡
 =
	`˝u_to_À32
(1)) {

1878 
__u32
 
hash
 = 
	`À32_to_˝u
(
	`BHDR
(
bs
->
bh
)->
h_hash
);

1885 i‡(
ó_block_ˇche
)

1886 
	`mb_ˇche_íåy_dñëe
(
ó_block_ˇche
, 
hash
,

1887 
bs
->
bh
->
b_blockƒ
);

1888 
	`ó_bdebug
(
bs
->
bh
, "modifying in-place");

1889 
îr‹
 = 
	`pxt4_x©å_£t_íåy
(
i
, 
s
, 
h™dÀ
, 
öode
,

1890 
åue
 );

1891 
	`pxt4_x©å_block_csum_£t
(
öode
, 
bs
->
bh
);

1892 
	`u∆ock_buf„r
(
bs
->
bh
);

1893 i‡(
îr‹
 =-
EFSCORRUPTED
)

1894 
bad_block
;

1895 i‡(!
îr‹
)

1896 
îr‹
 = 
	`pxt4_h™dÀ_dúty_mëad©a
(
h™dÀ
,

1897 
öode
,

1898 
bs
->
bh
);

1899 i‡(
îr‹
)

1900 
˛ónup
;

1901 
ö£πed
;

1903 
off£t
 = (*)
s
->
hîe
 - 
bs
->
bh
->
b_d©a
;

1905 
	`u∆ock_buf„r
(
bs
->
bh
);

1906 
	`ó_bdebug
(
bs
->
bh
, "cloning");

1907 
s
->
ba£
 = 
	`kmÆloc
(
bs
->
bh
->
b_size
, 
GFP_NOFS
);

1908 
îr‹
 = -
ENOMEM
;

1909 i‡(
s
->
ba£
 =
NULL
)

1910 
˛ónup
;

1911 
	`mem˝y
(
s
->
ba£
, 
	`BHDR
(
bs
->
bh
), bs->bh->
b_size
);

1912 
s
->
fú°
 = 
	`ENTRY
(
	`hódî
(s->
ba£
)+1);

1913 
	`hódî
(
s
->
ba£
)->
h_ªfcou¡
 = 
	`˝u_to_À32
(1);

1914 
s
->
hîe
 = 
	`ENTRY
(s->
ba£
 + 
off£t
);

1915 
s
->
íd
 = s->
ba£
 + 
bs
->
bh
->
b_size
;

1924 i‡(!
s
->
nŸ_found
 && s->
hîe
->
e_vÆue_öum
) {

1925 
ó_öo
 = 
	`À32_to_˝u
(
s
->
hîe
->
e_vÆue_öum
);

1926 
îr‹
 = 
	`pxt4_x©å_öode_igë
(
öode
, 
ó_öo
,

1927 
	`À32_to_˝u
(
s
->
hîe
->
e_hash
),

1928 &
tmp_öode
);

1929 i‡(
îr‹
)

1930 
˛ónup
;

1932 i‡(!
	`pxt4_ã°_öode_°©e
(
tmp_öode
,

1933 
PXT4_STATE_LUSTRE_EA_INODE
)) {

1938 
ﬁd_ó_öode_quŸa
 = 
	`À32_to_˝u
(

1939 
s
->
hîe
->
e_vÆue_size
);

1941 
	`ùut
(
tmp_öode
);

1943 
s
->
hîe
->
e_vÆue_öum
 = 0;

1944 
s
->
hîe
->
e_vÆue_size
 = 0;

1949 
s
->
ba£
 = 
	`kzÆloc
(
sb
->
s_blocksize
, 
GFP_NOFS
);

1951 
îr‹
 = -
ENOMEM
;

1952 i‡(
s
->
ba£
 =
NULL
)

1953 
˛ónup
;

1954 
	`hódî
(
s
->
ba£
)->
h_magic
 = 
	`˝u_to_À32
(
PXT4_XATTR_MAGIC
);

1955 
	`hódî
(
s
->
ba£
)->
h_blocks
 = 
	`˝u_to_À32
(1);

1956 
	`hódî
(
s
->
ba£
)->
h_ªfcou¡
 = 
	`˝u_to_À32
(1);

1957 
s
->
fú°
 = 
	`ENTRY
(
	`hódî
(s->
ba£
)+1);

1958 
s
->
hîe
 = 
	`ENTRY
(
	`hódî
(s->
ba£
)+1);

1959 
s
->
íd
 = s->
ba£
 + 
sb
->
s_blocksize
;

1962 
îr‹
 = 
	`pxt4_x©å_£t_íåy
(
i
, 
s
, 
h™dÀ
, 
öode
, 
åue
 );

1963 i‡(
îr‹
 =-
EFSCORRUPTED
)

1964 
bad_block
;

1965 i‡(
îr‹
)

1966 
˛ónup
;

1968 i‡(
i
->
vÆue
 && 
s
->
hîe
->
e_vÆue_öum
) {

1975 
ó_öo
 = 
	`À32_to_˝u
(
s
->
hîe
->
e_vÆue_öum
);

1976 
îr‹
 = 
	`pxt4_x©å_öode_igë
(
öode
, 
ó_öo
,

1977 
	`À32_to_˝u
(
s
->
hîe
->
e_hash
),

1978 &
ó_öode
);

1979 i‡(
îr‹
) {

1980 
ó_öode
 = 
NULL
;

1981 
˛ónup
;

1985 
ö£πed
:

1986 i‡(!
	`IS_LAST_ENTRY
(
s
->
fú°
)) {

1987 
√w_bh
 = 
	`pxt4_x©å_block_ˇche_föd
(
öode
, 
	`hódî
(
s
->
ba£
),

1988 &
˚
);

1989 i‡(
√w_bh
) {

1991 i‡(
√w_bh
 =
bs
->
bh
)

1992 
	`ó_bdebug
(
√w_bh
, "keeping");

1994 
u32
 
ªf
;

1996 
	`WARN_ON_ONCE
(
	`dquŸ_öôülize_√eded
(
öode
));

2000 
îr‹
 = 
	`dquŸ_Æloc_block
(
öode
,

2001 
	`PXT4_C2B
(
	`PXT4_SB
(
sb
), 1));

2002 i‡(
îr‹
)

2003 
˛ónup
;

2004 
	`BUFFER_TRACE
(
√w_bh
, "get_write_access");

2005 
îr‹
 = 
	`pxt4_jou∫Æ_gë_wrôe_ac˚ss
(
h™dÀ
,

2006 
√w_bh
);

2007 i‡(
îr‹
)

2008 
˛ónup_dquŸ
;

2009 
	`lock_buf„r
(
√w_bh
);

2022 i‡(
	`hli°_bl_unhashed
(&
˚
->
e_hash_li°
) ||

2023 !
˚
->
e_ªußbÀ
) {

2028 
	`u∆ock_buf„r
(
√w_bh
);

2029 
	`dquŸ_‰ì_block
(
öode
,

2030 
	`PXT4_C2B
(
	`PXT4_SB
(
sb
),

2032 
	`bªl£
(
√w_bh
);

2033 
	`mb_ˇche_íåy_put
(
ó_block_ˇche
, 
˚
);

2034 
˚
 = 
NULL
;

2035 
√w_bh
 = 
NULL
;

2036 
ö£πed
;

2038 
ªf
 = 
	`À32_to_˝u
(
	`BHDR
(
√w_bh
)->
h_ªfcou¡
) + 1;

2039 
	`BHDR
(
√w_bh
)->
h_ªfcou¡
 = 
	`˝u_to_À32
(
ªf
);

2040 i‡(
ªf
 >
PXT4_XATTR_REFCOUNT_MAX
)

2041 
˚
->
e_ªußbÀ
 = 0;

2042 
	`ó_bdebug
(
√w_bh
, "reusing;ÑefcountÇow=%d",

2043 
ªf
);

2044 
	`pxt4_x©å_block_csum_£t
(
öode
, 
√w_bh
);

2045 
	`u∆ock_buf„r
(
√w_bh
);

2046 
îr‹
 = 
	`pxt4_h™dÀ_dúty_mëad©a
(
h™dÀ
,

2047 
öode
,

2048 
√w_bh
);

2049 i‡(
îr‹
)

2050 
˛ónup_dquŸ
;

2052 
	`mb_ˇche_íåy_touch
(
ó_block_ˇche
, 
˚
);

2053 
	`mb_ˇche_íåy_put
(
ó_block_ˇche
, 
˚
);

2054 
˚
 = 
NULL
;

2055 } i‡(
bs
->
bh
 && 
s
->
ba£
 =bs->bh->
b_d©a
) {

2057 
	`ó_bdebug
(
bs
->
bh
, "keepingÅhis block");

2058 
	`pxt4_x©å_block_ˇche_ö£π
(
ó_block_ˇche
, 
bs
->
bh
);

2059 
√w_bh
 = 
bs
->
bh
;

2060 
	`gë_bh
(
√w_bh
);

2063 
pxt4_fsblk_t
 
gﬂl
, 
block
;

2065 
	`WARN_ON_ONCE
(
	`dquŸ_öôülize_√eded
(
öode
));

2067 
gﬂl
 = 
	`pxt4_group_fú°_block_no
(
sb
,

2068 
	`PXT4_I
(
öode
)->
i_block_group
);

2071 i‡(!(
	`pxt4_ã°_öode_Êag
(
öode
, 
PXT4_INODE_EXTENTS
)))

2072 
gﬂl
 = gﬂ»& 
PXT4_MAX_BLOCK_FILE_PHYS
;

2074 
block
 = 
	`pxt4_√w_mëa_blocks
(
h™dÀ
, 
öode
, 
gﬂl
, 0,

2075 
NULL
, &
îr‹
);

2076 i‡(
îr‹
)

2077 
˛ónup
;

2079 i‡(!(
	`pxt4_ã°_öode_Êag
(
öode
, 
PXT4_INODE_EXTENTS
)))

2080 
	`BUG_ON
(
block
 > 
PXT4_MAX_BLOCK_FILE_PHYS
);

2082 
	`ó_idebug
(
öode
, "creating block %llu",

2083 ()
block
);

2085 
√w_bh
 = 
	`sb_gëblk
(
sb
, 
block
);

2086 i‡(
	`u∆ikñy
(!
√w_bh
)) {

2087 
îr‹
 = -
ENOMEM
;

2088 
gëblk_Áûed
:

2089 
	`pxt4_‰ì_blocks
(
h™dÀ
, 
öode
, 
NULL
, 
block
, 1,

2090 
PXT4_FREE_BLOCKS_METADATA
);

2091 
˛ónup
;

2093 
îr‹
 = 
	`pxt4_x©å_öode_öc_ªf_Æl
(
h™dÀ
, 
öode
,

2094 
	`ENTRY
(
	`hódî
(
s
->
ba£
)+1));

2095 i‡(
îr‹
)

2096 
gëblk_Áûed
;

2097 i‡(
ó_öode
) {

2099 
îr‹
 = 
	`pxt4_x©å_öode_dec_ªf
(
h™dÀ
,

2100 
ó_öode
);

2101 i‡(
îr‹
)

2102 
	`pxt4_w¨nög_öode
(
ó_öode
,

2104 
îr‹
);

2105 
	`ùut
(
ó_öode
);

2106 
ó_öode
 = 
NULL
;

2109 
	`lock_buf„r
(
√w_bh
);

2110 
îr‹
 = 
	`pxt4_jou∫Æ_gë_¸óã_ac˚ss
(
h™dÀ
, 
√w_bh
);

2111 i‡(
îr‹
) {

2112 
	`u∆ock_buf„r
(
√w_bh
);

2113 
îr‹
 = -
EIO
;

2114 
gëblk_Áûed
;

2116 
	`mem˝y
(
√w_bh
->
b_d©a
, 
s
->
ba£
,Çew_bh->
b_size
);

2117 
	`pxt4_x©å_block_csum_£t
(
öode
, 
√w_bh
);

2118 
	`£t_buf„r_u±od©e
(
√w_bh
);

2119 
	`u∆ock_buf„r
(
√w_bh
);

2120 
	`pxt4_x©å_block_ˇche_ö£π
(
ó_block_ˇche
, 
√w_bh
);

2121 
îr‹
 = 
	`pxt4_h™dÀ_dúty_mëad©a
(
h™dÀ
, 
öode
,

2122 
√w_bh
);

2123 i‡(
îr‹
)

2124 
˛ónup
;

2128 i‡(
ﬁd_ó_öode_quŸa
)

2129 
	`pxt4_x©å_öode_‰ì_quŸa
(
öode
, 
NULL
, 
ﬁd_ó_öode_quŸa
);

2132 
	`PXT4_I
(
öode
)->
i_fûe_a˛
 = 
√w_bh
 ?Çew_bh->
b_blockƒ
 : 0;

2135 i‡(
bs
->
bh
 && bs->bh !
√w_bh
) {

2136 
pxt4_x©å_öode_¨øy
 *
ó_öode_¨øy
 = 
NULL
;

2138 
	`pxt4_x©å_ªÀa£_block
(
h™dÀ
, 
öode
, 
bs
->
bh
,

2139 &
ó_öode_¨øy
,

2141 
	`pxt4_x©å_öode_¨øy_‰ì
(
ó_öode_¨øy
);

2143 
îr‹
 = 0;

2145 
˛ónup
:

2146 i‡(
ó_öode
) {

2147 
îr‹2
;

2149 
îr‹2
 = 
	`pxt4_x©å_öode_dec_ªf
(
h™dÀ
, 
ó_öode
);

2150 i‡(
îr‹2
)

2151 
	`pxt4_w¨nög_öode
(
ó_öode
, "decÑefÉrror=%d",

2152 
îr‹2
);

2155 i‡(
îr‹
)

2156 
	`pxt4_x©å_öode_‰ì_quŸa
(
öode
, 
ó_öode
,

2157 
	`i_size_ªad
(
ó_öode
));

2158 
	`ùut
(
ó_öode
);

2160 i‡(
˚
)

2161 
	`mb_ˇche_íåy_put
(
ó_block_ˇche
, 
˚
);

2162 
	`bªl£
(
√w_bh
);

2163 i‡(!(
bs
->
bh
 && 
s
->
ba£
 =bs->bh->
b_d©a
))

2164 
	`k‰ì
(
s
->
ba£
);

2166  
îr‹
;

2168 
˛ónup_dquŸ
:

2169 
	`dquŸ_‰ì_block
(
öode
, 
	`PXT4_C2B
(
	`PXT4_SB
(
sb
), 1));

2170 
˛ónup
;

2172 
bad_block
:

2173 
	`PXT4_ERROR_INODE
(
öode
, "bad block %llu",

2174 
	`PXT4_I
(
öode
)->
i_fûe_a˛
);

2175 
˛ónup
;

2177 #unde‡
hódî


2178 
	}
}

2180 
	$pxt4_x©å_ibody_föd
(
öode
 *öode, 
pxt4_x©å_öfo
 *
i
,

2181 
pxt4_x©å_ibody_föd
 *
is
)

2183 
pxt4_x©å_ibody_hódî
 *
hódî
;

2184 
pxt4_öode
 *
øw_öode
;

2185 
îr‹
;

2187 i‡(
	`PXT4_I
(
öode
)->
i_exåa_isize
 == 0)

2189 
øw_öode
 = 
	`pxt4_øw_öode
(&
is
->
ûoc
);

2190 
hódî
 = 
	`IHDR
(
öode
, 
øw_öode
);

2191 
is
->
s
.
ba£
 = is->s.
fú°
 = 
	`IFIRST
(
hódî
);

2192 
is
->
s
.
hîe
 = is->s.
fú°
;

2193 
is
->
s
.
íd
 = (*)
øw_öode
 + 
	`PXT4_SB
(
öode
->
i_sb
)->
s_öode_size
;

2194 i‡(
	`pxt4_ã°_öode_°©e
(
öode
, 
PXT4_STATE_XATTR
)) {

2195 
îr‹
 = 
	`x©å_check_öode
(
öode
, 
hódî
, 
is
->
s
.
íd
);

2196 i‡(
îr‹
)

2197  
îr‹
;

2199 
îr‹
 = 
	`x©å_föd_íåy
(
öode
, &
is
->
s
.
hîe
, is->s.
íd
,

2200 
i
->
«me_ödex
, i->
«me
, 0);

2201 i‡(
îr‹
 &&Éº‹ !-
ENODATA
)

2202  
îr‹
;

2203 
is
->
s
.
nŸ_found
 = 
îr‹
;

2206 
	}
}

2208 
	$pxt4_x©å_ibody_ölöe_£t
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *inode,

2209 
pxt4_x©å_öfo
 *
i
,

2210 
pxt4_x©å_ibody_föd
 *
is
)

2212 
pxt4_x©å_ibody_hódî
 *
hódî
;

2213 
pxt4_x©å_£¨ch
 *
s
 = &
is
->s;

2214 
îr‹
;

2216 i‡(
	`PXT4_I
(
öode
)->
i_exåa_isize
 == 0)

2217  -
ENOSPC
;

2218 
îr‹
 = 
	`pxt4_x©å_£t_íåy
(
i
, 
s
, 
h™dÀ
, 
öode
, 
Ál£
 );

2219 i‡(
îr‹
)

2220  
îr‹
;

2221 
hódî
 = 
	`IHDR
(
öode
, 
	`pxt4_øw_öode
(&
is
->
ûoc
));

2222 i‡(!
	`IS_LAST_ENTRY
(
s
->
fú°
)) {

2223 
hódî
->
h_magic
 = 
	`˝u_to_À32
(
PXT4_XATTR_MAGIC
);

2224 
	`pxt4_£t_öode_°©e
(
öode
, 
PXT4_STATE_XATTR
);

2226 
hódî
->
h_magic
 = 
	`˝u_to_À32
(0);

2227 
	`pxt4_˛ór_öode_°©e
(
öode
, 
PXT4_STATE_XATTR
);

2230 
	}
}

2232 
	$pxt4_x©å_ibody_£t
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *inode,

2233 
pxt4_x©å_öfo
 *
i
,

2234 
pxt4_x©å_ibody_föd
 *
is
)

2236 
pxt4_x©å_ibody_hódî
 *
hódî
;

2237 
pxt4_x©å_£¨ch
 *
s
 = &
is
->s;

2238 
îr‹
;

2240 i‡(
	`PXT4_I
(
öode
)->
i_exåa_isize
 == 0)

2241  -
ENOSPC
;

2242 
îr‹
 = 
	`pxt4_x©å_£t_íåy
(
i
, 
s
, 
h™dÀ
, 
öode
, 
Ál£
 );

2243 i‡(
îr‹
)

2244  
îr‹
;

2245 
hódî
 = 
	`IHDR
(
öode
, 
	`pxt4_øw_öode
(&
is
->
ûoc
));

2246 i‡(!
	`IS_LAST_ENTRY
(
s
->
fú°
)) {

2247 
hódî
->
h_magic
 = 
	`˝u_to_À32
(
PXT4_XATTR_MAGIC
);

2248 
	`pxt4_£t_öode_°©e
(
öode
, 
PXT4_STATE_XATTR
);

2250 
hódî
->
h_magic
 = 
	`˝u_to_À32
(0);

2251 
	`pxt4_˛ór_öode_°©e
(
öode
, 
PXT4_STATE_XATTR
);

2254 
	}
}

2256 
	$pxt4_x©å_vÆue_ßme
(
pxt4_x©å_£¨ch
 *
s
,

2257 
pxt4_x©å_öfo
 *
i
)

2259 *
vÆue
;

2262 i‡(
s
->
hîe
->
e_vÆue_öum
)

2264 i‡(
	`À32_to_˝u
(
s
->
hîe
->
e_vÆue_size
Ë!
i
->
vÆue_Àn
)

2266 
vÆue
 = ((*)
s
->
ba£
Ë+ 
	`À16_to_˝u
(s->
hîe
->
e_vÆue_offs
);

2267  !
	`memcmp
(
vÆue
, 
i
->vÆue, i->
vÆue_Àn
);

2268 
	}
}

2270 
buf„r_hód
 *
	$pxt4_x©å_gë_block
(
öode
 *inode)

2272 
buf„r_hód
 *
bh
;

2273 
îr‹
;

2275 i‡(!
	`PXT4_I
(
öode
)->
i_fûe_a˛
)

2276  
NULL
;

2277 
bh
 = 
	`pxt4_sb_bªad
(
öode
->
i_sb
, 
	`PXT4_I
(öode)->
i_fûe_a˛
, 
REQ_PRIO
);

2278 i‡(
	`IS_ERR
(
bh
))

2279  
bh
;

2280 
îr‹
 = 
	`pxt4_x©å_check_block
(
öode
, 
bh
);

2281 i‡(
îr‹
) {

2282 
	`bªl£
(
bh
);

2283  
	`ERR_PTR
(
îr‹
);

2285  
bh
;

2286 
	}
}

2301 
	$pxt4_x©å_£t_h™dÀ
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *öode, 
«me_ödex
,

2302 c⁄° *
«me
, c⁄° *
vÆue
, 
size_t
 
vÆue_Àn
,

2303 
Êags
)

2305 
pxt4_x©å_öfo
 
i
 = {

2306 .
«me_ödex
 =Çame_index,

2307 .
«me
 =Çame,

2308 .
vÆue
 = value,

2309 .
vÆue_Àn
 = value_len,

2310 .
ö_öode
 = 0,

2312 
pxt4_x©å_ibody_föd
 
is
 = {

2313 .
s
 = { .
nŸ_found
 = -
ENODATA
, },

2315 
pxt4_x©å_block_föd
 
bs
 = {

2316 .
s
 = { .
nŸ_found
 = -
ENODATA
, },

2318 
no_ex∑nd
;

2319 
îr‹
;

2321 i‡(!
«me
)

2322  -
EINVAL
;

2323 i‡(
	`°æí
(
«me
) > 255)

2324  -
ERANGE
;

2326 
	`pxt4_wrôe_lock_x©å
(
öode
, &
no_ex∑nd
);

2329 i‡(
	`pxt4_h™dÀ_vÆid
(
h™dÀ
)) {

2330 
buf„r_hód
 *
bh
;

2331 
¸edôs
;

2333 
bh
 = 
	`pxt4_x©å_gë_block
(
öode
);

2334 i‡(
	`IS_ERR
(
bh
)) {

2335 
îr‹
 = 
	`PTR_ERR
(
bh
);

2336 
˛ónup
;

2339 
¸edôs
 = 
	`__pxt4_x©å_£t_¸edôs
(
öode
->
i_sb
, inode, 
bh
,

2340 
vÆue_Àn
,

2341 
Êags
 & 
XATTR_CREATE
);

2342 
	`bªl£
(
bh
);

2344 i‡(!
	`pxt4_h™dÀ_has_íough_¸edôs
(
h™dÀ
, 
¸edôs
)) {

2345 
îr‹
 = -
ENOSPC
;

2346 
˛ónup
;

2348 
	`WARN_ON_ONCE
(!(
cuºít
->
Êags
 & 
PF_MEMALLOC_NOFS
));

2351 
îr‹
 = 
	`pxt4_ª£rve_öode_wrôe
(
h™dÀ
, 
öode
, &
is
.
ûoc
);

2352 i‡(
îr‹
)

2353 
˛ónup
;

2355 i‡(
	`pxt4_ã°_öode_°©e
(
öode
, 
PXT4_STATE_NEW
)) {

2356 
pxt4_öode
 *
øw_öode
 = 
	`pxt4_øw_öode
(&
is
.
ûoc
);

2357 
	`mem£t
(
øw_öode
, 0, 
	`PXT4_SB
(
öode
->
i_sb
)->
s_öode_size
);

2358 
	`pxt4_˛ór_öode_°©e
(
öode
, 
PXT4_STATE_NEW
);

2361 
îr‹
 = 
	`pxt4_x©å_ibody_föd
(
öode
, &
i
, &
is
);

2362 i‡(
îr‹
)

2363 
˛ónup
;

2364 i‡(
is
.
s
.
nŸ_found
)

2365 
îr‹
 = 
	`pxt4_x©å_block_föd
(
öode
, &
i
, &
bs
);

2366 i‡(
îr‹
)

2367 
˛ónup
;

2368 i‡(
is
.
s
.
nŸ_found
 && 
bs
.s.not_found) {

2369 
îr‹
 = -
ENODATA
;

2370 i‡(
Êags
 & 
XATTR_REPLACE
)

2371 
˛ónup
;

2372 
îr‹
 = 0;

2373 i‡(!
vÆue
)

2374 
˛ónup
;

2376 
îr‹
 = -
EEXIST
;

2377 i‡(
Êags
 & 
XATTR_CREATE
)

2378 
˛ónup
;

2381 i‡(!
vÆue
) {

2382 i‡(!
is
.
s
.
nŸ_found
)

2383 
îr‹
 = 
	`pxt4_x©å_ibody_£t
(
h™dÀ
, 
öode
, &
i
, &
is
);

2384 i‡(!
bs
.
s
.
nŸ_found
)

2385 
îr‹
 = 
	`pxt4_x©å_block_£t
(
h™dÀ
, 
öode
, &
i
, &
bs
);

2387 
îr‹
 = 0;

2389 i‡(!
is
.
s
.
nŸ_found
 && 
	`pxt4_x©å_vÆue_ßme
(&is.s, &
i
))

2390 
˛ónup
;

2391 i‡(!
bs
.
s
.
nŸ_found
 && 
	`pxt4_x©å_vÆue_ßme
(&bs.s, &
i
))

2392 
˛ónup
;

2394 i‡(
	`pxt4_has_„©uª_ó_öode
(
öode
->
i_sb
) &&

2395 (
	`PXT4_XATTR_SIZE
(
i
.
vÆue_Àn
) >

2396 
	`PXT4_XATTR_MIN_LARGE_EA_SIZE
(
öode
->
i_sb
->
s_blocksize
)))

2397 
i
.
ö_öode
 = 1;

2398 
ªåy_öode
:

2399 
îr‹
 = 
	`pxt4_x©å_ibody_£t
(
h™dÀ
, 
öode
, &
i
, &
is
);

2400 i‡(!
îr‹
 && !
bs
.
s
.
nŸ_found
) {

2401 
i
.
vÆue
 = 
NULL
;

2402 
îr‹
 = 
	`pxt4_x©å_block_£t
(
h™dÀ
, 
öode
, &
i
, &
bs
);

2403 } i‡(
îr‹
 =-
ENOSPC
) {

2404 i‡(
	`PXT4_I
(
öode
)->
i_fûe_a˛
 && !
bs
.
s
.
ba£
) {

2405 
	`bªl£
(
bs
.
bh
);

2406 
bs
.
bh
 = 
NULL
;

2407 
îr‹
 = 
	`pxt4_x©å_block_föd
(
öode
, &
i
, &
bs
);

2408 i‡(
îr‹
)

2409 
˛ónup
;

2411 
îr‹
 = 
	`pxt4_x©å_block_£t
(
h™dÀ
, 
öode
, &
i
, &
bs
);

2412 i‡(!
îr‹
 && !
is
.
s
.
nŸ_found
) {

2413 
i
.
vÆue
 = 
NULL
;

2414 
îr‹
 = 
	`pxt4_x©å_ibody_£t
(
h™dÀ
, 
öode
, &
i
,

2415 &
is
);

2416 } i‡(
îr‹
 =-
ENOSPC
) {

2421 i‡(
	`pxt4_has_„©uª_ó_öode
(
öode
->
i_sb
) &&

2422 
i
.
vÆue_Àn
 && !i.
ö_öode
) {

2423 
i
.
ö_öode
 = 1;

2424 
ªåy_öode
;

2429 i‡(!
îr‹
) {

2430 
	`pxt4_x©å_upd©e_su≥r_block
(
h™dÀ
, 
öode
->
i_sb
);

2431 
öode
->
i_˘ime
 = 
	`cuºít_time
(inode);

2432 i‡(!
vÆue
)

2433 
no_ex∑nd
 = 0;

2434 
îr‹
 = 
	`pxt4_m¨k_ûoc_dúty
(
h™dÀ
, 
öode
, &
is
.
ûoc
);

2439 
is
.
ûoc
.
bh
 = 
NULL
;

2440 i‡(
	`IS_SYNC
(
öode
))

2441 
	`pxt4_h™dÀ_sync
(
h™dÀ
);

2444 
˛ónup
:

2445 
	`bªl£
(
is
.
ûoc
.
bh
);

2446 
	`bªl£
(
bs
.
bh
);

2447 
	`pxt4_wrôe_u∆ock_x©å
(
öode
, &
no_ex∑nd
);

2448  
îr‹
;

2449 
	}
}

2451 
	$pxt4_x©å_£t_¸edôs
(
öode
 *öode, 
size_t
 
vÆue_Àn
,

2452 
boﬁ
 
is_¸óã
, *
¸edôs
)

2454 
buf„r_hód
 *
bh
;

2455 
îr
;

2457 *
¸edôs
 = 0;

2459 i‡(!
	`PXT4_SB
(
öode
->
i_sb
)->
s_jou∫Æ
)

2462 
	`down_ªad
(&
	`PXT4_I
(
öode
)->
x©å_£m
);

2464 
bh
 = 
	`pxt4_x©å_gë_block
(
öode
);

2465 i‡(
	`IS_ERR
(
bh
)) {

2466 
îr
 = 
	`PTR_ERR
(
bh
);

2468 *
¸edôs
 = 
	`__pxt4_x©å_£t_¸edôs
(
öode
->
i_sb
, inode, 
bh
,

2469 
vÆue_Àn
, 
is_¸óã
);

2470 
	`bªl£
(
bh
);

2471 
îr
 = 0;

2474 
	`up_ªad
(&
	`PXT4_I
(
öode
)->
x©å_£m
);

2475  
îr
;

2476 
	}
}

2487 
	$pxt4_x©å_£t
(
öode
 *öode, 
«me_ödex
, c⁄° *
«me
,

2488 c⁄° *
vÆue
, 
size_t
 
vÆue_Àn
, 
Êags
)

2490 
h™dÀ_t
 *
h™dÀ
;

2491 
su≥r_block
 *
sb
 = 
öode
->
i_sb
;

2492 
îr‹
, 
ªåõs
 = 0;

2493 
¸edôs
;

2495 
îr‹
 = 
	`dquŸ_öôülize
(
öode
);

2496 i‡(
îr‹
)

2497  
îr‹
;

2499 
ªåy
:

2500 
îr‹
 = 
	`pxt4_x©å_£t_¸edôs
(
öode
, 
vÆue_Àn
, 
Êags
 & 
XATTR_CREATE
,

2501 &
¸edôs
);

2502 i‡(
îr‹
)

2503  
îr‹
;

2505 
h™dÀ
 = 
	`pxt4_jou∫Æ_°¨t
(
öode
, 
PXT4_HT_XATTR
, 
¸edôs
);

2506 i‡(
	`IS_ERR
(
h™dÀ
)) {

2507 
îr‹
 = 
	`PTR_ERR
(
h™dÀ
);

2509 
îr‹2
;

2511 
îr‹
 = 
	`pxt4_x©å_£t_h™dÀ
(
h™dÀ
, 
öode
, 
«me_ödex
, 
«me
,

2512 
vÆue
, 
vÆue_Àn
, 
Êags
);

2513 
îr‹2
 = 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

2514 i‡(
îr‹
 =-
ENOSPC
 &&

2515 
	`pxt4_should_ªåy_Æloc
(
sb
, &
ªåõs
))

2516 
ªåy
;

2517 i‡(
îr‹
 == 0)

2518 
îr‹
 = 
îr‹2
;

2521  
îr‹
;

2522 
	}
}

2528 
	$pxt4_x©å_shi·_íåõs
(
pxt4_x©å_íåy
 *
íåy
,

2529 
vÆue_offs_shi·
, *
to
,

2530 *
‰om
, 
size_t
 
n
)

2532 
pxt4_x©å_íåy
 *
œ°
 = 
íåy
;

2533 
√w_offs
;

2536 
	`BUG_ON
(
vÆue_offs_shi·
 > 0);

2539 ; !
	`IS_LAST_ENTRY
(
œ°
);Üa° = 
	`PXT4_XATTR_NEXT
(last)) {

2540 i‡(!
œ°
->
e_vÆue_öum
 &&Üa°->
e_vÆue_size
) {

2541 
√w_offs
 = 
	`À16_to_˝u
(
œ°
->
e_vÆue_offs
) +

2542 
vÆue_offs_shi·
;

2543 
œ°
->
e_vÆue_offs
 = 
	`˝u_to_À16
(
√w_offs
);

2547 
	`memmove
(
to
, 
‰om
, 
n
);

2548 
	}
}

2553 
	$pxt4_x©å_move_to_block
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *inode,

2554 
pxt4_öode
 *
øw_öode
,

2555 
pxt4_x©å_íåy
 *
íåy
)

2557 
pxt4_x©å_ibody_föd
 *
is
 = 
NULL
;

2558 
pxt4_x©å_block_föd
 *
bs
 = 
NULL
;

2559 *
buf„r
 = 
NULL
, *
b_íåy_«me
 = NULL;

2560 
size_t
 
vÆue_size
 = 
	`À32_to_˝u
(
íåy
->
e_vÆue_size
);

2561 
pxt4_x©å_öfo
 
i
 = {

2562 .
vÆue
 = 
NULL
,

2563 .
vÆue_Àn
 = 0,

2564 .
«me_ödex
 = 
íåy
->
e_«me_ödex
,

2565 .
ö_öode
 = !!
íåy
->
e_vÆue_öum
,

2567 
pxt4_x©å_ibody_hódî
 *
hódî
 = 
	`IHDR
(
öode
, 
øw_öode
);

2568 
îr‹
;

2570 
is
 = 
	`kzÆloc
((
pxt4_x©å_ibody_föd
), 
GFP_NOFS
);

2571 
bs
 = 
	`kzÆloc
((
pxt4_x©å_block_föd
), 
GFP_NOFS
);

2572 
buf„r
 = 
	`kmÆloc
(
vÆue_size
, 
GFP_NOFS
);

2573 
b_íåy_«me
 = 
	`kmÆloc
(
íåy
->
e_«me_Àn
 + 1, 
GFP_NOFS
);

2574 i‡(!
is
 || !
bs
 || !
buf„r
 || !
b_íåy_«me
) {

2575 
îr‹
 = -
ENOMEM
;

2576 
out
;

2579 
is
->
s
.
nŸ_found
 = -
ENODATA
;

2580 
bs
->
s
.
nŸ_found
 = -
ENODATA
;

2581 
is
->
ûoc
.
bh
 = 
NULL
;

2582 
bs
->
bh
 = 
NULL
;

2585 i‡(
íåy
->
e_vÆue_öum
) {

2586 
îr‹
 = 
	`pxt4_x©å_öode_gë
(
öode
, 
íåy
, 
buf„r
, 
vÆue_size
);

2587 i‡(
îr‹
)

2588 
out
;

2590 
size_t
 
vÆue_offs
 = 
	`À16_to_˝u
(
íåy
->
e_vÆue_offs
);

2591 
	`mem˝y
(
buf„r
, (*)
	`IFIRST
(
hódî
Ë+ 
vÆue_offs
, 
vÆue_size
);

2594 
	`mem˝y
(
b_íåy_«me
, 
íåy
->
e_«me
,É¡ry->
e_«me_Àn
);

2595 
b_íåy_«me
[
íåy
->
e_«me_Àn
] = '\0';

2596 
i
.
«me
 = 
b_íåy_«me
;

2598 
îr‹
 = 
	`pxt4_gë_öode_loc
(
öode
, &
is
->
ûoc
);

2599 i‡(
îr‹
)

2600 
out
;

2602 
îr‹
 = 
	`pxt4_x©å_ibody_föd
(
öode
, &
i
, 
is
);

2603 i‡(
îr‹
)

2604 
out
;

2607 
îr‹
 = 
	`pxt4_x©å_ibody_£t
(
h™dÀ
, 
öode
, &
i
, 
is
);

2608 i‡(
îr‹
)

2609 
out
;

2611 
i
.
vÆue
 = 
buf„r
;

2612 
i
.
vÆue_Àn
 = 
vÆue_size
;

2613 
îr‹
 = 
	`pxt4_x©å_block_föd
(
öode
, &
i
, 
bs
);

2614 i‡(
îr‹
)

2615 
out
;

2618 
îr‹
 = 
	`pxt4_x©å_block_£t
(
h™dÀ
, 
öode
, &
i
, 
bs
);

2619 i‡(
îr‹
)

2620 
out
;

2621 
îr‹
 = 0;

2622 
out
:

2623 
	`k‰ì
(
b_íåy_«me
);

2624 
	`k‰ì
(
buf„r
);

2625 i‡(
is
)

2626 
	`bªl£
(
is
->
ûoc
.
bh
);

2627 i‡(
bs
)

2628 
	`bªl£
(
bs
->
bh
);

2629 
	`k‰ì
(
is
);

2630 
	`k‰ì
(
bs
);

2632  
îr‹
;

2633 
	}
}

2635 
	$pxt4_x©å_make_öode_•a˚
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *inode,

2636 
pxt4_öode
 *
øw_öode
,

2637 
isize_diff
, 
size_t
 
i‰ì
,

2638 
size_t
 
b‰ì
, *
tŸÆ_öo
)

2640 
pxt4_x©å_ibody_hódî
 *
hódî
 = 
	`IHDR
(
öode
, 
øw_öode
);

2641 
pxt4_x©å_íåy
 *
smÆl_íåy
;

2642 
pxt4_x©å_íåy
 *
íåy
;

2643 
pxt4_x©å_íåy
 *
œ°
;

2644 
íåy_size
;

2645 
tŸÆ_size
;

2646 
mö_tŸÆ_size
;

2647 
îr‹
;

2649 
isize_diff
 > 
i‰ì
) {

2650 
íåy
 = 
NULL
;

2651 
smÆl_íåy
 = 
NULL
;

2652 
mö_tŸÆ_size
 = ~0U;

2653 
œ°
 = 
	`IFIRST
(
hódî
);

2655 ; !
	`IS_LAST_ENTRY
(
œ°
);Üa° = 
	`PXT4_XATTR_NEXT
(last)) {

2657 i‡((
œ°
->
e_«me_Àn
 == 4) &&

2658 (
œ°
->
e_«me_ödex
 =
PXT4_XATTR_INDEX_SYSTEM
) &&

2659 !
	`memcmp
(
œ°
->
e_«me
, "data", 4))

2661 
tŸÆ_size
 = 
	`PXT4_XATTR_LEN
(
œ°
->
e_«me_Àn
);

2662 i‡(!
œ°
->
e_vÆue_öum
)

2663 
tŸÆ_size
 +
	`PXT4_XATTR_SIZE
(

2664 
	`À32_to_˝u
(
œ°
->
e_vÆue_size
));

2665 i‡(
tŸÆ_size
 <
b‰ì
 &&

2666 
tŸÆ_size
 < 
mö_tŸÆ_size
) {

2667 i‡(
tŸÆ_size
 + 
i‰ì
 < 
isize_diff
) {

2668 
smÆl_íåy
 = 
œ°
;

2670 
íåy
 = 
œ°
;

2671 
mö_tŸÆ_size
 = 
tŸÆ_size
;

2676 i‡(
íåy
 =
NULL
) {

2677 i‡(
smÆl_íåy
 =
NULL
)

2678  -
ENOSPC
;

2679 
íåy
 = 
smÆl_íåy
;

2682 
íåy_size
 = 
	`PXT4_XATTR_LEN
(
íåy
->
e_«me_Àn
);

2683 
tŸÆ_size
 = 
íåy_size
;

2684 i‡(!
íåy
->
e_vÆue_öum
)

2685 
tŸÆ_size
 +
	`PXT4_XATTR_SIZE
(

2686 
	`À32_to_˝u
(
íåy
->
e_vÆue_size
));

2687 
îr‹
 = 
	`pxt4_x©å_move_to_block
(
h™dÀ
, 
öode
, 
øw_öode
,

2688 
íåy
);

2689 i‡(
îr‹
)

2690  
îr‹
;

2692 *
tŸÆ_öo
 -
íåy_size
;

2693 
i‰ì
 +
tŸÆ_size
;

2694 
b‰ì
 -
tŸÆ_size
;

2698 
	}
}

2704 
	$pxt4_ex∑nd_exåa_isize_ó
(
öode
 *öode, 
√w_exåa_isize
,

2705 
pxt4_öode
 *
øw_öode
, 
h™dÀ_t
 *
h™dÀ
)

2707 
pxt4_x©å_ibody_hódî
 *
hódî
;

2708 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
öode
->
i_sb
);

2709 
m¡_cou¡
;

2710 
size_t
 
mö_offs
;

2711 
size_t
 
i‰ì
, 
b‰ì
;

2712 
tŸÆ_öo
;

2713 *
ba£
, *
íd
;

2714 
îr‹
 = 0, 
åõd_mö_exåa_isize
 = 0;

2715 
s_mö_exåa_isize
 = 
	`À16_to_˝u
(
sbi
->
s_es
->s_min_extra_isize);

2716 
isize_diff
;

2718 
ªåy
:

2719 
isize_diff
 = 
√w_exåa_isize
 - 
	`PXT4_I
(
öode
)->
i_exåa_isize
;

2720 i‡(
	`PXT4_I
(
öode
)->
i_exåa_isize
 >
√w_exåa_isize
)

2723 
hódî
 = 
	`IHDR
(
öode
, 
øw_öode
);

2730 
ba£
 = 
	`IFIRST
(
hódî
);

2731 
íd
 = (*)
øw_öode
 + 
	`PXT4_SB
(
öode
->
i_sb
)->
s_öode_size
;

2732 
mö_offs
 = 
íd
 - 
ba£
;

2733 
tŸÆ_öo
 = (
pxt4_x©å_ibody_hódî
Ë+ (
u32
);

2735 
îr‹
 = 
	`x©å_check_öode
(
öode
, 
hódî
, 
íd
);

2736 i‡(
îr‹
)

2737 
˛ónup
;

2739 
i‰ì
 = 
	`pxt4_x©å_‰ì_•a˚
(
ba£
, &
mö_offs
, ba£, &
tŸÆ_öo
);

2740 i‡(
i‰ì
 >
isize_diff
)

2741 
shi·
;

2747 i‡(
	`PXT4_I
(
öode
)->
i_fûe_a˛
) {

2748 
buf„r_hód
 *
bh
;

2750 
bh
 = 
	`pxt4_sb_bªad
(
öode
->
i_sb
, 
	`PXT4_I
(öode)->
i_fûe_a˛
, 
REQ_PRIO
);

2751 i‡(
	`IS_ERR
(
bh
)) {

2752 
îr‹
 = 
	`PTR_ERR
(
bh
);

2753 
˛ónup
;

2755 
îr‹
 = 
	`pxt4_x©å_check_block
(
öode
, 
bh
);

2756 i‡(
îr‹
) {

2757 
	`bªl£
(
bh
);

2758 
˛ónup
;

2760 
ba£
 = 
	`BHDR
(
bh
);

2761 
íd
 = 
bh
->
b_d©a
 + bh->
b_size
;

2762 
mö_offs
 = 
íd
 - 
ba£
;

2763 
b‰ì
 = 
	`pxt4_x©å_‰ì_•a˚
(
	`BFIRST
(
bh
), &
mö_offs
, 
ba£
,

2764 
NULL
);

2765 
	`bªl£
(
bh
);

2766 i‡(
b‰ì
 + 
i‰ì
 < 
isize_diff
) {

2767 i‡(!
åõd_mö_exåa_isize
 && 
s_mö_exåa_isize
) {

2768 
åõd_mö_exåa_isize
++;

2769 
√w_exåa_isize
 = 
s_mö_exåa_isize
;

2770 
ªåy
;

2772 
îr‹
 = -
ENOSPC
;

2773 
˛ónup
;

2776 
b‰ì
 = 
öode
->
i_sb
->
s_blocksize
;

2779 
îr‹
 = 
	`pxt4_x©å_make_öode_•a˚
(
h™dÀ
, 
öode
, 
øw_öode
,

2780 
isize_diff
, 
i‰ì
, 
b‰ì
,

2781 &
tŸÆ_öo
);

2782 i‡(
îr‹
) {

2783 i‡(
îr‹
 =-
ENOSPC
 && !
åõd_mö_exåa_isize
 &&

2784 
s_mö_exåa_isize
) {

2785 
åõd_mö_exåa_isize
++;

2786 
√w_exåa_isize
 = 
s_mö_exåa_isize
;

2787 
ªåy
;

2789 
˛ónup
;

2791 
shi·
:

2793 
	`pxt4_x©å_shi·_íåõs
(
	`IFIRST
(
hódî
), 
	`PXT4_I
(
öode
)->
i_exåa_isize


2794 - 
√w_exåa_isize
, (*)
øw_öode
 +

2795 
PXT4_GOOD_OLD_INODE_SIZE
 + 
√w_exåa_isize
,

2796 (*)
hódî
, 
tŸÆ_öo
);

2797 
	`PXT4_I
(
öode
)->
i_exåa_isize
 = 
√w_exåa_isize
;

2799 
˛ónup
:

2800 i‡(
îr‹
 && (
m¡_cou¡
 !
	`À16_to_˝u
(
sbi
->
s_es
->
s_m¡_cou¡
))) {

2801 
	`pxt4_w¨nög
(
öode
->
i_sb
, "UnableÅoÉxpand inode %lu. Delete some EAs orÑunÉ2fsck.",

2802 
öode
->
i_öo
);

2803 
m¡_cou¡
 = 
	`À16_to_˝u
(
sbi
->
s_es
->
s_m¡_cou¡
);

2805  
îr‹
;

2806 
	}
}

2808 
	#EIA_INCR
 16

	)

2809 
	#EIA_MASK
 (
EIA_INCR
 - 1)

	)

2816 
	$pxt4_ex∑nd_öode_¨øy
(
pxt4_x©å_öode_¨øy
 **
ó_öode_¨øy
,

2817 
öode
 *inode)

2819 i‡(*
ó_öode_¨øy
 =
NULL
) {

2824 (*
ó_öode_¨øy
) =

2825 
	`kmÆloc
(
	`off£tof
(
pxt4_x©å_öode_¨øy
,

2826 
öodes
[
EIA_MASK
]),

2827 
GFP_NOFS
);

2828 i‡(*
ó_öode_¨øy
 =
NULL
)

2829  -
ENOMEM
;

2830 (*
ó_öode_¨øy
)->
cou¡
 = 0;

2831 } i‡(((*
ó_öode_¨øy
)->
cou¡
 & 
EIA_MASK
) == EIA_MASK) {

2833 
pxt4_x©å_öode_¨øy
 *
√w_¨øy
 = 
NULL
;

2834 
cou¡
 = (*
ó_öode_¨øy
)->count;

2837 
√w_¨øy
 = 
	`kmÆloc
(

2838 
	`off£tof
(
pxt4_x©å_öode_¨øy
,

2839 
öodes
[
cou¡
 + 
EIA_INCR
]),

2840 
GFP_NOFS
);

2841 i‡(
√w_¨øy
 =
NULL
)

2842  -
ENOMEM
;

2843 
	`mem˝y
(
√w_¨øy
, *
ó_öode_¨øy
,

2844 
	`off£tof
(
pxt4_x©å_öode_¨øy
, 
öodes
[
cou¡
]));

2845 
	`k‰ì
(*
ó_öode_¨øy
);

2846 *
ó_öode_¨øy
 = 
√w_¨øy
;

2848 (*
ó_öode_¨øy
)->
öodes
[(*ó_öode_¨øy)->
cou¡
++] = 
öode
;

2850 
	}
}

2861 
	$pxt4_x©å_dñëe_öode
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *inode,

2862 
pxt4_x©å_öode_¨øy
 **
ó_öode_¨øy
,

2863 
exåa_¸edôs
)

2865 
buf„r_hód
 *
bh
 = 
NULL
;

2866 
pxt4_x©å_ibody_hódî
 *
hódî
;

2867 
pxt4_ûoc
 
ûoc
 = { .
bh
 = 
NULL
 };

2868 
pxt4_x©å_íåy
 *
íåy
;

2869 
öode
 *
ó_öode
;

2870 
îr‹
;

2872 
îr‹
 = 
	`pxt4_x©å_ísuª_¸edôs
(
h™dÀ
, 
öode
, 
exåa_¸edôs
,

2873 
NULL
 ,

2874 
Ál£
 ,

2875 
Ál£
 );

2876 i‡(
îr‹
) {

2877 
	`PXT4_ERROR_INODE
(
öode
, "ísuª cªdô†”º‹ %d)", 
îr‹
);

2878 
˛ónup
;

2881 i‡(
	`pxt4_has_„©uª_ó_öode
(
öode
->
i_sb
) &&

2882 
	`pxt4_ã°_öode_°©e
(
öode
, 
PXT4_STATE_XATTR
)) {

2884 
îr‹
 = 
	`pxt4_gë_öode_loc
(
öode
, &
ûoc
);

2885 i‡(
îr‹
) {

2886 
	`PXT4_ERROR_INODE
(
öode
, "öodêlo¯”º‹ %d)", 
îr‹
);

2887 
˛ónup
;

2890 
îr‹
 = 
	`pxt4_jou∫Æ_gë_wrôe_ac˚ss
(
h™dÀ
, 
ûoc
.
bh
);

2891 i‡(
îr‹
) {

2892 
	`PXT4_ERROR_INODE
(
öode
, "writeáccess (error %d)",

2893 
îr‹
);

2894 
˛ónup
;

2897 
hódî
 = 
	`IHDR
(
öode
, 
	`pxt4_øw_öode
(&
ûoc
));

2898 i‡(
hódî
->
h_magic
 =
	`˝u_to_À32
(
PXT4_XATTR_MAGIC
))

2899 
	`pxt4_x©å_öode_dec_ªf_Æl
(
h™dÀ
, 
öode
, 
ûoc
.
bh
,

2900 
	`IFIRST
(
hódî
),

2901 
Ál£
 ,

2902 
ó_öode_¨øy
,

2903 
exåa_¸edôs
,

2904 
Ál£
 );

2907 i‡(
	`PXT4_I
(
öode
)->
i_fûe_a˛
) {

2908 
bh
 = 
	`pxt4_sb_bªad
(
öode
->
i_sb
, 
	`PXT4_I
(öode)->
i_fûe_a˛
, 
REQ_PRIO
);

2909 i‡(
	`IS_ERR
(
bh
)) {

2910 
îr‹
 = 
	`PTR_ERR
(
bh
);

2911 i‡(
îr‹
 =-
EIO
)

2912 
	`PXT4_ERROR_INODE
(
öode
, "block %lluÑeadÉrror",

2913 
	`PXT4_I
(
öode
)->
i_fûe_a˛
);

2914 
bh
 = 
NULL
;

2915 
˛ónup
;

2917 
îr‹
 = 
	`pxt4_x©å_check_block
(
öode
, 
bh
);

2918 i‡(
îr‹
)

2919 
˛ónup
;

2921 i‡(
	`pxt4_has_„©uª_ó_öode
(
öode
->
i_sb
)) {

2922 
íåy
 = 
	`BFIRST
(
bh
); !
	`IS_LAST_ENTRY
(entry);

2923 
íåy
 = 
	`PXT4_XATTR_NEXT
(entry)) {

2924 i‡(!
íåy
->
e_vÆue_öum
)

2926 
îr‹
 = 
	`pxt4_x©å_öode_igë
(
öode
,

2927 
	`À32_to_˝u
(
íåy
->
e_vÆue_öum
),

2928 
	`À32_to_˝u
(
íåy
->
e_hash
),

2929 &
ó_öode
);

2930 i‡(
îr‹
)

2932 
	`pxt4_x©å_öode_‰ì_quŸa
(
öode
, 
ó_öode
,

2933 
	`À32_to_˝u
(
íåy
->
e_vÆue_size
));

2934 
	`ùut
(
ó_öode
);

2939 
	`pxt4_x©å_ªÀa£_block
(
h™dÀ
, 
öode
, 
bh
, 
ó_öode_¨øy
,

2940 
exåa_¸edôs
);

2945 
	`PXT4_I
(
öode
)->
i_fûe_a˛
 = 0;

2946 
îr‹
 = 
	`pxt4_m¨k_öode_dúty
(
h™dÀ
, 
öode
);

2947 i‡(
îr‹
) {

2948 
	`PXT4_ERROR_INODE
(
öode
, "mark inode dirty (error %d)",

2949 
îr‹
);

2950 
˛ónup
;

2953 
îr‹
 = 0;

2954 
˛ónup
:

2955 
	`bªl£
(
ûoc
.
bh
);

2956 
	`bªl£
(
bh
);

2957  
îr‹
;

2958 
	}
}

2960 
	$pxt4_x©å_öode_¨øy_‰ì
(
pxt4_x©å_öode_¨øy
 *
ó_öode_¨øy
)

2962 
idx
;

2964 i‡(
ó_öode_¨øy
 =
NULL
)

2967 
idx
 = 0; idx < 
ó_öode_¨øy
->
cou¡
; ++idx)

2968 
	`ùut
(
ó_öode_¨øy
->
öodes
[
idx
]);

2969 
	`k‰ì
(
ó_öode_¨øy
);

2970 
	}
}

2981 
	$pxt4_x©å_block_ˇche_ö£π
(
mb_ˇche
 *
ó_block_ˇche
,

2982 
buf„r_hód
 *
bh
)

2984 
pxt4_x©å_hódî
 *
hódî
 = 
	`BHDR
(
bh
);

2985 
__u32
 
hash
 = 
	`À32_to_˝u
(
hódî
->
h_hash
);

2986 
ªußbÀ
 = 
	`À32_to_˝u
(
hódî
->
h_ªfcou¡
) <

2987 
PXT4_XATTR_REFCOUNT_MAX
;

2988 
îr‹
;

2990 i‡(!
ó_block_ˇche
)

2992 
îr‹
 = 
	`mb_ˇche_íåy_¸óã
(
ó_block_ˇche
, 
GFP_NOFS
, 
hash
,

2993 
bh
->
b_blockƒ
, 
ªußbÀ
);

2994 i‡(
îr‹
) {

2995 i‡(
îr‹
 =-
EBUSY
)

2996 
	`ó_bdebug
(
bh
, "already in cache");

2998 
	`ó_bdebug
(
bh
, "ö£πög [%x]", ()
hash
);

2999 
	}
}

3010 
	$pxt4_x©å_cmp
(
pxt4_x©å_hódî
 *
hódî1
,

3011 
pxt4_x©å_hódî
 *
hódî2
)

3013 
pxt4_x©å_íåy
 *
íåy1
, *
íåy2
;

3015 
íåy1
 = 
	`ENTRY
(
hódî1
+1);

3016 
íåy2
 = 
	`ENTRY
(
hódî2
+1);

3017 !
	`IS_LAST_ENTRY
(
íåy1
)) {

3018 i‡(
	`IS_LAST_ENTRY
(
íåy2
))

3020 i‡(
íåy1
->
e_hash
 !
íåy2
->e_hash ||

3021 
íåy1
->
e_«me_ödex
 !
íåy2
->e_name_index ||

3022 
íåy1
->
e_«me_Àn
 !
íåy2
->e_name_len ||

3023 
íåy1
->
e_vÆue_size
 !
íåy2
->e_value_size ||

3024 
íåy1
->
e_vÆue_öum
 !
íåy2
->e_value_inum ||

3025 
	`memcmp
(
íåy1
->
e_«me
, 
íåy2
->e_«me,É¡ry1->
e_«me_Àn
))

3027 i‡(!
íåy1
->
e_vÆue_öum
 &&

3028 
	`memcmp
((*)
hódî1
 + 
	`À16_to_˝u
(
íåy1
->
e_vÆue_offs
),

3029 (*)
hódî2
 + 
	`À16_to_˝u
(
íåy2
->
e_vÆue_offs
),

3030 
	`À32_to_˝u
(
íåy1
->
e_vÆue_size
)))

3033 
íåy1
 = 
	`PXT4_XATTR_NEXT
(entry1);

3034 
íåy2
 = 
	`PXT4_XATTR_NEXT
(entry2);

3036 i‡(!
	`IS_LAST_ENTRY
(
íåy2
))

3039 
	}
}

3049 
buf„r_hód
 *

3050 
	$pxt4_x©å_block_ˇche_föd
(
öode
 *inode,

3051 
pxt4_x©å_hódî
 *
hódî
,

3052 
mb_ˇche_íåy
 **
p˚
)

3054 
__u32
 
hash
 = 
	`À32_to_˝u
(
hódî
->
h_hash
);

3055 
mb_ˇche_íåy
 *
˚
;

3056 
mb_ˇche
 *
ó_block_ˇche
 = 
	`EA_BLOCK_CACHE
(
öode
);

3058 i‡(!
ó_block_ˇche
)

3059  
NULL
;

3060 i‡(!
hódî
->
h_hash
)

3061  
NULL
;

3062 
	`ó_idebug
(
öode
, "lookög f‹ cached block†[%x]", ()
hash
);

3063 
˚
 = 
	`mb_ˇche_íåy_föd_fú°
(
ó_block_ˇche
, 
hash
);

3064 
˚
) {

3065 
buf„r_hód
 *
bh
;

3067 
bh
 = 
	`pxt4_sb_bªad
(
öode
->
i_sb
, 
˚
->
e_vÆue
, 
REQ_PRIO
);

3068 i‡(
	`IS_ERR
(
bh
)) {

3069 i‡(
	`PTR_ERR
(
bh
Ë=-
ENOMEM
)

3070  
NULL
;

3071 
bh
 = 
NULL
;

3072 
	`PXT4_ERROR_INODE
(
öode
, "block %luÑeadÉrror",

3073 ()
˚
->
e_vÆue
);

3074 } i‡(
	`pxt4_x©å_cmp
(
hódî
, 
	`BHDR
(
bh
)) == 0) {

3075 *
p˚
 = 
˚
;

3076  
bh
;

3078 
	`bªl£
(
bh
);

3079 
˚
 = 
	`mb_ˇche_íåy_föd_√xt
(
ó_block_ˇche
, ce);

3081  
NULL
;

3082 
	}
}

3084 
	#NAME_HASH_SHIFT
 5

	)

3085 
	#VALUE_HASH_SHIFT
 16

	)

3092 
__À32
 
	$pxt4_x©å_hash_íåy
(*
«me
, 
size_t
 
«me_Àn
, 
__À32
 *
vÆue
,

3093 
size_t
 
vÆue_cou¡
)

3095 
__u32
 
hash
 = 0;

3097 
«me_Àn
--) {

3098 
hash
 = (hash << 
NAME_HASH_SHIFT
) ^

3099 (
hash
 >> (8*(hashË- 
NAME_HASH_SHIFT
)) ^

3100 *
«me
++;

3102 
vÆue_cou¡
--) {

3103 
hash
 = (hash << 
VALUE_HASH_SHIFT
) ^

3104 (
hash
 >> (8*(hashË- 
VALUE_HASH_SHIFT
)) ^

3105 
	`À32_to_˝u
(*
vÆue
++);

3107  
	`˝u_to_À32
(
hash
);

3108 
	}
}

3110 #unde‡
NAME_HASH_SHIFT


3111 #unde‡
VALUE_HASH_SHIFT


3113 
	#BLOCK_HASH_SHIFT
 16

	)

3120 
	$pxt4_x©å_ªhash
(
pxt4_x©å_hódî
 *
hódî
)

3122 
pxt4_x©å_íåy
 *
hîe
;

3123 
__u32
 
hash
 = 0;

3125 
hîe
 = 
	`ENTRY
(
hódî
+1);

3126 !
	`IS_LAST_ENTRY
(
hîe
)) {

3127 i‡(!
hîe
->
e_hash
) {

3129 
hash
 = 0;

3132 
hash
 = (hash << 
BLOCK_HASH_SHIFT
) ^

3133 (
hash
 >> (8*(hashË- 
BLOCK_HASH_SHIFT
)) ^

3134 
	`À32_to_˝u
(
hîe
->
e_hash
);

3135 
hîe
 = 
	`PXT4_XATTR_NEXT
(here);

3137 
hódî
->
h_hash
 = 
	`˝u_to_À32
(
hash
);

3138 
	}
}

3140 #unde‡
BLOCK_HASH_SHIFT


3142 
	#HASH_BUCKET_BITS
 10

	)

3144 
mb_ˇche
 *

3145 
	$pxt4_x©å_¸óã_ˇche
()

3147  
	`mb_ˇche_¸óã
(
HASH_BUCKET_BITS
);

3148 
	}
}

3150 
	$pxt4_x©å_de°roy_ˇche
(
mb_ˇche
 *
ˇche
)

3152 i‡(
ˇche
)

3153 
	`mb_ˇche_de°roy
(
ˇche
);

3154 
	}
}

	@xattr.h

10 
	~<löux/x©å.h
>

13 
	#PXT4_XATTR_MAGIC
 0xEA020000

	)

16 
	#PXT4_XATTR_REFCOUNT_MAX
 1024

	)

19 
	#PXT4_XATTR_INDEX_USER
 1

	)

20 
	#PXT4_XATTR_INDEX_POSIX_ACL_ACCESS
 2

	)

21 
	#PXT4_XATTR_INDEX_POSIX_ACL_DEFAULT
 3

	)

22 
	#PXT4_XATTR_INDEX_TRUSTED
 4

	)

23 
	#PXT4_XATTR_INDEX_LUSTRE
 5

	)

24 
	#PXT4_XATTR_INDEX_SECURITY
 6

	)

25 
	#PXT4_XATTR_INDEX_SYSTEM
 7

	)

26 
	#PXT4_XATTR_INDEX_RICHACL
 8

	)

27 
	#PXT4_XATTR_INDEX_ENCRYPTION
 9

	)

28 
	#PXT4_XATTR_INDEX_HURD
 10

	)

30 
	spxt4_x©å_hódî
 {

31 
__À32
 
	mh_magic
;

32 
__À32
 
	mh_ªfcou¡
;

33 
__À32
 
	mh_blocks
;

34 
__À32
 
	mh_hash
;

35 
__À32
 
	mh_checksum
;

37 
__u32
 
	mh_ª£rved
[3];

40 
	spxt4_x©å_ibody_hódî
 {

41 
__À32
 
	mh_magic
;

44 
	spxt4_x©å_íåy
 {

45 
__u8
 
	me_«me_Àn
;

46 
__u8
 
	me_«me_ödex
;

47 
__À16
 
	me_vÆue_offs
;

48 
__À32
 
	me_vÆue_öum
;

49 
__À32
 
	me_vÆue_size
;

50 
__À32
 
	me_hash
;

51 
	me_«me
[0];

54 
	#PXT4_XATTR_PAD_BITS
 2

	)

55 
	#PXT4_XATTR_PAD
 (1<<
PXT4_XATTR_PAD_BITS
)

	)

56 
	#PXT4_XATTR_ROUND
 (
PXT4_XATTR_PAD
-1)

	)

57 
	#PXT4_XATTR_LEN
(
«me_Àn
) \

58 (((
«me_Àn
Ë+ 
PXT4_XATTR_ROUND
 + \

59 (
pxt4_x©å_íåy
)Ë& ~
PXT4_XATTR_ROUND
)

	)

60 
	#PXT4_XATTR_NEXT
(
íåy
) \

61 ((
pxt4_x©å_íåy
 *)( \

62 (*)(
íåy
Ë+ 
	`PXT4_XATTR_LEN
(”¡ry)->
e_«me_Àn
)))

	)

63 
	#PXT4_XATTR_SIZE
(
size
) \

64 (((
size
Ë+ 
PXT4_XATTR_ROUND
Ë& ~PXT4_XATTR_ROUND)

	)

66 
	#IHDR
(
öode
, 
øw_öode
) \

67 ((
pxt4_x©å_ibody_hódî
 *) \

68 ((*)
øw_öode
 + \

69 
PXT4_GOOD_OLD_INODE_SIZE
 + \

70 
	`PXT4_I
(
öode
)->
i_exåa_isize
))

	)

71 
	#IFIRST
(
hdr
Ë((
pxt4_x©å_íåy
 *)((hdr)+1))

	)

82 
	#PXT4_XATTR_SIZE_MAX
 (1 << 24)

	)

88 
	#PXT4_XATTR_MIN_LARGE_EA_SIZE
(
b
) \

89 ((
b
Ë- 
	`PXT4_XATTR_LEN
(3Ë- (
pxt4_x©å_hódî
Ë- 4)

	)

91 
	#BHDR
(
bh
Ë((
pxt4_x©å_hódî
 *)((bh)->
b_d©a
))

	)

92 
	#ENTRY
(
±r
Ë((
pxt4_x©å_íåy
 *)’å))

	)

93 
	#BFIRST
(
bh
Ë
	`ENTRY
(
	`BHDR
(bh)+1)

	)

94 
	#IS_LAST_ENTRY
(
íåy
Ë(*(
__u32
 *)”¡ryË=0)

	)

96 
	#PXT4_ZERO_XATTR_VALUE
 ((*)-1)

	)

98 
	spxt4_x©å_öfo
 {

99 c⁄° *
	m«me
;

100 c⁄° *
	mvÆue
;

101 
size_t
 
	mvÆue_Àn
;

102 
	m«me_ödex
;

103 
	mö_öode
;

106 
	spxt4_x©å_£¨ch
 {

107 
pxt4_x©å_íåy
 *
	mfú°
;

108 *
	mba£
;

109 *
	míd
;

110 
pxt4_x©å_íåy
 *
	mhîe
;

111 
	mnŸ_found
;

114 
	spxt4_x©å_ibody_föd
 {

115 
pxt4_x©å_£¨ch
 
	ms
;

116 
pxt4_ûoc
 
	mûoc
;

119 
	spxt4_x©å_öode_¨øy
 {

120 
	mcou¡
;

121 
öode
 *
	möodes
[0];

124 c⁄° 
x©å_h™dÀr
 
pxt4_x©å_u£r_h™dÀr
;

125 c⁄° 
x©å_h™dÀr
 
pxt4_x©å_åu°ed_h™dÀr
;

126 c⁄° 
x©å_h™dÀr
 
pxt4_x©å_£curôy_h™dÀr
;

128 
	#PXT4_XATTR_NAME_ENCRYPTION_CONTEXT
 "c"

	)

139 
ölöe
 
	$pxt4_wrôe_lock_x©å
(
öode
 *öode, *
ßve
)

141 
	`down_wrôe
(&
	`PXT4_I
(
öode
)->
x©å_£m
);

142 *
ßve
 = 
	`pxt4_ã°_öode_°©e
(
öode
, 
PXT4_STATE_NO_EXPAND
);

143 
	`pxt4_£t_öode_°©e
(
öode
, 
PXT4_STATE_NO_EXPAND
);

144 
	}
}

146 
ölöe
 
	$pxt4_wrôe_åylock_x©å
(
öode
 *öode, *
ßve
)

148 i‡(
	`down_wrôe_åylock
(&
	`PXT4_I
(
öode
)->
x©å_£m
) == 0)

150 *
ßve
 = 
	`pxt4_ã°_öode_°©e
(
öode
, 
PXT4_STATE_NO_EXPAND
);

151 
	`pxt4_£t_öode_°©e
(
öode
, 
PXT4_STATE_NO_EXPAND
);

153 
	}
}

155 
ölöe
 
	$pxt4_wrôe_u∆ock_x©å
(
öode
 *öode, *
ßve
)

157 i‡(*
ßve
 == 0)

158 
	`pxt4_˛ór_öode_°©e
(
öode
, 
PXT4_STATE_NO_EXPAND
);

159 
	`up_wrôe
(&
	`PXT4_I
(
öode
)->
x©å_£m
);

160 
	}
}

162 
ssize_t
 
pxt4_li°x©å
(
díåy
 *, *, 
size_t
);

164 
pxt4_x©å_gë
(
öode
 *, , c⁄° *, *, 
size_t
);

165 
pxt4_x©å_£t
(
öode
 *, , c⁄° *, c⁄° *, 
size_t
, );

166 
pxt4_x©å_£t_h™dÀ
(
h™dÀ_t
 *, 
öode
 *, , c⁄° *, c⁄° *, 
size_t
, );

167 
pxt4_x©å_£t_¸edôs
(
öode
 *öode, 
size_t
 
vÆue_Àn
,

168 
boﬁ
 
is_¸óã
, *
¸edôs
);

169 
__pxt4_x©å_£t_¸edôs
(
su≥r_block
 *
sb
, 
öode
 *inode,

170 
buf„r_hód
 *
block_bh
, 
size_t
 
vÆue_Àn
,

171 
boﬁ
 
is_¸óã
);

173 
pxt4_x©å_dñëe_öode
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *inode,

174 
pxt4_x©å_öode_¨øy
 **
¨øy
,

175 
exåa_¸edôs
);

176 
pxt4_x©å_öode_¨øy_‰ì
(
pxt4_x©å_öode_¨øy
 *
¨øy
);

178 
pxt4_ex∑nd_exåa_isize_ó
(
öode
 *öode, 
√w_exåa_isize
,

179 
pxt4_öode
 *
øw_öode
, 
h™dÀ_t
 *
h™dÀ
);

181 c⁄° 
x©å_h™dÀr
 *
pxt4_x©å_h™dÀrs
[];

183 
pxt4_x©å_ibody_föd
(
öode
 *öode, 
pxt4_x©å_öfo
 *
i
,

184 
pxt4_x©å_ibody_föd
 *
is
);

185 
pxt4_x©å_ibody_gë
(
öode
 *öode, 
«me_ödex
,

186 c⁄° *
«me
,

187 *
buf„r
, 
size_t
 
buf„r_size
);

188 
pxt4_x©å_ibody_ölöe_£t
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *inode,

189 
pxt4_x©å_öfo
 *
i
,

190 
pxt4_x©å_ibody_föd
 *
is
);

192 
mb_ˇche
 *
pxt4_x©å_¸óã_ˇche
();

193 
pxt4_x©å_de°roy_ˇche
(
mb_ˇche
 *);

195 #ifde‡
CONFIG_PXT4_FS_SECURITY


196 
pxt4_öô_£curôy
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *inode,

197 
öode
 *
dú
, c⁄° 
q°r
 *qstr);

199 
ölöe
 
	$pxt4_öô_£curôy
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *inode,

200 
öode
 *
dú
, c⁄° 
q°r
 *qstr)

203 
	}
}

206 #ifde‡
CONFIG_LOCKDEP


207 
pxt4_x©å_öode_£t_˛ass
(
öode
 *
ó_öode
);

209 
ölöe
 
	$pxt4_x©å_öode_£t_˛ass
(
öode
 *
ó_öode
Ë{ 
	}
}

212 
pxt4_gë_öode_ußge
(
öode
 *öode, 
qsize_t
 *
ußge
);

	@xattr_security.c

7 
	~<löux/°rög.h
>

8 
	~<löux/fs.h
>

9 
	~<löux/£curôy.h
>

10 
	~<löux/¶ab.h
>

11 
	~"pxt4_jbd3.h
"

12 
	~"pxt4.h
"

13 
	~"x©å.h
"

16 
	$pxt4_x©å_£curôy_gë
(c⁄° 
x©å_h™dÀr
 *
h™dÀr
,

17 
díåy
 *
unu£d
, 
öode
 *inode,

18 c⁄° *
«me
, *
buf„r
, 
size_t
 
size
)

20  
	`pxt4_x©å_gë
(
öode
, 
PXT4_XATTR_INDEX_SECURITY
,

21 
«me
, 
buf„r
, 
size
);

22 
	}
}

25 
	$pxt4_x©å_£curôy_£t
(c⁄° 
x©å_h™dÀr
 *
h™dÀr
,

26 
díåy
 *
unu£d
, 
öode
 *inode,

27 c⁄° *
«me
, c⁄° *
vÆue
,

28 
size_t
 
size
, 
Êags
)

30  
	`pxt4_x©å_£t
(
öode
, 
PXT4_XATTR_INDEX_SECURITY
,

31 
«me
, 
vÆue
, 
size
, 
Êags
);

32 
	}
}

35 
	$pxt4_öôx©ås
(
öode
 *öode, c⁄° 
x©å
 *
x©å_¨øy
,

36 *
fs_öfo
)

38 c⁄° 
x©å
 *xattr;

39 
h™dÀ_t
 *
h™dÀ
 = 
fs_öfo
;

40 
îr
 = 0;

42 
x©å
 = 
x©å_¨øy
; x©å->
«me
 !
NULL
; xattr++) {

43 
îr
 = 
	`pxt4_x©å_£t_h™dÀ
(
h™dÀ
, 
öode
,

44 
PXT4_XATTR_INDEX_SECURITY
,

45 
x©å
->
«me
, x©å->
vÆue
,

46 
x©å
->
vÆue_Àn
, 
XATTR_CREATE
);

47 i‡(
îr
 < 0)

50  
îr
;

51 
	}
}

54 
	$pxt4_öô_£curôy
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *öode, öodê*
dú
,

55 c⁄° 
q°r
 *qstr)

57  
	`£curôy_öode_öô_£curôy
(
öode
, 
dú
, 
q°r
,

58 &
pxt4_öôx©ås
, 
h™dÀ
);

59 
	}
}

61 c⁄° 
x©å_h™dÀr
 
	gpxt4_x©å_£curôy_h™dÀr
 = {

62 .
¥efix
 = 
XATTR_SECURITY_PREFIX
,

63 .
	ggë
 = 
pxt4_x©å_£curôy_gë
,

64 .
	g£t
 = 
pxt4_x©å_£curôy_£t
,

	@xattr_trusted.c

9 
	~<löux/°rög.h
>

10 
	~<löux/ˇ∑bûôy.h
>

11 
	~<löux/fs.h
>

12 
	~"pxt4_jbd3.h
"

13 
	~"pxt4.h
"

14 
	~"x©å.h
"

16 
boﬁ


17 
	$pxt4_x©å_åu°ed_li°
(
díåy
 *dentry)

19  
	`ˇ∑bÀ
(
CAP_SYS_ADMIN
);

20 
	}
}

23 
	$pxt4_x©å_åu°ed_gë
(c⁄° 
x©å_h™dÀr
 *
h™dÀr
,

24 
díåy
 *
unu£d
, 
öode
 *inode,

25 c⁄° *
«me
, *
buf„r
, 
size_t
 
size
)

27  
	`pxt4_x©å_gë
(
öode
, 
PXT4_XATTR_INDEX_TRUSTED
,

28 
«me
, 
buf„r
, 
size
);

29 
	}
}

32 
	$pxt4_x©å_åu°ed_£t
(c⁄° 
x©å_h™dÀr
 *
h™dÀr
,

33 
díåy
 *
unu£d
, 
öode
 *inode,

34 c⁄° *
«me
, c⁄° *
vÆue
,

35 
size_t
 
size
, 
Êags
)

37  
	`pxt4_x©å_£t
(
öode
, 
PXT4_XATTR_INDEX_TRUSTED
,

38 
«me
, 
vÆue
, 
size
, 
Êags
);

39 
	}
}

41 c⁄° 
x©å_h™dÀr
 
	gpxt4_x©å_åu°ed_h™dÀr
 = {

42 .
¥efix
 = 
XATTR_TRUSTED_PREFIX
,

43 .
	gli°
 = 
pxt4_x©å_åu°ed_li°
,

44 .
	ggë
 = 
pxt4_x©å_åu°ed_gë
,

45 .
	g£t
 = 
pxt4_x©å_åu°ed_£t
,

	@xattr_user.c

9 
	~<löux/°rög.h
>

10 
	~<löux/fs.h
>

11 
	~"pxt4_jbd3.h
"

12 
	~"pxt4.h
"

13 
	~"x©å.h
"

15 
boﬁ


16 
	$pxt4_x©å_u£r_li°
(
díåy
 *dentry)

18  
	`ã°_›t
(
díåy
->
d_sb
, 
XATTR_USER
);

19 
	}
}

22 
	$pxt4_x©å_u£r_gë
(c⁄° 
x©å_h™dÀr
 *
h™dÀr
,

23 
díåy
 *
unu£d
, 
öode
 *inode,

24 c⁄° *
«me
, *
buf„r
, 
size_t
 
size
)

26 i‡(!
	`ã°_›t
(
öode
->
i_sb
, 
XATTR_USER
))

27  -
EOPNOTSUPP
;

28  
	`pxt4_x©å_gë
(
öode
, 
PXT4_XATTR_INDEX_USER
,

29 
«me
, 
buf„r
, 
size
);

30 
	}
}

33 
	$pxt4_x©å_u£r_£t
(c⁄° 
x©å_h™dÀr
 *
h™dÀr
,

34 
díåy
 *
unu£d
, 
öode
 *inode,

35 c⁄° *
«me
, c⁄° *
vÆue
,

36 
size_t
 
size
, 
Êags
)

38 i‡(!
	`ã°_›t
(
öode
->
i_sb
, 
XATTR_USER
))

39  -
EOPNOTSUPP
;

40  
	`pxt4_x©å_£t
(
öode
, 
PXT4_XATTR_INDEX_USER
,

41 
«me
, 
vÆue
, 
size
, 
Êags
);

42 
	}
}

44 c⁄° 
x©å_h™dÀr
 
	gpxt4_x©å_u£r_h™dÀr
 = {

45 .
¥efix
 = 
XATTR_USER_PREFIX
,

46 .
	gli°
 = 
pxt4_x©å_u£r_li°
,

47 .
	ggë
 = 
pxt4_x©å_u£r_gë
,

48 .
	g£t
 = 
pxt4_x©å_u£r_£t
,

	@/usr/include/linux/capability.h

14 #i‚de‡
_LINUX_CAPABILITY_H


15 
	#_LINUX_CAPABILITY_H


	)

17 
	~<löux/ty≥s.h
>

30 
	#_LINUX_CAPABILITY_VERSION_1
 0x19980330

	)

31 
	#_LINUX_CAPABILITY_U32S_1
 1

	)

33 
	#_LINUX_CAPABILITY_VERSION_2
 0x20071026

	)

34 
	#_LINUX_CAPABILITY_U32S_2
 2

	)

36 
	#_LINUX_CAPABILITY_VERSION_3
 0x20080522

	)

37 
	#_LINUX_CAPABILITY_U32S_3
 2

	)

39 
	s__u£r_ˇp_hódî_°ru˘
 {

40 
__u32
 
	mvîsi⁄
;

41 
	mpid
;

42 } *
	tˇp_u£r_hódî_t
;

44 
	s__u£r_ˇp_d©a_°ru˘
 {

45 
__u32
 
	mef„˘ive
;

46 
__u32
 
	m≥rmôãd
;

47 
__u32
 
	möhîôabÀ
;

48 } *
	tˇp_u£r_d©a_t
;

51 
	#VFS_CAP_REVISION_MASK
 0xFF000000

	)

52 
	#VFS_CAP_REVISION_SHIFT
 24

	)

53 
	#VFS_CAP_FLAGS_MASK
 ~
VFS_CAP_REVISION_MASK


	)

54 
	#VFS_CAP_FLAGS_EFFECTIVE
 0x000001

	)

56 
	#VFS_CAP_REVISION_1
 0x01000000

	)

57 
	#VFS_CAP_U32_1
 1

	)

58 
	#XATTR_CAPS_SZ_1
 ((
__À32
)*(1 + 2*
VFS_CAP_U32_1
))

	)

60 
	#VFS_CAP_REVISION_2
 0x02000000

	)

61 
	#VFS_CAP_U32_2
 2

	)

62 
	#XATTR_CAPS_SZ_2
 ((
__À32
)*(1 + 2*
VFS_CAP_U32_2
))

	)

64 
	#VFS_CAP_REVISION_3
 0x03000000

	)

65 
	#VFS_CAP_U32_3
 2

	)

66 
	#XATTR_CAPS_SZ_3
 ((
__À32
)*(2 + 2*
VFS_CAP_U32_3
))

	)

68 
	#XATTR_CAPS_SZ
 
XATTR_CAPS_SZ_3


	)

69 
	#VFS_CAP_U32
 
VFS_CAP_U32_3


	)

70 
	#VFS_CAP_REVISION
 
VFS_CAP_REVISION_3


	)

72 
	svfs_ˇp_d©a
 {

73 
__À32
 
	mmagic_ëc
;

75 
__À32
 
	m≥rmôãd
;

76 
__À32
 
	möhîôabÀ
;

77 } 
	md©a
[
VFS_CAP_U32
];

83 
	svfs_ns_ˇp_d©a
 {

84 
__À32
 
	mmagic_ëc
;

86 
__À32
 
	m≥rmôãd
;

87 
__À32
 
	möhîôabÀ
;

88 } 
	md©a
[
VFS_CAP_U32
];

89 
__À32
 
	mroŸid
;

98 
	#_LINUX_CAPABILITY_VERSION
 
_LINUX_CAPABILITY_VERSION_1


	)

99 
	#_LINUX_CAPABILITY_U32S
 
_LINUX_CAPABILITY_U32S_1


	)

111 
	#CAP_CHOWN
 0

	)

117 
	#CAP_DAC_OVERRIDE
 1

	)

123 
	#CAP_DAC_READ_SEARCH
 2

	)

129 
	#CAP_FOWNER
 3

	)

138 
	#CAP_FSETID
 4

	)

144 
	#CAP_KILL
 5

	)

150 
	#CAP_SETGID
 6

	)

155 
	#CAP_SETUID
 7

	)

172 
	#CAP_SETPCAP
 8

	)

176 
	#CAP_LINUX_IMMUTABLE
 9

	)

181 
	#CAP_NET_BIND_SERVICE
 10

	)

185 
	#CAP_NET_BROADCAST
 11

	)

201 
	#CAP_NET_ADMIN
 12

	)

207 
	#CAP_NET_RAW
 13

	)

213 
	#CAP_IPC_LOCK
 14

	)

217 
	#CAP_IPC_OWNER
 15

	)

220 
	#CAP_SYS_MODULE
 16

	)

225 
	#CAP_SYS_RAWIO
 17

	)

229 
	#CAP_SYS_CHROOT
 18

	)

233 
	#CAP_SYS_PTRACE
 19

	)

237 
	#CAP_SYS_PACCT
 20

	)

276 
	#CAP_SYS_ADMIN
 21

	)

280 
	#CAP_SYS_BOOT
 22

	)

289 
	#CAP_SYS_NICE
 23

	)

303 
	#CAP_SYS_RESOURCE
 24

	)

309 
	#CAP_SYS_TIME
 25

	)

314 
	#CAP_SYS_TTY_CONFIG
 26

	)

318 
	#CAP_MKNOD
 27

	)

322 
	#CAP_LEASE
 28

	)

326 
	#CAP_AUDIT_WRITE
 29

	)

330 
	#CAP_AUDIT_CONTROL
 30

	)

332 
	#CAP_SETFCAP
 31

	)

340 
	#CAP_MAC_OVERRIDE
 32

	)

349 
	#CAP_MAC_ADMIN
 33

	)

353 
	#CAP_SYSLOG
 34

	)

357 
	#CAP_WAKE_ALARM
 35

	)

361 
	#CAP_BLOCK_SUSPEND
 36

	)

365 
	#CAP_AUDIT_READ
 37

	)

368 
	#CAP_LAST_CAP
 
CAP_AUDIT_READ


	)

370 
	#ˇp_vÆid
(
x
Ë((xË>0 && (xË<
CAP_LAST_CAP
)

	)

376 
	#CAP_TO_INDEX
(
x
Ë((xË>> 5Ë

	)

377 
	#CAP_TO_MASK
(
x
Ë(1 << ((xË& 31)Ë

	)

	@/usr/include/linux/errno.h

1 
	~<asm/î∫o.h
>

	@/usr/include/linux/falloc.h

2 #i‚de‡
_FALLOC_H_


3 
	#_FALLOC_H_


	)

5 
	#FALLOC_FL_KEEP_SIZE
 0x01

	)

6 
	#FALLOC_FL_PUNCH_HOLE
 0x02

	)

7 
	#FALLOC_FL_NO_HIDE_STALE
 0x04

	)

29 
	#FALLOC_FL_COLLAPSE_RANGE
 0x08

	)

43 
	#FALLOC_FL_ZERO_RANGE
 0x10

	)

60 
	#FALLOC_FL_INSERT_RANGE
 0x20

	)

78 
	#FALLOC_FL_UNSHARE_RANGE
 0x40

	)

	@/usr/include/linux/fcntl.h

2 #i‚de‡
_LINUX_FCNTL_H


3 
	#_LINUX_FCNTL_H


	)

5 
	~<asm/f˙é.h
>

7 
	#F_SETLEASE
 (
F_LINUX_SPECIFIC_BASE
 + 0)

	)

8 
	#F_GETLEASE
 (
F_LINUX_SPECIFIC_BASE
 + 1)

	)

14 
	#F_CANCELLK
 (
F_LINUX_SPECIFIC_BASE
 + 5)

	)

17 
	#F_DUPFD_CLOEXEC
 (
F_LINUX_SPECIFIC_BASE
 + 6)

	)

23 
	#F_NOTIFY
 (
F_LINUX_SPECIFIC_BASE
+2)

	)

28 
	#F_SETPIPE_SZ
 (
F_LINUX_SPECIFIC_BASE
 + 7)

	)

29 
	#F_GETPIPE_SZ
 (
F_LINUX_SPECIFIC_BASE
 + 8)

	)

34 
	#F_ADD_SEALS
 (
F_LINUX_SPECIFIC_BASE
 + 9)

	)

35 
	#F_GET_SEALS
 (
F_LINUX_SPECIFIC_BASE
 + 10)

	)

40 
	#F_SEAL_SEAL
 0x0001

	)

41 
	#F_SEAL_SHRINK
 0x0002

	)

42 
	#F_SEAL_GROW
 0x0004

	)

43 
	#F_SEAL_WRITE
 0x0008

	)

44 
	#F_SEAL_FUTURE_WRITE
 0x0010

	)

52 
	#F_GET_RW_HINT
 (
F_LINUX_SPECIFIC_BASE
 + 11)

	)

53 
	#F_SET_RW_HINT
 (
F_LINUX_SPECIFIC_BASE
 + 12)

	)

54 
	#F_GET_FILE_RW_HINT
 (
F_LINUX_SPECIFIC_BASE
 + 13)

	)

55 
	#F_SET_FILE_RW_HINT
 (
F_LINUX_SPECIFIC_BASE
 + 14)

	)

61 
	#RWF_WRITE_LIFE_NOT_SET
 0

	)

62 
	#RWH_WRITE_LIFE_NONE
 1

	)

63 
	#RWH_WRITE_LIFE_SHORT
 2

	)

64 
	#RWH_WRITE_LIFE_MEDIUM
 3

	)

65 
	#RWH_WRITE_LIFE_LONG
 4

	)

66 
	#RWH_WRITE_LIFE_EXTREME
 5

	)

71 
	#DN_ACCESS
 0x00000001

	)

72 
	#DN_MODIFY
 0x00000002

	)

73 
	#DN_CREATE
 0x00000004

	)

74 
	#DN_DELETE
 0x00000008

	)

75 
	#DN_RENAME
 0x00000010

	)

76 
	#DN_ATTRIB
 0x00000020

	)

77 
	#DN_MULTISHOT
 0x80000000

	)

79 
	#AT_FDCWD
 -100

	)

82 
	#AT_SYMLINK_NOFOLLOW
 0x100

	)

83 
	#AT_REMOVEDIR
 0x200

	)

85 
	#AT_SYMLINK_FOLLOW
 0x400

	)

86 
	#AT_NO_AUTOMOUNT
 0x800

	)

87 
	#AT_EMPTY_PATH
 0x1000

	)

89 
	#AT_STATX_SYNC_TYPE
 0x6000

	)

90 
	#AT_STATX_SYNC_AS_STAT
 0x0000

	)

91 
	#AT_STATX_FORCE_SYNC
 0x2000

	)

92 
	#AT_STATX_DONT_SYNC
 0x4000

	)

94 
	#AT_RECURSIVE
 0x8000

	)

	@/usr/include/linux/fiemap.h

12 #i‚de‡
_LINUX_FIEMAP_H


13 
	#_LINUX_FIEMAP_H


	)

15 
	~<löux/ty≥s.h
>

17 
	sfõm≠_exã¡
 {

18 
__u64
 
	m„_logiˇl
;

20 
__u64
 
	m„_physiˇl
;

22 
__u64
 
	m„_Àngth
;

23 
__u64
 
	m„_ª£rved64
[2];

24 
__u32
 
	m„_Êags
;

25 
__u32
 
	m„_ª£rved
[3];

28 
	sfõm≠
 {

29 
__u64
 
	mfm_°¨t
;

31 
__u64
 
	mfm_Àngth
;

33 
__u32
 
	mfm_Êags
;

34 
__u32
 
	mfm_m≠≥d_exã¡s
;

35 
__u32
 
	mfm_exã¡_cou¡
;

36 
__u32
 
	mfm_ª£rved
;

37 
fõm≠_exã¡
 
	mfm_exã¡s
[0];

40 
	#FIEMAP_MAX_OFFSET
 (~0ULL)

	)

42 
	#FIEMAP_FLAG_SYNC
 0x00000001

	)

43 
	#FIEMAP_FLAG_XATTR
 0x00000002

	)

44 
	#FIEMAP_FLAG_CACHE
 0x00000004

	)

46 
	#FIEMAP_FLAGS_COMPAT
 (
FIEMAP_FLAG_SYNC
 | 
FIEMAP_FLAG_XATTR
)

	)

48 
	#FIEMAP_EXTENT_LAST
 0x00000001

	)

49 
	#FIEMAP_EXTENT_UNKNOWN
 0x00000002

	)

50 
	#FIEMAP_EXTENT_DELALLOC
 0x00000004

	)

52 
	#FIEMAP_EXTENT_ENCODED
 0x00000008

	)

54 
	#FIEMAP_EXTENT_DATA_ENCRYPTED
 0x00000080

	)

56 
	#FIEMAP_EXTENT_NOT_ALIGNED
 0x00000100

	)

58 
	#FIEMAP_EXTENT_DATA_INLINE
 0x00000200

	)

60 
	#FIEMAP_EXTENT_DATA_TAIL
 0x00000400

	)

62 
	#FIEMAP_EXTENT_UNWRITTEN
 0x00000800

	)

64 
	#FIEMAP_EXTENT_MERGED
 0x00001000

	)

67 
	#FIEMAP_EXTENT_SHARED
 0x00002000

	)

	@/usr/include/linux/fs.h

2 #i‚de‡
_LINUX_FS_H


3 
	#_LINUX_FS_H


	)

13 
	~<löux/limôs.h
>

14 
	~<löux/io˘l.h
>

15 
	~<löux/ty≥s.h
>

16 
	~<löux/fs¸y±.h
>

19 
	~<löux/mou¡.h
>

32 #unde‡
NR_OPEN


33 
	#INR_OPEN_CUR
 1024

	)

34 
	#INR_OPEN_MAX
 4096

	)

36 
	#BLOCK_SIZE_BITS
 10

	)

37 
	#BLOCK_SIZE
 (1<<
BLOCK_SIZE_BITS
)

	)

39 
	#SEEK_SET
 0

	)

40 
	#SEEK_CUR
 1

	)

41 
	#SEEK_END
 2

	)

42 
	#SEEK_DATA
 3

	)

43 
	#SEEK_HOLE
 4

	)

44 
	#SEEK_MAX
 
SEEK_HOLE


	)

46 
	#RENAME_NOREPLACE
 (1 << 0Ë

	)

47 
	#RENAME_EXCHANGE
 (1 << 1Ë

	)

48 
	#RENAME_WHITEOUT
 (1 << 2Ë

	)

50 
	sfûe_˛⁄e_ønge
 {

51 
__s64
 
	m§c_fd
;

52 
__u64
 
	m§c_off£t
;

53 
__u64
 
	m§c_Àngth
;

54 
__u64
 
	mde°_off£t
;

57 
	sf°rim_ønge
 {

58 
__u64
 
	m°¨t
;

59 
__u64
 
	mÀn
;

60 
__u64
 
	mmöÀn
;

64 
	#FILE_DEDUPE_RANGE_SAME
 0

	)

65 
	#FILE_DEDUPE_RANGE_DIFFERS
 1

	)

68 
	sfûe_dedu≥_ønge_öfo
 {

69 
__s64
 
	mde°_fd
;

70 
__u64
 
	mde°_off£t
;

71 
__u64
 
	mbyãs_dedu≥d
;

78 
__s32
 
	m°©us
;

79 
__u32
 
	mª£rved
;

83 
	sfûe_dedu≥_ønge
 {

84 
__u64
 
	m§c_off£t
;

85 
__u64
 
	m§c_Àngth
;

86 
__u16
 
	mde°_cou¡
;

87 
__u16
 
	mª£rved1
;

88 
__u32
 
	mª£rved2
;

89 
fûe_dedu≥_ønge_öfo
 
	möfo
[0];

93 
	sfûes_°©_°ru˘
 {

94 
	mƒ_fûes
;

95 
	mƒ_‰ì_fûes
;

96 
	mmax_fûes
;

99 
	söodes_°©_t
 {

100 
	mƒ_öodes
;

101 
	mƒ_unu£d
;

102 
	mdummy
[5];

106 
	#NR_FILE
 8192

	)

111 
	sfsx©å
 {

112 
__u32
 
	mfsx_xÊags
;

113 
__u32
 
	mfsx_extsize
;

114 
__u32
 
	mfsx_√xã¡s
;

115 
__u32
 
	mfsx_¥ojid
;

116 
__u32
 
	mfsx_cowextsize
;

117 
	mfsx_∑d
[8];

123 
	#FS_XFLAG_REALTIME
 0x00000001

	)

124 
	#FS_XFLAG_PREALLOC
 0x00000002

	)

125 
	#FS_XFLAG_IMMUTABLE
 0x00000008

	)

126 
	#FS_XFLAG_APPEND
 0x00000010

	)

127 
	#FS_XFLAG_SYNC
 0x00000020

	)

128 
	#FS_XFLAG_NOATIME
 0x00000040

	)

129 
	#FS_XFLAG_NODUMP
 0x00000080

	)

130 
	#FS_XFLAG_RTINHERIT
 0x00000100

	)

131 
	#FS_XFLAG_PROJINHERIT
 0x00000200

	)

132 
	#FS_XFLAG_NOSYMLINKS
 0x00000400

	)

133 
	#FS_XFLAG_EXTSIZE
 0x00000800

	)

134 
	#FS_XFLAG_EXTSZINHERIT
 0x00001000

	)

135 
	#FS_XFLAG_NODEFRAG
 0x00002000

	)

136 
	#FS_XFLAG_FILESTREAM
 0x00004000

	)

137 
	#FS_XFLAG_DAX
 0x00008000

	)

138 
	#FS_XFLAG_COWEXTSIZE
 0x00010000

	)

139 
	#FS_XFLAG_HASATTR
 0x80000000

	)

144 
	#BLKROSET
 
	`_IO
(0x12,93Ë

	)

145 
	#BLKROGET
 
	`_IO
(0x12,94Ë

	)

146 
	#BLKRRPART
 
	`_IO
(0x12,95Ë

	)

147 
	#BLKGETSIZE
 
	`_IO
(0x12,96Ë

	)

148 
	#BLKFLSBUF
 
	`_IO
(0x12,97Ë

	)

149 
	#BLKRASET
 
	`_IO
(0x12,98Ë

	)

150 
	#BLKRAGET
 
	`_IO
(0x12,99Ë

	)

151 
	#BLKFRASET
 
	`_IO
(0x12,100)

	)

152 
	#BLKFRAGET
 
	`_IO
(0x12,101)

	)

153 
	#BLKSECTSET
 
	`_IO
(0x12,102)

	)

154 
	#BLKSECTGET
 
	`_IO
(0x12,103)

	)

155 
	#BLKSSZGET
 
	`_IO
(0x12,104)

	)

157 
	#BLKPG
 
	`_IO
(0x12,105)

	)

161 
	#BLKELVGET
 
	`_IOR
(0x12,106,
size_t
)

	)

162 
	#BLKELVSET
 
	`_IOW
(0x12,107,
size_t
)

	)

167 
	#BLKBSZGET
 
	`_IOR
(0x12,112,
size_t
)

	)

168 
	#BLKBSZSET
 
	`_IOW
(0x12,113,
size_t
)

	)

169 
	#BLKGETSIZE64
 
	`_IOR
(0x12,114,
size_t
Ë

	)

170 
	#BLKTRACESETUP
 
	`_IOWR
(0x12,115,
blk_u£r_åa˚_£tup
)

	)

171 
	#BLKTRACESTART
 
	`_IO
(0x12,116)

	)

172 
	#BLKTRACESTOP
 
	`_IO
(0x12,117)

	)

173 
	#BLKTRACETEARDOWN
 
	`_IO
(0x12,118)

	)

174 
	#BLKDISCARD
 
	`_IO
(0x12,119)

	)

175 
	#BLKIOMIN
 
	`_IO
(0x12,120)

	)

176 
	#BLKIOOPT
 
	`_IO
(0x12,121)

	)

177 
	#BLKALIGNOFF
 
	`_IO
(0x12,122)

	)

178 
	#BLKPBSZGET
 
	`_IO
(0x12,123)

	)

179 
	#BLKDISCARDZEROES
 
	`_IO
(0x12,124)

	)

180 
	#BLKSECDISCARD
 
	`_IO
(0x12,125)

	)

181 
	#BLKROTATIONAL
 
	`_IO
(0x12,126)

	)

182 
	#BLKZEROOUT
 
	`_IO
(0x12,127)

	)

188 
	#BMAP_IOCTL
 1

	)

189 
	#FIBMAP
 
	`_IO
(0x00,1Ë

	)

190 
	#FIGETBSZ
 
	`_IO
(0x00,2Ë

	)

191 
	#FIFREEZE
 
	`_IOWR
('X', 119, Ë

	)

192 
	#FITHAW
 
	`_IOWR
('X', 120, Ë

	)

193 
	#FITRIM
 
	`_IOWR
('X', 121, 
f°rim_ønge
Ë

	)

194 
	#FICLONE
 
	`_IOW
(0x94, 9, )

	)

195 
	#FICLONERANGE
 
	`_IOW
(0x94, 13, 
fûe_˛⁄e_ønge
)

	)

196 
	#FIDEDUPERANGE
 
	`_IOWR
(0x94, 54, 
fûe_dedu≥_ønge
)

	)

198 
	#FSLABEL_MAX
 256

	)

200 
	#FS_IOC_GETFLAGS
 
	`_IOR
('f', 1, )

	)

201 
	#FS_IOC_SETFLAGS
 
	`_IOW
('f', 2, )

	)

202 
	#FS_IOC_GETVERSION
 
	`_IOR
('v', 1, )

	)

203 
	#FS_IOC_SETVERSION
 
	`_IOW
('v', 2, )

	)

204 
	#FS_IOC_FIEMAP
 
	`_IOWR
('f', 11, 
fõm≠
)

	)

205 
	#FS_IOC32_GETFLAGS
 
	`_IOR
('f', 1, )

	)

206 
	#FS_IOC32_SETFLAGS
 
	`_IOW
('f', 2, )

	)

207 
	#FS_IOC32_GETVERSION
 
	`_IOR
('v', 1, )

	)

208 
	#FS_IOC32_SETVERSION
 
	`_IOW
('v', 2, )

	)

209 
	#FS_IOC_FSGETXATTR
 
	`_IOR
('X', 31, 
fsx©å
)

	)

210 
	#FS_IOC_FSSETXATTR
 
	`_IOW
('X', 32, 
fsx©å
)

	)

211 
	#FS_IOC_GETFSLABEL
 
	`_IOR
(0x94, 49, [
FSLABEL_MAX
])

	)

212 
	#FS_IOC_SETFSLABEL
 
	`_IOW
(0x94, 50, [
FSLABEL_MAX
])

	)

234 
	#FS_SECRM_FL
 0x00000001

	)

235 
	#FS_UNRM_FL
 0x00000002

	)

236 
	#FS_COMPR_FL
 0x00000004

	)

237 
	#FS_SYNC_FL
 0x00000008

	)

238 
	#FS_IMMUTABLE_FL
 0x00000010

	)

239 
	#FS_APPEND_FL
 0x00000020

	)

240 
	#FS_NODUMP_FL
 0x00000040

	)

241 
	#FS_NOATIME_FL
 0x00000080

	)

243 
	#FS_DIRTY_FL
 0x00000100

	)

244 
	#FS_COMPRBLK_FL
 0x00000200

	)

245 
	#FS_NOCOMP_FL
 0x00000400

	)

247 
	#FS_ENCRYPT_FL
 0x00000800

	)

248 
	#FS_BTREE_FL
 0x00001000

	)

249 
	#FS_INDEX_FL
 0x00001000

	)

250 
	#FS_IMAGIC_FL
 0x00002000

	)

251 
	#FS_JOURNAL_DATA_FL
 0x00004000

	)

252 
	#FS_NOTAIL_FL
 0x00008000

	)

253 
	#FS_DIRSYNC_FL
 0x00010000

	)

254 
	#FS_TOPDIR_FL
 0x00020000

	)

255 
	#FS_HUGE_FILE_FL
 0x00040000

	)

256 
	#FS_EXTENT_FL
 0x00080000

	)

257 
	#FS_VERITY_FL
 0x00100000

	)

258 
	#FS_EA_INODE_FL
 0x00200000

	)

259 
	#FS_EOFBLOCKS_FL
 0x00400000

	)

260 
	#FS_NOCOW_FL
 0x00800000

	)

261 
	#FS_INLINE_DATA_FL
 0x10000000

	)

262 
	#FS_PROJINHERIT_FL
 0x20000000

	)

263 
	#FS_CASEFOLD_FL
 0x40000000

	)

264 
	#FS_RESERVED_FL
 0x80000000

	)

266 
	#FS_FL_USER_VISIBLE
 0x0003DFFF

	)

267 
	#FS_FL_USER_MODIFIABLE
 0x000380FF

	)

270 
	#SYNC_FILE_RANGE_WAIT_BEFORE
 1

	)

271 
	#SYNC_FILE_RANGE_WRITE
 2

	)

272 
	#SYNC_FILE_RANGE_WAIT_AFTER
 4

	)

273 
	#SYNC_FILE_RANGE_WRITE_AND_WAIT
 (
SYNC_FILE_RANGE_WRITE
 | \

274 
SYNC_FILE_RANGE_WAIT_BEFORE
 | \

275 
SYNC_FILE_RANGE_WAIT_AFTER
)

	)

281 
	t__bôwi£
 
	t__kî√l_rwf_t
;

284 
	#RWF_HIPRI
 ((
__kî√l_rwf_t
)0x00000001)

	)

287 
	#RWF_DSYNC
 ((
__kî√l_rwf_t
)0x00000002)

	)

290 
	#RWF_SYNC
 ((
__kî√l_rwf_t
)0x00000004)

	)

293 
	#RWF_NOWAIT
 ((
__kî√l_rwf_t
)0x00000008)

	)

296 
	#RWF_APPEND
 ((
__kî√l_rwf_t
)0x00000010)

	)

299 
	#RWF_SUPPORTED
 (
RWF_HIPRI
 | 
RWF_DSYNC
 | 
RWF_SYNC
 | 
RWF_NOWAIT
 |\

300 
RWF_APPEND
)

	)

	@/usr/include/linux/fscrypt.h

8 #i‚de‡
_LINUX_FSCRYPT_H


9 
	#_LINUX_FSCRYPT_H


	)

11 
	~<löux/ty≥s.h
>

14 
	#FSCRYPT_POLICY_FLAGS_PAD_4
 0x00

	)

15 
	#FSCRYPT_POLICY_FLAGS_PAD_8
 0x01

	)

16 
	#FSCRYPT_POLICY_FLAGS_PAD_16
 0x02

	)

17 
	#FSCRYPT_POLICY_FLAGS_PAD_32
 0x03

	)

18 
	#FSCRYPT_POLICY_FLAGS_PAD_MASK
 0x03

	)

19 
	#FSCRYPT_POLICY_FLAG_DIRECT_KEY
 0x04

	)

22 
	#FSCRYPT_MODE_AES_256_XTS
 1

	)

23 
	#FSCRYPT_MODE_AES_256_CTS
 4

	)

24 
	#FSCRYPT_MODE_AES_128_CBC
 5

	)

25 
	#FSCRYPT_MODE_AES_128_CTS
 6

	)

26 
	#FSCRYPT_MODE_ADIANTUM
 9

	)

35 
	#FSCRYPT_POLICY_V1
 0

	)

36 
	#FSCRYPT_KEY_DESCRIPTOR_SIZE
 8

	)

37 
	sfs¸y±_pﬁicy_v1
 {

38 
__u8
 
	mvîsi⁄
;

39 
__u8
 
	mc⁄ã¡s_í¸y±i⁄_mode
;

40 
__u8
 
	mfûíames_í¸y±i⁄_mode
;

41 
__u8
 
	mÊags
;

42 
__u8
 
	mma°î_key_des¸ùt‹
[
FSCRYPT_KEY_DESCRIPTOR_SIZE
];

44 
	#fs¸y±_pﬁicy
 
fs¸y±_pﬁicy_v1


	)

50 
	#FSCRYPT_KEY_DESC_PREFIX
 "fs¸y±:"

	)

51 
	#FSCRYPT_KEY_DESC_PREFIX_SIZE
 8

	)

52 
	#FSCRYPT_MAX_KEY_SIZE
 64

	)

53 
	sfs¸y±_key
 {

54 
__u32
 
	mmode
;

55 
__u8
 
	møw
[
FSCRYPT_MAX_KEY_SIZE
];

56 
__u32
 
	msize
;

62 
	#FSCRYPT_POLICY_V2
 2

	)

63 
	#FSCRYPT_KEY_IDENTIFIER_SIZE
 16

	)

64 
	sfs¸y±_pﬁicy_v2
 {

65 
__u8
 
	mvîsi⁄
;

66 
__u8
 
	mc⁄ã¡s_í¸y±i⁄_mode
;

67 
__u8
 
	mfûíames_í¸y±i⁄_mode
;

68 
__u8
 
	mÊags
;

69 
__u8
 
	m__ª£rved
[4];

70 
__u8
 
	mma°î_key_idítifõr
[
FSCRYPT_KEY_IDENTIFIER_SIZE
];

74 
	sfs¸y±_gë_pﬁicy_ex_¨g
 {

75 
__u64
 
	mpﬁicy_size
;

77 
__u8
 
	mvîsi⁄
;

78 
fs¸y±_pﬁicy_v1
 
	mv1
;

79 
fs¸y±_pﬁicy_v2
 
	mv2
;

80 } 
	mpﬁicy
;

87 
	#FSCRYPT_KEY_SPEC_TYPE_DESCRIPTOR
 1

	)

94 
	#FSCRYPT_KEY_SPEC_TYPE_IDENTIFIER
 2

	)

100 
	sfs¸y±_key_•ecifõr
 {

101 
__u32
 
	mty≥
;

102 
__u32
 
	m__ª£rved
;

104 
__u8
 
	m__ª£rved
[32];

105 
__u8
 
	mdes¸ùt‹
[
FSCRYPT_KEY_DESCRIPTOR_SIZE
];

106 
__u8
 
	midítifõr
[
FSCRYPT_KEY_IDENTIFIER_SIZE
];

107 } 
	mu
;

111 
	sfs¸y±_add_key_¨g
 {

112 
fs¸y±_key_•ecifõr
 
	mkey_•ec
;

113 
__u32
 
	møw_size
;

114 
__u32
 
	m__ª£rved
[9];

115 
__u8
 
	møw
[];

119 
	sfs¸y±_ªmove_key_¨g
 {

120 
fs¸y±_key_•ecifõr
 
	mkey_•ec
;

121 
	#FSCRYPT_KEY_REMOVAL_STATUS_FLAG_FILES_BUSY
 0x00000001

	)

122 
	#FSCRYPT_KEY_REMOVAL_STATUS_FLAG_OTHER_USERS
 0x00000002

	)

123 
__u32
 
	mªmovÆ_°©us_Êags
;

124 
__u32
 
	m__ª£rved
[5];

128 
	sfs¸y±_gë_key_°©us_¨g
 {

130 
fs¸y±_key_•ecifõr
 
	mkey_•ec
;

131 
__u32
 
	m__ª£rved
[6];

134 
	#FSCRYPT_KEY_STATUS_ABSENT
 1

	)

135 
	#FSCRYPT_KEY_STATUS_PRESENT
 2

	)

136 
	#FSCRYPT_KEY_STATUS_INCOMPLETELY_REMOVED
 3

	)

137 
__u32
 
	m°©us
;

138 
	#FSCRYPT_KEY_STATUS_FLAG_ADDED_BY_SELF
 0x00000001

	)

139 
__u32
 
	m°©us_Êags
;

140 
__u32
 
	mu£r_cou¡
;

141 
__u32
 
	m__out_ª£rved
[13];

144 
	#FS_IOC_SET_ENCRYPTION_POLICY
 
	`_IOR
('f', 19, 
fs¸y±_pﬁicy
)

	)

145 
	#FS_IOC_GET_ENCRYPTION_PWSALT
 
	`_IOW
('f', 20, 
__u8
[16])

	)

146 
	#FS_IOC_GET_ENCRYPTION_POLICY
 
	`_IOW
('f', 21, 
fs¸y±_pﬁicy
)

	)

147 
	#FS_IOC_GET_ENCRYPTION_POLICY_EX
 
	`_IOWR
('f', 22, 
__u8
[9]Ë

	)

148 
	#FS_IOC_ADD_ENCRYPTION_KEY
 
	`_IOWR
('f', 23, 
fs¸y±_add_key_¨g
)

	)

149 
	#FS_IOC_REMOVE_ENCRYPTION_KEY
 
	`_IOWR
('f', 24, 
fs¸y±_ªmove_key_¨g
)

	)

150 
	#FS_IOC_REMOVE_ENCRYPTION_KEY_ALL_USERS
 
	`_IOWR
('f', 25, 
fs¸y±_ªmove_key_¨g
)

	)

151 
	#FS_IOC_GET_ENCRYPTION_KEY_STATUS
 
	`_IOWR
('f', 26, 
fs¸y±_gë_key_°©us_¨g
)

	)

156 
	#FS_KEY_DESCRIPTOR_SIZE
 
FSCRYPT_KEY_DESCRIPTOR_SIZE


	)

157 
	#FS_POLICY_FLAGS_PAD_4
 
FSCRYPT_POLICY_FLAGS_PAD_4


	)

158 
	#FS_POLICY_FLAGS_PAD_8
 
FSCRYPT_POLICY_FLAGS_PAD_8


	)

159 
	#FS_POLICY_FLAGS_PAD_16
 
FSCRYPT_POLICY_FLAGS_PAD_16


	)

160 
	#FS_POLICY_FLAGS_PAD_32
 
FSCRYPT_POLICY_FLAGS_PAD_32


	)

161 
	#FS_POLICY_FLAGS_PAD_MASK
 
FSCRYPT_POLICY_FLAGS_PAD_MASK


	)

162 
	#FS_POLICY_FLAG_DIRECT_KEY
 
FSCRYPT_POLICY_FLAG_DIRECT_KEY


	)

163 
	#FS_POLICY_FLAGS_VALID
 0x07

	)

164 
	#FS_ENCRYPTION_MODE_INVALID
 0

	)

165 
	#FS_ENCRYPTION_MODE_AES_256_XTS
 
FSCRYPT_MODE_AES_256_XTS


	)

166 
	#FS_ENCRYPTION_MODE_AES_256_GCM
 2

	)

167 
	#FS_ENCRYPTION_MODE_AES_256_CBC
 3

	)

168 
	#FS_ENCRYPTION_MODE_AES_256_CTS
 
FSCRYPT_MODE_AES_256_CTS


	)

169 
	#FS_ENCRYPTION_MODE_AES_128_CBC
 
FSCRYPT_MODE_AES_128_CBC


	)

170 
	#FS_ENCRYPTION_MODE_AES_128_CTS
 
FSCRYPT_MODE_AES_128_CTS


	)

171 
	#FS_ENCRYPTION_MODE_SPECK128_256_XTS
 7

	)

172 
	#FS_ENCRYPTION_MODE_SPECK128_256_CTS
 8

	)

173 
	#FS_ENCRYPTION_MODE_ADIANTUM
 
FSCRYPT_MODE_ADIANTUM


	)

174 
	#FS_KEY_DESC_PREFIX
 
FSCRYPT_KEY_DESC_PREFIX


	)

175 
	#FS_KEY_DESC_PREFIX_SIZE
 
FSCRYPT_KEY_DESC_PREFIX_SIZE


	)

176 
	#FS_MAX_KEY_SIZE
 
FSCRYPT_MAX_KEY_SIZE


	)

	@/usr/include/linux/fsmap.h

9 #i‚de‡
_LINUX_FSMAP_H


10 
	#_LINUX_FSMAP_H


	)

12 
	~<löux/ty≥s.h
>

50 
	sfsm≠
 {

51 
__u32
 
	mfmr_devi˚
;

52 
__u32
 
	mfmr_Êags
;

53 
__u64
 
	mfmr_physiˇl
;

54 
__u64
 
	mfmr_ow√r
;

55 
__u64
 
	mfmr_off£t
;

56 
__u64
 
	mfmr_Àngth
;

57 
__u64
 
	mfmr_ª£rved
[3];

60 
	sfsm≠_hód
 {

61 
__u32
 
	mfmh_iÊags
;

62 
__u32
 
	mfmh_oÊags
;

63 
__u32
 
	mfmh_cou¡
;

64 
__u32
 
	mfmh_íåõs
;

65 
__u64
 
	mfmh_ª£rved
[6];

67 
fsm≠
 
	mfmh_keys
[2];

68 
fsm≠
 
	mfmh_ªcs
[];

72 
__ölöe__
 
size_t


73 
	$fsm≠_sizeof
(

74 
ƒ
)

76  (
fsm≠_hód
Ë+ 
ƒ
 * (
fsm≠
);

77 
	}
}

80 
__ölöe__
 

81 
	$fsm≠_adv™˚
(

82 
fsm≠_hód
 *
hód
)

84 
hód
->
fmh_keys
[0] = hód->
fmh_ªcs
[hód->
fmh_íåõs
 - 1];

85 
	}
}

89 
	#FMH_IF_VALID
 0

	)

92 
	#FMH_OF_DEV_T
 0x1

	)

95 
	#FMR_OF_PREALLOC
 0x1

	)

96 
	#FMR_OF_ATTR_FORK
 0x2

	)

97 
	#FMR_OF_EXTENT_MAP
 0x4

	)

98 
	#FMR_OF_SHARED
 0x8

	)

99 
	#FMR_OF_SPECIAL_OWNER
 0x10

	)

100 
	#FMR_OF_LAST
 0x20

	)

103 
	#FMR_OWNER
(
ty≥
, 
code
Ë(((
__u64
)type << 32) | \

104 ((
__u64
)
code
 & 0xFFFFFFFFULL))

	)

105 
	#FMR_OWNER_TYPE
(
ow√r
Ë((
__u32
)((
__u64
)ow√∏>> 32))

	)

106 
	#FMR_OWNER_CODE
(
ow√r
Ë((
__u32
)(((
__u64
)ow√∏& 0xFFFFFFFFULL)))

	)

107 
	#FMR_OWN_FREE
 
	`FMR_OWNER
(0, 1Ë

	)

108 
	#FMR_OWN_UNKNOWN
 
	`FMR_OWNER
(0, 2Ë

	)

109 
	#FMR_OWN_METADATA
 
	`FMR_OWNER
(0, 3Ë

	)

111 
	#FS_IOC_GETFSMAP
 
	`_IOWR
('X', 59, 
fsm≠_hód
)

	)

	@/usr/include/linux/fsverity.h

10 #i‚de‡
_LINUX_FSVERITY_H


11 
	#_LINUX_FSVERITY_H


	)

13 
	~<löux/io˘l.h
>

14 
	~<löux/ty≥s.h
>

16 
	#FS_VERITY_HASH_ALG_SHA256
 1

	)

17 
	#FS_VERITY_HASH_ALG_SHA512
 2

	)

19 
	sfsvîôy_íabÀ_¨g
 {

20 
__u32
 
	mvîsi⁄
;

21 
__u32
 
	mhash_Æg‹ôhm
;

22 
__u32
 
	mblock_size
;

23 
__u32
 
	mß…_size
;

24 
__u64
 
	mß…_±r
;

25 
__u32
 
	msig_size
;

26 
__u32
 
	m__ª£rved1
;

27 
__u64
 
	msig_±r
;

28 
__u64
 
	m__ª£rved2
[11];

31 
	sfsvîôy_dige°
 {

32 
__u16
 
	mdige°_Æg‹ôhm
;

33 
__u16
 
	mdige°_size
;

34 
__u8
 
	mdige°
[];

37 
	#FS_IOC_ENABLE_VERITY
 
	`_IOW
('f', 133, 
fsvîôy_íabÀ_¨g
)

	)

38 
	#FS_IOC_MEASURE_VERITY
 
	`_IOWR
('f', 134, 
fsvîôy_dige°
)

	)

	@/usr/include/linux/kdev_t.h

2 #i‚de‡
_LINUX_KDEV_T_H


3 
	#_LINUX_KDEV_T_H


	)

9 
	#MAJOR
(
dev
Ë((dev)>>8)

	)

10 
	#MINOR
(
dev
Ë((devË& 0xff)

	)

11 
	#MKDEV
(
ma
,
mi
Ë((ma)<<8 | (mi))

	)

	@/usr/include/linux/kernel.h

2 #i‚de‡
_LINUX_KERNEL_H


3 
	#_LINUX_KERNEL_H


	)

5 
	~<löux/sysöfo.h
>

6 
	~<löux/c⁄°.h
>

	@/usr/include/linux/magic.h

2 #i‚de‡
__LINUX_MAGIC_H__


3 
	#__LINUX_MAGIC_H__


	)

5 
	#ADFS_SUPER_MAGIC
 0xadf5

	)

6 
	#AFFS_SUPER_MAGIC
 0xadff

	)

7 
	#AFS_SUPER_MAGIC
 0x5346414F

	)

8 
	#AUTOFS_SUPER_MAGIC
 0x0187

	)

9 
	#CODA_SUPER_MAGIC
 0x73757245

	)

10 
	#CRAMFS_MAGIC
 0x28cd3d45

	)

11 
	#CRAMFS_MAGIC_WEND
 0x453dcd28

	)

12 
	#DEBUGFS_MAGIC
 0x64626720

	)

13 
	#SECURITYFS_MAGIC
 0x73636673

	)

14 
	#SELINUX_MAGIC
 0xf97cff8c

	)

15 
	#SMACK_MAGIC
 0x43415d53

	)

16 
	#RAMFS_MAGIC
 0x858458f6

	)

17 
	#TMPFS_MAGIC
 0x01021994

	)

18 
	#HUGETLBFS_MAGIC
 0x958458f6

	)

19 
	#SQUASHFS_MAGIC
 0x73717368

	)

20 
	#ECRYPTFS_SUPER_MAGIC
 0xf15f

	)

21 
	#EFS_SUPER_MAGIC
 0x414A53

	)

22 
	#EROFS_SUPER_MAGIC_V1
 0xE0F5E1E2

	)

23 
	#EXT2_SUPER_MAGIC
 0xEF53

	)

24 
	#EXT3_SUPER_MAGIC
 0xEF53

	)

25 
	#XENFS_SUPER_MAGIC
 0xabba1974

	)

26 
	#EXT4_SUPER_MAGIC
 0xEF53

	)

27 
	#BTRFS_SUPER_MAGIC
 0x9123683E

	)

28 
	#NILFS_SUPER_MAGIC
 0x3434

	)

29 
	#F2FS_SUPER_MAGIC
 0xF2F52010

	)

30 
	#HPFS_SUPER_MAGIC
 0xf995e849

	)

31 
	#ISOFS_SUPER_MAGIC
 0x9660

	)

32 
	#JFFS2_SUPER_MAGIC
 0x72b6

	)

33 
	#XFS_SUPER_MAGIC
 0x58465342

	)

34 
	#PSTOREFS_MAGIC
 0x6165676C

	)

35 
	#EFIVARFS_MAGIC
 0xde5e81e4

	)

36 
	#HOSTFS_SUPER_MAGIC
 0x00c0f„e

	)

37 
	#OVERLAYFS_SUPER_MAGIC
 0x794c7630

	)

39 
	#MINIX_SUPER_MAGIC
 0x137F

	)

40 
	#MINIX_SUPER_MAGIC2
 0x138F

	)

41 
	#MINIX2_SUPER_MAGIC
 0x2468

	)

42 
	#MINIX2_SUPER_MAGIC2
 0x2478

	)

43 
	#MINIX3_SUPER_MAGIC
 0x4d5®

	)

45 
	#MSDOS_SUPER_MAGIC
 0x4d44

	)

46 
	#NCP_SUPER_MAGIC
 0x564¯

	)

47 
	#NFS_SUPER_MAGIC
 0x6969

	)

48 
	#OCFS2_SUPER_MAGIC
 0x7461636f

	)

49 
	#OPENPROM_SUPER_MAGIC
 0x9Á1

	)

50 
	#QNX4_SUPER_MAGIC
 0x002‡

	)

51 
	#QNX6_SUPER_MAGIC
 0x68191122

	)

52 
	#AFS_FS_MAGIC
 0x6B414653

	)

54 
	#REISERFS_SUPER_MAGIC
 0x52654973

	)

57 
	#REISERFS_SUPER_MAGIC_STRING
 "ReIsErFs"

	)

58 
	#REISER2FS_SUPER_MAGIC_STRING
 "ReIsEr2Fs"

	)

59 
	#REISER2FS_JR_SUPER_MAGIC_STRING
 "ReIsEr3Fs"

	)

61 
	#SMB_SUPER_MAGIC
 0x517B

	)

62 
	#CGROUP_SUPER_MAGIC
 0x27e0eb

	)

63 
	#CGROUP2_SUPER_MAGIC
 0x63677270

	)

65 
	#RDTGROUP_SUPER_MAGIC
 0x7655821

	)

67 
	#STACK_END_MAGIC
 0x57AC6E9D

	)

69 
	#TRACEFS_MAGIC
 0x74726163

	)

71 
	#V9FS_MAGIC
 0x01021997

	)

73 
	#BDEVFS_MAGIC
 0x62646576

	)

74 
	#DAXFS_MAGIC
 0x64646178

	)

75 
	#BINFMTFS_MAGIC
 0x42494e4d

	)

76 
	#DEVPTS_SUPER_MAGIC
 0x1cd1

	)

77 
	#BINDERFS_SUPER_MAGIC
 0x6c6f6f70

	)

78 
	#FUTEXFS_SUPER_MAGIC
 0xBAD1DEA

	)

79 
	#PIPEFS_MAGIC
 0x50495045

	)

80 
	#PROC_SUPER_MAGIC
 0x9Á0

	)

81 
	#SOCKFS_MAGIC
 0x534F434B

	)

82 
	#SYSFS_MAGIC
 0x62656572

	)

83 
	#USBDEVICE_SUPER_MAGIC
 0x9Á2

	)

84 
	#MTD_INODE_FS_MAGIC
 0x11307854

	)

85 
	#ANON_INODE_FS_MAGIC
 0x09041934

	)

86 
	#BTRFS_TEST_MAGIC
 0x73727279

	)

87 
	#NSFS_MAGIC
 0x6e736673

	)

88 
	#BPF_FS_MAGIC
 0xˇ„4a11

	)

89 
	#AAFS_MAGIC
 0x5a3c69f0

	)

92 
	#UDF_SUPER_MAGIC
 0x15013346

	)

93 
	#BALLOON_KVM_MAGIC
 0x13661366

	)

94 
	#ZSMALLOC_MAGIC
 0x58295829

	)

95 
	#DMA_BUF_MAGIC
 0x444d4142

	)

96 
	#DEVMEM_MAGIC
 0x454d444d

	)

97 
	#Z3FOLD_MAGIC
 0x33

	)

99 
	#SHIFTFS_MAGIC
 0x6a656a62

	)

	@/usr/include/linux/mman.h

2 #i‚de‡
_LINUX_MMAN_H


3 
	#_LINUX_MMAN_H


	)

5 
	~<asm/mm™.h
>

6 
	~<asm-gíîic/hugëlb_ícode.h
>

8 
	#MREMAP_MAYMOVE
 1

	)

9 
	#MREMAP_FIXED
 2

	)

11 
	#OVERCOMMIT_GUESS
 0

	)

12 
	#OVERCOMMIT_ALWAYS
 1

	)

13 
	#OVERCOMMIT_NEVER
 2

	)

15 
	#MAP_SHARED
 0x01

	)

16 
	#MAP_PRIVATE
 0x02

	)

17 
	#MAP_SHARED_VALIDATE
 0x03

	)

26 
	#MAP_HUGE_SHIFT
 
HUGETLB_FLAG_ENCODE_SHIFT


	)

27 
	#MAP_HUGE_MASK
 
HUGETLB_FLAG_ENCODE_MASK


	)

29 
	#MAP_HUGE_64KB
 
HUGETLB_FLAG_ENCODE_64KB


	)

30 
	#MAP_HUGE_512KB
 
HUGETLB_FLAG_ENCODE_512KB


	)

31 
	#MAP_HUGE_1MB
 
HUGETLB_FLAG_ENCODE_1MB


	)

32 
	#MAP_HUGE_2MB
 
HUGETLB_FLAG_ENCODE_2MB


	)

33 
	#MAP_HUGE_8MB
 
HUGETLB_FLAG_ENCODE_8MB


	)

34 
	#MAP_HUGE_16MB
 
HUGETLB_FLAG_ENCODE_16MB


	)

35 
	#MAP_HUGE_32MB
 
HUGETLB_FLAG_ENCODE_32MB


	)

36 
	#MAP_HUGE_256MB
 
HUGETLB_FLAG_ENCODE_256MB


	)

37 
	#MAP_HUGE_512MB
 
HUGETLB_FLAG_ENCODE_512MB


	)

38 
	#MAP_HUGE_1GB
 
HUGETLB_FLAG_ENCODE_1GB


	)

39 
	#MAP_HUGE_2GB
 
HUGETLB_FLAG_ENCODE_2GB


	)

40 
	#MAP_HUGE_16GB
 
HUGETLB_FLAG_ENCODE_16GB


	)

	@/usr/include/linux/module.h

2 #i‚de‡
_LINUX_MODULE_H


3 
	#_LINUX_MODULE_H


	)

6 
	#MODULE_INIT_IGNORE_MODVERSIONS
 1

	)

7 
	#MODULE_INIT_IGNORE_VERMAGIC
 2

	)

	@/usr/include/linux/mount.h

1 #i‚de‡
_LINUX_MOUNT_H


2 
	#_LINUX_MOUNT_H


	)

11 
	#MS_RDONLY
 1

	)

12 
	#MS_NOSUID
 2

	)

13 
	#MS_NODEV
 4

	)

14 
	#MS_NOEXEC
 8

	)

15 
	#MS_SYNCHRONOUS
 16

	)

16 
	#MS_REMOUNT
 32

	)

17 
	#MS_MANDLOCK
 64

	)

18 
	#MS_DIRSYNC
 128

	)

19 
	#MS_NOATIME
 1024

	)

20 
	#MS_NODIRATIME
 2048

	)

21 
	#MS_BIND
 4096

	)

22 
	#MS_MOVE
 8192

	)

23 
	#MS_REC
 16384

	)

24 
	#MS_VERBOSE
 32768

	)

26 
	#MS_SILENT
 32768

	)

27 
	#MS_POSIXACL
 (1<<16Ë

	)

28 
	#MS_UNBINDABLE
 (1<<17Ë

	)

29 
	#MS_PRIVATE
 (1<<18Ë

	)

30 
	#MS_SLAVE
 (1<<19Ë

	)

31 
	#MS_SHARED
 (1<<20Ë

	)

32 
	#MS_RELATIME
 (1<<21Ë

	)

33 
	#MS_KERNMOUNT
 (1<<22Ë

	)

34 
	#MS_I_VERSION
 (1<<23Ë

	)

35 
	#MS_STRICTATIME
 (1<<24Ë

	)

36 
	#MS_LAZYTIME
 (1<<25Ë

	)

39 
	#MS_SUBMOUNT
 (1<<26)

	)

40 
	#MS_NOREMOTELOCK
 (1<<27)

	)

41 
	#MS_NOSEC
 (1<<28)

	)

42 
	#MS_BORN
 (1<<29)

	)

43 
	#MS_ACTIVE
 (1<<30)

	)

44 
	#MS_NOUSER
 (1<<31)

	)

49 
	#MS_RMT_MASK
 (
MS_RDONLY
|
MS_SYNCHRONOUS
|
MS_MANDLOCK
|
MS_I_VERSION
|\

50 
MS_LAZYTIME
)

	)

55 
	#MS_MGC_VAL
 0xC0ED0000

	)

56 
	#MS_MGC_MSK
 0xffff0000

	)

61 
	#OPEN_TREE_CLONE
 1

	)

62 
	#OPEN_TREE_CLOEXEC
 
O_CLOEXEC


	)

67 
	#MOVE_MOUNT_F_SYMLINKS
 0x00000001

	)

68 
	#MOVE_MOUNT_F_AUTOMOUNTS
 0x00000002

	)

69 
	#MOVE_MOUNT_F_EMPTY_PATH
 0x00000004

	)

70 
	#MOVE_MOUNT_T_SYMLINKS
 0x00000010

	)

71 
	#MOVE_MOUNT_T_AUTOMOUNTS
 0x00000020

	)

72 
	#MOVE_MOUNT_T_EMPTY_PATH
 0x00000040

	)

73 
	#MOVE_MOUNT__MASK
 0x00000077

	)

78 
	#FSOPEN_CLOEXEC
 0x00000001

	)

83 
	#FSPICK_CLOEXEC
 0x00000001

	)

84 
	#FSPICK_SYMLINK_NOFOLLOW
 0x00000002

	)

85 
	#FSPICK_NO_AUTOMOUNT
 0x00000004

	)

86 
	#FSPICK_EMPTY_PATH
 0x00000008

	)

91 
	efsc⁄fig_comm™d
 {

92 
	mFSCONFIG_SET_FLAG
 = 0,

93 
	mFSCONFIG_SET_STRING
 = 1,

94 
	mFSCONFIG_SET_BINARY
 = 2,

95 
	mFSCONFIG_SET_PATH
 = 3,

96 
	mFSCONFIG_SET_PATH_EMPTY
 = 4,

97 
	mFSCONFIG_SET_FD
 = 5,

98 
	mFSCONFIG_CMD_CREATE
 = 6,

99 
	mFSCONFIG_CMD_RECONFIGURE
 = 7,

105 
	#FSMOUNT_CLOEXEC
 0x00000001

	)

110 
	#MOUNT_ATTR_RDONLY
 0x00000001

	)

111 
	#MOUNT_ATTR_NOSUID
 0x00000002

	)

112 
	#MOUNT_ATTR_NODEV
 0x00000004

	)

113 
	#MOUNT_ATTR_NOEXEC
 0x00000008

	)

114 
	#MOUNT_ATTR__ATIME
 0x00000070

	)

115 
	#MOUNT_ATTR_RELATIME
 0x00000000

	)

116 
	#MOUNT_ATTR_NOATIME
 0x00000010

	)

117 
	#MOUNT_ATTR_STRICTATIME
 0x00000020

	)

118 
	#MOUNT_ATTR_NODIRATIME
 0x00000080

	)

	@/usr/include/linux/posix_acl_xattr.h

18 #i‚de‡
__UAPI_POSIX_ACL_XATTR_H


19 
	#__UAPI_POSIX_ACL_XATTR_H


	)

21 
	~<löux/ty≥s.h
>

24 
	#POSIX_ACL_XATTR_VERSION
 0x0002

	)

27 
	#ACL_UNDEFINED_ID
 (-1)

	)

29 
	sposix_a˛_x©å_íåy
 {

30 
__À16
 
	me_èg
;

31 
__À16
 
	me_≥rm
;

32 
__À32
 
	me_id
;

35 
	sposix_a˛_x©å_hódî
 {

36 
__À32
 
	ma_vîsi⁄
;

	@/usr/include/linux/quota.h

33 #i‚de‡
_LINUX_QUOTA_


34 
	#_LINUX_QUOTA_


	)

36 
	~<löux/ty≥s.h
>

38 
	#__DQUOT_VERSION__
 "dquŸ_6.6.0"

	)

40 
	#MAXQUOTAS
 3

	)

41 
	#USRQUOTA
 0

	)

42 
	#GRPQUOTA
 1

	)

43 
	#PRJQUOTA
 2

	)

48 
	#INITQFNAMES
 { \

53 };

	)

61 
	#SUBCMDMASK
 0x00ff

	)

62 
	#SUBCMDSHIFT
 8

	)

63 
	#QCMD
(
cmd
, 
ty≥
Ë(((cmdË<< 
SUBCMDSHIFT
Ë| (—y≥Ë& 
SUBCMDMASK
))

	)

65 
	#Q_SYNC
 0x800001

	)

66 
	#Q_QUOTAON
 0x800002

	)

67 
	#Q_QUOTAOFF
 0x800003

	)

68 
	#Q_GETFMT
 0x800004

	)

69 
	#Q_GETINFO
 0x800005

	)

70 
	#Q_SETINFO
 0x800006

	)

71 
	#Q_GETQUOTA
 0x800007

	)

72 
	#Q_SETQUOTA
 0x800008

	)

73 
	#Q_GETNEXTQUOTA
 0x800009

	)

76 
	#QFMT_VFS_OLD
 1

	)

77 
	#QFMT_VFS_V0
 2

	)

78 
	#QFMT_OCFS2
 3

	)

79 
	#QFMT_VFS_V1
 4

	)

83 
	#QIF_DQBLKSIZE_BITS
 10

	)

84 
	#QIF_DQBLKSIZE
 (1 << 
QIF_DQBLKSIZE_BITS
)

	)

91 
	mQIF_BLIMITS_B
 = 0,

92 
	mQIF_SPACE_B
,

93 
	mQIF_ILIMITS_B
,

94 
	mQIF_INODES_B
,

95 
	mQIF_BTIME_B
,

96 
	mQIF_ITIME_B
,

99 
	#QIF_BLIMITS
 (1 << 
QIF_BLIMITS_B
)

	)

100 
	#QIF_SPACE
 (1 << 
QIF_SPACE_B
)

	)

101 
	#QIF_ILIMITS
 (1 << 
QIF_ILIMITS_B
)

	)

102 
	#QIF_INODES
 (1 << 
QIF_INODES_B
)

	)

103 
	#QIF_BTIME
 (1 << 
QIF_BTIME_B
)

	)

104 
	#QIF_ITIME
 (1 << 
QIF_ITIME_B
)

	)

105 
	#QIF_LIMITS
 (
QIF_BLIMITS
 | 
QIF_ILIMITS
)

	)

106 
	#QIF_USAGE
 (
QIF_SPACE
 | 
QIF_INODES
)

	)

107 
	#QIF_TIMES
 (
QIF_BTIME
 | 
QIF_ITIME
)

	)

108 
	#QIF_ALL
 (
QIF_LIMITS
 | 
QIF_USAGE
 | 
QIF_TIMES
)

	)

110 
	sif_dqblk
 {

111 
__u64
 
	mdqb_bh¨dlimô
;

112 
__u64
 
	mdqb_bso·limô
;

113 
__u64
 
	mdqb_cur•a˚
;

114 
__u64
 
	mdqb_ih¨dlimô
;

115 
__u64
 
	mdqb_iso·limô
;

116 
__u64
 
	mdqb_curöodes
;

117 
__u64
 
	mdqb_btime
;

118 
__u64
 
	mdqb_ôime
;

119 
__u32
 
	mdqb_vÆid
;

122 
	sif_√xtdqblk
 {

123 
__u64
 
	mdqb_bh¨dlimô
;

124 
__u64
 
	mdqb_bso·limô
;

125 
__u64
 
	mdqb_cur•a˚
;

126 
__u64
 
	mdqb_ih¨dlimô
;

127 
__u64
 
	mdqb_iso·limô
;

128 
__u64
 
	mdqb_curöodes
;

129 
__u64
 
	mdqb_btime
;

130 
__u64
 
	mdqb_ôime
;

131 
__u32
 
	mdqb_vÆid
;

132 
__u32
 
	mdqb_id
;

139 
	#IIF_BGRACE
 1

	)

140 
	#IIF_IGRACE
 2

	)

141 
	#IIF_FLAGS
 4

	)

142 
	#IIF_ALL
 (
IIF_BGRACE
 | 
IIF_IGRACE
 | 
IIF_FLAGS
)

	)

145 
	mDQF_ROOT_SQUASH_B
 = 0,

146 
	mDQF_SYS_FILE_B
 = 16,

148 
	mDQF_PRIVATE


152 
	#DQF_ROOT_SQUASH
 (1 << 
DQF_ROOT_SQUASH_B
)

	)

154 
	#DQF_SYS_FILE
 (1 << 
DQF_SYS_FILE_B
)

	)

156 
	sif_dqöfo
 {

157 
__u64
 
	mdqi_bgø˚
;

158 
__u64
 
	mdqi_igø˚
;

159 
__u32
 
	mdqi_Êags
;

160 
__u32
 
	mdqi_vÆid
;

166 
	#QUOTA_NL_NOWARN
 0

	)

167 
	#QUOTA_NL_IHARDWARN
 1

	)

168 
	#QUOTA_NL_ISOFTLONGWARN
 2

	)

169 
	#QUOTA_NL_ISOFTWARN
 3

	)

170 
	#QUOTA_NL_BHARDWARN
 4

	)

171 
	#QUOTA_NL_BSOFTLONGWARN
 5

	)

172 
	#QUOTA_NL_BSOFTWARN
 6

	)

173 
	#QUOTA_NL_IHARDBELOW
 7

	)

174 
	#QUOTA_NL_ISOFTBELOW
 8

	)

175 
	#QUOTA_NL_BHARDBELOW
 9

	)

176 
	#QUOTA_NL_BSOFTBELOW
 10

	)

179 
	mQUOTA_NL_C_UNSPEC
,

180 
	mQUOTA_NL_C_WARNING
,

181 
	m__QUOTA_NL_C_MAX
,

183 
	#QUOTA_NL_C_MAX
 (
__QUOTA_NL_C_MAX
 - 1)

	)

186 
	mQUOTA_NL_A_UNSPEC
,

187 
	mQUOTA_NL_A_QTYPE
,

188 
	mQUOTA_NL_A_EXCESS_ID
,

189 
	mQUOTA_NL_A_WARNING
,

190 
	mQUOTA_NL_A_DEV_MAJOR
,

191 
	mQUOTA_NL_A_DEV_MINOR
,

192 
	mQUOTA_NL_A_CAUSED_ID
,

193 
	mQUOTA_NL_A_PAD
,

194 
	m__QUOTA_NL_A_MAX
,

196 
	#QUOTA_NL_A_MAX
 (
__QUOTA_NL_A_MAX
 - 1)

	)

	@/usr/include/linux/random.h

8 #i‚de‡
_LINUX_RANDOM_H


9 
	#_LINUX_RANDOM_H


	)

11 
	~<löux/ty≥s.h
>

12 
	~<löux/io˘l.h
>

13 
	~<löux/úqƒ.h
>

18 
	#RNDGETENTCNT
 
	`_IOR
–'R', 0x00, )

	)

21 
	#RNDADDTOENTCNT
 
	`_IOW
–'R', 0x01, )

	)

24 
	#RNDGETPOOL
 
	`_IOR
–'R', 0x02, [2] )

	)

30 
	#RNDADDENTROPY
 
	`_IOW
–'R', 0x03, [2] )

	)

33 
	#RNDZAPENTCNT
 
	`_IO
–'R', 0x04 )

	)

36 
	#RNDCLEARPOOL
 
	`_IO
–'R', 0x06 )

	)

39 
	#RNDRESEEDCRNG
 
	`_IO
–'R', 0x07 )

	)

41 
	sønd_poﬁ_öfo
 {

42 
	míå›y_cou¡
;

43 
	mbuf_size
;

44 
__u32
 
	mbuf
[0];

53 
	#GRND_NONBLOCK
 0x0001

	)

54 
	#GRND_RANDOM
 0x0002

	)

	@/usr/include/linux/sched.h

2 #i‚de‡
_LINUX_SCHED_H


3 
	#_LINUX_SCHED_H


	)

5 
	~<löux/ty≥s.h
>

10 
	#CSIGNAL
 0x000000f‡

	)

11 
	#CLONE_VM
 0x00000100

	)

12 
	#CLONE_FS
 0x00000200

	)

13 
	#CLONE_FILES
 0x00000400

	)

14 
	#CLONE_SIGHAND
 0x00000800

	)

15 
	#CLONE_PIDFD
 0x00001000

	)

16 
	#CLONE_PTRACE
 0x00002000

	)

17 
	#CLONE_VFORK
 0x00004000

	)

18 
	#CLONE_PARENT
 0x00008000

	)

19 
	#CLONE_THREAD
 0x00010000

	)

20 
	#CLONE_NEWNS
 0x00020000

	)

21 
	#CLONE_SYSVSEM
 0x00040000

	)

22 
	#CLONE_SETTLS
 0x00080000

	)

23 
	#CLONE_PARENT_SETTID
 0x00100000

	)

24 
	#CLONE_CHILD_CLEARTID
 0x00200000

	)

25 
	#CLONE_DETACHED
 0x00400000

	)

26 
	#CLONE_UNTRACED
 0x00800000

	)

27 
	#CLONE_CHILD_SETTID
 0x01000000

	)

28 
	#CLONE_NEWCGROUP
 0x02000000

	)

29 
	#CLONE_NEWUTS
 0x04000000

	)

30 
	#CLONE_NEWIPC
 0x08000000

	)

31 
	#CLONE_NEWUSER
 0x10000000

	)

32 
	#CLONE_NEWPID
 0x20000000

	)

33 
	#CLONE_NEWNET
 0x40000000

	)

34 
	#CLONE_IO
 0x80000000

	)

36 #i‚de‡
__ASSEMBLY__


66 
	s˛⁄e_¨gs
 {

67 
__Æig√d_u64
 
	mÊags
;

68 
__Æig√d_u64
 
	mpidfd
;

69 
__Æig√d_u64
 
	mchûd_tid
;

70 
__Æig√d_u64
 
	m∑ª¡_tid
;

71 
__Æig√d_u64
 
	mexô_sig«l
;

72 
__Æig√d_u64
 
	m°ack
;

73 
__Æig√d_u64
 
	m°ack_size
;

74 
__Æig√d_u64
 
	més
;

78 
	#CLONE_ARGS_SIZE_VER0
 64

	)

83 
	#SCHED_NORMAL
 0

	)

84 
	#SCHED_FIFO
 1

	)

85 
	#SCHED_RR
 2

	)

86 
	#SCHED_BATCH
 3

	)

88 
	#SCHED_IDLE
 5

	)

89 
	#SCHED_DEADLINE
 6

	)

92 
	#SCHED_RESET_ON_FORK
 0x40000000

	)

97 
	#SCHED_FLAG_RESET_ON_FORK
 0x01

	)

98 
	#SCHED_FLAG_RECLAIM
 0x02

	)

99 
	#SCHED_FLAG_DL_OVERRUN
 0x04

	)

100 
	#SCHED_FLAG_KEEP_POLICY
 0x08

	)

101 
	#SCHED_FLAG_KEEP_PARAMS
 0x10

	)

102 
	#SCHED_FLAG_UTIL_CLAMP_MIN
 0x20

	)

103 
	#SCHED_FLAG_UTIL_CLAMP_MAX
 0x40

	)

105 
	#SCHED_FLAG_KEEP_ALL
 (
SCHED_FLAG_KEEP_POLICY
 | \

106 
SCHED_FLAG_KEEP_PARAMS
)

	)

108 
	#SCHED_FLAG_UTIL_CLAMP
 (
SCHED_FLAG_UTIL_CLAMP_MIN
 | \

109 
SCHED_FLAG_UTIL_CLAMP_MAX
)

	)

111 
	#SCHED_FLAG_ALL
 (
SCHED_FLAG_RESET_ON_FORK
 | \

112 
SCHED_FLAG_RECLAIM
 | \

113 
SCHED_FLAG_DL_OVERRUN
 | \

114 
SCHED_FLAG_KEEP_ALL
 | \

115 
SCHED_FLAG_UTIL_CLAMP
)

	)

	@/usr/include/linux/stat.h

2 #i‚de‡
_LINUX_STAT_H


3 
	#_LINUX_STAT_H


	)

5 
	~<löux/ty≥s.h
>

7 #i‡
deföed
(
__KERNEL__
Ë|| !deföed(
__GLIBC__
) || (__GLIBC__ < 2)

9 
	#S_IFMT
 00170000

	)

10 
	#S_IFSOCK
 0140000

	)

11 
	#S_IFLNK
 0120000

	)

12 
	#S_IFREG
 0100000

	)

13 
	#S_IFBLK
 0060000

	)

14 
	#S_IFDIR
 0040000

	)

15 
	#S_IFCHR
 0020000

	)

16 
	#S_IFIFO
 0010000

	)

17 
	#S_ISUID
 0004000

	)

18 
	#S_ISGID
 0002000

	)

19 
	#S_ISVTX
 0001000

	)

21 
	#S_ISLNK
(
m
Ë(((mË& 
S_IFMT
Ë=
S_IFLNK
)

	)

22 
	#S_ISREG
(
m
Ë(((mË& 
S_IFMT
Ë=
S_IFREG
)

	)

23 
	#S_ISDIR
(
m
Ë(((mË& 
S_IFMT
Ë=
S_IFDIR
)

	)

24 
	#S_ISCHR
(
m
Ë(((mË& 
S_IFMT
Ë=
S_IFCHR
)

	)

25 
	#S_ISBLK
(
m
Ë(((mË& 
S_IFMT
Ë=
S_IFBLK
)

	)

26 
	#S_ISFIFO
(
m
Ë(((mË& 
S_IFMT
Ë=
S_IFIFO
)

	)

27 
	#S_ISSOCK
(
m
Ë(((mË& 
S_IFMT
Ë=
S_IFSOCK
)

	)

29 
	#S_IRWXU
 00700

	)

30 
	#S_IRUSR
 00400

	)

31 
	#S_IWUSR
 00200

	)

32 
	#S_IXUSR
 00100

	)

34 
	#S_IRWXG
 00070

	)

35 
	#S_IRGRP
 00040

	)

36 
	#S_IWGRP
 00020

	)

37 
	#S_IXGRP
 00010

	)

39 
	#S_IRWXO
 00007

	)

40 
	#S_IROTH
 00004

	)

41 
	#S_IWOTH
 00002

	)

42 
	#S_IXOTH
 00001

	)

56 
	s°©x_time°amp
 {

57 
__s64
 
	mtv_£c
;

58 
__u32
 
	mtv_n£c
;

59 
__s32
 
	m__ª£rved
;

99 
	s°©x
 {

101 
__u32
 
	m°x_mask
;

102 
__u32
 
	m°x_blksize
;

103 
__u64
 
	m°x_©åibuãs
;

105 
__u32
 
	m°x_∆ök
;

106 
__u32
 
	m°x_uid
;

107 
__u32
 
	m°x_gid
;

108 
__u16
 
	m°x_mode
;

109 
__u16
 
	m__•¨e0
[1];

111 
__u64
 
	m°x_öo
;

112 
__u64
 
	m°x_size
;

113 
__u64
 
	m°x_blocks
;

114 
__u64
 
	m°x_©åibuãs_mask
;

116 
°©x_time°amp
 
	m°x_©ime
;

117 
°©x_time°amp
 
	m°x_btime
;

118 
°©x_time°amp
 
	m°x_˘ime
;

119 
°©x_time°amp
 
	m°x_mtime
;

121 
__u32
 
	m°x_rdev_maj‹
;

122 
__u32
 
	m°x_rdev_mö‹
;

123 
__u32
 
	m°x_dev_maj‹
;

124 
__u32
 
	m°x_dev_mö‹
;

126 
__u64
 
	m__•¨e2
[14];

138 
	#STATX_TYPE
 0x00000001U

	)

139 
	#STATX_MODE
 0x00000002U

	)

140 
	#STATX_NLINK
 0x00000004U

	)

141 
	#STATX_UID
 0x00000008U

	)

142 
	#STATX_GID
 0x00000010U

	)

143 
	#STATX_ATIME
 0x00000020U

	)

144 
	#STATX_MTIME
 0x00000040U

	)

145 
	#STATX_CTIME
 0x00000080U

	)

146 
	#STATX_INO
 0x00000100U

	)

147 
	#STATX_SIZE
 0x00000200U

	)

148 
	#STATX_BLOCKS
 0x00000400U

	)

149 
	#STATX_BASIC_STATS
 0x000007ffU

	)

150 
	#STATX_BTIME
 0x00000800U

	)

151 
	#STATX_ALL
 0x00000fffU

	)

152 
	#STATX__RESERVED
 0x80000000U

	)

165 
	#STATX_ATTR_COMPRESSED
 0x00000004

	)

166 
	#STATX_ATTR_IMMUTABLE
 0x00000010

	)

167 
	#STATX_ATTR_APPEND
 0x00000020

	)

168 
	#STATX_ATTR_NODUMP
 0x00000040

	)

169 
	#STATX_ATTR_ENCRYPTED
 0x00000800

	)

171 
	#STATX_ATTR_AUTOMOUNT
 0x00001000

	)

	@/usr/include/linux/string.h

2 #i‚de‡
_LINUX_STRING_H_


3 
	#_LINUX_STRING_H_


	)

7 
	~<°rög.h
>

	@/usr/include/linux/time.h

2 #i‚de‡
_LINUX_TIME_H


3 
	#_LINUX_TIME_H


	)

5 
	~<löux/ty≥s.h
>

6 
	~<löux/time_ty≥s.h
>

8 #i‚de‡
_STRUCT_TIMESPEC


9 
	#_STRUCT_TIMESPEC


	)

10 
	stime•ec
 {

11 
__kî√l_time_t
 
	mtv_£c
;

12 
	mtv_n£c
;

16 
	stimevÆ
 {

17 
__kî√l_time_t
 
	mtv_£c
;

18 
__kî√l_su£c⁄ds_t
 
	mtv_u£c
;

21 
	stimez⁄e
 {

22 
	mtz_möuãswe°
;

23 
	mtz_d°time
;

30 
	#ITIMER_REAL
 0

	)

31 
	#ITIMER_VIRTUAL
 1

	)

32 
	#ITIMER_PROF
 2

	)

34 
	sôimî•ec
 {

35 
time•ec
 
	mô_öãrvÆ
;

36 
time•ec
 
	mô_vÆue
;

39 
	sôimîvÆ
 {

40 
timevÆ
 
	mô_öãrvÆ
;

41 
timevÆ
 
	mô_vÆue
;

47 
	#CLOCK_REALTIME
 0

	)

48 
	#CLOCK_MONOTONIC
 1

	)

49 
	#CLOCK_PROCESS_CPUTIME_ID
 2

	)

50 
	#CLOCK_THREAD_CPUTIME_ID
 3

	)

51 
	#CLOCK_MONOTONIC_RAW
 4

	)

52 
	#CLOCK_REALTIME_COARSE
 5

	)

53 
	#CLOCK_MONOTONIC_COARSE
 6

	)

54 
	#CLOCK_BOOTTIME
 7

	)

55 
	#CLOCK_REALTIME_ALARM
 8

	)

56 
	#CLOCK_BOOTTIME_ALARM
 9

	)

61 
	#CLOCK_SGI_CYCLE
 10

	)

62 
	#CLOCK_TAI
 11

	)

64 
	#MAX_CLOCKS
 16

	)

65 
	#CLOCKS_MASK
 (
CLOCK_REALTIME
 | 
CLOCK_MONOTONIC
)

	)

66 
	#CLOCKS_MONO
 
CLOCK_MONOTONIC


	)

71 
	#TIMER_ABSTIME
 0x01

	)

	@/usr/include/linux/types.h

2 #i‚de‡
_LINUX_TYPES_H


3 
	#_LINUX_TYPES_H


	)

5 
	~<asm/ty≥s.h
>

7 #i‚de‡
__ASSEMBLY__


9 
	~<löux/posix_ty≥s.h
>

17 #ifde‡
__CHECKER__


18 
	#__bôwi£__
 
	`__©åibuã__
((
bôwi£
))

	)

20 
	#__bôwi£__


	)

22 
	#__bôwi£
 
__bôwi£__


	)

24 
__u16
 
	t__bôwi£
 
	t__À16
;

25 
__u16
 
	t__bôwi£
 
	t__be16
;

26 
__u32
 
	t__bôwi£
 
	t__À32
;

27 
__u32
 
	t__bôwi£
 
	t__be32
;

28 
__u64
 
	t__bôwi£
 
	t__À64
;

29 
__u64
 
	t__bôwi£
 
	t__be64
;

31 
__u16
 
	t__bôwi£
 
	t__sum16
;

32 
__u32
 
	t__bôwi£
 
	t__wsum
;

43 
	#__Æig√d_u64
 
__u64
 
	`__©åibuã__
((
	`Æig√d
(8)))

	)

44 
	#__Æig√d_be64
 
__be64
 
	`__©åibuã__
((
	`Æig√d
(8)))

	)

45 
	#__Æig√d_À64
 
__À64
 
	`__©åibuã__
((
	`Æig√d
(8)))

	)

47 
	t__bôwi£
 
	t__pﬁl_t
;

	@/usr/include/linux/uio.h

10 #i‚de‡
__LINUX_UIO_H


11 
	#__LINUX_UIO_H


	)

14 
	~<löux/ty≥s.h
>

17 
	siovec


19 *
	miov_ba£
;

20 
__kî√l_size_t
 
	miov_Àn
;

27 
	#UIO_FASTIOV
 8

	)

28 
	#UIO_MAXIOV
 1024

	)

	@/usr/include/linux/utsname.h

2 #i‚de‡
_LINUX_UTSNAME_H


3 
	#_LINUX_UTSNAME_H


	)

5 
	#__OLD_UTS_LEN
 8

	)

7 
	sﬁdﬁd_ut¢ame
 {

8 
	msy¢ame
[9];

9 
	mnodíame
[9];

10 
	mªÀa£
[9];

11 
	mvîsi⁄
[9];

12 
	mmachöe
[9];

15 
	#__NEW_UTS_LEN
 64

	)

17 
	sﬁd_ut¢ame
 {

18 
	msy¢ame
[65];

19 
	mnodíame
[65];

20 
	mªÀa£
[65];

21 
	mvîsi⁄
[65];

22 
	mmachöe
[65];

25 
	s√w_ut¢ame
 {

26 
	msy¢ame
[
__NEW_UTS_LEN
 + 1];

27 
	mnodíame
[
__NEW_UTS_LEN
 + 1];

28 
	mªÀa£
[
__NEW_UTS_LEN
 + 1];

29 
	mvîsi⁄
[
__NEW_UTS_LEN
 + 1];

30 
	mmachöe
[
__NEW_UTS_LEN
 + 1];

31 
	mdomaö«me
[
__NEW_UTS_LEN
 + 1];

	@/usr/include/linux/uuid.h

18 #i‚de‡
_LINUX_UUID_H_


19 
	#_LINUX_UUID_H_


	)

21 
	~<löux/ty≥s.h
>

24 
__u8
 
	mb
[16];

25 } 
	tguid_t
;

27 
	#GUID_INIT
(
a
, 
b
, 
c
, 
d0
, 
d1
, 
d2
, 
d3
, 
d4
, 
d5
, 
d6
, 
d7
) \

28 ((
guid_t
) \

29 {{ (
a
) & 0xff, ((a) >> 8) & 0xff, ((a) >> 16) & 0xff, ((a) >> 24) & 0xff, \

30 (
b
) & 0xff, ((b) >> 8) & 0xff, \

31 (
c
) & 0xff, ((c) >> 8) & 0xff, \

32 (
d0
), (
d1
), (
d2
), (
d3
), (
d4
), (
d5
), (
d6
), (
d7
Ë}})

	)

35 
guid_t
 
	tuuid_À
;

36 
	#UUID_LE
(
a
, 
b
, 
c
, 
d0
, 
d1
, 
d2
, 
d3
, 
d4
, 
d5
, 
d6
, 
d7
) \

37 
	`GUID_INIT
(
a
, 
b
, 
c
, 
d0
, 
d1
, 
d2
, 
d3
, 
d4
, 
d5
, 
d6
, 
d7
)

	)

38 
	#NULL_UUID_LE
 \

39 
	`UUID_LE
(0x00000000, 0x0000, 0x0000, 0x00, 0x00, 0x00, 0x00, \

40 0x00, 0x00, 0x00, 0x00)

	)

	@/usr/include/linux/version.h

1 
	#LINUX_VERSION_CODE
 328844

	)

2 
	#KERNEL_VERSION
(
a
,
b
,
c
Ë((◊Ë<< 16Ë+ ((bË<< 8Ë+ ((cË> 255 ? 255 : (c)))

	)

	@/usr/include/linux/wait.h

2 #i‚de‡
_LINUX_WAIT_H


3 
	#_LINUX_WAIT_H


	)

5 
	#WNOHANG
 0x00000001

	)

6 
	#WUNTRACED
 0x00000002

	)

7 
	#WSTOPPED
 
WUNTRACED


	)

8 
	#WEXITED
 0x00000004

	)

9 
	#WCONTINUED
 0x00000008

	)

10 
	#WNOWAIT
 0x01000000

	)

12 
	#__WNOTHREAD
 0x20000000

	)

13 
	#__WALL
 0x40000000

	)

14 
	#__WCLONE
 0x80000000

	)

17 
	#P_ALL
 0

	)

18 
	#P_PID
 1

	)

19 
	#P_PGID
 2

	)

20 
	#P_PIDFD
 3

	)

	@/usr/include/linux/xattr.h

12 
	~<löux/libc-com∑t.h
>

14 #i‚de‡
_LINUX_XATTR_H


15 
	#_LINUX_XATTR_H


	)

17 #i‡
__UAPI_DEF_XATTR


18 
	#__USE_KERNEL_XATTR_DEFS


	)

20 
	#XATTR_CREATE
 0x1

	)

21 
	#XATTR_REPLACE
 0x2

	)

25 
	#XATTR_OS2_PREFIX
 "os2."

	)

26 
	#XATTR_OS2_PREFIX_LEN
 ((
XATTR_OS2_PREFIX
Ë- 1)

	)

28 
	#XATTR_MAC_OSX_PREFIX
 "osx."

	)

29 
	#XATTR_MAC_OSX_PREFIX_LEN
 ((
XATTR_MAC_OSX_PREFIX
Ë- 1)

	)

31 
	#XATTR_BTRFS_PREFIX
 "båfs."

	)

32 
	#XATTR_BTRFS_PREFIX_LEN
 ((
XATTR_BTRFS_PREFIX
Ë- 1)

	)

34 
	#XATTR_SECURITY_PREFIX
 "£curôy."

	)

35 
	#XATTR_SECURITY_PREFIX_LEN
 ((
XATTR_SECURITY_PREFIX
Ë- 1)

	)

37 
	#XATTR_SYSTEM_PREFIX
 "sy°em."

	)

38 
	#XATTR_SYSTEM_PREFIX_LEN
 ((
XATTR_SYSTEM_PREFIX
Ë- 1)

	)

40 
	#XATTR_TRUSTED_PREFIX
 "åu°ed."

	)

41 
	#XATTR_TRUSTED_PREFIX_LEN
 ((
XATTR_TRUSTED_PREFIX
Ë- 1)

	)

43 
	#XATTR_USER_PREFIX
 "u£r."

	)

44 
	#XATTR_USER_PREFIX_LEN
 ((
XATTR_USER_PREFIX
Ë- 1)

	)

47 
	#XATTR_EVM_SUFFIX
 "evm"

	)

48 
	#XATTR_NAME_EVM
 
XATTR_SECURITY_PREFIX
 
XATTR_EVM_SUFFIX


	)

50 
	#XATTR_IMA_SUFFIX
 "ima"

	)

51 
	#XATTR_NAME_IMA
 
XATTR_SECURITY_PREFIX
 
XATTR_IMA_SUFFIX


	)

53 
	#XATTR_SELINUX_SUFFIX
 "£löux"

	)

54 
	#XATTR_NAME_SELINUX
 
XATTR_SECURITY_PREFIX
 
XATTR_SELINUX_SUFFIX


	)

56 
	#XATTR_SMACK_SUFFIX
 "SMACK64"

	)

57 
	#XATTR_SMACK_IPIN
 "SMACK64IPIN"

	)

58 
	#XATTR_SMACK_IPOUT
 "SMACK64IPOUT"

	)

59 
	#XATTR_SMACK_EXEC
 "SMACK64EXEC"

	)

60 
	#XATTR_SMACK_TRANSMUTE
 "SMACK64TRANSMUTE"

	)

61 
	#XATTR_SMACK_MMAP
 "SMACK64MMAP"

	)

62 
	#XATTR_NAME_SMACK
 
XATTR_SECURITY_PREFIX
 
XATTR_SMACK_SUFFIX


	)

63 
	#XATTR_NAME_SMACKIPIN
 
XATTR_SECURITY_PREFIX
 
XATTR_SMACK_IPIN


	)

64 
	#XATTR_NAME_SMACKIPOUT
 
XATTR_SECURITY_PREFIX
 
XATTR_SMACK_IPOUT


	)

65 
	#XATTR_NAME_SMACKEXEC
 
XATTR_SECURITY_PREFIX
 
XATTR_SMACK_EXEC


	)

66 
	#XATTR_NAME_SMACKTRANSMUTE
 
XATTR_SECURITY_PREFIX
 
XATTR_SMACK_TRANSMUTE


	)

67 
	#XATTR_NAME_SMACKMMAP
 
XATTR_SECURITY_PREFIX
 
XATTR_SMACK_MMAP


	)

69 
	#XATTR_APPARMOR_SUFFIX
 "≠∑rm‹"

	)

70 
	#XATTR_NAME_APPARMOR
 
XATTR_SECURITY_PREFIX
 
XATTR_APPARMOR_SUFFIX


	)

72 
	#XATTR_CAPS_SUFFIX
 "ˇ∑bûôy"

	)

73 
	#XATTR_NAME_CAPS
 
XATTR_SECURITY_PREFIX
 
XATTR_CAPS_SUFFIX


	)

75 
	#XATTR_POSIX_ACL_ACCESS
 "posix_a˛_ac˚ss"

	)

76 
	#XATTR_NAME_POSIX_ACL_ACCESS
 
XATTR_SYSTEM_PREFIX
 
XATTR_POSIX_ACL_ACCESS


	)

77 
	#XATTR_POSIX_ACL_DEFAULT
 "posix_a˛_deÁu…"

	)

78 
	#XATTR_NAME_POSIX_ACL_DEFAULT
 
XATTR_SYSTEM_PREFIX
 
XATTR_POSIX_ACL_DEFAULT


	)

	@/usr/include/asm-generic/hugetlb_encode.h

1 #i‚de‡
_ASM_GENERIC_HUGETLB_ENCODE_H_


2 
	#_ASM_GENERIC_HUGETLB_ENCODE_H_


	)

20 
	#HUGETLB_FLAG_ENCODE_SHIFT
 26

	)

21 
	#HUGETLB_FLAG_ENCODE_MASK
 0x3f

	)

23 
	#HUGETLB_FLAG_ENCODE_64KB
 (16 << 
HUGETLB_FLAG_ENCODE_SHIFT
)

	)

24 
	#HUGETLB_FLAG_ENCODE_512KB
 (19 << 
HUGETLB_FLAG_ENCODE_SHIFT
)

	)

25 
	#HUGETLB_FLAG_ENCODE_1MB
 (20 << 
HUGETLB_FLAG_ENCODE_SHIFT
)

	)

26 
	#HUGETLB_FLAG_ENCODE_2MB
 (21 << 
HUGETLB_FLAG_ENCODE_SHIFT
)

	)

27 
	#HUGETLB_FLAG_ENCODE_8MB
 (23 << 
HUGETLB_FLAG_ENCODE_SHIFT
)

	)

28 
	#HUGETLB_FLAG_ENCODE_16MB
 (24 << 
HUGETLB_FLAG_ENCODE_SHIFT
)

	)

29 
	#HUGETLB_FLAG_ENCODE_32MB
 (25 << 
HUGETLB_FLAG_ENCODE_SHIFT
)

	)

30 
	#HUGETLB_FLAG_ENCODE_256MB
 (28 << 
HUGETLB_FLAG_ENCODE_SHIFT
)

	)

31 
	#HUGETLB_FLAG_ENCODE_512MB
 (29 << 
HUGETLB_FLAG_ENCODE_SHIFT
)

	)

32 
	#HUGETLB_FLAG_ENCODE_1GB
 (30 << 
HUGETLB_FLAG_ENCODE_SHIFT
)

	)

33 
	#HUGETLB_FLAG_ENCODE_2GB
 (31 << 
HUGETLB_FLAG_ENCODE_SHIFT
)

	)

34 
	#HUGETLB_FLAG_ENCODE_16GB
 (34 << 
HUGETLB_FLAG_ENCODE_SHIFT
)

	)

	@/usr/include/linux/const.h

4 #i‚de‡
_LINUX_CONST_H


5 
	#_LINUX_CONST_H


	)

16 #ifde‡
__ASSEMBLY__


17 
	#_AC
(
X
,
Y
Ë
	)
X

18 
	#_AT
(
T
,
X
Ë
	)
X

20 
	#__AC
(
X
,
Y
Ë(X##Y)

	)

21 
	#_AC
(
X
,
Y
Ë
	`__AC
(X,Y)

	)

22 
	#_AT
(
T
,
X
Ë((T)(X))

	)

25 
	#_UL
(
x
Ë(
	`_AC
(x, 
UL
))

	)

26 
	#_ULL
(
x
Ë(
	`_AC
(x, 
ULL
))

	)

28 
	#_BITUL
(
x
Ë(
	`_UL
(1Ë<< (x))

	)

29 
	#_BITULL
(
x
Ë(
	`_ULL
(1Ë<< (x))

	)

31 
	#__ALIGN_KERNEL
(
x
, 
a
Ë
	`__ALIGN_KERNEL_MASK
(x, (
	`ty≥of
(x))◊Ë- 1)

	)

32 
	#__ALIGN_KERNEL_MASK
(
x
, 
mask
Ë(((xË+ (mask)Ë& ~(mask))

	)

34 
	#__KERNEL_DIV_ROUND_UP
(
n
, 
d
Ë((“Ë+ (dË- 1Ë/ (d))

	)

	@/usr/include/linux/ioctl.h

2 #i‚de‡
_LINUX_IOCTL_H


3 
	#_LINUX_IOCTL_H


	)

5 
	~<asm/io˘l.h
>

	@/usr/include/linux/irqnr.h

	@/usr/include/linux/libc-compat.h

49 #i‚de‡
_LIBC_COMPAT_H


50 
	#_LIBC_COMPAT_H


	)

53 #i‡
deföed
(
__GLIBC__
)

56 #i‡
deföed
(
_NET_IF_H
Ë&& deföed(
__USE_MISC
)

61 
	#__UAPI_DEF_IF_IFCONF
 0

	)

62 
	#__UAPI_DEF_IF_IFMAP
 0

	)

63 
	#__UAPI_DEF_IF_IFNAMSIZ
 0

	)

64 
	#__UAPI_DEF_IF_IFREQ
 0

	)

66 
	#__UAPI_DEF_IF_NET_DEVICE_FLAGS
 0

	)

68 #i‚de‡
__UAPI_DEF_IF_NET_DEVICE_FLAGS_LOWER_UP_DORMANT_ECHO


69 
	#__UAPI_DEF_IF_NET_DEVICE_FLAGS_LOWER_UP_DORMANT_ECHO
 1

	)

78 
	#__UAPI_DEF_IF_IFCONF
 1

	)

79 
	#__UAPI_DEF_IF_IFMAP
 1

	)

80 
	#__UAPI_DEF_IF_IFNAMSIZ
 1

	)

81 
	#__UAPI_DEF_IF_IFREQ
 1

	)

83 
	#__UAPI_DEF_IF_NET_DEVICE_FLAGS
 1

	)

85 
	#__UAPI_DEF_IF_NET_DEVICE_FLAGS_LOWER_UP_DORMANT_ECHO
 1

	)

90 #i‡
deföed
(
_NETINET_IN_H
)

94 
	#__UAPI_DEF_IN_ADDR
 0

	)

95 
	#__UAPI_DEF_IN_IPPROTO
 0

	)

96 
	#__UAPI_DEF_IN_PKTINFO
 0

	)

97 
	#__UAPI_DEF_IP_MREQ
 0

	)

98 
	#__UAPI_DEF_SOCKADDR_IN
 0

	)

99 
	#__UAPI_DEF_IN_CLASS
 0

	)

101 
	#__UAPI_DEF_IN6_ADDR
 0

	)

106 #i‡
deföed
(
__USE_MISC
Ë|| deföed (
__USE_GNU
)

107 
	#__UAPI_DEF_IN6_ADDR_ALT
 0

	)

109 
	#__UAPI_DEF_IN6_ADDR_ALT
 1

	)

111 
	#__UAPI_DEF_SOCKADDR_IN6
 0

	)

112 
	#__UAPI_DEF_IPV6_MREQ
 0

	)

113 
	#__UAPI_DEF_IPPROTO_V6
 0

	)

114 
	#__UAPI_DEF_IPV6_OPTIONS
 0

	)

115 
	#__UAPI_DEF_IN6_PKTINFO
 0

	)

116 
	#__UAPI_DEF_IP6_MTUINFO
 0

	)

123 
	#__UAPI_DEF_IN_ADDR
 1

	)

124 
	#__UAPI_DEF_IN_IPPROTO
 1

	)

125 
	#__UAPI_DEF_IN_PKTINFO
 1

	)

126 
	#__UAPI_DEF_IP_MREQ
 1

	)

127 
	#__UAPI_DEF_SOCKADDR_IN
 1

	)

128 
	#__UAPI_DEF_IN_CLASS
 1

	)

130 
	#__UAPI_DEF_IN6_ADDR
 1

	)

133 
	#__UAPI_DEF_IN6_ADDR_ALT
 1

	)

134 
	#__UAPI_DEF_SOCKADDR_IN6
 1

	)

135 
	#__UAPI_DEF_IPV6_MREQ
 1

	)

136 
	#__UAPI_DEF_IPPROTO_V6
 1

	)

137 
	#__UAPI_DEF_IPV6_OPTIONS
 1

	)

138 
	#__UAPI_DEF_IN6_PKTINFO
 1

	)

139 
	#__UAPI_DEF_IP6_MTUINFO
 1

	)

144 #i‡
deföed
(
__NETIPX_IPX_H
)

146 
	#__UAPI_DEF_SOCKADDR_IPX
 0

	)

147 
	#__UAPI_DEF_IPX_ROUTE_DEFINITION
 0

	)

148 
	#__UAPI_DEF_IPX_INTERFACE_DEFINITION
 0

	)

149 
	#__UAPI_DEF_IPX_CONFIG_DATA
 0

	)

150 
	#__UAPI_DEF_IPX_ROUTE_DEF
 0

	)

154 
	#__UAPI_DEF_SOCKADDR_IPX
 1

	)

155 
	#__UAPI_DEF_IPX_ROUTE_DEFINITION
 1

	)

156 
	#__UAPI_DEF_IPX_INTERFACE_DEFINITION
 1

	)

157 
	#__UAPI_DEF_IPX_CONFIG_DATA
 1

	)

158 
	#__UAPI_DEF_IPX_ROUTE_DEF
 1

	)

163 #i‡
deföed
(
_SYS_XATTR_H
)

164 
	#__UAPI_DEF_XATTR
 0

	)

166 
	#__UAPI_DEF_XATTR
 1

	)

176 #i‚de‡
__UAPI_DEF_IF_IFCONF


177 
	#__UAPI_DEF_IF_IFCONF
 1

	)

179 #i‚de‡
__UAPI_DEF_IF_IFMAP


180 
	#__UAPI_DEF_IF_IFMAP
 1

	)

182 #i‚de‡
__UAPI_DEF_IF_IFNAMSIZ


183 
	#__UAPI_DEF_IF_IFNAMSIZ
 1

	)

185 #i‚de‡
__UAPI_DEF_IF_IFREQ


186 
	#__UAPI_DEF_IF_IFREQ
 1

	)

189 #i‚de‡
__UAPI_DEF_IF_NET_DEVICE_FLAGS


190 
	#__UAPI_DEF_IF_NET_DEVICE_FLAGS
 1

	)

193 #i‚de‡
__UAPI_DEF_IF_NET_DEVICE_FLAGS_LOWER_UP_DORMANT_ECHO


194 
	#__UAPI_DEF_IF_NET_DEVICE_FLAGS_LOWER_UP_DORMANT_ECHO
 1

	)

198 #i‚de‡
__UAPI_DEF_IN_ADDR


199 
	#__UAPI_DEF_IN_ADDR
 1

	)

201 #i‚de‡
__UAPI_DEF_IN_IPPROTO


202 
	#__UAPI_DEF_IN_IPPROTO
 1

	)

204 #i‚de‡
__UAPI_DEF_IN_PKTINFO


205 
	#__UAPI_DEF_IN_PKTINFO
 1

	)

207 #i‚de‡
__UAPI_DEF_IP_MREQ


208 
	#__UAPI_DEF_IP_MREQ
 1

	)

210 #i‚de‡
__UAPI_DEF_SOCKADDR_IN


211 
	#__UAPI_DEF_SOCKADDR_IN
 1

	)

213 #i‚de‡
__UAPI_DEF_IN_CLASS


214 
	#__UAPI_DEF_IN_CLASS
 1

	)

218 #i‚de‡
__UAPI_DEF_IN6_ADDR


219 
	#__UAPI_DEF_IN6_ADDR
 1

	)

221 #i‚de‡
__UAPI_DEF_IN6_ADDR_ALT


222 
	#__UAPI_DEF_IN6_ADDR_ALT
 1

	)

224 #i‚de‡
__UAPI_DEF_SOCKADDR_IN6


225 
	#__UAPI_DEF_SOCKADDR_IN6
 1

	)

227 #i‚de‡
__UAPI_DEF_IPV6_MREQ


228 
	#__UAPI_DEF_IPV6_MREQ
 1

	)

230 #i‚de‡
__UAPI_DEF_IPPROTO_V6


231 
	#__UAPI_DEF_IPPROTO_V6
 1

	)

233 #i‚de‡
__UAPI_DEF_IPV6_OPTIONS


234 
	#__UAPI_DEF_IPV6_OPTIONS
 1

	)

236 #i‚de‡
__UAPI_DEF_IN6_PKTINFO


237 
	#__UAPI_DEF_IN6_PKTINFO
 1

	)

239 #i‚de‡
__UAPI_DEF_IP6_MTUINFO


240 
	#__UAPI_DEF_IP6_MTUINFO
 1

	)

244 #i‚de‡
__UAPI_DEF_SOCKADDR_IPX


245 
	#__UAPI_DEF_SOCKADDR_IPX
 1

	)

247 #i‚de‡
__UAPI_DEF_IPX_ROUTE_DEFINITION


248 
	#__UAPI_DEF_IPX_ROUTE_DEFINITION
 1

	)

250 #i‚de‡
__UAPI_DEF_IPX_INTERFACE_DEFINITION


251 
	#__UAPI_DEF_IPX_INTERFACE_DEFINITION
 1

	)

253 #i‚de‡
__UAPI_DEF_IPX_CONFIG_DATA


254 
	#__UAPI_DEF_IPX_CONFIG_DATA
 1

	)

256 #i‚de‡
__UAPI_DEF_IPX_ROUTE_DEF


257 
	#__UAPI_DEF_IPX_ROUTE_DEF
 1

	)

261 #i‚de‡
__UAPI_DEF_XATTR


262 
	#__UAPI_DEF_XATTR
 1

	)

	@/usr/include/linux/limits.h

2 #i‚de‡
_LINUX_LIMITS_H


3 
	#_LINUX_LIMITS_H


	)

5 
	#NR_OPEN
 1024

	)

7 
	#NGROUPS_MAX
 65536

	)

8 
	#ARG_MAX
 131072

	)

9 
	#LINK_MAX
 127

	)

10 
	#MAX_CANON
 255

	)

11 
	#MAX_INPUT
 255

	)

12 
	#NAME_MAX
 255

	)

13 
	#PATH_MAX
 4096

	)

14 
	#PIPE_BUF
 4096

	)

15 
	#XATTR_NAME_MAX
 255

	)

16 
	#XATTR_SIZE_MAX
 65536

	)

17 
	#XATTR_LIST_MAX
 65536

	)

19 
	#RTSIG_MAX
 32

	)

	@/usr/include/linux/posix_types.h

2 #i‚de‡
_LINUX_POSIX_TYPES_H


3 
	#_LINUX_POSIX_TYPES_H


	)

5 
	~<löux/°ddef.h
>

22 #unde‡
__FD_SETSIZE


23 
	#__FD_SETSIZE
 1024

	)

26 
	mfds_bôs
[
__FD_SETSIZE
 / (8 * ())];

27 } 
	t__kî√l_fd_£t
;

30 (*
	t__kî√l_sigh™dÀr_t
)();

33 
	t__kî√l_key_t
;

34 
	t__kî√l_mqd_t
;

36 
	~<asm/posix_ty≥s.h
>

	@/usr/include/linux/sysinfo.h

2 #i‚de‡
_LINUX_SYSINFO_H


3 
	#_LINUX_SYSINFO_H


	)

5 
	~<löux/ty≥s.h
>

7 
	#SI_LOAD_SHIFT
 16

	)

8 
	ssysöfo
 {

9 
__kî√l_l⁄g_t
 
	mu±ime
;

10 
__kî√l_ul⁄g_t
 
	mlﬂds
[3];

11 
__kî√l_ul⁄g_t
 
	mtŸÆøm
;

12 
__kî√l_ul⁄g_t
 
	m‰ìøm
;

13 
__kî√l_ul⁄g_t
 
	msh¨edøm
;

14 
__kî√l_ul⁄g_t
 
	mbuf„ºam
;

15 
__kî√l_ul⁄g_t
 
	mtŸÆsw≠
;

16 
__kî√l_ul⁄g_t
 
	m‰ìsw≠
;

17 
__u16
 
	m¥ocs
;

18 
__u16
 
	m∑d
;

19 
__kî√l_ul⁄g_t
 
	mtŸÆhigh
;

20 
__kî√l_ul⁄g_t
 
	m‰ìhigh
;

21 
__u32
 
	mmem_unô
;

22 
	m_f
[20-2*(
__kî√l_ul⁄g_t
)-(
__u32
)];

	@/usr/include/linux/time_types.h

2 #i‚de‡
_LINUX_TIME_TYPES_H


3 
	#_LINUX_TIME_TYPES_H


	)

5 
	~<löux/ty≥s.h
>

7 
	s__kî√l_time•ec
 {

8 
__kî√l_time64_t
 
	mtv_£c
;

9 
	mtv_n£c
;

12 
	s__kî√l_ôimî•ec
 {

13 
__kî√l_time•ec
 
	mô_öãrvÆ
;

14 
__kî√l_time•ec
 
	mô_vÆue
;

24 #i‚de‡
__kî√l_ﬁd_timevÆ


25 
	s__kî√l_ﬁd_timevÆ
 {

26 
__kî√l_l⁄g_t
 
	mtv_£c
;

27 
__kî√l_l⁄g_t
 
	mtv_u£c
;

31 
	s__kî√l_sock_timevÆ
 {

32 
__s64
 
	mtv_£c
;

33 
__s64
 
	mtv_u£c
;

	@/usr/include/string.h

22 #i‚def 
_STRING_H


23 
	#_STRING_H
 1

	)

25 
	#__GLIBC_INTERNAL_STARTING_HEADER_IMPLEMENTATION


	)

26 
	~<bôs/libc-hódî-°¨t.h
>

28 
	g__BEGIN_DECLS


31 
	#__√ed_size_t


	)

32 
	#__√ed_NULL


	)

33 
	~<°ddef.h
>

36 #i‡
deföed
 
__˝lu•lus
 && (
__GNUC_PREREQ
 (4, 4) \

37 || 
	$__glibc_˛™g_¥îeq
 (3, 5))

38 
	#__CORRECT_ISO_CPP_STRING_H_PROTO


	)

43 *
	$mem˝y
 (*
__ª°ri˘
 
__de°
, c⁄° *__ª°ri˘ 
__§c
,

44 
size_t
 
__n
Ë
__THROW
 
	`__n⁄nuŒ
 ((1, 2));

47 *
	$memmove
 (*
__de°
, c⁄° *
__§c
, 
size_t
 
__n
)

48 
__THROW
 
	`__n⁄nuŒ
 ((1, 2));

53 #i‡
deföed
 
__USE_MISC
 || deföed 
__USE_XOPEN
 || 
	`__GLIBC_USE
 (
ISOC2X
)

54 *
	$memc˝y
 (*
__ª°ri˘
 
__de°
, c⁄° *__ª°ri˘ 
__§c
,

55 
__c
, 
size_t
 
__n
)

56 
__THROW
 
	`__n⁄nuŒ
 ((1, 2));

61 *
	$mem£t
 (*
__s
, 
__c
, 
size_t
 
__n
Ë
__THROW
 
	`__n⁄nuŒ
 ((1));

64 
	$memcmp
 (c⁄° *
__s1
, c⁄° *
__s2
, 
size_t
 
__n
)

65 
__THROW
 
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1, 2));

68 #ifde‡
__CORRECT_ISO_CPP_STRING_H_PROTO


71 *
	`memchr
 (*
__s
, 
__c
, 
size_t
 
__n
)

72 
__THROW
 
	`__asm
 ("memchr"Ë
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1));

73 c⁄° *
	`memchr
 (c⁄° *
__s
, 
__c
, 
size_t
 
__n
)

74 
__THROW
 
	`__asm
 ("memchr"Ë
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1));

76 #ifde‡
__OPTIMIZE__


77 
__exã∫_Æways_ölöe
 *

78 
	`memchr
 (*
__s
, 
__c
, 
size_t
 
__n
Ë
__THROW


80  
	`__buûtö_memchr
 (
__s
, 
__c
, 
__n
);

83 
__exã∫_Æways_ölöe
 const *

84 
	`memchr
 (c⁄° *
__s
, 
__c
, 
size_t
 
__n
Ë
__THROW


86  
	`__buûtö_memchr
 (
__s
, 
__c
, 
__n
);

89 
	}
}

91 *
	$memchr
 (c⁄° *
__s
, 
__c
, 
size_t
 
__n
)

92 
__THROW
 
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1));

95 #ifde‡
__USE_GNU


98 #ifde‡
__CORRECT_ISO_CPP_STRING_H_PROTO


99 "C++" *
	$øwmemchr
 (*
__s
, 
__c
)

100 
__THROW
 
	`__asm
 ("øwmemchr"Ë
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1));

101 "C++" c⁄° *
	$øwmemchr
 (c⁄° *
__s
, 
__c
)

102 
__THROW
 
	`__asm
 ("øwmemchr"Ë
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1));

104 *
	$øwmemchr
 (c⁄° *
__s
, 
__c
)

105 
__THROW
 
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1));

109 #ifde‡
__CORRECT_ISO_CPP_STRING_H_PROTO


110 "C++" *
	$memrchr
 (*
__s
, 
__c
, 
size_t
 
__n
)

111 
__THROW
 
	`__asm
 ("memrchr"Ë
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1));

112 "C++" c⁄° *
	$memrchr
 (c⁄° *
__s
, 
__c
, 
size_t
 
__n
)

113 
__THROW
 
	`__asm
 ("memrchr"Ë
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1));

115 *
	$memrchr
 (c⁄° *
__s
, 
__c
, 
size_t
 
__n
)

116 
__THROW
 
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1));

122 *
	$°r˝y
 (*
__ª°ri˘
 
__de°
, c⁄° *__ª°ri˘ 
__§c
)

123 
__THROW
 
	`__n⁄nuŒ
 ((1, 2));

125 *
	$°∫˝y
 (*
__ª°ri˘
 
__de°
,

126 c⁄° *
__ª°ri˘
 
__§c
, 
size_t
 
__n
)

127 
__THROW
 
	`__n⁄nuŒ
 ((1, 2));

130 *
	$°rˇt
 (*
__ª°ri˘
 
__de°
, c⁄° *__ª°ri˘ 
__§c
)

131 
__THROW
 
	`__n⁄nuŒ
 ((1, 2));

133 *
	$°∫ˇt
 (*
__ª°ri˘
 
__de°
, c⁄° *__ª°ri˘ 
__§c
,

134 
size_t
 
__n
Ë
__THROW
 
	`__n⁄nuŒ
 ((1, 2));

137 
	$°rcmp
 (c⁄° *
__s1
, c⁄° *
__s2
)

138 
__THROW
 
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1, 2));

140 
	$°∫cmp
 (c⁄° *
__s1
, c⁄° *
__s2
, 
size_t
 
__n
)

141 
__THROW
 
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1, 2));

144 
	$°rcﬁl
 (c⁄° *
__s1
, c⁄° *
__s2
)

145 
__THROW
 
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1, 2));

147 
size_t
 
	$°rx‰m
 (*
__ª°ri˘
 
__de°
,

148 c⁄° *
__ª°ri˘
 
__§c
, 
size_t
 
__n
)

149 
__THROW
 
	`__n⁄nuŒ
 ((2));

151 #ifde‡
__USE_XOPEN2K8


153 
	~<bôs/ty≥s/loˇÀ_t.h
>

156 
	$°rcﬁl_l
 (c⁄° *
__s1
, c⁄° *
__s2
, 
loˇÀ_t
 
__l
)

157 
__THROW
 
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1, 2, 3));

160 
size_t
 
	$°rx‰m_l
 (*
__de°
, c⁄° *
__§c
, 
size_t
 
__n
,

161 
loˇÀ_t
 
__l
Ë
__THROW
 
	`__n⁄nuŒ
 ((2, 4));

164 #i‡(
deföed
 
__USE_XOPEN_EXTENDED
 || deföed 
__USE_XOPEN2K8
 \

165 || 
	`__GLIBC_USE
 (
LIB_EXT2
Ë|| 
	$__GLIBC_USE
 (
ISOC2X
))

167 *
	$°rdup
 (c⁄° *
__s
)

168 
__THROW
 
__©åibuã_mÆloc__
 
	`__n⁄nuŒ
 ((1));

174 #i‡
deföed
 
__USE_XOPEN2K8
 || 
	`__GLIBC_USE
 (
LIB_EXT2
Ë|| __GLIBC_USE (
ISOC2X
)

175 *
	$°∫dup
 (c⁄° *
__°rög
, 
size_t
 
__n
)

176 
__THROW
 
__©åibuã_mÆloc__
 
	`__n⁄nuŒ
 ((1));

179 #i‡
deföed
 
__USE_GNU
 && deföed 
__GNUC__


181 
	#°rdu∑
(
s
) \

182 (
__exãnsi⁄__
 \

184 c⁄° *
__ﬁd
 = (
s
); \

185 
size_t
 
__Àn
 = 
	`°æí
 (
__ﬁd
) + 1; \

186 *
__√w
 = (*Ë
	`__buûtö_Æloˇ
 (
__Àn
); \

187 (*Ë
	`mem˝y
 (
__√w
, 
__ﬁd
, 
__Àn
); \

188 
	}
}))

	)

191 
	#°∫du∑
(
s
, 
n
) \

192 (
__exãnsi⁄__
 \

194 c⁄° *
__ﬁd
 = (
s
); \

195 
size_t
 
__Àn
 = 
	`°∫Àn
 (
__ﬁd
, (
n
)); \

196 *
__√w
 = (*Ë
	`__buûtö_Æloˇ
 (
__Àn
 + 1); \

197 
__√w
[
__Àn
] = '\0'; \

198 (*Ë
	`mem˝y
 (
__√w
, 
__ﬁd
, 
__Àn
); \

199 }))

	)

203 #ifde‡
__CORRECT_ISO_CPP_STRING_H_PROTO


206 *
°rchr
 (*
__s
, 
__c
)

207 
__THROW
 
__asm
 ("°rchr"Ë
__©åibuã_puª__
 
__n⁄nuŒ
 ((1));

208 c⁄° *
°rchr
 (c⁄° *
__s
, 
__c
)

209 
__THROW
 
__asm
 ("°rchr"Ë
__©åibuã_puª__
 
__n⁄nuŒ
 ((1));

211 #ifde‡
__OPTIMIZE__


212 
__exã∫_Æways_ölöe
 *

213 
°rchr
 (*
__s
, 
__c
Ë
	g__THROW


215  
__buûtö_°rchr
 (
__s
, 
__c
);

218 
__exã∫_Æways_ölöe
 const *

219 
°rchr
 (c⁄° *
__s
, 
__c
Ë
	g__THROW


221  
__buûtö_°rchr
 (
__s
, 
__c
);

226 *
	$°rchr
 (c⁄° *
__s
, 
__c
)

227 
__THROW
 
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1));

230 #ifde‡
__CORRECT_ISO_CPP_STRING_H_PROTO


233 *
	`°ºchr
 (*
__s
, 
__c
)

234 
__THROW
 
	`__asm
 ("°ºchr"Ë
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1));

235 c⁄° *
	`°ºchr
 (c⁄° *
__s
, 
__c
)

236 
__THROW
 
	`__asm
 ("°ºchr"Ë
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1));

238 #ifde‡
__OPTIMIZE__


239 
__exã∫_Æways_ölöe
 *

240 
	`°ºchr
 (*
__s
, 
__c
Ë
__THROW


242  
	`__buûtö_°ºchr
 (
__s
, 
__c
);

245 
__exã∫_Æways_ölöe
 const *

246 
	`°ºchr
 (c⁄° *
__s
, 
__c
Ë
__THROW


248  
	`__buûtö_°ºchr
 (
__s
, 
__c
);

251 
	}
}

253 *
	$°ºchr
 (c⁄° *
__s
, 
__c
)

254 
__THROW
 
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1));

257 #ifde‡
__USE_GNU


260 #ifde‡
__CORRECT_ISO_CPP_STRING_H_PROTO


261 "C++" *
	$°rch∫ul
 (*
__s
, 
__c
)

262 
__THROW
 
	`__asm
 ("°rch∫ul"Ë
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1));

263 "C++" c⁄° *
	$°rch∫ul
 (c⁄° *
__s
, 
__c
)

264 
__THROW
 
	`__asm
 ("°rch∫ul"Ë
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1));

266 *
	$°rch∫ul
 (c⁄° *
__s
, 
__c
)

267 
__THROW
 
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1));

273 
size_t
 
	$°rc•n
 (c⁄° *
__s
, c⁄° *
__ªje˘
)

274 
__THROW
 
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1, 2));

277 
size_t
 
	$°r•n
 (c⁄° *
__s
, c⁄° *
__ac˚±
)

278 
__THROW
 
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1, 2));

280 #ifde‡
__CORRECT_ISO_CPP_STRING_H_PROTO


283 *
	`°Ωbrk
 (*
__s
, c⁄° *
__ac˚±
)

284 
__THROW
 
	`__asm
 ("°Ωbrk"Ë
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1, 2));

285 c⁄° *
	`°Ωbrk
 (c⁄° *
__s
, c⁄° *
__ac˚±
)

286 
__THROW
 
	`__asm
 ("°Ωbrk"Ë
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1, 2));

288 #ifde‡
__OPTIMIZE__


289 
__exã∫_Æways_ölöe
 *

290 
	`°Ωbrk
 (*
__s
, c⁄° *
__ac˚±
Ë
__THROW


292  
	`__buûtö_°Ωbrk
 (
__s
, 
__ac˚±
);

295 
__exã∫_Æways_ölöe
 const *

296 
	`°Ωbrk
 (c⁄° *
__s
, c⁄° *
__ac˚±
Ë
__THROW


298  
	`__buûtö_°Ωbrk
 (
__s
, 
__ac˚±
);

301 
	}
}

303 *
	$°Ωbrk
 (c⁄° *
__s
, c⁄° *
__ac˚±
)

304 
__THROW
 
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1, 2));

307 #ifde‡
__CORRECT_ISO_CPP_STRING_H_PROTO


310 *
	`°r°r
 (*
__hay°ack
, c⁄° *
__√edÀ
)

311 
__THROW
 
	`__asm
 ("°r°r"Ë
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1, 2));

312 c⁄° *
	`°r°r
 (c⁄° *
__hay°ack
, c⁄° *
__√edÀ
)

313 
__THROW
 
	`__asm
 ("°r°r"Ë
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1, 2));

315 #ifde‡
__OPTIMIZE__


316 
__exã∫_Æways_ölöe
 *

317 
	`°r°r
 (*
__hay°ack
, c⁄° *
__√edÀ
Ë
__THROW


319  
	`__buûtö_°r°r
 (
__hay°ack
, 
__√edÀ
);

322 
__exã∫_Æways_ölöe
 const *

323 
	`°r°r
 (c⁄° *
__hay°ack
, c⁄° *
__√edÀ
Ë
__THROW


325  
	`__buûtö_°r°r
 (
__hay°ack
, 
__√edÀ
);

328 
	}
}

330 *
	$°r°r
 (c⁄° *
__hay°ack
, c⁄° *
__√edÀ
)

331 
__THROW
 
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1, 2));

336 *
	$°πok
 (*
__ª°ri˘
 
__s
, c⁄° *__ª°ri˘ 
__dñim
)

337 
__THROW
 
	`__n⁄nuŒ
 ((2));

341 *
	$__°πok_r
 (*
__ª°ri˘
 
__s
,

342 c⁄° *
__ª°ri˘
 
__dñim
,

343 **
__ª°ri˘
 
__ßve_±r
)

344 
__THROW
 
	`__n⁄nuŒ
 ((2, 3));

345 #ifde‡
__USE_POSIX


346 *
	$°πok_r
 (*
__ª°ri˘
 
__s
, c⁄° *__ª°ri˘ 
__dñim
,

347 **
__ª°ri˘
 
__ßve_±r
)

348 
__THROW
 
	`__n⁄nuŒ
 ((2, 3));

351 #ifde‡
__USE_GNU


353 #ifde‡
__CORRECT_ISO_CPP_STRING_H_PROTO


354 "C++" *
	$°rˇ£°r
 (*
__hay°ack
, c⁄° *
__√edÀ
)

355 
__THROW
 
	`__asm
 ("°rˇ£°r"Ë
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1, 2));

356 "C++" c⁄° *
	$°rˇ£°r
 (c⁄° *
__hay°ack
,

357 c⁄° *
__√edÀ
)

358 
__THROW
 
	`__asm
 ("°rˇ£°r"Ë
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1, 2));

360 *
	$°rˇ£°r
 (c⁄° *
__hay°ack
, c⁄° *
__√edÀ
)

361 
__THROW
 
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1, 2));

365 #ifde‡
__USE_GNU


369 *
	$memmem
 (c⁄° *
__hay°ack
, 
size_t
 
__hay°ackÀn
,

370 c⁄° *
__√edÀ
, 
size_t
 
__√edÀÀn
)

371 
__THROW
 
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1, 3));

375 *
	$__memp˝y
 (*
__ª°ri˘
 
__de°
,

376 c⁄° *
__ª°ri˘
 
__§c
, 
size_t
 
__n
)

377 
__THROW
 
	`__n⁄nuŒ
 ((1, 2));

378 *
	$memp˝y
 (*
__ª°ri˘
 
__de°
,

379 c⁄° *
__ª°ri˘
 
__§c
, 
size_t
 
__n
)

380 
__THROW
 
	`__n⁄nuŒ
 ((1, 2));

385 
size_t
 
	$°æí
 (c⁄° *
__s
)

386 
__THROW
 
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1));

388 #ifdef 
__USE_XOPEN2K8


391 
size_t
 
	$°∫Àn
 (c⁄° *
__°rög
, 
size_t
 
__maxÀn
)

392 
__THROW
 
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1));

397 *
	$°ªº‹
 (
__î∫um
Ë
__THROW
;

398 #ifde‡
__USE_XOPEN2K


406 #i‡
deföed
 
__USE_XOPEN2K
 && !deföed 
__USE_GNU


409 #ifde‡
__REDIRECT_NTH


410 
	`__REDIRECT_NTH
 (
°ªº‹_r
,

411 (
__î∫um
, *
__buf
, 
size_t
 
__buÊí
),

412 
__xpg_°ªº‹_r
Ë
	`__n⁄nuŒ
 ((2));

414 
	$__xpg_°ªº‹_r
 (
__î∫um
, *
__buf
, 
size_t
 
__buÊí
)

415 
__THROW
 
	`__n⁄nuŒ
 ((2));

416 
	#°ªº‹_r
 
__xpg_°ªº‹_r


	)

421 *
	$°ªº‹_r
 (
__î∫um
, *
__buf
, 
size_t
 
__buÊí
)

422 
__THROW
 
	`__n⁄nuŒ
 ((2)Ë
__wur
;

426 #ifde‡
__USE_XOPEN2K8


428 *
	$°ªº‹_l
 (
__î∫um
, 
loˇÀ_t
 
__l
Ë
__THROW
;

431 #ifde‡
__USE_MISC


432 
	~<°rögs.h
>

436 
	$ex∂icô_bzîo
 (*
__s
, 
size_t
 
__n
Ë
__THROW
 
	`__n⁄nuŒ
 ((1));

440 *
	$°r£p
 (**
__ª°ri˘
 
__°rögp
,

441 c⁄° *
__ª°ri˘
 
__dñim
)

442 
__THROW
 
	`__n⁄nuŒ
 ((1, 2));

445 #ifdef 
__USE_XOPEN2K8


447 *
	$°rsig«l
 (
__sig
Ë
__THROW
;

450 *
	$__°p˝y
 (*
__ª°ri˘
 
__de°
, c⁄° *__ª°ri˘ 
__§c
)

451 
__THROW
 
	`__n⁄nuŒ
 ((1, 2));

452 *
	$°p˝y
 (*
__ª°ri˘
 
__de°
, c⁄° *__ª°ri˘ 
__§c
)

453 
__THROW
 
	`__n⁄nuŒ
 ((1, 2));

457 *
	$__°≤˝y
 (*
__ª°ri˘
 
__de°
,

458 c⁄° *
__ª°ri˘
 
__§c
, 
size_t
 
__n
)

459 
__THROW
 
	`__n⁄nuŒ
 ((1, 2));

460 *
	$°≤˝y
 (*
__ª°ri˘
 
__de°
,

461 c⁄° *
__ª°ri˘
 
__§c
, 
size_t
 
__n
)

462 
__THROW
 
	`__n⁄nuŒ
 ((1, 2));

465 #ifdef 
__USE_GNU


467 
	$°rvîscmp
 (c⁄° *
__s1
, c⁄° *
__s2
)

468 
__THROW
 
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1, 2));

471 *
	$°r‰y
 (*
__°rög
Ë
__THROW
 
	`__n⁄nuŒ
 ((1));

474 *
	$mem‰ob
 (*
__s
, 
size_t
 
__n
Ë
__THROW
 
	`__n⁄nuŒ
 ((1));

476 #i‚de‡
ba£«me


481 #ifde‡
__CORRECT_ISO_CPP_STRING_H_PROTO


482 "C++" *
	$ba£«me
 (*
__fûíame
)

483 
__THROW
 
	`__asm
 ("ba£«me"Ë
	`__n⁄nuŒ
 ((1));

484 "C++" c⁄° *
	$ba£«me
 (c⁄° *
__fûíame
)

485 
__THROW
 
	`__asm
 ("ba£«me"Ë
	`__n⁄nuŒ
 ((1));

487 *
	$ba£«me
 (c⁄° *
__fûíame
Ë
__THROW
 
	`__n⁄nuŒ
 ((1));

492 #i‡
	`__GNUC_PREREQ
 (3,4)

493 #i‡
__USE_FORTIFY_LEVEL
 > 0 && 
deföed
 
__f‹tify_fun˘i⁄


495 
	~<bôs/°rög_f‹tifõd.h
>

499 
__END_DECLS


	@/usr/include/linux/stddef.h

4 #i‚de‡
__Æways_ölöe


5 
	#__Æways_ölöe
 
__ölöe__


	)

	@/usr/include/strings.h

18 #i‚def 
_STRINGS_H


19 
	#_STRINGS_H
 1

	)

21 
	~<„©uªs.h
>

22 
	#__√ed_size_t


	)

23 
	~<°ddef.h
>

26 #i‡
deföed
 
__˝lu•lus
 && 
__GNUC_PREREQ
 (4, 4)

27 
	#__CORRECT_ISO_CPP_STRINGS_H_PROTO


	)

30 
	g__BEGIN_DECLS


32 #i‡
deföed
 
__USE_MISC
 || !deföed 
__USE_XOPEN2K8


34 
	$bcmp
 (c⁄° *
__s1
, c⁄° *
__s2
, 
size_t
 
__n
)

35 
__THROW
 
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1, 2));

38 
	$bc›y
 (c⁄° *
__§c
, *
__de°
, 
size_t
 
__n
)

39 
__THROW
 
	`__n⁄nuŒ
 ((1, 2));

42 
	$bzîo
 (*
__s
, 
size_t
 
__n
Ë
__THROW
 
	`__n⁄nuŒ
 ((1));

45 #ifde‡
__CORRECT_ISO_CPP_STRINGS_H_PROTO


48 *
	`ödex
 (*
__s
, 
__c
)

49 
__THROW
 
	`__asm
 ("ödex"Ë
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1));

50 c⁄° *
	`ödex
 (c⁄° *
__s
, 
__c
)

51 
__THROW
 
	`__asm
 ("ödex"Ë
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1));

53 #i‡
deföed
 
__OPTIMIZE__


54 
__exã∫_Æways_ölöe
 *

55 
	`ödex
 (*
__s
, 
__c
Ë
__THROW


57  
	`__buûtö_ödex
 (
__s
, 
__c
);

60 
__exã∫_Æways_ölöe
 const *

61 
	`ödex
 (c⁄° *
__s
, 
__c
Ë
__THROW


63  
	`__buûtö_ödex
 (
__s
, 
__c
);

66 
	}
}

68 *
	$ödex
 (c⁄° *
__s
, 
__c
)

69 
__THROW
 
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1));

73 #ifde‡
__CORRECT_ISO_CPP_STRINGS_H_PROTO


76 *
	`rödex
 (*
__s
, 
__c
)

77 
__THROW
 
	`__asm
 ("rödex"Ë
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1));

78 c⁄° *
	`rödex
 (c⁄° *
__s
, 
__c
)

79 
__THROW
 
	`__asm
 ("rödex"Ë
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1));

81 #i‡
deföed
 
__OPTIMIZE__


82 
__exã∫_Æways_ölöe
 *

83 
	`rödex
 (*
__s
, 
__c
Ë
__THROW


85  
	`__buûtö_rödex
 (
__s
, 
__c
);

88 
__exã∫_Æways_ölöe
 const *

89 
	`rödex
 (c⁄° *
__s
, 
__c
Ë
__THROW


91  
	`__buûtö_rödex
 (
__s
, 
__c
);

94 
	}
}

96 *
	$rödex
 (c⁄° *
__s
, 
__c
)

97 
__THROW
 
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1));

101 #i‡
deföed
 
__USE_MISC
 || !deföed 
__USE_XOPEN2K8
 || deföed 
__USE_XOPEN2K8XSI


104 
	$ffs
 (
__i
Ë
__THROW
 
__©åibuã_c⁄°__
;

109 #ifdef 
__USE_MISC


110 
	$ff¶
 (
__l
Ë
__THROW
 
__©åibuã_c⁄°__
;

111 
__exãnsi⁄__
 
	$ff¶l
 (
__Œ
)

112 
__THROW
 
__©åibuã_c⁄°__
;

116 
	$°rˇ£cmp
 (c⁄° *
__s1
, c⁄° *
__s2
)

117 
__THROW
 
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1, 2));

120 
	$°∫ˇ£cmp
 (c⁄° *
__s1
, c⁄° *
__s2
, 
size_t
 
__n
)

121 
__THROW
 
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1, 2));

123 #ifdef 
__USE_XOPEN2K8


125 
	~<bôs/ty≥s/loˇÀ_t.h
>

128 
	$°rˇ£cmp_l
 (c⁄° *
__s1
, c⁄° *
__s2
, 
loˇÀ_t
 
__loc
)

129 
__THROW
 
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1, 2, 3));

133 
	$°∫ˇ£cmp_l
 (c⁄° *
__s1
, c⁄° *
__s2
,

134 
size_t
 
__n
, 
loˇÀ_t
 
__loc
)

135 
__THROW
 
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1, 2, 4));

138 
__END_DECLS


140 #i‡
	`__GNUC_PREREQ
 (3,4Ë&& 
__USE_FORTIFY_LEVEL
 > 0 \

141 && 
deföed
 
__f‹tify_fun˘i⁄


143 #i‡
deföed
 
__USE_MISC
 || !deföed 
__USE_XOPEN2K8


144 
	~<bôs/°rögs_f‹tifõd.h
>

	@/usr/include/features.h

18 #i‚def 
_FEATURES_H


19 
	#_FEATURES_H
 1

	)

120 #unde‡
__USE_ISOC11


121 #unde‡
__USE_ISOC99


122 #unde‡
__USE_ISOC95


123 #unde‡
__USE_ISOCXX11


124 #unde‡
__USE_POSIX


125 #unde‡
__USE_POSIX2


126 #unde‡
__USE_POSIX199309


127 #unde‡
__USE_POSIX199506


128 #unde‡
__USE_XOPEN


129 #unde‡
__USE_XOPEN_EXTENDED


130 #unde‡
__USE_UNIX98


131 #unde‡
__USE_XOPEN2K


132 #unde‡
__USE_XOPEN2KXSI


133 #unde‡
__USE_XOPEN2K8


134 #unde‡
__USE_XOPEN2K8XSI


135 #unde‡
__USE_LARGEFILE


136 #unde‡
__USE_LARGEFILE64


137 #unde‡
__USE_FILE_OFFSET64


138 #unde‡
__USE_MISC


139 #unde‡
__USE_ATFILE


140 #unde‡
__USE_GNU


141 #unde‡
__USE_FORTIFY_LEVEL


142 #unde‡
__KERNEL_STRICT_NAMES


143 #unde‡
__GLIBC_USE_ISOC2X


144 #unde‡
__GLIBC_USE_DEPRECATED_GETS


145 #unde‡
__GLIBC_USE_DEPRECATED_SCANF


149 #i‚de‡
_LOOSE_KERNEL_NAMES


150 
	#__KERNEL_STRICT_NAMES


	)

160 #i‡
deföed
 
__GNUC__
 && deföed 
__GNUC_MINOR__


161 
	#__GNUC_PREREQ
(
maj
, 
mö
) \

162 ((
__GNUC__
 << 16Ë+ 
__GNUC_MINOR__
 >((
maj
Ë<< 16Ë+ (
mö
))

	)

164 
	#__GNUC_PREREQ
(
maj
, 
mö
Ë0

	)

171 #i‡
deföed
 
__˛™g_maj‹__
 && deföed 
__˛™g_mö‹__


172 
	#__glibc_˛™g_¥îeq
(
maj
, 
mö
) \

173 ((
__˛™g_maj‹__
 << 16Ë+ 
__˛™g_mö‹__
 >((
maj
Ë<< 16Ë+ (
mö
))

	)

175 
	#__glibc_˛™g_¥îeq
(
maj
, 
mö
Ë0

	)

179 
	#__GLIBC_USE
(
F
Ë
__GLIBC_USE_
 ## 
	)
F

185 #i‡(
deföed
 
_BSD_SOURCE
 || deföed 
_SVID_SOURCE
) \

186 && !
deföed
 
	g_DEFAULT_SOURCE


188 #unde‡
_DEFAULT_SOURCE


189 
	#_DEFAULT_SOURCE
 1

	)

193 #ifde‡
_GNU_SOURCE


194 #unde‡
_ISOC95_SOURCE


195 
	#_ISOC95_SOURCE
 1

	)

196 #unde‡
_ISOC99_SOURCE


197 
	#_ISOC99_SOURCE
 1

	)

198 #unde‡
_ISOC11_SOURCE


199 
	#_ISOC11_SOURCE
 1

	)

200 #unde‡
_ISOC2X_SOURCE


201 
	#_ISOC2X_SOURCE
 1

	)

202 #unde‡
_POSIX_SOURCE


203 
	#_POSIX_SOURCE
 1

	)

204 #unde‡
_POSIX_C_SOURCE


205 
	#_POSIX_C_SOURCE
 200809L

	)

206 #unde‡
_XOPEN_SOURCE


207 
	#_XOPEN_SOURCE
 700

	)

208 #unde‡
_XOPEN_SOURCE_EXTENDED


209 
	#_XOPEN_SOURCE_EXTENDED
 1

	)

210 #unde‡
_LARGEFILE64_SOURCE


211 
	#_LARGEFILE64_SOURCE
 1

	)

212 #unde‡
_DEFAULT_SOURCE


213 
	#_DEFAULT_SOURCE
 1

	)

214 #unde‡
_ATFILE_SOURCE


215 
	#_ATFILE_SOURCE
 1

	)

220 #i‡(
deföed
 
_DEFAULT_SOURCE
 \

221 || (!
deföed
 
	g__STRICT_ANSI__
 \

222 && !
deföed
 
	g_ISOC99_SOURCE
 && !deföed 
	g_ISOC11_SOURCE
 \

223 && !
deföed
 
	g_ISOC2X_SOURCE
 \

224 && !
deföed
 
	g_POSIX_SOURCE
 && !deföed 
	g_POSIX_C_SOURCE
 \

225 && !
deföed
 
	g_XOPEN_SOURCE
))

226 #unde‡
_DEFAULT_SOURCE


227 
	#_DEFAULT_SOURCE
 1

	)

231 #i‡(
deföed
 
_ISOC2X_SOURCE
 \

232 || (
deföed
 
	g__STDC_VERSION__
 && __STDC_VERSION__ > 201710L))

233 
	#__GLIBC_USE_ISOC2X
 1

	)

235 
	#__GLIBC_USE_ISOC2X
 0

	)

239 #i‡(
deföed
 
_ISOC11_SOURCE
 || deföed 
_ISOC2X_SOURCE
 \

240 || (
deföed
 
	g__STDC_VERSION__
 && __STDC_VERSION__ >= 201112L))

241 
	#__USE_ISOC11
 1

	)

245 #i‡(
deföed
 
_ISOC99_SOURCE
 || deföed 
_ISOC11_SOURCE
 \

246 || 
deföed
 
_ISOC2X_SOURCE
 \

247 || (
deföed
 
__STDC_VERSION__
 && __STDC_VERSION__ >= 199901L))

248 
	#__USE_ISOC99
 1

	)

252 #i‡(
deföed
 
_ISOC99_SOURCE
 || deföed 
_ISOC11_SOURCE
 \

253 || 
deföed
 
_ISOC2X_SOURCE
 \

254 || (
deföed
 
__STDC_VERSION__
 && __STDC_VERSION__ >= 199409L))

255 
	#__USE_ISOC95
 1

	)

258 #ifde‡
__˝lu•lus


260 #i‡
__˝lu•lus
 >= 201703L

261 
	#__USE_ISOC11
 1

	)

265 #i‡
__˝lu•lus
 >201103L || 
deföed
 
__GXX_EXPERIMENTAL_CXX0X__


266 
	#__USE_ISOCXX11
 1

	)

267 
	#__USE_ISOC99
 1

	)

274 #ifde‡
_DEFAULT_SOURCE


275 #i‡!
deföed
 
_POSIX_SOURCE
 && !deföed 
_POSIX_C_SOURCE


276 
	#__USE_POSIX_IMPLICITLY
 1

	)

278 #unde‡
_POSIX_SOURCE


279 
	#_POSIX_SOURCE
 1

	)

280 #unde‡
_POSIX_C_SOURCE


281 
	#_POSIX_C_SOURCE
 200809L

	)

284 #i‡((!
deföed
 
__STRICT_ANSI__
 \

285 || (
deföed
 
_XOPEN_SOURCE
 && (_XOPEN_SOURCE - 0) >= 500)) \

286 && !
deföed
 
_POSIX_SOURCE
 && !deföed 
_POSIX_C_SOURCE
)

287 
	#_POSIX_SOURCE
 1

	)

288 #i‡
deföed
 
_XOPEN_SOURCE
 && (_XOPEN_SOURCE - 0) < 500

289 
	#_POSIX_C_SOURCE
 2

	)

290 #ñi‡
deföed
 
_XOPEN_SOURCE
 && (_XOPEN_SOURCE - 0) < 600

291 
	#_POSIX_C_SOURCE
 199506L

	)

292 #ñi‡
deföed
 
_XOPEN_SOURCE
 && (_XOPEN_SOURCE - 0) < 700

293 
	#_POSIX_C_SOURCE
 200112L

	)

295 
	#_POSIX_C_SOURCE
 200809L

	)

297 
	#__USE_POSIX_IMPLICITLY
 1

	)

306 #i‡((!
deföed
 
_POSIX_C_SOURCE
 || (_POSIX_C_SOURCE - 0) < 199506L) \

307 && (
deföed
 
_REENTRANT
 || deföed 
_THREAD_SAFE
))

308 
	#_POSIX_SOURCE
 1

	)

309 #unde‡
_POSIX_C_SOURCE


310 
	#_POSIX_C_SOURCE
 199506L

	)

313 #i‡(
deföed
 
_POSIX_SOURCE
 \

314 || (
deföed
 
_POSIX_C_SOURCE
 && _POSIX_C_SOURCE >= 1) \

315 || 
deföed
 
_XOPEN_SOURCE
)

316 
	#__USE_POSIX
 1

	)

319 #i‡
deföed
 
_POSIX_C_SOURCE
 && _POSIX_C_SOURCE >2 || deföed 
_XOPEN_SOURCE


320 
	#__USE_POSIX2
 1

	)

323 #i‡
deföed
 
_POSIX_C_SOURCE
 && (_POSIX_C_SOURCE - 0) >= 199309L

324 
	#__USE_POSIX199309
 1

	)

327 #i‡
deföed
 
_POSIX_C_SOURCE
 && (_POSIX_C_SOURCE - 0) >= 199506L

328 
	#__USE_POSIX199506
 1

	)

331 #i‡
deföed
 
_POSIX_C_SOURCE
 && (_POSIX_C_SOURCE - 0) >= 200112L

332 
	#__USE_XOPEN2K
 1

	)

333 #unde‡
__USE_ISOC95


334 
	#__USE_ISOC95
 1

	)

335 #unde‡
__USE_ISOC99


336 
	#__USE_ISOC99
 1

	)

339 #i‡
deföed
 
_POSIX_C_SOURCE
 && (_POSIX_C_SOURCE - 0) >= 200809L

340 
	#__USE_XOPEN2K8
 1

	)

341 #unde‡
_ATFILE_SOURCE


342 
	#_ATFILE_SOURCE
 1

	)

345 #ifdef 
_XOPEN_SOURCE


346 
	#__USE_XOPEN
 1

	)

347 #i‡(
_XOPEN_SOURCE
 - 0) >= 500

348 
	#__USE_XOPEN_EXTENDED
 1

	)

349 
	#__USE_UNIX98
 1

	)

350 #unde‡
_LARGEFILE_SOURCE


351 
	#_LARGEFILE_SOURCE
 1

	)

352 #i‡(
_XOPEN_SOURCE
 - 0) >= 600

353 #i‡(
_XOPEN_SOURCE
 - 0) >= 700

354 
	#__USE_XOPEN2K8
 1

	)

355 
	#__USE_XOPEN2K8XSI
 1

	)

357 
	#__USE_XOPEN2K
 1

	)

358 
	#__USE_XOPEN2KXSI
 1

	)

359 #unde‡
__USE_ISOC95


360 
	#__USE_ISOC95
 1

	)

361 #unde‡
__USE_ISOC99


362 
	#__USE_ISOC99
 1

	)

365 #ifde‡
_XOPEN_SOURCE_EXTENDED


366 
	#__USE_XOPEN_EXTENDED
 1

	)

371 #ifde‡
_LARGEFILE_SOURCE


372 
	#__USE_LARGEFILE
 1

	)

375 #ifde‡
_LARGEFILE64_SOURCE


376 
	#__USE_LARGEFILE64
 1

	)

379 #i‡
deföed
 
_FILE_OFFSET_BITS
 && _FILE_OFFSET_BITS == 64

380 
	#__USE_FILE_OFFSET64
 1

	)

383 #i‡
deföed
 
_DEFAULT_SOURCE


384 
	#__USE_MISC
 1

	)

387 #ifdef 
_ATFILE_SOURCE


388 
	#__USE_ATFILE
 1

	)

391 #ifdef 
_GNU_SOURCE


392 
	#__USE_GNU
 1

	)

395 #i‡
deföed
 
_FORTIFY_SOURCE
 && _FORTIFY_SOURCE > 0 \

396 && 
__GNUC_PREREQ
 (4, 1Ë&& 
deföed
 
	g__OPTIMIZE__
 && __OPTIMIZE__ > 0

397 #i‡
_FORTIFY_SOURCE
 > 1

398 
	#__USE_FORTIFY_LEVEL
 2

	)

400 
	#__USE_FORTIFY_LEVEL
 1

	)

403 
	#__USE_FORTIFY_LEVEL
 0

	)

410 #i‡
deföed
 
__˝lu•lus
 ? __˝lu•lu†>201402L : deföed 
__USE_ISOC11


411 
	#__GLIBC_USE_DEPRECATED_GETS
 0

	)

413 
	#__GLIBC_USE_DEPRECATED_GETS
 1

	)

428 #i‡(
deföed
 
__USE_GNU
 \

429 && (
deföed
 
	g__˝lu•lus
 \

430 ? (
	g__˝lu•lus
 < 201103L && !
deföed
 
	g__GXX_EXPERIMENTAL_CXX0X__
) \

431 : (!
deföed
 
__STDC_VERSION__
 || __STDC_VERSION__ < 199901L)))

432 
	#__GLIBC_USE_DEPRECATED_SCANF
 1

	)

434 
	#__GLIBC_USE_DEPRECATED_SCANF
 0

	)

439 
	~<°dc-¥edef.h
>

447 #unde‡
__GNU_LIBRARY__


448 
	#__GNU_LIBRARY__
 6

	)

452 
	#__GLIBC__
 2

	)

453 
	#__GLIBC_MINOR__
 31

	)

455 
	#__GLIBC_PREREQ
(
maj
, 
mö
) \

456 ((
__GLIBC__
 << 16Ë+ 
__GLIBC_MINOR__
 >((
maj
Ë<< 16Ë+ (
mö
))

	)

459 #i‚de‡
__ASSEMBLER__


460 #i‚de‡
_SYS_CDEFS_H


461 
	~<sys/cdefs.h
>

466 #i‡
deföed
 
__USE_FILE_OFFSET64
 && !deföed 
__REDIRECT


467 
	#__USE_LARGEFILE
 1

	)

468 
	#__USE_LARGEFILE64
 1

	)

474 #i‡
__GNUC_PREREQ
 (2, 7Ë&& 
deföed
 
__OPTIMIZE__
 \

475 && !
deföed
 
	g__OPTIMIZE_SIZE__
 && !deföed 
	g__NO_INLINE__
 \

476 && 
deföed
 
	g__exã∫_ölöe


477 
	#__USE_EXTERN_INLINES
 1

	)

485 
	~<gnu/°ubs.h
>

	@/usr/include/stdc-predef.h

18 #i‚def 
_STDC_PREDEF_H


19 
	#_STDC_PREDEF_H
 1

	)

36 #ifde‡
__GCC_IEC_559


37 #i‡
__GCC_IEC_559
 > 0

38 
	#__STDC_IEC_559__
 1

	)

41 
	#__STDC_IEC_559__
 1

	)

44 #ifde‡
__GCC_IEC_559_COMPLEX


45 #i‡
__GCC_IEC_559_COMPLEX
 > 0

46 
	#__STDC_IEC_559_COMPLEX__
 1

	)

49 
	#__STDC_IEC_559_COMPLEX__
 1

	)

58 
	#__STDC_ISO_10646__
 201706L

	)

	@
1
.
1
/usr/include
85
1628
acl.c
acl.h
balloc.c
bitmap.c
block_validity.c
dir.c
ext4.h
ext4_extents.h
ext4_jbd2.c
ext4_jbd2.h
extents.c
extents_status.c
extents_status.h
file.c
fsmap.c
fsmap.h
fsync.c
hash.c
ialloc.c
indirect.c
inline.c
inode.c
ioctl.c
mballoc.c
mballoc.h
migrate.c
mmp.c
move_extent.c
namei.c
page-io.c
readpage.c
resize.c
super.c
symlink.c
sysfs.c
truncate.h
verity.c
xattr.c
xattr.h
xattr_security.c
xattr_trusted.c
xattr_user.c
/usr/include/linux/capability.h
/usr/include/linux/errno.h
/usr/include/linux/falloc.h
/usr/include/linux/fcntl.h
/usr/include/linux/fiemap.h
/usr/include/linux/fs.h
/usr/include/linux/fscrypt.h
/usr/include/linux/fsmap.h
/usr/include/linux/fsverity.h
/usr/include/linux/kdev_t.h
/usr/include/linux/kernel.h
/usr/include/linux/magic.h
/usr/include/linux/mman.h
/usr/include/linux/module.h
/usr/include/linux/mount.h
/usr/include/linux/posix_acl_xattr.h
/usr/include/linux/quota.h
/usr/include/linux/random.h
/usr/include/linux/sched.h
/usr/include/linux/stat.h
/usr/include/linux/string.h
/usr/include/linux/time.h
/usr/include/linux/types.h
/usr/include/linux/uio.h
/usr/include/linux/utsname.h
/usr/include/linux/uuid.h
/usr/include/linux/version.h
/usr/include/linux/wait.h
/usr/include/linux/xattr.h
/usr/include/asm-generic/hugetlb_encode.h
/usr/include/linux/const.h
/usr/include/linux/ioctl.h
/usr/include/linux/irqnr.h
/usr/include/linux/libc-compat.h
/usr/include/linux/limits.h
/usr/include/linux/posix_types.h
/usr/include/linux/sysinfo.h
/usr/include/linux/time_types.h
/usr/include/string.h
/usr/include/linux/stddef.h
/usr/include/strings.h
/usr/include/features.h
/usr/include/stdc-predef.h
